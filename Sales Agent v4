<!DOCTYPE html>
<html lang="en">
<head>
    <title>Car Finance Savings Calculator | Compare My Finance</title>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://api.oneautoapi.com" crossorigin><link rel="preconnect" href="https://script.google.com" crossorigin><link rel="dns-prefetch" href="//i.ibb.co"><link rel="dns-prefetch" href="//cdn.tailwindcss.com"><link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style> html{scroll-behavior:smooth}body{font-family:'Poppins',sans-serif;background-color:rgba(0,66,37,.05)}.calculator-container{background:linear-gradient(145deg,rgba(255,255,255,.9),rgba(245,249,255,.9));box-shadow:0 10px 30px rgba(0,66,37,.08)}.input-field{transition:all .3s ease}.input-field:focus{border-color:#004225;box-shadow:0 0 0 3px rgba(0,66,37,.2)}.result-card{transition:transform .3s ease}.result-card:hover{transform:translateY(-3px)}.select-field{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em;padding-right:2.5rem;-webkit-print-color-adjust:exact;print-color-adjust:exact;appearance:none}.summary-box{transition:all .3s ease}.summary-box:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,66,37,.12)}.required-field::after{content:"*";color:#dc2626;margin-left:2px}#custom-alert-box{position:fixed;top:50%;left:50%;background-color:white;padding:20px;border:1px solid #004225;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:10000;text-align:center;color:#004225;min-width:300px;max-width:90%;max-height:80vh;overflow-y:auto}#custom-alert-box p{margin-bottom:15px;font-size:1rem;line-height:1.5}#custom-alert-box button{padding:10px 20px;background-color:#004225;color:white;border:none;border-radius:4px;cursor:pointer;font-size:.9rem;transition:background-color .2s ease}#custom-alert-box button:hover{background-color:#00542c}.car-svg-text{font-size:12px;font-weight:bold;text-anchor:middle;dominant-baseline:middle}.field-group-bg{background-color:#cce1d7}.bg-british-racing-green{background-color:#004225}.hover\:bg-british-racing-green-darker:hover{background-color:#00331c}.section-icon{width:60px;height:60px}.bg-light-green{background-color:#C1E1C1}.text-racing-green{color:#004225}.bg-racing-green{background-color:#004225}.error-message{color:#e53e3e;font-size:.75rem;margin-top:.25rem;display:none}input.error,select.error,input[list].error,.btn-option.error,.btn-finance-type.error{border-color:#e53e3e!important}.goal-btn{transition:all .2s ease-in-out;box-shadow:0 2px 4px rgba(0,0,0,.05)}.goal-btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.1)}.goal-btn.active-goal{background-color:#004225;color:white;box-shadow:0 4px 14px 0 rgba(0,66,37,.39);transform:translateY(-2px)}#goal-reset-results.active-goal,#goal-reset-results{background-color:#fecaca!important;color:#991b1b!important}.refinance-trigger{background-color:#004225!important;color:white!important}#finance-form-embed-container{font-family:'Poppins',sans-serif;background-color:#E8F5E9;padding:1rem}@media (min-width:768px){#finance-form-embed-container{padding:2rem}}.progress-bar-container{height:20px;background-color:#C1E1C1;border-radius:10px;margin-bottom:20px;overflow:hidden;position:relative}.progress{height:100%;background-color:#004225;border-radius:10px;transition:width .3s ease;display:flex;align-items:center;justify-content:center}#progress-bar-text{color:white;font-size:.8rem;line-height:20px;font-weight:600;opacity:0;transition:opacity .3s ease;text-shadow:1px 1px 1px rgba(0,0,0,.2)}.progress:not([style*="width: 0%"]):not([style*="width: 0px"]) #progress-bar-text{opacity:1}.form-section{display:none}.form-section.active{display:block;animation:fadeIn .4s}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.btn-option{transition:all .3s ease;border:1px solid #D1D5DB}.btn-option:hover{transform:translateY(-3px);box-shadow:0 4px 6px rgba(0,66,37,.1)}.btn-option.selected{background-color:#004225;color:white;border-color:#004225}.btn-finance-type{border:2px solid #004225;color:#004225;background-color:white;padding:.5rem 1rem;border-radius:.75rem;text-align:center;transition:all .3s ease;font-weight:500}.btn-finance-type:hover{transform:translateY(-2px);box-shadow:0 2px 4px rgba(0,66,37,.15);background-color:#f0fdf4}.btn-finance-type.selected{background-color:#004225;color:white;border-color:#004225}input:focus,select:focus,input[list]:focus,input[type="file"]:focus{border-color:#004225;box-shadow:0 0 0 3px rgba(0,66,37,.2);outline:none}input[type="checkbox"].error{outline:2px solid #e53e3e;outline-offset:2px}.input-sublabel{font-size:.75rem;color:#4A5568;margin-top:.25rem}.skip-btn{background-color:transparent;border:1px solid transparent;color:#4A5568;font-weight:500;padding:.5rem 1rem;border-radius:.75rem;transition:all .2s ease-in-out;cursor:pointer}.skip-btn:hover{color:#004225;background-color:#E8F5E9}.modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);padding:1rem}.modal-content{background-color:#fefefe;padding:20px;border:1px solid #888;width:90%;max-width:900px;border-radius:10px;position:absolute}.modal-header{padding-bottom:10px;border-bottom:1px solid #eee}.modal-body{padding-top:10px;max-height:60vh;overflow-y:auto}.modal-footer{padding-top:10px;border-top:1px solid #eee;text-align:right}.close-button{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close-button:hover,.close-button:focus{color:black;text-decoration:none}.modal-content h2{color:#004225;margin-top:0}.modal-content h3{color:#004225;margin-top:15px;margin-bottom:5px}.modal-content p,.modal-content li{font-size:.875rem;line-height:1.6;margin-bottom:10px}.modal-content ul{list-style-position:inside;padding-left:0}.collapsible-section{max-height:400px;opacity:1;overflow:hidden;transition:max-height .5s ease-in-out,opacity .3s ease-in-out,padding .5s ease-in-out,margin .5s ease-in-out;box-sizing:border-box}.collapsible-section.is-collapsed{max-height:0;opacity:0;padding-top:0!important;padding-bottom:0!important;margin-top:0!important;margin-bottom:0!important;border-top:none!important;pointer-events:none}#form-general-error{display:none;color:#e53e3e;font-size:.875rem;margin-bottom:1rem;padding:.75rem;background-color:#fee2e2;border-radius:.5rem;border:1px solid #ef4444}.fair-processing-notice{max-height:7.2rem;overflow-y:auto;padding:1rem;border:1px solid #cce1d7;border-radius:.75rem;background-color:#f0f7f3;font-size:.8rem;line-height:1.5}.fair-processing-notice h4{font-weight:600;color:#004225;margin-top:.5rem;margin-bottom:.25rem}.fair-processing-notice ul{list-style-type:disc;padding-left:1.5rem}.hidden{display:none} @keyframes pulse-green{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.95}} @keyframes pulse-cta { 0% { transform: scale(1.02); box-shadow: 0 4px 14px 0 rgba(0,66,37,.3); } 50% { transform: scale(1.07); box-shadow: 0 6px 20px 0 rgba(0,66,37,.4); } 100% { transform: scale(1.02); box-shadow: 0 4px 14px 0 rgba(0,66,37,.3); } } .pulse-cta-animation { animation: pulse-cta 1.5s infinite ease-in-out; } @keyframes shake-error { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } } .input-error-shake { animation: shake-error 0.5s ease-in-out; border-color: #fca5a5 !important; background-color: #fee2e2 !important; } .label-error-shake { color: #dc2626 !important; animation: shake-error 0.5s ease-in-out; } .input-valid-greyed { background-color: #f3f4f6 !important; } .pulse-success{animation:pulse-green 2s infinite;color:#004225;font-weight:bold}#results-section,#finance-form-embed-container{content-visibility:auto;contain-intrinsic-size:1200px} @keyframes pulse-input-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(0, 66, 37, 0.4); } 50% { box-shadow: 0 0 0 4px rgba(0, 66, 37, 0.1); } } .pulse-input-glow-animation { animation: pulse-input-glow 2s infinite ease-in-out; } @keyframes pulse-element { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } } .pulse-element-animation { animation: pulse-element 2s infinite ease-in-out; } .gauge-outer-container { position: relative; width: 100%; max-width: 350px; margin: 2rem auto 0; text-align: center; cursor: pointer; transition: transform 0.2s ease-in-out; } .gauge-outer-container:hover { transform: scale(1.03); } .gauge { position: relative; width: 100%; padding-top: 50%; height: 0; border-top-left-radius: 1000px; border-top-right-radius: 1000px; overflow: hidden; background: linear-gradient(to right, #f08c2a, #f1c40f, #2ecc71); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); border: 18px solid #E9E9E9; box-sizing: border-box; z-index: 10; } .gauge__overlay { position: absolute; top: 18px; left: 18px; right: 18px; bottom: 0; background-color: #ffffff; border-top-left-radius: 1000px; border-top-right-radius: 1000px; z-index: 2; } .gauge__needle { --rotation: -90deg; position: absolute; bottom: 0; left: 50%; width: 5px; height: 96%; background: #34495e; transform-origin: bottom center; border-radius: 3px 3px 0 0; z-index: 3; box-shadow: 0 0 8px rgba(0,0,0,0.2); transform: translateX(-50%) rotate(var(--rotation)); transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);  animation: sweep-gauge-animation 6s ease-in-out infinite; } .gauge__pivot { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 30px; height: 30px; background: #6c757d; border-radius: 50%; z-index: 4; } .gauge__label { position: absolute; color: #95a5a6; font-weight: 500; font-size: 14px; z-index: 5; } .gauge__label--poor { transform: rotate(-55deg); bottom: 30%; left: 15%; } .gauge__label--good { transform: rotate(55deg); bottom: 30%; right: 15%; } .gauge__value-display { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); z-index: 5; } .gauge__value { font-size: 4rem; font-weight: 600; color: #34495e; } .gauge__main-label { font-size: 1rem; color: #bdc3c7; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; } 
@keyframes sweep-gauge-animation {
  0%   { transform: translateX(-50%) rotate(-90deg); }
  40%  { transform: translateX(-50%) rotate(var(--rotation)); }
  60%  { transform: translateX(-50%) rotate(var(--rotation)); }
  100% { transform: translateX(-50%) rotate(-90deg); }
}
</style>
    <script>
        tailwind.config={theme:{extend:{colors:{'racing-green':{DEFAULT:'#004225','50':'#f0f7f3','100':'#cce1d7','200':'#99c3af','300':'#66a587','400':'#33875f','500':'#006837','600':'#00542c','700':'#004225','800':'#00311c','900':'#001f12'}}}}}
    </script>
<style>
  .band-wrap{overflow-x:auto; overflow-y:visible;border:1px solid #e7efe9;border-radius:14px;overflow-x:auto;overflow-y:visible;box-shadow:0 4px 16px rgba(0,0,0,.04);background:#fff;width:100%;max-width:100%}
  .band-table{width:100%;min-width:860px;border-collapse:separate;border-spacing:0}
  .band-table thead th{position:sticky;top:0;background:#07361e;color:#fff;padding:10px 12px;text-align:right;font-weight:700}
  .band-table thead th:first-child{text-align:left;left:0;z-index:2}
  .band-table tbody td,.band-table tbody th{padding:12px;border-bottom:1px solid #edf5f1;background:#fff;white-space:nowrap;text-align:right}
  .band-table tbody th{position:sticky;left:0;background:#fff;text-align:left;box-shadow:1px 0 0 #edf5f1}
  .band-table tbody tr:nth-child(odd) td{background:#fbfdfc}
  .band-table tbody tr.active td,.band-table tbody tr.active th{background:#ecfeff}
</style>
<style>
  .full-span{grid-column:1 / -1 !important; width:100% !important;}
</style>
<style>
  .band-table tbody td, .band-table tbody th { border-bottom:1px solid #cde8db !important; }
  .band-table tbody tr:nth-child(odd) td { background:#eaf7f0 !important; }
  .band-table tbody tr.active td, .band-table tbody tr.active th { background:#dff5e9 !important; }
  .bg-racing-green-50, [class*="bg-racing-green-50"] { background-color:#e7f5ed !important; }
  .soft-green, .pale-green, .summary-card, .savings-box, .comparison-card, .tile-soft-green { background:#eaf7f0 !important; }
  .bg-[#C1E1C1], .bg-\[\#C1E1C1\] { background-color:#a9e5c1 !important; }
</style>
<style>
  .psr-update.glow {
    box-shadow: 0 0 0 rgba(16,185,129,0.7);
    animation: psrPulse 2s infinite;
  }
  @keyframes psrPulse {
    0%   { box-shadow: 0 0 0 0 rgba(16,185,129,0.45); }
    50%  { box-shadow: 0 0 16px 6px rgba(16,185,129,0.25); }
    100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.45); }
  }
</style>
<style>#psr-update-btn{display:none!important}</style>

<style>
  :root { --site-gutter: clamp(12px, 3vw, 32px); --agent-width: clamp(280px, 28vw, 420px); --reserve-right: 20vw; }
  html, body { width:100%; max-width:100vw; overflow-x:hidden; }
  .calculator-container,
  #results-section,
  #finance-form-embed-container,
  .band-wrap,
  .band-table { width:100%; max-width:100%; }
  img, svg, canvas, video { max-width:100%; height:auto; }
  /* Floating Agent */
  .agent-window, #agent-window {
    position: fixed;
    right: var(--site-gutter);
    bottom: var(--site-gutter);
    width: var(--agent-width);
    max-height: calc(100vh - calc(var(--site-gutter) * 2));
    overflow: auto;
    z-index: 9999;
    pointer-events: auto;
  }
  /* Main frame: reserve space on the right ONLY for the main content wrapper */
  @media (min-width: 641px){
    /* We will tag the first wrapper with 'content-root' below */
    .content-root{
      padding-right: var(--reserve-right);
      box-sizing: border-box;
    }
  }
</style>


<style>
  @media (min-width: 641px){
    /* Tighten gutters when embedded; still okay standalone */
    :root { --site-gutter: clamp(8px, 1vw, 16px); }
    .content-root,
    .content-root > .mx-auto,
    .content-root .calculator-container{
      width: calc(100vw - var(--reserve-right));
      max-width: none !important;
      box-sizing: border-box;
    }
    .content-root,
    .content-root > .mx-auto{
      margin-left: 0 !important;
      margin-right: 0 !important;
      padding-left: var(--site-gutter) !important;
      padding-right: var(--reserve-right) !important;
    }
  }
</style>
<script>
(function(){
  function setReserve(){
    var minReserve = Math.round(window.innerWidth * 0.18); // allow tighter than 20% if agent is narrower
    var gap = 12;
    var agent = document.querySelector('#agent-window, .agent-window');
    var reserve = minReserve;
    if (agent){
      var w = agent.getBoundingClientRect().width;
      if (w > 0){
        reserve = Math.max(minReserve, Math.ceil(w + gap));
      }
    }
    document.documentElement.style.setProperty('--reserve-right', reserve + 'px');
    document.documentElement.style.setProperty('--site-gutter', 'clamp(8px, 1vw, 16px)');
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setReserve);
  } else {
    setReserve();
  }
  window.addEventListener('resize', setReserve);
})();
</script>


<style>
  #goal-save-monthly{ background:#e3f2fd; border-color:#bbdefb; color:#0d47a1; }
  #goal-save-monthly:hover{ background:#d1e9ff; }
  #goal-extend-term{ background:#ede7f6; border-color:#d1c4e9; color:#4a148c; }
  #goal-extend-term:hover{ background:#e0d7f2; }
  #goal-reduce-term{ background:#fff8e1; border-color:#ffe0b2; color:#e65100; }
  #goal-reduce-term:hover{ background:#ffefc6; }
  #goal-own-my-car{ background:#e0f2f1; border-color:#b2dfdb; color:#004d40; }
  #goal-own-my-car:hover{ background:#cff0ee; }
  #goal-reset-results{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
  #goal-reset-results:hover{ background:#fecaca; }
</style>


<style>
  /* Lock: no left border/gutter; keep a fixed 15% reserve on the right for desktop */
  @media (min-width: 641px){
    :root { --reserve-right: 15vw; --site-gutter: 0px; }
    .content-root,
    .content-root > .mx-auto{
      margin-left: 0 !important;
      padding-left: 0 !important;
      padding-right: var(--reserve-right) !important;
      width: auto !important;
      max-width: none !important;
      box-sizing: border-box !important;
    }
    .content-root .calculator-container{
      width: 100% !important;
      max-width: 100% !important;
    }
  }
</style>
<script>
  // Ensure JS-driven sizing can't re-introduce a different reserve: force 15vw always.
  (function(){
    function lockReserve(){
      document.documentElement.style.setProperty('--reserve-right', '15vw');
      document.documentElement.style.setProperty('--site-gutter', '0px');
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', lockReserve);
    } else {
      lockReserve();
    }
    window.addEventListener('resize', lockReserve);
  })();
</script>


<style>
  :root { --agent-gap: 5px; }
  @media (min-width: 641px){
    /* Stretch main frame to full width and reserve exactly (agent width + 5px) on the right */
    .content-root,
    .content-root > .mx-auto{
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
      padding-left: 0 !important;         /* no left border/gutter */
      padding-right: calc(var(--agent-measured-width, 0px) + var(--agent-gap)) !important;
      box-sizing: border-box !important;
    }
    .content-root .calculator-container{
      width: 100% !important;
      max-width: 100% !important;
    }
    /* Neutralize any earlier percentage-based reserves */
    :root { --reserve-right: 0px !important; }
    body.agent-present{ padding-right: 0 !important; }
    body.agent-present::before{ content:none !important; display:none !important; width:0 !important; }
  }
</style>
<script>
  (function(){
    function setMeasuredWidth(){
      var agent = document.querySelector('#agent-window, .agent-window');
      var w = 0;
      if (agent){
        var rect = agent.getBoundingClientRect();
        w = Math.max(0, Math.floor(rect.width));
        document.body.classList.add('agent-present');
      } else {
        document.body.classList.remove('agent-present');
      }
      document.documentElement.style.setProperty('--agent-measured-width', w + 'px');
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', setMeasuredWidth);
    } else {
      setMeasuredWidth();
    }
    window.addEventListener('resize', setMeasuredWidth);
    /* Watch DOM in case the agent mounts later */
    var obs = new MutationObserver(setMeasuredWidth);
    obs.observe(document.documentElement, { childList:true, subtree:true });
  })();
</script>


<style>
  /* Right-side gutter locked to 15% for the main frame only (desktop) */
  @media (min-width: 641px){
    :root { --reserve-right: 15vw; }
    .content-root,
    .content-root > .mx-auto{
      width: 100% !important;
      max-width: none !important;
      margin-right: 0 !important;
      padding-right: var(--reserve-right) !important; /* 15% only */
      box-sizing: border-box !important;
    }
  }
</style>
<script>
  (function(){
    function lock(){
      document.documentElement.style.setProperty('--reserve-right', '15vw');
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', lock);
    } else {
      lock();
    }
    window.addEventListener('resize', lock);
  })();
</script>


<style>
  /* 15% right gutter INSIDE the main frame (desktop only) */
  @media (min-width: 641px){
    /* Neutralize the v4 outer reserve so we don't double-pad */
    .content-root,
    .content-root > .mx-auto{
      padding-right: 0 !important;
    }
    /* Apply the gutter inside the main frame container only */
    .calculator-container{
      padding-right: calc(15%) !important;
      box-sizing: border-box !important;
      width: 100% !important;
      max-width: 100% !important;
    }
  }
</style>


<style>
  @media (min-width: 641px){
    .content-root,
    .content-root > .mx-auto{ padding-right: 0 !important; }
    .calculator-container{ padding-right: 20% !important; }
  }
</style>


<style>
  /* Make the Agent column always visible and independently scrollable */
  @media (min-width: 641px){
    #agent-window, .agent-window{
      position: fixed;
      top: var(--site-gutter, 12px);
      right: var(--site-gutter, 12px);
      bottom: var(--site-gutter, 12px);
      width: clamp(280px, 28vw, 420px);
      max-width: 42vw; /* safety on very narrow desktops */
      display: flex;
      flex-direction: column;
      overflow: auto;          /* scroll inside the agent if content is long */
      z-index: 9999;
      background: inherit;     /* keep any existing background */
    }
    /* Optional: ensure inner content doesn't add unexpected extra margins */
    #agent-window > *, .agent-window > *{
      margin-top: 0;
    }
  }
  /* On small screens, let the agent behave normally (no fixed full height) */
  @media (max-width: 640px){
    #agent-window, .agent-window{
      position: fixed;
      left: var(--site-gutter, 12px);
      right: var(--site-gutter, 12px);
      bottom: var(--site-gutter, 12px);
      top: auto;
      max-height: 60vh;
      overflow: auto;
    }
  }
</style>


<style>
  /* Product Sourcing Results table: cap width to 80% and center; never use inner scrollbars */
  @media (min-width: 641px){
    .psr-wrap{
      overflow-y: visible !important;
      max-height: none !important;
    }
    .psr-wrap .band-table{
      width: 100% !important;        /* allow full width on narrow screens */
      max-width: 80% !important;     /* cap width on wider screens */
      margin-left: auto !important;  /* center the table */
      margin-right: auto !important;
    }
  }
  /* Extra safety: prevent vertical mini-scrollbars anywhere in this table */
  .psr-wrap, .psr-wrap *{ overflow-y: visible !important; }
</style>
<script>
  // Tag the wrapper that contains the Product Sourcing Results table
  (function(){
    function tagPSR(){
      var t = document.getElementById('creditBandTable');
      if (!t) return;
      var wrap = t.closest ? t.closest('.band-wrap') : null;
      if (!wrap){ wrap = t.parentElement; }
      if (wrap && !wrap.classList.contains('psr-wrap')){
        wrap.classList.add('psr-wrap');
      }
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', tagPSR);
    } else {
      tagPSR();
    }
  })();
</script>


<style id="confirm-anchor-css">
  /* Anchor the confirm modal next to the Submit button (left side) */
  #confirmSubmitModal .modal-content {
    position: fixed !important;   /* anchor to viewport so scroll doesn't drift */
    top: 12px;                    /* will be overridden by JS */
    left: 12px;                   /* will be overridden by JS */
    margin: 0 !important;
    transform: none !important;
    max-width: 420px;             /* keep a sensible width */
    width: auto;
  }
  /* Optional: make only the confirm modal overlay slightly clearer to show it's contextual */
  #confirmSubmitModal.modal {
    background-color: rgba(0,0,0,0.35);
  }
</style>


<!-- Injected by ChatGPT: Embed whitespace fixes -->
<style id="embed-whitespace-fixes">
  /* Collapse forced heights on the PSR area */
  .band-wrap { height:auto !important; max-height:none !important; min-height:0 !important; }

  /* Avoid large placeholder reserves from content-visibility */
  #results-section, #finance-form-embed-container {
    content-visibility: visible !important;
    contain-intrinsic-size: auto !important;
  }

  /* Neutralize any 100vh constraint inside an embed */
  .min-h-screen { min-height: 0 !important; }
  .content-root { min-height: 0 !important; }

  /* Safety: ensure common PSR holders don't reserve space */
  #creditBandTable, .psr-container, .psr-holder { min-height: 0 !important; }
</style>

</head>
<body class="text-gray-800">
    <div class="content-root min-h-screen pb-8 px-4 sm:px-6 lg:px-8 w-full">
        <div class="mx-auto">
            <div class="calculator-container rounded-xl p-6 md:p-8 w-full">
                <div id="vehicle-details-section" class="bg-white rounded-xl p-6 shadow-md border border-gray-100 mb-4">
                    <div class="flex items-center mb-0">
                        <div class="bg-light-green p-3 rounded-full mr-4"><img id="colin-illustration"
     class="w-20 h-20 sm:w-24 sm:h-24 rounded-full object-cover mr-4 border-4 border-racing-green-200 shadow-lg"
     alt="Colin Compare mascot">
<script>
  (function() {
    const colinImages = [
      "https://i.ibb.co/8knpyxf/lite-Colin-Compare.jpg",
      "https://i.ibb.co/kgFgNGhR/small-colincompare-happy-save.jpg",
      "https://i.ibb.co/XZLFpB3y/colincompare-point-laptop.jpg",
      "https://i.ibb.co/SDP6CGQb/header-colincompare-laptop-image.jpg",
      "https://i.ibb.co/YBrvjZtF/colincompare-laptop-image.jpg",
      "https://i.ibb.co/Fq5gxKLv/colincompare-desk-image.jpg",
      "https://i.ibb.co/6RPJZJCr/Colin-Compare.jpg",
      "https://i.ibb.co/WNY5CMZz/Colin-Convertible-Coins.jpg"
    ];
    const img = document.getElementById("colin-illustration");
    let idx = Math.floor(Math.random() * colinImages.length);
    img.src = colinImages[idx];
    img.onerror = function() {
      idx = (idx + 1) % colinImages.length;
      img.src = colinImages[idx];
    };
  })();
</script></div>
                        <h2 class="text-xl font-semibold text-racing-green-700 flex items-center"><span class="bg-racing-green-100 text-racing-green-700 rounded-full w-7 h-7 inline-flex items-center justify-center mr-2 text-sm">A</span>Vehicle Details - Finance Finder</h2>
                    </div>
                    <p class="text-sm text-gray-600 mt-0 mb-1">ENTER YOUR CAR REGISTRATION TO START</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4 mb-4">
                        <div class="sm:col-span-2 field-group-bg p-3 rounded-md flex justify-center">
                            <div class="w-full max-w-sm">
                                <label for="vrn-calc" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Registration (VRN)</label>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="vrn-calc" name="vrn-calc" class="pulse-input-glow-animation input-field w-full px-4 py-2 border border-gray-300 rounded-lg uppercase" placeholder="e.g. AB12 CDE" required aria-label="Vehicle registration">
                                    <button type="button" id="vrn-lookup-btn-calc" class="pulse-element-animation bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all flex-shrink-0" aria-label="Find vehicle">
                                        <svg id="vrn-spinner-calc" class="animate-spin h-5 w-5 text-racing-green hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                        <span id="vrn-lookup-text-calc">Find</span>
                                    </button>
                                </div>
                                <span class="error-message" id="vrn-error-calc">Please enter a valid UK VRN.</span>
                                <span id="vrn-lookup-status-calc" class="text-sm mt-1" aria-live="polite"></span>
    <script>
    (function(){
      try {
        var vrnInput = document.getElementById('vrn-calc');
        var btn = document.getElementById('vrn-lookup-btn-calc');
        if (vrnInput && btn) {
          vrnInput.addEventListener('keydown', function(e){
            if (e.key === 'Enter') { e.preventDefault(); btn.click(); }
          });
        }
      } catch(e){ console.warn('enter key bind failed', e); }
    })();
    </script>
                            </div>
                        </div>
                        <div id="basic-vehicle-details" class="hidden col-span-full grid grid-cols-2 sm:grid-cols-4 gap-2">
                            <div><label for="make-calc" class="block text-sm font-medium text-gray-700 mb-1">Make</label><input type="text" id="make-calc" name="make-calc" list="manufacturer-list-calc" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg" required maxlength="20" aria-label="Vehicle make"><datalist id="manufacturer-list-calc"></datalist></div>
                            <div><label for="model-calc" class="block text-sm font-medium text-gray-700 mb-1">Model</label><input type="text" id="model-calc" name="model-calc" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg" required aria-label="Vehicle model"></div>
                            <div><label for="year-calc" class="block text-sm font-medium text-gray-700 mb-1">Year</label><input type="text" id="year-calc" name="year-calc" min="1950" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg" required maxlength="4" aria-label="Manufacture year"></div>
                            <div><label for="colour-calc" class="block text-sm font-medium text-gray-700 mb-1">Colour</label><input type="text" id="colour-calc" name="colour-calc" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly placeholder="Auto-filled" maxlength="10" aria-label="Vehicle colour"></div>
                        </div>
                        <div id="additional-vehicle-details" class="hidden col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 items-start">
                            <div><label for="vin-calc" class="block text-sm font-medium text-gray-700 mb-1">VIN</label><input type="text" id="vin-calc" name="vin-calc" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly placeholder="Auto-filled" aria-label="VIN"></div>
                            <div><label for="agreement-number-calc" class="block text-sm font-medium text-gray-700 mb-1">Agreement Number</label><input type="text" id="agreement-number-calc" name="agreement-number-calc" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly placeholder="N/A" aria-label="Agreement number"></div>
                            <div><label for="finance-company-calc" class="block text-sm font-medium text-gray-700 mb-1">Finance Company</label><input type="text" id="finance-company-calc" name="finance-company-calc" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly placeholder="N/A" aria-label="Finance company"></div>
                            <div><label for="finance-type" class="block text-sm font-medium text-gray-700 mb-1">Finance Type</label><select id="finance-type" class="select-field input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" aria-label="Finance type"><option value="pcp">PCP (Balloon Payment)</option><option value="hp">HP (No Balloon Payment)</option></select></div>
                            <div><label for="current-start-date" class="block text-sm font-medium text-gray-700 mb-1">Car Purchase Date</label><input type="date" id="current-start-date" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" aria-label="Car purchase date"></div>
                            <div><label for="current-term" class="block text-sm font-medium text-gray-700 mb-1 required-field">Original Term (months)</label><input type="text" id="current-term" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="48" required inputmode="numeric" aria-label="Original term"></div>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-8"><button id="find-savings-btn" class="hidden bg-racing-green-700 hover:bg-racing-green-800 text-white font-medium py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-racing-green-500 focus:ring-opacity-50 text-lg">Find Savings</button></div>
                <div class="mt-8 mb-8 p-4 bg-racing-green-50 border border-racing-green-200 rounded-lg text-sm text-racing-green-800"><p>If you have your Finance Agreement to hand, you can use this for a more accurate comparison. If you would prefer to speak to someone, <a href="https://www.comparemyfinance.co.uk/contact-us" target="_blank" rel="noopener noreferrer" class="font-bold underline hover:text-racing-green-600">contact us</a>.</p></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div id="section-1-wrapper" class="hidden">
                        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100 h-full flex flex-col">
                            <h2 class="text-xl font-semibold text-racing-green-700 mb-4 flex items-center"><span class="bg-racing-green-100 text-racing-green-700 rounded-full w-7 h-7 inline-flex items-center justify-center mr-2 text-sm">1</span>Your Current Finance</h2>
                            <p class="text-sm text-gray-600 -mt-2 mb-4">Please enter your original agreement details or click Estimate below.</p>
                            <div class="space-y-4">
                                <div class="field-group-bg p-3 rounded-md space-y-4">
                                    <div><label for="current-price" id="current-price-label" class="block text-sm font-medium text-gray-700 mb-1 required-field">Original Car Purchase Price (£)</label><input type="text" id="current-price" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required inputmode="decimal" aria-label="Original car price"></div>
                                    <div><label for="current-deposit" class="block text-sm font-medium text-gray-700 mb-1 required-field">Deposit Paid (£)</label><input type="text" id="current-deposit" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required inputmode="decimal" value="0" aria-label="Deposit paid"></div>
                                    <div><label for="current-interest" class="block text-sm font-medium text-gray-700 mb-1 required-field">Current APR (%)</label><input type="text" id="current-interest" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Estimated if unknown" required inputmode="decimal" aria-label="Current APR"></div>
                                    <div><label for="current-balloon" class="block text-sm font-medium text-gray-700 mb-1">Balloon (£) - GFV</label><input type="text" id="current-balloon" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Estimated if unknown" inputmode="decimal" aria-label="Balloon payment"></div>
                                    <button type="button" id="i-dont-have-figures-btn" class="w-full bg-racing-green-700 hover:bg-racing-green-800 text-white font-medium py-1 px-3 text-sm rounded-lg transition pulse-cta-animation">ESTIMATE my APR and Balloon</button>
                                    <div id="monthly-payment-container" class="hidden bg-green-100 p-2 rounded-md"><label for="current-monthly-payment" class="block text-sm font-medium text-gray-700 mb-1">Enter Monthly Payment (£)</label><input id="current-monthly-payment" inputmode="decimal" placeholder="Enter Payment to Estimate" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg" value="" aria-label="Monthly payment"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="hidden"><label for="current-payments-made" class="block text-sm font-medium text-gray-700 mb-1">Payments Made So Far</label><input type="text" id="current-payments-made" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none bg-gray-50" readonly placeholder="0" aria-label="Payments made"><p class="text-xs text-gray-500 mt-1">Auto-Calculated</p></div></div>
                            </div>
                            <div class="mt-auto pt-6 text-center"><button id="section-1-next-btn" class="bg-racing-green-700 hover:bg-racing-green-800 text-white font-medium py-3 px-8 text-lg rounded-lg transition duration-300 ease-in-out">Next</button></div>
                        </div>
                    </div>
                    <div id="section-2-wrapper" class="hidden">
                        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100 h-full flex flex-col">
                            <h2 class="text-xl font-semibold text-racing-green-700 mb-4 flex items-center"><span class="bg-racing-green-100 text-racing-green-700 rounded-full w-7 h-7 inline-flex items-center justify-center mr-2 text-sm">2</span>New Finance Option</h2>
                            <p class="text-sm text-gray-600 -mt-2 mb-4">Choose your credit band to see an estimate for your new finance agreement.</p>
                            <div class="space-y-4">
                                <div class="field-group-bg p-3 rounded-md space-y-1">
                                    <label for="credit-score" class="block text-sm font-medium text-gray-700 mb-1">Credit Score Band</label>
                                    <select id="credit-score" class="select-field input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" aria-label="Credit score"><option value="very-good">Excellent (800+)</option><option value="good">Good (720-799)</option><option value="fair">Fair (660-719)</option><option value="poor">Low (580-659)</option><option value="very-poor">Very Low (below 580)</option></select>
                                    <p class="text-xs text-gray-500 pt-1">All Credit Ref. Agency scores vary</p>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                    <div><label for="new-price" class="block text-sm font-medium text-gray-700 mb-1">Est. Settlement/Finance Amount Required (£)</label><input type="text" id="new-price" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none bg-gray-50" readonly placeholder="0"><p class="text-xs text-gray-500 mt-1">Auto-Calculated</p></div>
                                    <div><label for="new-interest" class="block text-sm font-medium text-gray-700 mb-1">New APR (%)</label><input type="text" id="new-interest" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="8.9" inputmode="decimal" value="8.9"><p class="text-xs text-gray-500 mt-1">Typical APR based on Credit Band averages</p></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                    <div><label for="new-term" class="block text-sm font-medium text-gray-700 mb-1">New Term (months)</label><input type="text" id="new-term" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="36" inputmode="numeric"><p class="text-xs text-gray-500 mt-1">Remaining Term</p></div>
                                    <div><label for="new-balloon" class="block text-sm font-medium text-gray-700 mb-1">New Balloon Payment (£)</label><input type="text" id="new-balloon" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="0" inputmode="decimal"><p class="text-xs text-gray-500 mt-1">Auto-Estimated</p></div>
                                </div>
                                <div class="pt-2"><label class="flex items-center"><input type="checkbox" id="early-repayment-check" class="rounded text-racing-green-700 focus:ring-racing-green-500 h-4 w-4 border-gray-300" checked><span class="ml-2 text-sm text-gray-700">inc. fees to repay early</span></label></div>
                            </div>
                            <div class="mt-auto pt-6 text-center"><button id="request-quote-btn" class="bg-racing-green-700 hover:bg-racing-green-800 text-white font-medium py-3 px-8 text-lg rounded-lg transition duration-300 ease-in-out">See my Results</button></div>
                        </div>
                    </div>
                </div>
                <div id="section-3-wrapper" class="hidden mt-8 bg-white rounded-xl p-6 shadow-md border border-gray-100">
                    <h2 class="text-xl font-semibold text-racing-green-700 mb-4 flex items-center"><span class="bg-racing-green-100 text-racing-green-700 rounded-full w-7 h-7 inline-flex items-center justify-center mr-2 text-sm">3</span>Results shown Next, let us know a little about you...</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div><label for="contact-name" class="block text-sm font-medium text-gray-700 mb-1 required-field">Name</label><input type="text" id="contact-name" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Your full name" required></div>
                        <div><label for="contact-email" class="block text-sm font-medium text-gray-700 mb-1 required-field">Email</label><input type="email" id="contact-email" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="your@email.com" required></div>
                        <div><label for="contact-phone" class="block text-sm font-medium text-gray-700 mb-1 required-field">Phone Number</label><input type="tel" id="contact-phone" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Your phone number" required></div>
                    </div>
                    <div class="text-center"><button id="calculate-btn" class="bg-racing-green-700 hover:bg-racing-green-800 text-white font-medium py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-racing-green-500 focus:ring-opacity-50 text-lg">Compare It!</button><p class="text-xs text-gray-500 mt-2">Fields marked with * are required. By clicking, you agree to be contacted.</p></div>
                </div>
                <div id="results-section" class="mt-10 hidden full-span w-full" aria-live="polite" style="grid-column:1 / -1;">
                    <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100 mb-6">
                        <div class="flex justify-center items-center mb-6 relative">
                            <img id="savings-illustration"
     class="w-20 h-20 sm:w-24 sm:h-24 rounded-full object-cover mr-4 border-4 border-racing-green-200 shadow-lg"
     alt="Colin Compare mascot">
<script>
  (function() {
    const savingsImages = [
      "https://i.ibb.co/8knpyxf/lite-Colin-Compare.jpg",
      "https://i.ibb.co/kgFgNGhR/small-colincompare-happy-save.jpg",
      "https://i.ibb.co/XZLFpB3y/colincompare-point-laptop.jpg",
      "https://i.ibb.co/SDP6CGQb/header-colincompare-laptop-image.jpg",
      "https://i.ibb.co/YBrvjZtF/colincompare-laptop-image.jpg",
      "https://i.ibb.co/Fq5gxKLv/colincompare-desk-image.jpg",
      "https://i.ibb.co/6RPJZJCr/Colin-Compare.jpg",
      "https://i.ibb.co/WNY5CMZz/Colin-Convertible-Coins.jpg"
    ];
    const img = document.getElementById("savings-illustration");
    let idx = Math.floor(Math.random() * savingsImages.length);
    img.src = savingsImages[idx];
    img.onerror = function() {
      idx = (idx + 1) % savingsImages.length;
      img.src = savingsImages[idx];
    };
  })();
</script>
                            <h2 class="text-2xl sm:text-3xl font-bold text-racing-green-700 text-center">ILLUSTRATIVE SAVINGS</h2>
                        </div>
                        <p class="text-center text-gray-600 -mt-4 mb-6">Colin Compare has found your Results...</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div class="summary-box bg-racing-green-50 rounded-lg p-5 shadow-sm text-center">
                                <p class="text-gray-600 mb-2 text-lg">Monthly Payment</p>
                                <div class="flex items-center justify-center"><p id="monthly-difference" class="text-3xl font-bold text-racing-green-700">-£0</p><span id="monthly-arrow" class="ml-2 text-2xl"></span></div>
                                <div class="mt-2 text-sm space-y-1"><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">Current:</span><span id="summary-current-monthly" class="font-medium">£0</span></div><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">New:</span><span id="summary-new-monthly" class="font-medium">£0</span></div></div>
                            </div>
                            <div class="summary-box bg-racing-green-50 rounded-lg p-5 shadow-sm text-center">
                                <p class="text-gray-600 mb-2 text-lg">Balance to Own</p>
                                <div class="flex items-center justify-center"><p id="total-savings" class="text-3xl font-bold text-racing-green-700">£0</p><span id="savings-arrow" class="ml-2 text-2xl"></span></div>
                                <div class="mt-2 text-sm space-y-1"><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">Current:</span><span id="summary-current-total" class="font-medium">£0</span></div><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">New:</span><span id="summary-new-total" class="font-medium">£0</span></div></div>
                            </div>
                            <div class="summary-box bg-racing-green-50 rounded-lg p-5 shadow-sm text-center">
                                <p class="text-gray-600 mb-2 text-lg">Term Length</p>
                                <div class="flex items-center justify-center"><p id="time-savings" class="text-3xl font-bold text-gray-700">0 months</p><span id="time-arrow" class="ml-2 text-2xl"></span></div>
                                <div class="mt-2 text-sm space-y-1"><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">Current:</span><span id="summary-current-term" class="font-medium">0 mo</span></div><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">New:</span><span id="summary-new-term" class="font-medium">0 mo</span></div></div>
                            </div>
                            <div class="summary-box bg-racing-green-50 rounded-lg p-5 shadow-sm text-center">
                                <p class="text-gray-600 mb-2 text-lg">Balloon Change</p>
                                <div class="flex items-center justify-center"><p id="equity-change-value" class="text-3xl font-bold text-black">£0</p><span id="equity-change-arrow" class="ml-2 text-2xl"></span></div>
                                <div class="mt-2 text-sm space-y-1"><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">Current:</span><span id="summary-current-balloon-equity" class="font-medium">£0</span></div><div class="flex justify-center items-center"><span class="text-gray-500 mr-2">New:</span><span id="summary-new-balloon-equity" class="font-medium">£0</span></div></div>
                            </div>
                        </div>
<div id="goal-gauge-wrap" class="my-2 grid grid-cols-1 gap-8 items-start full-span" style="grid-column:1 / -1;">
  <div id="goal-section" class="relative w-full">
    <h3 class="text-lg font-semibold text-gray-800 text-center mb-3">Want Alternatives...What's your Main Goal?</h3>
    <div class="flex flex-col items-center gap-4">
      <div class="flex flex-row flex-wrap justify-center items-center gap-4 w-full full-span">
        <button id="goal-save-monthly" class="goal-btn text-base font-medium py-3 px-6 rounded-lg bg-gray-100 text-gray-700 border border-gray-200 w-auto">SAVE £50pm</button>
        <button id="goal-extend-term" class="goal-btn text-base font-medium py-3 px-6 rounded-lg bg-gray-100 text-gray-700 border border-gray-200 w-auto">EXTEND +1</button>
          <button id="goal-reduce-term" class="goal-btn text-base font-medium py-3 px-6 rounded-lg bg-amber-100 text-amber-800 border border-amber-200 hover:bg-amber-200 w-auto">REDUCE -1</button>
        <button id="goal-own-my-car" class="goal-btn text-base font-medium py-3 px-6 rounded-lg bg-gray-100 text-gray-700 border border-gray-200 w-auto">OWN MY CAR</button>
          <button id="goal-reset-results" class="goal-btn active-goal text-base font-medium py-3 px-6 rounded-lg bg-red-100 text-red-700 border border-red-200 hover:bg-red-200 w-auto">RESET RESULTS</button>
      </div>
<div class="mt-6 w-full" >
  <div class="flex items-center justify-between mb-2">
    <h3 class="text-xl font-bold text-racing-green-700">
    <div class="flex items-center gap-3 justify-center flex-wrap text-center">
      Product Sourcing Results</h3>
      <button id="psr-update-btn" class="psr-update glow text-xs md:text-sm font-semibold py-2 px-3 rounded-md bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-400 focus:outline-none" style="display:none!important">
        UPDATE
      </button>
    </div>
  </div>
  <div class="band-wrap" style="width:100%;">
    <table class="band-table" id="creditBandTable" aria-label="Credit band estimates">
      <thead>
        <tr>
          <th style="min-width:160px">Band</th>
          <th>Rate</th>
          <th>New Balloon</th>
          <th>New Term</th>
          <th>Monthly</th>
          <th>Total (to own)</th>
        </tr>
      </thead>
<tbody>
  <tr data-band="EXCELLENT"><th>EXCELLENT</th><td>8.90%</td><td>£0</td><td>0</td><td>£0</td><td>£0</td></tr>
  <tr data-band="GOOD"><th>GOOD</th><td>9.90%</td><td>£0</td><td>0</td><td>£0</td><td>£0</td></tr>
  <tr data-band="FAIR"><th>FAIR</th><td>10.90%</td><td>£0</td><td>0</td><td>£0</td><td>£0</td></tr>
  <tr data-band="LOW"><th>LOW</th><td>19.90%</td><td>£0</td><td>0</td><td>£0</td><td>£0</td></tr>
  <tr data-band="VERY LOW"><th>VERY LOW</th><td>22.90%</td><td>£0</td><td>0</td><td>£0</td><td>£0</td></tr>
</tbody>
</tbody>
    </table>
  </div>
</div>
  <div id="credit-score-gauge-wrapper" style="width:100%;" class="flex justify-center md:justify-end">
    <div class="gauge-outer-container" aria-label="Credit score gauge">
      <div class="gauge">
        <div class="gauge__overlay"></div>
        <div class="gauge__needle" id="credit-gauge-needle"></div>
        <div class="gauge__pivot"></div>
        <span class="gauge__label gauge__label--poor">POOR</span>
        <span class="gauge__label gauge__label--good">GOOD</span>
        <div class="gauge__value-display">
          <div id="credit-gauge-value" class="gauge__value">0</div>
        </div>
      </div>
      <div class="gauge__main-label">CREDIT SCORE</div>
      <p class="mt-1 text-sm text-black text-center">Soft Search - No Impact on your credit score.</p>
    </div>
  </div>
</div>
<div class="my-6 flex justify-center"><button id="save-now-refinance-btn" class="refinance-trigger text-lg font-bold py-3 px-6 rounded-lg bg-british-racing-green text-white hover:bg-british-racing-green-darker w-full md:w-2/3 shadow-md transition transform hover:scale-105">SAVE NOW - REFINANCE</button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-2">
                            <div class="summary-box bg-racing-green-50 rounded-lg p-5 shadow-sm text-center">
                                <p class="text-gray-600 mb-2 text-lg">Balance to Own</p>
                                <div class="flex justify-around items-center h-full">
                                    <div class="text-center w-1/2 px-1">
                                        <p class="text-xs text-gray-500 mb-1">Current Total</p>
                                        <svg id="current-total-car" viewBox="0 0 150 70" class="w-full h-auto mx-auto"><path d="M10 50 Q5 30 10 25 L25 25 L35 10 L115 10 L125 25 L140 25 Q145 30 140 50 Z" fill="#E9E9E9" stroke="#4A5568" stroke-width="1"/><circle cx="35" cy="55" r="10" fill="#4A5568" stroke="#1A202C" stroke-width="1"/><circle cx="115" cy="55" r="10" fill="#4A5568" stroke="#1A202C" stroke-width="1"/><text id="current-total-car-text" x="75" y="35" class="car-svg-text fill-current text-black">£0</text></svg>
                                    </div>
                                    <div class="text-center w-1/2 px-1">
                                        <p class="text-xs text-gray-500 mb-1">New Total</p>
                                        <svg id="new-total-car" viewBox="0 0 150 70" class="w-full h-auto mx-auto"><path d="M10 50 Q5 30 10 25 L25 25 L35 10 L115 10 L125 25 L140 25 Q145 30 140 50 Z" fill="#E9E9E9" stroke="#4A5568" stroke-width="1"/><circle cx="35" cy="55" r="10" fill="#4A5568" stroke="#1A202C" stroke-width="1"/><circle cx="115" cy="55" r="10" fill="#4A5568" stroke="#1A202C" stroke-width="1"/><text id="new-total-car-text" x="75" y="35" class="car-svg-text fill-current text-black">£0</text></svg>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-box bg-racing-green-50 rounded-lg p-5 shadow-sm text-center">
                                <p class="text-gray-600 mb-2 text-lg">Paid Off</p>
                                <div class="w-full max-w-[200px] mx-auto my-2">
                                    <svg id="car-graphic" viewBox="0 0 150 70" class="w-full h-auto">
                                        <defs><clipPath id="carBodyClipPath"><path d="M10 50 Q5 30 10 25 L25 25 L35 10 L115 10 L125 25 L140 25 Q145 30 140 50 Z"/></clipPath></defs>
                                        <path d="M10 50 Q5 30 10 25 L25 25 L35 10 L115 10 L125 25 L140 25 Q145 30 140 50 Z" fill="#E2E8F0" stroke="#4A5568" stroke-width="1"/><rect id="car-fill-percentage-rect" x="0" y="0" width="0%" height="100%" fill="#006837" fill-opacity="0.7" clip-path="url(#carBodyClipPath)"/><path d="M10 50 Q5 30 10 25 L25 25 L35 10 L115 10 L125 25 L140 25 Q145 30 140 50 Z" fill="none" stroke="#1A202C" stroke-width="1"/><circle cx="35" cy="55" r="10" fill="#4A5568" stroke="#1A202C" stroke-width="1"/><circle cx="115" cy="55" r="10" fill="#4A5568" stroke="#1A202C" stroke-width="1"/>
                                    </svg>
                                </div>
                                <p id="car-percentage-text" class="text-xl font-bold text-racing-green-700 mt-1">0.0%</p>
                                <p class="text-xs text-gray-500 mt-0.5">Percentage of the Original Purchase Price that will be paid off by the end of this agreement.</p>
                            </div>
                        </div>
                        <div class="mt-8 bg-racing-green-50 rounded-lg p-5 shadow-sm"><h4 class="font-medium text-racing-green-700 mb-2 text-lg">Comparison Summary</h4><p id="recommendation" class="text-gray-700 leading-relaxed text-sm">Please fill in the details above and click "Compare It!" to see your comparison.</p><p class="text-gray-700 leading-relaxed mt-2 text-sm">Note: Lender balloon payments can vary by ~10%, affecting monthly payments. For an accurate quote based on your vehicle and circumstances, please speak to an Expert.</p></div>
                        <div class="mt-8 flex justify-center"><button id="refinance-now-btn-large" class="refinance-trigger w-full md:w-2/3 bg-racing-green-700 hover:bg-racing-green-800 text-white font-bold py-4 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-101 focus:outline-none focus:ring-2 focus:ring-racing-green-500 focus:ring-opacity-50 text-2xl shadow-lg">REFINANCE NOW</button></div>
                        <div id="early-repayment-section" class="mt-6 bg-racing-green-50 rounded-lg p-5 shadow-sm hidden">
                            <h4 class="font-medium text-racing-green-700 mb-2 text-lg">Early Repayment Charges (ERC) to Switch</h4>
                            <div><p class="text-gray-700 mb-1 text-sm">Estimated ERC included in new finance:</p><p id="early-repayment-fee" class="font-medium text-racing-green-700 text-lg">£0</p><p class="mt-2 text-gray-700 text-sm"><strong>ERCs are already built into the Comparison provided</strong> if the box was ticked. You do not typically have to pay these fees upfront; they are often included in the Refinance balance if you prefer.</p></div>
                        </div>
                    </div>
                </div>
                <div id="finance-form-embed-container" class="hidden"><div class="mx-auto w-full">
<div class="progress-bar-container"><div class="progress" id="progress-bar" style="width:0%"><span id="progress-bar-text">0%</span></div></div>
<div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-8">
<form id="finance-application-form" novalidate>
<div id="form-general-error" role="alert">Please correct the errors highlighted below before proceeding.</div>
<div class="form-section active" id="section-1" data-section="1">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Personal Details Icon"><path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" fill="#004225"></path><path d="M12.0002 14.5C6.99016 14.5 2.91016 17.86 2.91016 22C2.91016 22.28 3.13016 22.5 3.41016 22.5H20.5902C20.8702 22.5 21.0902 22.28 21.0902 22C21.0902 17.86 17.0102 14.5 12.0002 14.5Z" fill="#004225"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">APPLY - Personal Details</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
<div class="md:col-span-2"><label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title</label><select id="title" name="title" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="honorific-prefix"><option value="">Select</option><option value="Mr">Mr</option><option value="Mrs">Mrs</option><option value="Miss">Miss</option><option value="Ms">Ms</option><option value="Dr">Dr</option></select></div>
<div class="md:col-span-5"><label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name</label><input type="text" id="firstName" name="firstName" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="given-name"></div>
<div class="md:col-span-5"><label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label><input type="text" id="lastName" name="lastName" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="family-name"></div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label><input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="email"><span class="error-message" id="email-error">Please enter a valid email address</span></div>
<div><label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label><input type="tel" id="phone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-xl" placeholder="e.g. 07123456789" required autocomplete="tel-national" inputmode="tel"><span class="error-message" id="phone-error">Please enter a valid UK phone number</span></div>
<div><label for="dob" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label><input type="date" id="dob" name="dob" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="bday"><span class="error-message" id="dob-error">You must be at least 17 years old.</span></div>
<div><label class="block text-sm font-medium text-gray-700 mb-1">Marital Status</label><div class="grid grid-cols-2 gap-3"><button type="button" class="btn-option px-4 py-2 rounded-xl text-center" data-value="Single" data-target="maritalStatus">Single</button><button type="button" class="btn-option px-4 py-2 rounded-xl text-center" data-value="Married" data-target="maritalStatus">Married</button><button type="button" class="btn-option px-4 py-2 rounded-xl text-center" data-value="Divorced" data-target="maritalStatus">Divorced</button><button type="button" class="btn-option px-4 py-2 rounded-xl text-center" data-value="Widowed" data-target="maritalStatus">Widowed</button></div><input type="hidden" id="maritalStatus" name="maritalStatus" required><span class="error-message" id="maritalStatus-error">Please select a marital status</span></div>
</div>
<div class="flex justify-end"><button type="button" class="next-btn bg-racing-green text-white px-6 py-2 rounded-xl hover:bg-opacity-90 transition-all">Next Step</button></div>
</div>
<div class="form-section" id="section-2" data-section="2">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Address History Icon"><path d="M12 3L4 9V21H20V9L12 3Z" stroke="#004225" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#004225"></path><path d="M9 21V12H15V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">Address History</h2>
</div>
<div class="mb-6"><h3 class="text-lg font-medium text-racing-green mb-4">Current Address</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div class="md:col-span-2"><label for="currentAddressLine1" class="block text-sm font-medium text-gray-700 mb-1">Address Line 1</label><input type="text" id="currentAddressLine1" name="currentAddressLine1" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required placeholder="Start typing your address or postcode" autocomplete="address-line1"></div>
<div><label for="currentAddressLine2" class="block text-sm font-medium text-gray-700 mb-1">Address Line 2 (optional)</label><input type="text" id="currentAddressLine2" name="currentAddressLine2" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="address-line2"></div>
<div><label for="currentCity" class="block text-sm font-medium text-gray-700 mb-1">City</label><input type="text" id="currentCity" name="currentCity" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="address-level2"></div>
<div><label for="currentPostcode" class="block text-sm font-medium text-gray-700 mb-1">Postcode</label><input type="text" id="currentPostcode" name="currentPostcode" class="w-full px-4 py-2 border border-gray-300 rounded-xl" placeholder="e.g. AB12 3CD" required autocomplete="postal-code"><span class="error-message" id="currentPostcode-error">Please enter a valid UK postcode</span></div>
<div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
<div><label class="block text-sm font-medium text-gray-700 mb-1">Time at Address</label><div class="grid grid-cols-2 gap-3"><div><label for="currentAddressYears" class="block text-xs text-gray-500 mb-1">Years</label><input type="number" id="currentAddressYears" name="currentAddressYears" min="0" max="99" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric"></div><div><label for="currentAddressMonths" class="block text-xs text-gray-500 mb-1">Months</label><input type="number" id="currentAddressMonths" name="currentAddressMonths" min="0" max="11" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required value="0" inputmode="numeric"></div></div></div>
<div><label for="residentialStatus" class="block text-sm font-medium text-gray-700 mb-1">Residential Status</label><select id="residentialStatus" name="residentialStatus" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required><option value="">Please select</option><option value="Homeowner">Homeowner</option><option value="Living with parents">Living with parents</option><option value="Tenant">Tenant</option><option value="Council tenant">Council tenant</option><option value="Joint owner">Joint owner</option></select></div>
</div>
</div>
<div id="previousAddressContainer" class="collapsible-section is-collapsed mt-8 pt-6 border-t border-gray-200"><h3 class="text-lg font-medium text-racing-green mb-4">Previous Address</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label for="previousAddressLine1" class="block text-sm font-medium text-gray-700 mb-1">Address Line 1</label><input type="text" id="previousAddressLine1" name="previousAddressLine1" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="address-line1"></div>
<div><label for="previousAddressLine2" class="block text-sm font-medium text-gray-700 mb-1">Address Line 2 (optional)</label><input type="text" id="previousAddressLine2" name="previousAddressLine2" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="address-line2"></div>
<div><label for="previousCity" class="block text-sm font-medium text-gray-700 mb-1">City</label><input type="text" id="previousCity" name="previousCity" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="address-level2"></div>
<div><label for="previousPostcode" class="block text-sm font-medium text-gray-700 mb-1">Postcode</label><input type="text" id="previousPostcode" name="previousPostcode" class="w-full px-4 py-2 border border-gray-300 rounded-xl" placeholder="e.g. AB12 3CD" autocomplete="postal-code"><span class="error-message" id="previousPostcode-error">Please enter a valid UK postcode</span></div>
<div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
<div><label class="block text-sm font-medium text-gray-700 mb-1">Time at Previous Address</label><div class="grid grid-cols-2 gap-3"><div><label for="previousAddressYears" class="block text-xs text-gray-500 mb-1">Years</label><input type="number" id="previousAddressYears" name="previousAddressYears" min="0" max="99" class="w-full px-4 py-2 border border-gray-300 rounded-xl" inputmode="numeric"></div><div><label for="previousAddressMonths" class="block text-sm font-medium text-gray-700 mb-1">Months</label><input type="number" id="previousAddressMonths" name="previousAddressMonths" min="0" max="11" class="w-full px-4 py-2 border border-gray-300 rounded-xl" value="0" inputmode="numeric"></div></div></div>
<div><label for="previousResidentialStatus" class="block text-sm font-medium text-gray-700 mb-1">Residential Status at Previous Address</label><select id="previousResidentialStatus" name="previousResidentialStatus" class="w-full px-4 py-2 border border-gray-300 rounded-xl"><option value="">Please select</option><option value="Homeowner">Homeowner</option><option value="Living with parents">Living with parents</option><option value="Tenant">Tenant</option><option value="Council tenant">Council tenant</option><option value="Joint owner">Joint owner</option></select></div>
</div>
</div>
</div>
</div>
<div class="flex flex-col sm:flex-row sm:justify-between items-center gap-4 mt-6"><button type="button" class="prev-btn bg-gray-300 text-gray-700 px-6 py-2 rounded-xl hover:bg-gray-400 transition-all w-full sm:w-auto">Previous Step</button><button type="button" class="next-btn bg-racing-green text-white px-6 py-2 rounded-xl hover:bg-opacity-90 transition-all w-full sm:w-auto">Next Step</button></div>
</div>
<div class="form-section" id="section-3" data-section="3">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Employment Details Icon"><path d="M20 7H4C2.89543 7 2 7.89543 2 9V19C2 20.1046 2.89543 21 4 21H20C21.1046 21 22 20.1046 22 19V9C22 7.89543 21.1046 7 20 7Z" fill="#004225"></path><path d="M16 7V5C16 3.89543 15.1046 3 14 3H10C8.89543 3 8 3.89543 8 5V7" stroke="#004225" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 12V16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 12H16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">Employment Details</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label for="employmentStatus" class="block text-sm font-medium text-gray-700 mb-1">Employment Status</label><select id="employmentStatus" name="employmentStatus" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required><option value="">Please select</option><option value="Full-time employed">Full-time employed</option><option value="Part-time employed">Part-time employed</option><option value="Self-employed">Self-employed</option><option value="Retired">Retired</option><option value="Student">Student</option><option value="Unemployed">Unemployed</option></select></div>
<div><label for="occupation" class="block text-sm font-medium text-gray-700 mb-1">Occupation</label><input type="text" id="occupation" name="occupation" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="organization-title"></div>
<div><label for="employerName" class="block text-sm font-medium text-gray-700 mb-1">Employer Name</label><input type="text" id="employerName" name="employerName" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="organization"></div>
<div><label for="employerPhone" class="block text-sm font-medium text-gray-700 mb-1">Employer Phone</label><input type="tel" id="employerPhone" name="employerPhone" class="w-full px-4 py-2 border border-gray-300 rounded-xl" placeholder="e.g. 01234567890" required inputmode="tel" autocomplete="off"><span class="error-message" id="employerPhone-error">Please enter a valid UK phone number</span></div>
<div><label class="block text-sm font-medium text-gray-700 mb-1">Time with Current Employer</label><div class="grid grid-cols-2 gap-3"><div><label for="employmentYears" class="block text-xs text-gray-500 mb-1">Years</label><input type="number" id="employmentYears" name="employmentYears" min="0" max="99" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric"></div><div><label for="employmentMonths" class="block text-sm font-medium text-gray-700 mb-1">Months</label><input type="number" id="employmentMonths" name="employmentMonths" min="0" max="11" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required value="0" inputmode="numeric"></div></div></div>
<div><label for="monthlyTakeHomePay" class="block text-sm font-medium text-gray-700 mb-1">Monthly Take Home Pay (after tax, all sources) (£)</label><input type="text" id="monthlyTakeHomePay" name="monthlyTakeHomePay" min="0" step="50" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric"><span class="error-message" id="monthlyTakeHomePay-error">Minimum take home pay is £800.</span></div>
</div>
<div id="previousEmployerContainer" class="collapsible-section is-collapsed mt-8 pt-6 border-t border-gray-200"><h3 class="text-lg font-medium text-racing-green mb-4">Previous Employer Details</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label for="previousEmployerName" class="block text-sm font-medium text-gray-700 mb-1">Previous Employer Name</label><input type="text" id="previousEmployerName" name="previousEmployerName" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="organization"></div>
<div><label for="previousOccupation" class="block text-sm font-medium text-gray-700 mb-1">Previous Occupation</label><input type="text" id="previousOccupation" name="previousOccupation" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="organization-title"></div>
<div class="md:col-span-2"><label for="previousEmployerAddress1" class="block text-sm font-medium text-gray-700 mb-1">Previous Employer Address Line 1</label><input type="text" id="previousEmployerAddress1" name="previousEmployerAddress1" class="w-full px-4 py-2 border border-gray-300 rounded-xl" autocomplete="address-line1"></div>
<div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Time with Previous Employer</label><div class="grid grid-cols-2 gap-3"><div><label for="previousEmploymentYears" class="block text-xs text-gray-500 mb-1">Years</label><input type="number" id="previousEmploymentYears" name="previousEmploymentYears" min="0" max="99" class="w-full px-4 py-2 border border-gray-300 rounded-xl" inputmode="numeric"></div><div><label for="previousEmploymentMonths" class="block text-sm font-medium text-gray-700 mb-1">Months</label><input type="number" id="previousEmploymentMonths" name="previousEmploymentMonths" min="0" max="11" class="w-full px-4 py-2 border border-gray-300 rounded-xl" value="0" inputmode="numeric"></div></div></div>
</div>
</div>
<div class="flex flex-col sm:flex-row sm:justify-between items-center gap-4 mt-6"><button type="button" class="prev-btn bg-gray-300 text-gray-700 px-6 py-2 rounded-xl hover:bg-gray-400 transition-all w-full sm:w-auto">Previous Step</button><button type="button" class="next-btn bg-racing-green text-white px-6 py-2 rounded-xl hover:bg-opacity-90 transition-all w-full sm:w-auto">Next Step</button></div>
</div>
<div class="form-section" id="section-4" data-section="4">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Vehicle Details Icon"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5H6.5C5.84 5 5.29 5.42 5.08 6.01L3 12V20C3 20.55 3.45 21 4 21H5C5.55 21 6 20.55 6 20V19H18V20C18 20.55 18.45 21 19 21H20C20.55 21 21 20.55 21 20V12L18.92 6.01Z" fill="#004225"></path><path d="M7.5 16C8.32843 16 9 15.3284 9 14.5C9 13.6716 8.32843 13 7.5 13C6.67157 13 6 13.6716 6 14.5C6 15.3284 6.67157 16 7.5 16Z" fill="white"></path><path d="M16.5 16C17.3284 16 18 15.3284 18 14.5C18 13.6716 17.3284 13 16.5 13C15.6716 13 15 13.6716 15 14.5C15 15.3284 15.6716 16 16.5 16Z" fill="white"></path><path d="M5 10H19L17.5 5.5H6.5L5 10Z" fill="#004225" stroke="white" stroke-width="0.5"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">Vehicle Details</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label for="vrn" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Registration (VRN)</label><input type="text" id="vrn" name="vrn" class="w-full px-4 py-2 border border-gray-300 rounded-xl uppercase" placeholder="e.g. AB12 CDE" required autocomplete="off"><span class="error-message" id="vrn-error">Please enter a valid UK VRN.</span></div>
<div class="w-full"><label for="vin" class="block text-sm font-medium text-gray-700 mb-1">VIN (Vehicle Identification Number)</label><input type="text" id="vin" name="vin" class="w-full px-4 py-2 border border-gray-300 rounded-xl" placeholder="Auto-filled by other form" autocomplete="off"></div>
<div><label for="make" class="block text-sm font-medium text-gray-700 mb-1">Make</label><input type="text" id="make" name="make" list="manufacturer-list" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="off"><datalist id="manufacturer-list"></datalist></div>
<div><label for="model" class="block text-sm font-medium text-gray-700 mb-1">Model</label><input type="text" id="model" name="model" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="off"></div>
<div><label for="year" class="block text-sm font-medium text-gray-700 mb-1">Year</label><input type="number" id="year" name="year" min="1950" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric"></div>
<div><label for="colour" class="block text-sm font-medium text-gray-700 mb-1">Colour</label><input type="text" id="colour" name="colour" class="w-full px-4 py-2 border border-gray-300 rounded-xl" placeholder="Auto-filled by other form" autocomplete="off"></div>
<div><label for="vehicleCurrentMileage" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Current Mileage</label><input type="number" id="vehicleCurrentMileage" name="vehicleCurrentMileage" min="0" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-xl bg-racing-green-100" required inputmode="numeric"></div>
<div><label for="price" class="block text-sm font-medium text-gray-700 mb-1">Original Purchase Price (if known) (£)</label><input type="number" id="price" name="price" min="0" step="100" class="w-full px-4 py-2 border border-gray-300 rounded-xl" inputmode="numeric"></div>
</div>
<div class="flex flex-col sm:flex-row sm:justify-between items-center gap-4 mt-6"><button type="button" class="prev-btn bg-gray-300 text-gray-700 px-6 py-2 rounded-xl hover:bg-gray-400 transition-all w-full sm:w-auto">Previous Step</button><button type="button" class="skip-btn w-full sm:w-auto">Skip for Now</button><button type="button" class="next-btn bg-racing-green text-white px-6 py-2 rounded-xl hover:bg-opacity-90 transition-all w-full sm:w-auto">Next Step</button></div>
</div>
<div class="form-section" id="section-5" data-section="5">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Car Finance Details Icon"><path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" fill="#004225" stroke="#004225" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M14 2V8H20" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16 13H8" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16 17H8" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 9H8" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">Car Finance Details</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 mb-6">
<div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Finance Type</label><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div class="text-center"><button type="button" class="btn-finance-type w-full" data-value="PCP" data-target="financeType">Personal Contract Purchase (PCP)</button><p class="input-sublabel text-xs text-gray-600 mt-1">generally lower payments, balloon at the end</p></div><div class="text-center"><button type="button" class="btn-finance-type w-full" data-value="HP" data-target="financeType">Hire Purchase (HP)</button><p class="input-sublabel text-xs text-gray-600 mt-1">own the car outright at the end</p></div></div><input type="hidden" id="financeType" name="financeType" required><span class="error-message" id="financeType-error">Please select a finance type</span></div>
<div class="mt-6 w-full" ><label for="term" class="block text-sm font-medium text-gray-700 mb-1">Finance Term (months)</label><select id="term" name="term" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required><option value="">Please select</option></select></div>
<div class="mt-6 w-full" ><label for="settlementTotal" class="block text-sm font-medium text-gray-700 mb-1">Finance Settlement/Required Finance Total (£)</label><input type="number" id="settlementTotal" name="settlementTotal" min="0" step="100" class="w-full px-4 py-2 border border-gray-300 rounded-xl bg-racing-green-100" required inputmode="numeric"><span class="error-message" id="settlementTotal-error">This field is required.</span></div>
<div class="mt-6 w-full" ><label for="annualMileage" class="block text-sm font-medium text-gray-700 mb-1">Intended Annual Mileage</label><select id="annualMileage" name="annualMileage" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-xl bg-racing-green-100" required><option value="">Please select</option><option value="5000">5,000 miles</option><option value="6000">6,000 miles</option><option value="8000">8,000 miles</option><option value="10000">10,000 miles</option><option value="12000">12,000 miles</option><option value="15000">15,000 miles</option><option value="18000">18,000 miles</option><option value="20000">20,000 miles</option><option value="25000">25,000 miles</option><option value="30000">30,000 miles</option></select></div>
</div>
<div class="flex flex-col sm:flex-row sm:justify-between items-center gap-4 mt-6"><button type="button" class="prev-btn bg-gray-300 text-gray-700 px-6 py-2 rounded-xl hover:bg-gray-400 transition-all w-full sm:w-auto">Previous Step</button><button type="button" class="next-btn bg-racing-green text-white px-6 py-2 rounded-xl hover:bg-opacity-90 transition-all w-full sm:w-auto">Next Step</button></div>
</div>
<div class="form-section" id="section-6" data-section="6">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Bank Details Icon"><path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" fill="#004225"></path><path d="M22 6L12 13L2 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">Bank Details</h2>
</div>
<div class="mb-6 p-4 bg-light-green bg-opacity-30 rounded-xl"><p class="text-sm text-gray-700">We use these bank details to perform an electronic Identity Verification to verify ID. Your direct debit details are protected by the <a href="https://www.directdebit.co.uk/direct-debit-guarantee/" target="_blank" rel="noopener noreferrer" class="text-racing-green underline font-medium">Direct Debit Guarantee Scheme</a>; these details may also be used for the new agreement direct debit details however you can change these before completion.</p></div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label for="bankName" class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label><input type="text" id="bankName" name="bankName" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="organization"></div>
<div><label for="accountHolder" class="block text-sm font-medium text-gray-700 mb-1">Account Holder Name</label><input type="text" id="accountHolder" name="accountHolder" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required autocomplete="cc-name"></div>
<div><label for="sortCode" class="block text-sm font-medium text-gray-700 mb-1">Sort Code</label><input type="text" id="sortCode" name="sortCode" placeholder="XX-XX-XX" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric" autocomplete="off"><span class="error-message" id="sortCode-error">Please enter a valid 6-digit sort code</span></div>
<div><label for="accountNumber" class="block text-sm font-medium text-gray-700 mb-1">Account Number</label><input type="text" id="accountNumber" name="accountNumber" placeholder="XXXXXXXX" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric" autocomplete="off"><span class="error-message" id="accountNumber-error">Please enter a valid 8-digit account number</span></div>
<div><label class="block text-sm font-medium text-gray-700 mb-1">Time with Bank</label><div class="grid grid-cols-2 gap-3"><div><label for="bankYears" class="block text-xs text-gray-500 mb-1">Years</label><input type="number" id="bankYears" name="bankYears" min="0" max="99" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required inputmode="numeric"></div><div><label for="bankMonths" class="block text-sm font-medium text-gray-700 mb-1">Months</label><input type="number" id="bankMonths" name="bankMonths" min="0" max="11" class="w-full px-4 py-2 border border-gray-300 rounded-xl" required value="0" inputmode="numeric"></div></div><span class="error-message" id="timeWithBank-error">Time with bank must be at least 1 year.</span></div>
<div id="bankValidationResult" class="hidden p-3 rounded-xl col-span-1 md:col-span-2 mt-2"></div>
</div>
<div class="flex flex-col sm:flex-row sm:justify-between items-center gap-4 mt-6"><button type="button" class="prev-btn bg-gray-300 text-gray-700 px-6 py-2 rounded-xl hover:bg-gray-400 transition-all w-full sm:w-auto">Previous Step</button><button type="button" class="skip-btn w-full sm:w-auto">Skip for Now</button><button type="button" class="next-btn bg-racing-green text-white px-6 py-2 rounded-xl hover:bg-opacity-90 transition-all w-full sm:w-auto">Proceed</button></div>
</div>
<div class="form-section" id="section-7" data-section="7">
<div class="flex items-center mb-6">
<div class="bg-light-green p-3 rounded-full mr-4"><svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Consent Icon"><path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="#004225"></path></svg></div>
<h2 class="text-2xl font-semibold text-racing-green">Consent &amp; Submit</h2>
</div>
<div class="mb-6">
<div class="fair-processing-notice mb-6">
<h3 class="text-lg font-semibold text-racing-green mb-2">Fair Processing Notice</h3>
<h4>How We Use and Share Your Personal Information</h4>
<p>At comparemyfinance.co.uk, we are committed to protecting your privacy and ensuring that your personal data is handled with the utmost care and transparency. This notice explains how we will process your personal information when you apply for car finance through our partnership with CarFinance247 Limited.</p>
<h4>1. Sharing Your Information with CarFinance247</h4>
<p>When you make an application for car finance through us, we will share the personal data you provide in your application with CarFinance247 Limited (CarFinance247). This information is necessary for them to process your application and to make a decision on whether to offer you a finance agreement.</p>
<p>The personal data we share may include:</p>
<ul>
<li>Your personal details (name, address, date of birth)</li>
<li>Your contact information (email address, phone number)</li>
<li>Your employment and income details</li>
<li>Information about the vehicle you wish to finance</li>
</ul>
<h4>2. The Purpose and Legal Basis for Processing Your Application</h4>
<p>We provide your personal data to CarFinance247 for the specific purpose of them assessing your eligibility for car finance from their panel of lenders. The processing of your personal data by CarFinance247 is based on their legitimate interest to assess your application and decide whether, and on what terms, a finance agreement can be offered to you.</p>
<p><strong>Your Right to Opt-Out:</strong> You have the right to object to this processing at any time. If you wish to opt-out, you can do so by contacting CarFinance247 directly. You can find their contact details in their Privacy Policy, which is available on their website.</p>
<h4>3. Marketing from CarFinance247</h4>
<p>CarFinance247 may also use your personal data to contact you about products or services from CarFinance247, its associated companies, or other selected third parties that they believe may be of interest to you. The use of your data for marketing purposes is based on CarFinance247's legitimate interest in promoting relevant products and services.</p>
<p><strong>Your Right to Opt-Out of Marketing:</strong> You can opt out of receiving these marketing communications at any time by giving notice to CarFinance247. Details on how to manage your marketing preferences will be available in their communications with you and in their full Privacy Policy.</p>
<h4>4. Credit Reference Agencies</h4>
<p>As part of the application process, CarFinance247 will use the services of Credit Reference Agencies (CRAs) to assess your creditworthiness and to prevent fraud. This will involve them sharing your personal information with CRAs and receiving information back from them.</p>
<p>For full details on how CRAs use and share your personal information, you should refer to the <strong>Credit Reference Agency Information Notice (CRAIN)</strong>. This notice is a standardized document produced by the main UK CRAs in the UK and explains:</p>
<ul>
<li>The types of data they hold about you.</li>
<li>How they use this data to make decisions.</li>
<li>How long they keep your data for.</li>
<li>Your data protection rights in relation to the information they hold.</li>
</ul>
<p>You can access the CRAIN directly from the websites of the main UK Credit Reference Agencies:</p>
<ul>
<li>Experian: www.experian.co.uk/crain</li>
<li>Equifax: www.equifax.co.uk/crain</li>
<li>TransUnion: www.transunion.co.uk/crain</li>
</ul>
<p>We strongly recommend that you read this notice to understand how your data will be used by CRAs.</p>
<h4>5. CarFinance247's Privacy Policy</h4>
<p>CarFinance247 is a data controller for the personal information they receive from us. For comprehensive details on how they will handle your personal data, including how they manage marketing preferences, your rights as a data subject, and how to contact them, please refer to their full Privacy Policy on their website: carfinance247.co.uk</p>
<h4>6. Our Commitment</h4>
<p>comparemyfinance.co.uk is committed to ensuring that your personal information is processed in a fair, lawful, and transparent manner at all times. If you have any questions about how we handle your data, please do not hesitate to contact us.</p>
<p>This Fair Processing Notice is provided to ensure you are fully informed about the processing of your personal data in relation to your car finance application through our partnership with CarFinance247.</p>
</div>
<div class="mb-4"><label class="flex items-start cursor-pointer"><input type="checkbox" id="consentMarketing" name="consentMarketing" class="mt-1 mr-2 h-4 w-4 text-racing-green border-gray-300 rounded focus:ring-racing-green"><span class="ml-2 text-sm text-gray-700">I consent to receiving marketing communications about relevant products and services.</span></label></div>
<div class="mb-4"><label class="flex items-start cursor-pointer"><input type="checkbox" id="consentTerms" name="consentTerms" class="mt-1 mr-2 h-4 w-4 text-racing-green border-gray-300 rounded focus:ring-racing-green" required><span class="ml-2 text-sm text-gray-700"><strong>I confirm that I have read and agree to the Fair Processing Notice, <a href="#" id="termsLink" class="text-racing-green underline">terms and conditions</a> and <a href="#" id="privacyLink" class="text-racing-green underline">privacy policy</a></strong> *.</span></label><span class="error-message" id="consentTerms-error">You must agree to the terms and conditions</span></div>
<div class="mb-4"><label class="flex items-start cursor-pointer"><input type="checkbox" id="consentAccurate" name="consentAccurate" class="mt-1 mr-2 h-4 w-4 text-racing-green border-gray-300 rounded focus:ring-racing-green" required><span class="ml-2 text-sm text-gray-700"><strong>I confirm that the information provided is accurate and true</strong> *.</span></label><span class="error-message" id="consentAccurate-error">You must confirm the information is accurate</span></div>
</div>
<div class="flex flex-col sm:flex-row sm:justify-between items-center gap-4 mt-6"><button type="button" class="prev-btn bg-gray-300 text-gray-700 px-6 py-2 rounded-xl hover:bg-gray-400 transition-all w-full sm:w-auto">Previous Step</button><p id="inline-success-message" class="hidden text-center w-full"></p><button type="submit" id="submit-btn" class="bg-racing-green text-white px-8 py-3 rounded-xl hover:bg-opacity-90 transition-all font-medium w-full sm:w-auto">Submit Application</button></div>
</div>
</form>
</div>
</div></div>
            </div>
        </div>
    </div>
    <div id="modal-container">
        <div id="termsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-content"><div class="modal-header"><span class="close-button" data-modal="termsModal">&times;</span><h2>Terms and Conditions</h2></div><div class="modal-body"><p>Terms and Conditions ... (omitted here for brevity; use your copy from the original file)</p></div><div class="modal-footer"><button type="button" class="close-modal-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg" data-modal="termsModal">Close</button></div></div>
        </div>
        <div id="privacyModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-content"><div class="modal-header"><span class="close-button" data-modal="privacyModal">&times;</span><h2>Privacy Policy</h2></div><div class="modal-body"><p>Privacy Policy ... (omitted here for brevity; use your copy from the original file)</p></div><div class="modal-footer"><button type="button" class="close-modal-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg" data-modal="privacyModal">Close</button></div></div>
        </div>
        <div id="confirmSubmitModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-content max-w-md"><div class="modal-header"><h2>Confirm Submission</h2><span class="close-button" data-modal="confirmSubmitModal">&times;</span></div><div class="modal-body"><p>Are you sure you want to submit your finance application?</p></div><div class="modal-footer flex justify-end gap-4"><button type="button" id="cancelSubmitBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancel</button><button type="button" id="confirmSubmitBtn" class="bg-racing-green text-white px-4 py-2 rounded-lg">Yes, Submit</button></div></div>
        </div>
        <div id="successModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-content max-w-md text-center">
                <div class="modal-body">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"><svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Application Submitted!</h2><p class="text-gray-600">Thank you. Your application has been successfully submitted. We will be in touch shortly.</p>
                </div>
                <div class="modal-footer justify-center"><button type="button" id="closeSuccessModalBtn" class="bg-racing-green text-white px-6 py-2 rounded-lg">OK</button></div>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded',()=>{const GOOGLE_SCRIPT_URL='https://script.google.com/macros/s/AKfycbyGY8_ZjRoIh3TMR1MLx-LdYznYCMbroOq_VPkqHu8-1stnmmI6CMFi0IFtKETZKvJH/exec',LIVE_SCRIPT_URL='https://script.google.com/macros/s/AKfycbzipBLlTMTzAdaNWnTN1TsKlKkhWi71Uauz6-jaUrZoIi3GMoiT-FZsEeDvJnz9LkDF/exec',ONEAUTO_API_KEY='ICV6nKX6SM8Z8TUnDrRWW11TQfL4BVps9wzErC36';try{emailjs.init({publicKey:"2IzMUyHd8lP-idbVq"})}catch(e){}const el=id=>document.getElementById(id);const vrnInputCalc=el('vrn-calc'),yearInputCalc=el('year-calc'),vrnLookupBtnCalc=el('vrn-lookup-btn-calc'),manufacturerListCalc=el('manufacturer-list-calc');const financeType=el('finance-type'),currentPrice=el('current-price'),currentDeposit=el('current-deposit'),currentInterest=el('current-interest');const currentTerm=el('current-term'),currentStartDate=el('current-start-date'),currentPaymentsMade=el('current-payments-made');const currentMonthlyPayment=el('current-monthly-payment'),currentBalloon=el('current-balloon'),creditScore=el('credit-score');const newPrice=el('new-price'),newInterest=el('new-interest'),newTerm=el('new-term'),newBalloon=el('new-balloon');const earlyRepaymentCheck=el('early-repayment-check'),contactName=el('contact-name'),contactEmail=el('contact-email'),contactPhone=el('contact-phone');const calculateBtn=el('calculate-btn'),iDontHaveFiguresBtn=el('i-dont-have-figures-btn'),monthlyPaymentContainer=el('monthly-payment-container');const findSavingsBtn=el('find-savings-btn'),section1NextBtn=el('section-1-next-btn'),requestQuoteBtn=el('request-quote-btn');const resultsSection=el('results-section'),section1Wrapper=el('section-1-wrapper'),section2Wrapper=el('section-2-wrapper'),section3Wrapper=el('section-3-wrapper');const financeFormEmbedContainer=el('finance-form-embed-container'),vrnStatusEl=el('vrn-lookup-status-calc'),vrnSpinner=el('vrn-spinner-calc');const vrnText=el('vrn-lookup-text-calc'),vrnError=el('vrn-error-calc');let initialCalculationState=null,customAlertTimeout=null,liveCalcTimer=null;let liveRowIndex=null,isSessionStarting=!1,pendingUpdates=[];
function resetLiveSessionIfNewVRN(vrn) {
  try {
    const norm = (vrn || '').toUpperCase().replace(/\s/g, '');
    const last = sessionStorage.getItem('currentVrn') || '';
    if (norm && last && norm !== last) {
      // different customer → drop the previous row link
      liveRowIndex = null;
      isSessionStarting = false;
      pendingUpdates = [];
      sessionStorage.removeItem('liveRowIndex');
    }
    if (norm) sessionStorage.setItem('currentVrn', norm);
  } catch (e) {}
}
const sanitize=val=>parseFloat(String(val||'').replace(/[£,%\s]/g,''))||0;const isValidUKVRN=vrn=>vrn&&/^[A-Z]{2}[0-9]{2}[A-Z]{3}$|^[A-Z][0-9]{1,3}[A-Z]{3}$|^[A-Z]{3}[0-9]{1,3}[A-Z]$|^[0-9]{1,4}[A-Z]{1,2}$|^[A-Z]{1,2}[0-9]{1,4}$|^[A-Z]{1,3}[0-9]{1,3}$|^[0-9]{1,3}[A-Z]{1,3}$/.test(vrn.toUpperCase().replace(/\s/g,''));const formatCurrency=val=>`${val<0?"-":""}£${Math.abs(val).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")}`;const setText=(id,text)=>{const e=el(id);if(e)e.textContent=text};const validationRules={email:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),phone:p=>{if(!p)return!1;let n=p.replace(/[\s()-]+/g,'');if(n.startsWith('+44'))n='0'+n.substring(3);else if(n.startsWith('0044'))n='0'+n.substring(4);return/^(0(1|2|3|7|8)\d{9}|05\d{8})$/.test(n)}};const showAlert=msg=>{el('custom-alert-box')?.remove();const box=document.createElement('div');box.id='custom-alert-box';box.innerHTML=`<p>${msg}</p><button>OK</button>`;box.querySelector('button').onclick=()=>{box.remove();clearTimeout(customAlertTimeout)};document.body.appendChild(box);box.style.transform='translate(-50%, -50%)';customAlertTimeout=setTimeout(()=>box.remove(),7e3)};const showGoalAlert=(msg,anchorEl)=>{el('custom-alert-box')?.remove();if(!anchorEl){showAlert(msg);return}
const box=document.createElement('div');box.id='custom-alert-box';box.innerHTML=`<p>${msg}</p><button>OK</button>`;box.querySelector('button').onclick=()=>{box.remove();clearTimeout(customAlertTimeout)};document.body.appendChild(box);const anchorRect=anchorEl.getBoundingClientRect();const boxRect=box.getBoundingClientRect();const margin=10;let top=anchorRect.top-boxRect.height-margin;let left=anchorRect.left+(anchorRect.width/2);box.style.top=`${top}px`;box.style.left=`${left}px`;box.style.transform='translateX(-50%)';customAlertTimeout=setTimeout(()=>box.remove(),7e3)};function triggerErrorShake(inputId,message){const input=el(inputId);const label=document.querySelector(`label[for="${inputId}"]`);if(input){input.classList.remove('input-error-shake');if(label)label.classList.remove('label-error-shake');void input.offsetWidth;showAlert(message);input.classList.add('input-error-shake');if(label)label.classList.add('label-error-shake');input.focus()}}
function collectAllCalculatorData(){return{vrn:el('vrn-calc')?.value,make:el('make-calc')?.value,model:el('model-calc')?.value,year:el('year-calc')?.value,colour:el('colour-calc')?.value,vin:el('vin-calc')?.value,agreementNumber:el('agreement-number-calc')?.value,financeCompany:el('finance-company-calc')?.value,price:el('current-price')?.value,deposit:el('current-deposit')?.value,currentApr:el('current-interest')?.value,agreementStartDate:el('current-start-date')?.value,originalTerm:el('current-term')?.value,financeType:el('finance-type')?.value,settlementTotal:el('new-price')?.value,currentBalloon:el('current-balloon')?.value,paymentsMade:el('current-payments-made')?.value,creditScore:el('credit-score')?.value,newApr:el('new-interest')?.value,term:el('new-term')?.value,newBalloon:el('new-balloon')?.value,incErc:el('early-repayment-check')?.checked,contactName:el('contact-name')?.value,contactEmail:el('contact-email')?.value,contactPhone:el('contact-phone')?.value,summaryMonthlyDifference:el('monthly-difference')?.textContent,summaryTotalSavings:el('total-savings')?.textContent,summaryTermChange:el('time-savings')?.textContent,summaryEquityChange:el('equity-change-value')?.textContent,recommendation:el('recommendation')?.textContent}}
function getEmailParams(){return{from_name:el('contact-name')?.value.trim()||'',client_email_address:el('contact-email')?.value.trim()||'',phone_number:el('contact-phone')?.value.trim()||'',to_email:'info@comparemyfinance.co.uk',from_email:'calculator@comparemyfinance.co.uk',reply_to:el('contact-email')?.value.trim()||'',subject:'Car Finance Savings Calculator Results - '+(el('contact-name')?.value.trim()||'User'),vehicle_registration:el('vrn-calc')?.value||'',vehicle_make:el('make-calc')?.value||'',vehicle_model:el('model-calc')?.value||'', finance_lender: el('finance-company-calc')?.value || 'N/A', current_finance_type:el('finance-type')?.value.toUpperCase()||'',current_purchase_price:formatCurrency(sanitize(el('current-price')?.value)),current_deposit:formatCurrency(sanitize(el('current-deposit')?.value)),current_apr:sanitize(el('current-interest')?.value).toFixed(1),current_term:parseInt(sanitize(el('current-term')?.value),10),current_payments_made:parseInt(sanitize(el('current-payments-made')?.value),10),current_balloon:formatCurrency(el('finance-type').value==='pcp'?sanitize(el('current-balloon')?.value):0),current_monthly_payment_display:el('summary-current-monthly')?.textContent||'',current_total_remaining_display:el('summary-current-total')?.textContent||'',current_settlement_figure:el('new-price')?.value||'',new_credit_score:el('credit-score')?.options[el('credit-score').selectedIndex]?.text||'',new_apr:sanitize(el('new-interest')?.value).toFixed(1),new_term:parseInt(sanitize(el('new-term')?.value),10),new_balloon:formatCurrency(sanitize(el('new-balloon')?.value)),new_erc_fee_display:el('early-repayment-check')?.checked&&el('new-early-repayment-fee')?el('new-early-repayment-fee').textContent:'N/A',new_monthly_payment_display:el('summary-new-monthly')?.textContent||'',new_total_cost_display:el('summary-new-total')?.textContent||'',summary_monthly_difference:(el('monthly-difference')?.textContent||'')+((el('monthly-arrow')?.textContent||'')==='↑'?' increase':' decrease'),summary_total_impact:(el('total-savings')?.textContent||'')+((el('savings-arrow')?.textContent||'')==='↑'?' more expensive':' saving'),summary_term_change:el('time-savings')?.textContent||'',summary_recommendation:el('recommendation')?.textContent||'',referer: getRefererFromUrl()}}
function sendEmail(){if(typeof emailjs==='undefined'||!emailjs.send){return}const emailParams=getEmailParams();emailjs.send('service_qxsk59h','template_comparisondone',emailParams).then(function(response){const regEmailParams={...emailParams,to_email:emailParams.client_email_address,subject:'Important Regulatory Information from Compare My Finance'};emailjs.send('service_qxsk59h','template_iddabun',regEmailParams)},function(error){})}
const setVrnLoading=(loading,status='',statusClass='text-gray-600')=>{vrnText.classList.toggle('hidden',loading);vrnSpinner.classList.toggle('hidden',!loading);vrnLookupBtnCalc.disabled=loading;vrnStatusEl.textContent=status;vrnStatusEl.className=`text-sm mt-1 ${statusClass}`};const setVehicleInputs=data=>{const setVal=(id,val)=>{const e=el(id);if(e)e.value=val||''};setVal('make-calc',data.make);setVal('model-calc',data.model);setVal('year-calc',data.year);setVal('vin-calc',data.vin);setVal('colour-calc',data.colour);if(data.finance){const fin=data.finance;setVal('finance-company-calc',fin.finance_company||'N/A');setVal('agreement-number-calc',fin.finance_agreement_number||'N/A');setVal('current-start-date',fin.finance_start_date);if(el('current-term')&&fin.finance_term_months){setVal('current-term',fin.finance_term_months);el('current-term').dispatchEvent(new Event('input'))}if(el('finance-type')&&fin.finance_type){const fType=fin.finance_type.toUpperCase();el('finance-type').value=fType.includes('PCP')?'pcp':(fType.includes('HIRE PURCHASE')?'hp':el('finance-type').value);el('finance-type').dispatchEvent(new Event('change'))}}
toggleAdditionalVehicleDetails()};async function handleVrnLookup() {try{var bvd=document.getElementById('basic-vehicle-details');if(bvd)bvd.classList.remove('hidden')}catch(e){};const vrn=vrnInputCalc.value.toUpperCase().replace(/\s/g,'');resetLiveSessionIfNewVRN(vrn);vrnInputCalc.classList.toggle('error',!isValidUKVRN(vrn));vrnError.style.display=isValidUKVRN(vrn)?'none':'block';if(!isValidUKVRN(vrn))return;setVrnLoading(!0,'Checking database...');try{const res=await fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'getVrnData',payload:{vrn}})});const result=await res.json();if(result.success&&result.data){setVehicleInputs(result.data);setVrnLoading(!1,'Vehicle found in database!','text-green-600 font-medium');return}}catch(error){}
setVrnLoading(!0,'Looking up vehicle via DVLA API...');try{const res=await fetch(`https://api.oneautoapi.com/experian/financerecords/v3?vehicle_registration_mark=${vrn}`,{headers:{'x-api-key':ONEAUTO_API_KEY}});if(res.status===204)throw new Error('Vehicle not found (204 No Content).');if(!res.ok)throw new Error(`API error: ${res.status} ${res.statusText}`);const data=await res.json();if(data.success&&data.result){const r=data.result;const fin=r.finance_data_qty>0?r.finance_data_items[0]:null;
const vData = {
    vrn,
    make: r.dvla_manufacturer_desc,
    model: r.dvla_model_desc,
    year: r.manufactured_year,
    vin: r.vehicle_identification_number,
    colour: r.colour,
    referer: getRefererFromUrl(),
    finance_type: fin ? fin.finance_type : null,
    finance_company: fin ? fin.finance_company : null,
    finance_agreement_number: fin ? fin.finance_agreement_number : null,
    finance_start_date: fin ? fin.finance_start_date : null,
    finance_term_months: fin ? fin.finance_term_months : null,
    finance: fin 
};
setVehicleInputs(vData);try{await fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'saveVrnData',payload:vData})});setVrnLoading(!1,'Vehicle details found & saved!','text-green-600 font-medium')}catch{setVrnLoading(!1,'Vehicle details found (save failed).','text-green-600 font-medium')}}else{throw new Error(data.error||'VRN not found.')}}catch(e){setVrnLoading(!1,e.message,'text-red-600');setVehicleInputs({})}}
const calcPmt=(p,r,t,b=0)=>{if(t<=0)return 0;p=Math.max(0,p);b=Math.max(0,b);if(r===0)return(p-b)/t;const pvB=b/Math.pow(1+r,t),effP=p-pvB;const num=effP*r*Math.pow(1+r,t),den=Math.pow(1+r,t)-1;return den===0?(p-b)/t:Math.max(0,num/den)};const solveAPR=(p,t,pmt,b)=>{if(t<=0)return 0;let low=0,high=100,mid;for(let i=0;i<60;i++){mid=(low+high)/2;const guess=calcPmt(p,mid/1200,t,b);if(Math.abs(guess-pmt)<.01)return mid;guess>pmt?high=mid:low=mid}return mid};const toggleAdditionalVehicleDetails=()=>el('additional-vehicle-details').classList.toggle('hidden',!(yearInputCalc.value&&/^\d{4}$/.test(yearInputCalc.value)));const performCalc=(saveSnapshot=!0)=>{const ftv=financeType?.value??'',price=sanitize(currentPrice?.value),deposit=sanitize(currentDeposit?.value),cAPR=sanitize(currentInterest?.value);const cTerm=parseInt(sanitize(currentTerm?.value),10),paymentsMade=parseInt(sanitize(currentPaymentsMade?.value),10);const cBalloon=ftv==='pcp'?sanitize(currentBalloon?.value):0,setFigInput=sanitize(newPrice?.value),nAPR=sanitize(newInterest?.value);const nTerm=parseInt(sanitize(newTerm?.value),10),nBalloon=sanitize(newBalloon?.value),incERC=earlyRepaymentCheck?.checked??!1;if(price<=0||cTerm<=0||nTerm<=0)return showAlert('Ensure purchase price and terms are positive values.');const cLoan=Math.max(0,price-deposit),cMIR=cAPR/1200,cPmt=calcPmt(cLoan,cMIR,cTerm,cBalloon);const remPmt=Math.max(0,cTerm-paymentsMade);let balance=cLoan;for(let i=0;i<paymentsMade&&i<cTerm;i++)balance-=(cPmt-(balance*cMIR));const cTotalToPay=(cPmt*remPmt)+cBalloon;const erc=incERC&&setFigInput>0&&cAPR>0?Math.min(setFigInput*(remPmt>12?.01:.005),setFigInput*cAPR/1200*2):0;const nTotalFin=setFigInput+erc,nPmt=calcPmt(nTotalFin,nAPR/1200,nTerm,nBalloon);const nTotalCost=(nPmt*nTerm)+nBalloon,monthlyDiff=cPmt-nPmt,saving=cTotalToPay-nTotalCost;setText('summary-current-monthly',formatCurrency(cPmt));setText('summary-new-monthly',formatCurrency(nPmt));const diffEl=el('monthly-difference'),arrowEl=el('monthly-arrow');if(diffEl){diffEl.textContent=formatCurrency(Math.abs(monthlyDiff));diffEl.className=`text-3xl font-bold ${monthlyDiff>=0?'text-green-600':'text-orange-600'}`}
if(arrowEl){arrowEl.textContent=monthlyDiff>=0?'↓':'↑';arrowEl.className=`ml-2 text-2xl ${monthlyDiff>=0?'text-green-600':'text-orange-600'}`}
setText('summary-current-total',formatCurrency(cTotalToPay));setText('summary-new-total',formatCurrency(nTotalCost));const totalSavEl=el('total-savings'),savArrowEl=el('savings-arrow');if(totalSavEl){totalSavEl.textContent=formatCurrency(Math.abs(saving));totalSavEl.className=`text-3xl font-bold ${saving>=0?'text-green-600':'text-red-600'}`}
if(savArrowEl){savArrowEl.textContent=saving>=0?'↓':'↑';savArrowEl.className=`ml-2 text-2xl ${saving>=0?'text-green-600':'text-red-600'}`}
setText('summary-current-term',`${remPmt} mo`);setText('summary-new-term',`${nTerm} mo`);const timeSav=remPmt-nTerm,tsEl=el('time-savings');if(tsEl){tsEl.textContent=timeSav===0?'No Change':`${Math.abs(timeSav)} month${Math.abs(timeSav)!==1?'s':''} ${timeSav>0?'less':'more'}`;tsEl.className=`text-3xl font-bold ${timeSav===0?'text-gray-700':(timeSav>0?'text-green-600':'text-black')}`}
setText('summary-current-balloon-equity',formatCurrency(cBalloon));setText('summary-new-balloon-equity',formatCurrency(nBalloon));const balDiff=cBalloon-nBalloon,eqEl=el('equity-change-value');if(eqEl){eqEl.textContent=balDiff===0?'No Change':formatCurrency(Math.abs(balDiff));eqEl.className=`text-3xl font-bold ${balDiff===0?'text-gray-700':'text-black'}`}
let summary = '';if (monthlyDiff > 0) {summary = `Based on these figures, you could achieve a monthly saving of <strong>${formatCurrency(monthlyDiff)}</strong>. `;}
summary += `Refinancing would ${saving > 0 ? `save ${formatCurrency(saving)}` : (saving < 0 ? `cost an extra ${formatCurrency(Math.abs(saving))}` : 'result in no change')} in total. Consider all factors before deciding.`;const recommendationEl = el('recommendation');if(recommendationEl) recommendationEl.innerHTML = summary;updatePaidOffGraphic(nBalloon,price);updateTotalCostCars(cTotalToPay,nTotalCost);el('early-repayment-section').style.display=incERC&&erc>0?'block':'none';setText('early-repayment-fee',formatCurrency(erc));resultsSection.classList.remove('hidden');setTimeout(() => resultsSection.scrollIntoView({behavior:'smooth',block:'start'}), 350);if(saveSnapshot){initialCalculationState={newInterest:newInterest.value,newTerm:newTerm.value,newBalloon:newBalloon.value,creditScore:creditScore.value,earlyRepaymentCheck:earlyRepaymentCheck.checked}}};const updatePaidOffGraphic=(nBalloon,carValue)=>{let percent=carValue>0?((carValue-nBalloon)/carValue)*100:0;percent=Math.max(0,Math.min(100,percent));el('car-fill-percentage-rect')?.setAttribute('width',`${percent}%`);setText('car-percentage-text',`${percent.toFixed(1)}%`)};const updateTotalCostCars=(current,newTotal)=>{const cTxt=el('current-total-car-text'),nTxt=el('new-total-car-text');if(!cTxt||!nTxt)return;cTxt.textContent=formatCurrency(current);nTxt.textContent=formatCurrency(newTotal);const classes=['text-red-600','font-bold','text-black','text-green-600'];classes.forEach(c=>{cTxt.classList.remove(c);nTxt.classList.remove(c)});if(current>newTotal){cTxt.classList.add('text-red-600','font-bold');nTxt.classList.add('text-green-600','font-bold')}else if(newTotal>current){nTxt.classList.add('text-red-600','font-bold');cTxt.classList.add('text-green-600','font-bold')}else{cTxt.classList.add('text-black','font-bold');nTxt.classList.add('text-black','font-bold')}};const setPaymentsMade=()=>{if(!currentStartDate.value){currentPaymentsMade.value=0;return}
const start=new Date(currentStartDate.value),today=new Date();const payments=Math.max(0,(today.getFullYear()-start.getFullYear())*12-start.getMonth()+today.getMonth());currentPaymentsMade.value=payments};const setSettlementFig=()=>{const price=sanitize(currentPrice.value),deposit=sanitize(currentDeposit.value),apr=sanitize(currentInterest.value);const term=parseInt(sanitize(currentTerm.value),10),payments=parseInt(sanitize(currentPaymentsMade.value),10);if(price<=0||term<=0){if(newPrice)newPrice.value=0;return}
let balance=Math.max(0,price-deposit);const pmt=calcPmt(balance,apr/1200,term,sanitize(currentBalloon.value));for(let i=0;i<payments&&i<term;i++)balance-=(pmt-(balance*apr/1200));const settlement=payments>=term?(financeType.value==='pcp'?sanitize(currentBalloon.value):0):balance;if(newPrice)newPrice.value=Math.max(0,Math.round(settlement))};const setNewTerm=()=>{const term=parseInt(sanitize(currentTerm.value),10),payments=parseInt(sanitize(currentPaymentsMade.value),10);
let remainingTerm = term > 0 ? Math.max(1, term - payments) : 0;
if (financeType.value === 'hp') {
    remainingTerm += 1; 
}
newTerm.value = remainingTerm;};const getBalloonPercent=term=>{const pts=[{m:24,p:.5865},{m:37,p:.5352},{m:49,p:.4542},{m:60,p:.3597}];if(term<=0)return 0;if(term<=pts[0].m)return pts[0].p;if(term>=pts[3].m)return pts[3].p;let l=pts[0],u=pts[3];for(let i=0;i<3;i++)if(term>=pts[i].m&&term<=pts[i+1].m){l=pts[i];u=pts[i+1];break}
return l.p+(term-l.m)*(u.p-l.p)/(u.m-l.m)};
const setNewBalloon=()=>{
if (financeType.value === 'hp') {
    newBalloon.value = 0;
    return;
}
const nTermVal=parseInt(sanitize(newTerm.value),10),cPrice=sanitize(currentPrice.value),cBalloonVal=sanitize(currentBalloon.value);if(nTermVal<=0||cPrice<=0){newBalloon.value=0;return}
let newB=cBalloonVal>0?Math.round(cBalloonVal*1.025):Math.round(cPrice*getBalloonPercent(nTermVal));
newBalloon.value=Math.max(0,newB)};
const autoUpdateFields=()=>{setPaymentsMade();setSettlementFig();setNewTerm();setNewBalloon()};const liveReverseCalcAPR=()=>{clearTimeout(liveCalcTimer);liveCalcTimer=setTimeout(()=>{const price=sanitize(currentPrice.value),deposit=sanitize(currentDeposit.value),term=sanitize(currentTerm.value),pmt=sanitize(currentMonthlyPayment.value);if(pmt<=0)return;if(price<=0||deposit<0||term<=0)return showAlert("Please fill Price, Deposit, and Term before entering a monthly payment.");let balloon=sanitize(currentBalloon.value);if(financeType.value==='hp'){balloon=0;currentBalloon.value='0'}else if(balloon===0&&financeType.value==='pcp'){balloon=Math.round(price*getBalloonPercent(term));currentBalloon.value=balloon}
currentInterest.value=solveAPR(price-deposit,term,pmt,balloon).toFixed(2);autoUpdateFields()},800)};const updateAprFromCredit=()=>{const scores={'very-good':8.9,'good':10.9,'fair':12.9,'poor':19.9,'very-poor':22.9};newInterest.value=(scores[creditScore.value]||8.9).toFixed(1)};const resetToInitial=()=>{if(initialCalculationState){newInterest.value=initialCalculationState.newInterest;newTerm.value=initialCalculationState.newTerm;newBalloon.value=initialCalculationState.newBalloon;creditScore.value=initialCalculationState.creditScore;earlyRepaymentCheck.checked=initialCalculationState.earlyRepaymentCheck;performCalc(!1);return!0}
return!1};const handleGoal=type=>{const resetBtn=el('goal-reset-results');if(!resetToInitial()){showGoalAlert("Please click 'Compare It!' first to see your initial results before setting a goal.",resetBtn);return}
if(type==='save-monthly'){const cMonthly=sanitize(el('summary-current-monthly').textContent);const desiredSaving=50;if(isNaN(cMonthly)||cMonthly<=desiredSaving){return showGoalAlert('Current monthly payment is too low to apply this saving.',resetBtn)}
const price=sanitize(newPrice.value)||sanitize(currentPrice.value-currentDeposit.value);const target=Math.max(0,cMonthly-desiredSaving);let foundTerm=null;for(let t=parseInt(newTerm.value,10)||12;t<=84;t++){if(calcPmt(price,sanitize(newInterest.value)/1200,t,sanitize(newBalloon.value))<=target){foundTerm=t;break}}
if(!foundTerm)return showGoalAlert(`Could not reach the target saving of ${formatCurrency(desiredSaving)} per month.`,resetBtn);newTerm.value=foundTerm;showGoalAlert(`New term set to ${foundTerm} months to target a saving of at least ${formatCurrency(desiredSaving)} per month.`,resetBtn)}else if(type==='extend-term'){const extended=Math.min(84,(parseInt(sanitize(newTerm.value),10)||24)+6);newTerm.value=extended;showGoalAlert(`Term extended by 6 months to ${extended} months.`,resetBtn)}else if(type==='own-my-car'){newTerm.value=60;newBalloon.value=0;showGoalAlert('Set to "Own My Car" style (HP): Term is 60 months and the balloon payment is £0.',resetBtn)}
setNewBalloon();performCalc(!1)};const handleResetResults=()=>{if(resetToInitial()){showAlert('Results have been reset to your initial comparison.')}else{showAlert("No initial comparison to reset to. Please click 'Compare It!' first.")}};const populateManufacturers=()=>{const mans=["Abarth","Acura","Alfa Romeo","Alpine","Aston Martin","Audi","Austin","Bentley","BMW","Bugatti","Buick","Cadillac","Caterham","Chevrolet","Chrysler","Citroen","Cupra","Dacia","Daewoo","Daihatsu","Dodge","DS Automobiles","Ferrari","Fiat","Fisker","Ford","Genesis","GMC","Honda","Hummer","Hyundai","Ineos","Infiniti","Isuzu","Jaguar","Jeep","Kia","Koenigsegg","Lamborghini","Lancia","Land Rover","Lexus","Lincoln","Lotus","Maserati","Maybach","Mazda","McLaren","Mercedes-Benz","MG","Mini","Mitsubishi","Morgan","Morris","Nissan","Noble","Pagani","Peugeot","Polestar","Pontiac","Porsche","Proton","Ram","Renault","Rivian","Rolls-Royce","Rover","Saab","Seat","Skoda","Smart","SsangYong","Subaru","Suzuki","Tata","Tesla","Toyota","Triumph","TVR","Vauxhall","Volkswagen","Volvo","Westfield","Zenos"];if(manufacturerListCalc)mans.sort().forEach(m=>{const opt=document.createElement('option');opt.value=m;manufacturerListCalc.appendChild(opt)})};const pEF=()=>{const f=financeFormEmbedContainer;if(!f)return;const setVal=(sel,val)=>{const e=f.querySelector(sel);if(e)e.value=val||''};setVal('#firstName',contactName?.value.split(' ')[0]);setVal('#lastName',contactName?.value.split(' ').slice(1).join(' '));setVal('#email',contactEmail?.value);setVal('#phone',contactPhone?.value);setVal('#vrn',vrnInputCalc?.value);setVal('#make',el('make-calc')?.value);setVal('#model',el('model-calc')?.value);setVal('#year',yearInputCalc?.value);setVal('#vin',el('vin-calc')?.value);setVal('#colour',el('colour-calc')?.value);setVal('#price',currentPrice?.value);setVal('#settlementTotal',newPrice?.value);setVal('#term',newTerm?.value);const ftv=financeType?.value.toUpperCase()||'',ftInput=f.querySelector('#financeType'),ftBtns=f.querySelectorAll('.btn-finance-type[data-target="financeType"]');if(ftInput)ftInput.value=ftv;if(ftBtns)ftBtns.forEach(b=>b.classList.toggle('selected',b.dataset.value.toUpperCase()===ftv))};const iAF=()=>{const c=financeFormEmbedContainer;if(!c)return;const sections=Array.from(c.querySelectorAll('.form-section')),pBar=c.querySelector('#progress-bar'),pText=c.querySelector('#progress-bar-text');const form=c.querySelector('#finance-application-form'),fErr=c.querySelector('#form-general-error'),cModal=el('confirmSubmitModal'),sModal=el('successModal');let currentSection=1,totalSections=7,sModalTimeout;
if(form)form.addEventListener('keydown',e=>{if(e.key==='Enter')e.preventDefault()});const v={email:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),postcode:p=>/^([Gg][Ii][Rr] 0[Aa]{2}|(?![QVX])[A-PR-UWYZ](?![IJZ][A-HK-Y])[A-HK-Y]?\d\d?[A-Z]?\s*\d[ABD-HJLNP-UW-Z]{2})$/i.test(p.trim()),sortCode:s=>/^\d{2}-?\d{2}-?\d{2}$/.test(s)&&s.replace(/-/g,'').length===6,accNum:a=>/^\d{8}$/.test(a),phone:p=>{if(!p)return!1;let n=p.replace(/[\s()-]+/g,'');if(n.startsWith('+44'))n='0'+n.substring(3);else if(n.startsWith('0044'))n='0'+n.substring(4);return/^(0(1|2|3|7|8)\d{9}|05\d{8})$/.test(n)}};const validateSection=sEl=>{let isValid=!0;const isVisible=el=>{let c=el;while(c&&c!==document.body){if(window.getComputedStyle(c).display==='none'||c.classList.contains('is-collapsed'))return!1;c=c.parentElement}return!0};sEl.querySelectorAll('input[required],select[required],textarea[required]').forEach(i=>{if(!isVisible(i)){i.classList.remove('error');const e=el(`${i.id}-error`);if(e)e.style.display='none';return}
let fieldValid=(i.type==='checkbox')?i.checked:(i.value.trim()&&!(i.id==='email'&&!v.email(i.value))&&!((i.id==='phone'||i.id==='employerPhone')&&!v.phone(i.value))&&!(i.id.toLowerCase().includes('postcode')&&!v.postcode(i.value))&&!(i.id==='sortCode'&&!v.sortCode(i.value))&&!(i.id==='accountNumber'&&!v.accNum(i.value)));i.classList.toggle('error',!fieldValid);sEl.querySelectorAll(`[data-target="${i.id}"]`).forEach(b=>b.classList.toggle('error',!fieldValid));const errEl=el(`${i.id}-error`);if(errEl)errEl.style.display=fieldValid?'none':'block';if(!fieldValid)isValid=!1});return isValid};const updateProgress=()=>{const p=Math.round(Math.max(0,(currentSection-1)/(totalSections-1)*100));if(pBar)pBar.style.width=`${p}%`;if(pText)pText.textContent=`${p}% Complete`};const showSection=sNum=>{sections.forEach(s=>s.classList.remove('active'));const t=c.querySelector(`#section-${sNum}`);if(t){t.classList.add('active');currentSection=sNum;updateProgress();setTimeout(()=>c.scrollIntoView({behavior:'smooth',block:'start'}),350)}
if(fErr)fErr.style.display='none'};c.querySelectorAll('.next-btn').forEach(b=>b.addEventListener('click',()=>{const sEl=c.querySelector('.form-section.active');if(!sEl)return;const sNum=parseInt(sEl.dataset.section,10);if(sNum===6)c.dataset.skippedBankDetails='false';if(validateSection(sEl)){sendSectionData(sEl);if(sNum<totalSections)showSection(sNum+1)}else{if(fErr){fErr.textContent="Please correct the errors before proceeding.";fErr.style.display='block'}
const firstErr=sEl.querySelector('.error');if(firstErr)setTimeout(()=>firstErr.scrollIntoView({behavior:'smooth',block:'center'}),350)}}));c.querySelectorAll('.prev-btn').forEach(b=>b.addEventListener('click',()=>{const sNum=parseInt(c.querySelector('.form-section.active')?.dataset.section,10);if(sNum>1)showSection(sNum-1)}));c.querySelectorAll('.skip-btn').forEach(b=>b.addEventListener('click',()=>{const sEl=c.querySelector('.form-section.active');const sNum=parseInt(sEl?.dataset.section,10);if(sNum===6)c.dataset.skippedBankDetails='true';const data=collectSectionData(sEl);data.__skipped='true';data.__section=sNum;data.skippedBankDetails=c.dataset.skippedBankDetails||'false';sendSectionData(sEl,data);if(sNum<totalSections)showSection(sNum+1)}));c.querySelectorAll('.btn-option,.btn-finance-type').forEach(b=>b.addEventListener('click',function(){const t=this.dataset.target,val=this.dataset.value,tInput=c.querySelector(`#${t}`),errEl=c.querySelector(`#${t}-error`);c.querySelectorAll(`[data-target="${t}"]`).forEach(btn=>btn.classList.remove('selected','error'));this.classList.add('selected');if(tInput){tInput.value=val;tInput.dispatchEvent(new Event('input',{bubbles:!0}))}
if(errEl)errEl.style.display='none'}));const sendApp=()=>{const sBtn=c.querySelector('#submit-btn');const btnRect=sBtn.getBoundingClientRect();if(sBtn){sBtn.disabled=!0;sBtn.textContent='Submitting...'}
const fData=new FormData(form),payload={};for(const[k,v]of fData.entries())payload[k]=v==='on'?'Yes':v;const now=new Date();Object.assign(payload,{agreementNumber:el('agreement-number-calc')?.value||'N/A',financeCompany:el('finance-company-calc')?.value||'N/A',applicationDate:now.toLocaleDateString('en-GB'),applicationTime:now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}),client_email_address:payload.email,consentMarketing:payload.consentMarketing?'Yes':'No',consentTerms:payload.consentTerms?'Yes':'No',consentAccurate:payload.consentAccurate?'Yes':'No'});emailjs.send('service_qxsk59h','template_newapp',payload).then(async()=>{if(liveRowIndex){await postToScript({action:'updateSheetData',rowIndex:liveRowIndex,data:{__status:'submitted',__submittedAt:new Date().toISOString()}})}
const successMsg=el('inline-success-message'),submitBtn=el('submit-btn'),prevBtn=c.querySelector('#section-7 .prev-btn');if(successMsg){successMsg.textContent='THANK YOU, APPLICATION SENT!';successMsg.classList.remove('hidden');successMsg.classList.add('pulse-success')}
if(submitBtn)submitBtn.classList.add('hidden');if(prevBtn)prevBtn.classList.add('hidden');if(sModal){const modalContent=sModal.querySelector('.modal-content');sModal.style.visibility='hidden';sModal.style.display='flex';const modalRect=modalContent.getBoundingClientRect();sModal.style.display='none';sModal.style.visibility='visible';let top=btnRect.top+(btnRect.height/2)-(modalRect.height/2);let left=btnRect.left+(btnRect.width/2)-(modalRect.width/2);top=Math.max(10,Math.min(top,window.innerHeight-modalRect.height-10));left=Math.max(10,Math.min(left,window.innerWidth-modalRect.width-10));modalContent.style.top=`${top}px`;modalContent.style.left=`${left}px`;sModal.style.display='flex';sModalTimeout=setTimeout(()=>{if(sModal.style.display==='flex')sModal.style.display='none'},8e3)}},()=>{showAlert('Failed to send application. Please try again.');if(sBtn){sBtn.disabled=!1;sBtn.textContent='Submit Application'}})}
if(form)form.addEventListener('submit',e=>{e.preventDefault();const lastSection=c.querySelector('#section-7');if(!validateSection(lastSection)){if(fErr){fErr.textContent="Please correct the errors before proceeding.";fErr.style.display='block'}
const firstErr=lastSection.querySelector('.error');if(firstErr)setTimeout(()=>firstErr.scrollIntoView({behavior:'smooth',block:'center'}),350);return}
sendSectionData(lastSection);if(cModal){const submitBtn=el('submit-btn');const modalContent=cModal.querySelector('.modal-content');cModal.style.display='flex';const btnRect=submitBtn.getBoundingClientRect();const modalRect=modalContent.getBoundingClientRect();let top=btnRect.top-modalRect.height-10;let left=btnRect.left+(btnRect.width/2)-(modalRect.width/2);top=Math.max(10,top);left=Math.max(10,left);left=Math.min(left,window.innerWidth-modalRect.width-10);modalContent.style.top=`${top}px`;modalContent.style.left=`${left}px`}else{sendApp()}});const addModalListener=(id,event,cb)=>{const e=el(id);if(e)e.addEventListener(event,cb)};addModalListener('confirmSubmitBtn','click',()=>{if(cModal)cModal.style.display='none';sendApp()});addModalListener('cancelSubmitBtn','click',()=>{if(cModal)cModal.style.display='none'});addModalListener('closeSuccessModalBtn','click',()=>{if(sModal)sModal.style.display='none';if(sModalTimeout)clearTimeout(sModalTimeout)});addModalListener('termsLink','click',e=>{e.preventDefault();const m=el('termsModal');if(m)m.style.display='flex'});addModalListener('privacyLink','click',e=>{e.preventDefault();const m=el('privacyModal');if(m)m.style.display='flex'});document.querySelectorAll('.close-button,.close-modal-btn').forEach(b=>b.addEventListener('click',function(){const m=el(this.dataset.modal);if(m)m.style.display='none'}));window.addEventListener('click',e=>{if(e.target.classList.contains('modal'))e.target.style.display='none'});const termSelect=el('term');if(termSelect)for(let i=12;i<=62;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i} months`;termSelect.appendChild(o)}
const cAY=el('currentAddressYears'),cAM=el('currentAddressMonths'),pAC=el('previousAddressContainer'),pAF=pAC.querySelectorAll('input:not(#previousAddressLine2),select');const checkTimeAtAddr=()=>{const totalMonths=(parseInt(cAY?.value||0))*12+(parseInt(cAM?.value||0));pAC.classList.toggle('is-collapsed',totalMonths>=36);pAF.forEach(f=>totalMonths<36?f.setAttribute('required',''):f.removeAttribute('required'))};if(cAY&&cAM)[cAY,cAM].forEach(e=>e.addEventListener('input',checkTimeAtAddr));const eY=el('employmentYears'),eM=el('employmentMonths'),pEC=el('previousEmployerContainer'),prevEmployerFields=pEC.querySelectorAll('input,select');const checkTimeAtEmp=()=>{const totalMonths=(parseInt(eY?.value||0))*12+(parseInt(eM?.value||0));pEC.classList.toggle('is-collapsed',totalMonths>=12);prevEmployerFields.forEach(f=>totalMonths<12?f.setAttribute('required',''):f.removeAttribute('required'))};if(eY&&eM)[eY,eM].forEach(e=>e.addEventListener('input',checkTimeAtEmp));const sc=el('sortCode'),an=el('accountNumber');if(sc)sc.addEventListener('input',e=>{let v=e.target.value.replace(/\D/g,'').slice(0,6);e.target.value=v.replace(/(\d{2})(?=\d)/g,'$1-');if(v.length===6)an?.focus()});if(an)an.addEventListener('input',e=>{e.target.value=e.target.value.replace(/\D/g,'').slice(0,8);if(e.target.value.length===8)el('bankYears')?.focus()});if(sections.length>0)showSection(1)};function setupEventListeners(){const listen=(id,event,cb)=>{const e=el(id);if(e)e.addEventListener(event,cb)};listen('vrn-lookup-btn-calc','click',handleVrnLookup);if(vrnInputCalc){vrnInputCalc.addEventListener('input',e=>e.target.value=e.target.value.toUpperCase());vrnInputCalc.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();vrnLookupBtnCalc.click()}})}
listen('year-calc','input',toggleAdditionalVehicleDetails);listen('find-savings-btn','click',()=>{section1Wrapper.classList.remove('hidden');if(financeType.value==='hp'){currentBalloon.value='0'}
setTimeout(()=>section1Wrapper.scrollIntoView({behavior:'smooth',block:'center'}),350)});listen('section-1-next-btn','click',()=>{const price=sanitize(currentPrice.value);const deposit=sanitize(currentDeposit.value);if(price<=0){return triggerErrorShake('current-price','Please enter the Original Car Purchase Price before proceeding.')}
if(deposit>price){return triggerErrorShake('current-deposit','Deposit paid cannot be more than the car purchase price.')}
if(sanitize(currentInterest.value)<=0&&currentInterest.value.trim()!=='0'){return triggerErrorShake('current-interest','Please enter a valid Current APR (%) before proceeding.')}
if(financeType.value==='pcp'&&monthlyPaymentContainer.classList.contains('hidden')&&sanitize(currentBalloon.value)<=0&&currentBalloon.value.trim()!=='0'){return triggerErrorShake('current-balloon','Please enter the Balloon payment (£) for a PCP agreement, or use the estimate feature.')}
section2Wrapper.classList.remove('hidden');setTimeout(()=>section2Wrapper.scrollIntoView({behavior:'smooth',block:'center'}),350)});listen('request-quote-btn','click',()=>{section3Wrapper.classList.remove('hidden');setTimeout(()=>section3Wrapper.scrollIntoView({behavior:'smooth',block:'center'}),350)});listen('calculate-btn','click',()=>{const nameField=el('contact-name');const emailField=el('contact-email');const phoneField=el('contact-phone');[nameField,emailField,phoneField].forEach(f=>f.classList.remove('error'));if(!nameField||!nameField.value.trim()){nameField.classList.add('error');showAlert('Please enter your full name.');return}
if(!emailField||!emailField.value.trim()||!validationRules.email(emailField.value)){emailField.classList.add('error');showAlert('Please enter a valid email address.');return}
if(!phoneField||!phoneField.value.trim()||!validationRules.phone(phoneField.value)){phoneField.classList.add('error');showAlert('Please enter a valid UK phone number.');return}
let allData=collectAllCalculatorData();allData.__section='CompareItClicked';if(allData.contactName){const nameParts=allData.contactName.split(' ');allData.firstName=nameParts.shift()||'';allData.lastName=nameParts.join(' ');delete allData.contactName}
if(allData.contactEmail){allData.email=allData.contactEmail;delete allData.contactEmail}
if(allData.contactPhone){allData.phone=allData.contactPhone;delete allData.contactPhone}
if(liveRowIndex){postToScript({action:'updateSheetData',rowIndex:liveRowIndex,data:allData})}else if(isSessionStarting){pendingUpdates.push(allData)}else{startLiveSession(allData)}
performCalc(!0);sendEmail()});listen('contact-phone','keydown',e=>{if(e.key==='Enter'){e.preventDefault();calculateBtn.click()}});listen('i-dont-have-figures-btn','click',()=>{const priceInput=el('current-price');if(!priceInput||sanitize(priceInput.value)<=0){triggerErrorShake('current-price','Please enter the Original Car Purchase Price before estimating.')}else{monthlyPaymentContainer.classList.remove('hidden');iDontHaveFiguresBtn.classList.add('hidden');currentInterest.value='';if(financeType.value==='hp'){currentBalloon.value='0'}else{currentBalloon.value=''}
autoUpdateFields();currentMonthlyPayment.focus()}});const clearErrorOnChange=inputId=>{listen(inputId,'input',()=>{const input=el(inputId);const label=document.querySelector(`label[for="${inputId}"]`);const cleanValue=input.value.replace(/[£,%\s]/g,'');if(cleanValue.trim()!==''&&!isNaN(cleanValue)){input.classList.remove('input-error-shake','error');if(label){label.classList.remove('label-error-shake')}}})};clearErrorOnChange('current-price');clearErrorOnChange('current-interest');clearErrorOnChange('current-balloon');clearErrorOnChange('current-deposit');listen('current-monthly-payment','input',liveReverseCalcAPR);[currentPrice,currentDeposit,currentTerm].forEach(e=>listen(e?.id,'input',()=>{if(monthlyPaymentContainer.classList.contains('hidden')){currentInterest.value='';if(financeType.value!=='hp'){currentBalloon.value=''}}else{liveReverseCalcAPR()}
if(financeType.value==='hp'){currentBalloon.value='0'}
autoUpdateFields()}));listen('finance-type','change',()=>{const isEstimateMode=!monthlyPaymentContainer.classList.contains('hidden');if(financeType.value==='hp'){currentBalloon.value='0';currentBalloon.readOnly=!0;currentBalloon.classList.add('bg-gray-100')}else{currentBalloon.readOnly=!1;currentBalloon.classList.remove('bg-gray-100');currentBalloon.value=''}
if(isEstimateMode){liveReverseCalcAPR()}
autoUpdateFields()});[currentStartDate,currentInterest,currentBalloon,newInterest,newTerm].forEach(e=>listen(e?.id,'input',autoUpdateFields));listen('current-balloon','input',()=>currentBalloon.dataset.manuallySet='true');listen('credit-score','change',()=>{updateAprFromCredit();autoUpdateFields()});listen('current-term','input',()=>{const termInput=el('current-term');const hasValue=termInput&&sanitize(termInput.value)>0;termInput.classList.toggle('input-valid-greyed',hasValue);const isHidden=!hasValue;findSavingsBtn.classList.toggle('hidden',isHidden);if(!isHidden){findSavingsBtn.classList.add('pulse-cta-animation')}else{findSavingsBtn.classList.remove('pulse-cta-animation')}});listen('goal-save-monthly','click',()=>handleGoal('save-monthly'));listen('goal-extend-term','click',()=>handleGoal('extend-term'));listen('goal-own-my-car','click',()=>handleGoal('own-my-car'));listen('goal-reset-results','click',handleResetResults);document.querySelectorAll('.refinance-trigger').forEach(b=>b.addEventListener('click',()=>{let allData=collectAllCalculatorData();allData.__section='RefinanceNowClicked';if(allData.contactName){const nameParts=allData.contactName.split(' ');allData.firstName=nameParts.shift()||'';allData.lastName=nameParts.join(' ');delete allData.contactName}
if(allData.contactEmail){allData.email=allData.contactEmail;delete allData.contactEmail}
if(allData.contactPhone){allData.phone=allData.contactPhone;delete allData.contactPhone}
if(liveRowIndex){postToScript({action:'updateSheetData',rowIndex:liveRowIndex,data:allData})}else if(isSessionStarting){pendingUpdates.push(allData)}else{startLiveSession(allData)}
financeFormEmbedContainer.classList.remove('hidden');setTimeout(() => financeFormEmbedContainer.scrollIntoView({behavior:'smooth'}), 350);pEF()}));[contactName,contactEmail,contactPhone,vrnInputCalc,el('make-calc'),el('model-calc'),yearInputCalc,el('vin-calc'),el('colour-calc'),currentPrice,newPrice,newTerm,financeType].forEach(f=>{if(f)f.addEventListener(f.tagName==='SELECT'?'change':'input',pEF)})}
async function postToScript(payload){try{const response=await fetch(LIVE_SCRIPT_URL,{method:'POST',cache:'no-cache',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload),redirect:'follow'});if(payload.action==='startNewApplication'){if(!response.ok)throw new Error(`HTTP ${response.status}`);const result=await response.json();if(result&&result.rowIndex)return{success:!0,rowIndex:result.rowIndex};throw new Error('Invalid startNewApplication response')}else{if(!response.ok){const text=await response.text().catch(()=>'');throw new Error(`Update failed: ${response.status} ${text}`)}
return{success:!0}}}catch(error){return{success:!1,error}}}
function getRefererFromUrl(){try{const pathSegments=window.location.pathname.split('/').filter(Boolean);return pathSegments.length>0?pathSegments[pathSegments.length-1]:'Direct'}catch(e){return'Direct'}}
async function startLiveSession(initialData) {
    if (isSessionStarting) return;
    isSessionStarting = true;
    const meta = { referer: getRefererFromUrl() };
    const result = await postToScript({
        action: 'startNewApplication',
        meta: meta
    });
    if (result.success && result.rowIndex) {
        liveRowIndex = result.rowIndex;
        try { sessionStorage.setItem('liveRowIndex', String(liveRowIndex)); } catch (e) {}
        await postToScript({
            action: 'updateSheetData',
            rowIndex: liveRowIndex,
            data: initialData
        });
        while (pendingUpdates.length) {
            postToScript({ action: 'updateSheetData', rowIndex: liveRowIndex, data: pendingUpdates.shift() });
        }
    } else {
    }
    isSessionStarting = false;
}
function collectSectionData(sectionElement){const data={};const inputs=sectionElement.querySelectorAll('input, select, textarea');inputs.forEach(input=>{if(input.id){if(input.type==='checkbox'){data[input.id]=input.checked?'Checked':'Unchecked'}else{data[input.id]=input.value}}});return data}
function sendSectionData(sectionElement,overrideData){const sectionData=overrideData||collectSectionData(sectionElement);sectionData.__section=sectionElement?.dataset?.section||sectionElement?.id||'';if(liveRowIndex){postToScript({action:'updateSheetData',rowIndex:liveRowIndex,data:sectionData})}else if(isSessionStarting){pendingUpdates.push(sectionData)}else{startLiveSession(sectionData)}}
(function init(){try{const nav=performance.getEntriesByType('navigation')[0];const isReload=nav?nav.type==='reload':!1;const urlParams=new URLSearchParams(window.location.search);if(isReload||urlParams.has('fresh')){sessionStorage.removeItem('liveRowIndex')}else{const stored=sessionStorage.getItem('liveRowIndex');if(stored)liveRowIndex=parseInt(stored,10)||null}}catch{}
if(yearInputCalc)yearInputCalc.max=new Date().getFullYear()+1;if(newInterest&&!newInterest.value)newInterest.value='8.9';if(currentStartDate&&!currentStartDate.value){const d=new Date();d.setFullYear(d.getFullYear()-1);d.setDate(d.getDate()+1);currentStartDate.valueAsDate=d}
populateManufacturers();iAF();toggleAdditionalVehicleDetails();setupEventListeners();autoUpdateFields()})()});
</script>
<script>
(function(){
  function scoreToDegrees(score, min=300, max=850){
    var s = Math.max(min, Math.min(max, Number(score) || min));
    return ((s - min) / (max - min)) * 180 - 90;
  }
  function mapBandToScore(val){
    switch(val){
      case 'very-good': return 825;  
      case 'good':      return 760;  
      case 'fair':      return 690;  
      case 'poor':      return 620;  
      case 'very-poor': return 520;  
      default:          return 690;
    }
  }
  function updateGauge(score){
    var needle = document.getElementById('credit-gauge-needle');
    var valueEl = document.getElementById('credit-gauge-value');
    if(!needle || !valueEl) return;
    var deg = scoreToDegrees(score);
    needle.style.setProperty('--rotation', deg + 'deg');
    valueEl.textContent = Math.round(score);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var bandSelect = document.getElementById('credit-score');
    var resetBtn   = document.getElementById('goal-reset-results');
    if (bandSelect) updateGauge(mapBandToScore(bandSelect.value));
    if (bandSelect) {
      bandSelect.addEventListener('change', function(){
        updateGauge(mapBandToScore(this.value));
      });
    }
    if (resetBtn) {
      resetBtn.addEventListener('click', function(){
        if (bandSelect) updateGauge(mapBandToScore(bandSelect.value));
      });
    }
  });
})();
</script>
<script>
(function(){
  function bandToScore(val){
    switch(val){
      case 'very-good': return 825;
      case 'good':      return 760;
      case 'fair':      return 690;
      case 'poor':      return 620;
      case 'very-poor': return 520;
      default:          return 690;
    }
  }
  function scoreToDeg(score,min=300,max=850){
    var s = Math.max(min, Math.min(max, Number(score)||min));
    return ((s - min) / (max - min)) * 180 - 90;
  }
  function setNeedleTargetFromBand(){
    var sel = document.getElementById('credit-score');
    var needle = document.getElementById('credit-gauge-needle');
    if(!sel || !needle) return;
    var target = bandToScore(sel.value);
    needle.style.setProperty('--rotation', scoreToDeg(target) + 'deg');
  }
  function startRollingScore(){
    var el = document.getElementById('credit-gauge-value');
    if(!el) return;
    var start = 0, end = 900, duration = 10000; 
    function animate(){
      var t0 = performance.now();
      function frame(now){
        var p = (now - t0) / duration;
        if (p > 1) p = 1;
        var val = Math.floor(start + (end - start) * p);
        el.textContent = val;
        if (p < 1) requestAnimationFrame(frame);
        else setTimeout(animate, 200); 
      }
      requestAnimationFrame(frame);
    }
    animate();
  }
  document.addEventListener('DOMContentLoaded', function(){
    setNeedleTargetFromBand();
    var sel = document.getElementById('credit-score');
    if (sel) sel.addEventListener('change', setNeedleTargetFromBand);
    var resetBtn = document.getElementById('goal-reset-results');
    if (resetBtn) resetBtn.addEventListener('click', setNeedleTargetFromBand);
    startRollingScore();
  });
})();
</script>
<script>
(function(){
  function el(id){ return document.getElementById(id); }
  function toInt(v){ var n=parseInt(v,10); return isNaN(n)?0:n; }
  var years = el('employmentYears');
  var months = el('employmentMonths');
  var prevBox = document.getElementById('previousEmployerContainer');
  var prevName = el('previousEmployerName');
  var prevRole = el('previousOccupation');
  var prevAddr1 = el('previousEmployerAddress1');
  var prevYears = el('previousEmploymentYears');
  var prevMonths = el('previousEmploymentMonths');
  var form = el('finance-application-form');
  var section3 = document.getElementById('section-3');
  var section3NextBtn = section3 ? section3.querySelector('.next-btn') : null;
  if(!years || !months || !form) return;
  if (prevBox) {
    prevBox.classList.add('is-collapsed');
    prevBox.style.display = 'none';
    prevBox.setAttribute('aria-hidden','true');
  }
  [prevName, prevRole, prevAddr1, prevYears, prevMonths].forEach(function(i){
    if(i) i.removeAttribute('required');
  });
  var touched = false; 
  function currentMonths(){
    return (toInt(years.value) * 12) + toInt(months.value);
  }
  function setRequired(on){
    [prevName, prevRole, prevAddr1, prevYears, prevMonths].forEach(function(i){
      if(!i) return;
      if(on){ i.setAttribute('required',''); }
      else { i.removeAttribute('required'); }
    });
  }
  function showPrev(on){
    if(!prevBox) return;
    if(on){
      prevBox.classList.remove('is-collapsed');
      prevBox.style.display = '';
      prevBox.removeAttribute('aria-hidden');
    } else {
      prevBox.classList.add('is-collapsed');
      prevBox.style.display = 'none';
      prevBox.setAttribute('aria-hidden','true');
    }
  }
  function needPrevious(){
    return currentMonths() < 36;
  }
  function applyRule(options){
    options = options || {};
    if (!touched && !options.force) {
      setRequired(false);
      showPrev(false);
      return;
    }
    var needPrev = needPrevious();
    setRequired(needPrev);
    showPrev(needPrev);
    return needPrev;
  }
  function validatePrevIfNeeded(){
    var needPrev = applyRule({force:true});
    if (!needPrev) return true;
    var fields = [prevName, prevRole, prevAddr1, prevYears, prevMonths];
    var ok = true;
    fields.forEach(function(i){
      if (!i) return;
      var empty = (i.value == null) || (String(i.value).trim() === "");
      if (empty) {
        ok = false;
        i.classList.add('error');
        if (i.setCustomValidity) i.setCustomValidity('This field is required');
        var sib = i.nextElementSibling;
        if (sib && sib.classList && sib.classList.contains('error-message')) {
          sib.style.display = 'block';
        }
      } else {
        i.classList.remove('error');
        if (i.setCustomValidity) i.setCustomValidity('');
        var sib2 = i.nextElementSibling;
        if (sib2 && sib2.classList && sib2.classList.contains('error-message')) {
          sib2.style.display = 'none';
        }
      }
    });
    if (!ok && prevBox && prevBox.scrollIntoView) {
      prevBox.scrollIntoView({behavior:'smooth', block:'start'});
    }
    return ok;
  }
  ['input','change','blur'].forEach(function(evt){
    years.addEventListener(evt, function(){ touched = true; applyRule(); }, {passive:true});
    months.addEventListener(evt, function(){ touched = true; applyRule(); }, {passive:true});
  });
  if (section3NextBtn) {
    section3NextBtn.addEventListener('click', function(e){
      touched = true;
      if (!validatePrevIfNeeded()) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
  }
  form.addEventListener('submit', function(e){
    touched = true;
    if (!validatePrevIfNeeded()) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
  }, true);
})();
</script>
<style>
  #agent-column {
    position: fixed;
    top: 0; right: 0;
    width: 380px; height: 100%;
    background: #fff;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0,0,0,.1);
    z-index: 9999;
    display: flex; flex-direction: column;
    overflow-y: auto;
  }
  #agent-column h3 { color: #004225; }
  body { margin-right: 380px; } 
  @media print { #agent-column { display: none !important; } body { margin-right: 0; } }
</style>
<div id="agent-column">
  <div class="p-4 border-b flex items-center justify-between bg-gray-50">
    <div class="flex flex-col">
      <span class="text-sm font-semibold text-racing-green-700">Agent Mode</span>
      <span class="text-xs text-gray-500">Guided prompts + live comparison</span>
    </div>
  </div>
  <div class="px-4 py-3">
    <div class="grid grid-cols-3 gap-2 mb-3">
      <button class="agent-stage bg-racing-green-700 text-white rounded-lg px-3 py-2 text-sm" data-stage="qualify">Qualify</button>
      <button class="agent-stage bg-gray-100 text-gray-800 rounded-lg px-3 py-2 text-sm" data-stage="compare">Compare</button>
      <button class="agent-stage bg-gray-100 text-gray-800 rounded-lg px-3 py-2 text-sm" data-stage="close">Close</button>
    </div>
    <div id="agent-prompts" class="space-y-3"></div>
    <div id="agent-compare-card" class="mt-4 hidden">
      <h3 class="text-lg font-semibold mb-2">Live Comparison (Old vs New)</h3>
      <div class="flex items-center flex-wrap gap-2 mb-3">
        <div class="flex items-center gap-1 bg-racing-green-50 border px-2 py-1 rounded-lg">
          <button id="term-minus" class="px-2 py-1 rounded bg-white border hover:bg-gray-50">-1</button>
          <div class="text-xs text-gray-600">New Term</div>
          <button id="term-plus" class="px-2 py-1 rounded bg-white border hover:bg-gray-50">+1</button>
        </div>
        <div class="text-xs text-gray-500">Range: 12–84 months</div>
        <div class="ml-auto flex items-center gap-2">
          <button id="term-reset" class="px-3 py-1 text-xs rounded bg-gray-100 border hover:bg-gray-200">Reset</button>
          <button id="copy-summary" class="px-3 py-1 text-xs rounded bg-gray-100 border hover:bg-gray-200">Copy</button>
        </div>
      </div>
      <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full text-sm">
          <thead class="bg-racing-green-50 text-racing-green-700">
            <tr>
              <th class="text-left p-2">Metric</th>
              <th class="text-right p-2">Current</th>
              <th class="text-right p-2">New</th>
              <th class="text-right p-2">Δ</th>
            </tr>
          </thead>
          <tbody id="cmp-rows" class="divide-y"></tbody>
        </table>
      </div>
      <p id="erc-note" class="text-xs text-gray-500 mt-2"></p>
    </div>
  </div>
</div>
<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const toNum = (txt) => {
    if (txt == null) return 0;
    const s = (""+txt).replace(/[£,\s]/g,'');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  };
  const fmt = (v) => {
    const sign = v < 0 ? "-" : "";
    const s = Math.round(Math.abs(v)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return sign + "£" + s;
  };
  function rebuildAgentComparison(){
    const rowsEl = $("cmp-rows");
    if (!rowsEl) return;
    const cMonthly = toNum($("summary-current-monthly")?.textContent);
    const nMonthly = toNum($("summary-new-monthly")?.textContent);
    const cTotal   = toNum($("summary-current-total")?.textContent);
    const nTotal   = toNum($("summary-new-total")?.textContent);
    const cTerm    = $("summary-current-term")?.textContent || "";
    const nTerm    = $("summary-new-term")?.textContent || "";
    const cBalloon = toNum($("summary-current-balloon-equity")?.textContent);
    const nBalloon = toNum($("summary-new-balloon-equity")?.textContent);
    const monthlyDiff = cMonthly - nMonthly;
    const totalDiff   = cTotal - nTotal;
    const termDelta   = (() => {
      const getM = (s)=>parseInt(String(s).replace(/\D/g,''),10)||0;
      const a=getM(cTerm), b=getM(nTerm);
      const d=b-a;
      return (d===0) ? "No change" : (Math.abs(d)+" mo " + (d<0?"less":"more"));
    })();
    const balDiff = nBalloon - cBalloon;
    const row = (k, a, b, d, cls="") => `<tr>
      <td class="p-2">${k}</td>
      <td class="p-2 text-right">${a}</td>
      <td class="p-2 text-right">${b}</td>
      <td class="p-2 text-right ${cls}">${d}</td>
    </tr>`;
    rowsEl.innerHTML = [
      row("Monthly Payment", fmt(cMonthly), fmt(nMonthly),
          (monthlyDiff>=0? "−":"+") + fmt(Math.abs(monthlyDiff)),
          monthlyDiff>=0?"text-green-600 font-semibold":"text-red-600 font-semibold"),
      row("Balance to Own", fmt(cTotal), fmt(nTotal),
          (totalDiff>=0? "−":"+") + fmt(Math.abs(totalDiff)),
          totalDiff>=0?"text-green-600 font-semibold":"text-red-600 font-semibold"),
      row("Term Length", cTerm, nTerm, termDelta, "font-semibold"),
      row("Balloon / Equity", fmt(cBalloon), fmt(nBalloon),
          (balDiff===0? "No change" : ( (balDiff<0?"−":"+") + fmt(Math.abs(balDiff)) )), "font-semibold")
    ].join("");
    const ercNote = $("erc-note");
    if (ercNote) {
      ercNote.textContent = "This comparison updates automatically as you adjust figures on the left.";
    }
  }
  function renderPrompts(stage){
    const host = $("agent-prompts");
    if (!host) return;
    if (stage === "qualify") {
      host.innerHTML = `
        <div class="space-y-3 text-sm text-gray-800">
          <h4 class="text-xs tracking-wide uppercase text-gray-500">QUALIFY</h4>
          <p class="font-medium">Build RAPPORT in this section — get to know your customer. 🙂</p>
          <ul class="list-disc list-inside space-y-1">
            <li>Confirm the <strong>finance company</strong> and the <strong>vehicle details</strong> (make & model).</li>
            <li>Confirm <strong>purchase date</strong>.</li>
          </ul>
          <p class="text-xs text-gray-600 italic border-l-2 border-green-500 pl-3">
            "So I can see your BMW is with CLOSE BROTHERS finance, purchased in May 2024"
          </p>
          <h5 class="mt-3 font-semibold">Soft fact discussions to build trust…</h5>
          <p class="text-xs text-gray-600 italic">
            "Amazing, I can see it’s an M‑Sport model, nice!"<br>
            "Mercedes are my favourite car if I had to choose between that and an Audi or BMW!"
          </p>
          <h5 class="mt-2 font-semibold">Your Current Finance</h5>
          <ul class="list-disc list-inside space-y-1">
            <li>Confirm <strong>price paid for car</strong> and any <strong>deposit</strong> used.</li>
            <li>Confirm <strong>monthly payment</strong> with the customer.</li>
            <li>Check customer <strong>goal & preferences</strong> — Save monthly? Lower APR? Own the car outright at end of term? Extend deal to keep car longer?</li>
          </ul>
          <div class="text-xs text-gray-600">
            <p>"We can estimate some of these details if you don't have everything to hand."</p>
            <p>"The minimum we need is the <strong>Price / Deposit / Monthly Payment</strong>."</p>
            <p>Use <strong>ESTIMATE MY APR</strong> if the customer doesn’t know all the detail.</p>
          </div>
          <h5 class="mt-2 font-semibold">New Finance Option</h5>
          <p class="text-xs text-gray-600">Leave this as <strong>EXCELLENT credit score</strong> for now — we’ll discuss how credit band affects APR later.</p>
          <h5 class="mt-2 font-semibold">Results Show Next</h5>
          <p class="text-xs text-gray-600">We should have these details already but it’s worth taking time to check data and spellings here!</p>
        </div>
      `;
      return;
    }
    if (stage === "compare") {
      host.innerHTML = `
        <div class="space-y-2 text-sm text-gray-800">
          <h4 class="text-xs tracking-wide uppercase text-gray-500">COMPARE</h4>
          <ul class="list-disc list-inside space-y-1">
            <li>Click through the Table which shows rates based on credit score bands</li>
            <li>Rate shown in each credit score band is the best rate seen in this banding</li>
            <li>Actual rates are subject to your vehicle’s make, model, age and mileage, your credit score, your personal circumstances, and lender policies.</li>
            <li>Lightly discuss with customer the results shown within the Table and the Savings Summary (click different bands in the table to see the different outcomes)</li>
          </ul>
        </div>
`;
      return;
    }
    host.innerHTML = `
      <div class="space-y-2 text-sm text-gray-800">
        <h4 class="text-xs tracking-wide uppercase text-gray-500">CLOSE</h4>
        <ul class="list-disc list-inside space-y-1">
          <li>Recap savings and end‑of‑term position.</li>
          <li>Confirm band/term chosen and proceed to application.</li>
          <li>Capture consents; send disclosure & pre‑contract info.</li>
        </ul>
      </div>
    `;
  }
  function setActiveStage(stage){
    document.querySelectorAll(".agent-stage").forEach(btn => {
      const on = btn.getAttribute("data-stage") === stage;
      btn.className = `agent-stage ${on ? 'bg-racing-green-700 text-white' : 'bg-gray-100 text-gray-800'} rounded-lg px-3 py-2 text-sm`;
    });
    renderPrompts(stage);
  }
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".agent-stage").forEach(btn => {
      btn.addEventListener("click", () => {
        const stage = btn.getAttribute("data-stage") || "qualify";
        setActiveStage(stage);
      });
    });
    setActiveStage("qualify");
    const toWatch = [
      "summary-current-monthly","summary-new-monthly",
      "summary-current-total","summary-new-total",
      "summary-current-term","summary-new-term",
      "summary-current-balloon-equity","summary-new-balloon-equity"
    ].map(id => document.getElementById(id)).filter(Boolean);
    const mo = new MutationObserver(() => rebuildAgentComparison());
    toWatch.forEach(node => mo.observe(node, {characterData:true, childList:true, subtree:true}));
    rebuildAgentComparison();
    const compareBtn = document.getElementById("calculate-btn");
    if (compareBtn) {
      compareBtn.addEventListener("click", () => {
        setActiveStage("compare");
      });
    }
  });
})();
</script>
<script>
(function(){
function pmt(pv, apr, term, balloon){
  if (term <= 0) return 0;
  var r = (apr||0)/1200;
  pv = Math.max(0, pv); balloon = Math.max(0, balloon);
  if (r === 0) return (pv - balloon)/term;
  var pvBalloon = balloon / Math.pow(1+r, term);
  var eff = pv - pvBalloon;
  return (eff * r * Math.pow(1+r, term)) / (Math.pow(1+r, term) - 1);
}
function calcSettlement(){
  function gv(id){
    var el = document.getElementById(id);
    if(!el) return 0;
    return parseFloat(String(el.value||'0').replace(/[, \t]/g,''))||0;
  }
  var price   = gv('current-price');
  var deposit = gv('current-deposit');
  var term    = parseInt((document.getElementById('current-term')||{}).value||'0',10)||0;
  var paid    = parseInt((document.getElementById('current-payments-made')||{}).value||'0',10)||0;
  var apr     = gv('current-interest');
  var balloon = gv('current-balloon');
  var loan = Math.max(0, price - deposit);
  var r = apr/1200;
  if (loan<=0 || term<=0) return 0;
  var m;
  if (r === 0) { m = (loan - balloon)/term; }
  else {
    var pvBalloon = balloon / Math.pow(1+r, term);
    var eff = loan - pvBalloon;
    m = (eff * r * Math.pow(1+r, term)) / (Math.pow(1+r, term) - 1);
  }
  var bal = loan;
  for (var i=0; i<Math.min(paid, term); i++){
    var interest = bal * r;
    bal = bal + interest - m;
  }
  return paid >= term ? balloon : Math.max(0, bal);
}
var CREDIT_BANDS = [
  {key:'very-good', name:'EXCELLENT', apr:8.9},
  {key:'good',      name:'GOOD',      apr:9.9},
  {key:'fair',      name:'FAIR',      apr:10.9},
  {key:'poor',      name:'LOW',       apr:19.9},
  {key:'very-poor', name:'VERY LOW',  apr:22.9}
];
function readProposal(){
  var nt = document.getElementById('new-term') || document.getElementById('term');
  var nb = document.getElementById('new-balloon');
  var term = parseInt((nt && nt.value)||'0',10)||0;
  var balloon = parseFloat(String((nb && nb.value)||'0').replace(/[, \t]/g,''))||0;
  return { term: term, balloon: balloon };
}
function £(v){ return '£' + Math.round(v).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
function buildBandTableViewOnly(){
  var table = document.getElementById('creditBandTable');
  if(!table) return;
  var tbody = table.querySelector('tbody');
  if(!tbody) return;
  var pv = 0;
  try { if (typeof calcSettlement === 'function') pv = calcSettlement(); } catch(e){ pv = 0; }
  var termEl = document.getElementById('new-term') || document.getElementById('term');
  var term = termEl ? parseInt(termEl.value || termEl.textContent || 0, 10) : 0;
  var balloonEl = document.getElementById('new-balloon');
  var balloon = balloonEl && balloonEl.value ? parseFloat(balloonEl.value) : 0;
  function fmtGBP(v){
    try{ return '£' + (parseFloat(v)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
    catch(e){ return '£0.00'; }
  }
  function PMT(principal, aprPercent, nper, fv){
    if (typeof pmt === 'function') return pmt(principal, aprPercent, nper, fv);
    var r = (aprPercent/100)/12;
    if (!nper || nper <= 0) return 0;
    if (Math.abs(r) < 1e-12) return (principal - (fv||0))/nper;
    var v = Math.pow(1+r, -nper);
    return ((principal - (fv||0)*v) * r) / (1 - v);
  }
  var rows = [];
  for (var i=0; i<CREDIT_BANDS.length; i++){
    var band = CREDIT_BANDS[i];
    var apr = band.apr;
    var monthly = PMT(pv, apr, term, balloon);
    if (!isFinite(monthly)) monthly = 0;
    var total = monthly * term + balloon;
    var bandName = (band.name || '').toUpperCase();
    rows.push(
      '<tr data-band="'+bandName+'">' +
        '<th>'+ (band.name || '') +'</th>' +
        '<td>'+ apr.toFixed(1) +'%</td>' +
        '<td>'+ fmtGBP(balloon) +'</td>' +
        '<td>'+ (term||0) +'</td>' +
        '<td>'+ fmtGBP(monthly) +'</td>' +
        '<td>'+ fmtGBP(total) +'</td>' +
      '</tr>'
    );
  }
  tbody.innerHTML = rows.join('');
  try {
    var sel = document.getElementById('credit-score');
    var map = { 'very-good':'EXCELLENT','good':'GOOD','fair':'FAIR','poor':'LOW','very-poor':'VERY LOW' };
    var name = sel ? map[sel.value] || 'EXCELLENT' : 'EXCELLENT';
    var trs = tbody.querySelectorAll('tr');
    trs.forEach(function(r){ r.classList.remove('active'); });
    var active = tbody.querySelector('tr[data-band="'+name+'"]');
    if (active) active.classList.add('active');
  } catch(e){}
}
var pv = calcSettlement();
  var ref = readProposal();
  for (var i=0;i<CREDIT_BANDS.length;i++){
    var b = CREDIT_BANDS[i];
    var name = (b.name||'').toUpperCase();
    if (name === 'VERY-LOW') name = 'VERY LOW';
    var tr = table.querySelector('tbody tr[data-band="'+ name +'"]');
    if (!tr) {
      var tb = table.querySelector('tbody');
      tr = document.createElement('tr');
      tr.setAttribute('data-band', name);
      tr.innerHTML = '<th>'+name+'</th><td></td><td></td><td></td><td></td><td></td>';
      tb.appendChild(tr);
    }
    var cells = tr.querySelectorAll('td');
    var monthly = pmt(pv, b.apr, ref.term, ref.balloon);
    if (!isFinite(monthly)) monthly = 0;
    var total = monthly * ref.term + ref.balloon;
    cells[0].textContent = b.apr.toFixed(1) + '%';
    cells[1].textContent = £(ref.balloon);
    cells[2].textContent = (function(){var t=document.getElementById('summary-new-term');var v=t?parseInt((t.textContent||'').replace(/[^0-9]/g,''),10):NaN;return isFinite(v)&&v>0?v:ref.term})();
    cells[3].textContent = £(monthly);
    cells[4].textContent = £(total);
  }
}
  var pv = calcSettlement();
  var ref = readProposal();
  var BAND_NAME_MAP = {
    'EXCELLENT':'EXCELLENT',
    'GOOD':'GOOD',
    'FAIR':'FAIR',
    'LOW':'LOW',
    'VERY LOW':'VERY LOW'
  };
  for (var i=0;i<CREDIT_BANDS.length;i++){
    var b = CREDIT_BANDS[i];
    var name = b.name.toUpperCase();
    if (name === 'VERY LOW' || name === 'VERY-LOW') name = 'VERY LOW';
    var tr = table.querySelector('tbody tr[data-band=\"'+ name +'\"]');
    if (!tr) {
      var tb = table.querySelector('tbody');
      tr = document.createElement('tr');
      tr.setAttribute('data-band', name);
      tr.innerHTML = '<th>'+name+'</th><td></td><td></td><td></td><td></td><td></td><td>—</td>';
      tb.appendChild(tr);
    }
    var cells = tr.querySelectorAll('td');
    var monthly = pmt(pv, b.apr, ref.term, ref.balloon);
    if (!isFinite(monthly)) monthly = 0;
    var total = monthly * ref.term + ref.balloon;
    cells[0].textContent = b.apr.toFixed(1) + '%';
    cells[1].textContent = £(ref.balloon);
    cells[2].textContent = ref.term;
    cells[3].textContent = £(monthly);
    cells[4].textContent = £(total);
    if (cells.length > 5 && !cells[5].textContent) { cells[5].textContent = '—'; }
  }
}
  var tbodyHost = table.querySelector('tbody');
  if(!tbodyHost){ return; }
  var pv = calcSettlement();                  
  var ref = readProposal();                   
  var rows = [];
  for (var i=0;i<CREDIT_BANDS.length;i++){
    var b = CREDIT_BANDS[i];
    var monthly = pmt(pv, b.apr, ref.term, ref.balloon);
    if (!isFinite(monthly)) monthly = 0;
    var total = monthly*ref.term + ref.balloon;
    rows.push(
      '<tr>' +
        '<th>'+ b.name +'</th>' +
        '<td>'+ b.apr.toFixed(1) +'%' + '</td>' +
        '<td>'+ £(ref.balloon) +'</td>' +
        '<td>'+ ref.term +'</td>' +
        '<td>'+ £(monthly) +'</td>' +
        '<td>'+ £(total) +'</td>' +
        '<td>—</td>' +
      '</tr>'
    );
  }
  tbodyHost.innerHTML = rows.join('');
}
}
function hookBandTable(id, evt){
  var el = document.getElementById(id);
  if (el) el.addEventListener(evt||'input', buildBandTableViewOnly);
}
document.addEventListener('DOMContentLoaded', function(){
  ['current-price','current-deposit','current-term','current-payments-made','current-interest','current-balloon','new-term','new-balloon'].forEach(function(id){ hookBandTable(id,'input'); });
  var moTargets = ['summary-current-monthly','summary-new-monthly','summary-current-total','summary-new-total'];
  var mo = new MutationObserver(buildBandTableViewOnly);
  for (var i=0;i<moTargets.length;i++){ var n = document.getElementById(moTargets[i]); if (n) mo.observe(n,{childList:true,subtree:true,characterData:true}); }
  buildBandTableViewOnly();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (typeof buildBandTableViewOnly === 'function') {
    var ids = ['current-price','current-deposit','current-term','current-payments-made','current-interest','current-balloon','new-term','new-balloon'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.addEventListener('input', buildBandTableViewOnly);
    });
    try {
      var moTargets = ['summary-current-monthly','summary-new-monthly','summary-current-total','summary-new-total'];
      var mo = new MutationObserver(buildBandTableViewOnly);
      moTargets.map(function(id){ return document.getElementById(id); })
               .filter(function(n){ return !!n; })
               .forEach(function(n){ mo.observe(n,{childList:true,subtree:true,characterData:true}); });
    } catch(e) {  }
    try { buildBandTableViewOnly(); } catch(e) {}
  }
});
</script>
<script>
(function(){
  function syncTableHeightWithGauge(){
    try{
      var gauge = document.querySelector('#credit-score-gauge-wrapper .gauge-outer-container');
      var tableWrap = document.querySelector('.band-wrap');
      if (!gauge || !tableWrap) return;
      var h = Math.max(0, Math.round(gauge.getBoundingClientRect().height));
      if (h > 0){
        tableWrap.style.height = h + 'px';
        tableWrap.style.maxHeight = h + 'px';
      }
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    syncTableHeightWithGauge();
    window.addEventListener('resize', syncTableHeightWithGauge);
    try {
      if (typeof buildBandTableViewOnly === 'function'){
        var old = buildBandTableViewOnly;
        window.buildBandTableViewOnly = function(){
          var r = old.apply(this, arguments);
          syncTableHeightWithGauge();
          return r;
        };
      }
    } catch(e){}
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var btn = document.getElementById('save-now-refinance-btn');
  if (btn){
    btn.addEventListener('click', function(){
      var big = document.getElementById('refinance-now-btn-large');
      var alt = document.getElementById('refinance-now-btn-2');
      if (big) big.click(); else if (alt) alt.click();
    });
  }
  var s1 = document.getElementById('section-1-wrapper');
  var s2 = document.getElementById('section-2-wrapper');
  var s3 = document.getElementById('section-3-wrapper');
  if (s1 && s3){
    var nextBtn = Array.from(s1.querySelectorAll('button')).find(function(b){
      return /\bnext\b/i.test((b.textContent||'').trim());
    });
    if (nextBtn){
      nextBtn.addEventListener('click', function(){
        setTimeout(function(){
          if (s2) s2.classList.add('hidden');
          s3.classList.remove('hidden');
          try{ s3.scrollIntoView({behavior:'smooth', block:'start'});}catch(e){}
        }, 80);
      });
    }
  }
});
</script>
<script>
(function(){
  function mapBandNameToSelectValue(name){
    switch(String(name||'').toUpperCase()){
      case 'EXCELLENT': return 'very-good';
      case 'GOOD':      return 'good';
      case 'FAIR':      return 'fair';
      case 'LOW':       return 'poor';
      case 'VERY LOW':  return 'very-poor';
      default:          return null;
    }
  }
  function mapSelectValueToBandName(val){
    switch(String(val||'')){
      case 'very-good': return 'EXCELLENT';
      case 'good':      return 'GOOD';
      case 'fair':      return 'FAIR';
      case 'poor':      return 'LOW';
      case 'very-poor': return 'VERY LOW';
      default:          return null;
    }
  }
  function highlightBandRow(name){
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    var rows = table.querySelectorAll('tbody tr');
    rows.forEach(function(r){ r.classList.remove('active'); });
    var tr = table.querySelector('tbody tr[data-band="'+ name +'"]');
    if (tr){ tr.classList.add('active'); }
  }
  function setCreditBand(name){
    var sel = document.getElementById('credit-score');
    var val = mapBandNameToSelectValue(name);
    if (!sel || !val) return;
    if (sel.value !== val){
      sel.value = val;
      sel.dispatchEvent(new Event('change', {bubbles:true}));
      sel.dispatchEvent(new Event('input', {bubbles:true}));
    } else {
      sel.dispatchEvent(new Event('change', {bubbles:true}));
    }
    try { if (typeof buildBandTableViewOnly === 'function') buildBandTableViewOnly(); } catch(e){}
    highlightBandRow(mapSelectValueToBandName(sel.value) || name);
  }
  function wireRowClicks(){
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    table.querySelectorAll('tbody tr').forEach(function(tr){
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', function(){
        var name = this.getAttribute('data-band');
        setCreditBand(name);
      });
    });
  }
  function defaultOnCompare(){
    var calcBtn = document.getElementById('calculate-btn');
    if (!calcBtn) return;
    calcBtn.addEventListener('click', function(){
      setTimeout(function(){
        setCreditBand('EXCELLENT');
      }, 150);
    });
  }
  function reflectSelectToTable(){
    var sel = document.getElementById('credit-score');
    if (!sel) return;
    sel.addEventListener('change', function(){
      var name = mapSelectValueToBandName(this.value);
      if (name) highlightBandRow(name);
    });
    setTimeout(function(){
      var name = mapSelectValueToBandName(sel.value);
      if (name) highlightBandRow(name);
    }, 0);
  }
  document.addEventListener('DOMContentLoaded', function(){
    wireRowClicks();
    defaultOnCompare();
    reflectSelectToTable();
  });
})();
</script>
<style>
  #creditBandTable tbody tr.active th,
  #creditBandTable tbody tr.active td{
    background:#cfeee0 !important;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.0);
  }
  #creditBandTable tbody tr:hover td,
  #creditBandTable tbody tr:hover th{
    background:#e6f6ef;
  }
</style>
<script>
<script>
(function(){
  function _safeRecalculate(){
    try{
      if (typeof performCalc === 'function'){ performCalc(false); }
      else {
        var ni = document.getElementById('new-interest'); if (ni) ni.dispatchEvent(new Event('change',{bubbles:true}));
        var nt = document.getElementById('new-term'); if (nt) nt.dispatchEvent(new Event('change',{bubbles:true}));
        var nb = document.getElementById('new-balloon'); if (nb) nb.dispatchEvent(new Event('change',{bubbles:true}));
      }
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    if (typeof applyBand === 'function'){
      var _origApply = applyBand;
      window.applyBand = function(name){
        var r = _origApply.apply(this, arguments);
        _safeRecalculate();
        return r;
      };
    }
    var sel = document.getElementById('credit-score');
    if (sel){
      sel.addEventListener('change', function(){ _safeRecalculate(); });
    }
  });
})();
</script>
<script>
(function () {
  var BAND_TO_SELECT_VALUE = {
    'EXCELLENT': 'very-good',
    'GOOD':      'good',
    'FAIR':      'fair',
    'LOW':       'poor',
    'VERY LOW':  'very-poor'
  };
  var BAND_APR = { 'EXCELLENT': 8.9, 'GOOD': 9.9, 'FAIR': 10.9, 'LOW': 19.9, 'VERY LOW': 22.9 };
  function _safeRecalculate() {
    try {
      if (typeof performCalc === 'function') {
        performCalc(false);
      } else {
        ['new-interest','new-term','new-balloon'].forEach(function(id){
          var el = document.getElementById(id);
          if (el) {
            el.dispatchEvent(new Event('input', {bubbles:true}));
            el.dispatchEvent(new Event('change', {bubbles:true}));
          }
        });
      }
    } catch (e) {}
  }
  function _setNewAPR(apr) {
    var ni = document.getElementById('new-interest');
    if (ni) {
      var val = parseFloat(apr);
      if (!isNaN(val)) {
        if (String(ni.value) !== String(val)) {
          ni.value = val;
          ni.dispatchEvent(new Event('input', {bubbles:true}));
        }
        ni.dispatchEvent(new Event('change', {bubbles:true}));
      }
    }
  }
  function _highlightBand(name) {
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    table.querySelectorAll('tbody tr').forEach(function (r) { r.classList.remove('active'); });
    var tr = table.querySelector('tbody tr[data-band="' + name + '"]');
    if (tr) tr.classList.add('active');
  }
  window.applyBand = function(name) {
    var band = String(name || 'EXCELLENT').toUpperCase();
    var sel = document.getElementById('credit-score');
    var val = BAND_TO_SELECT_VALUE[band] || BAND_TO_SELECT_VALUE['EXCELLENT'];
    if (sel) {
      if (sel.value !== val) {
        sel.value = val;
        sel.dispatchEvent(new Event('change', {bubbles:true}));
      } else {
        sel.dispatchEvent(new Event('change', {bubbles:true}));
      }
    }
    if (BAND_APR.hasOwnProperty(band)) _setNewAPR(BAND_APR[band]);
    try { if (typeof buildBandTableViewOnly === 'function') buildBandTableViewOnly(); } catch(e){}
    _highlightBand(band);
    setTimeout(_safeRecalculate, 150);
  };
  function _wireTableClicks() {
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    ['click','dblclick'].forEach(function(evt){
      table.addEventListener(evt, function(e){
        var tr = e.target.closest('tr[data-band]');
        if (!tr) return;
        window.applyBand(tr.getAttribute('data-band'));
      });
    });
  }
  function _observeRebuilds() {
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    var tb = table.querySelector('tbody');
    if (!tb || !window.MutationObserver) return;
    var mo = new MutationObserver(function(){
      var sel = document.getElementById('credit-score');
      var map = { 'very-good':'EXCELLENT','good':'GOOD','fair':'FAIR','poor':'LOW','very-poor':'VERY LOW' };
      var name = sel ? map[sel.value] || 'EXCELLENT' : 'EXCELLENT';
      _highlightBand(name);
    });
    mo.observe(tb, {childList:true, subtree:true});
  }
  document.addEventListener('DOMContentLoaded', function () {
    _wireTableClicks();
    _observeRebuilds();
    var calcBtn = document.getElementById('calculate-btn');
    if (calcBtn) {
      calcBtn.addEventListener('click', function () {
        setTimeout(function () { window.applyBand('EXCELLENT'); }, 150);
      });
    }
  });
})();
</script>
<script>
(function(){
  function _safeRecalculate(){
    try{
      if (typeof performCalc === 'function'){ performCalc(false); }
      else {
        ['new-interest','new-term','new-balloon'].forEach(function(id){
          var el=document.getElementById(id);
          if(el){ el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }
        });
      }
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    var sel = document.getElementById('credit-score');
    if (sel){
      sel.addEventListener('change', function(){
        setTimeout(_safeRecalculate, 150);
      });
    }
  });
})();
</script>
<script>
(function(){
  function debounce(fn, t){ var id; return function(){ var args=arguments; clearTimeout(id); id=setTimeout(function(){ fn.apply(null,args); }, t||120); }; }
  var rebuild = debounce(function(){ try{ buildBandTableViewOnly(); }catch(e){} }, 150);
  document.addEventListener('DOMContentLoaded', function(){
    ['new-term','new-balloon','current-price','current-deposit','current-term','current-payments-made','current-interest','current-balloon']
      .forEach(function(id){
        var el = document.getElementById(id);
        if (el){
          el.addEventListener('input', rebuild);
          el.addEventListener('change', rebuild);
        }
      });
    rebuild();
  });
})();
</script>
<script>
(function(){
  function recalcThenRebuild(){
    try{ if (typeof performCalc === 'function'){ performCalc(false); } }catch(e){}
    setTimeout(function(){ try{ buildBandTableViewOnly(); }catch(e){} }, 150);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var table = document.getElementById('creditBandTable');
    if (table){
      ['click','dblclick'].forEach(function(evt){
        table.addEventListener(evt, function(e){
          var tr = e.target.closest('tr[data-band]'); if (!tr) return;
          if (typeof window.applyBand === 'function'){ window.applyBand(tr.getAttribute('data-band')); }
          else {
            var back = { 'EXCELLENT':'very-good','GOOD':'good','FAIR':'fair','LOW':'poor','VERY LOW':'very-poor' };
            var name = tr.getAttribute('data-band');
            var sel = document.getElementById('credit-score');
            if (sel && back[name]){ sel.value = back[name]; sel.dispatchEvent(new Event('change',{bubbles:true})); }
          }
          recalcThenRebuild();
        });
      });
    }
  });
})();
</script>
<script>
(function(){
  function _safeRecalculateThenRefresh(){
    try {
      if (typeof performCalc === 'function') {
        performCalc(false); 
      } else {
        ['new-interest','new-term','new-balloon'].forEach(function(id){
          var el=document.getElementById(id);
          if(el){
            el.dispatchEvent(new Event('input',{bubbles:true}));
            el.dispatchEvent(new Event('change',{bubbles:true}));
          }
        });
      }
    } catch(e){}
    setTimeout(function(){
      try { buildBandTableViewOnly(); } catch(e) {}
      try {
        var sel = document.getElementById('credit-score');
        var map = { 'very-good':'EXCELLENT','good':'GOOD','fair':'FAIR','poor':'LOW','very-poor':'VERY LOW' };
        var name = sel ? (map[sel.value] || 'EXCELLENT') : 'EXCELLENT';
        var table = document.getElementById('creditBandTable');
        if (table){
          table.querySelectorAll('tbody tr').forEach(function(r){ r.classList.remove('active'); });
          var tr = table.querySelector('tbody tr[data-band="'+name+'"]');
          if (tr) tr.classList.add('active');
        }
      } catch(e){}
    }, 150);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('psr-update-btn');
    if (btn){
      btn.addEventListener('click', _safeRecalculateThenRefresh);
    }
  });
})();
</script>
<script>
(function(){
  function getSelectedBandName(){
    var sel = document.getElementById('credit-score');
    var map = { 'very-good':'EXCELLENT','good':'GOOD','fair':'FAIR','poor':'LOW','very-poor':'VERY LOW' };
    if (sel && sel.value) return map[sel.value] || 'EXCELLENT';
    var tr = document.querySelector('#creditBandTable tbody tr.active');
    return tr ? tr.getAttribute('data-band') : 'EXCELLENT';
  }
  function suppressEmails(){
    var stubs = {};
    try{
      if (window.emailjs && typeof window.emailjs.send === 'function'){
        stubs.emailjs = { send: window.emailjs.send };
        window.emailjs.send = function(){ try { return Promise.resolve(); } catch(e){ return; } };
      }
    }catch(e){}
    try{
      if (typeof window.sendEmail === 'function'){
        stubs.sendEmail = window.sendEmail;
        window.sendEmail = function(){  };
      }
    }catch(e){}
    window.__noEmail = true;
    return function restore(){
      try{ if (stubs.emailjs && stubs.emailjs.send) window.emailjs.send = stubs.emailjs.send; }catch(e){}
      try{ if (stubs.sendEmail) window.sendEmail = stubs.sendEmail; }catch(e){}
      window.__noEmail = false;
    };
  }
  function reapplyBandAndRecalc(bandName){
    try{
      if (typeof window.applyBand === 'function'){
        window.applyBand(bandName);
      } else {
        var back = { 'EXCELLENT':'very-good','GOOD':'good','FAIR':'fair','LOW':'poor','VERY LOW':'very-poor' };
        var sel = document.getElementById('credit-score');
        if (sel && back[bandName]){
          sel.value = back[bandName];
          sel.dispatchEvent(new Event('change',{bubbles:true}));
        }
      }
    }catch(e){}
    setTimeout(function(){
      try{ if (typeof performCalc === 'function'){ performCalc(false); } }catch(e){}
      setTimeout(function(){ try{ buildBandTableViewOnly(); }catch(e){} }, 150);
    }, 150);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('psr-update-btn');
    var calcBtn = document.getElementById('calculate-btn');
    if (!btn || !calcBtn) return;
    btn.addEventListener('click', function(){
      var chosen = getSelectedBandName();
      var restore = suppressEmails();
      try { calcBtn.click(); } catch(e){}
      setTimeout(function(){
        try { restore(); } catch(e){}
        reapplyBandAndRecalc(chosen);
      }, 250);
    });
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var extendBtn = document.querySelector('#goal-extend-term, #extend-term-btn, #extend-term, button[data-action="extend-term"]');
  if (extendBtn){
    extendBtn.textContent = 'EXTEND +1';
    extendBtn.addEventListener('click', function(e){
      try{
        var termEl = document.getElementById('new-term') || document.getElementById('term');
        if (termEl){
          var current = parseInt(termEl.value || termEl.textContent || '0', 10) || 0;
          var next = current + 1;
          termEl.value = next;
          termEl.dispatchEvent(new Event('input', {bubbles:true}));
          termEl.dispatchEvent(new Event('change', {bubbles:true}));
        }
      }catch(err){}
    }, { once: false });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  function recalcAndRefresh(){
    try { if (typeof performCalc === 'function') performCalc(false); } catch(e){}
    setTimeout(function(){ try{ buildBandTableViewOnly(); }catch(e){} }, 150);
  }
  function clampTerm(val){
    var min = 1, max = 120;
    var t = parseInt(val, 10) || 0;
    if (t < min) t = min;
    if (t > max) t = max;
    return t;
  }
  var termEl = document.getElementById('new-term') || document.getElementById('term');
  var extendBtn = document.querySelector('#goal-extend-term, #extend-term-btn, #extend-term, button[data-action="extend-term"]');
  if (extendBtn){
    extendBtn.textContent = 'EXTEND +1';
    extendBtn.addEventListener('click', function(){
      var el = document.getElementById('new-term') || document.getElementById('term');
      if (!el) return;
      var current = parseInt(el.value || el.textContent || '0', 10) || 0;
      var next = clampTerm(current + 1);
      if (el.value !== undefined) el.value = next; else el.textContent = String(next);
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
      recalcAndRefresh();
    });
  }
  var reduceBtn = document.getElementById('goal-reduce-term');
  if (reduceBtn){
    reduceBtn.addEventListener('click', function(){
      var el = document.getElementById('new-term') || document.getElementById('term');
      if (!el) return;
      var current = parseInt(el.value || el.textContent || '0', 10) || 0;
      var next = clampTerm(current - 1);
      if (el.value !== undefined) el.value = next; else el.textContent = String(next);
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
      recalcAndRefresh();
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  try { buildBandTableViewOnly(); } catch(e){}
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var selector = '#goal-extend-term, #extend-term-btn, #extend-term, button[data-action="extend-term"]';
  var btn = document.querySelector(selector);
  if (!btn) return;
  var clone = btn.cloneNode(true);
  clone.id = btn.id || 'goal-extend-term';
  clone.textContent = 'EXTEND +1';
  btn.parentNode.replaceChild(clone, btn);
  clone.addEventListener('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    try{
      var el = document.getElementById('new-term') || document.getElementById('term');
      if (!el) return;
      var current = parseInt(el.value || el.textContent || '0', 10) || 0;
      var next = Math.max(1, Math.min(120, current + 1));
      if (el.value !== undefined) el.value = next; else el.textContent = String(next);
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
      try { if (typeof performCalc === 'function') performCalc(false); } catch(e){}
      setTimeout(function(){ try{ buildBandTableViewOnly(); }catch(e){} }, 150);
    }catch(err){}
  }, {capture:true});
});
</script>
<script>
(function(){
  var timer = null;
  function scheduleUpdate(){
    clearTimeout(timer);
    timer = setTimeout(function(){
      try{
        var btn = document.getElementById('psr-update-btn');
        if (btn) btn.click();
      }catch(e){}
    }, 200);
  }
  document.addEventListener('DOMContentLoaded', function(){
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    ['click','dblclick'].forEach(function(evt){
      table.addEventListener(evt, function(ev){
        var tr = ev.target.closest('tr[data-band]');
        if (!tr) return;
        scheduleUpdate();
      });
    });
  });
})();
</script>
<script>
(function(){
  if (window.__goalTermPatchV2Loaded) return;
  window.__goalTermPatchV2Loaded = true;
  let goalTermOffset = 0;
  let lastBaselineTerm = null;
  function clamp(x, lo, hi){ x = parseInt(x,10) || 0; return Math.max(lo, Math.min(hi, x)); }
  function hasBaseline(){try{if(typeof initialCalculationState!=='undefined'&&initialCalculationState&&initialCalculationState.newTerm!=null)return true;var rs=document.getElementById('results-section'),nt=document.getElementById('new-term')||document.getElementById('term');return!!(rs&&!rs.classList.contains('hidden')&&nt&&parseInt(nt.value||nt.textContent||'0',10)>0)}catch(e){return false}}
  function baseTerm(){
    try {
      if (hasBaseline()){
        return parseInt(initialCalculationState.newTerm, 10) || 0;
      }
    } catch(e){}
    return 0;
  }
  function setTermInput(next){
    try {
      if (typeof newTerm !== 'undefined' && newTerm && 'value' in newTerm){
        newTerm.value = next;
      } else {
        const el = document.getElementById('new-term') || document.getElementById('term');
        if (el) el.value = next;
      }
      const el = document.getElementById('new-term') || document.getElementById('term');
      if (el){
        el.dispatchEvent(new Event('input', {bubbles:true}));
        el.dispatchEvent(new Event('change', {bubbles:true}));
      }
    } catch(e){}
  }
  function recalc(){
    try { if (typeof setNewBalloon === 'function') setNewBalloon(); } catch(e){}
    try { if (typeof performCalc === 'function') performCalc(false); } catch(e){}
  }
  function nudge(delta, anchorEl){
    if (!hasBaseline()){
      if (typeof showGoalAlert === 'function'){
        showGoalAlert("Please click ‘Compare It!’ first so I can use your initial comparison as the baseline.", anchorEl);
      } else {
        alert("Please click 'Compare It!' first to set a baseline.");
      }
      return;
    }
    goalTermOffset += delta;
    const base = baseTerm();
    const min = 1, max = 84;
    const next = clamp(base + goalTermOffset, min, max);
    goalTermOffset = next - base; 
    setTermInput(next);
    recalc();
  }
  function wire(){
    const extendBtn = document.getElementById('goal-extend-term');
    if (extendBtn){
      const clone = extendBtn.cloneNode(true);
      extendBtn.parentNode.replaceChild(clone, extendBtn);
      clone.addEventListener('click', function(e){ e.preventDefault(); nudge(1, clone); });
    }
    const reduceBtn = document.getElementById('goal-reduce-term');
    if (reduceBtn){
      const clone = reduceBtn.cloneNode(true);
      reduceBtn.parentNode.replaceChild(clone, reduceBtn);
      clone.addEventListener('click', function(e){ e.preventDefault(); nudge(-1, clone); });
    }
    const resetBtn = document.getElementById('goal-reset-results');
    if (resetBtn){
      resetBtn.addEventListener('click', function(){ goalTermOffset = 0; }, {capture:true});
    }
  }
  function watchBaseline(){
    let seen = hasBaseline();
    if (seen){ lastBaselineTerm = baseTerm(); }
    setInterval(function(){
      const nowHas = hasBaseline();
      if (nowHas){
        const t = baseTerm();
        if (t !== lastBaselineTerm){
          goalTermOffset = 0;
          lastBaselineTerm = t;
        }
      }
      seen = nowHas;
    }, 500);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ wire(); watchBaseline(); });
  } else {
    wire(); watchBaseline();
  }
})();
</script>
<script>
(function(){
  if (window.__gaugeSummaryReflow) return; window.__gaugeSummaryReflow = true;
  function onReady(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);} else {fn();} }
  onReady(function(){
    const gauge = document.getElementById('credit-score-gauge-wrapper');
    let summaryBox = null;
    const h4s = document.querySelectorAll('h4');
    for (const h of h4s){
      if (/Comparison Summary/i.test(h.textContent || '')){
        let node = h.closest('div');
        while (node && node.parentElement && node.parentElement !== document.body){
          if (node.className && /rounded|shadow|p-5|bg-/.test(node.className)) { break; }
          node = node.parentElement;
        }
        summaryBox = node || h.parentElement;
        break;
      }
    }
    if (!gauge || !summaryBox) return;
    const wrapper = document.createElement('div');
    wrapper.id = 'gauge-summary-row';
    wrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 items-start';
    const parent = gauge.parentNode;
    parent.insertBefore(wrapper, gauge);
    wrapper.appendChild(gauge);
    wrapper.appendChild(summaryBox);
  });
})();
</script>
<script>(function(){function s(){try{var t=document.getElementById('summary-new-term');if(!t)return;var v=parseInt((t.textContent||'').replace(/[^0-9]/g,''),10)||0;var tb=document.getElementById('creditBandTable');if(!tb)return;var rows=tb.querySelectorAll('tbody tr[data-band]');for(var i=0;i<rows.length;i++){var cells=rows[i].querySelectorAll('td');if(cells&&cells.length>=3)cells[2].textContent=v}}catch(e){}}function o(){var t=document.getElementById('summary-new-term');if(!t)return;var m=new MutationObserver(s);m.observe(t,{childList:true,subtree:true,characterData:true});s()}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',o)}else{o()}document.addEventListener('click',function(ev){if(ev.target&&ev.target.closest&&ev.target.closest('#psr-update-btn, #psr-extend, #psr-reduce, #calc-button, #compare-it-btn')){setTimeout(s,200)}});})();</script>
<script>
  (function(){
    try {
      const post = () => {
        const h = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
        parent.postMessage({ type:'cmf-autoheight', height:h }, '*');
      };
      if ('ResizeObserver' in window) {
        new ResizeObserver(post).observe(document.body);
      } else {
        setInterval(post, 600);
      }
      window.addEventListener('load', post);
      window.addEventListener('resize', post);
      post();
    } catch(e) {}
  })();
</script>


<script>
(function(){
  'use strict';
  function $(sel){ return document.querySelector(sel); }
  function num(text){ return Number(String(text||'').replace(/[^\d.-]+/g,'')) || 0; }
  function fmtGBP(v){ try{ return '£' + Math.round(v).toLocaleString('en-GB'); }catch(e){ return '£' + Math.round(v); } }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function pmtWithBalloon(P, aprAnnual, n, F){
    const i = (aprAnnual||0) / 12;
    if (n <= 0) return 0;
    if (!i) return (P - (F||0)) / n;
    const pow = Math.pow(1+i, -n);
    const adj = P - (F||0) * Math.pow(1+i, -n);
    return (adj * i) / (1 - pow);
  }
  const btnExtend = document.getElementById('goal-extend-term');
  const btnReduce = document.getElementById('goal-reduce-term');
  const table = document.getElementById('creditBandTable');
  if(!table){ return; }
  const MIN_TERM = 12, MAX_TERM = 84;
  const STEP_EXTEND = +(btnExtend?.dataset?.step || 1);
  const STEP_REDUCE = +(btnReduce?.dataset?.step || 1);
  function readInitialTerm(){
    const newTermEl = document.getElementById('new-term');
    let t = num(newTermEl?.textContent);
    if(!t){
      const sel = document.getElementById('term');
      if (sel && sel.value) t = num(sel.value);
    }
    return t || 48;
  }
  let termMonths = readInitialTerm();
  table.dataset.term = String(termMonths);
  function readInputs(){
    const price = num(document.getElementById('current-price')?.value || document.getElementById('current-price')?.textContent);
    const deposit = num(document.getElementById('current-deposit')?.value || document.getElementById('current-deposit')?.textContent);
    let P = Math.max(0, price - deposit);
    const ft = (document.getElementById('financeType')?.value || document.getElementById('finance-type')?.value || '').toLowerCase();
    let F = 0;
    const currentBalloon = num(document.getElementById('current-balloon')?.value || document.getElementById('current-balloon')?.textContent);
    if (ft.includes('pcp')) F = currentBalloon;
    return { P, F, ft };
  }

  // Prefer the summary card "Balloon Change" value if present
  

function readSummaryNewBalloon(){
  // 1) Prefer explicit '#new-balloon' input if present
  var inp = document.getElementById('new-balloon');
  if (inp){
    var raw = (inp.value || inp.textContent || '').trim();
    var v = Number(raw.replace(/[^0-9.-]+/g,''));
    if (!isNaN(v) && v >= 0) return v;
  }
  // 2) Try to find a card that contains 'Balloon Change' then parse 'New: £...'
  var cards = Array.from(document.querySelectorAll('*')).filter(function(el){
    try { return /Balloon\s*Change/i.test(el.textContent || ''); } catch(e){ return false; }
  });
  for (var i=0; i<cards.length; i++){
    var newNode = cards[i].querySelector('[data-label="new"], .new, [id*="new" i], [class*="new" i]');
    var text = newNode ? String(newNode.textContent || '') : String(cards[i].textContent || '');
    var m = text.match(/New\s*:\s*£?\s*([0-9][\d,]*(?:\.\d{1,2})?)/i);
    if (m){
      var v2 = Number(m[1].replace(/,/g,''));
      if (!isNaN(v2) && v2 >= 0) return v2;
    }
  }
  // 3) Fallback: scan any 'balloon' labeled element for a 'New:' amount
  var els = document.querySelectorAll('[id*="balloon" i], [class*="balloon" i]');
  for (var j=0; j<els.length; j++){
    var t = String(els[j].textContent || '');
    var mm = t.match(/New\s*:\s*£?\s*([0-9][\d,]*(?:\.\d{1,2})?)/i);
    if (mm){
      var v3 = Number(mm[1].replace(/,/g,''));
      if (!isNaN(v3) && v3 >= 0) return v3;
    }
  }
  return NaN;
}

  // 2) Look for a "Balloon Change" card and parse its "New:" value
  var candidates = Array.from(document.querySelectorAll('*')).filter(function(el){
    try { return /Balloon\s*Change/i.test(el.textContent || ''); } catch(e){ return false; }
  });
  for (var i=0; i<candidates.length; i++){
    var text = String(candidates[i].textContent || '');
    var m = text.match(/New\s*:\s*£?\s*([\d,]+(?:\.\d{1,2})?)/i);
    if (m){
      var v2 = Number(m[1].replace(/,/g,''));
      if (!isNaN(v2) && v2 >= 0) return v2;
    }
  }
  // 3) As a fallback, scan any element labeled with balloon for a "New:" amount
  var balloonEls = document.querySelectorAll('[id*="balloon" i], [class*="balloon" i]');
  for (var j=0; j<balloonEls.length; j++){
    var t = String(balloonEls[j].textContent || '');
    var mm = t.match(/New\s*:\s*£?\s*([\d,]+(?:\.\d{1,2})?)/i);
    if (mm){
      var v3 = Number(mm[1].replace(/,/g,''));
      if (!isNaN(v3) && v3 >= 0) return v3;
    }
  }
  // No override
  return NaN;
}
    // Fallback: if a summary new balloon text exists with a known id, parse it here
    var el = document.getElementById('summary-new-balloon');
    if (el){
      var v2 = Number(String(el.textContent||'').replace(/[^0-9.-]+/g,''));
      if (!isNaN(v2) && v2 >= 0) return v2;
    }
    // As a last resort, do not override
    return NaN;
  }

  function parseAprFromCell(cell){
    const m = String(cell?.textContent||'').match(/(\d+(?:\.\d+)?)\s*%/);
    return m ? (parseFloat(m[1]) / 100) : 0;
  }
  function getRows(){
    return Array.from(table.querySelectorAll('tbody tr')).map(tr => {
      const cells = tr.querySelectorAll('td, th');
      return {
        tr,
        band: tr.dataset.band || (cells[0]?.textContent||'').trim(),
        rateCell: cells[1],
        balloonCell: cells[2],
        termCell: cells[3],
        monthlyCell: cells[4],
        totalCell: cells[5],
        apr: parseAprFromCell(cells[1])
      };
    });
  }
  const rows = getRows();
  function recompute(){
    const inp = readInputs();
    let P = inp.P;
    let F = inp.F;
    // Override F if summary "Balloon Change" shows a value
    var summaryF = readSummaryNewBalloon();
    if (!isNaN(summaryF)) { F = summaryF; }
rows.forEach(r => {
      const monthly = pmtWithBalloon(P, r.apr, termMonths, F);
      const total = monthly * termMonths + F;
      if (r.balloonCell) r.balloonCell.textContent = fmtGBP(F);
      if (r.termCell)    r.termCell.textContent    = termMonths + ' mo';
      if (r.monthlyCell) r.monthlyCell.textContent = fmtGBP(monthly);
      if (r.totalCell)   r.totalCell.textContent   = fmtGBP(total);
    });
    const newTermEl = document.getElementById('new-term');
    if (newTermEl) newTermEl.textContent = termMonths + ' months';
    const termSel = document.getElementById('term');
    if (termSel) {
      const opt = Array.from(termSel.options).find(o => num(o.value) === termMonths);
      if (opt) termSel.value = opt.value;
    }
    if (typeof window.onQuoteTermChanged === 'function') {
      window.onQuoteTermChanged(termMonths, rows.map(r => ({
        band: r.band, apr: r.apr, monthly: num(r.monthlyCell?.textContent), totalToOwn: num(r.totalCell?.textContent)
      })));
    }
    updateButtons();
  }
  function updateButtons(){
    if (btnExtend){
      btnExtend.disabled = termMonths >= MAX_TERM;
      btnExtend.classList.toggle('opacity-50', btnExtend.disabled);
      btnExtend.classList.toggle('cursor-not-allowed', btnExtend.disabled);
    }
    if (btnReduce){
      btnReduce.disabled = termMonths <= MIN_TERM;
      btnReduce.classList.toggle('opacity-50', btnReduce.disabled);
      btnReduce.classList.toggle('cursor-not-allowed', btnReduce.disabled);
    }
    const display = document.querySelector('[data-role="term-display"], #current-term');
    if (display) display.textContent = termMonths + ' mo';
  }
  function setTerm(n){
    const clamped = clamp(n, MIN_TERM, MAX_TERM);
    if (clamped !== termMonths){
      termMonths = clamped;
      table.dataset.term = String(termMonths);
      recompute();
    }
  }
  btnExtend && btnExtend.addEventListener('click', function(){ setTerm(termMonths + STEP_EXTEND); });
  btnReduce && btnReduce.addEventListener('click', function(){ setTerm(termMonths - STEP_REDUCE); });
  const termSel = document.getElementById('term');
  if (termSel){
    termSel.addEventListener('change', function(){ const v = num(termSel.value); if (v) setTerm(v); });
  }
  
// Observe for changes so the table picks up summary updates
(function(){
  var mo, scheduled=false;
  try{
    mo = new MutationObserver(function(){
      if (scheduled) return;
      scheduled = true;
      setTimeout(function(){ scheduled=false; try{ if (typeof recompute==='function') recompute(); }catch(e){} }, 60);
    });
    mo.observe(document.body, { childList:true, characterData:true, subtree:true });
  }catch(e){}
})();

recompute();
})();</script>



<script>
(function(){
  if (window.__ConsolidatedPSR_v1) return;
  window.__ConsolidatedPSR_v1 = true;
  function clampTerm(value){ var min=12, max=84; var n=parseInt(value,10)||min; return Math.max(min, Math.min(n,max)); }
  function fmtGBP(v){ try { return '£' + Math.round(v).toLocaleString('en-GB'); } catch(e){ return '£' + Math.round(v||0); } }
  function parseMoney(txt){ return Number(String(txt||'').replace(/[^\d.-]+/g,'')); }
  function getEl(id){ return document.getElementById(id); }
  function PMT(P, apr, n, F){
    if (typeof window.pmt === 'function') { try { return window.pmt(P, apr, n, F); } catch(e){} }
    var i=(apr||0)/12; if (n<=0) return 0; if (!i) return (P-(F||0))/n;
    var pow=Math.pow(1+i,-n); var adj=P-(F||0)*Math.pow(1+i,-n); return (adj*i)/(1-pow);
  }
  function ownTermButtons(){
    var extendBtn=getEl('goal-extend-term'); var reduceBtn=getEl('goal-reduce-term');
    var newTermInput=getEl('new-term'); var termSelect=getEl('term');
    if (!extendBtn && !reduceBtn) return;
    function resetListeners(btn){ if (!btn) return null; var clone=btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn); return clone; }
    extendBtn = resetListeners(extendBtn); reduceBtn = resetListeners(reduceBtn);
    function readTerm(){
      if (newTermInput){ var raw=('value' in newTermInput && newTermInput.value!=='')?newTermInput.value:newTermInput.textContent;
        var n=parseInt(String(raw).replace(/[^0-9]/g,''),10); if (isFinite(n)&&n>0) return n; }
      if (termSelect&&termSelect.value){ var n2=parseInt(String(termSelect.value).replace(/[^0-9]/g,''),10); if (isFinite(n2)&&n2>0) return n2; }
      return 48;
    }
    function writeTerm(n){
      if (newTermInput){ if ('value' in newTermInput) newTermInput.value=n; else newTermInput.textContent=n+' months';
        try{ newTermInput.dispatchEvent(new Event('change',{bubbles:true})); }catch(e){} }
      if (termSelect){ var opt=Array.prototype.find.call((termSelect.options||[]),function(o){return parseInt(o.value,10)===n;});
        if (opt) termSelect.value=opt.value; try{ termSelect.dispatchEvent(new Event('change',{bubbles:true})); }catch(e){} }
    }
    function adjustTerm(delta){
      var next=clampTerm(readTerm()+delta); writeTerm(next);
      if (typeof window.performCalc==='function'){ try{ window.performCalc(false);}catch(e){} }
      if (typeof window.buildBandTableViewOnly==='function'){ setTimeout(function(){ try{ window.buildBandTableViewOnly(); }catch(e){} },50); }
    }
    if (extendBtn) extendBtn.addEventListener('click', function(e){ e.preventDefault(); adjustTerm(+1); });
    if (reduceBtn) reduceBtn.addEventListener('click', function(e){ e.preventDefault(); adjustTerm(-1); });
  }
  var CREDIT_BANDS=(Array.isArray(window.CREDIT_BANDS)&&window.CREDIT_BANDS.length)?window.CREDIT_BANDS:[
    {key:'very-good', name:'EXCELLENT', apr:8.9},{key:'good',name:'GOOD',apr:9.9},{key:'fair',name:'FAIR',apr:10.9},{key:'poor',name:'LOW',apr:19.9},{key:'very-poor',name:'VERY LOW',apr:22.9}
  ];
  function readNewBalloonFromSummary(){
    var el=getEl('summary-new-balloon-equity'); if (el){ var v=parseMoney(el.textContent); if (!isNaN(v)) return v; }
    var inp=getEl('new-balloon'); if (inp){ var v2=parseMoney(inp.value||inp.textContent); if (!isNaN(v2)) return v2; } return 0;
  }
  function readTermForTable(){ var el=getEl('new-term')||getEl('term'); if(!el) return 0;
    var raw=('value' in el && el.value!=='')?el.value:el.textContent; var n=parseInt(String(raw).replace(/[^0-9]/g,''),10); return isFinite(n)?n:0; }
  function readSettlement(){ try{ if(typeof window.calcSettlement==='function') return window.calcSettlement(); }catch(e){} return 0; }
  function applyBand(bandName){
    var band=CREDIT_BANDS.find(function(b){return b.name===bandName;}); if(!band) return;
    var creditSel=getEl('credit-score'); var newAPR=getEl('new-interest');
    if (creditSel) creditSel.value=band.key; if (newAPR) newAPR.value=(Number(band.apr)||0).toFixed(1);
    if (typeof window.performCalc==='function'){ try{ window.performCalc(false);}catch(e){} }
    var table=getEl('creditBandTable'); if (table){ Array.prototype.forEach.call(table.querySelectorAll('tbody tr'),function(r){r.classList.remove('active');});
      var active=table.querySelector('tbody tr[data-band="'+bandName+'"]'); if (active) active.classList.add('active'); }
    try{ buildBandTableViewOnly(); }catch(e){}
  }
  window.applyBand=applyBand;
  function buildBandTableViewOnly(){
    var table=getEl('creditBandTable'); if(!table) return; var tbody=table.querySelector('tbody'); if(!tbody) return;
    var F=readNewBalloonFromSummary(); var term=readTermForTable(); var P=readSettlement();
    var rows=CREDIT_BANDS.map(function(band){
      var monthly=PMT(P, Number(band.apr)||0, term, F); var total=(isFinite(monthly)?monthly:0)*term+F;
      return '<tr data-band="'+band.name+'">'+
        '<th>'+band.name+'</th>'+
        '<td>'+ (Number(band.apr)||0).toFixed(2) +'%</td>'+
        '<td>'+ fmtGBP(F) +'</td>'+
        '<td>'+ term +'</td>'+
        '<td>'+ fmtGBP(monthly) +'</td>'+
        '<td>'+ fmtGBP(total) +'</td>'+
      '</tr>';
    }).join('');
    tbody.innerHTML=rows;
    var creditSel=getEl('credit-score'); if (creditSel){
      var sel=CREDIT_BANDS.find(function(b){return b.key===creditSel.value;});
      if (sel){ var r=tbody.querySelector('tr[data-band="'+sel.name+'"]'); if (r) r.classList.add('active'); }
    }
  }
  window.buildBandTableViewOnly=buildBandTableViewOnly;
  function bindRowDelegation(){
    var table=getEl('creditBandTable'); if(!table) return; var body=table.querySelector('tbody'); if(!body) return;
    if (body.__delegatedRowClickBound) return;
    body.addEventListener('click', function(ev){
      var row=ev.target.closest('tr'); if(!row||!row.dataset.band) return; applyBand(row.dataset.band);
    }); body.__delegatedRowClickBound=true;
  }
  (function hookPerformCalc(){ if (typeof window.performCalc==='function' && !window.__pc_hooked_by_consolidated){
    window.__pc_hooked_by_consolidated=true; var _pc=window.performCalc;
    window.performCalc=function(){ var r=_pc.apply(this, arguments); try{ setTimeout(buildBandTableViewOnly,10);}catch(e){} return r; };
  } })();
  function init(){ ownTermButtons(); bindRowDelegation(); try{ buildBandTableViewOnly(); }catch(e){} }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init);} else { init(); }
})();
</script>





<style>
  /* Minimal, non-destructive styles for the PSR header controls */
  .psr-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .psr-title { display: inline-flex; align-items: baseline; gap: 10px; }
  .psr-controls { display: inline-flex; align-items: center; gap: 8px; }
  .psr-controls button { margin: 0; }
</style>






<script>
/* ===== PSR Consistency Patch v1.2: match summary rounding & prefer site pmt + ERC ===== */
(function(){
  if (window.__PSR_CONSISTENCY_V12) return;
  window.__PSR_CONSISTENCY_V12 = true;

  function parseMoney(x){ return Number(String(x||'').replace(/[^0-9.-]+/g,'')) || 0; }
  function formatGBP(n){ try { return '£' + Math.round(Number(n)||0).toLocaleString('en-GB'); } catch(e){ return '£' + Math.round(Number(n)||0); } }
  function parseAPRPercent(txt){ var m = String(txt||'').match(/(-?\d+(?:\.\d+)?)\s*%/); return m ? (parseFloat(m[1]) / 100) : 0; }
  function parseIntSafe(x){ var n = parseInt(String(x||'').replace(/[^0-9]/g,''),10); return isFinite(n)?n:0; }

  function getERCAmount(){
    var ids = ['#erc','#new-erc','#erc-amount','#erc_value','#summary-erc','#early-repayment-charge','#early_repayment_charge'];
    for (var i=0;i<ids.length;i++){ var el = document.querySelector(ids[i]);
      if (!el) continue;
      var val = ('value' in el && el.value !== '') ? el.value : el.textContent;
      var n = parseMoney(val); if (n) return n;
    }
    var nameEl = document.querySelector('input[name="erc"],input[name="early-repayment-charge"],input[name="early_repayment_charge"]');
    if (nameEl){ var n2=parseMoney(nameEl.value||nameEl.textContent); if (n2) return n2; }
    var dataEl=document.querySelector('[data-erc]');
    if (dataEl){ var n3 = parseMoney(dataEl.getAttribute('data-erc')); if (n3) return n3; }
    return 0;
  }

  function getSettlementPlusERC(){
    var v = 0, np = document.getElementById('new-price');
    if (np){ v = ('value' in np && np.value !== '') ? parseMoney(np.value) : parseMoney(np.textContent); }
    if (!v){ try { if (typeof window.calcSettlement === 'function') v = Number(window.calcSettlement())||0; } catch(e){} }
    return (Number(v)||0) + (Number(getERCAmount())||0);
  }

  function getFinanceType(){
    var val = '';
    var el = document.getElementById('finance-type') || document.getElementById('product-type');
    if (el && ('value' in el) && el.value) val = String(el.value).toLowerCase();
    if (!val){ var sel=document.querySelector('select[name="finance-type"],select[name="product-type"]'); if (sel&&sel.value) val=String(sel.value).toLowerCase(); }
    if (!val){ var chk=document.querySelector('input[name="finance-type"]:checked,input[name="product-type"]:checked'); if (chk&&chk.value) val=String(chk.value).toLowerCase(); }
    if (!val){ var pcp=document.querySelector('input[value="PCP"],input[value="pcp"]'); var hp=document.querySelector('input[value="HP"],input[value="hp"]'); if (pcp&&pcp.checked) val='pcp'; else if (hp&&hp.checked) val='hp'; }
    return (val==='hp'||val==='hire purchase') ? 'hp' : 'pcp';
  }

  function monthlyPayment(P, aprDec, n, F){
    // Prefer site's own pmt if available to match summary behaviour
    if (typeof window.pmt === 'function'){
      try { return window.pmt(P, aprDec*100, n, F); } catch(e){/* fallback */}
    }
    // Fallback PMT with balloon
    var i = (Number(aprDec)||0)/12; n=Number(n)||0; P=Number(P)||0; F=Number(F)||0;
    if (n<=0) return 0;
    if (!i) return (P - F)/n;
    var pow = Math.pow(1+i, -n);
    var adj = P - F * Math.pow(1+i, -n);
    return (adj * i)/(1 - pow);
  }

  function recalcConsistent(){
    var table = document.getElementById('creditBandTable'); if (!table) return;
    var tbody = table.tBodies && table.tBodies[0]; if (!tbody) return;

    var P = getSettlementPlusERC();
    var finance = getFinanceType();

    Array.prototype.forEach.call(tbody.rows, function(row){
      var tds = row.querySelectorAll('td'); if (!tds || tds.length < 5) return;
      var aprDec  = parseAPRPercent(tds[0].textContent||'0%');  // decimal e.g. 0.099
      var balloon = parseMoney(tds[1].textContent||'0');
      var term    = parseIntSafe(tds[2].textContent||'0');

      var F = (finance === 'pcp') ? balloon : 0;

      var mExact = monthlyPayment(P, aprDec, term, F);
      // Match summary display + total method: use rounded monthly for total
      var mRounded = Math.round(mExact);
      var total    = mRounded * term + F;

      tds[3].textContent = formatGBP(mRounded);
      tds[4].textContent = formatGBP(total);
    });
  }

  function schedule(){
    if (window.__psrConsistSched) return;
    window.__psrConsistSched = true;
    setTimeout(function(){ try{ recalcConsistent(); } finally { window.__psrConsistSched=false; } }, 0);
    setTimeout(function(){ try{ recalcConsistent(); } catch(e){} }, 40);
  }

  // Run after any main calc or table rebuild
  (function patchers(){
    if (typeof window.performCalc === 'function' && !window.performCalc.__psrConsistent){
      var _pc = window.performCalc;
      window.performCalc = function(){
        var r = _pc.apply(this, arguments);
        schedule(); return r;
      };
      window.performCalc.__psrConsistent = true;
    }
    if (typeof window.buildBandTableViewOnly === 'function' && !window.buildBandTableViewOnly.__psrConsistent){
      var _bb = window.buildBandTableViewOnly;
      window.buildBandTableViewOnly = function(){
        var r = _bb.apply(this, arguments);
        schedule(); return r;
      };
      window.buildBandTableViewOnly.__psrConsistent = true;
    }
    var tbody = document.querySelector('#creditBandTable tbody');
    if (tbody && !tbody.__psrConsistentObs){
      try {
        var mo = new MutationObserver(schedule);
        mo.observe(tbody, {childList:true, subtree:true, characterData:true});
        tbody.__psrConsistentObs = true;
      } catch(e){}
    }
  })();

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', schedule, {once:true}); }
  else { schedule(); }
})();
</script>


<script>
  // ===== FINAL CONSOLIDATED SCRIPT FOR PSR TABLE CONSISTENCY v5 =====
  (function() {
    if (window.__PSR_TABLE_LOGIC_V5_LOADED) return;
    window.__PSR_TABLE_LOGIC_V5_LOADED = true;

    const CREDIT_BANDS = [
      { key: 'very-good', name: 'EXCELLENT', apr: 8.90 },
      { key: 'good',      name: 'GOOD',      apr: 9.90 },
      { key: 'fair',      name: 'FAIR',      apr: 10.90 },
      { key: 'poor',      name: 'LOW',       apr: 19.90 },
      { key: 'very-poor', name: 'VERY LOW',  apr: 22.90 }
    ];

    // --- 1. HELPER FUNCTIONS ---
    const parseMoney = (text) => Number(String(text || '').replace(/[^\d.-]+/g, '')) || 0;
    const formatGBP = (num) => '£' + Math.round(Number(num) || 0).toLocaleString('en-GB');
    const pmt = (p, apr, t, b = 0) => {
      if (t <= 0) return 0;
      const r = (apr || 0) / 1200;
      if (r === 0) return (p - b) / t;
      const pvB = b / Math.pow(1 + r, t);
      const effP = p - pvB;
      const num = effP * r * Math.pow(1 + r, t);
      const den = Math.pow(1 + r, t) - 1;
      return den === 0 ? (p - b) / t : Math.max(0, num / den);
    };

    // --- 2. THE CORE LOGIC: Sync table to summary cards ---
    function syncTableToSummaryCards() {
      const table = document.getElementById('creditBandTable');
      if (!table) return;

      // A. Get baseline data from the main calculator and summary cards.
      const baseSettlement = parseMoney(document.getElementById('new-price')?.value);
      const newTerm = parseMoney(document.getElementById('new-term')?.value);
      const newBalloon = parseMoney(document.getElementById('summary-new-balloon-equity')?.textContent);
      
      // B. *** THE KEY FIX *** Get the Early Repayment Charge (ERC).
      const ercElement = document.getElementById('early-repayment-fee');
      const ercAmount = ercElement ? parseMoney(ercElement.textContent) : 0;
      const includeErc = document.getElementById('early-repayment-check')?.checked;
      
      // The final principal MUST include the ERC to match the summary cards.
      const totalPrincipalToFinance = baseSettlement + (includeErc ? ercAmount : 0);

      // C. Loop through each row and update its values.
      table.querySelectorAll('tbody tr').forEach(row => {
        const bandName = row.dataset.band;
        const band = CREDIT_BANDS.find(b => b.name === bandName);
        if (!band) return;

        const rowApr = band.apr;
        
        // D. Recalculate using the CORRECT total principal and the row's specific APR.
        const newMonthly = pmt(totalPrincipalToFinance, rowApr, newTerm, newBalloon);
        const newTotalToOwn = newMonthly * newTerm + newBalloon;

        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            cells[3].textContent = formatGBP(newMonthly);
            cells[4].textContent = formatGBP(newTotalToOwn);
        }
      });
    }

    // --- 3. PRESERVE ROW SELECTION FUNCTIONALITY ---
    function applyBand(bandName) {
      const band = CREDIT_BANDS.find(b => b.name === bandName);
      if (!band) return;
      document.getElementById('credit-score').value = band.key;
      document.getElementById('new-interest').value = band.apr.toFixed(1);

      const table = document.getElementById('creditBandTable');
      if (table) {
          table.querySelectorAll('tbody tr').forEach(row => row.classList.remove('active'));
          const activeRow = table.querySelector(`tbody tr[data-band="${bandName}"]`);
          if (activeRow) activeRow.classList.add('active');
      }
      if (typeof performCalc === 'function') {
        performCalc(false);
      }
    }

    // --- 4. WIRING & INITIALIZATION ---
    if (typeof window.performCalc === 'function' && !window.performCalc.isPatched) {
      const originalPerformCalc = window.performCalc;
      window.performCalc = function(...args) {
        originalPerformCalc.apply(this, args);
        setTimeout(syncTableToSummaryCards, 0);
      };
      window.performCalc.isPatched = true;
    }

    const tableBody = document.querySelector('#creditBandTable tbody');
    if (tableBody && !tableBody.isPatched) {
        tableBody.addEventListener('click', function(event) {
            const row = event.target.closest('tr[data-band]');
            if (row) applyBand(row.dataset.band);
        });
        tableBody.isPatched = true;
    }

    // initial run
    setTimeout(syncTableToSummaryCards, 0);
  })();
</script>


<style>
  /* Center PSR title + EXTEND/REDUCE */
  .psr-bar{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin:8px 0 12px}
  .psr-controls{display:flex;gap:8px;align-items:center}
  /* SAVE NOW – REFINANCE subtle glow + pulse */
  .pulse-cta-animation{position:relative}
  .pulse-cta-animation::after{
    content:""; position:absolute; inset:-6px; border-radius:14px;
    box-shadow:0 0 0 0 rgba(79,209,197,.55);
    animation:pulseSoftGlow 2.4s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes pulseSoftGlow{
    0%{ box-shadow:0 0 0 0 rgba(79,209,197,.55); transform:scale(1); }
    70%{ box-shadow:0 0 20px 12px rgba(79,209,197,.10); transform:scale(1.01); }
    100%{ box-shadow:0 0 0 0 rgba(79,209,197,0); transform:scale(1); }
  }
  /* Ensure PSR table can expand without internal scrolling */
  #creditBandTable{ width:100%; }
</style>
<script>
/* ===== PSR v4_test PATCH: center header + restore MONTHLY + CTA pulse + no table scroll ===== */
(function(){
  if (window.__PSR_V4TEST_PATCH_LOADED) return;
  window.__PSR_V4TEST_PATCH_LOADED = true;

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function parseMoney(s){ return Number(String(s||'').replace(/[^0-9.-]+/g,''))||0; }
  function fmtGBP(n){ try { return '£' + Math.round(Number(n)||0).toLocaleString('en-GB'); } catch(e){ return '£' + Math.round(Number(n)||0); } }

  function getFinanceType(){
    var val='';
    var el=$('#finance-type')||$('#product-type');
    if(el && el.value) val=String(el.value).toLowerCase();
    if(!val){ var sel=$('select[name="finance-type"],select[name="product-type"]'); if(sel&&sel.value) val=String(sel.value).toLowerCase(); }
    if(!val){ var chk=$('input[name="finance-type"]:checked, input[name="product-type"]:checked'); if(chk&&chk.value) val=String(chk.value).toLowerCase(); }
    if(!val){ var pcp=$('input[value="PCP"],input[value="pcp"]'); var hp=$('input[value="HP"],input[value="hp"]'); if(pcp&&pcp.checked) val='pcp'; else if(hp&&hp.checked) val='hp'; }
    return (val==='hp'||val==='hire purchase')?'hp':'pcp';
  }

  function pmtWithBalloon(P, aprDec, n, F){
    var i=(Number(aprDec)||0)/12; n=Number(n)||0; P=Number(P)||0; F=Number(F)||0;
    if(n<=0) return 0;
    if(!i) return (P-F)/n;
    var pow=Math.pow(1+i,-n);
    var adj=P - F*pow;
    return (adj*i)/(1 - pow);
  }

  function principalInclERC(){
    const base = parseMoney($('#new-price')?.value || $('#new-price')?.textContent); // settlement / amount to finance before ERC
    const ercToggle = $('#early-repayment-check');
    const includeERC = ercToggle ? !!ercToggle.checked : true;

    const cAPR  = Number($('#current-interest')?.value) || 0;
    const cTerm = parseMoney($('#current-term')?.value);
    const paid  = parseMoney($('#current-payments-made')?.value);
    const rem   = Math.max(0, cTerm - paid);

    if (!includeERC || base<=0 || cAPR<=0) return base||0;
    const interestCap = (base * (cAPR/1200)) * 2;         // two months’ interest
    const rateCap     = base * (rem > 12 ? 0.01 : 0.005); // 1% or 0.5%
    const erc = Math.min(rateCap, interestCap);
    return base + erc;
  }

  function syncPSR(){
    const table = $('#creditBandTable');
    if (!table) return;

    const termEl = $('#new-term');
    const term = termEl ? parseInt(String(termEl.value||'').replace(/[^0-9]/g,''),10) || 0 : 0;

    const financeType = getFinanceType();
    const balloonCard = parseMoney($('#summary-new-balloon-equity')?.textContent) || 0;
    const balloon = financeType === 'hp' ? 0 : balloonCard;
    const principal = principalInclERC();

    const rows = table.querySelectorAll('tbody tr[data-band]');
    rows.forEach(function(tr){
      const tds = tr.querySelectorAll('td');
      if (!tds || tds.length < 5) return;

      // Rate cell expected at tds[0], like "9.90%"
      const rateTxt = (tds[0].textContent||'0%');
      const m = rateTxt.match(/(-?\d+(?:\.\d+)?)\s*%/);
      const aprDec = m ? parseFloat(m[1])/100 : 0;

      const monthly = pmtWithBalloon(principal, aprDec, term, balloon);
      const total   = monthly * term + balloon;

      // Update cells without changing structure
      if (tds[1]) tds[1].textContent = fmtGBP(balloon); // New Balloon
      if (tds[2]) tds[2].textContent = String(term);    // New Term
      if (tds[3]) tds[3].textContent = fmtGBP(monthly); // Monthly
      if (tds[4]) tds[4].textContent = fmtGBP(total);   // Total (to own)
    });
  }

  // Center header + move EXTEND/REDUCE next to title
  function centerHeader(){
    var ex = $('#goal-extend-term'), rd = $('#goal-reduce-term');
    if (!ex && !rd) return;
    // Find "Product Sourcing Results" title element
    var title = Array.from(document.querySelectorAll('h1,h2,h3,h4,.title,.card-title,.section-title')).find(function(el){
      return /product sourcing results/i.test((el.textContent||'').trim());
    });
    var tbl = $('#creditBandTable');
    if (!title && tbl){
      title = (tbl.closest('.card, .panel, .section, .container, .content, .box') || tbl.parentElement);
      var inner = Array.from(title.querySelectorAll('h1,h2,h3,h4,.title,.card-title,.section-title')).find(function(el){
        return /product sourcing results/i.test((el.textContent||'').trim());
      });
      if (inner) title = inner;
    }
    if (!title) return;
    var bar = title.parentElement;
    if (!bar || !bar.classList || !bar.classList.contains('psr-bar')){
      var wrap = document.createElement('div');
      wrap.className = 'psr-bar';
      title.parentNode.insertBefore(wrap, title);
      wrap.appendChild(title);
      bar = wrap;
    }
    var controls = bar.querySelector('.psr-controls');
    if (!controls){
      controls = document.createElement('span');
      controls.className = 'psr-controls';
      bar.appendChild(controls);
    }
    if (ex && ex.parentNode !== controls) controls.appendChild(ex);
    if (rd && rd.parentNode !== controls) controls.appendChild(rd);
  }

  // Add glow/pulse to SAVE NOW button
  function glowCTA(){
    var candidates = [
      '#save-now-refinance-btn','#refinance-now','#save-now','#saveNowRefinanceBtn'
    ];
    var cta = null;
    for (var i=0;i<candidates.length;i++){
      cta = $(candidates[i]);
      if (cta) break;
    }
    if (!cta){
      cta = Array.from(document.querySelectorAll('a,button')).find(function(b){
        return /save now\s*-\s*refinance/i.test((b.textContent||'').trim());
      });
    }
    if (cta) cta.classList.add('pulse-cta-animation');
  }

  // Remove internal scrollbars by expanding the nearest containers
  function expandPSRHeight(){
    var tbl = $('#creditBandTable'); if (!tbl) return;
    var p = tbl.parentElement;
    var hops = 0;
    while (p && hops < 5){
      var cs = window.getComputedStyle(p);
      var oy = cs.overflowY;
      var maxh = cs.maxHeight;
      if ((oy === 'auto' || oy === 'scroll') || (maxh && maxh !== 'none')){
        p.style.overflowY = 'visible';
        p.style.maxHeight = 'none';
        p.style.height = 'auto';
      }
      p = p.parentElement; hops++;
    }
    var holder = tbl.closest('.card, .panel, .section, .container, .content, .box') || tbl.parentElement;
    if (holder){ holder.style.minHeight = '60vh'; }
  }

  // Hook once after main calc so table updates post-cards
  if (typeof window.performCalc === 'function' && !window.performCalc.__psrV4Mini){
    var _pc = window.performCalc;
    window.performCalc = function(){
      var r = _pc.apply(this, arguments);
      setTimeout(syncPSR, 0);
      return r;
    };
    window.performCalc.__psrV4Mini = true;
  }

  // Init
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      centerHeader(); glowCTA(); expandPSRHeight(); syncPSR();
    }, {once:true});
  } else {
    centerHeader(); glowCTA(); expandPSRHeight(); syncPSR();
  }
})();
</script>


<!-- === NO-INTEREST-ON-ERC PATCH (Summary + PSR table) ======================= -->
<script>
(function(){
  if (window.__NO_ERC_INTEREST_PATCH__) return;
  window.__NO_ERC_INTEREST_PATCH__ = true;

  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const money = s => Number(String(s||'').replace(/[^0-9.-]+/g,''))||0;
  const gbp = n => '£' + Math.round(Number(n)||0).toLocaleString('en-GB'); // match table rounding

  function financeType(){
    let val = ($('#finance-type')||$('#product-type')||{}).value;
    if(!val){
      const sel = $('select[name="finance-type"],select[name="product-type"]');
      if (sel) val = sel.value;
    }
    if(!val){
      const chk = $('input[name="finance-type"]:checked, input[name="product-type"]:checked');
      if (chk) val = chk.value;
    }
    val = String(val||'').toLowerCase();
    return (val==='hp'||val==='hire purchase') ? 'hp' : 'pcp';
  }

  function pmt(P, rYear, n, F){
    const i = (Number(rYear)||0)/12;
    n = Number(n)||0; P = Number(P)||0; F = Number(F)||0;
    if (n<=0) return 0;
    if (!i)   return (P - F) / n;
    const pow = Math.pow(1+i, -n);
    const adj = P - F*pow;
    return (adj*i) / (1 - pow);
  }

  // --- Inputs pulled from your UI ------------------------------------------
  function baseSettlement(){
    const el = $('#new-price');
    let v = 0;
    if (el) v = (el.tagName === 'INPUT') ? Number(el.value) : money(el.textContent);
    return Number(v)||0;
  }

  function ercAmount(){
    const include = !!($('#early-repayment-check')?.checked);
    const base = baseSettlement();
    const cAPR  = Number($('#current-interest')?.value)||0;
    const cTerm = Number($('#current-term')?.value)||0;
    const paid  = Number($('#current-payments-made')?.value)||0;
    const rem   = Math.max(0, cTerm - paid);
    if (!include || base<=0 || cAPR<=0) return 0;
    const interestCap = (base*(cAPR/1200))*2;           // two months’ interest
    const rateCap     = base*(rem>12 ? 0.01 : 0.005);   // 1% or 0.5%
    return Math.min(rateCap, interestCap);
  }

  function termVal(){
    const el = $('#new-term');
    return el ? parseInt(String(el.value||'').replace(/[^0-9]/g,''),10)||0 : 0;
  }

  function aprVal(){
    const el = $('#new-interest');
    return el ? (parseFloat(el.value)||0)/100 : 0;
  }

  function balloonVal(){
    const ft = financeType();
    const card = $('#summary-new-balloon-equity'); // already formatted in UI
    const b = card ? money(card.textContent) : 0;
    return (ft === 'hp') ? 0 : b;
  }

  // --- Summary card: set "New" monthly to match rule (interest applied to ERC) ---
  function // (removed) updateSummaryCardMonthly();{
try {
    // Do nothing: performCalc is the single source of truth and already includes ERC in principal.
    const keep = document.getElementById('summary-new-monthly');
    if (keep && keep.textContent) { /* preserve */ }
} catch(e) {}
}
    });
    if (done) return;

    function updatePSRTable(){
// Use ERC in principal (consistent with performCalc)
var _settlement = sanitize(document.getElementById('new-price')?.value);
var _incERC = !!document.getElementById('early-repayment-check')?.checked;
var _cAPR = sanitize(document.getElementById('current-interest')?.value);
var _term = parseInt(sanitize(document.getElementById('current-term')?.value), 10);
var _pmade = parseInt(sanitize(document.getElementById('current-payments-made')?.value), 10);
var _remaining = Math.max(0, _term - _pmade);
var _erc = (_incERC && _settlement > 0 && _cAPR > 0)
    ? Math.min(_settlement * (_remaining > 12 ? 0.01 : 0.005), _settlement * _cAPR/1200 * 2)
    : 0;
var settlementPlusERC = _settlement + _erc;


    const tbl = document.getElementById('creditBandTable'); if (!tbl) return;

    const n  = termVal();
    const F  = balloonVal();
    const P  = baseSettlement(); // <— NO ERC in principal
    const erc = ercAmount();

    const rows = tbl.querySelectorAll('tbody tr[data-band]');
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if (!tds || tds.length < 5) return;

      // tds[0] = Rate (e.g. "9.90%")
      const rateTxt = tds[0].textContent || '0%';
      const m = rateTxt.match(/(-?\d+(?:\.\d+)?)\s*%/);
      const apr = m ? parseFloat(m[1])/100 : 0;

      const monthly   = pmt(P, apr, n, F);
      const monthlyUI = Math.round(monthly);
      const totalUI   = Math.round(monthlyUI * n + F + erc); // ERC added once

      if (tds[1]) tds[1].textContent = gbp(F);        // New Balloon
      if (tds[2]) tds[2].textContent = String(n);     // New Term
      if (tds[3]) tds[3].textContent = gbp(monthlyUI);// Monthly
      if (tds[4]) tds[4].textContent = gbp(totalUI);  // Total (to own)
    });
  }

  // Run after your normal performCalc so we win timing without fighting
  if (typeof window.performCalc === 'function' && !window.performCalc.__noErcInterestPatch){
    const _orig = window.performCalc;
    window.performCalc = function(){
      const ret = _orig.apply(this, arguments);
      requestAnimationFrame(()=>{ // (removed) updateSummaryCardMonthly(); updatePSRTable(); });
      return ret;
    };
    window.performCalc.__noErcInterestPatch = true;
  }

  // Initial pass
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(()=>{ // (removed) updateSummaryCardMonthly(); updatePSRTable(); });
    }, {once:true});
  } else {
    requestAnimationFrame(()=>{ // (removed) updateSummaryCardMonthly(); updatePSRTable(); });
  }
})();
</script>


<script id="confirm-anchor-js">
(function(){
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function positionConfirmModal(){
    try{
      var modal = document.getElementById('confirmSubmitModal');
      if(!modal) return;
      var content = modal.querySelector('.modal-content');
      var btn = document.getElementById('submit-btn');
      if(!content || !btn) return;

      // Only run if visible
      var isOpen = modal.style.display !== 'none' && window.getComputedStyle(modal).display !== 'none';
      if(!isOpen) return;

      // Ensure we can measure
      var prevVis = content.style.visibility;
      content.style.visibility = 'hidden';
      // Force layout to ensure proper measurements
      var cw = content.offsetWidth || 360;
      var ch = content.offsetHeight || 180;
      content.style.visibility = prevVis || '';

      var gap = 12;
      var rect = btn.getBoundingClientRect();

      // Place the pop-up immediately to the LEFT of the button
      var left = rect.left - cw - gap;
      var top  = rect.top + (rect.height - ch)/2;

      // Keep within viewport bounds
      var maxTop = window.innerHeight - ch - gap;
      left = Math.max(8, Math.round(left));
      top  = Math.round(clamp(top, 8, maxTop));

      // Apply (fixed coordinates)
      content.style.left = left + 'px';
      content.style.top  = top + 'px';
      content.style.position = 'fixed';
    }catch(e){
      // fail safe: do nothing
    }
  }

  function isConfirmOpen(){
    var modal = document.getElementById('confirmSubmitModal');
    if(!modal) return false;
    var disp = modal.style.display || window.getComputedStyle(modal).display;
    return disp !== 'none';
  }

  function repositionIfOpen(){
    if(isConfirmOpen()) positionConfirmModal();
  }

  // Reposition whenever the submit button is clicked (after any existing handlers toggle the modal)
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('submit-btn');
    if(btn){
      btn.addEventListener('click', function(){
        // Wait a tick for any existing logic to open the modal
        setTimeout(positionConfirmModal, 0);
      }, true); // capture phase to run before bubbling completes
    }

    // Watch the confirm modal for display changes (opened/closed by existing code)
    var modal = document.getElementById('confirmSubmitModal');
    if(modal && 'MutationObserver' in window){
      var obs = new MutationObserver(function(){
        positionConfirmModal();
      });
      obs.observe(modal, { attributes:true, attributeFilter:['style','class'] });
    }

    // Keep it "stuck" on resize / scroll
    window.addEventListener('resize', repositionIfOpen, { passive: true });
    window.addEventListener('scroll', repositionIfOpen, { passive: true });
  });
})();
</script>


<script>
(function() {
  // Guard against running multiple times
  if (window.__TABLE_ERC_PATCH_APPLIED__) return;
  window.__TABLE_ERC_PATCH_APPLIED__ = true;

  /**
   * This new function replaces the existing table update logic.
   * Its sole purpose is to add the ERC to the principal *before* calculating the monthly payment.
   */
  function updatePSRTable_withERC_in_Principal() {
// Use ERC in principal (consistent with performCalc)
var _settlement = sanitize(document.getElementById('new-price')?.value);
var _incERC = !!document.getElementById('early-repayment-check')?.checked;
var _cAPR = sanitize(document.getElementById('current-interest')?.value);
var _term = parseInt(sanitize(document.getElementById('current-term')?.value), 10);
var _pmade = parseInt(sanitize(document.getElementById('current-payments-made')?.value), 10);
var _remaining = Math.max(0, _term - _pmade);
var _erc = (_incERC && _settlement > 0 && _cAPR > 0)
    ? Math.min(_settlement * (_remaining > 12 ? 0.01 : 0.005), _settlement * _cAPR/1200 * 2)
    : 0;
var settlementPlusERC = _settlement + _erc;


    const table = document.getElementById('creditBandTable');
    if (!table) return;

    // --- 1. Get all necessary values from the page ---
    const getEl = (id) => document.getElementById(id);
    const parseMoney = (s) => Number(String(s || '').replace(/[^\d.-]+/g, '')) || 0;
    const formatGBP = (n) => '£' + Math.round(Number(n) || 0).toLocaleString('en-GB');
    const pmt = window.pmt || function(P, rYear, n, F) { /* Fallback PMT */ };

    const baseSettlement = parseMoney(getEl('new-price')?.value);
    const ercAmount = parseMoney(getEl('early-repayment-fee')?.textContent);
    const includeErc = getEl('early-repayment-check')?.checked;
    const term = parseMoney(getEl('new-term')?.value);
    const balloon = parseMoney(getEl('summary-new-balloon-equity')?.textContent);
    
    // --- 2. THE KEY CHANGE: Create the new principal amount ---
    // The principal now includes the ERC if the checkbox is ticked.
    const principalToFinance = baseSettlement + (includeErc ? ercAmount : 0);

    // --- 3. Update each row in the table with the new calculation ---
    table.querySelectorAll('tbody tr[data-band]').forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length < 5) return;

      const rateText = cells[0].textContent || '0%';
      const aprDecimal = (parseFloat(rateText.match(/(-?\d+(?:\.\d+)?)\s*%/)?.[1]) || 0) / 100;

      // Calculate monthly payment using the principal that INCLUDES the ERC
      const monthlyPayment = pmt(principalToFinance, aprDecimal * 100, term, balloon);
      
      // Total is now derived from this new monthly payment
      const totalToOwn = monthlyPayment * term + balloon;
      
      // Update the table cells
      cells[3].textContent = formatGBP(monthlyPayment); // Monthly
      cells[4].textContent = formatGBP(totalToOwn);   // Total (to own)
    });
  }

  // --- 4. Hook into the page's calculation process ---
  // This patch waits for the original `performCalc` function to run, then immediately
  // runs our new table logic to ensure our values are the ones displayed.
  if (typeof window.performCalc === 'function' && !window.performCalc.__ercPatcher) {
    const originalPerformCalc = window.performCalc;
    window.performCalc = function(...args) {
      originalPerformCalc.apply(this, args);
      // Run our new function immediately after the original calculation completes
      requestAnimationFrame(updatePSRTable_withERC_in_Principal);
    };
    window.performCalc.__ercPatcher = true;
  }
  
  // Also run once on load in case the table is already visible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updatePSRTable_withERC_in_Principal);
  } else {
    updatePSRTable();
  }
})();
</script>

<script>
(function(){
  // Single post-calc synchronizer
  try {
    var _origPerformCalc = window.performCalc;
    if (typeof _origPerformCalc === 'function' && !_origPerformCalc.__ercSyncPatched) {
      window.performCalc = function(){
        _origPerformCalc.apply(this, arguments);
        try { updatePSRTable(); } catch(e){}
      };
      window.performCalc.__ercSyncPatched = true;
    }
  } catch(e){}
})();
</script>


<!-- Injected by ChatGPT: Neutralize inline height writers -->
<script>
(function () {
  function clearHeights() {
    try {
      var t = document.getElementById('creditBandTable')
              || document.querySelector('[data-psr]')
              || document.querySelector('.psr-table');
      var holder = t ? (t.closest('.card, .panel, .section, .container, .content, .box, .psr-holder') || t.parentElement) : null;
      if (holder) {
        holder.style.minHeight = '';
        holder.style.height = '';
        holder.style.maxHeight = '';
      }
      var wrap = t ? t.closest('.band-wrap') : document.querySelector('.band-wrap');
      if (wrap) {
        wrap.style.minHeight = '';
        wrap.style.height = '';
        wrap.style.maxHeight = '';
      }
    } catch (e) {
      console && console.warn && console.warn('Embed whitespace fixes encountered an error:', e);
    }
  }

  function observeForRewrites(el) {
    if (!el) return;
    try {
      var mo = new MutationObserver(function(muts) {
        for (var i=0; i<muts.length; i++) {
          if (muts[i].type === 'attributes' && muts[i].attributeName === 'style') {
            el.style.minHeight = '';
            el.style.height = '';
            el.style.maxHeight = '';
          }
        }
      });
      mo.observe(el, { attributes: true, attributeFilter: ['style'] });
    } catch (e) {}
  }

  function init() {
    clearHeights();

    var t = document.getElementById('creditBandTable')
            || document.querySelector('[data-psr]')
            || document.querySelector('.psr-table');
    var holder = t ? (t.closest('.card, .panel, .section, .container, .content, .box, .psr-holder') || t.parentElement) : null;
    var wrap = t ? t.closest('.band-wrap') : document.querySelector('.band-wrap');
    observeForRewrites(holder);
    observeForRewrites(wrap);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

</body></html>
<script>
(function(){
  if (window.__PSR_RowDelegate_Patched) return;
  window.__PSR_RowDelegate_Patched = true;

  function £(n){ try { return '£' + Math.round(n).toLocaleString('en-GB'); } catch(e){ return '£' + Math.round(n||0); } }
  function parseMoney(txt){ return Number(String(txt||'').replace(/[^\d.-]+/g,'')); }
  function parseAPR(txt){ var m=String(txt||'').match(/(\d+(?:\.\d+)?)\s*%/); return m? (parseFloat(m[1])/100):0; }

  function getSummaryNewBalloon(){
    var el = document.getElementById('summary-new-balloon-equity');
    if (el){
      var v = parseMoney(el.textContent);
      if (!isNaN(v)) return v;
    }
    var inp = document.getElementById('new-balloon');
    if (inp){
      var v2 = parseMoney(inp.value || inp.textContent);
      if (!isNaN(v2)) return v2;
    }
    return 0;
  }

  function getTerm(){
    var el = document.getElementById('new-term') || document.getElementById('term');
    if (!el) return 0;
    var raw = ('value' in el && el.value !== '') ? el.value : el.textContent;
    var n = parseInt(String(raw).replace(/[^0-9]/g,''), 10);
    return isFinite(n) ? n : 0;
  }

  function getSettlement(){
    try { if (typeof calcSettlement === 'function') return calcSettlement(); } catch(e){}
    return 0;
  }

  function PMT(P, apr, n, F){
    // Use site's PMT if present
    if (typeof window.pmt === 'function') {
      try { return window.pmt(P, apr, n, F); } catch(e){}
    }
    // Fallback: pmt with balloon
    var i = (apr||0)/12;
    if (n <= 0) return 0;
    if (!i) return (P - (F||0)) / n;
    var pow = Math.pow(1+i, -n);
    var adj = P - (F||0)*Math.pow(1+i,-n);
    return (adj*i)/(1-pow);
  }

  function enforceSummaryBalloonOnTable(){
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;

    var F = getSummaryNewBalloon();
    var term = getTerm();
    var P = getSettlement();

    Array.prototype.forEach.call(tbody.querySelectorAll('tr'), function(tr){
      var tds = tr.querySelectorAll('td, th');
      var rateCell = tds[1];
      var newBalloonCell = tds[2];
      var termCell = tds[3];
      var monthlyCell = tds[4];
      var totalCell = tds[5];
      var apr = parseAPR(rateCell ? rateCell.textContent : '0%');
      var monthly = PMT(P, apr, term, F);
      var total = monthly*term + F;
      if (newBalloonCell) newBalloonCell.textContent = £(F);
      if (termCell) termCell.textContent = String(term);
      if (monthlyCell) monthlyCell.textContent = £(monthly);
      if (totalCell) totalCell.textContent = £(total);
    });
  }

  function wireDelegatedRowClicks(){
    if (window.__PSR_DelegatedClickBound) return;
    var table = document.getElementById('creditBandTable');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;

    tbody.addEventListener('click', function(ev){
      var row = ev.target.closest('tr');
      if (!row) return;
      var bandName = row.getAttribute('data-band') || (row.querySelector('th') ? row.querySelector('th').textContent.trim().toUpperCase() : '');
      if (!bandName) return;

      // Prefer site's own setter if it exists
      if (typeof window.setCreditBand === 'function') {
        try { window.setCreditBand(bandName); return; } catch(e){}
      }

      // Fallback: approximate behaviour — set dropdown/APR, calc, highlight
      var map = {'EXCELLENT':'very-good','GOOD':'good','FAIR':'fair','LOW':'poor','VERY LOW':'very-poor'};
      var sel = document.getElementById('credit-score');
      if (sel && map[bandName]) sel.value = map[bandName];
      var rateCell = row.querySelector('td:nth-child(2)');
      var apr = parseAPR(rateCell ? rateCell.textContent : '0%');
      var aprInput = document.getElementById('new-interest');
      if (aprInput && !isNaN(apr)) aprInput.value = (apr*100).toFixed(1);

      if (typeof window.performCalc === 'function') { try { window.performCalc(false); } catch(e){} }

      Array.prototype.forEach.call(tbody.querySelectorAll('tr'), function(r){ r.classList.remove('active'); });
      row.classList.add('active');

      try { enforceSummaryBalloonOnTable(); } catch(e){}
    }, false);

    window.__PSR_DelegatedClickBound = true;
  }

  function init(){
    wireDelegatedRowClicks();
    enforceSummaryBalloonOnTable();

    // Re-apply whenever the table changes
    try {
      var table = document.getElementById('creditBandTable');
      var tbody = table && table.querySelector('tbody');
      if (tbody) {
        var mo = new MutationObserver(function(){ enforceSummaryBalloonOnTable(); wireDelegatedRowClicks(); });
        mo.observe(tbody, {childList:true, subtree:true});
      }
    } catch(e){}

    // Also refresh after performCalc()
    if (typeof window.performCalc === 'function' && !window.__PSR_PatchPerformCalc){
      window.__PSR_PatchPerformCalc = true;
      var _pc = window.performCalc;
      window.performCalc = function(){
        var r = _pc.apply(this, arguments);
        try { setTimeout(function(){ enforceSummaryBalloonOnTable(); wireDelegatedRowClicks(); }, 10); } catch(e){}
        return r;
      };
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
