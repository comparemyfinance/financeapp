<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>

<!-- SECURITY/POLICY: Do not add deprecated Permissions-Policy/Feature-Policy tokens (Chrome logs “Unrecognized feature”: ambient-light-sensor, speaker, vibrate, vr). If you need a permission, use a currently-supported token only. -->
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), usb=(), serial=(), xr-spatial-tracking=(), fullscreen=(self), clipboard-read=(self), clipboard-write=(self)"/>
<title>CMF Refi Orchestrator</title>
<style id="tailwind-built">
/*! tailwindcss v4.2.0 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0;--tw-rotate-x:initial;--tw-rotate-y:initial;--tw-rotate-z:initial;--tw-skew-x:initial;--tw-skew-y:initial;--tw-space-y-reverse:0;--tw-space-x-reverse:0;--tw-divide-y-reverse:0;--tw-border-style:solid;--tw-leading:initial;--tw-font-weight:initial;--tw-tracking:initial;--tw-shadow:0 0 #0000;--tw-shadow-color:initial;--tw-shadow-alpha:100%;--tw-inset-shadow:0 0 #0000;--tw-inset-shadow-color:initial;--tw-inset-shadow-alpha:100%;--tw-ring-color:initial;--tw-ring-shadow:0 0 #0000;--tw-inset-ring-color:initial;--tw-inset-ring-shadow:0 0 #0000;--tw-ring-inset:initial;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-offset-shadow:0 0 #0000;--tw-outline-style:solid;--tw-blur:initial;--tw-brightness:initial;--tw-contrast:initial;--tw-grayscale:initial;--tw-hue-rotate:initial;--tw-invert:initial;--tw-opacity:initial;--tw-saturate:initial;--tw-sepia:initial;--tw-drop-shadow:initial;--tw-drop-shadow-color:initial;--tw-drop-shadow-alpha:100%;--tw-drop-shadow-size:initial;--tw-backdrop-blur:initial;--tw-backdrop-brightness:initial;--tw-backdrop-contrast:initial;--tw-backdrop-grayscale:initial;--tw-backdrop-hue-rotate:initial;--tw-backdrop-invert:initial;--tw-backdrop-opacity:initial;--tw-backdrop-saturate:initial;--tw-backdrop-sepia:initial;--tw-duration:initial}}}@layer theme{:root,:host{--font-sans:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";--font-mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;--color-red-50:oklch(97.1% .013 17.38);--color-red-100:oklch(93.6% .032 17.717);--color-red-200:oklch(88.5% .062 18.334);--color-red-300:oklch(80.8% .114 19.571);--color-red-400:oklch(70.4% .191 22.216);--color-red-500:oklch(63.7% .237 25.331);--color-red-600:oklch(57.7% .245 27.325);--color-red-700:oklch(50.5% .213 27.518);--color-red-800:oklch(44.4% .177 26.899);--color-orange-600:oklch(64.6% .222 41.116);--color-amber-50:oklch(98.7% .022 95.277);--color-amber-100:oklch(96.2% .059 95.617);--color-yellow-50:oklch(98.7% .026 102.212);--color-yellow-100:oklch(97.3% .071 103.193);--color-yellow-200:oklch(94.5% .129 101.54);--color-yellow-300:oklch(90.5% .182 98.111);--color-yellow-400:oklch(85.2% .199 91.936);--color-yellow-500:oklch(79.5% .184 86.047);--color-yellow-600:oklch(68.1% .162 75.834);--color-yellow-700:oklch(55.4% .135 66.442);--color-yellow-800:oklch(47.6% .114 61.907);--color-green-50:oklch(98.2% .018 155.826);--color-green-100:oklch(96.2% .044 156.743);--color-green-200:oklch(92.5% .084 155.995);--color-green-400:oklch(79.2% .209 151.711);--color-green-500:oklch(72.3% .219 149.579);--color-green-600:oklch(62.7% .194 149.214);--color-green-700:oklch(52.7% .154 150.069);--color-green-800:oklch(44.8% .119 151.328);--color-green-900:oklch(39.3% .095 152.535);--color-teal-50:oklch(98.4% .014 180.72);--color-teal-100:oklch(95.3% .051 180.801);--color-cyan-400:oklch(78.9% .154 211.53);--color-cyan-600:oklch(60.9% .126 221.723);--color-cyan-700:oklch(52% .105 223.128);--color-cyan-900:oklch(39.8% .07 227.392);--color-blue-50:oklch(97% .014 254.604);--color-blue-100:oklch(93.2% .032 255.585);--color-blue-200:oklch(88.2% .059 254.128);--color-blue-300:oklch(80.9% .105 251.813);--color-blue-500:oklch(62.3% .214 259.815);--color-blue-600:oklch(54.6% .245 262.881);--color-blue-700:oklch(48.8% .243 264.376);--color-blue-800:oklch(42.4% .199 265.638);--color-indigo-100:oklch(93% .034 272.788);--color-indigo-700:oklch(45.7% .24 277.023);--color-purple-50:oklch(97.7% .014 308.299);--color-purple-100:oklch(94.6% .033 307.174);--color-purple-600:oklch(55.8% .288 302.321);--color-rose-50:oklch(96.9% .015 12.422);--color-rose-100:oklch(94.1% .03 12.58);--color-slate-50:oklch(98.4% .003 247.858);--color-slate-600:oklch(44.6% .043 257.281);--color-slate-700:oklch(37.2% .044 257.287);--color-slate-800:oklch(27.9% .041 260.031);--color-slate-900:oklch(20.8% .042 265.755);--color-slate-950:oklch(12.9% .042 264.695);--color-gray-50:oklch(98.5% .002 247.839);--color-gray-100:oklch(96.7% .003 264.542);--color-gray-200:oklch(92.8% .006 264.531);--color-gray-300:oklch(87.2% .01 258.338);--color-gray-400:oklch(70.7% .022 261.325);--color-gray-500:oklch(55.1% .027 264.364);--color-gray-600:oklch(44.6% .03 256.802);--color-gray-700:oklch(37.3% .034 259.733);--color-gray-800:oklch(27.8% .033 256.848);--color-gray-900:oklch(21% .034 264.665);--color-black:#000;--color-white:#fff;--spacing:.25rem;--container-sm:24rem;--container-md:28rem;--container-xl:36rem;--container-2xl:42rem;--container-4xl:56rem;--container-6xl:72rem;--container-7xl:80rem;--text-xs:.75rem;--text-xs--line-height:calc(1 / .75);--text-sm:.875rem;--text-sm--line-height:calc(1.25 / .875);--text-base:1rem;--text-base--line-height:calc(1.5 / 1);--text-lg:1.125rem;--text-lg--line-height:calc(1.75 / 1.125);--text-xl:1.25rem;--text-xl--line-height:calc(1.75 / 1.25);--text-2xl:1.5rem;--text-2xl--line-height:calc(2 / 1.5);--text-3xl:1.875rem;--text-3xl--line-height:calc(2.25 / 1.875);--text-4xl:2.25rem;--text-4xl--line-height:calc(2.5 / 2.25);--font-weight-medium:500;--font-weight-semibold:600;--font-weight-bold:700;--font-weight-extrabold:800;--tracking-wide:.025em;--tracking-wider:.05em;--tracking-widest:.1em;--leading-tight:1.25;--leading-snug:1.375;--leading-relaxed:1.625;--radius-md:.375rem;--radius-lg:.5rem;--radius-xl:.75rem;--radius-2xl:1rem;--animate-pulse:pulse 2s cubic-bezier(.4, 0, .6, 1) infinite;--animate-bounce:bounce 1s infinite;--blur-sm:8px;--default-transition-duration:.15s;--default-transition-timing-function:cubic-bezier(.4, 0, .2, 1);--default-font-family:var(--font-sans);--default-mono-font-family:var(--font-mono)}}@layer base{*,:after,:before,::backdrop{box-sizing:border-box;border:0 solid;margin:0;padding:0}::file-selector-button{box-sizing:border-box;border:0 solid;margin:0;padding:0}html,:host{-webkit-text-size-adjust:100%;tab-size:4;line-height:1.5;font-family:var(--default-font-family,ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji");font-feature-settings:var(--default-font-feature-settings,normal);font-variation-settings:var(--default-font-variation-settings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:var(--default-mono-font-family,ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace);font-feature-settings:var(--default-mono-font-feature-settings,normal);font-variation-settings:var(--default-mono-font-variation-settings,normal);font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}:-moz-focusring{outline:auto}progress{vertical-align:baseline}summary{display:list-item}ol,ul,menu{list-style:none}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}button,input,select,optgroup,textarea{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}::file-selector-button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}:where(select:is([multiple],[size])) optgroup{font-weight:bolder}:where(select:is([multiple],[size])) optgroup option{padding-inline-start:20px}::file-selector-button{margin-inline-end:4px}::placeholder{opacity:1}@supports (not ((-webkit-appearance:-apple-pay-button))) or (contain-intrinsic-size:1px){::placeholder{color:currentColor}@supports (color:color-mix(in lab, red, red)){::placeholder{color:color-mix(in oklab, currentcolor 50%, transparent)}}}textarea{resize:vertical}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-date-and-time-value{min-height:1lh;text-align:inherit}::-webkit-datetime-edit{display:inline-flex}::-webkit-datetime-edit-fields-wrapper{padding:0}::-webkit-datetime-edit{padding-block:0}::-webkit-datetime-edit-year-field{padding-block:0}::-webkit-datetime-edit-month-field{padding-block:0}::-webkit-datetime-edit-day-field{padding-block:0}::-webkit-datetime-edit-hour-field{padding-block:0}::-webkit-datetime-edit-minute-field{padding-block:0}::-webkit-datetime-edit-second-field{padding-block:0}::-webkit-datetime-edit-millisecond-field{padding-block:0}::-webkit-datetime-edit-meridiem-field{padding-block:0}::-webkit-calendar-picker-indicator{line-height:1}:-moz-ui-invalid{box-shadow:none}button,input:where([type=button],[type=reset],[type=submit]){appearance:button}::file-selector-button{appearance:button}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[hidden]:where(:not([hidden=until-found])){display:none!important}}@layer components;@layer utilities{.pointer-events-none{pointer-events:none}.collapse{visibility:collapse}.visible{visibility:visible}.sr-only{clip-path:inset(50%);white-space:nowrap;border-width:0;width:1px;height:1px;margin:-1px;padding:0;position:absolute;overflow:hidden}.absolute{position:absolute}.fixed{position:fixed}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:calc(var(--spacing) * 0)}.start{inset-inline-start:var(--spacing)}.end{inset-inline-end:var(--spacing)}.top-0{top:calc(var(--spacing) * 0)}.top-1{top:calc(var(--spacing) * 1)}.top-1\/2{top:50%}.top-2\.5{top:calc(var(--spacing) * 2.5)}.top-4{top:calc(var(--spacing) * 4)}.top-8{top:calc(var(--spacing) * 8)}.right-0{right:calc(var(--spacing) * 0)}.right-3{right:calc(var(--spacing) * 3)}.right-4{right:calc(var(--spacing) * 4)}.right-5{right:calc(var(--spacing) * 5)}.bottom-5{bottom:calc(var(--spacing) * 5)}.bottom-24{bottom:calc(var(--spacing) * 24)}.left-1{left:calc(var(--spacing) * 1)}.left-3{left:calc(var(--spacing) * 3)}.z-0{z-index:0}.z-10{z-index:10}.z-20{z-index:20}.z-40{z-index:40}.z-50{z-index:50}.z-\[9999\]{z-index:9999}.col-span-12{grid-column:span 12/span 12}.col-start-1{grid-column-start:1}.col-start-6{grid-column-start:6}.col-end-8{grid-column-end:8}.col-end-13{grid-column-end:13}.container{width:100%}@media (min-width:40rem){.container{max-width:40rem}}@media (min-width:48rem){.container{max-width:48rem}}@media (min-width:64rem){.container{max-width:64rem}}@media (min-width:80rem){.container{max-width:80rem}}@media (min-width:96rem){.container{max-width:96rem}}.-mx-2{margin-inline:calc(var(--spacing) * -2)}.mx-4{margin-inline:calc(var(--spacing) * 4)}.mx-auto{margin-inline:auto}.my-4{margin-block:calc(var(--spacing) * 4)}.my-6{margin-block:calc(var(--spacing) * 6)}.-mt-1{margin-top:calc(var(--spacing) * -1)}.-mt-px{margin-top:-1px}.mt-0{margin-top:calc(var(--spacing) * 0)}.mt-0\.5{margin-top:calc(var(--spacing) * .5)}.mt-1{margin-top:calc(var(--spacing) * 1)}.mt-2{margin-top:calc(var(--spacing) * 2)}.mt-3{margin-top:calc(var(--spacing) * 3)}.mt-4{margin-top:calc(var(--spacing) * 4)}.mt-5{margin-top:calc(var(--spacing) * 5)}.mt-6{margin-top:calc(var(--spacing) * 6)}.mt-8{margin-top:calc(var(--spacing) * 8)}.mt-\[0\.2375rem\]{margin-top:.2375rem}.mr-2{margin-right:calc(var(--spacing) * 2)}.mr-3{margin-right:calc(var(--spacing) * 3)}.mb-1{margin-bottom:calc(var(--spacing) * 1)}.mb-2{margin-bottom:calc(var(--spacing) * 2)}.mb-3{margin-bottom:calc(var(--spacing) * 3)}.mb-4{margin-bottom:calc(var(--spacing) * 4)}.mb-5{margin-bottom:calc(var(--spacing) * 5)}.mb-6{margin-bottom:calc(var(--spacing) * 6)}.mb-8{margin-bottom:calc(var(--spacing) * 8)}.mb-10{margin-bottom:calc(var(--spacing) * 10)}.ml-2{margin-left:calc(var(--spacing) * 2)}.ml-3{margin-left:calc(var(--spacing) * 3)}.ml-4{margin-left:calc(var(--spacing) * 4)}.block{display:block}.contents{display:contents}.flex{display:flex}.grid{display:grid}.hidden{display:none}.inline{display:inline}.inline-block{display:inline-block}.inline-flex{display:inline-flex}.table{display:table}.h-2{height:calc(var(--spacing) * 2)}.h-2\.5{height:calc(var(--spacing) * 2.5)}.h-4{height:calc(var(--spacing) * 4)}.h-5{height:calc(var(--spacing) * 5)}.h-6{height:calc(var(--spacing) * 6)}.h-8{height:calc(var(--spacing) * 8)}.h-9{height:calc(var(--spacing) * 9)}.h-10{height:calc(var(--spacing) * 10)}.h-12{height:calc(var(--spacing) * 12)}.h-14{height:calc(var(--spacing) * 14)}.h-16{height:calc(var(--spacing) * 16)}.h-20{height:calc(var(--spacing) * 20)}.h-24{height:calc(var(--spacing) * 24)}.h-48{height:calc(var(--spacing) * 48)}.h-64{height:calc(var(--spacing) * 64)}.h-\[24\.7px\]{height:24.7px}.h-full{height:100%}.h-screen{height:100vh}.max-h-\[90vh\]{max-height:90vh}.max-h-\[1200px\]{max-height:1200px}.min-h-0{min-height:calc(var(--spacing) * 0)}.min-h-\[900px\]{min-height:900px}.min-h-screen{min-height:100vh}.w-1\/2{width:50%}.w-1\/3{width:33.3333%}.w-2{width:calc(var(--spacing) * 2)}.w-2\.5{width:calc(var(--spacing) * 2.5)}.w-2\/3{width:66.6667%}.w-4{width:calc(var(--spacing) * 4)}.w-5{width:calc(var(--spacing) * 5)}.w-6{width:calc(var(--spacing) * 6)}.w-8{width:calc(var(--spacing) * 8)}.w-9{width:calc(var(--spacing) * 9)}.w-10{width:calc(var(--spacing) * 10)}.w-12{width:calc(var(--spacing) * 12)}.w-14{width:calc(var(--spacing) * 14)}.w-16{width:calc(var(--spacing) * 16)}.w-24{width:calc(var(--spacing) * 24)}.w-64{width:calc(var(--spacing) * 64)}.w-72{width:calc(var(--spacing) * 72)}.w-80{width:calc(var(--spacing) * 80)}.w-\[380px\]{width:380px}.w-auto{width:auto}.w-fit{width:fit-content}.w-full{width:100%}.w-px{width:1px}.w-screen{width:100vw}.max-w-2xl{max-width:var(--container-2xl)}.max-w-4xl{max-width:var(--container-4xl)}.max-w-6xl{max-width:var(--container-6xl)}.max-w-7xl{max-width:var(--container-7xl)}.max-w-\[1700px\]{max-width:1700px}.max-w-md{max-width:var(--container-md)}.max-w-sm{max-width:var(--container-sm)}.max-w-xl{max-width:var(--container-xl)}.min-w-0{min-width:calc(var(--spacing) * 0)}.min-w-\[110px\]{min-width:110px}.min-w-\[120px\]{min-width:120px}.min-w-full{min-width:100%}.flex-1{flex:1}.flex-\[2\]{flex:2}.flex-auto{flex:auto}.flex-shrink{flex-shrink:1}.flex-shrink-0{flex-shrink:0}.shrink{flex-shrink:1}.shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.border-collapse{border-collapse:collapse}.-translate-y-1\/2{--tw-translate-y:calc(calc(1 / 2 * 100%) * -1);translate:var(--tw-translate-x) var(--tw-translate-y)}.translate-y-20{--tw-translate-y:calc(var(--spacing) * 20);translate:var(--tw-translate-x) var(--tw-translate-y)}.rotate-45{rotate:45deg}.transform{transform:var(--tw-rotate-x,) var(--tw-rotate-y,) var(--tw-rotate-z,) var(--tw-skew-x,) var(--tw-skew-y,)}.animate-bounce{animation:var(--animate-bounce)}.animate-pulse{animation:var(--animate-pulse)}.cursor-not-allowed{cursor:not-allowed}.cursor-pointer{cursor:pointer}.cursor-wait{cursor:wait}.resize-none{resize:none}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-row{flex-direction:row}.flex-row-reverse{flex-direction:row-reverse}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.items-end{align-items:flex-end}.items-start{align-items:flex-start}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.justify-end{justify-content:flex-end}.justify-start{justify-content:flex-start}.gap-0{gap:calc(var(--spacing) * 0)}.gap-1{gap:calc(var(--spacing) * 1)}.gap-2{gap:calc(var(--spacing) * 2)}.gap-3{gap:calc(var(--spacing) * 3)}.gap-4{gap:calc(var(--spacing) * 4)}.gap-5{gap:calc(var(--spacing) * 5)}.gap-6{gap:calc(var(--spacing) * 6)}.gap-8{gap:calc(var(--spacing) * 8)}:where(.space-y-1>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 1) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 1) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-2>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 2) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-3>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 3) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-4>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 4) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-6>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 6) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 6) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-8>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 8) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 8) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-x-1\.5>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 1.5) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 1.5) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-2>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 2) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-3>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 3) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-4>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 4) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-x-reverse)))}.gap-y-2{row-gap:calc(var(--spacing) * 2)}:where(.divide-y>:not(:last-child)){--tw-divide-y-reverse:0;border-bottom-style:var(--tw-border-style);border-top-style:var(--tw-border-style);border-top-width:calc(1px * var(--tw-divide-y-reverse));border-bottom-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)))}:where(.divide-gray-200>:not(:last-child)){border-color:var(--color-gray-200)}.self-center{align-self:center}.self-start{align-self:flex-start}.truncate{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.overflow-auto{overflow:auto}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-x-hidden{overflow-x:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:.25rem}.rounded-2xl{border-radius:var(--radius-2xl)}.rounded-full{border-radius:3.40282e38px}.rounded-lg{border-radius:var(--radius-lg)}.rounded-md{border-radius:var(--radius-md)}.rounded-xl{border-radius:var(--radius-xl)}.rounded-t-xl{border-top-left-radius:var(--radius-xl);border-top-right-radius:var(--radius-xl)}.border{border-style:var(--tw-border-style);border-width:1px}.border-2{border-style:var(--tw-border-style);border-width:2px}.border-t{border-top-style:var(--tw-border-style);border-top-width:1px}.border-t-2{border-top-style:var(--tw-border-style);border-top-width:2px}.border-r{border-right-style:var(--tw-border-style);border-right-width:1px}.border-b{border-bottom-style:var(--tw-border-style);border-bottom-width:1px}.border-b-2{border-bottom-style:var(--tw-border-style);border-bottom-width:2px}.border-l-4{border-left-style:var(--tw-border-style);border-left-width:4px}.border-dashed{--tw-border-style:dashed;border-style:dashed}.border-none{--tw-border-style:none;border-style:none}.border-\[\#001f3f\]{border-color:#001f3f}.border-\[var\(--racing\)\]{border-color:var(--racing)}.border-\[var\(--racing-line\)\]{border-color:var(--racing-line)}.border-\[var\(--racing-line\,\#cfe6dc\)\]{border-color:var(--racing-line,#cfe6dc)}.border-blue-600{border-color:var(--color-blue-600)}.border-cyan-900{border-color:var(--color-cyan-900)}.border-gray-100{border-color:var(--color-gray-100)}.border-gray-200{border-color:var(--color-gray-200)}.border-gray-300{border-color:var(--color-gray-300)}.border-gray-400{border-color:var(--color-gray-400)}.border-green-200{border-color:var(--color-green-200)}.border-green-400{border-color:var(--color-green-400)}.border-red-200{border-color:var(--color-red-200)}.border-slate-700{border-color:var(--color-slate-700)}.border-white{border-color:var(--color-white)}.border-white\/20{border-color:#fff3}@supports (color:color-mix(in lab, red, red)){.border-white\/20{border-color:color-mix(in oklab, var(--color-white) 20%, transparent)}}.border-white\/30{border-color:#ffffff4d}@supports (color:color-mix(in lab, red, red)){.border-white\/30{border-color:color-mix(in oklab, var(--color-white) 30%, transparent)}}.border-yellow-300{border-color:var(--color-yellow-300)}.border-t-blue-600{border-top-color:var(--color-blue-600)}.border-t-green-600{border-top-color:var(--color-green-600)}.bg-\[\#001f3f\]{background-color:#001f3f}.bg-\[\#004225\]{background-color:#004225}.bg-\[var\(--gold-orange\)\]{background-color:var(--gold-orange)}.bg-\[var\(--pale-green\)\]{background-color:var(--pale-green)}.bg-\[var\(--racing\)\]{background-color:var(--racing)}.bg-\[var\(--racing-mint\)\]{background-color:var(--racing-mint)}.bg-amber-50{background-color:var(--color-amber-50)}.bg-black{background-color:var(--color-black)}.bg-black\/40{background-color:#0006}@supports (color:color-mix(in lab, red, red)){.bg-black\/40{background-color:color-mix(in oklab, var(--color-black) 40%, transparent)}}.bg-black\/60{background-color:#0009}@supports (color:color-mix(in lab, red, red)){.bg-black\/60{background-color:color-mix(in oklab, var(--color-black) 60%, transparent)}}.bg-blue-50{background-color:var(--color-blue-50)}.bg-blue-100{background-color:var(--color-blue-100)}.bg-blue-500{background-color:var(--color-blue-500)}.bg-blue-600{background-color:var(--color-blue-600)}.bg-cyan-700{background-color:var(--color-cyan-700)}.bg-gray-50{background-color:var(--color-gray-50)}.bg-gray-100{background-color:var(--color-gray-100)}.bg-gray-200{background-color:var(--color-gray-200)}.bg-gray-300{background-color:var(--color-gray-300)}.bg-gray-700{background-color:var(--color-gray-700)}.bg-gray-800\/50{background-color:#1e293980}@supports (color:color-mix(in lab, red, red)){.bg-gray-800\/50{background-color:color-mix(in oklab, var(--color-gray-800) 50%, transparent)}}.bg-green-50{background-color:var(--color-green-50)}.bg-green-100{background-color:var(--color-green-100)}.bg-green-400{background-color:var(--color-green-400)}.bg-green-500{background-color:var(--color-green-500)}.bg-green-600{background-color:var(--color-green-600)}.bg-green-700{background-color:var(--color-green-700)}.bg-indigo-100{background-color:var(--color-indigo-100)}.bg-purple-50{background-color:var(--color-purple-50)}.bg-purple-600{background-color:var(--color-purple-600)}.bg-red-50{background-color:var(--color-red-50)}.bg-red-100{background-color:var(--color-red-100)}.bg-red-500{background-color:var(--color-red-500)}.bg-red-600{background-color:var(--color-red-600)}.bg-rose-50{background-color:var(--color-rose-50)}.bg-slate-600{background-color:var(--color-slate-600)}.bg-slate-700{background-color:var(--color-slate-700)}.bg-slate-800{background-color:var(--color-slate-800)}.bg-slate-900{background-color:var(--color-slate-900)}.bg-slate-950\/50{background-color:#02061880}@supports (color:color-mix(in lab, red, red)){.bg-slate-950\/50{background-color:color-mix(in oklab, var(--color-slate-950) 50%, transparent)}}.bg-teal-50{background-color:var(--color-teal-50)}.bg-white{background-color:var(--color-white)}.bg-white\/10{background-color:#ffffff1a}@supports (color:color-mix(in lab, red, red)){.bg-white\/10{background-color:color-mix(in oklab, var(--color-white) 10%, transparent)}}.bg-white\/15{background-color:#ffffff26}@supports (color:color-mix(in lab, red, red)){.bg-white\/15{background-color:color-mix(in oklab, var(--color-white) 15%, transparent)}}.bg-white\/60{background-color:#fff9}@supports (color:color-mix(in lab, red, red)){.bg-white\/60{background-color:color-mix(in oklab, var(--color-white) 60%, transparent)}}.bg-white\/70{background-color:#ffffffb3}@supports (color:color-mix(in lab, red, red)){.bg-white\/70{background-color:color-mix(in oklab, var(--color-white) 70%, transparent)}}.bg-white\/80{background-color:#fffc}@supports (color:color-mix(in lab, red, red)){.bg-white\/80{background-color:color-mix(in oklab, var(--color-white) 80%, transparent)}}.bg-yellow-50{background-color:var(--color-yellow-50)}.bg-yellow-100{background-color:var(--color-yellow-100)}.bg-yellow-400{background-color:var(--color-yellow-400)}.bg-yellow-500{background-color:var(--color-yellow-500)}.bg-\[url\(\'https\:\/\/www\.transparenttextures\.com\/patterns\/cubes\.png\'\)\]{background-image:url(https://www.transparenttextures.com/patterns/cubes.png)}.bg-contain{background-size:contain}.bg-center{background-position:50%}.bg-no-repeat{background-repeat:no-repeat}.object-contain{object-fit:contain}.object-cover{object-fit:cover}.p-0{padding:calc(var(--spacing) * 0)}.p-2{padding:calc(var(--spacing) * 2)}.p-3{padding:calc(var(--spacing) * 3)}.p-4{padding:calc(var(--spacing) * 4)}.p-5{padding:calc(var(--spacing) * 5)}.p-6{padding:calc(var(--spacing) * 6)}.p-8{padding:calc(var(--spacing) * 8)}.px-1{padding-inline:calc(var(--spacing) * 1)}.px-2{padding-inline:calc(var(--spacing) * 2)}.px-3{padding-inline:calc(var(--spacing) * 3)}.px-4{padding-inline:calc(var(--spacing) * 4)}.px-5{padding-inline:calc(var(--spacing) * 5)}.px-6{padding-inline:calc(var(--spacing) * 6)}.py-0\.5{padding-block:calc(var(--spacing) * .5)}.py-1{padding-block:calc(var(--spacing) * 1)}.py-1\.5{padding-block:calc(var(--spacing) * 1.5)}.py-2{padding-block:calc(var(--spacing) * 2)}.py-2\.5{padding-block:calc(var(--spacing) * 2.5)}.py-3{padding-block:calc(var(--spacing) * 3)}.py-4{padding-block:calc(var(--spacing) * 4)}.py-5{padding-block:calc(var(--spacing) * 5)}.py-6{padding-block:calc(var(--spacing) * 6)}.py-8{padding-block:calc(var(--spacing) * 8)}.py-\[0\.2375rem\]{padding-block:.2375rem}.pt-1{padding-top:calc(var(--spacing) * 1)}.pt-2{padding-top:calc(var(--spacing) * 2)}.pt-3{padding-top:calc(var(--spacing) * 3)}.pt-4{padding-top:calc(var(--spacing) * 4)}.pt-10{padding-top:calc(var(--spacing) * 10)}.pr-2{padding-right:calc(var(--spacing) * 2)}.pr-4{padding-right:calc(var(--spacing) * 4)}.pr-12{padding-right:calc(var(--spacing) * 12)}.pr-28{padding-right:calc(var(--spacing) * 28)}.pb-2{padding-bottom:calc(var(--spacing) * 2)}.pb-3{padding-bottom:calc(var(--spacing) * 3)}.pb-4{padding-bottom:calc(var(--spacing) * 4)}.pl-4{padding-left:calc(var(--spacing) * 4)}.pl-5{padding-left:calc(var(--spacing) * 5)}.pl-6{padding-left:calc(var(--spacing) * 6)}.pl-10{padding-left:calc(var(--spacing) * 10)}.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}.font-mono{font-family:var(--font-mono)}.text-2xl{font-size:var(--text-2xl);line-height:var(--tw-leading,var(--text-2xl--line-height))}.text-3xl{font-size:var(--text-3xl);line-height:var(--tw-leading,var(--text-3xl--line-height))}.text-4xl{font-size:var(--text-4xl);line-height:var(--tw-leading,var(--text-4xl--line-height))}.text-base{font-size:var(--text-base);line-height:var(--tw-leading,var(--text-base--line-height))}.text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}.text-sm{font-size:var(--text-sm);line-height:var(--tw-leading,var(--text-sm--line-height))}.text-xl{font-size:var(--text-xl);line-height:var(--tw-leading,var(--text-xl--line-height))}.text-xs{font-size:var(--text-xs);line-height:var(--tw-leading,var(--text-xs--line-height))}.text-\[0\.6rem\]{font-size:.6rem}.text-\[0\.8rem\]{font-size:.8rem}.text-\[0\.65rem\]{font-size:.65rem}.text-\[0\.85rem\]{font-size:.85rem}.text-\[10px\]{font-size:10px}.text-\[11px\]{font-size:11px}.text-\[12px\]{font-size:12px}.text-\[13px\]{font-size:13px}.leading-relaxed{--tw-leading:var(--leading-relaxed);line-height:var(--leading-relaxed)}.leading-snug{--tw-leading:var(--leading-snug);line-height:var(--leading-snug)}.leading-tight{--tw-leading:var(--leading-tight);line-height:var(--leading-tight)}.font-bold{--tw-font-weight:var(--font-weight-bold);font-weight:var(--font-weight-bold)}.font-extrabold{--tw-font-weight:var(--font-weight-extrabold);font-weight:var(--font-weight-extrabold)}.font-medium{--tw-font-weight:var(--font-weight-medium);font-weight:var(--font-weight-medium)}.font-semibold{--tw-font-weight:var(--font-weight-semibold);font-weight:var(--font-weight-semibold)}.tracking-wide{--tw-tracking:var(--tracking-wide);letter-spacing:var(--tracking-wide)}.tracking-wider{--tw-tracking:var(--tracking-wider);letter-spacing:var(--tracking-wider)}.tracking-widest{--tw-tracking:var(--tracking-widest);letter-spacing:var(--tracking-widest)}.break-words{overflow-wrap:break-word}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.text-\[\#001f3f\]{color:#001f3f}.text-\[\#004225\]{color:#004225}.text-\[var\(--racing-ink\)\]{color:var(--racing-ink)}.text-blue-500{color:var(--color-blue-500)}.text-blue-600{color:var(--color-blue-600)}.text-blue-700{color:var(--color-blue-700)}.text-blue-800{color:var(--color-blue-800)}.text-cyan-400{color:var(--color-cyan-400)}.text-gray-400{color:var(--color-gray-400)}.text-gray-500{color:var(--color-gray-500)}.text-gray-600{color:var(--color-gray-600)}.text-gray-700{color:var(--color-gray-700)}.text-gray-800{color:var(--color-gray-800)}.text-gray-900{color:var(--color-gray-900)}.text-green-400{color:var(--color-green-400)}.text-green-600{color:var(--color-green-600)}.text-green-700{color:var(--color-green-700)}.text-green-800{color:var(--color-green-800)}.text-green-900{color:var(--color-green-900)}.text-indigo-700{color:var(--color-indigo-700)}.text-orange-600{color:var(--color-orange-600)}.text-red-300{color:var(--color-red-300)}.text-red-400{color:var(--color-red-400)}.text-red-500{color:var(--color-red-500)}.text-red-600{color:var(--color-red-600)}.text-red-700{color:var(--color-red-700)}.text-red-800{color:var(--color-red-800)}.text-slate-700{color:var(--color-slate-700)}.text-white{color:var(--color-white)}.text-white\/80{color:#fffc}@supports (color:color-mix(in lab, red, red)){.text-white\/80{color:color-mix(in oklab, var(--color-white) 80%, transparent)}}.text-yellow-300{color:var(--color-yellow-300)}.text-yellow-400{color:var(--color-yellow-400)}.text-yellow-600{color:var(--color-yellow-600)}.text-yellow-700{color:var(--color-yellow-700)}.text-yellow-800{color:var(--color-yellow-800)}.uppercase{text-transform:uppercase}.underline{text-decoration-line:underline}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.placeholder-gray-400::placeholder{color:var(--color-gray-400)}.opacity-0{opacity:0}.opacity-10{opacity:.1}.opacity-40{opacity:.4}.opacity-50{opacity:.5}.opacity-60{opacity:.6}.opacity-70{opacity:.7}.opacity-75{opacity:.75}.opacity-80{opacity:.8}.opacity-90{opacity:.9}.shadow{--tw-shadow:0 1px 3px 0 var(--tw-shadow-color,#0000001a), 0 1px 2px -1px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px var(--tw-shadow-color,#00000040);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-\[0_0_8px_rgba\(34\,197\,94\,0\.6\)\]{--tw-shadow:0 0 8px var(--tw-shadow-color,#22c55e99);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 var(--tw-shadow-color,#0000000d);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px var(--tw-shadow-color,#0000001a), 0 4px 6px -4px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px var(--tw-shadow-color,#0000001a), 0 2px 4px -2px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 3px 0 var(--tw-shadow-color,#0000001a), 0 1px 2px -1px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px var(--tw-shadow-color,#0000001a), 0 8px 10px -6px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.ring-1{--tw-ring-shadow:var(--tw-ring-inset,) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color,currentcolor);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.ring-blue-300{--tw-ring-color:var(--color-blue-300)}.outline{outline-style:var(--tw-outline-style);outline-width:1px}.blur{--tw-blur:blur(8px);filter:var(--tw-blur,) var(--tw-brightness,) var(--tw-contrast,) var(--tw-grayscale,) var(--tw-hue-rotate,) var(--tw-invert,) var(--tw-saturate,) var(--tw-sepia,) var(--tw-drop-shadow,)}.filter{filter:var(--tw-blur,) var(--tw-brightness,) var(--tw-contrast,) var(--tw-grayscale,) var(--tw-hue-rotate,) var(--tw-invert,) var(--tw-saturate,) var(--tw-sepia,) var(--tw-drop-shadow,)}.backdrop-blur-\[1px\]{--tw-backdrop-blur:blur(1px);-webkit-backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,)}.backdrop-blur-sm{--tw-backdrop-blur:blur(var(--blur-sm));-webkit-backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter,display,content-visibility,overlay,pointer-events;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-all{transition-property:all;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-colors{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-opacity{transition-property:opacity;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-transform{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.duration-300{--tw-duration:.3s;transition-duration:.3s}.duration-500{--tw-duration:.5s;transition-duration:.5s}.outline-none{--tw-outline-style:none;outline-style:none}@media (hover:hover){.group-hover\:bg-green-100:is(:where(.group):hover *){background-color:var(--color-green-100)}.group-hover\:bg-yellow-200:is(:where(.group):hover *){background-color:var(--color-yellow-200)}.group-hover\:text-blue-700:is(:where(.group):hover *){color:var(--color-blue-700)}.group-hover\:text-green-800:is(:where(.group):hover *){color:var(--color-green-800)}.group-hover\:opacity-100:is(:where(.group):hover *){opacity:1}}.peer-checked\:translate-x-full:is(:where(.peer):checked~*){--tw-translate-x:100%;translate:var(--tw-translate-x) var(--tw-translate-y)}@media (hover:hover){.hover\:border-blue-200:hover{border-color:var(--color-blue-200)}.hover\:bg-\[\#00331e\]:hover{background-color:#00331e}.hover\:bg-amber-100:hover{background-color:var(--color-amber-100)}.hover\:bg-blue-50:hover{background-color:var(--color-blue-50)}.hover\:bg-blue-100:hover{background-color:var(--color-blue-100)}.hover\:bg-blue-700:hover{background-color:var(--color-blue-700)}.hover\:bg-cyan-600:hover{background-color:var(--color-cyan-600)}.hover\:bg-gray-50:hover{background-color:var(--color-gray-50)}.hover\:bg-gray-100:hover{background-color:var(--color-gray-100)}.hover\:bg-gray-300:hover{background-color:var(--color-gray-300)}.hover\:bg-gray-700:hover{background-color:var(--color-gray-700)}.hover\:bg-green-50:hover{background-color:var(--color-green-50)}.hover\:bg-green-600:hover{background-color:var(--color-green-600)}.hover\:bg-green-700:hover{background-color:var(--color-green-700)}.hover\:bg-green-800:hover{background-color:var(--color-green-800)}.hover\:bg-purple-100:hover{background-color:var(--color-purple-100)}.hover\:bg-red-700:hover{background-color:var(--color-red-700)}.hover\:bg-rose-100:hover{background-color:var(--color-rose-100)}.hover\:bg-slate-50:hover{background-color:var(--color-slate-50)}.hover\:bg-slate-600:hover{background-color:var(--color-slate-600)}.hover\:bg-teal-100:hover{background-color:var(--color-teal-100)}.hover\:pl-4:hover{padding-left:calc(var(--spacing) * 4)}.hover\:text-gray-600:hover{color:var(--color-gray-600)}.hover\:text-green-800:hover{color:var(--color-green-800)}.hover\:text-red-700:hover{color:var(--color-red-700)}.hover\:underline:hover{text-decoration-line:underline}.hover\:opacity-90:hover{opacity:.9}}.focus\:border-\[var\(--gold-orange\)\]:focus{border-color:var(--gold-orange)}.focus\:border-green-400:focus{border-color:var(--color-green-400)}.focus\:border-green-500:focus{border-color:var(--color-green-500)}.focus\:border-transparent:focus{border-color:#0000}.focus\:ring-2:focus{--tw-ring-shadow:var(--tw-ring-inset,) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color,currentcolor);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.focus\:ring-\[var\(--gold-orange\)\]:focus{--tw-ring-color:var(--gold-orange)}.focus\:ring-green-500:focus{--tw-ring-color:var(--color-green-500)}.focus\:ring-green-800:focus{--tw-ring-color:var(--color-green-800)}.focus\:ring-red-500:focus{--tw-ring-color:var(--color-red-500)}.focus\:ring-offset-2:focus{--tw-ring-offset-width:2px;--tw-ring-offset-shadow:var(--tw-ring-inset,) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color)}.focus\:outline-none:focus{--tw-outline-style:none;outline-style:none}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:bg-gray-500:disabled{background-color:var(--color-gray-500)}@media (min-width:40rem){.sm\:col-span-1{grid-column:span 1/span 1}.sm\:col-span-2{grid-column:span 2/span 2}.sm\:mb-0{margin-bottom:calc(var(--spacing) * 0)}.sm\:flex{display:flex}.sm\:w-1\/2{width:50%}.sm\:w-80{width:calc(var(--spacing) * 80)}.sm\:w-auto{width:auto}.sm\:min-w-0{min-width:calc(var(--spacing) * 0)}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:flex-row{flex-direction:row}.sm\:flex-nowrap{flex-wrap:nowrap}.sm\:items-center{align-items:center}:where(.sm\:space-x-2>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 2) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-x-reverse)))}.sm\:p-6{padding:calc(var(--spacing) * 6)}.sm\:text-4xl{font-size:var(--text-4xl);line-height:var(--tw-leading,var(--text-4xl--line-height))}}@media (min-width:48rem){.md\:col-span-2{grid-column:span 2/span 2}.md\:flex{display:flex}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.md\:p-0{padding:calc(var(--spacing) * 0)}.md\:p-8{padding:calc(var(--spacing) * 8)}.md\:px-8{padding-inline:calc(var(--spacing) * 8)}.md\:text-3xl{font-size:var(--text-3xl);line-height:var(--tw-leading,var(--text-3xl--line-height))}.md\:text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}}@media (min-width:64rem){.lg\:col-span-5{grid-column:span 5/span 5}.lg\:col-span-7{grid-column:span 7/span 7}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.lg\:p-8{padding:calc(var(--spacing) * 8)}}@media (min-width:80rem){.xl\:col-span-5{grid-column:span 5/span 5}.xl\:col-span-7{grid-column:span 7/span 7}}}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}@property --tw-rotate-x{syntax:"*";inherits:false}@property --tw-rotate-y{syntax:"*";inherits:false}@property --tw-rotate-z{syntax:"*";inherits:false}@property --tw-skew-x{syntax:"*";inherits:false}@property --tw-skew-y{syntax:"*";inherits:false}@property --tw-space-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-space-x-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-divide-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-leading{syntax:"*";inherits:false}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-tracking{syntax:"*";inherits:false}@property --tw-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-shadow-color{syntax:"*";inherits:false}@property --tw-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-inset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-shadow-color{syntax:"*";inherits:false}@property --tw-inset-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-ring-color{syntax:"*";inherits:false}@property --tw-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-ring-color{syntax:"*";inherits:false}@property --tw-inset-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-ring-inset{syntax:"*";inherits:false}@property --tw-ring-offset-width{syntax:"<length>";inherits:false;initial-value:0}@property --tw-ring-offset-color{syntax:"*";inherits:false;initial-value:#fff}@property --tw-ring-offset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-outline-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-blur{syntax:"*";inherits:false}@property --tw-brightness{syntax:"*";inherits:false}@property --tw-contrast{syntax:"*";inherits:false}@property --tw-grayscale{syntax:"*";inherits:false}@property --tw-hue-rotate{syntax:"*";inherits:false}@property --tw-invert{syntax:"*";inherits:false}@property --tw-opacity{syntax:"*";inherits:false}@property --tw-saturate{syntax:"*";inherits:false}@property --tw-sepia{syntax:"*";inherits:false}@property --tw-drop-shadow{syntax:"*";inherits:false}@property --tw-drop-shadow-color{syntax:"*";inherits:false}@property --tw-drop-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-drop-shadow-size{syntax:"*";inherits:false}@property --tw-backdrop-blur{syntax:"*";inherits:false}@property --tw-backdrop-brightness{syntax:"*";inherits:false}@property --tw-backdrop-contrast{syntax:"*";inherits:false}@property --tw-backdrop-grayscale{syntax:"*";inherits:false}@property --tw-backdrop-hue-rotate{syntax:"*";inherits:false}@property --tw-backdrop-invert{syntax:"*";inherits:false}@property --tw-backdrop-opacity{syntax:"*";inherits:false}@property --tw-backdrop-saturate{syntax:"*";inherits:false}@property --tw-backdrop-sepia{syntax:"*";inherits:false}@property --tw-duration{syntax:"*";inherits:false}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}

/* Patch: missing custom utility from original UI */
.peer-checked\:bg-racing-green-600:is(:where(.peer):checked~*){background-color:#16a34a}
</style>
<style id="forms-lite">
/* forms-lite: soften default control chrome (replaces Tailwind forms plugin basics) */
input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="url"],
input[type="password"], input[type="search"], input[type="date"], input[type="time"],
select, textarea {
  border: 1px solid rgba(17, 24, 39, 0.18); /* soft slate */
  border-radius: 0.75rem; /* matches rounded-xl vibe */
  background-color: #fff;
  padding: 0.5rem 0.75rem;
  outline: none;
}
input:focus, select:focus, textarea:focus {
  border-color: rgba(34, 197, 94, 0.55); /* soft green */
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18);
}
input::placeholder, textarea::placeholder { color: rgba(107, 114, 128, 0.75); }
</style>
<style id="ui-polish-patches">
/* ---- UI polish patches (post-tailwind) ---- */

/* 1) Make all .input-field controls consistent outside #pse (fix dark outline on CURRENT APR etc.) */
.input-field{
  border: 1px solid rgba(17, 24, 39, 0.18) !important;
  border-radius: 0.75rem !important;
  outline: none !important;
}
.input-field:focus{
  outline: none !important;
  border-color: rgba(34, 197, 94, 0.55) !important;
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18) !important;
}

/* 2) Soften borders inside the Application modal (sections/boxes looking too dark) */
#customerModal .border,
#customerModal .border-2,
#customerModal .border-b,
#customerModal .border-t,
#customerModal .border-l,
#customerModal .border-r{
  border-color: rgba(17, 24, 39, 0.14) !important;
}

/* 3) Client Files: make document preview larger and reliably tall */
#client-files-view{
  min-height: 82vh;
}
#client-files-view .drive-layout,
#client-files-view .drive-pane,
#client-files-view .drive-preview,
#client-files-view .drive-preview-area{
  min-height: 70vh;
}
#drive-preview-frame{
  min-height: 70vh;
}
</style>



<script>
// ===== UI: Stage-change highlight =========================================
// Purpose: When a card's Stage dropdown changes, briefly outline the card green
// for key stages (Ready To Deal / Awaiting Payout / Completed).
// Note: Uses event delegation on document to cover dynamically-rendered cards.
// ============================================================================
(function(){
  const READY_STAGES = new Set(['Ready To Deal','Awaiting Payout','Completed']);
  document.addEventListener('change', (ev) => {
    const sel = ev.target && ev.target.closest && ev.target.closest('.deal-stage-select');
    if (!sel) return;
    const card = sel.closest('.kanban-card');
    if (!card) return;
    // Toggle border based on new stage
    const ready = READY_STAGES.has(sel.value);
    card.classList.toggle('deal-ready', ready);
}, true); // capture to run before any other listeners that might re-render
})();
// ===== end green border trigger =====
</script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
        :root { --british-racing-green: #004225; --pale-green: #F0FFF0; --pale-green-darker: #e6f5e6; --gold-orange: #FF8C00; }
        body { font-family: 'Poppins', sans-serif; overflow: hidden; }
        .sidebar { background-color: #1f2937; color: #f3f4f6; }
        .sidebar .crm-title { color: #ffffff; font-family: 'Poppins', sans-serif; }
        .tab-link { display: block; padding: 12px 16px; border-radius: 8px; color: #d1d5db; font-weight: 500; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .tab-link:hover { background-color: #374151; color: #ffffff; }
        .tab-link.active-tab { background-color: #004225; color: #ffffff; font-weight: 600; }
        .content-area { background-color: #f0f2f5; overflow-y: auto; height: 100vh; }
        .tab-content { display: none; height: 100%; width: 100%; }
        #pse { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; color: #333; }
        #pse .page-container { display: flex; flex-direction: column; gap: 25px; max-width: 1800px; margin: 0 auto; }
        #pse .grid-card { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.07); animation: fadeIn 0.5s forwards; display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #pse .section-header { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; border-bottom: 2px solid #D8E4C6; padding-bottom: 10px; }
        #pse .section-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; border: 2px solid #004225; object-fit: cover; }
        #pse h2 { color: #004225; text-align: center; margin: 0; font-size: 1.8em; border: none; padding: 0; }
        #pse h3 { color: #004225; margin-top: 0; }
        #pse #finance-form { display: flex; flex-direction: column; flex-grow: 1; }
        #pse .form-grid { display: grid; grid-template-columns: 1fr; gap: 0 20px; flex-grow: 1; }
        @media (min-width: 600px) { #pse .form-grid { grid-template-columns: 1fr 1fr; } }
        #pse .form-row-triplet { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; }
        #pse .form-row-split { grid-column: 1 / -1; display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; align-items: start; }
        #pse .form-group { margin-bottom: 20px; }
        #pse .form-group.highlight-bg { background-color: var(--pale-green); padding: 1rem; border-radius: 0.5rem; }
        #pse .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #004225; }
        #pse .form-group input, #pse .form-group select, #pse .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; transition: border-color 0.3s; }
        #pse .form-group input:disabled, #pse .form-group input:read-only { background-color: #e9ecef; cursor: not-allowed; color: #555; font-weight: bold; }
        #pse .form-group input.editable-calc { background-color: #e9ecef; cursor: text; }
        #pse .form-group input:focus, #pse .form-group select:focus, #pse .form-group textarea:focus { border-color: #004225; outline: none; }
        #pse .btn { display: inline-block; width: 100%; padding: 12px 25px; background-color: #004225; color: #fff; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: all 0.3s; margin-top: auto; text-decoration: none; box-sizing: border-box; }
        #pse .btn:hover { background-color: #00331e; transform: translateY(-2px); }
        #pse .vrn-lookup-group { display: flex; gap: 8px; }
        #pse .vrn-lookup-group input { flex-grow: 1; }
        #pse .vrn-lookup-group button { flex-shrink: 0; padding: 0 16px; background-color: #e5e7eb; color: #1f2937; border: 1px solid #d1d5db; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        #pse .spinner { animation: spin 1s linear infinite; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #004225; border-radius: 50%; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #pse #products-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #pse #products-table th, #pse #products-table td { border: 1px solid #D8E4C6; padding: 12px 15px; text-align: left; font-size: 0.9em; }
        #pse #products-table .balloon-input-cell { padding: 4px 8px; }
        #pse #products-table .balloon-input { width: 100%; max-width: 120px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        #pse #products-table th { background-color: #004225; color: white; font-weight: 600; white-space: nowrap; }
        #pse #products-table tbody tr { background-color: #F7F9F5; cursor: pointer; transition: all 0.3s; }
        #pse #products-table tbody tr:hover { background-color: #D8E4C6; }
        #pse #products-table tbody tr.selected-row { background-color: #cde2b4; box-shadow: 0 0 0 2px #004225; transform: scale(1.01); }
        #pse .placeholder-text { color: #777; text-align: center; padding: 50px 20px; background-color: #f8f9fa; border-radius: 8px; border: 2px dashed #D8E4C6; min-height: 300px; display: flex; align-items: center; justify-content: center; flex-grow: 1; }
        #pse #comparison-container { display: flex; flex-direction: column; flex-grow: 1; gap: 25px; }
        @media (min-width: 768px) and (max-width: 1023px) { #pse .main-comparison-area { grid-template-columns: 1fr 1fr; grid-template-areas: "current proposed" "summary summary"; } #pse #current-agreement-col { grid-area: current; } #pse #proposed-agreement-col { grid-area: proposed; } #pse #summary-col { grid-area: summary; } }
        @media (min-width: 1024px) { #pse .main-comparison-area { grid-template-columns: 1fr 1fr 1fr; } }
        #pse .comparison-column { background-color: #F7F9F5; padding: 20px; border-radius: 8px; border: 1px solid #D8E4C6; display: flex; flex-direction: column; }
        #pse .comparison-details .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb; font-size: 0.95em; }
        #pse .comparison-details .detail-item:last-child { border-bottom: none; }
        #pse .comparison-details .detail-item span { font-weight: 500; color: #374151; margin-right: 1rem; }
        #pse .comparison-details .detail-item strong { font-weight: 600; color: #004225; text-align: right; }
        #pse .savings-summary-area { display: grid; grid-template-columns: 1fr; gap: 1rem; height: 100%; }
        @media (min-width: 600px) { #pse .savings-summary-area { grid-template-columns: repeat(2, 1fr); } }
        #pse .summary-box { background-color: #F0FDF4; border-radius: 0.75rem; padding: 1rem; text-align: center; border: 1px solid #D1FAE5; }
        #pse .summary-box .label { color: #374151; margin-bottom: 0.25rem; font-size: 1rem; font-weight: 500; }
        #pse .summary-box .value { font-size: 2rem; font-weight: 700; line-height: 1.2; }
        #pse .summary-box .details { margin-top: 0.5rem; font-size: 0.85rem; color: #4B5563; }
        #pse .positive-saving, #pse .text-green-600 { color: #16A34A; }
        #pse .negative-saving, #pse .text-red-600 { color: #DC2626; }
        #pse .text-orange-600 { color: #EA580C; }
        #pse .term-adjust-container { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        #pse .term-adjust-btn { background-color: #004225; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; transition: background-color 0.3s; }
        #pse .term-adjust-btn:hover { background-color: #00331e; }
        #pse .term-adjust-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #pse .dns-layout-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { #pse .dns-layout-grid { grid-template-columns: 1fr 1fr; } }
        #pse .dns-fields-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { #pse .dns-fields-grid { grid-template-columns: 1fr 1fr; } }
        #pse .header-banner { background-color: #004225; color: white; display: inline-block; }
        #pse .sub-header-banner { background-color: #cce1d7; color: #00311c; display: inline-block; }
        #pse .input-field, #pse .select-field, #pse .textarea-field { transition: all 0.3s ease; border: 1px solid #D1D5DB; }
        #pse .input-field:focus, #pse .select-field:focus, #pse .textarea-field:focus { border-color: #004225; box-shadow: 0 0 0 3px rgba(0, 66, 37, 0.2); outline: none; }
        #pse .select-field { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; appearance: none; }
        #pse #demands-and-needs-section label.required::after { content: "*"; color: #dc2626; margin-left: 2px; }
        #pse #demands-and-needs-section .field-group-bg { background-color: #f0f7f3; border: 1px solid #cce1d7; padding: 1rem; border-radius: 8px; }
        #pse .letter-preview { background-color: white; padding: 1.25rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-family: 'Poppins', sans-serif; color: #333; line-height: 1.4; }
        #pse .letter-preview h1, #pse .letter-preview h2, #pse .letter-preview h3 { font-family: 'Poppins', sans-serif; color: #004225; }
        #pse .letter-preview p { margin-bottom: 0.5em; }
        #pse .letter-preview .section-title { font-size: 1.1em; font-weight: bold; margin-top: 1.5em; margin-bottom: 0.5em; border-bottom: 1px solid #cce1d7; padding-bottom: 0.25em; }
        #pse .print-button { background-color: #006837; color: white; }
        #pse .print-button:hover { background-color: #004225; }
        #pse .print-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
@media print {
          /* Hide everything except the DNS letter when printing */
          body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            background: #f4f7f5 !important;
          }
          .sidebar, nav, header, footer, .top-nav, .crm-title,
          .tab-link, #sales-pipeline-crm, #comparison-calculator {
            display: none !important;
          }
          .tab-content {
            display: none !important;
          }
          #pse {
            display: block !important;
          }
          #pse .dns-layout-grid {
            display: block !important;
          }
          #pse .dns-layout-grid > :not(.letter-preview-wrapper) {
            display: none !important;
          }
          #pse .letter-preview-wrapper,
          #pse .letter-preview {
            max-width: 680px;
            margin: 0 auto !important;
          }
          #pse .letter-preview {
            background: #ffffff !important;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            padding: 24px 28px !important;
            border: 1px solid #e6e6e6;
          }
          #pse .letter-preview h2.section-title,
          #pse .letter-preview h3.section-title {
            border-bottom: 1px solid #e6e6e6;
            padding-bottom: 6px;
            margin-bottom: 10px;
            color: #004225;
          }
          #pse .letter-preview p,
          #pse .letter-preview li {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
            line-height: 1.6;
          }
          #pse .letter-preview ul.letter-bullets {
            padding-left: 18px;
          }
          #pse .letter-preview ul.letter-bullets li {
            margin-bottom: 4px;
          }
          /* Hide buttons and helper text inside DNS card */
          #pse #final-quote-checklist-section,
          #pse #ltr_print-letter-btn,
          #pse #print-reminder {
            display: none !important;
          }
        }
        #pse .letter-preview .esign-section { margin-top: 3em; padding-top: 1.5em; border-top: 1px solid #cce1d7; }
        #pse .letter-preview .esign-declaration { font-style: italic; margin-bottom: 1.5em; }
        #pse .letter-preview .esign-signature-line { border-bottom: 1px solid #333; height: 2em; margin-bottom: 0.5em; width: 70%; }
        #pse .letter-preview .esign-date-line { border-bottom: 1px solid #333; height: 1.5em; margin-bottom: 0.5em; width: 40%; display: inline-block; }
        #pse .section-heading-styled { background-color: #004225; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 1.125rem; font-weight: 500; }
        #pse #demands-and-needs-section .company-details-compact label { font-size: 0.75rem; }
        #pse #demands-and-needs-section .company-details-compact input { font-size: 0.875rem; padding: 0.25rem 0.5rem; }
        #pse #final-quote-checklist-section { background-color: #fefce8; border: 1px solid #fde047; }
        #pse #final-quote-checklist-section h4 { color: #854d0e; }
        #pse #checklist-items-container { padding-left: 1rem; border-left: 4px solid #facc15; }
        #pse #checklist-toggle:checked ~ .peer-checked\:bg-racing-green-600 { background-color: #059669; }
        #pse #checklist-toggle:checked ~ .peer-checked\:translate-x-full { transform: translateX(100%); }
        #pse .hidden { display: none; }
        #sales-pipeline-crm { font-family: 'Inter', sans-serif; background-color: var(--pale-green); color: var(--british-racing-green); height: 100%; display: flex; flex-direction: column; }
        #sales-pipeline-crm .top-nav { background-color: var(--british-racing-green); position: relative; z-index: 20; }
        #sales-pipeline-crm .nav-tab.active { background-color: #006A3E; }
        #sales-pipeline-crm .kanban-column { background-color: var(--pale-green-darker); height: calc(100vh - 15rem); overflow-y: auto; }
        #sales-pipeline-crm .kanban-card { cursor: pointer; border-left: 4px solid var(--gold-orange); transition: all 0.2s; }
        #sales-pipeline-crm .kanban-card:active { cursor: grabbing; }
        #sales-pipeline-crm .dragging { opacity: 0.5; }
        #sales-pipeline-crm .drag-over { background-color: #d9e9d9; }
        #sales-pipeline-crm .custom-file-upload { border: 2px dashed #9ae6b4; display: inline-block; padding: 2rem 1rem; cursor: pointer; text-align: center; width: 100%; border-radius: 0.5rem; background-color: white; }
        #sales-pipeline-crm .custom-file-upload:hover { border-color: var(--gold-orange); background-color: #fafafa; }
        #sales-pipeline-crm input[type="file"] { display: none; }
        #sales-pipeline-crm .kanban-column::-webkit-scrollbar, #sales-pipeline-crm .modal-body-scroll::-webkit-scrollbar { width: 8px; }
        #sales-pipeline-crm .kanban-column::-webkit-scrollbar-track, #sales-pipeline-crm .modal-body-scroll::-webkit-scrollbar-track { background: transparent; }
        #sales-pipeline-crm .kanban-column::-webkit-scrollbar-thumb, #sales-pipeline-crm .modal-body-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        #sales-pipeline-crm .kanban-column::-webkit-scrollbar-thumb:hover, #sales-pipeline-crm .modal-body-scroll::-webkit-scrollbar-thumb:hover { background: #aaa; }
        #sales-pipeline-crm #customerModal .modal-content { max-height: 85vh; overflow-y: auto; }
        #sales-pipeline-crm #contacts-view th { position: relative; user-select: none;}
        #sales-pipeline-crm #contacts-view th[data-sort-key] { cursor: pointer; }
        #sales-pipeline-crm #contacts-view th .sort-indicator { margin-left: 5px; color: #9ca3af; display: inline-block; width: 1em; text-align: center;}
        #sales-pipeline-crm #contacts-view th.sort-asc .sort-indicator, #sales-pipeline-crm #contacts-view th.sort-desc .sort-indicator { color: var(--british-racing-green); }
        #sales-pipeline-crm .input-field { margin-top: 0.25rem; display: block; width: 100%; border-radius: 0.375rem; border: 1px solid #D1D5DB; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }

/* UI tweak: ensure finance type dropdown text is fully visible */
#finance-type.input-field { min-height: 48px; padding-top: 0.6rem; padding-bottom: 0.6rem; }

        #sales-pipeline-crm .input-field:focus { --tw-ring-color: #004225; border-color: #004225; }
        #sales-pipeline-crm #contacts-view th .col-resizer { position: absolute; top: 0; right: -3px; width: 6px; height: 100%; cursor: col-resize; user-select: none; z-index: 2; }
        #sales-pipeline-crm #contacts-view th .col-resizer::after { content: ""; position: absolute; top: 0; bottom: 0; left: 2px; width: 2px; background: transparent; }
        #sales-pipeline-crm #contacts-view th:hover .col-resizer::after { background: #e5e7eb; }
        #sales-pipeline-crm .is-resizing { cursor: col-resize !important; }
        #sales-pipeline-crm #contacts-view th .sort-indicator { display: none; }
        #sales-pipeline-crm #contacts-view th .sort-controls { display: inline-flex; flex-direction: column; margin-left: 6px; vertical-align: middle; }
        #sales-pipeline-crm #contacts-view th .sort-controls .sort-arrow { width: 12px; height: 10px; line-height: 10px; font-size: 10px; color: #9ca3af; border: none; background: transparent; padding: 0; cursor: pointer; }
        #sales-pipeline-crm #contacts-view th .sort-controls .sort-arrow.active { color: var(--british-racing-green); }
        #sales-pipeline-crm #contacts-view th .sort-controls .sort-arrow:focus { outline: none; }
.scrollbar-thin::-webkit-scrollbar { width: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #555; }
        [x-cloak] { display: none !important; }
        .brand-bg-dark { background-color: #004225; }
        .brand-bg-dark-hover:hover { background-color: #00331e; }
        .brand-bg-light { background-color: #E0F2E9; }
        .brand-bg-accent { background-color: #C1E1C1; }
        .brand-text-dark { color: #004225; }
        .brand-focus-ring:focus { --tw-ring-color: #004225; }

/* === Compact density overrides for Original Agreement Details === */
#form-card.compact { padding: 14px; }
#form-card.compact .section-header { margin-bottom: 8px; padding-bottom: 6px; }
#form-card.compact .page-container { gap: 12px; }
#form-card.compact .form-grid { gap: 8px 12px; }
#form-card.compact .form-group { margin-bottom: 8px; }
#form-card.compact .form-row-split,
#form-card.compact .form-row-triplet { gap: 8px; }
#form-card.compact label { margin-bottom: 2px; font-size: 0.9rem; }
#form-card.compact input,
#form-card.compact select,
#form-card.compact textarea { padding: 0.2rem 0.4rem; min-height: 32px; }
#form-card.compact .original-input,
#form-card.compact .editable-calc { height: 36px; }
#form-card.compact .vrn-lookup-group button { padding: 0 10px; height: 32px; }
#form-card.compact .btn { padding: 6px 10px; }
#form-card.compact .mt-1 { margin-top: 2px; }

#form-card.compact .highlight-bg { padding: 0.5rem; }

/* Kanban card toggle controls */
.toggle{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:4px;border:1px solid currentColor;font-weight:700;}
.toggle-red{color:#dc2626;background:#fee2e2;}
.toggle-green{color:#16a34a;background:#dcfce7;}
.toggle-label{font-size:10px;color:#374151;text-align:right;min-width:38px;}
.label-xs{font-size:0.70rem;color:#6b7280;}
.doc-toggle+span{font-size:10px;color:#374151;}
.toggle-stacked .toggle-sub{font-size:10px;line-height:1;text-align:right;color:#374151;margin-top:2px;}
.card-gap-tight{column-gap:.25rem;row-gap:.25rem;}
.kanban-card .grid{row-gap:.25rem;}
.kanban-card{padding-top:.4rem;padding-bottom:.4rem;}

        /* --- VRN as mini car reg plate (Kanban cards) --- */
        .vrn-plate{
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          background: #FDE047;              /* yellow */
          border: 1px solid #000;           /* black border */
          border-radius: 6px;
          padding: 2px 6px;
          display: inline-block;
          letter-spacing: .06em;
          color: #000;
          font-weight: 800;
          line-height: 1;
        }

        /* --- Save Deal overlay + Colin spinner --- */
        @keyframes colinSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .colin-spinner { animation: colinSpin .9s linear infinite; }
        @media (prefers-reduced-motion: reduce) { .colin-spinner { animation: none; } }

/* --- Refinance Deal UI --- */
.refinance-label-box{
  border:2px solid #9CA3AF; /* slate-ish */
  border-radius: 10px;
  padding: 2px 8px;
  display: inline-flex;
  align-items: center;
}

#products-table .ps-edit-cell {
  white-space: nowrap;
}

#products-table .ps-edit-input {
  width: 92px;
  max-width: 100%;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.15);
  background: rgba(255,255,255,0.85);
  font-size: 0.85rem;
}

#products-table .ps-edit-cell--rate .ps-edit-input {
  width: 78px;
}

#products-table .ps-edit-cell--term .ps-edit-input {
  width: 70px;
}

#products-table .ps-edit-suffix {
  margin-left: 4px;
  font-weight: 600;
}

#products-table .ps-edit-input:focus,
#products-table .balloon-input:focus {
  outline: 2px solid rgba(0, 66, 37, 0.35);
  outline-offset: 2px;
}

.refinance-label-box.refinance-true{
  background:#DCFCE7; /* green-100 */
  border-color:#16A34A; /* green-600 */
}
.refinance-label-box.refinance-false{
  background:#FEE2E2; /* red-100 */
  border-color:#DC2626; /* red-600 */
}

/* DNS letter: reduce small-print sizing */
#dns .letter .small-print,
#dns .letter small {
  font-size: 11px;
  line-height: 1.35;
}

/* VRN: center the VRN control block vertically within the VRN section */
#pse #form-card .ps-vrn-search {
  display: flex;
  flex-direction: column;
}
#pse #form-card .ps-vrn-controls {
  margin-top: auto;
  margin-bottom: auto;
}

/* DNS letter: much smaller text for detailed sections */
#dns .letter .dns-mini,
#dns .letter .dns-mini p,
#dns .letter .dns-mini li,
#dns .letter p.dns-mini,
#dns .letter ul.dns-mini li {
  font-size: 10px !important;
  line-height: 1.18 !important;
}

#dns .letter .dns-mini .section-title {
  font-size: 12px !important;
  line-height: 1.2 !important;
}

#dns .letter .dns-mini .section-subtitle {
  font-size: 11px !important;
  line-height: 1.2 !important;
}

#dns .letter .dns-mini .small-print,
#dns .letter .dns-mini small {
  font-size: 9px !important;
  line-height: 1.18 !important;
}

/* DNS letter: reduce overall font sizing to shorten printed length */
#dns .letter-preview,
#dns .letter-preview .letter {
  font-size: 12px;
  line-height: 1.35;
}

#dns .letter-preview p { margin-bottom: 0.7em; }

#dns .letter-preview .section-title {
  font-size: 13px;
  margin-top: 0.9em;
  margin-bottom: 0.45em;
}

#dns .letter-preview .section-subtitle {
  font-size: 12px;
  margin-top: 0.8em;
  margin-bottom: 0.4em;
}

/* Letter header logo (page 1 only) */
#dns .letter-header-logo {
  margin-bottom: 14px;
}
#dns .letter-logo {
  display: block;
  max-width: 100%;
  height: auto;
}

/* Footer on last page only (placed at end of content) */
#dns .letter-footer {
  margin-top: 18px;
  padding-top: 10px;
  border-top: 1px solid #cce1d7;
}

/* DNS letter: force 8pt body text (not headers) for selected detailed sections + (for example) blocks */
#dns .letter .dns-mini,
#dns .letter .dns-mini p,
#dns .letter .dns-mini li,
#dns .letter p.dns-mini,
#dns .letter ul.dns-mini li {
  font-size: 11pt !important;
  line-height: 1.18 !important;
}

/* Keep headers readable (not forced to 8pt) */
#dns .letter .dns-mini .section-title {
  font-size: 12px !important;
  line-height: 1.2 !important;
}
#dns .letter .dns-mini .section-subtitle {
  font-size: 11px !important;
  line-height: 1.2 !important;
}

/* Letter: two-column bullets for dense sections (2 & 3) */
#dns .letter-preview .bullets-2col {
  column-count: 2;
  column-gap: 1.2em;
}
#dns .letter-preview .bullets-2col li {
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
}

  /* UI tweaks */
  .logout-icon{ color:#dc2626 !important; }
</style>
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script><style>
.kanban-card, .kanban-card * { box-sizing: border-box; }

/* Tighter vertical rhythm inside Kanban cards */
.kanban-card .row, .kanban-card .grid, .kanban-card .flex { gap: 4px !important; }
.kanban-card .p-2, .kanban-card .p-3, .kanban-card .p-4 { padding: 6px !important; }
.kanban-card .py-2, .kanban-card .py-3, .kanban-card .py-4 { padding-top: 6px !important; padding-bottom: 6px !important; }
.kanban-card .my-2, .kanban-card .my-3, .kanban-card .my-4 { margin-top: 4px !important; margin-bottom: 4px !important; }
.kanban-card .mt-2, .kanban-card .mt-3, .kanban-card .mt-4 { margin-top: 4px !important; }
.kanban-card .mb-2, .kanban-card .mb-3, .kanban-card .mb-4 { margin-bottom: 4px !important; }

/* Inputs: consistent height and centered text for OLD/NEW columns */
.kanban-card input[type="text"],
.kanban-card input[type="number"],
.kanban-card input[type="date"],
.kanban-card input[type="email"],
.kanban-card input[type="tel"],
.kanban-card select,
.kanban-card textarea {
  height: 30px;
  line-height: 30px;
  padding: 0 8px;
}

/* Center text inside the fields that belong to OLD/NEW columns by common labels/selectors */
[class*="old"], [class*="Old"], [data-col="old"],
[class*="new"], [class*="New"], [data-col="new"] {
  text-align: center !important;
}
[class*="old"] input, [class*="Old"] input, [data-col="old"] input,
[class*="new"] input, [class*="New"] input, [data-col="new"] input,
[class*="old"] select, [class*="Old"] select, [data-col="old"] select,
[class*="new"] select, [class*="New"] select, [data-col="new"] select,
[class*="old"] textarea, [class*="Old"] textarea, [data-col="old"] textarea,
[class*="new"] textarea, [class*="New"] textarea, [data-col="new"] textarea {
  text-align: center !important;
}

/* If the OLD/NEW sections are side-by-side columns, align their headers and reduce spacing */
.kanban-columns, .kanban-row {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}
.kanban-col-header { text-align: center; font-weight: 600; letter-spacing: 0.02em; margin-bottom: 6px; }

/* Tighten labels below Settlement/Savings */
.label-xs { font-size: 11px; opacity: 0.8; margin-top: 2px !important; display:block; text-align:right; }

</style>
<style>
.kanban-card input[type="text"],
.kanban-card input[type="number"],
.kanban-card input[type="date"],
.kanban-card input[type="email"],
.kanban-card input[type="tel"],
.kanban-card select,
.kanban-card textarea {
  text-align: center !important;
}

/* Tighter field group spacing */
.kanban-card .input-field,
.kanban-card .select-field,
.kanban-card .textarea-field,
.kanban-card .field-group-bg {
  margin-top: 4px !important;
  margin-bottom: 4px !important;
}

/* Reduce gap for any CSS grid inside kanban cards */
.kanban-card [class*="grid"],
.kanban-card [class*="Grid"],
.kanban-card .dns-fields-grid {
  gap: 6px !important;
}

/* Align small labels neatly */
.kanban-card .label-xs { line-height: 1.1; text-align: right; }

</style>
<style>
/* === ULTRA TIGHT v13: Kanban density & card compaction === */
#kanban-board.space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: .5rem !important; } /* shrink board gaps */
#sales-pipeline-crm .kanban-column {
  flex: 0 0 280px !important; width: 280px !important;
  padding: 6px !important; gap: 8px !important;
}
#sales-pipeline-crm .kanban-card {
  padding: 6px 8px !important;
  border-radius: 12px !important;
  font-size: 12.5px !important;
  line-height: 1.15 !important;
  box-shadow: 0 2px 6px rgba(0,0,0,.05);
}
#sales-pipeline-crm .kanban-card .grid,
#sales-pipeline-crm .kanban-card .flex,
#sales-pipeline-crm .kanban-card .row { gap: 4px !important; }

/* Inputs/buttons inside cards */
#sales-pipeline-crm .kanban-card input,
#sales-pipeline-crm .kanban-card select,
#sales-pipeline-crm .kanban-card textarea,
#sales-pipeline-crm .kanban-card button {
  height: 28px !important;
  padding: 0 6px !important;
  border-radius: 6px !important;
}
#sales-pipeline-crm .kanban-card textarea { min-height: 60px !important; }
#sales-pipeline-crm .kanban-card label {
  font-size: 11px !important;
  margin-bottom: 2px !important;
  color: #374151;
}

/* Old/New columns look compact & centered */
#sales-pipeline-crm .kanban-card .kanban-row,
#sales-pipeline-crm .kanban-card .kanban-columns {
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 6px !important;
}
#sales-pipeline-crm .kanban-card [data-col="old"],
#sales-pipeline-crm .kanban-card [data-col="new"] {
  text-align: center !important;
}
#sales-pipeline-crm .kanban-card [data-col="old"] input,
#sales-pipeline-crm .kanban-card [data-col="new"] input,
#sales-pipeline-crm .kanban-card [data-col="old"] select,
#sales-pipeline-crm .kanban-card [data-col="new"] select {
  text-align: center !important;
}

/* Toggle stack (ID / V5 / Income / Settle) */
#sales-pipeline-crm .toggle-label { font-size: 10px !important; min-width: 36px !important; text-align: right !important; color:#374151; }
#sales-pipeline-crm .doc-toggle,
#sales-pipeline-crm .toggle { width: 18px !important; height: 18px !important; border-radius: 3px !important; }
#sales-pipeline-crm .toggle-green { background: #dcfce7 !important; color:#16a34a !important; }
#sales-pipeline-crm .toggle-red { background: #fee2e2 !important; color:#dc2626 !important; }

/* Compact footer row (owner + stage + ref numbers) */
#sales-pipeline-crm .kanban-card .footer-row {
  display:grid; grid-template-columns: 1fr 1fr; gap:6px;
}
#sales-pipeline-crm .kanban-card .footer-row .ref { font-size: 11px; text-align:right; opacity:.8; }

/* Stage 'ready' accent */
#sales-pipeline-crm .kanban-card.deal-ready { border-left-color: #22c55e !important; box-shadow: 0 0 0 2px rgba(34,197,94,.25); }
</style>
<style>
#sales-pipeline-crm .kanban-card { padding: 4px 6px !important; line-height: 1.1 !important; }
#sales-pipeline-crm .kanban-card .grid,
#sales-pipeline-crm .kanban-card .row,
#sales-pipeline-crm .kanban-card .flex { gap: 4px !important; }
#sales-pipeline-crm .kanban-card input,
#sales-pipeline-crm .kanban-card select,
#sales-pipeline-crm .kanban-card textarea,
#sales-pipeline-crm .kanban-card button { height: 26px !important; }
#sales-pipeline-crm .kanban-card textarea { min-height: 54px !important; }
</style>
<style id="cmf-theme-vars">
:root{
  --cmf-stage-header-font-size: 12px;
  --cmf-stage-header-gap: 8px;
}
</style>
<style id="cmf-stage-header-css">
/* SAFE v21: compact single-row stage headers (no DOM changes) */
#sales-pipeline-crm .kanban-column > .column-header,
#sales-pipeline-crm .kanban-column > header,
#sales-pipeline-crm .kanban-column > .title-bar,
#sales-pipeline-crm .kanban-column > div:first-child {
  display:flex !important;
  align-items:center !important;
  justify-content: space-between !important;
  gap: var(--cmf-stage-header-gap) !important;
  font-size: var(--cmf-stage-header-font-size) !important;
  line-height: 1.05 !important;
  padding: 4px 6px !important;
  white-space: nowrap !important;
}
#sales-pipeline-crm .kanban-column > .column-header *,
#sales-pipeline-crm .kanban-column > header *,
#sales-pipeline-crm .kanban-column > .title-bar *,
#sales-pipeline-crm .kanban-column > div:first-child * {
  white-space: nowrap !important;
  line-height: 1.05 !important;
}
#sales-pipeline-crm .kanban-column > .column-header br,
#sales-pipeline-crm .kanban-column > header br,
#sales-pipeline-crm .kanban-column > .title-bar br,
#sales-pipeline-crm .kanban-column > div:first-child br {
  display: none !important;
}
/* If counts/totals rendered as blocks, keep them inline */
#sales-pipeline-crm .kanban-column .stage-count,
#sales-pipeline-crm .kanban-column .stage-sum,
#sales-pipeline-crm .kanban-column .column-meta {
  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;
}
</style>
<style id="cmf-theme-vars-sticky">
:root{
  --cmf-stage-header-font-size: 12px;    /* already present in v21, ensure default */
  --cmf-stage-header-gap: 8px;           /* gap between title / count / total */
  --cmf-sticky-top: 0px;                 /* offset if you have a top navbar, e.g., 48px */
  --cmf-header-bg: #ffffff;              /* header background to prevent bleed when sticky */
}
</style>
<style id="cmf-stage-header-sticky">
/* Keep the first child of each kanban column (the stage header) fixed (sticky) */
#sales-pipeline-crm .kanban-column > .column-header,
#sales-pipeline-crm .kanban-column > header,
#sales-pipeline-crm .kanban-column > .title-bar,
#sales-pipeline-crm .kanban-column > div:first-child{
  position: sticky !important;
  top: var(--cmf-sticky-top) !important;
  z-index: 20 !important;
  background: var(--cmf-header-bg) !important;
  box-shadow: 0 1px 0 rgba(0,0,0,.06);
}

/* Ensure the header content stays on ONE ROW */
#sales-pipeline-crm .kanban-column > .column-header,
#sales-pipeline-crm .kanban-column > header,
#sales-pipeline-crm .kanban-column > .title-bar,
#sales-pipeline-crm .kanban-column > div:first-child{
  display:flex !important;
  align-items:center !important;
  justify-content: space-between !important;
  gap: var(--cmf-stage-header-gap) !important;
  font-size: var(--cmf-stage-header-font-size) !important;
  line-height: 1.05 !important;
  padding: 4px 6px !important;
  white-space: nowrap !important;
}
#sales-pipeline-crm .kanban-column > .column-header *,
#sales-pipeline-crm .kanban-column > header *,
#sales-pipeline-crm .kanban-column > .title-bar *,
#sales-pipeline-crm .kanban-column > div:first-child *{
  white-space: nowrap !important;
  line-height: 1.05 !important;
}
/* Hide any <br> inside headers to force a single line */
#sales-pipeline-crm .kanban-column > .column-header br,
#sales-pipeline-crm .kanban-column > header br,
#sales-pipeline-crm .kanban-column > .title-bar br,
#sales-pipeline-crm .kanban-column > div:first-child br{
  display:none !important;
}
</style>
<!-- EMBED LAYOUT OVERRIDES (Square Online): Page is designed to live inside an embed. Width is responsive; height is constrained (~1200px) to avoid Square container clipping. If changing heights, also review tab bodies and any iframe srcdoc templates. -->
<style id="cmf-embed-overrides">
  :root { --embed-height: 1200px; }
  html, body {
    width: 100% !important;
    height: var(--embed-height) !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: auto !important; /* allow scrolling inside the embed if needed */
  }
  /* Tailwind's h-screen uses 100vh; override to our fixed height for embedding */
  .h-screen { height: var(--embed-height) !important; }
  /* Main content area should honor the embed height */
  .content-area { height: var(--embed-height) !important; }
  .tab-content { height: 100% !important; }
  /* Kanban columns used viewport height; switch to embed height */
  #sales-pipeline-crm .kanban-column { height: calc(var(--embed-height) - 15rem) !important; }
  /* Some components may have internal max-heights tuned for 1200px already; keep as-is. */
</style>
<style id="cmf-embed-width-fix">
  /* Constrain the entire document to its parent container */
  html, body {
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
  }
  *, *::before, *::after { box-sizing: inherit !important; }

  /* Common root containers */
  #app, #root, #cmf-root, .container, .content-area, .page, .wrapper, main, section {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }

  /* Media & tables should never exceed the parent's width */
  img, video, canvas, svg, iframe, table {
    max-width: 100% !important;
    height: auto;
  }

  /* Avoid utility classes/inline styles forcing min-width overflow */
  [class*="min-w-"], [style*="min-width"] {
    min-width: 0 !important;
  }

  /* If any element uses fixed pixel widths, let it shrink within the container */
  [class*="w-["], [style*="width"] {
    max-width: 100% !important;
  }
</style>
<style id="cmf-not-taken-up-border">
  /* Bright red left border for cards in the Not Taken Up column */
  #kanban-board .kanban-column[data-deal-stage="Not Taken Up"] .kanban-card{
    border-left-color:#ff0000 !important;
    box-shadow:0 0 0 2px rgba(220,38,38,.25);
  }
</style>
<style id="cmf-banner-topgap-fix">
  /* Remove small white gap above the pipeline banner */
  #app { padding-top: 0 !important; }
  #cmf-pipeline-banner-wrap { margin-top: 0 !important; }
</style>
<style id="login-watermark-css">
  :root{
    --login-wm-size: 520px;
    --login-wm-opacity: 0.10;
    --login-wm-fade-ms: 3500;
  }
  .login-wm-layer{
    position:absolute;
    inset:0;
    background-repeat: repeat;
    background-size: var(--login-wm-size) auto;
    background-position: 0 0;
    background-attachment: fixed;
    opacity: 0;
    filter: saturate(0) contrast(1.1);
    pointer-events:none;
    z-index:0;
    transition: opacity calc(var(--login-wm-fade-ms) * 1ms) ease;
    transform: translateZ(0);
  }
  /* soften everything behind the card slightly */
  #authScreen::before{
    content:"";
    position:absolute;
    inset:0;
    background: radial-gradient(circle at 30% 20%, rgba(0,66,37,.10), transparent 55%),
                radial-gradient(circle at 70% 80%, rgba(0,66,37,.08), transparent 55%);
    pointer-events:none;
    z-index:0;
  }
</style>
<script id="login-watermark-js">
(function(){
  // Use your existing Colin assets already referenced in the app.
  const IMGS = [
    "https://lh3.googleusercontent.com/d/1Kf2kzoUmPDkHOrj_TkezYe0937VUAqzj",
    "https://lh3.googleusercontent.com/d/1z1OLTlJGykDP98DAwljiEJN02u6bDLZT",
    "https://lh3.googleusercontent.com/d/126qJMUWUzhzmUItRi9Zt1JFQDZ5TVgxx"
  ];

  const a = document.getElementById('wmA');
  const b = document.getElementById('wmB');
  if(!a || !b) return;

  let i = 0;
  let showA = true;

  function setLayer(el, url){
    // Use the image as a tiled watermark
    el.style.backgroundImage = `url("${url}")`;
  }

  setLayer(a, IMGS[i % IMGS.length]);
  setLayer(b, IMGS[(i+1) % IMGS.length]);

  // Start with A visible
  a.style.opacity = getComputedStyle(document.documentElement).getPropertyValue('--login-wm-opacity') || "0.10";

  // Fade between layers every ~9s (slow and subtle)
  const intervalMs = 9000;
  window.setInterval(() => {
    i = (i + 1) % IMGS.length;

    const incoming = showA ? b : a;
    const outgoing = showA ? a : b;

    setLayer(incoming, IMGS[(i+1) % IMGS.length]);

    incoming.style.opacity = getComputedStyle(document.documentElement).getPropertyValue('--login-wm-opacity') || "0.10";
    outgoing.style.opacity = "0";

    showA = !showA;
  }, intervalMs);

  // Respect reduced motion
  try{
    const rm = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)');
    if (rm && rm.matches){
      a.style.transition = "none";
      b.style.transition = "none";
      a.style.opacity = "0.08";
      b.style.opacity = "0";
    }
  }catch(e){}
})();
</script>
</head>
<body>
<!-- LLM EDITING GUIDE:
- This file is a single-page UI with multiple tabs. Navigation links use <a class="tab-link" data-tab="..."> and must match the corresponding content container id.
- Two tabs render inside iframes via <template id="calc-v18-srcdoc"> and <template id="whatsapp-messenger-srcdoc">. If you change global CSS, consider whether those srcdoc templates also need the same CSS injected.
- Tailwind is precompiled and inlined (search: <style id="tailwind-built">). Do NOT use https://cdn.tailwindcss.com or tailwind.config (runtime) in production.
- Form control look/feel is normalized via <style id="forms-lite"> and <style id="ui-polish-patches">. If borders/focus rings look wrong, adjust these blocks (prefer small overrides over editing compiled Tailwind).
- Key modals: #customerModal (Application), #dealModal, #notesModal (if present). Keep IDs stable; JS binds events by id.
- Server calls go through App.apiCall(...) / google.script.run.handleWebClientRequest(...). Preserve action names and payload shapes.
 -->

<div class="min-h-screen w-full flex items-center justify-center bg-gray-100 relative overflow-hidden" id="loginOverlay">
<!-- BRANDING: Background watermark layer for Colin Compare. Uses CSS animation to fade between watermark images. If swapping assets, update only the watermark URLs/classes here. -->
<div aria-hidden="true" class="login-wm-layer" id="wmA"></div>
<div aria-hidden="true" class="login-wm-layer" id="wmB"></div>
<div class="relative w-full max-w-md mx-4">
<div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden backdrop-blur-[1px]">
<div class="px-6 py-5 bg-[#004225] text-white">
<div class="flex items-center gap-3">
<img alt="Logo" class="w-10 h-10 rounded-full border border-white/30 object-cover" src="https://lh3.googleusercontent.com/d/1zESgE9OpS1KcJapsFvvwcVyr2Ogykz2j"/>
<div>
<div class="text-lg font-semibold leading-tight">CMF Refi Orchestrator</div>
<div class="text-xs text-white/80">Welcome back — sign in to continue</div>
</div>
</div>
</div>
<form class="px-6 py-6 space-y-4" id="loginForm">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="loginUsername">Username</label>
<input autocomplete="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-800" id="loginUsername" placeholder="Enter your username" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="loginPassword">Password</label>
<input autocomplete="current-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-800" id="loginPassword" placeholder="Enter your password" required="" type="password"/>
</div>
<div class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-3 py-2" id="loginError"></div>
<button class="w-full bg-[#004225] hover:bg-[#00331e] text-white font-semibold py-2.5 rounded-lg transition-colors" id="loginBtn" type="submit">
          Sign in
        </button>
<div class="text-xs text-gray-600 leading-snug">
<span class="font-semibold">Tip:</span>
          Having trouble? Double‑check caps lock and try again.
        </div>
</form>
</div>
<div class="mt-3 text-center text-xs text-gray-500">
      Email IT@comparemyfinance.co.uk for Access Requests.
    </div>
</div>
</div>
<div class="flex h-screen bg-gray-200 hidden" id="appRoot">
<div class="sidebar w-64 p-5 flex-shrink-0">
<div class="flex justify-center mb-6"><img alt="Company Logo" class="h-24 w-24 rounded-full border-2 border-white" src="https://lh3.googleusercontent.com/d/1zESgE9OpS1KcJapsFvvwcVyr2Ogykz2j"/></div>
<h1 class="crm-title text-2xl font-bold mb-8 text-center">CMF Refi Orchestrator</h1>
<nav>
<ul>
<li class="mb-4"><a class="tab-link active-tab" data-tab="sales-pipeline-crm" href="#">Sales Pipeline</a></li>
<li class="mb-4"><a class="tab-link" data-tab="pse" href="#">Product Source &amp; DNS</a></li>
<li class="mb-4"><a class="tab-link" data-tab="document-upload" href="#">Document Upload</a></li>
<li class="mb-4"><a class="tab-link" data-tab="client-files-view" href="#" onclick="App.ui.switchTab('client-files-view'); setTimeout(() =&gt; { if(window.App &amp;&amp; App.handlers &amp;&amp; App.handlers.runFolderSearch) App.handlers.runFolderSearch(\'\'); }, 200); return false;">Client Files</a></li>
<li class="mb-4"><a class="tab-link" data-tab="comparison-calculator" href="#">Comparison Calculator</a></li>
<li class="mb-4"><a class="tab-link" data-tab="whatsapp-messenger" href="#">WhatsApp Messenger</a></li>
<li class="mb-4"><a class="tab-link" data-tab="twilio-flex" href="#">Twilio Flex</a></li>
</ul>
<li class="mt-8">
<button class="w-full text-left bg-gray-800/50 hover:bg-gray-700 text-white" id="logoutBtn">
<i class="fas fa-right-from-bracket mr-2 logout-icon"></i>Logout
  </button>
</li>
</nav>
</div>
<main class="content-area flex-1">
<div class="tab-content p-4 sm:p-6 lg:p-8" id="pse">
<div class="page-container">
<div class="grid-card compact" id="form-card">
<div class="ps-header">
<div class="ps-header-main">
<div class="ps-header-avatar">
<img alt="Vehicle Finance Finder mascot" src="https://lh3.googleusercontent.com/d/1LwV6T2e1v9r3gD_vrf0IQLpB1pXqfkoZ"/>
</div>
<div class="ps-header-text">
<div class="ps-header-title">Vehicle Finance Finder</div>
<div class="ps-header-subtitle">Original agreement details</div>
</div>
</div>
</div>
<form class="ps-form" id="finance-form">
<div class="ps-vrn-row"><div class="ps-vrn-search"><div class="ps-vrn-helper">
        ENTER CLIENT CAR REGISTRATION TO START
      </div><div class="ps-vrn-controls"><label for="vrn">Vehicle Registration (VRN)</label><div class="vrn-lookup-group">
<input class="original-input" id="vrn" placeholder="e.g. AB12 CDE" type="text"/>
<button id="vrn-lookup-btn" type="button">
<span id="vrn-lookup-text">Find</span>
<div class="spinner hidden" id="vrn-spinner"></div>
</button>
</div><small class="mt-1 ps-vrn-status" id="vrn-status"></small></div></div><div class="ps-client-col">
<div class="ps-client-placeholder">
<div class="ps-client-title">Client Details Selected</div>
<div class="ps-client-grid">
<div class="ps-client-field">
<label for="ps_client_firstName">First name</label>
<input id="ps_client_firstName" placeholder="firstName" readonly="" type="text"/>
</div>
<div class="ps-client-field">
<label for="ps_client_lastName">Last name</label>
<input id="ps_client_lastName" placeholder="lastName" readonly="" type="text"/>
</div>
<div class="ps-client-field ps-client-field--full">
<label for="ps_client_currentPostcode">Current postcode</label>
<input id="ps_client_currentPostcode" placeholder="currentPostcode" readonly="" type="text"/>
</div>
</div>
<small class="ps-client-note">Check correct Client Details appear before proceeding.</small>
</div>
</div></div>
<div class="form-grid ps-details-grid">
<div class="form-group">
<label for="finance-type">Finance Type</label>
<select class="original-input" id="finance-type" required="">
<option value="">Select finance type</option>
<option value="PCP">PCP</option>
<option value="HP">HP</option>
</select>
</div>
<div class="form-group">
<label for="vehicle-make">Make</label>
<input class="original-input" id="vehicle-make" list="manufacturer-list" required="" type="text"/>
<datalist id="manufacturer-list"></datalist>
</div>
<div class="form-group">
<label for="vehicle-model">Model</label>
<input class="original-input" id="vehicle-model" required="" type="text"/>
</div>
<div class="form-group">
<label for="vehicle-year">Year</label>
<input class="original-input" id="vehicle-year" required="" type="number"/>
</div>
<div class="form-group">
<label for="finance-company">Finance Company</label>
<input id="finance-company" readonly="" type="text"/>
</div>
<div class="form-group">
<label for="agreement-number">Agreement Number</label>
<input id="agreement-number" readonly="" type="text"/>
</div>
<div class="form-group">
<label for="original-purchase-price">Purchase Price (£)</label>
<input class="original-input" id="original-purchase-price" required="" type="number" value="20000"/>
</div>
<div class="form-group">
<label for="deposit-paid">Deposit Paid (£)</label>
<input class="original-input" id="deposit-paid" required="" type="number" value="0"/>
</div>
<div class="form-group">
<label for="agreement-start-date">Agreement Start Date</label>
<input class="original-input" id="agreement-start-date" required="" type="date" value="2023-07-19"/>
</div>
<div class="form-group">
<label for="original-apr">Original APR (%)</label>
<input class="original-input" id="original-apr" required="" step="0.1" type="number" value="12.9"/>
</div>
<div class="form-group">
<label for="original-term">Original Term (months)</label>
<input class="original-input" id="original-term" required="" type="number" value="48"/>
</div>
<div class="form-group">
<label for="original-final-balloon">Final Balloon (£)</label>
<input class="original-input" id="original-final-balloon" required="" type="number" value="5000"/>
</div>
</div>
<div class="ps-summary-grid">
<div class="form-group">
<label for="monthly-payment-display">Monthly Payment (£)</label>
<input class="editable-calc" id="monthly-payment-display" type="text"/>
</div>
<div class="form-group">
<label for="outstanding-balance-display">Outstanding Balance (£)</label>
<input class="editable-calc" id="outstanding-balance-display" type="text"/>
</div>
<div class="form-group">
<label for="remaining-term-display">Remaining Term (months)</label>
<input class="editable-calc" id="remaining-term-display" type="text"/>
</div>
</div>
<button class="btn ps-primary-btn" type="submit">Find New Products</button>
</form>
</div>
<div class="grid-card" id="results-card">
<div class="section-header"><img alt="colincompare-happy-save" src="https://lh3.googleusercontent.com/d/1Kf2kzoUmPDkHOrj_TkezYe0937VUAqzj"/><h2 class="ml-4">Product Sourcing Results</h2></div>
<div id="results-container"><div class="placeholder-text"><p>New finance products will be displayed here after you submit your current details.</p></div></div>
</div>
<div class="grid-card" id="comparison-card">
<div class="section-header"><img alt="colincompare-laptop-image" src="https://lh3.googleusercontent.com/d/1z1OLTlJGykDP98DAwljiEJN02u6bDLZT"/><h2 class="ml-4">Comparison</h2></div>
<div id="comparison-container"><div class="placeholder-text"><p>Select a product from the results table above to see a detailed comparison.</p></div></div>
</div>
<div class="grid-card hidden" id="demands-and-needs-section">
<div class="text-center mb-10">
<h1 class="text-3xl sm:text-4xl font-bold header-banner p-2 px-6 rounded-lg shadow-md mb-3">Compare My Finance</h1>
<p class="sub-header-banner p-2 px-4 rounded-md text-lg">Demands &amp; Needs Letter Creator</p>
</div>
<div class="dns-layout-grid">
<div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
<h2 class="text-2xl font-semibold text-green-800 mb-6 pb-3 border-b border-gray-200">Client &amp; Finance Details</h2>
<div class="my-6 bg-yellow-50 border border-yellow-300 rounded-lg p-5 shadow-sm" id="final-quote-checklist-section">
<h4 class="font-medium text-yellow-800 mb-4 text-lg flex items-center"><svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"></path></svg>FINAL QUOTE CHECKLIST</h4>
<label class="flex items-center cursor-pointer text-sm font-medium text-gray-700 mb-4" for="checklist-toggle"><div class="relative"><input class="sr-only" id="checklist-toggle" type="checkbox"/><div class="w-10 h-6 bg-gray-300 rounded-full shadow-inner peer-checked:bg-racing-green-600"></div><div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-full"></div></div><span class="ml-3">Enable Final Checks (Confirm all items below)</span></label>
<div class="hidden" id="checklist-items-container">
<p class="text-sm text-yellow-700 mb-3 font-semibold">Confirm each item is verified before generating the DNS letter.</p>
<div class="flex flex-col gap-3">
<label class="flex items-start cursor-pointer"><input class="h-5 w-5 rounded text-green-800 border-gray-400 mt-0.5" id="check-current-details" type="checkbox"/><span class="ml-3 text-sm text-gray-800">Has the customer's <strong>current</strong> balloon, interest rate (APR) been checked?</span></label>
<label class="flex items-start cursor-pointer"><input class="h-5 w-5 rounded text-green-800 border-gray-400 mt-0.5" id="check-new-details" type="checkbox"/><span class="ml-3 text-sm text-gray-800">Has the <strong>new</strong> finance option's balloon, interest rate (APR) been checked?</span></label>
<label class="flex items-start cursor-pointer"><input class="h-5 w-5 rounded text-green-800 border-gray-400 mt-0.5" id="check-settlement-figure" type="checkbox"/><span class="ml-3 text-sm text-gray-800">Has the customer's <strong>accurate settlement figure</strong> been obtained from their current lender?</span></label>
<label class="flex items-start cursor-pointer"><input class="h-5 w-5 rounded text-green-800 border-gray-400 mt-0.5" id="check-settlement-statement" type="checkbox"/><span class="ml-3 text-sm text-gray-800">Does the settlement figure reflect the customer's settlement statement?</span></label>
<label class="flex items-start cursor-pointer"><input class="h-5 w-5 rounded text-green-800 border-gray-400 mt-0.5" id="check-erc-twice" type="checkbox"/><span class="ml-3 text-sm text-gray-800">Have you ensured you have not added the ERC TWICE on the system?</span></label>
</div>
</div>
</div>
<div class="field-group-bg mb-6"><h3 class="text-lg font-medium text-green-800">Letter Administration</h3><div class="dns-fields-grid mt-4"><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_staff-name">Prepared by (Staff Name)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_staff-name" placeholder="e.g., John Doe" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_letter-date">Date of Letter</label><input class="input-field w-full p-2 rounded-lg" id="ltr_letter-date" type="date"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_reference-number">Reference Number</label><input class="input-field w-full p-2 rounded-lg" id="ltr_reference-number" placeholder="e.g., CMF12345" type="text"/></div></div></div>
<div class="field-group-bg mb-6"><h3 class="text-lg font-medium text-green-800">Client Information</h3><div class="dns-fields-grid mt-4"><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_client-name">Client Full Name</label><input class="input-field w-full p-2 rounded-lg" id="ltr_client-name" placeholder="e.g., Jane Smith" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_client-address-street">Street Address</label><input class="input-field w-full p-2 rounded-lg" id="ltr_client-address-street" placeholder="e.g., 123 Main Street" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_client-address-town">Town/City</label><input class="input-field w-full p-2 rounded-lg" id="ltr_client-address-town" placeholder="e.g., Anytown" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_client-address-postcode">Postcode</label><input class="input-field w-full p-2 rounded-lg" id="ltr_client-address-postcode" placeholder="e.g., AT1 2BC" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_client-email">Client Email</label><input class="input-field w-full p-2 rounded-lg" id="ltr_client-email" placeholder="client@example.com" type="email"/></div></div></div>
<div class="field-group-bg mb-6">
<h3 class="text-lg font-medium text-green-800">Employment &amp; Income</h3>
<div class="dns-field-grid mt-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_employment-summary">Employment</label>
<input class="input-field w-full p-2 rounded-lg" id="ltr_employment-summary" placeholder="e.g. employed / self-employed / other" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_time-in-employment">Time in Employment</label>
<input class="input-field w-full p-2 rounded-lg" id="ltr_time-in-employment" placeholder="e.g. 2 years 3 months" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_net-income-monthly">Regular Net income monthly</label>
<input class="input-field w-full p-2 rounded-lg" id="ltr_net-income-monthly" placeholder="e.g. 2500.00" step="0.01" type="number"/>
</div>
</div>
</div>
<div class="field-group-bg mb-6"><h3 class="text-lg font-medium text-green-800">Current Finance Details</h3><div class="dns-fields-grid mt-4"><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-lender">Current Lender</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-lender" placeholder="e.g., Blackhorse Finance" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-finance-type">Finance Type</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_current-finance-type"><option value="PCP">PCP (Personal Contract Purchase)</option><option value="HP">HP (Hire Purchase)</option><option value="Personal Loan">Personal Loan for Car</option><option value="Other">Other</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-vehicle-price">Original Purchase Price (£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-vehicle-price" placeholder="25000" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-deposit">Original Deposit Paid (£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-deposit" placeholder="5000" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-apr">Current APR (%)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-apr" placeholder="6.9" step="0.1" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-term">Original Term (months)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-term" placeholder="48" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-monthly-payment">Current Monthly Payment (£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-monthly-payment" placeholder="350.00" step="0.01" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-balloon">Current Balloon/GFV(£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-balloon" placeholder="8000" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-agreement-start-date">Current Agreement Start Date</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-agreement-start-date" type="date"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_current-payments-made">Payments Made So Far</label><input class="input-field w-full p-2 rounded-lg" id="ltr_current-payments-made" placeholder="12" type="number"/></div></div></div>
<div class="field-group-bg mb-6"><h3 class="text-lg font-medium text-green-800">New Finance Option</h3><div class="dns-fields-grid mt-4"><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-lender-name">New Lender Name</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-lender-name" placeholder="e.g., Santander Consumer Finance" type="text"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_new-term-type">Type of agreement</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_new-term-type" required=""><option value="">Select (HP / PCP / Other)...</option><option value="HP">HP</option><option value="PCP">PCP</option><option value="Other">Other</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-finance-amount">Finance Amount (Settlement inc.ERC)(£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-finance-amount" placeholder="15000.00" step="0.01" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_early-repayment-charges-paid">ERCs due on Old Agreement(£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_early-repayment-charges-paid" placeholder="0.00" step="0.01" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-additional-cash">Additional Cash Release/Deposit (£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-additional-cash" placeholder="0 (positive for deposit, negative for release)" step="0.01" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-apr">New APR (%)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-apr" placeholder="5.9" step="0.1" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-term">New Term (months)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-term" placeholder="48" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-monthly-payment">New Monthly Payment (£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-monthly-payment" placeholder="320.00" step="0.01" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_new-balloon">New Balloon/GFV(£)</label><input class="input-field w-full p-2 rounded-lg" id="ltr_new-balloon" placeholder="7000" type="number"/></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_potential-commission">Commission(£)</label><input class="input-field w-full p-2 rounded-lg bg-gray-100" id="ltr_potential-commission" placeholder="Auto-calculated" readonly="" type="text"/></div></div></div>
<div class="field-group-bg flex flex-col gap-4"><h3 class="section-heading-styled">Client's Needs &amp; Priorities</h3><div><label class="block text-sm font-medium text-gray-700 mb-1 required" for="ltr_primary-demand-need">Primary Need</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_primary-demand-need" required=""><option value="">Select Primary Need...</option><option value="REDUCE your monthly payment">REDUCE your monthly payment</option><option value="INCREASE your monthly payment to lower the vehicle balance owed">INCREASE your monthly payment to lower the vehicle balance owed</option><option value="EXTEND your Term">EXTEND your Term</option><option value="SHORTEN your Term">SHORTEN your Term</option><option value="an agreement that allowed you to own the car outright at the end of the term">An agreement that allowed you to own the car outright at the end of the term</option><option value="a LOWER Interest Rate">A LOWER Interest Rate</option><option value="DECREASE the overall Total to Pay">DECREASE the overall Total to Pay</option></select></div><div class="hidden flex flex-col gap-2" id="ltr_secondary-demand-need-container"><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_secondary-demand-need">Secondary Need (Optional)</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_secondary-demand-need"><option value="">Select Secondary Need...</option><option value="REDUCE your monthly payment">REDUCE your monthly payment</option><option value="INCREASE your monthly payment to lower the vehicle balance owed">INCREASE your monthly payment to lower the vehicle balance owed</option><option value="EXTEND your Term">EXTEND your Term</option><option value="SHORTEN your Term">SHORTEN your Term</option><option value="an agreement that allowed you to own the car outright at the end of the term">An agreement that allowed you to own the car outright at the end of the term</option><option value="a LOWER Interest Rate">A LOWER Interest Rate</option><option value="DECREASE the overall Total to Pay">DECREASE the overall Total to Pay</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_client-demands-needs">Other Stated Demands and Needs (Free Text)</label><textarea class="textarea-field input-field w-full p-2 rounded-lg" id="ltr_client-demands-needs" placeholder="e.g., Client wishes to reduce monthly outgoings..." rows="3"></textarea></div></div>
<hr class="my-6 border-green-200 border-t-2"/>
<h3 class="section-heading-styled mb-4">How we met Your Needs</h3>
<div class="field-group-bg flex flex-col gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_how-option-meets-needs">How the New Finance Option Addresses Stated Needs</label><textarea class="textarea-field input-field w-full p-2 rounded-lg" id="ltr_how-option-meets-needs" placeholder="e.g., The new finance option provides a lower monthly payment..." rows="3"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_term-change-choice">Client's Choice Regarding Loan Term</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_term-change-choice"><option value="no_change">No significant change in remaining Term</option><option value="extend">Extend term</option><option value="reduce">Reduce term</option></select></div><div class="hidden flex flex-col gap-2" id="ltr_term-extension-reason-section"><label class="block text-sm font-medium text-gray-700" for="ltr_term-extension-reason">Reason for Extending Term</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_term-extension-reason"><option value="">Select reason...</option><option value="To REDUCE monthly payments">To REDUCE monthly payments</option><option value="To LOWER the total to pay">To LOWER the total to pay</option><option value="To EXTEND your use of the vehicle">To EXTEND your use of the vehicle</option><option value="To MATCH when you expect to change/dispose of the Vehicle">To MATCH when you expect to change/dispose of the Vehicle</option><option value="Other">Other (please specify below)</option></select><textarea class="textarea-field input-field w-full hidden p-2 rounded-lg" id="ltr_term-extension-reason-other" placeholder="Specify other reason" rows="2"></textarea></div><div class="hidden flex flex-col gap-2" id="ltr_term-reduction-reason-section"><label class="block text-sm font-medium text-gray-700" for="ltr_term-reduction-reason">Reason for Reducing Term</label><select class="select-field input-field w-full p-2 rounded-lg" id="ltr_term-reduction-reason"><option value="">Select reason...</option><option value="Buy/exchange vehicle sooner">Intends to buy/exchange vehicle sooner</option><option value="New job">New job circumstances</option><option value="Family reasons">Family reasons</option><option value="Lifestyle change">Lifestyle change</option><option value="Pay off quicker">Wishes to pay off finance quicker</option><option value="Other">Other (please specify below)</option></select><textarea class="textarea-field input-field w-full hidden p-2 rounded-lg" id="ltr_term-reduction-reason-other" placeholder="Specify other reason" rows="2"></textarea></div><div><label class="block text-sm font-medium text-gray-700 mb-1" for="ltr_client-specific-choices-rationale">Other Specific Client Choices &amp; Rationale</label><textarea class="textarea-field input-field w-full p-2 rounded-lg" id="ltr_client-specific-choices-rationale" placeholder="Detail any other specific requests..." rows="3"></textarea></div></div>
<div class="field-group-bg company-details-compact mt-6"><h3 class="text-lg font-medium text-green-800 mb-3">Company Details for Letter</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-trading-name">Trading Name</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-trading-name" type="text" value="Compare My Finance"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-legal-name">Legal Name</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-legal-name" type="text" value="Abundance Finance Ltd"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-address1">Address 1</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-address1" type="text" value="349 Fleet Road"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-address2">Address 2 / Town</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-address2" type="text" value="Fleet"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-postcode">Postcode</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-postcode" type="text" value="GU51 3NT"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-email">Email</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-email" type="email" value="info@comparemyfinance.co.uk"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-fca-number">FCA Number</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-fca-number" type="text" value="926161"/></div><div><label class="block text-xs font-medium text-gray-700" for="ltr_company-number">Company Number</label><input class="input-field w-full text-sm rounded-md" id="ltr_company-number" type="text" value="12588565"/></div></div></div>
</div>
<div class="bg-white rounded-xl p-0 shadow-lg border border-gray-200 sticky top-8 self-start">
<div class="flex justify-between items-center p-4 border-b border-gray-200">
<h2 class="text-2xl font-semibold text-green-800 border-none p-0">Letter Preview</h2>
<div class="flex items-center"><p class="hidden text-xs text-red-600 mr-2" id="print-reminder">Complete checklist to enable print.</p><button class="print-button font-medium py-2 px-4 rounded-lg transition-all duration-300" id="ltr_print-letter-btn">Print Letter</button></div>
</div>
<div class="letter-preview overflow-y-auto max-h-[1200px]" id="ltr_letter-preview-content"><p class="text-gray-500"><em>Letter will appear here as you fill in the details.</em></p></div>
</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="sales-pipeline-crm" style="display:block;">
<nav class="top-nav w-full flex justify-center items-center p-2 flex-shrink-0">
<div class="absolute right-4 text-sm font-medium text-white transition-opacity duration-500 opacity-0 pointer-events-none" id="nav-message-area"><span id="nav-message-text"></span></div>
<div class="flex items-center space-x-4"><button class="nav-tab active w-14 h-14 flex items-center justify-center rounded-xl text-white hover:bg-green-700 transition-colors" data-view="pipeline" title="Sales Pipeline"><i class="fas fa-briefcase text-2xl"></i></button><button class="nav-tab w-14 h-14 flex items-center justify-center rounded-xl text-white hover:bg-green-700 transition-colors" data-view="forecasting" title="Forecasting"><i class="fas fa-chart-line text-2xl"></i></button><button class="nav-tab w-14 h-14 flex items-center justify-center rounded-xl text-white hover:bg-green-700 transition-colors" data-view="contacts" title="Contacts"><i class="fas fa-address-book text-2xl"></i></button><button class="nav-tab w-14 h-14 flex items-center justify-center rounded-xl text-white hover:bg-green-700 transition-colors" data-view="data" title="Data Management"><i class="fas fa-database text-2xl"></i></button></div>
</nav>
<header class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white flex-shrink-0">
<div class="flex items-center space-x-2" id="title-and-buttons-wrapper"><h1 class="text-3xl font-bold text-gray-800" id="pageTitle">Sales Pipeline</h1></div>
<!-- DEBUG/OBSERVABILITY: “Jigsaw response” status panel. Shows last server/API response for the active deal (status + reference + raw/summary). Safe to hide for production; keep for troubleshooting. -->
</header>
<div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto bg-[var(--pale-green)]" id="app">
<div class="view" id="pipeline-view">
<div class="w-full max-w-xl mb-3 px-1 flex flex-col sm:flex-row sm:space-x-2" id="kanban-toolbar">
<div class="w-full sm:w-1/2 mb-2 sm:mb-0">
<label class="sr-only" for="surnameSearch">Search surname</label>
<input aria-label="Search surname across all deal stages" autocomplete="off" class="w-full px-3 py-2 border rounded-lg" id="surnameSearch" inputmode="text" name="surnameSearch" placeholder="Search surname…" type="search"/>
</div>
<div class="w-full sm:w-1/2">
<label class="sr-only" for="expertSearch">Search expert</label>
<input aria-label="Search expert across all deal stages" autocomplete="off" class="w-full px-3 py-2 border rounded-lg" id="expertSearch" inputmode="text" name="expertSearch" placeholder="Search expert…" type="search"/>
</div>
</div>
<div class="flex overflow-x-auto space-x-4 pb-4" id="kanban-board"></div>
</div>
<div class="view hidden" id="contacts-view">
<div class="mb-4 flex justify-between items-center">
<div class="relative w-full max-w-md"><input class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-offset-2 focus:ring-green-800" id="contactSearch" placeholder="Search contacts..." type="text"/><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
<div class="hidden" id="contacts-actions"><button class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-colors ml-4" id="delete-selected-btn"><i class="fas fa-trash mr-2"></i>Delete Selected</button></div>
</div>
<div class="bg-white shadow-md rounded-lg overflow-hidden">
<div class="overflow-x-auto">
<table class="w-full divide-y divide-gray-200" id="contacts-table">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-left"><input id="select-all-contacts" type="checkbox"/></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="receivedDate">Received Date <span class="sort-indicator">▼</span></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="referer">Referer <span class="sort-indicator">▼</span></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="vrn">VRN <span class="sort-indicator">▼</span></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="firstName">First Name <span class="sort-indicator">▼</span></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="lastName">Last Name <span class="sort-indicator">▼</span></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="phone">Phone Number <span class="sort-indicator">▼</span></th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="settlementTotal">Value <span class="sort-indicator">▼</span></th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200" id="contacts-list"></tbody>
</table>
</div>
</div>
</div>
<div class="view hidden" id="forecasting-view"><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold text-gray-800 mb-4">Projected Revenue (Next 3 Months)</h2><div class="space-y-4" id="projected-revenue-chart"></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold text-gray-800 mb-4">Previous 3 Months Performance</h2><div class="space-y-4" id="previous-performance-chart"></div></div></div></div>
<div class="view hidden" id="data-view"><div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl mx-auto space-y-8" id="data-content"><h2 class="text-2xl font-bold text-gray-800 mb-4">Data Management</h2><div class="bg-green-50 border-l-4 border-green-400 text-green-800 p-4 rounded-md flex items-center justify-between"><div class="flex items-center space-x-2"><i class="fas fa-circle" id="connection-status-icon"></i><p class="font-bold" id="connection-status-text">Connection Status: Checking...</p></div></div><div class="bg-white p-6 rounded-lg shadow-md border mt-8"><h3 class="text-xl font-semibold mb-4 text-gray-700">Import/Export Data</h3><label class="custom-file-upload" for="importFile"><i class="fas fa-file-excel text-4xl text-gray-400"></i><p class="mt-2 text-gray-600">Click to import Excel file</p><p class="text-sm text-gray-500 mt-1" id="fileName"></p></label><input accept=".xls, .xlsx" id="importFile" type="file"/><div class="mt-4 text-sm" id="status-message"></div><div class="flex justify-end mt-4 space-x-2"><button class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled="" id="importButton"><i class="fas fa-file-import"></i><span>Import Data</span></button><button class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2" id="exportButton"><i class="fas fa-file-export"></i><span>Export Data</span></button></div></div></div></div>
</div>
<div class="fixed inset-0 bg-black/60 items-center justify-center hidden z-50" id="manageStagesModal"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 text-gray-800"><h2 class="text-xl font-bold mb-4">Manage Sales Stages</h2><div class="space-y-2 mb-4" id="stage-list"></div><button class="text-green-700 font-semibold hover:text-green-800 transition-colors mb-4" id="addStageBtn">+ Add Stage</button><div class="flex justify-end space-x-3"><button class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors" id="cancelStages">Cancel</button><button class="bg-[var(--gold-orange)] text-white font-semibold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity" id="saveStages">Save Changes</button></div></div></div>
<div class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4" id="customerModal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-6xl text-gray-800 flex flex-col">
<div class="relative flex items-center gap-3 p-4 border-b sticky top-0 bg-white z-40">
<h2 class="text-xl font-bold truncate pr-28 min-w-0" id="modalTitle">Application</h2>
<div class="absolute right-4 top-4 flex items-center gap-2 z-50" id="customerModalTopActions">
<button class="flex items-center gap-2 text-sm font-semibold px-3 py-1.5 rounded-lg border border-gray-200 bg-white shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" id="closeCustomerModal" type="button">
<span>Close</span><span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-50"><i class="fas fa-times text-red-600"></i></span>
</button>
</div>
</div>
<form class="p-6 space-y-6 modal-content modal-body-scroll" id="customerForm"><input id="dealId" type="hidden"/></form>
<div class="flex items-center justify-between p-4 border-t gap-3"><div class="text-sm text-gray-600 flex-1 space-y-1" id="lenderStatuses"><div>Jigsaw: <span class="font-semibold text-gray-700" id="jigsawStatusText">Not sent</span></div><div>CarMoney: <span class="font-semibold text-gray-700" id="carMoneyStatusText">Not sent</span></div><div>CF247: <span class="font-semibold text-gray-700" id="cf247StatusText">Not sent</span></div></div><div class="flex-[2] flex flex-wrap sm:flex-nowrap justify-center gap-2 w-full"><button class="bg-white text-[#001f3f] border border-[#001f3f] font-semibold rounded-lg hover:bg-slate-50 transition-colors px-2 py-1.5 flex flex-col items-center justify-center leading-tight flex-1 min-w-[120px] sm:min-w-0 text-center" id="validateJigsawBtn" title="Validate application with Jigsaw (no submission)" type="button"><span class="text-[0.65rem] font-semibold opacity-90">VALIDATE</span><span class="text-[0.85rem] font-semibold break-words">JIGSAW</span></button><button class="bg-[#001f3f] text-white font-semibold rounded-lg hover:opacity-90 transition-opacity px-2 py-1.5 flex flex-col items-center justify-center leading-tight flex-1 min-w-[120px] sm:min-w-0 text-center" id="sendJigsawBtn" title="Send full application to Jigsaw" type="button"><span class="text-[0.65rem] font-semibold opacity-90">SEND</span><span class="text-[0.85rem] font-semibold break-words">JIGSAW</span></button><button class="bg-green-600 text-white font-semibold rounded-lg hover:opacity-90 transition-opacity px-2 py-1.5 flex flex-col items-center justify-center leading-tight flex-1 min-w-[120px] sm:min-w-0 text-center" id="sendCarMoneyBtn" title="Placeholder - not yet wired" type="button"><span class="text-[0.65rem] font-semibold opacity-90">SEND</span><span class="text-[0.85rem] font-semibold break-words">CARMONEY</span></button><button class="bg-purple-600 text-white font-semibold rounded-lg hover:opacity-90 transition-opacity px-2 py-1.5 flex flex-col items-center justify-center leading-tight flex-1 min-w-[120px] sm:min-w-0 text-center" id="sendCF247Btn" title="Placeholder - not yet wired" type="button"><span class="text-[0.65rem] font-semibold opacity-90">SEND</span><span class="text-[0.85rem] font-semibold break-words">CF247</span></button>
<button class="bg-gray-700 text-white font-semibold rounded-lg hover:opacity-90 transition-opacity px-2 py-1 flex flex-col items-center justify-center leading-tight flex-1 min-w-[110px] sm:min-w-0 text-center" id="printApplicationPdfBtn" title="Generate a PDF of the full application" type="button">
<span class="text-[0.6rem] font-semibold opacity-90">PRINT</span>
<span class="text-[0.8rem] font-semibold break-words">PDF</span>
</button>
</div><div class="flex-1 flex justify-end gap-3"><button class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden" id="deleteDealBtn" type="button">Delete</button><button class="bg-[var(--gold-orange)] text-white font-semibold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity" id="saveDealBtn" type="button">Save Deal</button></div></div></div></div>
<div class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50" id="confirmModal"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4 text-gray-800"><h2 class="text-lg font-bold mb-4" id="confirmTitle">Are you sure?</h2><p class="text-gray-600 mb-6" id="confirmMessage">This action cannot be undone.</p><div class="flex justify-end space-x-3"><button class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors" id="confirmCancel">Cancel</button><button class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors" id="confirmAction">Confirm</button></div></div></div>
<div class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50" id="duplicateModal"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 text-gray-800 flex flex-col max-h-[90vh]"><h2 class="text-xl font-bold mb-2">Duplicate Check</h2><p class="text-gray-600 mb-4">Found <span id="duplicateCount"></span> duplicates based on VRN. Do you want to skip them and import the unique contacts?</p><div class="flex-1 overflow-y-auto border rounded-lg p-2 modal-body-scroll"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">VRN</th><th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th></tr></thead><tbody class="bg-white divide-y divide-gray-200" id="duplicateList"></tbody></table></div><div class="flex justify-end space-x-3 mt-6"><button class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors" id="cancelDuplicate">Cancel</button><button class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-opacity" id="importAllBtn">Import All</button><button class="bg-[var(--gold-orange)] text-white font-semibold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity" id="confirmDuplicate">Skip &amp; Import</button></div></div></div>
</div>
<div class="tab-content p-4 sm:p-6 lg:p-8" id="twilio-flex" style="display:none;">
<div class="max-w-[1700px] mx-auto">
<div class="rounded-2xl overflow-hidden border border-gray-200 shadow bg-white">
<!-- TAB: Twilio Flex (placeholder). UI skeleton only (no backend wiring). If you connect Twilio later, implement handlers without breaking existing tab switching. -->
<div class="px-4 py-3 flex items-center justify-between text-white" style="background:#0b0b3b;">
<div class="flex items-center gap-3">
<div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center">
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M4 6h16M4 12h10M4 18h16" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
</svg>
</div>
<div class="font-semibold tracking-wide">TWILIO FLEX</div>
</div>
<div class="flex items-center gap-3">
<div class="hidden sm:flex items-center gap-2 text-sm">
<span class="inline-flex items-center gap-2 bg-white/10 rounded-full px-3 py-1">
<span class="w-2 h-2 rounded-full bg-green-400"></span>
              Available
              <span class="opacity-80">13:04</span>
</span>
</div>
<div class="w-8 h-8 rounded-full bg-white/15 flex items-center justify-center font-semibold">KM</div>
</div>
</div>
<div class="flex min-h-[900px] bg-gray-50">
<!-- SALES PIPELINE TAB: Left rail navigation + application list (Kanban/queue). Key IDs used by JS: #applicationsList, #pipelineBoard, #searchInput (verify in code below). -->
<aside class="w-[380px] bg-white border-r flex">
<div class="w-14 bg-gray-50 border-r flex flex-col items-center py-4 gap-4">
<button class="w-9 h-9 rounded-lg bg-white shadow-sm border flex items-center justify-center" title="Menu">
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
</svg>
</button>
<button class="w-9 h-9 rounded-lg bg-white shadow-sm border flex items-center justify-center" title="Applications">
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M7 7h10M7 11h10M7 15h6" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
<path d="M6 3h12a2 2 0 0 1 2 2v14l-3-2-3 2-3-2-3 2-3-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<button class="w-9 h-9 rounded-lg bg-white shadow-sm border flex items-center justify-center" title="Insights">
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M4 19V5M4 19h16" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
<path d="M7 15l3-4 3 2 4-6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<button class="w-9 h-9 rounded-lg bg-white shadow-sm border flex items-center justify-center" title="Settings">
<svg aria-hidden="true" fill="none" height="18" viewbox="0 0 24 24" width="18">
<path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"></path>
<path d="M19.4 15a7.96 7.96 0 0 0 .1-1 7.96 7.96 0 0 0-.1-1l2.1-1.6-2-3.4-2.5 1a7.5 7.5 0 0 0-1.7-1l-.4-2.7H9.1l-.4 2.7a7.5 7.5 0 0 0-1.7 1l-2.5-1-2 3.4L4.6 13a7.96 7.96 0 0 0-.1 1 7.96 7.96 0 0 0 .1 1L2.5 16.6l2 3.4 2.5-1a7.5 7.5 0 0 0 1.7 1l.4 2.7h5.8l.4-2.7a7.5 7.5 0 0 0 1.7-1l2.5 1 2-3.4L19.4 15Z" stroke="currentColor" stroke-linejoin="round" stroke-width="1.6"></path>
</svg>
</button>
</div>
<div class="flex-1">
<div class="px-4 py-3 border-b flex items-center justify-between">
<div class="flex items-center gap-2">
<span class="text-sm font-semibold text-gray-900">All Applications</span>
<span class="text-xs text-gray-500">▼</span>
</div>
<button class="text-sm font-semibold text-blue-600 hover:underline">+ New</button>
</div>
<div class="p-2">
<div class="rounded-xl border bg-white">
<div class="px-3 py-3 flex items-center justify-between hover:bg-gray-50 cursor-pointer">
<div class="flex items-center gap-3">
<div class="w-9 h-9 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-semibold">JS</div>
<div>
<div class="text-sm font-semibold text-gray-900">Jordan Smith</div>
<div class="text-xs text-gray-500">Incoming refinance request</div>
</div>
</div>
<div class="flex items-center gap-2">
<span class="w-6 h-6 rounded-full bg-green-100 text-green-700 flex items-center justify-center text-xs">✓</span>
<span class="w-6 h-6 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-xs">×</span>
</div>
</div>
<div class="border-t"></div>
<div class="px-3 py-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer">
<div class="w-9 h-9 rounded-full bg-gray-100 text-gray-700 flex items-center justify-center font-semibold">AP</div>
<div class="flex-1">
<div class="text-sm font-semibold text-gray-900">Ava Patel</div>
<div class="text-xs text-gray-500 truncate">11:13 | Note: Uploaded payslips &amp; V5C — pending review</div>
</div>
</div>
</div>
<p class="text-xs text-gray-400 mt-3 px-1">UI placeholder only — wire up task/app selection later.</p>
</div>
</div>
</aside>
<!-- SALES PIPELINE TAB: Main workspace where selected application/deal details render. Contains Kanban board + detail panels + modals. -->
<section class="flex-1 flex flex-col">
<div class="bg-white border-b px-6 py-4 flex items-start justify-between">
<div>
<div class="text-lg font-semibold text-gray-900">Jordan Smith</div>
<div class="mt-2 flex items-center gap-6 text-sm">
<button class="pb-2 border-b-2 border-blue-600 text-blue-600 font-semibold">Incoming</button>
<button class="pb-2 text-gray-500">Info</button>
</div>
</div>
<div class="text-sm text-gray-500 pt-1">Queue: Car Refinance</div>
</div>
<div class="flex-1 p-6 grid grid-cols-12 gap-6">
<!-- SALES PIPELINE TAB: “Incoming request” panel. Shows inbound lead/request payload and key computed fields. If changing fields, keep IDs stable for App.handlers.* consumers. -->
<div class="col-span-12 lg:col-span-5 bg-white rounded-2xl border shadow-sm p-6 flex flex-col items-center justify-center text-center">
<div class="w-16 h-16 rounded-2xl bg-blue-50 flex items-center justify-center mb-4">
<svg aria-hidden="true" fill="none" height="28" viewbox="0 0 24 24" width="28">
<path d="M21 11.5a8.5 8.5 0 0 1-8.5 8.5H6l-3 2v-5.5A8.5 8.5 0 0 1 11.5 3H12A9 9 0 0 1 21 11.5Z" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
<path d="M7.5 12h9M7.5 8.5h6" stroke="currentColor" stroke-linecap="round" stroke-width="2"></path>
</svg>
</div>
<div class="uppercase tracking-widest text-xs text-gray-400 mb-2">Incoming Refinance Request</div>
<div class="text-xl font-semibold text-gray-900">Car Refinance Application</div>
<div class="text-sm text-gray-500 mt-2">Applicant: Jordan Smith • Requested agent assistance</div>
<div class="mt-6 w-full max-w-sm text-left">
<div class="rounded-xl border bg-gray-50 p-4">
<div class="text-sm font-semibold text-gray-900 mb-1">Agent prompt (placeholder)</div>
<p class="text-sm text-gray-600">
                    Show scripted guidance, compliance checks, and next-best-actions here.
                    Replace with your workflow components later.
                  </p>
</div>
</div>
</div>
<!-- SALES PIPELINE TAB: Deal detail panel (editable fields, lender statuses, actions). Inputs often use .input-field class for consistent styling. -->
<div class="col-span-12 lg:col-span-7 space-y-6">
<div class="grid grid-cols-12 gap-6">
<!-- SALES PIPELINE TAB: Customer profile card (name/contact/VRN). Mostly read-only; keep semantic grouping for LLM edits. -->
<div class="col-span-12 xl:col-span-5 bg-white rounded-2xl border shadow-sm p-5">
<div class="flex items-start gap-4">
<div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-bold">JS</div>
<div class="flex-1">
<div class="text-lg font-semibold text-gray-900">Jordan Smith</div>
<div class="text-sm text-gray-500 flex items-center gap-2 mt-1">
<span class="inline-flex items-center gap-1 text-yellow-600">
                          ★
                          <span class="text-gray-600">Preferred</span>
</span>
</div>
<div class="mt-3 space-y-2 text-sm text-gray-700">
<div class="flex items-center gap-2"><span class="text-gray-400">✉</span> jordan.smith@email.com</div>
<div class="flex items-center gap-2"><span class="text-gray-400">☎</span> +44 7700 900000</div>
</div>
</div>
</div>
<div class="mt-5 pt-4 border-t">
<div class="text-sm font-semibold text-gray-900 mb-2">Closest Branch</div>
<div class="text-sm text-gray-700">Scorpus Finance Centre</div>
<div class="text-sm text-gray-500">Manchester, UK</div>
</div>
</div>
<!-- SALES PIPELINE TAB: Conversation summary (notes + extracted intent). Used for quick operator context; safe to restructure if IDs/classes preserved. -->
<div class="col-span-12 xl:col-span-7 bg-white rounded-2xl border shadow-sm p-5">
<div class="flex items-start justify-between gap-3">
<div class="text-lg font-semibold text-gray-900">Conversation Summary</div>
<div class="flex items-center gap-2">
<button class="text-sm px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-50">Refresh</button>
<span class="text-xs font-semibold px-3 py-1.5 rounded-full bg-green-50 text-green-700">Sentiment: Positive</span>
</div>
</div>
<p class="mt-3 text-sm text-gray-700 leading-relaxed">
                    Jordan contacted the virtual assistant to refinance an existing car loan.
                    They provided basic details (vehicle, current lender, outstanding balance) and asked for a better APR and monthly payment.
                    The assistant confirmed eligibility checks and then routed the request to a live agent for verification and next steps.
                  </p>
<p class="mt-3 text-xs text-gray-400">
                    Placeholder text — replace with your transcript summariser / AI notes.
                  </p>
</div>
</div>
<div class="grid grid-cols-12 gap-6">
<!-- SALES PIPELINE TAB: Timeline of events / status changes. If you add event types, keep the list rendering function consistent. -->
<div class="col-span-12 xl:col-span-5 bg-white rounded-2xl border shadow-sm p-5">
<div class="text-lg font-semibold text-gray-900 mb-4">Event Timeline</div>
<div class="space-y-4">
<div class="flex gap-3">
<div class="flex flex-col items-center">
<div class="w-8 h-8 rounded-full bg-gray-100 border flex items-center justify-center text-gray-600">•</div>
<div class="w-px flex-1 bg-gray-200 mt-2"></div>
</div>
<div class="flex-1">
<div class="text-sm text-gray-500">1 month ago</div>
<div class="text-sm font-semibold text-gray-900">Application Submitted</div>
<div class="mt-2 rounded-xl border bg-gray-50 p-3">
<div class="text-sm text-gray-700">Requested amount: £12,500</div>
<div class="text-sm text-gray-500">Vehicle: 2019 BMW 3 Series (placeholder)</div>
</div>
</div>
</div>
<div class="flex gap-3">
<div class="flex flex-col items-center">
<div class="w-8 h-8 rounded-full bg-gray-100 border flex items-center justify-center text-gray-600">+</div>
</div>
<div class="flex-1">
<div class="text-sm text-gray-500">Today</div>
<div class="text-sm font-semibold text-gray-900">Agent Review</div>
<div class="text-sm text-gray-500 mt-1">Awaiting document validation &amp; affordability checks.</div>
</div>
</div>
</div>
</div>
<!-- SALES PIPELINE TAB: Application history / audit trail. Useful for debugging and compliance; avoid removing fields without updating export logic. -->
<div class="col-span-12 xl:col-span-7 bg-white rounded-2xl border shadow-sm p-5 overflow-x-auto">
<div class="text-lg font-semibold text-gray-900 mb-4">Application History</div>
<table class="w-full text-sm">
<thead class="text-left text-gray-500">
<tr class="border-b">
<th class="py-2 pr-4 font-semibold">Application ID</th>
<th class="py-2 pr-4 font-semibold">Status</th>
<th class="py-2 pr-4 font-semibold">Amount</th>
<th class="py-2 pr-4 font-semibold">Vehicle</th>
<th class="py-2 font-semibold">Date</th>
</tr>
</thead>
<tbody class="text-gray-700">
<tr class="border-b">
<td class="py-3 pr-4">#RF-1250</td>
<td class="py-3 pr-4"><span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700">Approved</span></td>
<td class="py-3 pr-4">£12,500</td>
<td class="py-3 pr-4">BMW 3 Series</td>
<td class="py-3">Jul 2, 2025</td>
</tr>
<tr class="border-b">
<td class="py-3 pr-4">#RF-1113</td>
<td class="py-3 pr-4"><span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700">In Review</span></td>
<td class="py-3 pr-4">£9,750</td>
<td class="py-3 pr-4">VW Golf</td>
<td class="py-3">Jun 30, 2025</td>
</tr>
<tr class="border-b">
<td class="py-3 pr-4">#RF-1045</td>
<td class="py-3 pr-4"><span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">Completed</span></td>
<td class="py-3 pr-4">£7,200</td>
<td class="py-3 pr-4">Ford Focus</td>
<td class="py-3">May 13, 2025</td>
</tr>
<tr>
<td class="py-3 pr-4">#RF-0998</td>
<td class="py-3 pr-4"><span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-700">Cancelled</span></td>
<td class="py-3 pr-4">£10,000</td>
<td class="py-3 pr-4">Audi A3</td>
<td class="py-3">Mar 20, 2025</td>
</tr>
</tbody>
</table>
<p class="text-xs text-gray-400 mt-3">Placeholder data — connect to your application store later.</p>
</div>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
</div>
<div class="tab-content" id="comparison-calculator" style="display:none;">
<div class="w-full">
<div class="bg-white rounded-2xl shadow p-0 md:p-0">
<div class="w-full" id="comparison-calculator-root" style="min-height: 780px;">
<div class="w-full">
<div class="rounded-xl overflow-hidden border border-[var(--racing-line,#cfe6dc)] shadow" style="height: 1200px;">
<iframe id="calc-v18-iframe" style="width:100%;height:100%;border:0;background:white;" title="Intelligent Refinance Calculator"></iframe>
</div>
<p class="text-xs text-gray-500 mt-2"></p>
</div>
<template id="calc-v18-srcdoc"><!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>CMF Intelligent Refinance Calculator — v1</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>


<style>
    :root{
      --racing:#004225; --racing-ink:#002915; --racing-mint:#e9f5ef; --racing-line:#cfe6dc;
      --wm-size:360px; --wm-opacity:.12; --wm-fade-ms:12000;
    }
    body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,rgba(0,66,37,.06),transparent) fixed}
    .card{box-shadow:0 16px 40px rgba(0,66,37,.12); background:linear-gradient(145deg,#ffffff,#f3f8f6)}
    .ribbon{background:linear-gradient(90deg,var(--racing),#0a5b36);color:#fff}
    .input-field{border:1.5px solid var(--racing-line)}
    .input-field:focus{border-color:var(--racing); box-shadow:0 0 0 4px rgba(0,66,37,.15); outline:none}
    .pill{border:1.5px solid var(--racing); color:var(--racing); background:#fff; transition:all .15s}
    .pill.active{background:var(--racing); color:#fff}
    .btn-green{background:var(--racing); color:#fff; border:1.5px solid var(--racing);
      border-radius:.75rem; padding:.6rem 1rem; font-weight:600; box-shadow:0 6px 18px rgba(0,66,37,.22)}
    .btn-green:hover{background:#0a5b36}
    .badge{padding:2px 8px; border-radius:10px; line-height:1.8; font-weight:600}
    .badge.good{background:rgba(0,66,37,.14); color:var(--racing)}
    .badge.warn{background:rgba(255,165,0,.18); color:#8a5500}
    .badge.bad{ background:rgba(220,38,38,.12); color:#991b1b}
    .muted{color:rgba(0,0,0,.62)}
    .wm-layer{position:fixed; inset:0; background-position:0 0; background-repeat:repeat; background-size:var(--wm-size) auto;
      background-attachment:fixed; opacity:0; filter:saturate(0) contrast(1.15); pointer-events:none; z-index:0;
      transition:opacity calc(var(--wm-fade-ms) * 1ms) ease; image-rendering:crisp-edges}
    .z-content{position:relative; z-index:1}
    /* Pastel green fill for inputs */
    input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]):not([type="button"]):not([type="submit"]):not([type="range"]):not([type="color"]),
    select, textarea {
      background-color: #EAFBF2 !important;
    }
    .soft-panel{background:rgba(255,255,255,.72)}
    .divider{border-top:1px solid var(--racing-line)}
    .mono{font-variant-numeric: tabular-nums;}
  </style>
<style id="tailwind-built">
/*! tailwindcss v4.2.0 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0;--tw-rotate-x:initial;--tw-rotate-y:initial;--tw-rotate-z:initial;--tw-skew-x:initial;--tw-skew-y:initial;--tw-space-y-reverse:0;--tw-space-x-reverse:0;--tw-divide-y-reverse:0;--tw-border-style:solid;--tw-leading:initial;--tw-font-weight:initial;--tw-tracking:initial;--tw-shadow:0 0 #0000;--tw-shadow-color:initial;--tw-shadow-alpha:100%;--tw-inset-shadow:0 0 #0000;--tw-inset-shadow-color:initial;--tw-inset-shadow-alpha:100%;--tw-ring-color:initial;--tw-ring-shadow:0 0 #0000;--tw-inset-ring-color:initial;--tw-inset-ring-shadow:0 0 #0000;--tw-ring-inset:initial;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-offset-shadow:0 0 #0000;--tw-outline-style:solid;--tw-blur:initial;--tw-brightness:initial;--tw-contrast:initial;--tw-grayscale:initial;--tw-hue-rotate:initial;--tw-invert:initial;--tw-opacity:initial;--tw-saturate:initial;--tw-sepia:initial;--tw-drop-shadow:initial;--tw-drop-shadow-color:initial;--tw-drop-shadow-alpha:100%;--tw-drop-shadow-size:initial;--tw-backdrop-blur:initial;--tw-backdrop-brightness:initial;--tw-backdrop-contrast:initial;--tw-backdrop-grayscale:initial;--tw-backdrop-hue-rotate:initial;--tw-backdrop-invert:initial;--tw-backdrop-opacity:initial;--tw-backdrop-saturate:initial;--tw-backdrop-sepia:initial;--tw-duration:initial}}}@layer theme{:root,:host{--font-sans:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";--font-mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;--color-red-50:oklch(97.1% .013 17.38);--color-red-100:oklch(93.6% .032 17.717);--color-red-200:oklch(88.5% .062 18.334);--color-red-300:oklch(80.8% .114 19.571);--color-red-400:oklch(70.4% .191 22.216);--color-red-500:oklch(63.7% .237 25.331);--color-red-600:oklch(57.7% .245 27.325);--color-red-700:oklch(50.5% .213 27.518);--color-red-800:oklch(44.4% .177 26.899);--color-orange-600:oklch(64.6% .222 41.116);--color-amber-50:oklch(98.7% .022 95.277);--color-amber-100:oklch(96.2% .059 95.617);--color-yellow-50:oklch(98.7% .026 102.212);--color-yellow-100:oklch(97.3% .071 103.193);--color-yellow-200:oklch(94.5% .129 101.54);--color-yellow-300:oklch(90.5% .182 98.111);--color-yellow-400:oklch(85.2% .199 91.936);--color-yellow-500:oklch(79.5% .184 86.047);--color-yellow-600:oklch(68.1% .162 75.834);--color-yellow-700:oklch(55.4% .135 66.442);--color-yellow-800:oklch(47.6% .114 61.907);--color-green-50:oklch(98.2% .018 155.826);--color-green-100:oklch(96.2% .044 156.743);--color-green-200:oklch(92.5% .084 155.995);--color-green-400:oklch(79.2% .209 151.711);--color-green-500:oklch(72.3% .219 149.579);--color-green-600:oklch(62.7% .194 149.214);--color-green-700:oklch(52.7% .154 150.069);--color-green-800:oklch(44.8% .119 151.328);--color-green-900:oklch(39.3% .095 152.535);--color-teal-50:oklch(98.4% .014 180.72);--color-teal-100:oklch(95.3% .051 180.801);--color-cyan-400:oklch(78.9% .154 211.53);--color-cyan-600:oklch(60.9% .126 221.723);--color-cyan-700:oklch(52% .105 223.128);--color-cyan-900:oklch(39.8% .07 227.392);--color-blue-50:oklch(97% .014 254.604);--color-blue-100:oklch(93.2% .032 255.585);--color-blue-200:oklch(88.2% .059 254.128);--color-blue-300:oklch(80.9% .105 251.813);--color-blue-500:oklch(62.3% .214 259.815);--color-blue-600:oklch(54.6% .245 262.881);--color-blue-700:oklch(48.8% .243 264.376);--color-blue-800:oklch(42.4% .199 265.638);--color-indigo-100:oklch(93% .034 272.788);--color-indigo-700:oklch(45.7% .24 277.023);--color-purple-50:oklch(97.7% .014 308.299);--color-purple-100:oklch(94.6% .033 307.174);--color-purple-600:oklch(55.8% .288 302.321);--color-rose-50:oklch(96.9% .015 12.422);--color-rose-100:oklch(94.1% .03 12.58);--color-slate-50:oklch(98.4% .003 247.858);--color-slate-600:oklch(44.6% .043 257.281);--color-slate-700:oklch(37.2% .044 257.287);--color-slate-800:oklch(27.9% .041 260.031);--color-slate-900:oklch(20.8% .042 265.755);--color-slate-950:oklch(12.9% .042 264.695);--color-gray-50:oklch(98.5% .002 247.839);--color-gray-100:oklch(96.7% .003 264.542);--color-gray-200:oklch(92.8% .006 264.531);--color-gray-300:oklch(87.2% .01 258.338);--color-gray-400:oklch(70.7% .022 261.325);--color-gray-500:oklch(55.1% .027 264.364);--color-gray-600:oklch(44.6% .03 256.802);--color-gray-700:oklch(37.3% .034 259.733);--color-gray-800:oklch(27.8% .033 256.848);--color-gray-900:oklch(21% .034 264.665);--color-black:#000;--color-white:#fff;--spacing:.25rem;--container-sm:24rem;--container-md:28rem;--container-xl:36rem;--container-2xl:42rem;--container-4xl:56rem;--container-6xl:72rem;--container-7xl:80rem;--text-xs:.75rem;--text-xs--line-height:calc(1 / .75);--text-sm:.875rem;--text-sm--line-height:calc(1.25 / .875);--text-base:1rem;--text-base--line-height:calc(1.5 / 1);--text-lg:1.125rem;--text-lg--line-height:calc(1.75 / 1.125);--text-xl:1.25rem;--text-xl--line-height:calc(1.75 / 1.25);--text-2xl:1.5rem;--text-2xl--line-height:calc(2 / 1.5);--text-3xl:1.875rem;--text-3xl--line-height:calc(2.25 / 1.875);--text-4xl:2.25rem;--text-4xl--line-height:calc(2.5 / 2.25);--font-weight-medium:500;--font-weight-semibold:600;--font-weight-bold:700;--font-weight-extrabold:800;--tracking-wide:.025em;--tracking-wider:.05em;--tracking-widest:.1em;--leading-tight:1.25;--leading-snug:1.375;--leading-relaxed:1.625;--radius-md:.375rem;--radius-lg:.5rem;--radius-xl:.75rem;--radius-2xl:1rem;--animate-pulse:pulse 2s cubic-bezier(.4, 0, .6, 1) infinite;--animate-bounce:bounce 1s infinite;--blur-sm:8px;--default-transition-duration:.15s;--default-transition-timing-function:cubic-bezier(.4, 0, .2, 1);--default-font-family:var(--font-sans);--default-mono-font-family:var(--font-mono)}}@layer base{*,:after,:before,::backdrop{box-sizing:border-box;border:0 solid;margin:0;padding:0}::file-selector-button{box-sizing:border-box;border:0 solid;margin:0;padding:0}html,:host{-webkit-text-size-adjust:100%;tab-size:4;line-height:1.5;font-family:var(--default-font-family,ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji");font-feature-settings:var(--default-font-feature-settings,normal);font-variation-settings:var(--default-font-variation-settings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:var(--default-mono-font-family,ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace);font-feature-settings:var(--default-mono-font-feature-settings,normal);font-variation-settings:var(--default-mono-font-variation-settings,normal);font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}:-moz-focusring{outline:auto}progress{vertical-align:baseline}summary{display:list-item}ol,ul,menu{list-style:none}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}button,input,select,optgroup,textarea{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}::file-selector-button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}:where(select:is([multiple],[size])) optgroup{font-weight:bolder}:where(select:is([multiple],[size])) optgroup option{padding-inline-start:20px}::file-selector-button{margin-inline-end:4px}::placeholder{opacity:1}@supports (not ((-webkit-appearance:-apple-pay-button))) or (contain-intrinsic-size:1px){::placeholder{color:currentColor}@supports (color:color-mix(in lab, red, red)){::placeholder{color:color-mix(in oklab, currentcolor 50%, transparent)}}}textarea{resize:vertical}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-date-and-time-value{min-height:1lh;text-align:inherit}::-webkit-datetime-edit{display:inline-flex}::-webkit-datetime-edit-fields-wrapper{padding:0}::-webkit-datetime-edit{padding-block:0}::-webkit-datetime-edit-year-field{padding-block:0}::-webkit-datetime-edit-month-field{padding-block:0}::-webkit-datetime-edit-day-field{padding-block:0}::-webkit-datetime-edit-hour-field{padding-block:0}::-webkit-datetime-edit-minute-field{padding-block:0}::-webkit-datetime-edit-second-field{padding-block:0}::-webkit-datetime-edit-millisecond-field{padding-block:0}::-webkit-datetime-edit-meridiem-field{padding-block:0}::-webkit-calendar-picker-indicator{line-height:1}:-moz-ui-invalid{box-shadow:none}button,input:where([type=button],[type=reset],[type=submit]){appearance:button}::file-selector-button{appearance:button}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[hidden]:where(:not([hidden=until-found])){display:none!important}}@layer components;@layer utilities{.pointer-events-none{pointer-events:none}.collapse{visibility:collapse}.visible{visibility:visible}.sr-only{clip-path:inset(50%);white-space:nowrap;border-width:0;width:1px;height:1px;margin:-1px;padding:0;position:absolute;overflow:hidden}.absolute{position:absolute}.fixed{position:fixed}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:calc(var(--spacing) * 0)}.start{inset-inline-start:var(--spacing)}.end{inset-inline-end:var(--spacing)}.top-0{top:calc(var(--spacing) * 0)}.top-1{top:calc(var(--spacing) * 1)}.top-1\/2{top:50%}.top-2\.5{top:calc(var(--spacing) * 2.5)}.top-4{top:calc(var(--spacing) * 4)}.top-8{top:calc(var(--spacing) * 8)}.right-0{right:calc(var(--spacing) * 0)}.right-3{right:calc(var(--spacing) * 3)}.right-4{right:calc(var(--spacing) * 4)}.right-5{right:calc(var(--spacing) * 5)}.bottom-5{bottom:calc(var(--spacing) * 5)}.bottom-24{bottom:calc(var(--spacing) * 24)}.left-1{left:calc(var(--spacing) * 1)}.left-3{left:calc(var(--spacing) * 3)}.z-0{z-index:0}.z-10{z-index:10}.z-20{z-index:20}.z-40{z-index:40}.z-50{z-index:50}.z-\[9999\]{z-index:9999}.col-span-12{grid-column:span 12/span 12}.col-start-1{grid-column-start:1}.col-start-6{grid-column-start:6}.col-end-8{grid-column-end:8}.col-end-13{grid-column-end:13}.container{width:100%}@media (min-width:40rem){.container{max-width:40rem}}@media (min-width:48rem){.container{max-width:48rem}}@media (min-width:64rem){.container{max-width:64rem}}@media (min-width:80rem){.container{max-width:80rem}}@media (min-width:96rem){.container{max-width:96rem}}.-mx-2{margin-inline:calc(var(--spacing) * -2)}.mx-4{margin-inline:calc(var(--spacing) * 4)}.mx-auto{margin-inline:auto}.my-4{margin-block:calc(var(--spacing) * 4)}.my-6{margin-block:calc(var(--spacing) * 6)}.-mt-1{margin-top:calc(var(--spacing) * -1)}.-mt-px{margin-top:-1px}.mt-0{margin-top:calc(var(--spacing) * 0)}.mt-0\.5{margin-top:calc(var(--spacing) * .5)}.mt-1{margin-top:calc(var(--spacing) * 1)}.mt-2{margin-top:calc(var(--spacing) * 2)}.mt-3{margin-top:calc(var(--spacing) * 3)}.mt-4{margin-top:calc(var(--spacing) * 4)}.mt-5{margin-top:calc(var(--spacing) * 5)}.mt-6{margin-top:calc(var(--spacing) * 6)}.mt-8{margin-top:calc(var(--spacing) * 8)}.mt-\[0\.2375rem\]{margin-top:.2375rem}.mr-2{margin-right:calc(var(--spacing) * 2)}.mr-3{margin-right:calc(var(--spacing) * 3)}.mb-1{margin-bottom:calc(var(--spacing) * 1)}.mb-2{margin-bottom:calc(var(--spacing) * 2)}.mb-3{margin-bottom:calc(var(--spacing) * 3)}.mb-4{margin-bottom:calc(var(--spacing) * 4)}.mb-5{margin-bottom:calc(var(--spacing) * 5)}.mb-6{margin-bottom:calc(var(--spacing) * 6)}.mb-8{margin-bottom:calc(var(--spacing) * 8)}.mb-10{margin-bottom:calc(var(--spacing) * 10)}.ml-2{margin-left:calc(var(--spacing) * 2)}.ml-3{margin-left:calc(var(--spacing) * 3)}.ml-4{margin-left:calc(var(--spacing) * 4)}.block{display:block}.contents{display:contents}.flex{display:flex}.grid{display:grid}.hidden{display:none}.inline{display:inline}.inline-block{display:inline-block}.inline-flex{display:inline-flex}.table{display:table}.h-2{height:calc(var(--spacing) * 2)}.h-2\.5{height:calc(var(--spacing) * 2.5)}.h-4{height:calc(var(--spacing) * 4)}.h-5{height:calc(var(--spacing) * 5)}.h-6{height:calc(var(--spacing) * 6)}.h-8{height:calc(var(--spacing) * 8)}.h-9{height:calc(var(--spacing) * 9)}.h-10{height:calc(var(--spacing) * 10)}.h-12{height:calc(var(--spacing) * 12)}.h-14{height:calc(var(--spacing) * 14)}.h-16{height:calc(var(--spacing) * 16)}.h-20{height:calc(var(--spacing) * 20)}.h-24{height:calc(var(--spacing) * 24)}.h-48{height:calc(var(--spacing) * 48)}.h-64{height:calc(var(--spacing) * 64)}.h-\[24\.7px\]{height:24.7px}.h-full{height:100%}.h-screen{height:100vh}.max-h-\[90vh\]{max-height:90vh}.max-h-\[1200px\]{max-height:1200px}.min-h-0{min-height:calc(var(--spacing) * 0)}.min-h-\[900px\]{min-height:900px}.min-h-screen{min-height:100vh}.w-1\/2{width:50%}.w-1\/3{width:33.3333%}.w-2{width:calc(var(--spacing) * 2)}.w-2\.5{width:calc(var(--spacing) * 2.5)}.w-2\/3{width:66.6667%}.w-4{width:calc(var(--spacing) * 4)}.w-5{width:calc(var(--spacing) * 5)}.w-6{width:calc(var(--spacing) * 6)}.w-8{width:calc(var(--spacing) * 8)}.w-9{width:calc(var(--spacing) * 9)}.w-10{width:calc(var(--spacing) * 10)}.w-12{width:calc(var(--spacing) * 12)}.w-14{width:calc(var(--spacing) * 14)}.w-16{width:calc(var(--spacing) * 16)}.w-24{width:calc(var(--spacing) * 24)}.w-64{width:calc(var(--spacing) * 64)}.w-72{width:calc(var(--spacing) * 72)}.w-80{width:calc(var(--spacing) * 80)}.w-\[380px\]{width:380px}.w-auto{width:auto}.w-fit{width:fit-content}.w-full{width:100%}.w-px{width:1px}.w-screen{width:100vw}.max-w-2xl{max-width:var(--container-2xl)}.max-w-4xl{max-width:var(--container-4xl)}.max-w-6xl{max-width:var(--container-6xl)}.max-w-7xl{max-width:var(--container-7xl)}.max-w-\[1700px\]{max-width:1700px}.max-w-md{max-width:var(--container-md)}.max-w-sm{max-width:var(--container-sm)}.max-w-xl{max-width:var(--container-xl)}.min-w-0{min-width:calc(var(--spacing) * 0)}.min-w-\[110px\]{min-width:110px}.min-w-\[120px\]{min-width:120px}.min-w-full{min-width:100%}.flex-1{flex:1}.flex-\[2\]{flex:2}.flex-auto{flex:auto}.flex-shrink{flex-shrink:1}.flex-shrink-0{flex-shrink:0}.shrink{flex-shrink:1}.shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.border-collapse{border-collapse:collapse}.-translate-y-1\/2{--tw-translate-y:calc(calc(1 / 2 * 100%) * -1);translate:var(--tw-translate-x) var(--tw-translate-y)}.translate-y-20{--tw-translate-y:calc(var(--spacing) * 20);translate:var(--tw-translate-x) var(--tw-translate-y)}.rotate-45{rotate:45deg}.transform{transform:var(--tw-rotate-x,) var(--tw-rotate-y,) var(--tw-rotate-z,) var(--tw-skew-x,) var(--tw-skew-y,)}.animate-bounce{animation:var(--animate-bounce)}.animate-pulse{animation:var(--animate-pulse)}.cursor-not-allowed{cursor:not-allowed}.cursor-pointer{cursor:pointer}.cursor-wait{cursor:wait}.resize-none{resize:none}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-row{flex-direction:row}.flex-row-reverse{flex-direction:row-reverse}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.items-end{align-items:flex-end}.items-start{align-items:flex-start}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.justify-end{justify-content:flex-end}.justify-start{justify-content:flex-start}.gap-0{gap:calc(var(--spacing) * 0)}.gap-1{gap:calc(var(--spacing) * 1)}.gap-2{gap:calc(var(--spacing) * 2)}.gap-3{gap:calc(var(--spacing) * 3)}.gap-4{gap:calc(var(--spacing) * 4)}.gap-5{gap:calc(var(--spacing) * 5)}.gap-6{gap:calc(var(--spacing) * 6)}.gap-8{gap:calc(var(--spacing) * 8)}:where(.space-y-1>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 1) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 1) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-2>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 2) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-3>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 3) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-4>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 4) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-6>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 6) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 6) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-8>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 8) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 8) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-x-1\.5>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 1.5) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 1.5) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-2>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 2) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-3>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 3) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-4>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 4) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-x-reverse)))}.gap-y-2{row-gap:calc(var(--spacing) * 2)}:where(.divide-y>:not(:last-child)){--tw-divide-y-reverse:0;border-bottom-style:var(--tw-border-style);border-top-style:var(--tw-border-style);border-top-width:calc(1px * var(--tw-divide-y-reverse));border-bottom-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)))}:where(.divide-gray-200>:not(:last-child)){border-color:var(--color-gray-200)}.self-center{align-self:center}.self-start{align-self:flex-start}.truncate{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.overflow-auto{overflow:auto}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-x-hidden{overflow-x:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:.25rem}.rounded-2xl{border-radius:var(--radius-2xl)}.rounded-full{border-radius:3.40282e38px}.rounded-lg{border-radius:var(--radius-lg)}.rounded-md{border-radius:var(--radius-md)}.rounded-xl{border-radius:var(--radius-xl)}.rounded-t-xl{border-top-left-radius:var(--radius-xl);border-top-right-radius:var(--radius-xl)}.border{border-style:var(--tw-border-style);border-width:1px}.border-2{border-style:var(--tw-border-style);border-width:2px}.border-t{border-top-style:var(--tw-border-style);border-top-width:1px}.border-t-2{border-top-style:var(--tw-border-style);border-top-width:2px}.border-r{border-right-style:var(--tw-border-style);border-right-width:1px}.border-b{border-bottom-style:var(--tw-border-style);border-bottom-width:1px}.border-b-2{border-bottom-style:var(--tw-border-style);border-bottom-width:2px}.border-l-4{border-left-style:var(--tw-border-style);border-left-width:4px}.border-dashed{--tw-border-style:dashed;border-style:dashed}.border-none{--tw-border-style:none;border-style:none}.border-\[\#001f3f\]{border-color:#001f3f}.border-\[var\(--racing\)\]{border-color:var(--racing)}.border-\[var\(--racing-line\)\]{border-color:var(--racing-line)}.border-\[var\(--racing-line\,\#cfe6dc\)\]{border-color:var(--racing-line,#cfe6dc)}.border-blue-600{border-color:var(--color-blue-600)}.border-cyan-900{border-color:var(--color-cyan-900)}.border-gray-100{border-color:var(--color-gray-100)}.border-gray-200{border-color:var(--color-gray-200)}.border-gray-300{border-color:var(--color-gray-300)}.border-gray-400{border-color:var(--color-gray-400)}.border-green-200{border-color:var(--color-green-200)}.border-green-400{border-color:var(--color-green-400)}.border-red-200{border-color:var(--color-red-200)}.border-slate-700{border-color:var(--color-slate-700)}.border-white{border-color:var(--color-white)}.border-white\/20{border-color:#fff3}@supports (color:color-mix(in lab, red, red)){.border-white\/20{border-color:color-mix(in oklab, var(--color-white) 20%, transparent)}}.border-white\/30{border-color:#ffffff4d}@supports (color:color-mix(in lab, red, red)){.border-white\/30{border-color:color-mix(in oklab, var(--color-white) 30%, transparent)}}.border-yellow-300{border-color:var(--color-yellow-300)}.border-t-blue-600{border-top-color:var(--color-blue-600)}.border-t-green-600{border-top-color:var(--color-green-600)}.bg-\[\#001f3f\]{background-color:#001f3f}.bg-\[\#004225\]{background-color:#004225}.bg-\[var\(--gold-orange\)\]{background-color:var(--gold-orange)}.bg-\[var\(--pale-green\)\]{background-color:var(--pale-green)}.bg-\[var\(--racing\)\]{background-color:var(--racing)}.bg-\[var\(--racing-mint\)\]{background-color:var(--racing-mint)}.bg-amber-50{background-color:var(--color-amber-50)}.bg-black{background-color:var(--color-black)}.bg-black\/40{background-color:#0006}@supports (color:color-mix(in lab, red, red)){.bg-black\/40{background-color:color-mix(in oklab, var(--color-black) 40%, transparent)}}.bg-black\/60{background-color:#0009}@supports (color:color-mix(in lab, red, red)){.bg-black\/60{background-color:color-mix(in oklab, var(--color-black) 60%, transparent)}}.bg-blue-50{background-color:var(--color-blue-50)}.bg-blue-100{background-color:var(--color-blue-100)}.bg-blue-500{background-color:var(--color-blue-500)}.bg-blue-600{background-color:var(--color-blue-600)}.bg-cyan-700{background-color:var(--color-cyan-700)}.bg-gray-50{background-color:var(--color-gray-50)}.bg-gray-100{background-color:var(--color-gray-100)}.bg-gray-200{background-color:var(--color-gray-200)}.bg-gray-300{background-color:var(--color-gray-300)}.bg-gray-700{background-color:var(--color-gray-700)}.bg-gray-800\/50{background-color:#1e293980}@supports (color:color-mix(in lab, red, red)){.bg-gray-800\/50{background-color:color-mix(in oklab, var(--color-gray-800) 50%, transparent)}}.bg-green-50{background-color:var(--color-green-50)}.bg-green-100{background-color:var(--color-green-100)}.bg-green-400{background-color:var(--color-green-400)}.bg-green-500{background-color:var(--color-green-500)}.bg-green-600{background-color:var(--color-green-600)}.bg-green-700{background-color:var(--color-green-700)}.bg-indigo-100{background-color:var(--color-indigo-100)}.bg-purple-50{background-color:var(--color-purple-50)}.bg-purple-600{background-color:var(--color-purple-600)}.bg-red-50{background-color:var(--color-red-50)}.bg-red-100{background-color:var(--color-red-100)}.bg-red-500{background-color:var(--color-red-500)}.bg-red-600{background-color:var(--color-red-600)}.bg-rose-50{background-color:var(--color-rose-50)}.bg-slate-600{background-color:var(--color-slate-600)}.bg-slate-700{background-color:var(--color-slate-700)}.bg-slate-800{background-color:var(--color-slate-800)}.bg-slate-900{background-color:var(--color-slate-900)}.bg-slate-950\/50{background-color:#02061880}@supports (color:color-mix(in lab, red, red)){.bg-slate-950\/50{background-color:color-mix(in oklab, var(--color-slate-950) 50%, transparent)}}.bg-teal-50{background-color:var(--color-teal-50)}.bg-white{background-color:var(--color-white)}.bg-white\/10{background-color:#ffffff1a}@supports (color:color-mix(in lab, red, red)){.bg-white\/10{background-color:color-mix(in oklab, var(--color-white) 10%, transparent)}}.bg-white\/15{background-color:#ffffff26}@supports (color:color-mix(in lab, red, red)){.bg-white\/15{background-color:color-mix(in oklab, var(--color-white) 15%, transparent)}}.bg-white\/60{background-color:#fff9}@supports (color:color-mix(in lab, red, red)){.bg-white\/60{background-color:color-mix(in oklab, var(--color-white) 60%, transparent)}}.bg-white\/70{background-color:#ffffffb3}@supports (color:color-mix(in lab, red, red)){.bg-white\/70{background-color:color-mix(in oklab, var(--color-white) 70%, transparent)}}.bg-white\/80{background-color:#fffc}@supports (color:color-mix(in lab, red, red)){.bg-white\/80{background-color:color-mix(in oklab, var(--color-white) 80%, transparent)}}.bg-yellow-50{background-color:var(--color-yellow-50)}.bg-yellow-100{background-color:var(--color-yellow-100)}.bg-yellow-400{background-color:var(--color-yellow-400)}.bg-yellow-500{background-color:var(--color-yellow-500)}.bg-\[url\(\'https\:\/\/www\.transparenttextures\.com\/patterns\/cubes\.png\'\)\]{background-image:url(https://www.transparenttextures.com/patterns/cubes.png)}.bg-contain{background-size:contain}.bg-center{background-position:50%}.bg-no-repeat{background-repeat:no-repeat}.object-contain{object-fit:contain}.object-cover{object-fit:cover}.p-0{padding:calc(var(--spacing) * 0)}.p-2{padding:calc(var(--spacing) * 2)}.p-3{padding:calc(var(--spacing) * 3)}.p-4{padding:calc(var(--spacing) * 4)}.p-5{padding:calc(var(--spacing) * 5)}.p-6{padding:calc(var(--spacing) * 6)}.p-8{padding:calc(var(--spacing) * 8)}.px-1{padding-inline:calc(var(--spacing) * 1)}.px-2{padding-inline:calc(var(--spacing) * 2)}.px-3{padding-inline:calc(var(--spacing) * 3)}.px-4{padding-inline:calc(var(--spacing) * 4)}.px-5{padding-inline:calc(var(--spacing) * 5)}.px-6{padding-inline:calc(var(--spacing) * 6)}.py-0\.5{padding-block:calc(var(--spacing) * .5)}.py-1{padding-block:calc(var(--spacing) * 1)}.py-1\.5{padding-block:calc(var(--spacing) * 1.5)}.py-2{padding-block:calc(var(--spacing) * 2)}.py-2\.5{padding-block:calc(var(--spacing) * 2.5)}.py-3{padding-block:calc(var(--spacing) * 3)}.py-4{padding-block:calc(var(--spacing) * 4)}.py-5{padding-block:calc(var(--spacing) * 5)}.py-6{padding-block:calc(var(--spacing) * 6)}.py-8{padding-block:calc(var(--spacing) * 8)}.py-\[0\.2375rem\]{padding-block:.2375rem}.pt-1{padding-top:calc(var(--spacing) * 1)}.pt-2{padding-top:calc(var(--spacing) * 2)}.pt-3{padding-top:calc(var(--spacing) * 3)}.pt-4{padding-top:calc(var(--spacing) * 4)}.pt-10{padding-top:calc(var(--spacing) * 10)}.pr-2{padding-right:calc(var(--spacing) * 2)}.pr-4{padding-right:calc(var(--spacing) * 4)}.pr-12{padding-right:calc(var(--spacing) * 12)}.pr-28{padding-right:calc(var(--spacing) * 28)}.pb-2{padding-bottom:calc(var(--spacing) * 2)}.pb-3{padding-bottom:calc(var(--spacing) * 3)}.pb-4{padding-bottom:calc(var(--spacing) * 4)}.pl-4{padding-left:calc(var(--spacing) * 4)}.pl-5{padding-left:calc(var(--spacing) * 5)}.pl-6{padding-left:calc(var(--spacing) * 6)}.pl-10{padding-left:calc(var(--spacing) * 10)}.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}.font-mono{font-family:var(--font-mono)}.text-2xl{font-size:var(--text-2xl);line-height:var(--tw-leading,var(--text-2xl--line-height))}.text-3xl{font-size:var(--text-3xl);line-height:var(--tw-leading,var(--text-3xl--line-height))}.text-4xl{font-size:var(--text-4xl);line-height:var(--tw-leading,var(--text-4xl--line-height))}.text-base{font-size:var(--text-base);line-height:var(--tw-leading,var(--text-base--line-height))}.text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}.text-sm{font-size:var(--text-sm);line-height:var(--tw-leading,var(--text-sm--line-height))}.text-xl{font-size:var(--text-xl);line-height:var(--tw-leading,var(--text-xl--line-height))}.text-xs{font-size:var(--text-xs);line-height:var(--tw-leading,var(--text-xs--line-height))}.text-\[0\.6rem\]{font-size:.6rem}.text-\[0\.8rem\]{font-size:.8rem}.text-\[0\.65rem\]{font-size:.65rem}.text-\[0\.85rem\]{font-size:.85rem}.text-\[10px\]{font-size:10px}.text-\[11px\]{font-size:11px}.text-\[12px\]{font-size:12px}.text-\[13px\]{font-size:13px}.leading-relaxed{--tw-leading:var(--leading-relaxed);line-height:var(--leading-relaxed)}.leading-snug{--tw-leading:var(--leading-snug);line-height:var(--leading-snug)}.leading-tight{--tw-leading:var(--leading-tight);line-height:var(--leading-tight)}.font-bold{--tw-font-weight:var(--font-weight-bold);font-weight:var(--font-weight-bold)}.font-extrabold{--tw-font-weight:var(--font-weight-extrabold);font-weight:var(--font-weight-extrabold)}.font-medium{--tw-font-weight:var(--font-weight-medium);font-weight:var(--font-weight-medium)}.font-semibold{--tw-font-weight:var(--font-weight-semibold);font-weight:var(--font-weight-semibold)}.tracking-wide{--tw-tracking:var(--tracking-wide);letter-spacing:var(--tracking-wide)}.tracking-wider{--tw-tracking:var(--tracking-wider);letter-spacing:var(--tracking-wider)}.tracking-widest{--tw-tracking:var(--tracking-widest);letter-spacing:var(--tracking-widest)}.break-words{overflow-wrap:break-word}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.text-\[\#001f3f\]{color:#001f3f}.text-\[\#004225\]{color:#004225}.text-\[var\(--racing-ink\)\]{color:var(--racing-ink)}.text-blue-500{color:var(--color-blue-500)}.text-blue-600{color:var(--color-blue-600)}.text-blue-700{color:var(--color-blue-700)}.text-blue-800{color:var(--color-blue-800)}.text-cyan-400{color:var(--color-cyan-400)}.text-gray-400{color:var(--color-gray-400)}.text-gray-500{color:var(--color-gray-500)}.text-gray-600{color:var(--color-gray-600)}.text-gray-700{color:var(--color-gray-700)}.text-gray-800{color:var(--color-gray-800)}.text-gray-900{color:var(--color-gray-900)}.text-green-400{color:var(--color-green-400)}.text-green-600{color:var(--color-green-600)}.text-green-700{color:var(--color-green-700)}.text-green-800{color:var(--color-green-800)}.text-green-900{color:var(--color-green-900)}.text-indigo-700{color:var(--color-indigo-700)}.text-orange-600{color:var(--color-orange-600)}.text-red-300{color:var(--color-red-300)}.text-red-400{color:var(--color-red-400)}.text-red-500{color:var(--color-red-500)}.text-red-600{color:var(--color-red-600)}.text-red-700{color:var(--color-red-700)}.text-red-800{color:var(--color-red-800)}.text-slate-700{color:var(--color-slate-700)}.text-white{color:var(--color-white)}.text-white\/80{color:#fffc}@supports (color:color-mix(in lab, red, red)){.text-white\/80{color:color-mix(in oklab, var(--color-white) 80%, transparent)}}.text-yellow-300{color:var(--color-yellow-300)}.text-yellow-400{color:var(--color-yellow-400)}.text-yellow-600{color:var(--color-yellow-600)}.text-yellow-700{color:var(--color-yellow-700)}.text-yellow-800{color:var(--color-yellow-800)}.uppercase{text-transform:uppercase}.underline{text-decoration-line:underline}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.placeholder-gray-400::placeholder{color:var(--color-gray-400)}.opacity-0{opacity:0}.opacity-10{opacity:.1}.opacity-40{opacity:.4}.opacity-50{opacity:.5}.opacity-60{opacity:.6}.opacity-70{opacity:.7}.opacity-75{opacity:.75}.opacity-80{opacity:.8}.opacity-90{opacity:.9}.shadow{--tw-shadow:0 1px 3px 0 var(--tw-shadow-color,#0000001a), 0 1px 2px -1px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px var(--tw-shadow-color,#00000040);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-\[0_0_8px_rgba\(34\,197\,94\,0\.6\)\]{--tw-shadow:0 0 8px var(--tw-shadow-color,#22c55e99);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 var(--tw-shadow-color,#0000000d);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px var(--tw-shadow-color,#0000001a), 0 4px 6px -4px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px var(--tw-shadow-color,#0000001a), 0 2px 4px -2px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 3px 0 var(--tw-shadow-color,#0000001a), 0 1px 2px -1px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px var(--tw-shadow-color,#0000001a), 0 8px 10px -6px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.ring-1{--tw-ring-shadow:var(--tw-ring-inset,) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color,currentcolor);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.ring-blue-300{--tw-ring-color:var(--color-blue-300)}.outline{outline-style:var(--tw-outline-style);outline-width:1px}.blur{--tw-blur:blur(8px);filter:var(--tw-blur,) var(--tw-brightness,) var(--tw-contrast,) var(--tw-grayscale,) var(--tw-hue-rotate,) var(--tw-invert,) var(--tw-saturate,) var(--tw-sepia,) var(--tw-drop-shadow,)}.filter{filter:var(--tw-blur,) var(--tw-brightness,) var(--tw-contrast,) var(--tw-grayscale,) var(--tw-hue-rotate,) var(--tw-invert,) var(--tw-saturate,) var(--tw-sepia,) var(--tw-drop-shadow,)}.backdrop-blur-\[1px\]{--tw-backdrop-blur:blur(1px);-webkit-backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,)}.backdrop-blur-sm{--tw-backdrop-blur:blur(var(--blur-sm));-webkit-backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter,display,content-visibility,overlay,pointer-events;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-all{transition-property:all;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-colors{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-opacity{transition-property:opacity;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-transform{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.duration-300{--tw-duration:.3s;transition-duration:.3s}.duration-500{--tw-duration:.5s;transition-duration:.5s}.outline-none{--tw-outline-style:none;outline-style:none}@media (hover:hover){.group-hover\:bg-green-100:is(:where(.group):hover *){background-color:var(--color-green-100)}.group-hover\:bg-yellow-200:is(:where(.group):hover *){background-color:var(--color-yellow-200)}.group-hover\:text-blue-700:is(:where(.group):hover *){color:var(--color-blue-700)}.group-hover\:text-green-800:is(:where(.group):hover *){color:var(--color-green-800)}.group-hover\:opacity-100:is(:where(.group):hover *){opacity:1}}.peer-checked\:translate-x-full:is(:where(.peer):checked~*){--tw-translate-x:100%;translate:var(--tw-translate-x) var(--tw-translate-y)}@media (hover:hover){.hover\:border-blue-200:hover{border-color:var(--color-blue-200)}.hover\:bg-\[\#00331e\]:hover{background-color:#00331e}.hover\:bg-amber-100:hover{background-color:var(--color-amber-100)}.hover\:bg-blue-50:hover{background-color:var(--color-blue-50)}.hover\:bg-blue-100:hover{background-color:var(--color-blue-100)}.hover\:bg-blue-700:hover{background-color:var(--color-blue-700)}.hover\:bg-cyan-600:hover{background-color:var(--color-cyan-600)}.hover\:bg-gray-50:hover{background-color:var(--color-gray-50)}.hover\:bg-gray-100:hover{background-color:var(--color-gray-100)}.hover\:bg-gray-300:hover{background-color:var(--color-gray-300)}.hover\:bg-gray-700:hover{background-color:var(--color-gray-700)}.hover\:bg-green-50:hover{background-color:var(--color-green-50)}.hover\:bg-green-600:hover{background-color:var(--color-green-600)}.hover\:bg-green-700:hover{background-color:var(--color-green-700)}.hover\:bg-green-800:hover{background-color:var(--color-green-800)}.hover\:bg-purple-100:hover{background-color:var(--color-purple-100)}.hover\:bg-red-700:hover{background-color:var(--color-red-700)}.hover\:bg-rose-100:hover{background-color:var(--color-rose-100)}.hover\:bg-slate-50:hover{background-color:var(--color-slate-50)}.hover\:bg-slate-600:hover{background-color:var(--color-slate-600)}.hover\:bg-teal-100:hover{background-color:var(--color-teal-100)}.hover\:pl-4:hover{padding-left:calc(var(--spacing) * 4)}.hover\:text-gray-600:hover{color:var(--color-gray-600)}.hover\:text-green-800:hover{color:var(--color-green-800)}.hover\:text-red-700:hover{color:var(--color-red-700)}.hover\:underline:hover{text-decoration-line:underline}.hover\:opacity-90:hover{opacity:.9}}.focus\:border-\[var\(--gold-orange\)\]:focus{border-color:var(--gold-orange)}.focus\:border-green-400:focus{border-color:var(--color-green-400)}.focus\:border-green-500:focus{border-color:var(--color-green-500)}.focus\:border-transparent:focus{border-color:#0000}.focus\:ring-2:focus{--tw-ring-shadow:var(--tw-ring-inset,) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color,currentcolor);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.focus\:ring-\[var\(--gold-orange\)\]:focus{--tw-ring-color:var(--gold-orange)}.focus\:ring-green-500:focus{--tw-ring-color:var(--color-green-500)}.focus\:ring-green-800:focus{--tw-ring-color:var(--color-green-800)}.focus\:ring-red-500:focus{--tw-ring-color:var(--color-red-500)}.focus\:ring-offset-2:focus{--tw-ring-offset-width:2px;--tw-ring-offset-shadow:var(--tw-ring-inset,) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color)}.focus\:outline-none:focus{--tw-outline-style:none;outline-style:none}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:bg-gray-500:disabled{background-color:var(--color-gray-500)}@media (min-width:40rem){.sm\:col-span-1{grid-column:span 1/span 1}.sm\:col-span-2{grid-column:span 2/span 2}.sm\:mb-0{margin-bottom:calc(var(--spacing) * 0)}.sm\:flex{display:flex}.sm\:w-1\/2{width:50%}.sm\:w-80{width:calc(var(--spacing) * 80)}.sm\:w-auto{width:auto}.sm\:min-w-0{min-width:calc(var(--spacing) * 0)}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:flex-row{flex-direction:row}.sm\:flex-nowrap{flex-wrap:nowrap}.sm\:items-center{align-items:center}:where(.sm\:space-x-2>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 2) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-x-reverse)))}.sm\:p-6{padding:calc(var(--spacing) * 6)}.sm\:text-4xl{font-size:var(--text-4xl);line-height:var(--tw-leading,var(--text-4xl--line-height))}}@media (min-width:48rem){.md\:col-span-2{grid-column:span 2/span 2}.md\:flex{display:flex}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.md\:p-0{padding:calc(var(--spacing) * 0)}.md\:p-8{padding:calc(var(--spacing) * 8)}.md\:px-8{padding-inline:calc(var(--spacing) * 8)}.md\:text-3xl{font-size:var(--text-3xl);line-height:var(--tw-leading,var(--text-3xl--line-height))}.md\:text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}}@media (min-width:64rem){.lg\:col-span-5{grid-column:span 5/span 5}.lg\:col-span-7{grid-column:span 7/span 7}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.lg\:p-8{padding:calc(var(--spacing) * 8)}}@media (min-width:80rem){.xl\:col-span-5{grid-column:span 5/span 5}.xl\:col-span-7{grid-column:span 7/span 7}}}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}@property --tw-rotate-x{syntax:"*";inherits:false}@property --tw-rotate-y{syntax:"*";inherits:false}@property --tw-rotate-z{syntax:"*";inherits:false}@property --tw-skew-x{syntax:"*";inherits:false}@property --tw-skew-y{syntax:"*";inherits:false}@property --tw-space-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-space-x-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-divide-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-leading{syntax:"*";inherits:false}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-tracking{syntax:"*";inherits:false}@property --tw-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-shadow-color{syntax:"*";inherits:false}@property --tw-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-inset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-shadow-color{syntax:"*";inherits:false}@property --tw-inset-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-ring-color{syntax:"*";inherits:false}@property --tw-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-ring-color{syntax:"*";inherits:false}@property --tw-inset-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-ring-inset{syntax:"*";inherits:false}@property --tw-ring-offset-width{syntax:"<length>";inherits:false;initial-value:0}@property --tw-ring-offset-color{syntax:"*";inherits:false;initial-value:#fff}@property --tw-ring-offset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-outline-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-blur{syntax:"*";inherits:false}@property --tw-brightness{syntax:"*";inherits:false}@property --tw-contrast{syntax:"*";inherits:false}@property --tw-grayscale{syntax:"*";inherits:false}@property --tw-hue-rotate{syntax:"*";inherits:false}@property --tw-invert{syntax:"*";inherits:false}@property --tw-opacity{syntax:"*";inherits:false}@property --tw-saturate{syntax:"*";inherits:false}@property --tw-sepia{syntax:"*";inherits:false}@property --tw-drop-shadow{syntax:"*";inherits:false}@property --tw-drop-shadow-color{syntax:"*";inherits:false}@property --tw-drop-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-drop-shadow-size{syntax:"*";inherits:false}@property --tw-backdrop-blur{syntax:"*";inherits:false}@property --tw-backdrop-brightness{syntax:"*";inherits:false}@property --tw-backdrop-contrast{syntax:"*";inherits:false}@property --tw-backdrop-grayscale{syntax:"*";inherits:false}@property --tw-backdrop-hue-rotate{syntax:"*";inherits:false}@property --tw-backdrop-invert{syntax:"*";inherits:false}@property --tw-backdrop-opacity{syntax:"*";inherits:false}@property --tw-backdrop-saturate{syntax:"*";inherits:false}@property --tw-backdrop-sepia{syntax:"*";inherits:false}@property --tw-duration{syntax:"*";inherits:false}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}

/* Patch: missing custom utility from original UI */
.peer-checked\:bg-racing-green-600:is(:where(.peer):checked~*){background-color:#16a34a}
</style>
</head>
<body class="text-gray-800">
<!-- BRANDING: watermark helper block (legacy). Prefer editing the primary watermark section above. -->
<div aria-hidden="true" class="wm-layer" id="wmA"></div>
<div aria-hidden="true" class="wm-layer" id="wmB"></div>
<div class="z-content">
<div class="w-full bg-[var(--racing)] text-white">
<div class="max-w-7xl mx-auto px-4 md:px-8 py-6">
<div class="flex items-start justify-between gap-6">
<div class="flex-1">
<div class="inline-flex items-center gap-3 bg-white/10 border border-white/20 rounded-full px-3 py-1 text-sm mb-3">
<span class="inline-block w-2 h-2 rounded-full bg-white/80"></span>
<span>Compare My Finance — PCP &amp; HP</span>
</div>
<h1 class="text-2xl md:text-3xl font-semibold leading-tight">Intelligent Refinance Calculator</h1>
<p class="text-white/80 text-sm mt-1">Solve for APR, term, payment, balloon, settlement balance, and “match in X months” scenarios.</p>
</div>
<div class="hidden md:flex flex-col items-end text-xs text-white/80">
<div class="bg-white/10 border border-white/20 rounded-xl px-3 py-2">
<div class="font-semibold text-white">Wizard-driven</div>
<div>Asks only for the minimum inputs needed</div>
</div>
</div>
</div>
</div>
</div>
<div class="max-w-7xl mx-auto w-full p-4 md:p-8">
<div class="card rounded-2xl p-5 md:p-8 border border-[var(--racing-line)]">
<!-- NAVIGATION: Primary tab list. Each <a.tab-link data-tab="..."> must match a content container id. If adding tabs, update both nav + container + App.ui.switchTab mapping. -->
<div class="flex flex-wrap items-center gap-2 mb-5">
<button class="pill active px-3 py-1 rounded-lg text-sm" data-tab="solver">Universal Solver</button>
<button class="pill px-3 py-1 rounded-lg text-sm" data-tab="compare">Deal Comparison + Match</button>
<button class="pill px-3 py-1 rounded-lg text-sm" data-tab="notes">Notes</button>
</div>
<!-- UNIVERSAL SOLVER: Tooling panel for quick calculations/validation. Structure: left inputs + right outputs. Keep IDs stable because JS reads them directly. -->
<section id="tab-solver">
<div class="grid grid-cols-1 lg:grid-cols-12 gap-5">
<!-- UNIVERSAL SOLVER: Left column = scenario selector + inputs (form controls). -->
<div class="lg:col-span-7 rounded-xl border border-[var(--racing-line)] soft-panel">
<div class="ribbon rounded-t-xl px-5 py-3 flex items-center justify-between">
<h2 class="text-base md:text-lg font-semibold">What would you like to calculate today?</h2>
<span class="text-xs bg-white/10 border border-white/20 rounded-full px-2 py-1">Auto-detect missing inputs</span>
</div>
<div class="p-5 space-y-4">
<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Calculation</label>
<select class="input-field w-full px-3 py-2 rounded-lg" id="calc-mode">
<option value="monthly">Monthly payment (given settlement/amount, APR, term, optional balloon)</option>
<option value="apr">APR (given settlement/amount, term, monthly payment, optional balloon)</option>
<option value="term">Term (given settlement/amount, APR, monthly payment, optional balloon)</option>
<option value="amount">Amount to finance / Settlement (given APR, term, monthly payment, optional balloon)</option>
<option value="balloon">Balloon / GFV (PCP only) (given amount, APR, term, monthly payment)</option>
<option value="balance">Outstanding balance at month X (given amount, APR, term, optional balloon)</option>
<option value="pay_to_target">Monthly payment to hit target balance at month X</option>
<option value="term_to_target">Term needed so balance at month X equals target (given amount + APR)</option>
</select>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Deal type</label>
<div class="flex items-center gap-2">
<button class="pill active px-3 py-2 rounded-lg text-sm w-full" id="solver-type-hp">HP</button>
<button class="pill px-3 py-2 rounded-lg text-sm w-full" id="solver-type-pcp">PCP</button>
</div>
<div class="text-xs muted mt-1">PCP enables Balloon/GFV. HP assumes balloon = £0.</div>
</div>
</div>
<div class="divider"></div>
<!-- UNIVERSAL SOLVER: Input group container. If adding fields, follow .input-field convention for consistent styles. -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Settlement / Amount to finance (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-P" inputmode="decimal" placeholder="e.g. 12,500"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">APR (%)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-apr" inputmode="decimal" placeholder="e.g. 9.9"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Term (months)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-n" inputmode="numeric" placeholder="e.g. 48"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Monthly payment (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-M" inputmode="decimal" placeholder="e.g. 289.50"/>
</div>
<div id="s-balloon-wrap">
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Balloon / GFV (£) (PCP)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-B" inputmode="decimal" placeholder="e.g. 6,000"/>
</div>
<div id="s-k-wrap">
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Month X (from today)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-k" inputmode="numeric" placeholder="e.g. 24"/>
</div>
<div class="md:col-span-2" id="s-target-wrap">
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Target balance at month X (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="s-target" inputmode="decimal" placeholder="e.g. 8,000"/>
<div class="text-xs muted mt-1">If you want “match current deal”, use the Comparison tab → Match panel.</div>
</div>
</div>
<div class="flex flex-wrap items-center gap-3 pt-2">
<button class="btn-green" id="solver-calc-btn">Calculate</button>
<button class="btn-green" id="solver-clear-btn">Clear</button>
<span class="text-sm badge" id="solver-status">Ready</span>
</div>
<div class="rounded-xl border border-[var(--racing-line)] bg-white/70 p-4">
<div class="font-semibold text-[var(--racing-ink)] mb-2">Minimum inputs needed</div>
<ul class="text-sm list-disc pl-5 space-y-1" id="solver-min-req"></ul>
</div>
</div>
</div>
<!-- UNIVERSAL SOLVER: Right column = computed outputs + explanation. Pure UI; computations live in JS (search for handlers). -->
<div class="lg:col-span-5 rounded-xl border border-[var(--racing-line)] bg-white/80">
<div class="ribbon rounded-t-xl px-5 py-3 flex items-center justify-between">
<h2 class="text-base md:text-lg font-semibold">Results</h2>
<span class="text-xs bg-white/10 border border-white/20 rounded-full px-2 py-1">Live solver</span>
</div>
<div class="p-5 space-y-4">
<div class="grid grid-cols-1 gap-2 text-sm">
<div class="flex items-center justify-between p-2 rounded-lg bg-[var(--racing-mint)] border border-[var(--racing-line)]">
<span class="font-medium">Monthly payment</span>
<span class="font-extrabold text-2xl mono" id="o-M">£0.00</span>
</div>
<div class="flex justify-between"><span>Total payable</span><span class="font-semibold mono" id="o-total">£0.00</span></div>
<div class="flex justify-between"><span>Total interest</span><span class="font-semibold mono" id="o-interest">£0.00</span></div>
<div class="flex justify-between"><span>End-of-term balance</span><span class="font-semibold mono" id="o-end">£0.00</span></div>
<div class="flex justify-between"><span>APR (nominal)</span><span class="font-semibold mono" id="o-apr">—</span></div>
<div class="flex justify-between"><span>Term (months)</span><span class="font-semibold mono" id="o-n">—</span></div>
<div class="flex justify-between"><span>Settlement / Amount</span><span class="font-semibold mono" id="o-P">—</span></div>
<div class="flex justify-between" id="o-balloon-row"><span>Balloon / GFV</span><span class="font-semibold mono" id="o-B">—</span></div>
<div class="flex justify-between" id="o-balance-row"><span>Balance at month X</span><span class="font-semibold mono" id="o-balance">—</span></div>
<div class="flex justify-between" id="o-x-row"><span>Month X</span><span class="font-semibold mono" id="o-k">—</span></div>
</div>
<div class="rounded-xl border border-[var(--racing-line)] bg-white/70 p-4">
<div class="flex items-center justify-between mb-2">
<div class="font-semibold text-[var(--racing-ink)]">Explain</div>
<span class="text-xs badge" id="solver-verdict">—</span>
</div>
<div class="text-sm muted leading-relaxed" id="solver-explain">
                    Pick a calculation, enter any known figures, then press Calculate.
                  </div>
</div>
</div>
</div>
</div>
</section>
<!-- DEAL COMPARISON: Side-by-side comparison UI (Current vs New). Used in “Product Source & DNS” workflows. -->
<section class="hidden" id="tab-compare">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<!-- DEAL COMPARISON: Current deal column (existing finance terms). IDs typically prefixed with ltr_current-*. -->
<section class="rounded-xl border border-[var(--racing-line)] bg-white/80">
<div class="ribbon rounded-t-xl px-5 py-3 flex items-center justify-between">
<h2 class="text-base md:text-lg font-semibold">Current Deal (from today)</h2>
<div class="flex items-center gap-2">
<button class="pill px-3 py-1 rounded-lg text-sm active" data-side="left" data-type="hp">HP</button>
<button class="pill px-3 py-1 rounded-lg text-sm" data-side="left" data-type="pcp">PCP</button>
</div>
</div>
<div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Monthly payment (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="left-M" inputmode="decimal" placeholder="customer figure (optional)"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Settlement / balance today (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="left-P" inputmode="decimal" placeholder="e.g. 12,500"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">APR (%)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="left-apr" inputmode="decimal" placeholder="e.g. 12.9"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Remaining term (months)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="left-n" inputmode="numeric" placeholder="e.g. 36"/>
</div>
<div class="md:col-span-2" id="left-B-wrap">
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Balloon / GFV (£) (PCP)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="left-B" inputmode="decimal" placeholder="PCP only"/>
</div>
</div>
</section>
<!-- DEAL COMPARISON: New deal column (candidate refinance offer). IDs typically prefixed with ltr_new-*. -->
<section class="rounded-xl border border-[var(--racing-line)] bg-white/80">
<div class="ribbon rounded-t-xl px-5 py-3 flex items-center justify-between">
<h2 class="text-base md:text-lg font-semibold">New Offer</h2>
<div class="flex items-center gap-2">
<button class="pill px-3 py-1 rounded-lg text-sm active" data-side="right" data-type="hp">HP</button>
<button class="pill px-3 py-1 rounded-lg text-sm" data-side="right" data-type="pcp">PCP</button>
</div>
</div>
<div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-3">
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Amount to finance (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="right-P" inputmode="decimal" placeholder="usually settlement"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">APR (%)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="right-apr" inputmode="decimal" placeholder="e.g. 8.9"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Term (months)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="right-n" inputmode="numeric" placeholder="e.g. 48"/>
</div>
<div>
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Monthly payment (£)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="right-M" inputmode="decimal" placeholder="auto if amount+apr+term"/>
</div>
<div class="md:col-span-2" id="right-B-wrap">
<label class="block text-sm mb-1 text-[var(--racing-ink)]">Balloon / GFV (£) (PCP)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="right-B" inputmode="decimal" placeholder="PCP only"/>
</div>
</div>
</section>
</div>
<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-5">
<div class="rounded-xl bg-[var(--racing-mint)] border border-[var(--racing-line)] p-5">
<h3 class="font-semibold text-[var(--racing-ink)] mb-3">Current — Results</h3>
<div class="text-sm space-y-2">
<div class="flex items-center justify-between p-2 rounded-lg bg-white/60">
<span class="font-medium">Monthly payment</span><span class="font-extrabold text-2xl mono" id="left-out-M">£0.00</span>
</div>
<div class="flex justify-between"><span>Total to pay</span><span class="font-semibold mono" id="left-out-total">£0.00</span></div>
<div class="flex justify-between"><span>Total interest</span><span class="font-semibold mono" id="left-out-int">£0.00</span></div>
<div class="flex justify-between"><span>End-of-term balance</span><span class="font-semibold mono" id="left-out-end">£0.00</span></div>
</div>
</div>
<div class="rounded-xl bg-[var(--racing-mint)] border border-[var(--racing-line)] p-5">
<h3 class="font-semibold text-[var(--racing-ink)] mb-3">New — Results</h3>
<div class="text-sm space-y-2">
<div class="flex items-center justify-between p-2 rounded-lg bg-white/60">
<span class="font-medium">Monthly payment</span><span class="font-extrabold text-2xl mono" id="right-out-M">£0.00</span>
</div>
<div class="flex justify-between"><span>Total to pay</span><span class="font-semibold mono" id="right-out-total">£0.00</span></div>
<div class="flex justify-between"><span>Total interest</span><span class="font-semibold mono" id="right-out-int">£0.00</span></div>
<div class="flex justify-between"><span>End-of-term balance</span><span class="font-semibold mono" id="right-out-end">£0.00</span></div>
</div>
</div>
<div class="rounded-xl bg-white border-2 border-[var(--racing)] p-5">
<div class="flex items-center justify-between mb-3">
<h3 class="font-semibold text-[var(--racing-ink)]">Match / Compare</h3>
<span class="text-xs px-2 py-1 rounded-full bg-[var(--racing)] text-white">Live</span>
</div>
<div class="text-sm space-y-3">
<div class="flex items-center justify-between">
<span>Monthly change</span>
<span class="font-semibold badge mono" id="cmp-dM">£0.00</span>
</div>
<div class="flex items-center justify-between">
<span>Interest change</span>
<span class="font-semibold badge mono" id="cmp-dI">£0.00</span>
</div>
<div class="flex items-center justify-between">
<span>End balance change</span>
<span class="font-semibold badge mono" id="cmp-dE">£0.00</span>
</div>
<div class="divider"></div>
<div class="rounded-xl border border-[var(--racing-line)] bg-white/70 p-4">
<div class="font-semibold text-[var(--racing-ink)] mb-2">Match balance at month X</div>
<div class="grid grid-cols-1 gap-2">
<div>
<label class="block text-xs mb-1 muted">Month X (e.g. 24)</label>
<input class="input-field w-full px-3 py-2 rounded-lg" id="match-k" inputmode="numeric" placeholder="24"/>
</div>
<div class="text-xs muted leading-relaxed">
                      This answers: “If switching (PCP → HP or HP → PCP), what term is needed so the balance in X months matches staying on the current deal?”
                    </div>
<button class="btn-green w-full" id="match-btn">Solve term for new deal</button>
<div class="text-xs muted">
                      Required on current: settlement, APR, remaining term (+ balloon if PCP). Required on new: settlement, APR (+ balloon if PCP).
                    </div>
</div>
</div>
<div class="rounded-xl border border-[var(--racing-line)] bg-white/70 p-4">
<div class="flex items-center justify-between">
<div class="font-semibold text-[var(--racing-ink)]">Match result</div>
<span class="text-xs badge" id="match-verdict">—</span>
</div>
<div class="grid grid-cols-1 gap-2 text-sm mt-2">
<div class="flex justify-between"><span>Target balance (current @ X)</span><span class="font-semibold mono" id="match-target">—</span></div>
<div class="flex justify-between"><span>New term needed</span><span class="font-semibold mono" id="match-term">—</span></div>
<div class="flex justify-between"><span>New monthly (with that term)</span><span class="font-semibold mono" id="match-monthly">—</span></div>
<div class="flex justify-between"><span>New balance @ X</span><span class="font-semibold mono" id="match-newbal">—</span></div>
<div class="flex justify-between"><span>Difference</span><span class="font-semibold badge mono" id="match-diff">—</span></div>
</div>
</div>
</div>
</div>
</div>
</section>
<!-- NOTES: Operator notes area. Designed for quick, structured notes. Preserve textarea IDs if used for saving. -->
<section class="hidden" id="tab-notes">
<div class="rounded-xl border border-[var(--racing-line)] bg-white/80 p-5 space-y-3">
<h2 class="text-lg font-semibold text-[var(--racing-ink)]">What this version covers</h2>
<ul class="list-disc pl-5 text-sm space-y-2">
<li><span class="font-semibold">HP + PCP</span> with optional balloon/GFV.</li>
<li><span class="font-semibold">Solve any single unknown</span>: payment, APR, term, amount, balloon.</li>
<li><span class="font-semibold">Outstanding balance at month X</span> from today.</li>
<li><span class="font-semibold">Target-driven refi logic</span>: payment required to reach a target balance at X, or term needed so balance at X equals a target.</li>
<li><span class="font-semibold">Switch scenario</span> (e.g. PCP → HP): match the new deal’s balance at X months to the “stay on current” balance at X months.</li>
</ul>
<div class="rounded-xl bg-[var(--racing-mint)] border border-[var(--racing-line)] p-4 text-sm">
<div class="font-semibold text-[var(--racing-ink)] mb-1">Important</div>
              This is an illustrative calculator. It does not include fees, arrears, payment holidays, mileage/condition adjustments, or lender-specific settlement mechanics.
              Add those as additional “cashflows” or adjustments if you want exact back-office replication.
            </div>
<div class="text-sm muted">
              Implementation detail: numeric solvers use safe bisection / discrete search. Everything runs client-side (single HTML file).
            </div>
</div>
</section>
</div>
<div class="text-xs muted mt-4">
        Styling based on your existing CMF Deal Comparison calculator.
      </div>
</div>
</div>
<script>
/* ---------------------------
   WATERMARK (same image set)
----------------------------*/
(function(){
  const imgs = [
    "https://lh3.googleusercontent.com/d/1zESgE9OpS1KcJapsFvvwcVyr2Ogykz2j",
    "https://lh3.googleusercontent.com/d/1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH",
    "https://lh3.googleusercontent.com/d/1Kf2kzoUmPDkHOrj_TkezYe0937VUAqzj",
    "https://lh3.googleusercontent.com/d/1z1OLTlJGykDP98DAwljiEJN02u6bDLZT",
    "https://lh3.googleusercontent.com/d/1CKF3DD9sPJtLzxT28t0sgFN_W3NigU-g",
    "https://lh3.googleusercontent.com/d/1NHtgaOBuB2qS9yGyl9jVoX7VOTnlPT0S",
    "https://lh3.googleusercontent.com/d/19AmXdwRyfPvogLEF-BGxxJeF6zgpAFK7"
  ];
  const A = document.getElementById('wmA'), B = document.getElementById('wmB');
  const targetOpacity = getComputedStyle(document.documentElement).getPropertyValue('--wm-opacity').trim() || '0.12';
  const fadeMs = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--wm-fade-ms')) || 12000;
  const holdMs = 2000;
  let showingA=true, idx=0;
  const setBg=(el,src)=>el.style.backgroundImage=`url('${src}')`;
  const show=(el)=>el.style.opacity=targetOpacity;
  const hide=(el)=>el.style.opacity='0';
  function cycle(){
    const cur=showingA?A:B, nxt=showingA?B:A;
    setBg(nxt, imgs[idx]); idx=(idx+1)%imgs.length;
    requestAnimationFrame(()=>{ show(nxt); hide(cur); });
    showingA=!showingA;
    setTimeout(cycle, fadeMs+holdMs);
  }
  setBg(A, imgs[0]); show(A); idx=1%imgs.length; setTimeout(cycle, holdMs);
})();

/* ---------------------------
   UTILITIES
----------------------------*/
const qs=(s,r=document)=>r.querySelector(s);
const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));

const currency=new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:2});
const parseMoney=v=>v?(parseFloat(String(v).replace(/[^0-9.\-]/g,''))||0):0;
const parsePct=v=>v?(parseFloat(String(v).replace(/[^0-9.\-]/g,''))||0):0;
const parseIntish=v=>v?Math.max(0,Math.round(parseFloat(String(v).replace(/[^0-9.\-]/g,''))||0)):0;

function fmtGBP(x){ return currency.format(Number.isFinite(x)?x:0); }
function fmtAPR(apr){ return (Number.isFinite(apr) && apr>0) ? (apr.toFixed(2)+'%') : '—'; }
function badge(el, kind, text){
  if(!el) return;
  el.classList.remove('good','warn','bad');
  if(kind) el.classList.add(kind);
  el.textContent=text;
}

/* ---------------------------
   FINANCE CORE (HP / PCP)
   All “P” assumed: balance/settlement TODAY.
----------------------------*/
function monthlyPayment(P, apr, n, B, type){
  P = Math.max(0, P); n = Math.max(0, Math.round(n||0)); B = Math.max(0, B||0);
  const r = (apr>0) ? (apr/100)/12 : 0;

  if(n<=0 || P<=0) return {M:0, r, P, n, B, type};

  if(r===0){
    const M = (type==='pcp') ? Math.max(0,(P-B)/n) : (P/n);
    return {M, r, P, n, B, type};
  }

  const denom = 1 - Math.pow(1+r, -n);
  if(denom<=0) return {M:0, r, P, n, B, type};

  if(type==='pcp'){
    const pvB = B / Math.pow(1+r, n);
    const M = (P - pvB) * (r/denom);
    return {M, r, P, n, B, type};
  } else {
    const M = P * (r/denom);
    return {M, r, P, n, B, type};
  }
}

function totalsFrom(P, apr, n, B, type){
  const {M, r} = monthlyPayment(P, apr, n, B, type);
  let total = 0;
  if(n>0){
    total = (type==='pcp') ? (M*n + (B||0)) : (M*n);
  }
  const interest = Math.max(0, total - (P||0));
  const end = (type==='pcp') ? (B||0) : 0;
  return {M, r, total, interest, end};
}

/**
 * Outstanding at month k (0 = today).
 * Formula: PV(remaining payments) + PV(balloon), discounted back k months.
 */
function outstandingBalance(P, apr, n, k, B, type){
  P = Math.max(0, P); n = Math.max(0, Math.round(n||0)); k = Math.max(0, Math.round(k||0)); B = Math.max(0, B||0);
  const {M, r} = monthlyPayment(P, apr, n, B, type);

  if(n<=0) return P;
  if(k<=0) return P;
  if(k>=n) return (type==='pcp') ? B : 0;

  const rem = n - k;
  if(r===0){
    const bal = Math.max(0, (P - M*k));
    if(type==='pcp' && k>=n) return B;
    // for PCP: linear part is P-B, but formula above already uses P and M. At end we return B.
    return (type==='pcp') ? Math.max(B, bal) : bal;
  }

  const pvPayments = M * (1 - Math.pow(1+r, -rem)) / r;
  const pvBalloon = (type==='pcp') ? (B / Math.pow(1+r, rem)) : 0;
  return pvPayments + pvBalloon;
}

/* ---------------------------
   SOLVERS
----------------------------*/
function solveAPR_fromPMnB(P, M, n, B, type){
  P=Math.max(0,P); M=Math.max(0,M); n=Math.max(0,Math.round(n||0)); B=Math.max(0,B||0);
  if(P<=0 || M<=0 || n<=0) return null;

  // Bisection on monthly rate r in [0, 2.0] (~2400% APR) with expansion if needed
  let lo=0, hi=0.5;
  const f = (r)=> monthlyPayment(P, r*12*100, n, B, type).M - M;

  let flo=f(lo), fhi=f(hi), tries=0;
  while(flo*fhi>0 && hi<2 && tries<25){
    hi*=1.4; fhi=f(hi); tries++;
  }
  if(flo*fhi>0) return null;

  for(let i=0;i<90;i++){
    const mid=(lo+hi)/2;
    const fm=f(mid);
    if(Math.abs(fm) < 1e-8) return mid*12*100;
    if(flo*fm<=0){ hi=mid; fhi=fm; }
    else { lo=mid; flo=fm; }
  }
  return ((lo+hi)/2)*12*100;
}

function solveTerm_fromPMaprB(P, M, apr, B, type, maxN=180){
  P=Math.max(0,P); M=Math.max(0,M); apr=Math.max(0,apr); B=Math.max(0,B||0);
  if(P<=0 || M<=0 || apr<0) return null;

  // term must be >= 1
  // monotonic: for fixed P,apr,B, payment decreases as n increases.
  let lo=1, hi=maxN;

  const payAt = (n)=> monthlyPayment(P, apr, n, B, type).M;

  // Ensure bracket around M (payAt(lo) >= M >= payAt(hi)) or fallback to discrete closest.
  const pLo=payAt(lo), pHi=payAt(hi);
  if(M > pLo) return lo; // needs shorter than 1 month, clamp
  if(M < pHi){
    // payment too small even at max term -> return max term
    return hi;
  }

  // binary search nearest integer where payAt(n) close to M
  for(let i=0;i<40;i++){
    const mid = Math.floor((lo+hi)/2);
    const pm = payAt(mid);
    if(pm === M) return mid;
    if(pm > M) lo = mid + 1;
    else hi = mid - 1;
  }
  // pick best in neighbourhood
  let bestN=lo, bestDiff=Infinity;
  for(let n=Math.max(1,lo-3); n<=Math.min(maxN,lo+3); n++){
    const d = Math.abs(payAt(n)-M);
    if(d<bestDiff){ bestDiff=d; bestN=n; }
  }
  return bestN;
}

function solveP_fromMaprnB(M, apr, n, B, type){
  M=Math.max(0,M); apr=Math.max(0,apr); n=Math.max(0,Math.round(n||0)); B=Math.max(0,B||0);
  if(M<=0 || n<=0) return null;

  const r = (apr>0) ? (apr/100)/12 : 0;
  if(r===0){
    if(type==='pcp') return Math.max(0, M*n + B);
    return Math.max(0, M*n);
  }
  const pvPayments = M * (1 - Math.pow(1+r, -n)) / r;
  const pvBalloon = (type==='pcp') ? (B / Math.pow(1+r, n)) : 0;
  return pvPayments + pvBalloon;
}

function solveBalloon_fromPMaprn(P, M, apr, n){
  // PCP only. Closed form.
  P=Math.max(0,P); M=Math.max(0,M); apr=Math.max(0,apr); n=Math.max(0,Math.round(n||0));
  if(P<=0 || M<=0 || n<=0) return null;
  const r = (apr>0) ? (apr/100)/12 : 0;
  if(r===0) return Math.max(0, P - M*n);
  const frac = (1 - Math.pow(1+r, -n)) / r;
  const B = (P - M*frac) * Math.pow(1+r, n);
  return Math.max(0, B);
}

function paymentToHitTarget(P, apr, n, k, B, type, targetBal){
  P=Math.max(0,P); apr=Math.max(0,apr); n=Math.max(0,Math.round(n||0)); k=Math.max(0,Math.round(k||0)); B=Math.max(0,B||0); targetBal=Math.max(0,targetBal);
  if(P<=0 || n<=0 || k>=n) return null;
  const r = (apr>0) ? (apr/100)/12 : 0;
  const rem = n - k;

  if(r===0){
    const M = (targetBal - (type==='pcp'?B:0)) / rem;
    return (Number.isFinite(M) && M>=0) ? M : null;
  }

  const pvBalloon = (type==='pcp') ? (B / Math.pow(1+r, rem)) : 0;
  const denom = (1 - Math.pow(1+r, -rem)) / r;
  const M = (targetBal - pvBalloon) / denom;
  return (Number.isFinite(M) && M>=0) ? M : null;
}

function solveTermToMatchBalanceAtK(P, apr, k, targetBal, B, type, maxN=240){
  P=Math.max(0,P); apr=Math.max(0,apr); k=Math.max(0,Math.round(k||0)); targetBal=Math.max(0,targetBal); B=Math.max(0,B||0);
  if(P<=0 || k<0) return null;
  const startN = Math.max(1, k+1);

  let best = {n:null, bal:null, diff:Infinity};
  for(let n=startN; n<=maxN; n++){
    const bal = outstandingBalance(P, apr, n, k, B, type);
    const diff = Math.abs(bal - targetBal);
    if(diff < best.diff){
      best = {n, bal, diff};
    }
    // If diff is tiny, we can stop early
    if(best.diff <= Math.max(20, 0.001*targetBal)) break;
  }
  return best.n ? best : null;
}

/* ---------------------------
   UNIVERSAL SOLVER WIRING
----------------------------*/
const solverState = { type: 'hp' };

const MODES = {
  monthly: {
    title: "Monthly payment",
    min: (type)=> type==='pcp' ? ['Settlement/Amount (P)','APR','Term (months)','Balloon/GFV (B)'] : ['Settlement/Amount (P)','APR','Term (months)'],
    explain: "Computes the monthly payment from today, plus total payable, interest, and end-of-term balance."
  },
  apr: {
    title: "APR",
    min: (type)=> type==='pcp' ? ['Settlement/Amount (P)','Monthly payment (M)','Term (months)','Balloon/GFV (B)'] : ['Settlement/Amount (P)','Monthly payment (M)','Term (months)'],
    explain: "Computes the implied APR given today’s balance, remaining term and monthly payment (and balloon if PCP)."
  },
  term: {
    title: "Term",
    min: (type)=> type==='pcp' ? ['Settlement/Amount (P)','APR','Monthly payment (M)','Balloon/GFV (B)'] : ['Settlement/Amount (P)','APR','Monthly payment (M)'],
    explain: "Computes the term needed to reach the end balance (balloon for PCP or £0 for HP) while paying the given monthly."
  },
  amount: {
    title: "Amount / Settlement",
    min: (type)=> type==='pcp' ? ['APR','Term (months)','Monthly payment (M)','Balloon/GFV (B)'] : ['APR','Term (months)','Monthly payment (M)'],
    explain: "Computes the implied balance/settlement today that matches the given payment, APR, term (and balloon if PCP)."
  },
  balloon: {
    title: "Balloon / GFV",
    min: (_)=> ['Settlement/Amount (P)','APR','Term (months)','Monthly payment (M)'],
    explain: "PCP only. Computes the implied balloon/GFV that makes the payment work."
  },
  balance: {
    title: "Outstanding at month X",
    min: (type)=> type==='pcp' ? ['Settlement/Amount (P)','APR','Term (months)','Balloon/GFV (B)','Month X'] : ['Settlement/Amount (P)','APR','Term (months)','Month X'],
    explain: "Computes the outstanding balance at month X (from today) using the deal’s cashflow structure."
  },
  pay_to_target: {
    title: "Payment to hit target at X",
    min: (type)=> type==='pcp' ? ['Settlement/Amount (P)','APR','Term (months)','Balloon/GFV (B)','Month X','Target balance @ X'] : ['Settlement/Amount (P)','APR','Term (months)','Month X','Target balance @ X'],
    explain: "Computes the monthly payment required so that the balance at month X equals the target."
  },
  term_to_target: {
    title: "Term to hit target at X",
    min: (type)=> type==='pcp' ? ['Settlement/Amount (P)','APR','Balloon/GFV (B)','Month X','Target balance @ X'] : ['Settlement/Amount (P)','APR','Month X','Target balance @ X'],
    explain: "Searches for a term such that the balance at month X equals the target."
  }
};

function setSolverType(type){
  solverState.type = type;
  qs('#solver-type-hp').classList.toggle('active', type==='hp');
  qs('#solver-type-pcp').classList.toggle('active', type==='pcp');
  qs('#solver-type-hp').style.background = type==='hp' ? 'var(--racing)' : '#fff';
  qs('#solver-type-hp').style.color = type==='hp' ? '#fff' : 'var(--racing)';
  qs('#solver-type-pcp').style.background = type==='pcp' ? 'var(--racing)' : '#fff';
  qs('#solver-type-pcp').style.color = type==='pcp' ? '#fff' : 'var(--racing)';
  qs('#s-balloon-wrap').style.display = (type==='pcp') ? '' : 'none';
}

function setModeUI(){
  const mode = qs('#calc-mode').value;
  const showK = (mode==='balance' || mode==='pay_to_target' || mode==='term_to_target');
  const showTarget = (mode==='pay_to_target' || mode==='term_to_target');
  qs('#s-k-wrap').style.display = showK ? '' : 'none';
  qs('#s-target-wrap').style.display = showTarget ? '' : 'none';

  // Balloon only visible for PCP (deal type); additionally, balloon mode forces PCP UI.
  if(mode==='balloon'){
    setSolverType('pcp');
    qs('#solver-type-hp').disabled = true;
    qs('#solver-type-hp').classList.add('opacity-50');
  } else {
    qs('#solver-type-hp').disabled = false;
    qs('#solver-type-hp').classList.remove('opacity-50');
  }

  renderMinReq();
  badge(qs('#solver-status'), null, 'Ready');
  qs('#solver-explain').textContent = MODES[mode].explain;
}

function renderMinReq(){
  const mode = qs('#calc-mode').value;
  const list = qs('#solver-min-req');
  list.innerHTML = '';
  const items = MODES[mode].min(solverState.type);
  items.forEach(t=>{
    const li=document.createElement('li');
    li.textContent=t;
    list.appendChild(li);
  });
}

function getSolverInputs(){
  const P = parseMoney(qs('#s-P').value);
  const apr = parsePct(qs('#s-apr').value);
  const n = parseIntish(qs('#s-n').value);
  const M = parseMoney(qs('#s-M').value);
  const B = parseMoney(qs('#s-B').value);
  const k = parseIntish(qs('#s-k').value);
  const target = parseMoney(qs('#s-target').value);
  return {P, apr, n, M, B, k, target, type: solverState.type};
}

function missingFieldsForMode(mode, inp){
  const type = inp.type;
  const missing = [];
  const need = MODES[mode].min(type);

  // map display labels to checks
  const has = {
    'Settlement/Amount (P)': inp.P>0,
    'APR': inp.apr>0,
    'Term (months)': inp.n>0,
    'Monthly payment (M)': inp.M>0,
    'Balloon/GFV (B)': (type==='pcp' ? inp.B>=0 && inp.B!==null && inp.B!==undefined && (mode!=='monthly' || true) : true),
    'Month X': inp.k>0 || inp.k===0,
    'Target balance @ X': inp.target>0 || inp.target===0
  };

  need.forEach(label=>{
    // Balloon requirement: PCP and balloon should be provided when it affects solvability
    if(label.includes('Balloon') && type==='pcp'){
      const must = (mode!=='balloon'); // for balloon mode, balloon is output so not required
      if(must && !(inp.B>0 || inp.B===0)) missing.push(label);
      // Allow blank balloon if user explicitly sets to 0, but that’s HP-like PCP.
    } else if(!has[label]) {
      missing.push(label);
    }
  });

  // Specific: if PCP mode and balloon field empty, treat as missing where needed
  if(type==='pcp' && (mode==='monthly' || mode==='apr' || mode==='term' || mode==='amount' || mode==='balance' || mode==='pay_to_target' || mode==='term_to_target')){
    // For PCP calculations, balloon is genuinely required unless user sets it.
    // If input left blank => parseMoney gives 0, which could be legitimate; so we detect blank string.
    const rawB = (qs('#s-B').value||'').trim();
    if(rawB==='' && mode!=='balloon'){
      // Balloon is required for PCP, except if the user is intentionally modelling a £0 balloon PCP (rare)
      missing.push('Balloon/GFV (B)');
    }
  }

  // Month X only applies to some modes
  if((mode==='balance' || mode==='pay_to_target' || mode==='term_to_target')){
    const rawK=(qs('#s-k').value||'').trim();
    if(rawK==='') missing.push('Month X');
  }
  if((mode==='pay_to_target' || mode==='term_to_target')){
    const rawT=(qs('#s-target').value||'').trim();
    if(rawT==='') missing.push('Target balance @ X');
  }

  // De-dup
  return Array.from(new Set(missing));
}

function clearOutputs(){
  qs('#o-M').textContent = fmtGBP(0);
  qs('#o-total').textContent = fmtGBP(0);
  qs('#o-interest').textContent = fmtGBP(0);
  qs('#o-end').textContent = fmtGBP(0);
  qs('#o-apr').textContent = '—';
  qs('#o-n').textContent = '—';
  qs('#o-P').textContent = '—';
  qs('#o-B').textContent = '—';
  qs('#o-k').textContent = '—';
  qs('#o-balance').textContent = '—';
  qs('#o-balloon-row').style.display = (solverState.type==='pcp') ? '' : 'none';
  qs('#o-balance-row').style.display = 'none';
  qs('#o-x-row').style.display = 'none';
  badge(qs('#solver-verdict'), null, '—');
}

function setSolverOutputs({P, apr, n, M, B, type, k, balance}){
  const tot = totalsFrom(P, apr, n, (type==='pcp'?B:0), type);

  qs('#o-M').textContent = fmtGBP(M ?? tot.M ?? 0);
  qs('#o-total').textContent = fmtGBP(tot.total);
  qs('#o-interest').textContent = fmtGBP(tot.interest);
  qs('#o-end').textContent = fmtGBP(tot.end);

  qs('#o-apr').textContent = fmtAPR(apr);
  qs('#o-n').textContent = n>0 ? String(n) : '—';
  qs('#o-P').textContent = P>0 ? fmtGBP(P) : '—';

  qs('#o-balloon-row').style.display = (type==='pcp') ? '' : 'none';
  qs('#o-B').textContent = (type==='pcp') ? fmtGBP(B||0) : '—';

  if(Number.isFinite(k)){
    qs('#o-x-row').style.display = '';
    qs('#o-k').textContent = String(k);
  } else {
    qs('#o-x-row').style.display = 'none';
    qs('#o-k').textContent = '—';
  }

  if(Number.isFinite(balance)){
    qs('#o-balance-row').style.display = '';
    qs('#o-balance').textContent = fmtGBP(balance);
  } else {
    qs('#o-balance-row').style.display = 'none';
    qs('#o-balance').textContent = '—';
  }
}

function runSolver(){
  const mode = qs('#calc-mode').value;
  const inp = getSolverInputs();
  const miss = missingFieldsForMode(mode, inp);

  if(miss.length){
    badge(qs('#solver-status'), 'warn', 'Need inputs');
    badge(qs('#solver-verdict'), 'warn', 'Missing minimums');
    qs('#solver-explain').innerHTML = `Provide: <span class="font-semibold">${miss.join(', ')}</span>.`;
    clearOutputs();
    return;
  }

  let P=inp.P, apr=inp.apr, n=inp.n, M=inp.M, B=(inp.type==='pcp'?inp.B:0), k=inp.k;
  let balance = null;

  let explain = '';
  let ok = true;

  if(mode==='monthly'){
    M = monthlyPayment(P, apr, n, B, inp.type).M;
    explain = `Monthly payment computed from P=${fmtGBP(P)}, APR=${fmtAPR(apr)}, term=${n} months${inp.type==='pcp'?`, balloon=${fmtGBP(B)}`:''}.`;
  } else if(mode==='apr'){
    apr = solveAPR_fromPMnB(P, M, n, B, inp.type);
    if(apr==null){ ok=false; explain='Could not solve APR (check figures).'; }
    else explain = `Implied APR solved from P=${fmtGBP(P)}, M=${fmtGBP(M)}, term=${n} months${inp.type==='pcp'?`, balloon=${fmtGBP(B)}`:''}.`;
  } else if(mode==='term'){
    n = solveTerm_fromPMaprB(P, M, apr, B, inp.type, 240);
    if(n==null){ ok=false; explain='Could not solve term (check figures).'; }
    else explain = `Term solved from P=${fmtGBP(P)}, APR=${fmtAPR(apr)}, M=${fmtGBP(M)}${inp.type==='pcp'?`, balloon=${fmtGBP(B)}`:''}.`;
  } else if(mode==='amount'){
    P = solveP_fromMaprnB(M, apr, n, B, inp.type);
    if(P==null){ ok=false; explain='Could not solve settlement/amount (check figures).'; }
    else explain = `Settlement/amount solved from APR=${fmtAPR(apr)}, term=${n} months, M=${fmtGBP(M)}${inp.type==='pcp'?`, balloon=${fmtGBP(B)}`:''}.`;
  } else if(mode==='balloon'){
    // force PCP
    B = solveBalloon_fromPMaprn(P, M, apr, n);
    if(B==null){ ok=false; explain='Could not solve balloon (check figures).'; }
    else explain = `Implied balloon solved from P=${fmtGBP(P)}, APR=${fmtAPR(apr)}, term=${n} months, M=${fmtGBP(M)}.`;
  } else if(mode==='balance'){
    balance = outstandingBalance(P, apr, n, k, B, inp.type);
    explain = `Outstanding balance at month ${k} computed from P=${fmtGBP(P)}, APR=${fmtAPR(apr)}, term=${n} months${inp.type==='pcp'?`, balloon=${fmtGBP(B)}`:''}.`;
  } else if(mode==='pay_to_target'){
    const Mreq = paymentToHitTarget(P, apr, n, k, B, inp.type, inp.target);
    if(Mreq==null){ ok=false; explain='Could not solve monthly payment (check term vs month X).'; }
    else { M = Mreq; balance = outstandingBalance(P, apr, n, k, B, inp.type); explain = `Monthly payment computed so balance at month ${k} equals target ${fmtGBP(inp.target)}.`; }
  } else if(mode==='term_to_target'){
    const res = solveTermToMatchBalanceAtK(P, apr, k, inp.target, B, inp.type, 240);
    if(!res){ ok=false; explain='Could not find a term within the search range.'; }
    else {
      n = res.n;
      M = monthlyPayment(P, apr, n, B, inp.type).M;
      balance = res.bal;
      explain = `Found term ${n} months so balance at month ${k} is closest to target ${fmtGBP(inp.target)}.`;
    }
  }

  if(!ok){
    badge(qs('#solver-status'), 'bad', 'Not solvable');
    badge(qs('#solver-verdict'), 'bad', 'Check inputs');
    qs('#solver-explain').textContent = explain;
    clearOutputs();
    return;
  }

  // render outputs
  setSolverOutputs({P, apr, n, M, B, type: inp.type, k: (mode.includes('balance')||mode.includes('target'))?k:NaN, balance: (mode==='balance'||mode.includes('target'))?balance:NaN});
  badge(qs('#solver-status'), 'good', 'Solved');
  badge(qs('#solver-verdict'), 'good', MODES[mode].title);
  qs('#solver-explain').textContent = explain;
}

/* ---------------------------
   COMPARISON WIRING
----------------------------*/
const compareState = { leftType:'hp', rightType:'hp' };

function setDealType(side, type){
  if(side==='left') compareState.leftType = type;
  if(side==='right') compareState.rightType = type;
  qsa(`[data-side="${side}"]`).forEach(btn=>{
    const active = btn.dataset.type === type;
    btn.classList.toggle('active', active);
    btn.style.background = active ? 'var(--racing)' : '#fff';
    btn.style.color = active ? '#fff' : 'var(--racing)';
  });

  qs(`#${side}-B-wrap`).style.display = (type==='pcp') ? '' : 'none';
  tickCompare();
}

function getDeal(side){
  const P = parseMoney(qs(`#${side}-P`).value);
  const apr = parsePct(qs(`#${side}-apr`).value);
  const n = parseIntish(qs(`#${side}-n`).value);
  const Mraw = parseMoney(qs(`#${side}-M`).value);
  const Braw = parseMoney(qs(`#${side}-B`).value);
  const type = (side==='left') ? compareState.leftType : compareState.rightType;
  const B = (type==='pcp') ? Braw : 0;
  const out = totalsFrom(P, apr, n, B, type);
  // If user manually entered M, we keep it for “implied APR” workflows elsewhere; for outputs, we use computed.
  // For the UI results we always show computed monthly from P/apr/n/B if possible; if insufficient, show entered.
  const useComputed = (P>0 && (apr>0 || apr===0) && n>0);
  const M = useComputed ? out.M : (Mraw||0);
  return {P, apr, n, B, type, M, ...out};
}

function tickCompare(){
  const L = getDeal('left');
  const R = getDeal('right');

  qs('#left-out-M').textContent = fmtGBP(L.M);
  qs('#left-out-total').textContent = fmtGBP(L.total);
  qs('#left-out-int').textContent = fmtGBP(L.interest);
  qs('#left-out-end').textContent = fmtGBP(L.end);

  qs('#right-out-M').textContent = fmtGBP(R.M);
  qs('#right-out-total').textContent = fmtGBP(R.total);
  qs('#right-out-int').textContent = fmtGBP(R.interest);
  qs('#right-out-end').textContent = fmtGBP(R.end);

  const dM = (R.M||0) - (L.M||0);
  const dI = (R.interest||0) - (L.interest||0);
  const dE = (R.end||0) - (L.end||0);

  function setDelta(el, v){
    const txt = (v>=0?'+':'') + fmtGBP(Math.abs(v)).replace('£','£');
    const fixed = (v>=0?'+':'') + currency.format(v).replace('£-','-£');
    el.textContent = fixed;
    el.classList.remove('good','warn','bad');
    // For refinance, lower is usually better
    if(v<0) el.classList.add('good');
    else if(v>0) el.classList.add('bad');
    else el.classList.add('good');
  }
  setDelta(qs('#cmp-dM'), dM);
  setDelta(qs('#cmp-dI'), dI);
  setDelta(qs('#cmp-dE'), dE);
}

function solveMatch(){
  const k = parseIntish(qs('#match-k').value);
  const L = getDeal('left');
  const R = getDeal('right');

  const verdict = qs('#match-verdict');
  const targetEl = qs('#match-target');
  const termEl = qs('#match-term');
  const monthlyEl = qs('#match-monthly');
  const newbalEl = qs('#match-newbal');
  const diffEl = qs('#match-diff');

  verdict.classList.remove('good','warn','bad');
  diffEl.classList.remove('good','warn','bad');

  // Minimal checks (current)
  const missing = [];
  if(!(L.P>0)) missing.push('Current settlement (balance today)');
  if(!(L.apr>0 || L.apr===0)) missing.push('Current APR');
  if(!(L.n>0)) missing.push('Current remaining term');
  if(L.type==='pcp' && (qs('#left-B').value||'').trim()==='') missing.push('Current balloon (PCP)');

  // Minimal checks (new)
  if(!(R.P>0)) missing.push('New amount/settlement');
  if(!(R.apr>0 || R.apr===0)) missing.push('New APR');
  if(R.type==='pcp' && (qs('#right-B').value||'').trim()==='') missing.push('New balloon (PCP)');

  if(!k){
    missing.push('Month X');
  }

  if(missing.length){
    badge(verdict, 'warn', 'Need inputs');
    targetEl.textContent = '—'; termEl.textContent = '—'; monthlyEl.textContent = '—'; newbalEl.textContent = '—'; diffEl.textContent='—';
    return;
  }

  const target = outstandingBalance(L.P, L.apr, L.n, k, L.B, L.type);
  targetEl.textContent = fmtGBP(target);

  const res = solveTermToMatchBalanceAtK(R.P, R.apr, k, target, R.B, R.type, 240);
  if(!res){
    badge(verdict, 'bad', 'No solution');
    termEl.textContent = '—'; monthlyEl.textContent = '—'; newbalEl.textContent = '—'; diffEl.textContent='—';
    return;
  }

  const newTerm = res.n;
  const newMonthly = monthlyPayment(R.P, R.apr, newTerm, R.B, R.type).M;
  const newBal = res.bal;
  const diff = newBal - target;

  termEl.textContent = `${newTerm} months`;
  monthlyEl.textContent = fmtGBP(newMonthly);
  newbalEl.textContent = fmtGBP(newBal);

  diffEl.textContent = (diff>=0?'+':'') + currency.format(diff).replace('£-','-£');

  const tolGood = Math.max(50, 0.01*Math.max(target,newBal));
  if(Math.abs(diff) <= tolGood){
    badge(verdict, 'good', 'Matched');
    diffEl.classList.add('good');
  } else if(diff<0){
    badge(verdict, 'good', 'Lower (better)');
    diffEl.classList.add('good');
  } else {
    badge(verdict, 'bad', 'Higher (worse)');
    diffEl.classList.add('bad');
  }

  // Write solved term to New Offer Term box (non-destructive)
  qs('#right-n').value = String(newTerm);
  tickCompare();
}

/* ---------------------------
   TAB + EVENTS
----------------------------*/
function setTab(name){
  qsa('[data-tab]').forEach(b=>{
    const active = b.dataset.tab === name;
    b.classList.toggle('active', active);
    b.style.background = active ? 'var(--racing)' : '#fff';
    b.style.color = active ? '#fff' : 'var(--racing)';
  });
  qs('#tab-solver').classList.toggle('hidden', name!=='solver');
  qs('#tab-compare').classList.toggle('hidden', name!=='compare');
  qs('#tab-notes').classList.toggle('hidden', name!=='notes');
}

function wire(){
  // tabs
  qsa('[data-tab]').forEach(b=>b.addEventListener('click', ()=>setTab(b.dataset.tab)));

  // solver type buttons
  qs('#solver-type-hp').addEventListener('click', ()=>{ setSolverType('hp'); setModeUI(); });
  qs('#solver-type-pcp').addEventListener('click', ()=>{ setSolverType('pcp'); setModeUI(); });

  // solver mode change
  qs('#calc-mode').addEventListener('change', setModeUI);

  // solver calc/clear
  qs('#solver-calc-btn').addEventListener('click', runSolver);
  qs('#solver-clear-btn').addEventListener('click', ()=>{
    ['#s-P','#s-apr','#s-n','#s-M','#s-B','#s-k','#s-target'].forEach(id=>{ const el=qs(id); if(el) el.value=''; });
    badge(qs('#solver-status'), null, 'Ready');
    badge(qs('#solver-verdict'), null, '—');
    qs('#solver-explain').textContent = MODES[qs('#calc-mode').value].explain;
    clearOutputs();
  });

  // Live “minimum inputs” refresh
  ['#s-P','#s-apr','#s-n','#s-M','#s-B','#s-k','#s-target'].forEach(id=>{
    const el=qs(id); if(!el) return;
    el.addEventListener('input', ()=>{
      // Keep the min list stable; update status only when user actually runs calculate.
      clearOutputs();
    });
  });

  // compare: type toggle
  qsa('[data-side="left"]').forEach(btn=>btn.addEventListener('click', ()=>setDealType('left', btn.dataset.type)));
  qsa('[data-side="right"]').forEach(btn=>btn.addEventListener('click', ()=>setDealType('right', btn.dataset.type)));

  // compare: tick on input
  ['left','right'].forEach(side=>{
    ['P','apr','n','M','B'].forEach(f=>{
      const el=qs(`#${side}-${f}`); if(!el) return;
      el.addEventListener('input', tickCompare);
    });
  });

  // match solver
  qs('#match-btn').addEventListener('click', solveMatch);

  // initial
  setSolverType('hp');
  setModeUI();
  clearOutputs();
  setDealType('left','hp');
  setDealType('right','hp');
  tickCompare();
  setTab('solver');
}

if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', wire); else wire();
</script>
</body>
</html>
</template>
<script>
    (function(){
      var tpl = document.getElementById('calc-v18-srcdoc');
      var ifr = document.getElementById('calc-v18-iframe');
      if(ifr && tpl){ ifr.srcdoc = tpl.innerHTML; }
    })();
  </script>
</div>
</div>
</div>
</div>
<div class="tab-content" id="document-upload" style="display:none; height: 100%;">
<div class="w-full h-full flex flex-col">
<div class="bg-white rounded-2xl shadow p-0 border border-gray-200 h-full overflow-hidden">
<iframe allow="camera; microphone; autoplay; encrypted-media;" data-base-src="https://script.google.com/macros/s/AKfycbzeNckPwMZx_7PBbsgcGSsFOoNYw06zmfhs3-mmHKWGTcpZGqJ8GILraiwI7QS9C9MeSQ/exec" id="customer-upload-iframe" src="about:blank" style="width:100%; height:100%; border:0; background:#fff;" title="Customer Document Upload">
</iframe>
</div>
</div>
</div>
<div class="tab-content hidden h-screen flex flex-col bg-gray-100" id="client-files-view" style="display:none; height: 100%;">
<div class="hidden bg-slate-900 text-cyan-400 font-mono text-xs border-b border-cyan-900 shrink-0" id="sys-console">
<div class="flex items-center justify-between px-4 py-2 bg-slate-800">
<div class="flex items-center gap-4">
<div class="flex items-center gap-2">
<div class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse" id="sys-status-dot"></div>
<span class="font-bold uppercase tracking-wider text-red-400" id="sys-status-text">DISCONNECTED</span>
</div>
<div class="h-4 w-px bg-slate-600"></div>
<span id="sys-latency">Latency: --ms</span>
</div>
<div class="flex gap-2">
<button class="px-3 py-1 bg-cyan-700 hover:bg-cyan-600 text-white rounded transition-colors uppercase font-bold tracking-wide text-[10px]" onclick="App.diagnostics.runFullTest()">
                    ▶ Run Diagnostics
                </button>
<button class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded transition-colors text-[10px]" onclick="document.getElementById('sys-log-container').classList.toggle('hidden')">
                    Toggle Logs
                </button>
<button class="px-3 py-1 bg-green-700 hover:bg-green-600 text-white rounded transition-colors uppercase font-bold tracking-wide text-[10px]" onclick="console.log('Force Clicked'); if(window.App &amp;&amp; App.handlers &amp;&amp; App.handlers.runFolderSearch) App.handlers.runFolderSearch('');">
                ▼ FORCE LOAD FILES
            </button>
</div>
</div>
<div class="hidden h-48 overflow-y-auto p-4 space-y-1 bg-slate-950/50 shadow-inner" id="sys-log-container">
<div class="opacity-50 border-b border-dashed border-slate-700 pb-2 mb-2">System Console Initialized... waiting for command.</div>
</div>
</div>
<div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm flex items-center justify-between shrink-0">
<div>
<h2 class="text-xl font-bold text-gray-800">Client File Explorer</h2>
<p class="text-sm text-gray-500">Browse all client folders, or type to filter by surname/VRN</p>
</div>
<div class="flex gap-2 w-1/2 max-w-xl">
<div class="relative flex-1">
<input class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all" id="drive-search-input" oninput="App.handlers.handleLiveSearch(this.value)" placeholder="Type Surname to filter (or leave empty to browse all)..." type="text"/>
<svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</div>
<button class="bg-green-700 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-800 transition-colors shadow-sm" onclick="App.handlers.runFolderSearch(document.getElementById(\'drive-search-input\').value)">
                Search
            </button>
</div>
</div>
<div class="drive-layout flex flex-1 overflow-hidden p-4 gap-4">
<div class="w-1/3 bg-white rounded-xl shadow border border-gray-200 flex flex-col overflow-hidden">
<div class="p-3 bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider flex justify-between items-center">
<span>Search Results</span>
<span class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full hidden" id="drive-result-count">0</span>
</div>
<div class="flex-1 overflow-y-auto p-2 space-y-1" id="drive-file-list">
<div class="flex flex-col items-center justify-center h-full text-gray-400">
<div class="bg-gray-50 p-4 rounded-full mb-3">
<svg class="w-8 h-8 opacity-40" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</div>
<p class="text-sm font-medium">Ready to search</p>
<p class="text-xs opacity-70">Enter a client VRN above</p>
</div>
</div>
</div>
<div class="w-2/3 bg-white rounded-xl shadow border border-gray-200 flex flex-col overflow-hidden relative">
<div class="h-10 bg-gray-50 border-b border-gray-200 flex items-center justify-between px-4">
<span class="text-xs font-semibold text-gray-500 uppercase">Document Preview</span>
<button class="text-xs text-red-500 hover:text-red-700 font-medium" onclick="document.getElementById('drive-preview-frame').src='about:blank'; document.getElementById('drive-placeholder').style.display='flex';">
                    Close Preview
                </button>
</div>
<div class="flex-1 relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-gray-100">
<iframe class="w-full h-full border-none bg-white" id="drive-preview-frame" src="about:blank"></iframe>
<div class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-10" id="drive-placeholder">
<div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 text-center max-w-sm">
<div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
<svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</div>
<h4 class="text-lg font-bold text-gray-800">No Document Selected</h4>
<p class="text-sm text-gray-500 mt-2">Click a file from the list on the left to preview it here.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="whatsapp-messenger" style="display:none; height: 100%;">
<div class="w-full h-full flex flex-col">
<div class="bg-white rounded-2xl shadow p-0 border border-gray-200 h-full overflow-hidden">
<iframe allow="camera; microphone; autoplay; encrypted-media;" id="whatsapp-messenger-iframe" style="width:100%; height:100%; border:0; background:#fff;" title="WhatsApp Messenger">
</iframe>
</div>
<template id="whatsapp-messenger-srcdoc"><!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>WhatsApp Chat Inbox</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>
<style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #555; }
        [x-cloak] { display: none !important; }
        /* Brand Colors */
        .brand-bg-dark { background-color: #004225; }
        .brand-bg-dark-hover:hover { background-color: #00331e; }
        .brand-bg-light { background-color: #E0F2E9; }
        .brand-bg-accent { background-color: #C1E1C1; }
        .brand-text-dark { color: #004225; }
        .brand-focus-ring:focus {
            --tw-ring-color: #004225;
        }
    </style>
<style id="tailwind-built">
/*! tailwindcss v4.2.0 | MIT License | https://tailwindcss.com */
@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-translate-x:0;--tw-translate-y:0;--tw-translate-z:0;--tw-rotate-x:initial;--tw-rotate-y:initial;--tw-rotate-z:initial;--tw-skew-x:initial;--tw-skew-y:initial;--tw-space-y-reverse:0;--tw-space-x-reverse:0;--tw-divide-y-reverse:0;--tw-border-style:solid;--tw-leading:initial;--tw-font-weight:initial;--tw-tracking:initial;--tw-shadow:0 0 #0000;--tw-shadow-color:initial;--tw-shadow-alpha:100%;--tw-inset-shadow:0 0 #0000;--tw-inset-shadow-color:initial;--tw-inset-shadow-alpha:100%;--tw-ring-color:initial;--tw-ring-shadow:0 0 #0000;--tw-inset-ring-color:initial;--tw-inset-ring-shadow:0 0 #0000;--tw-ring-inset:initial;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-offset-shadow:0 0 #0000;--tw-outline-style:solid;--tw-blur:initial;--tw-brightness:initial;--tw-contrast:initial;--tw-grayscale:initial;--tw-hue-rotate:initial;--tw-invert:initial;--tw-opacity:initial;--tw-saturate:initial;--tw-sepia:initial;--tw-drop-shadow:initial;--tw-drop-shadow-color:initial;--tw-drop-shadow-alpha:100%;--tw-drop-shadow-size:initial;--tw-backdrop-blur:initial;--tw-backdrop-brightness:initial;--tw-backdrop-contrast:initial;--tw-backdrop-grayscale:initial;--tw-backdrop-hue-rotate:initial;--tw-backdrop-invert:initial;--tw-backdrop-opacity:initial;--tw-backdrop-saturate:initial;--tw-backdrop-sepia:initial;--tw-duration:initial}}}@layer theme{:root,:host{--font-sans:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";--font-mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;--color-red-50:oklch(97.1% .013 17.38);--color-red-100:oklch(93.6% .032 17.717);--color-red-200:oklch(88.5% .062 18.334);--color-red-300:oklch(80.8% .114 19.571);--color-red-400:oklch(70.4% .191 22.216);--color-red-500:oklch(63.7% .237 25.331);--color-red-600:oklch(57.7% .245 27.325);--color-red-700:oklch(50.5% .213 27.518);--color-red-800:oklch(44.4% .177 26.899);--color-orange-600:oklch(64.6% .222 41.116);--color-amber-50:oklch(98.7% .022 95.277);--color-amber-100:oklch(96.2% .059 95.617);--color-yellow-50:oklch(98.7% .026 102.212);--color-yellow-100:oklch(97.3% .071 103.193);--color-yellow-200:oklch(94.5% .129 101.54);--color-yellow-300:oklch(90.5% .182 98.111);--color-yellow-400:oklch(85.2% .199 91.936);--color-yellow-500:oklch(79.5% .184 86.047);--color-yellow-600:oklch(68.1% .162 75.834);--color-yellow-700:oklch(55.4% .135 66.442);--color-yellow-800:oklch(47.6% .114 61.907);--color-green-50:oklch(98.2% .018 155.826);--color-green-100:oklch(96.2% .044 156.743);--color-green-200:oklch(92.5% .084 155.995);--color-green-400:oklch(79.2% .209 151.711);--color-green-500:oklch(72.3% .219 149.579);--color-green-600:oklch(62.7% .194 149.214);--color-green-700:oklch(52.7% .154 150.069);--color-green-800:oklch(44.8% .119 151.328);--color-green-900:oklch(39.3% .095 152.535);--color-teal-50:oklch(98.4% .014 180.72);--color-teal-100:oklch(95.3% .051 180.801);--color-cyan-400:oklch(78.9% .154 211.53);--color-cyan-600:oklch(60.9% .126 221.723);--color-cyan-700:oklch(52% .105 223.128);--color-cyan-900:oklch(39.8% .07 227.392);--color-blue-50:oklch(97% .014 254.604);--color-blue-100:oklch(93.2% .032 255.585);--color-blue-200:oklch(88.2% .059 254.128);--color-blue-300:oklch(80.9% .105 251.813);--color-blue-500:oklch(62.3% .214 259.815);--color-blue-600:oklch(54.6% .245 262.881);--color-blue-700:oklch(48.8% .243 264.376);--color-blue-800:oklch(42.4% .199 265.638);--color-indigo-100:oklch(93% .034 272.788);--color-indigo-700:oklch(45.7% .24 277.023);--color-purple-50:oklch(97.7% .014 308.299);--color-purple-100:oklch(94.6% .033 307.174);--color-purple-600:oklch(55.8% .288 302.321);--color-rose-50:oklch(96.9% .015 12.422);--color-rose-100:oklch(94.1% .03 12.58);--color-slate-50:oklch(98.4% .003 247.858);--color-slate-600:oklch(44.6% .043 257.281);--color-slate-700:oklch(37.2% .044 257.287);--color-slate-800:oklch(27.9% .041 260.031);--color-slate-900:oklch(20.8% .042 265.755);--color-slate-950:oklch(12.9% .042 264.695);--color-gray-50:oklch(98.5% .002 247.839);--color-gray-100:oklch(96.7% .003 264.542);--color-gray-200:oklch(92.8% .006 264.531);--color-gray-300:oklch(87.2% .01 258.338);--color-gray-400:oklch(70.7% .022 261.325);--color-gray-500:oklch(55.1% .027 264.364);--color-gray-600:oklch(44.6% .03 256.802);--color-gray-700:oklch(37.3% .034 259.733);--color-gray-800:oklch(27.8% .033 256.848);--color-gray-900:oklch(21% .034 264.665);--color-black:#000;--color-white:#fff;--spacing:.25rem;--container-sm:24rem;--container-md:28rem;--container-xl:36rem;--container-2xl:42rem;--container-4xl:56rem;--container-6xl:72rem;--container-7xl:80rem;--text-xs:.75rem;--text-xs--line-height:calc(1 / .75);--text-sm:.875rem;--text-sm--line-height:calc(1.25 / .875);--text-base:1rem;--text-base--line-height:calc(1.5 / 1);--text-lg:1.125rem;--text-lg--line-height:calc(1.75 / 1.125);--text-xl:1.25rem;--text-xl--line-height:calc(1.75 / 1.25);--text-2xl:1.5rem;--text-2xl--line-height:calc(2 / 1.5);--text-3xl:1.875rem;--text-3xl--line-height:calc(2.25 / 1.875);--text-4xl:2.25rem;--text-4xl--line-height:calc(2.5 / 2.25);--font-weight-medium:500;--font-weight-semibold:600;--font-weight-bold:700;--font-weight-extrabold:800;--tracking-wide:.025em;--tracking-wider:.05em;--tracking-widest:.1em;--leading-tight:1.25;--leading-snug:1.375;--leading-relaxed:1.625;--radius-md:.375rem;--radius-lg:.5rem;--radius-xl:.75rem;--radius-2xl:1rem;--animate-pulse:pulse 2s cubic-bezier(.4, 0, .6, 1) infinite;--animate-bounce:bounce 1s infinite;--blur-sm:8px;--default-transition-duration:.15s;--default-transition-timing-function:cubic-bezier(.4, 0, .2, 1);--default-font-family:var(--font-sans);--default-mono-font-family:var(--font-mono)}}@layer base{*,:after,:before,::backdrop{box-sizing:border-box;border:0 solid;margin:0;padding:0}::file-selector-button{box-sizing:border-box;border:0 solid;margin:0;padding:0}html,:host{-webkit-text-size-adjust:100%;tab-size:4;line-height:1.5;font-family:var(--default-font-family,ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji");font-feature-settings:var(--default-font-feature-settings,normal);font-variation-settings:var(--default-font-variation-settings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:var(--default-mono-font-family,ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace);font-feature-settings:var(--default-mono-font-feature-settings,normal);font-variation-settings:var(--default-mono-font-variation-settings,normal);font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}:-moz-focusring{outline:auto}progress{vertical-align:baseline}summary{display:list-item}ol,ul,menu{list-style:none}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}button,input,select,optgroup,textarea{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}::file-selector-button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}:where(select:is([multiple],[size])) optgroup{font-weight:bolder}:where(select:is([multiple],[size])) optgroup option{padding-inline-start:20px}::file-selector-button{margin-inline-end:4px}::placeholder{opacity:1}@supports (not ((-webkit-appearance:-apple-pay-button))) or (contain-intrinsic-size:1px){::placeholder{color:currentColor}@supports (color:color-mix(in lab, red, red)){::placeholder{color:color-mix(in oklab, currentcolor 50%, transparent)}}}textarea{resize:vertical}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-date-and-time-value{min-height:1lh;text-align:inherit}::-webkit-datetime-edit{display:inline-flex}::-webkit-datetime-edit-fields-wrapper{padding:0}::-webkit-datetime-edit{padding-block:0}::-webkit-datetime-edit-year-field{padding-block:0}::-webkit-datetime-edit-month-field{padding-block:0}::-webkit-datetime-edit-day-field{padding-block:0}::-webkit-datetime-edit-hour-field{padding-block:0}::-webkit-datetime-edit-minute-field{padding-block:0}::-webkit-datetime-edit-second-field{padding-block:0}::-webkit-datetime-edit-millisecond-field{padding-block:0}::-webkit-datetime-edit-meridiem-field{padding-block:0}::-webkit-calendar-picker-indicator{line-height:1}:-moz-ui-invalid{box-shadow:none}button,input:where([type=button],[type=reset],[type=submit]){appearance:button}::file-selector-button{appearance:button}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[hidden]:where(:not([hidden=until-found])){display:none!important}}@layer components;@layer utilities{.pointer-events-none{pointer-events:none}.collapse{visibility:collapse}.visible{visibility:visible}.sr-only{clip-path:inset(50%);white-space:nowrap;border-width:0;width:1px;height:1px;margin:-1px;padding:0;position:absolute;overflow:hidden}.absolute{position:absolute}.fixed{position:fixed}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:calc(var(--spacing) * 0)}.start{inset-inline-start:var(--spacing)}.end{inset-inline-end:var(--spacing)}.top-0{top:calc(var(--spacing) * 0)}.top-1{top:calc(var(--spacing) * 1)}.top-1\/2{top:50%}.top-2\.5{top:calc(var(--spacing) * 2.5)}.top-4{top:calc(var(--spacing) * 4)}.top-8{top:calc(var(--spacing) * 8)}.right-0{right:calc(var(--spacing) * 0)}.right-3{right:calc(var(--spacing) * 3)}.right-4{right:calc(var(--spacing) * 4)}.right-5{right:calc(var(--spacing) * 5)}.bottom-5{bottom:calc(var(--spacing) * 5)}.bottom-24{bottom:calc(var(--spacing) * 24)}.left-1{left:calc(var(--spacing) * 1)}.left-3{left:calc(var(--spacing) * 3)}.z-0{z-index:0}.z-10{z-index:10}.z-20{z-index:20}.z-40{z-index:40}.z-50{z-index:50}.z-\[9999\]{z-index:9999}.col-span-12{grid-column:span 12/span 12}.col-start-1{grid-column-start:1}.col-start-6{grid-column-start:6}.col-end-8{grid-column-end:8}.col-end-13{grid-column-end:13}.container{width:100%}@media (min-width:40rem){.container{max-width:40rem}}@media (min-width:48rem){.container{max-width:48rem}}@media (min-width:64rem){.container{max-width:64rem}}@media (min-width:80rem){.container{max-width:80rem}}@media (min-width:96rem){.container{max-width:96rem}}.-mx-2{margin-inline:calc(var(--spacing) * -2)}.mx-4{margin-inline:calc(var(--spacing) * 4)}.mx-auto{margin-inline:auto}.my-4{margin-block:calc(var(--spacing) * 4)}.my-6{margin-block:calc(var(--spacing) * 6)}.-mt-1{margin-top:calc(var(--spacing) * -1)}.-mt-px{margin-top:-1px}.mt-0{margin-top:calc(var(--spacing) * 0)}.mt-0\.5{margin-top:calc(var(--spacing) * .5)}.mt-1{margin-top:calc(var(--spacing) * 1)}.mt-2{margin-top:calc(var(--spacing) * 2)}.mt-3{margin-top:calc(var(--spacing) * 3)}.mt-4{margin-top:calc(var(--spacing) * 4)}.mt-5{margin-top:calc(var(--spacing) * 5)}.mt-6{margin-top:calc(var(--spacing) * 6)}.mt-8{margin-top:calc(var(--spacing) * 8)}.mt-\[0\.2375rem\]{margin-top:.2375rem}.mr-2{margin-right:calc(var(--spacing) * 2)}.mr-3{margin-right:calc(var(--spacing) * 3)}.mb-1{margin-bottom:calc(var(--spacing) * 1)}.mb-2{margin-bottom:calc(var(--spacing) * 2)}.mb-3{margin-bottom:calc(var(--spacing) * 3)}.mb-4{margin-bottom:calc(var(--spacing) * 4)}.mb-5{margin-bottom:calc(var(--spacing) * 5)}.mb-6{margin-bottom:calc(var(--spacing) * 6)}.mb-8{margin-bottom:calc(var(--spacing) * 8)}.mb-10{margin-bottom:calc(var(--spacing) * 10)}.ml-2{margin-left:calc(var(--spacing) * 2)}.ml-3{margin-left:calc(var(--spacing) * 3)}.ml-4{margin-left:calc(var(--spacing) * 4)}.block{display:block}.contents{display:contents}.flex{display:flex}.grid{display:grid}.hidden{display:none}.inline{display:inline}.inline-block{display:inline-block}.inline-flex{display:inline-flex}.table{display:table}.h-2{height:calc(var(--spacing) * 2)}.h-2\.5{height:calc(var(--spacing) * 2.5)}.h-4{height:calc(var(--spacing) * 4)}.h-5{height:calc(var(--spacing) * 5)}.h-6{height:calc(var(--spacing) * 6)}.h-8{height:calc(var(--spacing) * 8)}.h-9{height:calc(var(--spacing) * 9)}.h-10{height:calc(var(--spacing) * 10)}.h-12{height:calc(var(--spacing) * 12)}.h-14{height:calc(var(--spacing) * 14)}.h-16{height:calc(var(--spacing) * 16)}.h-20{height:calc(var(--spacing) * 20)}.h-24{height:calc(var(--spacing) * 24)}.h-48{height:calc(var(--spacing) * 48)}.h-64{height:calc(var(--spacing) * 64)}.h-\[24\.7px\]{height:24.7px}.h-full{height:100%}.h-screen{height:100vh}.max-h-\[90vh\]{max-height:90vh}.max-h-\[1200px\]{max-height:1200px}.min-h-0{min-height:calc(var(--spacing) * 0)}.min-h-\[900px\]{min-height:900px}.min-h-screen{min-height:100vh}.w-1\/2{width:50%}.w-1\/3{width:33.3333%}.w-2{width:calc(var(--spacing) * 2)}.w-2\.5{width:calc(var(--spacing) * 2.5)}.w-2\/3{width:66.6667%}.w-4{width:calc(var(--spacing) * 4)}.w-5{width:calc(var(--spacing) * 5)}.w-6{width:calc(var(--spacing) * 6)}.w-8{width:calc(var(--spacing) * 8)}.w-9{width:calc(var(--spacing) * 9)}.w-10{width:calc(var(--spacing) * 10)}.w-12{width:calc(var(--spacing) * 12)}.w-14{width:calc(var(--spacing) * 14)}.w-16{width:calc(var(--spacing) * 16)}.w-24{width:calc(var(--spacing) * 24)}.w-64{width:calc(var(--spacing) * 64)}.w-72{width:calc(var(--spacing) * 72)}.w-80{width:calc(var(--spacing) * 80)}.w-\[380px\]{width:380px}.w-auto{width:auto}.w-fit{width:fit-content}.w-full{width:100%}.w-px{width:1px}.w-screen{width:100vw}.max-w-2xl{max-width:var(--container-2xl)}.max-w-4xl{max-width:var(--container-4xl)}.max-w-6xl{max-width:var(--container-6xl)}.max-w-7xl{max-width:var(--container-7xl)}.max-w-\[1700px\]{max-width:1700px}.max-w-md{max-width:var(--container-md)}.max-w-sm{max-width:var(--container-sm)}.max-w-xl{max-width:var(--container-xl)}.min-w-0{min-width:calc(var(--spacing) * 0)}.min-w-\[110px\]{min-width:110px}.min-w-\[120px\]{min-width:120px}.min-w-full{min-width:100%}.flex-1{flex:1}.flex-\[2\]{flex:2}.flex-auto{flex:auto}.flex-shrink{flex-shrink:1}.flex-shrink-0{flex-shrink:0}.shrink{flex-shrink:1}.shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.border-collapse{border-collapse:collapse}.-translate-y-1\/2{--tw-translate-y:calc(calc(1 / 2 * 100%) * -1);translate:var(--tw-translate-x) var(--tw-translate-y)}.translate-y-20{--tw-translate-y:calc(var(--spacing) * 20);translate:var(--tw-translate-x) var(--tw-translate-y)}.rotate-45{rotate:45deg}.transform{transform:var(--tw-rotate-x,) var(--tw-rotate-y,) var(--tw-rotate-z,) var(--tw-skew-x,) var(--tw-skew-y,)}.animate-bounce{animation:var(--animate-bounce)}.animate-pulse{animation:var(--animate-pulse)}.cursor-not-allowed{cursor:not-allowed}.cursor-pointer{cursor:pointer}.cursor-wait{cursor:wait}.resize-none{resize:none}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-row{flex-direction:row}.flex-row-reverse{flex-direction:row-reverse}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.items-end{align-items:flex-end}.items-start{align-items:flex-start}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.justify-end{justify-content:flex-end}.justify-start{justify-content:flex-start}.gap-0{gap:calc(var(--spacing) * 0)}.gap-1{gap:calc(var(--spacing) * 1)}.gap-2{gap:calc(var(--spacing) * 2)}.gap-3{gap:calc(var(--spacing) * 3)}.gap-4{gap:calc(var(--spacing) * 4)}.gap-5{gap:calc(var(--spacing) * 5)}.gap-6{gap:calc(var(--spacing) * 6)}.gap-8{gap:calc(var(--spacing) * 8)}:where(.space-y-1>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 1) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 1) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-2>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 2) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-3>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 3) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-4>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 4) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-6>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 6) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 6) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-y-8>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing) * 8) * var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing) * 8) * calc(1 - var(--tw-space-y-reverse)))}:where(.space-x-1\.5>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 1.5) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 1.5) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-2>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 2) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-3>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 3) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-x-reverse)))}:where(.space-x-4>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 4) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-x-reverse)))}.gap-y-2{row-gap:calc(var(--spacing) * 2)}:where(.divide-y>:not(:last-child)){--tw-divide-y-reverse:0;border-bottom-style:var(--tw-border-style);border-top-style:var(--tw-border-style);border-top-width:calc(1px * var(--tw-divide-y-reverse));border-bottom-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)))}:where(.divide-gray-200>:not(:last-child)){border-color:var(--color-gray-200)}.self-center{align-self:center}.self-start{align-self:flex-start}.truncate{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.overflow-auto{overflow:auto}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-x-hidden{overflow-x:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:.25rem}.rounded-2xl{border-radius:var(--radius-2xl)}.rounded-full{border-radius:3.40282e38px}.rounded-lg{border-radius:var(--radius-lg)}.rounded-md{border-radius:var(--radius-md)}.rounded-xl{border-radius:var(--radius-xl)}.rounded-t-xl{border-top-left-radius:var(--radius-xl);border-top-right-radius:var(--radius-xl)}.border{border-style:var(--tw-border-style);border-width:1px}.border-2{border-style:var(--tw-border-style);border-width:2px}.border-t{border-top-style:var(--tw-border-style);border-top-width:1px}.border-t-2{border-top-style:var(--tw-border-style);border-top-width:2px}.border-r{border-right-style:var(--tw-border-style);border-right-width:1px}.border-b{border-bottom-style:var(--tw-border-style);border-bottom-width:1px}.border-b-2{border-bottom-style:var(--tw-border-style);border-bottom-width:2px}.border-l-4{border-left-style:var(--tw-border-style);border-left-width:4px}.border-dashed{--tw-border-style:dashed;border-style:dashed}.border-none{--tw-border-style:none;border-style:none}.border-\[\#001f3f\]{border-color:#001f3f}.border-\[var\(--racing\)\]{border-color:var(--racing)}.border-\[var\(--racing-line\)\]{border-color:var(--racing-line)}.border-\[var\(--racing-line\,\#cfe6dc\)\]{border-color:var(--racing-line,#cfe6dc)}.border-blue-600{border-color:var(--color-blue-600)}.border-cyan-900{border-color:var(--color-cyan-900)}.border-gray-100{border-color:var(--color-gray-100)}.border-gray-200{border-color:var(--color-gray-200)}.border-gray-300{border-color:var(--color-gray-300)}.border-gray-400{border-color:var(--color-gray-400)}.border-green-200{border-color:var(--color-green-200)}.border-green-400{border-color:var(--color-green-400)}.border-red-200{border-color:var(--color-red-200)}.border-slate-700{border-color:var(--color-slate-700)}.border-white{border-color:var(--color-white)}.border-white\/20{border-color:#fff3}@supports (color:color-mix(in lab, red, red)){.border-white\/20{border-color:color-mix(in oklab, var(--color-white) 20%, transparent)}}.border-white\/30{border-color:#ffffff4d}@supports (color:color-mix(in lab, red, red)){.border-white\/30{border-color:color-mix(in oklab, var(--color-white) 30%, transparent)}}.border-yellow-300{border-color:var(--color-yellow-300)}.border-t-blue-600{border-top-color:var(--color-blue-600)}.border-t-green-600{border-top-color:var(--color-green-600)}.bg-\[\#001f3f\]{background-color:#001f3f}.bg-\[\#004225\]{background-color:#004225}.bg-\[var\(--gold-orange\)\]{background-color:var(--gold-orange)}.bg-\[var\(--pale-green\)\]{background-color:var(--pale-green)}.bg-\[var\(--racing\)\]{background-color:var(--racing)}.bg-\[var\(--racing-mint\)\]{background-color:var(--racing-mint)}.bg-amber-50{background-color:var(--color-amber-50)}.bg-black{background-color:var(--color-black)}.bg-black\/40{background-color:#0006}@supports (color:color-mix(in lab, red, red)){.bg-black\/40{background-color:color-mix(in oklab, var(--color-black) 40%, transparent)}}.bg-black\/60{background-color:#0009}@supports (color:color-mix(in lab, red, red)){.bg-black\/60{background-color:color-mix(in oklab, var(--color-black) 60%, transparent)}}.bg-blue-50{background-color:var(--color-blue-50)}.bg-blue-100{background-color:var(--color-blue-100)}.bg-blue-500{background-color:var(--color-blue-500)}.bg-blue-600{background-color:var(--color-blue-600)}.bg-cyan-700{background-color:var(--color-cyan-700)}.bg-gray-50{background-color:var(--color-gray-50)}.bg-gray-100{background-color:var(--color-gray-100)}.bg-gray-200{background-color:var(--color-gray-200)}.bg-gray-300{background-color:var(--color-gray-300)}.bg-gray-700{background-color:var(--color-gray-700)}.bg-gray-800\/50{background-color:#1e293980}@supports (color:color-mix(in lab, red, red)){.bg-gray-800\/50{background-color:color-mix(in oklab, var(--color-gray-800) 50%, transparent)}}.bg-green-50{background-color:var(--color-green-50)}.bg-green-100{background-color:var(--color-green-100)}.bg-green-400{background-color:var(--color-green-400)}.bg-green-500{background-color:var(--color-green-500)}.bg-green-600{background-color:var(--color-green-600)}.bg-green-700{background-color:var(--color-green-700)}.bg-indigo-100{background-color:var(--color-indigo-100)}.bg-purple-50{background-color:var(--color-purple-50)}.bg-purple-600{background-color:var(--color-purple-600)}.bg-red-50{background-color:var(--color-red-50)}.bg-red-100{background-color:var(--color-red-100)}.bg-red-500{background-color:var(--color-red-500)}.bg-red-600{background-color:var(--color-red-600)}.bg-rose-50{background-color:var(--color-rose-50)}.bg-slate-600{background-color:var(--color-slate-600)}.bg-slate-700{background-color:var(--color-slate-700)}.bg-slate-800{background-color:var(--color-slate-800)}.bg-slate-900{background-color:var(--color-slate-900)}.bg-slate-950\/50{background-color:#02061880}@supports (color:color-mix(in lab, red, red)){.bg-slate-950\/50{background-color:color-mix(in oklab, var(--color-slate-950) 50%, transparent)}}.bg-teal-50{background-color:var(--color-teal-50)}.bg-white{background-color:var(--color-white)}.bg-white\/10{background-color:#ffffff1a}@supports (color:color-mix(in lab, red, red)){.bg-white\/10{background-color:color-mix(in oklab, var(--color-white) 10%, transparent)}}.bg-white\/15{background-color:#ffffff26}@supports (color:color-mix(in lab, red, red)){.bg-white\/15{background-color:color-mix(in oklab, var(--color-white) 15%, transparent)}}.bg-white\/60{background-color:#fff9}@supports (color:color-mix(in lab, red, red)){.bg-white\/60{background-color:color-mix(in oklab, var(--color-white) 60%, transparent)}}.bg-white\/70{background-color:#ffffffb3}@supports (color:color-mix(in lab, red, red)){.bg-white\/70{background-color:color-mix(in oklab, var(--color-white) 70%, transparent)}}.bg-white\/80{background-color:#fffc}@supports (color:color-mix(in lab, red, red)){.bg-white\/80{background-color:color-mix(in oklab, var(--color-white) 80%, transparent)}}.bg-yellow-50{background-color:var(--color-yellow-50)}.bg-yellow-100{background-color:var(--color-yellow-100)}.bg-yellow-400{background-color:var(--color-yellow-400)}.bg-yellow-500{background-color:var(--color-yellow-500)}.bg-\[url\(\'https\:\/\/www\.transparenttextures\.com\/patterns\/cubes\.png\'\)\]{background-image:url(https://www.transparenttextures.com/patterns/cubes.png)}.bg-contain{background-size:contain}.bg-center{background-position:50%}.bg-no-repeat{background-repeat:no-repeat}.object-contain{object-fit:contain}.object-cover{object-fit:cover}.p-0{padding:calc(var(--spacing) * 0)}.p-2{padding:calc(var(--spacing) * 2)}.p-3{padding:calc(var(--spacing) * 3)}.p-4{padding:calc(var(--spacing) * 4)}.p-5{padding:calc(var(--spacing) * 5)}.p-6{padding:calc(var(--spacing) * 6)}.p-8{padding:calc(var(--spacing) * 8)}.px-1{padding-inline:calc(var(--spacing) * 1)}.px-2{padding-inline:calc(var(--spacing) * 2)}.px-3{padding-inline:calc(var(--spacing) * 3)}.px-4{padding-inline:calc(var(--spacing) * 4)}.px-5{padding-inline:calc(var(--spacing) * 5)}.px-6{padding-inline:calc(var(--spacing) * 6)}.py-0\.5{padding-block:calc(var(--spacing) * .5)}.py-1{padding-block:calc(var(--spacing) * 1)}.py-1\.5{padding-block:calc(var(--spacing) * 1.5)}.py-2{padding-block:calc(var(--spacing) * 2)}.py-2\.5{padding-block:calc(var(--spacing) * 2.5)}.py-3{padding-block:calc(var(--spacing) * 3)}.py-4{padding-block:calc(var(--spacing) * 4)}.py-5{padding-block:calc(var(--spacing) * 5)}.py-6{padding-block:calc(var(--spacing) * 6)}.py-8{padding-block:calc(var(--spacing) * 8)}.py-\[0\.2375rem\]{padding-block:.2375rem}.pt-1{padding-top:calc(var(--spacing) * 1)}.pt-2{padding-top:calc(var(--spacing) * 2)}.pt-3{padding-top:calc(var(--spacing) * 3)}.pt-4{padding-top:calc(var(--spacing) * 4)}.pt-10{padding-top:calc(var(--spacing) * 10)}.pr-2{padding-right:calc(var(--spacing) * 2)}.pr-4{padding-right:calc(var(--spacing) * 4)}.pr-12{padding-right:calc(var(--spacing) * 12)}.pr-28{padding-right:calc(var(--spacing) * 28)}.pb-2{padding-bottom:calc(var(--spacing) * 2)}.pb-3{padding-bottom:calc(var(--spacing) * 3)}.pb-4{padding-bottom:calc(var(--spacing) * 4)}.pl-4{padding-left:calc(var(--spacing) * 4)}.pl-5{padding-left:calc(var(--spacing) * 5)}.pl-6{padding-left:calc(var(--spacing) * 6)}.pl-10{padding-left:calc(var(--spacing) * 10)}.text-center{text-align:center}.text-left{text-align:left}.text-right{text-align:right}.font-mono{font-family:var(--font-mono)}.text-2xl{font-size:var(--text-2xl);line-height:var(--tw-leading,var(--text-2xl--line-height))}.text-3xl{font-size:var(--text-3xl);line-height:var(--tw-leading,var(--text-3xl--line-height))}.text-4xl{font-size:var(--text-4xl);line-height:var(--tw-leading,var(--text-4xl--line-height))}.text-base{font-size:var(--text-base);line-height:var(--tw-leading,var(--text-base--line-height))}.text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}.text-sm{font-size:var(--text-sm);line-height:var(--tw-leading,var(--text-sm--line-height))}.text-xl{font-size:var(--text-xl);line-height:var(--tw-leading,var(--text-xl--line-height))}.text-xs{font-size:var(--text-xs);line-height:var(--tw-leading,var(--text-xs--line-height))}.text-\[0\.6rem\]{font-size:.6rem}.text-\[0\.8rem\]{font-size:.8rem}.text-\[0\.65rem\]{font-size:.65rem}.text-\[0\.85rem\]{font-size:.85rem}.text-\[10px\]{font-size:10px}.text-\[11px\]{font-size:11px}.text-\[12px\]{font-size:12px}.text-\[13px\]{font-size:13px}.leading-relaxed{--tw-leading:var(--leading-relaxed);line-height:var(--leading-relaxed)}.leading-snug{--tw-leading:var(--leading-snug);line-height:var(--leading-snug)}.leading-tight{--tw-leading:var(--leading-tight);line-height:var(--leading-tight)}.font-bold{--tw-font-weight:var(--font-weight-bold);font-weight:var(--font-weight-bold)}.font-extrabold{--tw-font-weight:var(--font-weight-extrabold);font-weight:var(--font-weight-extrabold)}.font-medium{--tw-font-weight:var(--font-weight-medium);font-weight:var(--font-weight-medium)}.font-semibold{--tw-font-weight:var(--font-weight-semibold);font-weight:var(--font-weight-semibold)}.tracking-wide{--tw-tracking:var(--tracking-wide);letter-spacing:var(--tracking-wide)}.tracking-wider{--tw-tracking:var(--tracking-wider);letter-spacing:var(--tracking-wider)}.tracking-widest{--tw-tracking:var(--tracking-widest);letter-spacing:var(--tracking-widest)}.break-words{overflow-wrap:break-word}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.text-\[\#001f3f\]{color:#001f3f}.text-\[\#004225\]{color:#004225}.text-\[var\(--racing-ink\)\]{color:var(--racing-ink)}.text-blue-500{color:var(--color-blue-500)}.text-blue-600{color:var(--color-blue-600)}.text-blue-700{color:var(--color-blue-700)}.text-blue-800{color:var(--color-blue-800)}.text-cyan-400{color:var(--color-cyan-400)}.text-gray-400{color:var(--color-gray-400)}.text-gray-500{color:var(--color-gray-500)}.text-gray-600{color:var(--color-gray-600)}.text-gray-700{color:var(--color-gray-700)}.text-gray-800{color:var(--color-gray-800)}.text-gray-900{color:var(--color-gray-900)}.text-green-400{color:var(--color-green-400)}.text-green-600{color:var(--color-green-600)}.text-green-700{color:var(--color-green-700)}.text-green-800{color:var(--color-green-800)}.text-green-900{color:var(--color-green-900)}.text-indigo-700{color:var(--color-indigo-700)}.text-orange-600{color:var(--color-orange-600)}.text-red-300{color:var(--color-red-300)}.text-red-400{color:var(--color-red-400)}.text-red-500{color:var(--color-red-500)}.text-red-600{color:var(--color-red-600)}.text-red-700{color:var(--color-red-700)}.text-red-800{color:var(--color-red-800)}.text-slate-700{color:var(--color-slate-700)}.text-white{color:var(--color-white)}.text-white\/80{color:#fffc}@supports (color:color-mix(in lab, red, red)){.text-white\/80{color:color-mix(in oklab, var(--color-white) 80%, transparent)}}.text-yellow-300{color:var(--color-yellow-300)}.text-yellow-400{color:var(--color-yellow-400)}.text-yellow-600{color:var(--color-yellow-600)}.text-yellow-700{color:var(--color-yellow-700)}.text-yellow-800{color:var(--color-yellow-800)}.uppercase{text-transform:uppercase}.underline{text-decoration-line:underline}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.placeholder-gray-400::placeholder{color:var(--color-gray-400)}.opacity-0{opacity:0}.opacity-10{opacity:.1}.opacity-40{opacity:.4}.opacity-50{opacity:.5}.opacity-60{opacity:.6}.opacity-70{opacity:.7}.opacity-75{opacity:.75}.opacity-80{opacity:.8}.opacity-90{opacity:.9}.shadow{--tw-shadow:0 1px 3px 0 var(--tw-shadow-color,#0000001a), 0 1px 2px -1px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px var(--tw-shadow-color,#00000040);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-\[0_0_8px_rgba\(34\,197\,94\,0\.6\)\]{--tw-shadow:0 0 8px var(--tw-shadow-color,#22c55e99);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 var(--tw-shadow-color,#0000000d);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px var(--tw-shadow-color,#0000001a), 0 4px 6px -4px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px var(--tw-shadow-color,#0000001a), 0 2px 4px -2px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 3px 0 var(--tw-shadow-color,#0000001a), 0 1px 2px -1px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px var(--tw-shadow-color,#0000001a), 0 8px 10px -6px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.ring-1{--tw-ring-shadow:var(--tw-ring-inset,) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color,currentcolor);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.ring-blue-300{--tw-ring-color:var(--color-blue-300)}.outline{outline-style:var(--tw-outline-style);outline-width:1px}.blur{--tw-blur:blur(8px);filter:var(--tw-blur,) var(--tw-brightness,) var(--tw-contrast,) var(--tw-grayscale,) var(--tw-hue-rotate,) var(--tw-invert,) var(--tw-saturate,) var(--tw-sepia,) var(--tw-drop-shadow,)}.filter{filter:var(--tw-blur,) var(--tw-brightness,) var(--tw-contrast,) var(--tw-grayscale,) var(--tw-hue-rotate,) var(--tw-invert,) var(--tw-saturate,) var(--tw-sepia,) var(--tw-drop-shadow,)}.backdrop-blur-\[1px\]{--tw-backdrop-blur:blur(1px);-webkit-backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,)}.backdrop-blur-sm{--tw-backdrop-blur:blur(var(--blur-sm));-webkit-backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);backdrop-filter:var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,) var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,) var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,)}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter,display,content-visibility,overlay,pointer-events;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-all{transition-property:all;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-colors{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-opacity{transition-property:opacity;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-transform{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.duration-300{--tw-duration:.3s;transition-duration:.3s}.duration-500{--tw-duration:.5s;transition-duration:.5s}.outline-none{--tw-outline-style:none;outline-style:none}@media (hover:hover){.group-hover\:bg-green-100:is(:where(.group):hover *){background-color:var(--color-green-100)}.group-hover\:bg-yellow-200:is(:where(.group):hover *){background-color:var(--color-yellow-200)}.group-hover\:text-blue-700:is(:where(.group):hover *){color:var(--color-blue-700)}.group-hover\:text-green-800:is(:where(.group):hover *){color:var(--color-green-800)}.group-hover\:opacity-100:is(:where(.group):hover *){opacity:1}}.peer-checked\:translate-x-full:is(:where(.peer):checked~*){--tw-translate-x:100%;translate:var(--tw-translate-x) var(--tw-translate-y)}@media (hover:hover){.hover\:border-blue-200:hover{border-color:var(--color-blue-200)}.hover\:bg-\[\#00331e\]:hover{background-color:#00331e}.hover\:bg-amber-100:hover{background-color:var(--color-amber-100)}.hover\:bg-blue-50:hover{background-color:var(--color-blue-50)}.hover\:bg-blue-100:hover{background-color:var(--color-blue-100)}.hover\:bg-blue-700:hover{background-color:var(--color-blue-700)}.hover\:bg-cyan-600:hover{background-color:var(--color-cyan-600)}.hover\:bg-gray-50:hover{background-color:var(--color-gray-50)}.hover\:bg-gray-100:hover{background-color:var(--color-gray-100)}.hover\:bg-gray-300:hover{background-color:var(--color-gray-300)}.hover\:bg-gray-700:hover{background-color:var(--color-gray-700)}.hover\:bg-green-50:hover{background-color:var(--color-green-50)}.hover\:bg-green-600:hover{background-color:var(--color-green-600)}.hover\:bg-green-700:hover{background-color:var(--color-green-700)}.hover\:bg-green-800:hover{background-color:var(--color-green-800)}.hover\:bg-purple-100:hover{background-color:var(--color-purple-100)}.hover\:bg-red-700:hover{background-color:var(--color-red-700)}.hover\:bg-rose-100:hover{background-color:var(--color-rose-100)}.hover\:bg-slate-50:hover{background-color:var(--color-slate-50)}.hover\:bg-slate-600:hover{background-color:var(--color-slate-600)}.hover\:bg-teal-100:hover{background-color:var(--color-teal-100)}.hover\:pl-4:hover{padding-left:calc(var(--spacing) * 4)}.hover\:text-gray-600:hover{color:var(--color-gray-600)}.hover\:text-green-800:hover{color:var(--color-green-800)}.hover\:text-red-700:hover{color:var(--color-red-700)}.hover\:underline:hover{text-decoration-line:underline}.hover\:opacity-90:hover{opacity:.9}}.focus\:border-\[var\(--gold-orange\)\]:focus{border-color:var(--gold-orange)}.focus\:border-green-400:focus{border-color:var(--color-green-400)}.focus\:border-green-500:focus{border-color:var(--color-green-500)}.focus\:border-transparent:focus{border-color:#0000}.focus\:ring-2:focus{--tw-ring-shadow:var(--tw-ring-inset,) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color,currentcolor);box-shadow:var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow)}.focus\:ring-\[var\(--gold-orange\)\]:focus{--tw-ring-color:var(--gold-orange)}.focus\:ring-green-500:focus{--tw-ring-color:var(--color-green-500)}.focus\:ring-green-800:focus{--tw-ring-color:var(--color-green-800)}.focus\:ring-red-500:focus{--tw-ring-color:var(--color-red-500)}.focus\:ring-offset-2:focus{--tw-ring-offset-width:2px;--tw-ring-offset-shadow:var(--tw-ring-inset,) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color)}.focus\:outline-none:focus{--tw-outline-style:none;outline-style:none}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:bg-gray-500:disabled{background-color:var(--color-gray-500)}@media (min-width:40rem){.sm\:col-span-1{grid-column:span 1/span 1}.sm\:col-span-2{grid-column:span 2/span 2}.sm\:mb-0{margin-bottom:calc(var(--spacing) * 0)}.sm\:flex{display:flex}.sm\:w-1\/2{width:50%}.sm\:w-80{width:calc(var(--spacing) * 80)}.sm\:w-auto{width:auto}.sm\:min-w-0{min-width:calc(var(--spacing) * 0)}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:flex-row{flex-direction:row}.sm\:flex-nowrap{flex-wrap:nowrap}.sm\:items-center{align-items:center}:where(.sm\:space-x-2>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing) * 2) * var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-x-reverse)))}.sm\:p-6{padding:calc(var(--spacing) * 6)}.sm\:text-4xl{font-size:var(--text-4xl);line-height:var(--tw-leading,var(--text-4xl--line-height))}}@media (min-width:48rem){.md\:col-span-2{grid-column:span 2/span 2}.md\:flex{display:flex}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.md\:p-0{padding:calc(var(--spacing) * 0)}.md\:p-8{padding:calc(var(--spacing) * 8)}.md\:px-8{padding-inline:calc(var(--spacing) * 8)}.md\:text-3xl{font-size:var(--text-3xl);line-height:var(--tw-leading,var(--text-3xl--line-height))}.md\:text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}}@media (min-width:64rem){.lg\:col-span-5{grid-column:span 5/span 5}.lg\:col-span-7{grid-column:span 7/span 7}.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.lg\:p-8{padding:calc(var(--spacing) * 8)}}@media (min-width:80rem){.xl\:col-span-5{grid-column:span 5/span 5}.xl\:col-span-7{grid-column:span 7/span 7}}}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}@property --tw-rotate-x{syntax:"*";inherits:false}@property --tw-rotate-y{syntax:"*";inherits:false}@property --tw-rotate-z{syntax:"*";inherits:false}@property --tw-skew-x{syntax:"*";inherits:false}@property --tw-skew-y{syntax:"*";inherits:false}@property --tw-space-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-space-x-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-divide-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-leading{syntax:"*";inherits:false}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-tracking{syntax:"*";inherits:false}@property --tw-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-shadow-color{syntax:"*";inherits:false}@property --tw-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-inset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-shadow-color{syntax:"*";inherits:false}@property --tw-inset-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-ring-color{syntax:"*";inherits:false}@property --tw-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-ring-color{syntax:"*";inherits:false}@property --tw-inset-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-ring-inset{syntax:"*";inherits:false}@property --tw-ring-offset-width{syntax:"<length>";inherits:false;initial-value:0}@property --tw-ring-offset-color{syntax:"*";inherits:false;initial-value:#fff}@property --tw-ring-offset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-outline-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-blur{syntax:"*";inherits:false}@property --tw-brightness{syntax:"*";inherits:false}@property --tw-contrast{syntax:"*";inherits:false}@property --tw-grayscale{syntax:"*";inherits:false}@property --tw-hue-rotate{syntax:"*";inherits:false}@property --tw-invert{syntax:"*";inherits:false}@property --tw-opacity{syntax:"*";inherits:false}@property --tw-saturate{syntax:"*";inherits:false}@property --tw-sepia{syntax:"*";inherits:false}@property --tw-drop-shadow{syntax:"*";inherits:false}@property --tw-drop-shadow-color{syntax:"*";inherits:false}@property --tw-drop-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-drop-shadow-size{syntax:"*";inherits:false}@property --tw-backdrop-blur{syntax:"*";inherits:false}@property --tw-backdrop-brightness{syntax:"*";inherits:false}@property --tw-backdrop-contrast{syntax:"*";inherits:false}@property --tw-backdrop-grayscale{syntax:"*";inherits:false}@property --tw-backdrop-hue-rotate{syntax:"*";inherits:false}@property --tw-backdrop-invert{syntax:"*";inherits:false}@property --tw-backdrop-opacity{syntax:"*";inherits:false}@property --tw-backdrop-saturate{syntax:"*";inherits:false}@property --tw-backdrop-sepia{syntax:"*";inherits:false}@property --tw-duration{syntax:"*";inherits:false}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}

/* Patch: missing custom utility from original UI */
.peer-checked\:bg-racing-green-600:is(:where(.peer):checked~*){background-color:#16a34a}
</style>
</head>
<body class="bg-gray-100">
<div class="h-screen w-screen flex flex-col antialiased text-gray-800" x-data="whatsappChat()" x-init="init()">
<div class="flex flex-row h-full w-full overflow-x-hidden">
<div class="flex flex-col py-8 pl-6 pr-2 w-80 bg-white flex-shrink-0">
<div class="flex flex-row items-start justify-start w-full mb-4">
<img alt="CMF Logo SQR" class="h-16 w-16 rounded-lg flex-shrink-0" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://lh3.googleusercontent.com/u/0/d/1zESgE9OpS1KcJapsFvvwcVyr2Ogykz2j=w1000-h1000';" referrerpolicy="no-referrer" src="https://drive.google.com/uc?export=view&amp;id=1zESgE9OpS1KcJapsFvvwcVyr2Ogykz2j"/>
<div class="ml-4 flex flex-col">
<div class="flex items-center space-x-2">
<img alt="colincarcoin" class="h-16 w-auto object-contain" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://lh3.googleusercontent.com/u/0/d/1XN9o3vEh0fo0yxEg-CPgVZOrw856TgaW=w1000-h1000';" referrerpolicy="no-referrer" src="https://lh3.googleusercontent.com/d/19AmXdwRyfPvogLEF-BGxxJeF6zgpAFK7"/>
</div>
<a class="mt-2 text-sm text-white font-semibold brand-bg-dark brand-bg-dark-hover py-2 px-4 rounded-lg text-center w-fit" href="https://www.comparemyfinance.co.uk/s/stories/resolvemyclaim" rel="noopener noreferrer" target="_blank">
                        New Application
                    </a>
</div>
</div>
<div class="flex flex-row items-center brand-bg-light border border-gray-200 w-full p-3 rounded-lg">
<img class="h-12 w-12 rounded-full object-cover border-2 border-white shadow-md flex-shrink-0" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://lh3.googleusercontent.com/u/0/d/1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH=w1000-h1000';" referrerpolicy="no-referrer" src="https://drive.google.com/uc?export=view&amp;id=1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH"/>
<div class="ml-3 flex-grow">
<div class="text-sm font-semibold truncate" x-text="settings.phoneNumberId || 'Phone ID Not Set'"></div>
<div class="text-xs text-gray-500 -mt-1">Your WhatsApp Number ID</div>
<div class="flex items-center space-x-1.5 mt-1">
<div :class="{
                            'bg-green-500': connectionStatus === 'connected',
                            'bg-red-500': connectionStatus === 'failed',
                            'bg-yellow-500': connectionStatus === 'connecting'
                        }" class="w-2.5 h-2.5 rounded-full"></div>
<div :class="{
                            'text-green-700': connectionStatus === 'connected',
                            'text-red-700': connectionStatus === 'failed',
                            'text-yellow-700': connectionStatus === 'connecting'
                        }" class="text-xs font-semibold" x-text="statusText"></div>
</div>
</div>
<button @click="isSettingsOpen = true" class="ml-2 text-sm brand-bg-dark brand-bg-dark-hover text-white py-1 px-3 rounded-lg flex-shrink-0 self-center">
                    Settings
                </button>
</div>
<div class="flex flex-col mt-4 flex-1 min-h-0">
<div class="flex justify-between items-center">
<div class="flex flex-row items-center justify-between text-xs">
<span class="font-bold">Active Conversations</span>
<span class="flex items-center justify-center bg-gray-300 h-4 w-4 rounded-full ml-2" x-text="Object.keys(conversations).length"></span>
</div>
<button @click="fetchConversations()" class="text-gray-400 hover:text-gray-600" title="Refresh Conversations">
<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.18-3.182l-3.182-3.183a8.25 8.25 0 00-11.664 0l-3.18 3.185" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
<div class="flex flex-col space-y-1 mt-4 -mx-2 h-full overflow-y-auto scrollbar-thin">
<template :key="phone" x-for="(convo, phone) in sortedConversations">
<button :class="{'bg-gray-200': activeConversation === phone, 'hover:bg-gray-100': activeConversation !== phone}" @click="selectConversation(phone)" class="flex flex-row items-center rounded-xl p-2 text-left w-full">
<div :title="pinnedConversations.includes(phone) ? 'Unpin conversation' : 'Pin conversation'" @click.stop="togglePin(phone)" class="cursor-pointer">
<div :class="{
                                        'bg-yellow-400 text-gray-800': pinnedConversations.includes(phone), 
                                        'brand-bg-accent': !pinnedConversations.includes(phone)
                                     }" class="flex items-center justify-center h-8 w-8 rounded-full uppercase" x-text="convo.name.charAt(0)">
</div>
</div>
<div class="ml-2 text-sm font-semibold w-full overflow-hidden">
<p x-text="convo.name"></p>
<p class="text-xs text-gray-500" x-text="phone"></p>
<p class="text-xs text-gray-500 truncate" x-html="convo.messages[convo.messages.length - 1].text"></p>
</div>
</button>
</template>
<div class="text-center text-gray-500 p-4 text-sm" x-show="Object.keys(conversations).length === 0">
<span x-show="connectionStatus === 'connected'">Waiting for incoming messages...</span>
<span x-show="connectionStatus === 'connecting'">Connecting to message server...</span>
<span x-show="connectionStatus === 'failed'">Connection failed. Check settings.</span>
</div>
</div>
</div>
</div>
<div class="flex flex-col flex-auto h-full p-6">
<div class="relative flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-gray-50 h-full p-4">
<div class="absolute inset-0 z-0 bg-contain bg-center bg-no-repeat opacity-10" style="background-image: url('https://drive.google.com/uc?export=view&amp;id=1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH'), url('https://lh3.googleusercontent.com/u/0/d/1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH=w1600-h1600');"></div>
<div class="relative z-10 flex flex-col h-full overflow-x-auto mb-4 scrollbar-thin" x-ref="chatbox" x-show="activeConversation">
<div class="flex flex-col h-full">
<template :key="message.timestamp + message.text" x-for="message in conversations[activeConversation]?.messages || []">
<div class="grid grid-cols-12 gap-y-2">
<div class="col-start-6 col-end-13 p-3 rounded-lg" x-show="message.type === 'outgoing'">
<div class="flex items-center justify-start flex-row-reverse">
<div class="flex items-center justify-center h-10 w-10 rounded-full brand-bg-dark flex-shrink-0 text-white">You</div>
<div class="relative mr-3">
<div class="text-sm brand-bg-light py-2 px-4 shadow rounded-xl">
<div x-html="message.text.replace(/\n/g, '&lt;br&gt;')"></div>
</div>
<div class="text-xs text-right text-gray-500 mt-1" x-text="formatTimestamp(message.timestamp)"></div>
</div>
</div>
</div>
<div class="col-start-1 col-end-8 p-3 rounded-lg" x-show="message.type === 'incoming'">
<div class="flex flex-row items-center">
<div class="flex items-center justify-center h-10 w-10 rounded-full brand-bg-accent flex-shrink-0 uppercase" x-text="conversations[activeConversation]?.name.charAt(0)"></div>
<div class="relative ml-3">
<div class="text-sm bg-white py-2 px-4 shadow rounded-xl">
<div x-html="message.text.replace(/\n/g, '&lt;br&gt;')"></div>
</div>
<div class="text-xs text-left text-gray-500 mt-1" x-text="formatTimestamp(message.timestamp)"></div>
</div>
</div>
</div>
</div></template>
</div>
</div>
<div class="relative z-10 flex items-center justify-center h-full" x-show="!activeConversation">
<div class="text-center text-gray-500">
<img class="h-12 w-12 rounded-full object-cover border-2 border-white shadow-md flex-shrink-0" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://lh3.googleusercontent.com/u/0/d/1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH=w1000-h1000';" referrerpolicy="no-referrer" src="https://drive.google.com/uc?export=view&amp;id=1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH"/>
<h2 class="mt-2 text-lg font-medium">Select a conversation</h2>
<p class="text-sm">Choose a conversation from the left to start chatting.</p>
</div>
</div>
<div class="relative z-10 flex flex-row items-center rounded-xl bg-white w-full px-4" x-show="activeConversation">
<div class="flex-grow">
<div class="relative w-full">
<textarea @keydown.enter.prevent.exact="sendMessage" class="flex w-full border rounded-xl focus:outline-none focus:border-green-400 pl-4 pr-12 h-20 resize-none pt-3" placeholder="Reply to your customer..." x-model="replyMessage" x-ref="replybox"></textarea>
<!-- WHATSAPP TAB: Quick-reply chips. Clicking inserts templated text into message composer. If editing copy, keep data-template attributes intact. -->
<div class="pt-2 w-full" x-show="activeConversation">
<div class="flex flex-wrap items-start gap-2 w-full">
<template :key="i" x-for="(cr, i) in commonReplies">
<button @click="insertQuickReply(cr)" class="shrink-0 whitespace-nowrap text-sm px-3 py-1 rounded-full border border-gray-200 hover:bg-gray-50">
<span x-text="cr"></span>
</button>
</template>
</div>
</div>
<div class="absolute right-3 top-1/2 -translate-y-1/2">
<button @click="isEmojiPickerOpen = !isEmojiPickerOpen">
<svg class="w-6 h-6 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75s.168-.75.375-.75.375.336.375.75zm4.5 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</div>
<div class="ml-4">
<button :disabled="sendingMessage || !replyMessage.trim()" @click="sendMessage" class="flex items-center justify-center brand-bg-dark brand-bg-dark-hover rounded-xl text-white px-4 py-1 flex-shrink-0">
<span x-show="!sendingMessage">Send</span>
<span x-show="sendingMessage">Sending...</span>
<span class="ml-2">
<svg class="w-4 h-4 transform rotate-45 -mt-px" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
</span>
</button>
</div>
<div @click.outside="isEmojiPickerOpen = false" class="absolute bottom-24 right-0 z-20" x-cloak="" x-show="isEmojiPickerOpen">
<emoji-picker class="light"></emoji-picker>
</div>
</div>
</div>
</div>
</div>
<div @click.self="isSettingsOpen = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak="" x-show="isSettingsOpen">
<div @click.stop="" class="bg-white rounded-lg p-8 shadow-2xl max-w-md w-full">
<h2 class="text-2xl font-bold mb-4">Settings</h2>
<p class="text-gray-600 mb-6">Enter your API details to connect to WhatsApp. These are stored only in your browser.</p>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700" for="accessToken">Access Token</label>
<input class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 brand-focus-ring" id="accessToken" placeholder="Starts with 'EAAL...'" type="password" x-model="settings.accessToken"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700" for="phoneNumberId">Phone Number ID</label>
<input class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 brand-focus-ring" id="phoneNumberId" placeholder="e.g., 704223126117310" type="text" x-model="settings.phoneNumberId"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700" for="scriptUrl">Google Script Web App URL</label>
<input class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 brand-focus-ring" id="scriptUrl" placeholder="The URL from your deployed Google Script" type="text" x-model="settings.scriptUrl"/>
</div>
</div>
<div class="mt-8 flex justify-end space-x-3">
<button @click="isSettingsOpen = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    Cancel
                </button>
<button @click="saveSettings" class="brand-bg-dark brand-bg-dark-hover text-white font-bold py-2 px-4 rounded-lg">
                    Save and Connect
                </button>
</div>
</div>
</div>
</div>
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>

        // === OPTIONAL PREFILL (INSECURE) ===
        // Put your real credentials here if you insist.
        // These will live in the HTML file and can be extracted by anyone with file access.
document.addEventListener('alpine:init', () => {
    Alpine.data('whatsappChat', () => ({
        // --- STATE ---
        isSettingsOpen: false,
        isEmojiPickerOpen: false,
        settings: {
            accessToken: '',
            phoneNumberId: '',
            scriptUrl: ''
        },
        conversations: {},
        activeConversation: null,
        replyMessage: '',
        commonReplies: [
            "👍 Noted",
            "Thanks for your message! 😊",
            "I have updated your Marketing Preferences. Thank you.",
            "The FCA are due to come back with the findings of the Consultation early October. We'll keep you updated.",
            "Great — can we start with your vehicle registration (VRN)?",
            "Perfect, lovely vehicle! We can see your lender and purchase date. How much did you buy the car for, and what deposit was used?",
            "Do you know your interest rate? If not, I can estimate it from your current monthly payment.",
            "Thanks — what is your current monthly payment? I can estimate your balloon from that."
        ],
        sendingMessage: false,
        connectionStatus: 'connecting', // can be: 'connecting', 'connected', 'failed'
        pinnedConversations: [], // <-- ADDED: For pinning feature
        // Rotating mascot images (random with fallback)
mascotImages: [
    "https://drive.google.com/uc?export=view&id=1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH",
    "https://drive.google.com/uc?export=view&id=1Kf2kzoUmPDkHOrj_TkezYe0937VUAqzj",
    "https://drive.google.com/uc?export=view&id=1z1OLTlJGykDP98DAwljiEJN02u6bDLZT",
    "https://drive.google.com/uc?export=view&id=1CKF3DD9sPJtLzxT28t0sgFN_W3NigU-g",
    "https://drive.google.com/uc?export=view&id=1NHtgaOBuB2qS9yGyl9jVoX7VOTnlPT0S"
],
fallbackMascot: "https://drive.google.com/uc?export=view&id=1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH",
mascotImage: "",
        
        // --- COMPUTED PROPERTIES ---
        // START OF MODIFIED SECTION: Sorting Logic
        get sortedConversations() {
            const sortedEntries = Object.entries(this.conversations)
                .sort(([_, a], [__, b]) => {
                    const lastMsgA = a.messages[a.messages.length - 1];
                    const lastMsgB = b.messages[b.messages.length - 1];
                    return new Date(lastMsgB.timestamp) - new Date(lastMsgA.timestamp);
                });

            const pinned = sortedEntries.filter(([phone, _]) => this.pinnedConversations.includes(phone));
            const unpinned = sortedEntries.filter(([phone, _]) => !this.pinnedConversations.includes(phone));

            const finalSorted = [...pinned, ...unpinned];
            
            return finalSorted.reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {});
        },
        // END OF MODIFIED SECTION

        get statusText() {
            switch (this.connectionStatus) {
                case 'connected': return 'Connected';
                case 'failed': return 'Connection Failed';
                case 'connecting': return 'Connecting...';
                default: return 'Idle';
            }
        },

        // --- METHODS ---
        init() {
            // 1. Load saved credentials from localStorage
            const savedSettings = localStorage.getItem('whatsappSettings');
            if (savedSettings) {
                try {
                    this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                } catch (e) {
                    console.error("Could not parse saved WhatsApp settings.");
                }
            }

            // 2. Validate if all necessary credentials exist
            if (this.settings.accessToken && this.settings.phoneNumberId && this.settings.scriptUrl) {
                this.fetchConversations();
                if (!window.pollingInterval) {
                    window.pollingInterval = setInterval(() => this.fetchConversations(), 5000);
                }
            } else {
                // 3. Missing credentials → force Settings modal open
                this.isSettingsOpen = true;
                this.connectionStatus = 'failed';
            }

            // Close emoji picker when switching conversations
            this.$watch('activeConversation', () => { this.isEmojiPickerOpen = false });

            // Initialize Emoji Picker listener if it exists
            const picker = this.$root.querySelector('emoji-picker');
            if (picker) {
                picker.addEventListener('emoji-click', event => {
                    this.replyMessage += event.detail.unicode;
                });
            }
        },

        saveSettings() {
            if (!this.settings.accessToken || !this.settings.phoneNumberId || !this.settings.scriptUrl) {
                alert('Please fill in all fields.');
                return;
            }
            // Persist credentials to local storage
            localStorage.setItem('whatsappSettings', JSON.stringify(this.settings));

            this.isSettingsOpen = false;
            this.conversations = {};
            this.activeConversation = null;

            // Attempt connection
            this.fetchConversations();
            if (!window.pollingInterval) {
                window.pollingInterval = setInterval(() => this.fetchConversations(), 5000);
            }
        }},

        async fetchConversations() {
            if (!this.settings.scriptUrl) {
                this.connectionStatus = 'failed';
                return;
            }
            this.connectionStatus = 'connecting';
            try {
                const response = await fetch(`${this.settings.scriptUrl}?action=getMessages`);
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    this.processMessages(data.messages);
                    this.connectionStatus = 'connected';
                } else {
                    throw new Error(data.error || 'Failed to fetch messages from Google Script.');
                }
            } catch (error) {
                console.error('Error fetching conversations:', error);
                this.connectionStatus = 'failed';
            }
        },

        processMessages(messages) {
    // Capture scroll position BEFORE updating DOM
    const chatbox = this.$refs.chatbox;
    const hasChatbox = !!chatbox;
    const wasAtBottom = hasChatbox ? (chatbox.scrollHeight - chatbox.scrollTop - chatbox.clientHeight < 10) : false;
    const prevScrollTop = hasChatbox ? chatbox.scrollTop : 0;
    const prevScrollHeight = hasChatbox ? chatbox.scrollHeight : 0;

    const newConversations = {};
    messages.forEach(msg => {
        const phone = msg.type === 'incoming' ? msg.from : msg.to;
        if (!phone) return;

        if (!newConversations[phone]) {
            newConversations[phone] = {
                name: msg.name || phone,
                messages: []
            };
        }
        if (msg.name && msg.name !== phone && msg.name !== 'You') {
            newConversations[phone].name = msg.name;
        }
        newConversations[phone].messages.push(msg);
    });

    for (const phone in newConversations) {
        newConversations[phone].messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        if (newConversations[phone].messages.length > 0 && newConversations[phone].messages[0].type === 'incoming') {
            const firstIncomingMessage = newConversations[phone].messages[0];
            const placeholderTimestamp = new Date(new Date(firstIncomingMessage.timestamp).getTime() - 1000).toISOString();
            const placeholderMessage = {
                timestamp: placeholderTimestamp,
                from: this.settings.phoneNumberId,
                to: phone,
                name: 'You',
                text: '<em>(This conversation was started with an automated template message.)</em>',
                type: 'outgoing'
            };
            newConversations[phone].messages.unshift(placeholderMessage);
        }
    }

    this.conversations = newConversations;

    // AFTER DOM updates, restore scroll thoughtfully
    this.$nextTick(() => {
        const chatboxNow = this.$refs.chatbox;
        if (!chatboxNow) return;

        const newScrollHeight = chatboxNow.scrollHeight;

        // Only auto-scroll if we were already at bottom OR the user is on a different conversation
        if (wasAtBottom) {
            chatboxNow.scrollTop = chatboxNow.scrollHeight;
        } else {
            // Preserve relative position after re-render
            const delta = newScrollHeight - prevScrollHeight;
            chatboxNow.scrollTop = Math.max(0, prevScrollTop + delta);
        }
    });
},
        
        selectConversation(phone) {
            this.activeConversation = phone;
            this.$nextTick(() => { this.scrollToBottom(); });
        },
        async sendMessage() {
            if (!this.replyMessage.trim() || !this.activeConversation) return;
            this.sendingMessage = true;
            const textToSend = this.replyMessage.trim();
            const recipientPhone = this.activeConversation;
            const apiUrl = `https://graph.facebook.com/v19.0/${this.settings.phoneNumberId}/messages`;
            const payload = {
                messaging_product: 'whatsapp',
                to: recipientPhone,
                type: 'text',
                text: { body: textToSend }
            };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.settings.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    await this.logOutgoingMessage(recipientPhone, textToSend);
                    this.replyMessage = '';
                } else {
                    const error = await response.json();
                    alert(`Failed to send message: ${error.error.message}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            } finally {
                this.sendingMessage = false;
            }
        },
        async logOutgoingMessage(to, text) {
             if (!this.settings.scriptUrl) return;
             try {
                const response = await fetch(this.settings.scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify({
                        action: 'logOutgoing',
                        to: to,
                        text: text
                    })
                });
                if(response.ok) {
                    const newMessage = {
                        timestamp: new Date().toISOString(),
                        from: this.settings.phoneNumberId,
                        to: to,
                        name: 'You',
                        text: text,
                        type: 'outgoing'
                    };
                    if (this.conversations[to]) {
                        this.conversations[to].messages.push(newMessage);
                    }
                    this.$nextTick(() => this.scrollToBottom());
                } else {
                     console.error('Failed to log outgoing message to Google Script');
                }
             } catch (error) {
                 console.error('Error logging outgoing message:', error);
             }
        },
        scrollToBottom(force = false) {
    const el = this.$refs.chatbox;
    if (!el) return;
    const nearBottom = (el.scrollHeight - el.scrollTop - el.clientHeight) < 10;
    if (force || nearBottom) {
        el.scrollTop = el.scrollHeight;
    }
},
        formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            const time = date.toLocaleTimeString('en-GB', options);
            const day = date.getDate();
            const month = date.toLocaleString('en-GB', { month: 'short' });
            return `${time} | ${day} ${month}`;
        }
    }));
});
</script>
<script>
/* Fallback tab initialiser (runs even if module script fails). */
(function() {
  function $all(sel) { return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  function showTab(tabEl) {
    var tabs = $all('.tab-link');
    var panels = $all('.tab-content');
    tabs.forEach(function(t) { t.classList.remove('active-tab'); });
    panels.forEach(function(p) { p.style.display = 'none'; });

    tabEl.classList.add('active-tab');
    var id = tabEl.getAttribute('data-tab');
    if (!id) return;
    var panel = document.getElementById(id);
    if (panel) panel.style.display = 'block';
  }
  function init() {
    var tabs = $all('.tab-link');
    if (!tabs.length) return;
    tabs.forEach(function(t) {
      t.addEventListener('click', function(e) {
        e.preventDefault();
        showTab(t);
      });
    });
    // Prefer the one already marked active, otherwise first
    var active = document.querySelector('.tab-link.active-tab') || tabs[0];
    showTab(active);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html></template>
</div>
</div>
</main>
</div>
<script>
  // Payload supplier URL is now centralized in CONFIG (module script).
</script>
<script>
  // Apps Script injected URL (same-origin endpoint)
  window.CMF_SELF_URL = '<?= serviceUrl ?>';
</script>
<script type="module">
/* =======================================================================
   1. GLOBAL CONFIGURATION (Edit settings here)
   ======================================================================= */
  // ===== Feature flags =====
  window.DISABLE_DELTA_POLLING = true; // disables periodic getDelta auto-refresh

const CONFIG = {
  LOCKING_ENABLED: false, // Pipeline locking disabled (reverted)

  ENDPOINTS: {
    // The backend for Sales Pipeline & CRM
    CRM: window.CMF_SELF_URL,
    // The backend for Product Source & DNS
    PSE: 'https://script.google.com/macros/s/AKfycbyGY8_ZjRoIh3TMR1MLx-LdYznYCMbroOq_VPkqHu8-1stnmmI6CMFi0IFtKETZKvJH/exec',
    // The backend for VRN Lookup / Payload supplier
    PAYLOAD: 'https://script.google.com/macros/s/AKfycbzaQHrIW0I4gLBdVq4UO8RwNcbfKFT7MPG3KEqnxGTreLLKvDysICqjMIBicOQAB460jA/exec'
  },
  TIMEOUT_MS: 25000 // 25 second timeout for all requests
};

// Ensure CMF_CLIENT_ID exists (used by legacy locking payloads). In Apps Script hosting we keep locking disabled,
// but some cleanup calls may still reference this identifier.
window.CMF_CLIENT_ID = window.CMF_CLIENT_ID || (function(){
  try { return 'webapp-' + Math.random().toString(36).slice(2, 10); } catch(e){ return 'webapp'; }
})(); 


// Back-compat for any legacy code that still references this global:
window.PAYLOAD_SUPPLIER_URL = CONFIG.ENDPOINTS.PAYLOAD;

/* =======================================================================
   AI-READABLE ANNOTATIONS (CMF CRMproject)
   -----------------------------------------------------------------------
   Purpose:
     - Single-file CRM dashboard with multiple tabs (CRM, Sales Pipeline,
       Application, Document Uploads, etc.) and Google Apps Script backends.
   Key fragility to protect (DO NOT REMOVE):
     - TAB WIRING + VRN LOOKUP WIRING must survive DOM re-renders and AI edits.
       This file uses CAPTURE-PHASE EVENT DELEGATION near the end of this
       module to make these interactions "unbreakable".
   How to edit safely:
     1) Keep element IDs/classes used by delegation:
        - Tabs: .tab-link (data-tab), .tab-content (panel IDs)
        - VRN: #vrn, #vrn-lookup-btn
     2) If you rename IDs/classes, update the delegated handler accordingly.
     3) Backend calls are typically Apps Script endpoints; preserve the
        request shape expected by your scripts (often POST + JSON payload).
   ======================================================================= */
        const $ = (s) => document.querySelector(s), $$ = (s) => document.querySelectorAll(s);
        const on = (el, ev, h) => el.addEventListener(ev, h);
        const toggleClass = (el, cls, force) => el.classList.toggle(cls, force);
        const getEl = (id) => document.getElementById(id);
        const getVal = (id) => getEl(id)?.value;
        const setVal = (id, val) => { const el = getEl(id); if (el) el.value = val; };
        const setHtml = (id, html) => { const el = getEl(id); if (el) el.innerHTML = html; };
        const setTxt = (id, txt) => { const el = getEl(id); if (el) el.textContent = txt; };

// --- Currency/percent helpers ---
const fmtGBP0 = new Intl.NumberFormat('en-GB', { style:'currency', currency:'GBP', minimumFractionDigits:0, maximumFractionDigits:0 });
const fmtGBP2 = new Intl.NumberFormat('en-GB', { style:'currency', currency:'GBP', minimumFractionDigits:2, maximumFractionDigits:2 });

const stripCurrency = (v) => (String(v||'').replace(/[^\d.-]/g, ''));
const toNumber = (v, dp=0) => {
  const n = parseFloat(stripCurrency(v));
  return isNaN(n) ? 0 : (dp===0 ? Math.round(n) : parseFloat(n.toFixed(dp)));
};
const ensurePercent = (v) => {
  const s = String(v ?? '').trim();
  return s.endsWith('%') ? s : (s ? s.replace('%','') + '%' : '');
};

        const showToast = (message, type = 'info', duration = 3000) => {
            const toast = getEl('toast-notification');
            if (!toast) return;
            setTxt('toast-message', message);
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl text-sm z-50 transition-transform transform translate-y-20 ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { toast.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
                 setTimeout(() => toast.classList.add('hidden'), 300);
            }, duration);
        };
        const initializeTabs = () => {
            const tabs = $$('.tab-link'), contents = $$('.tab-content');
            tabs.forEach(tab => on(tab, 'click', e => {
                e.preventDefault();
                tabs.forEach(item => item.classList.remove('active-tab'));
                contents.forEach(content => content.style.display = 'none');
                tab.classList.add('active-tab');
                const activeContent = getEl(tab.dataset.tab);
                if (activeContent) {
                    const isFlexTab = ['sales-pipeline-crm'].includes(activeContent.id);
                    activeContent.style.display = isFlexTab ? 'flex' : 'block';
                    if (isFlexTab) activeContent.style.flexDirection = 'column';

                    // If Sales Pipeline was initialised while hidden, force a render refresh once it becomes visible.
                    if (activeContent.id === 'sales-pipeline-crm') {
                        try {
                            if (window.App && App.render && typeof App.render.all === 'function') {
                                requestAnimationFrame(() => {
                                    try { App.render.all(); } catch(e){}
                                });
                            }
                            // Also refresh column resizers if user switches to Contacts view later
                            if (window.App && App.state) {
                                App.state.resizersSetup = false;
                            }
                        } catch(e){}
                    }

                    if (activeContent.id === 'document-upload') {
                        loadCustomerUploadIframe();
                    }

                    if (activeContent.id === 'whatsapp-messenger') {
                        const ifr = document.getElementById('whatsapp-messenger-iframe');
                        const tpl = document.getElementById('whatsapp-messenger-srcdoc');
                        if (ifr && tpl && !ifr.dataset.loaded) {
                            ifr.srcdoc = tpl.innerHTML;
                            ifr.dataset.loaded = '1';
                        }
                    }
                }
            }));
            window.__cmfTabsInitDone = true;
            (tabs[0]).click();
        };
        /* =======================================================================
   TAB: PSE / VEHICLE LOOKUP (VRN)
   -----------------------------------------------------------------------
   - Renders and manages the VRN lookup experience.
   - Must keep VRN input id="vrn" and button id="vrn-lookup-btn"
   - The delegated wiring guard calls window.handleVrnLookup() on click.
   ======================================================================= */

const initializePSE = () => {
            const GOOGLE_SCRIPT_URL = CONFIG.ENDPOINTS.PSE;
            window.illustratorResultsData = {};
            window.appState = { financeDetails: {}, products: [], selectedProductIndex: null };
            const lenderData = [{ l: "BNP Paribas Finance", a: 12.9, c: 4 }, { l: "Motonovo", a: 11.9, c: 4, h: true }, { l: "V12", a: 15.9, c: 5 }, { l: "Close Brothers", a: 12.9, c: 4.5 }, { l: "Credit Agricole", a: 14.0, c: 3 }, { l: "Northridge Finance", a: 9.9, c: 3.5, h: true }, { l: "Alphera", a: 10.9, c: 4, h: true }, { l: "Zopa", a: 17.9, c: 4 }, { l: "Advantage Finance", a: 31.4, c: 4 }, { l: "Automoney", a: 28.0, c: 4 }, { l: "Moneybarn", a: 33.7, c: 2.6 }, { l: "Moneyway", a: 26.65, c: 4 }, { l: "Oodle", a: 23.1, c: 4 }, { l: "Lendable", a: 29.8, c: 4 }, { l: "Startline Finance", a: 24.3, c: 4 }, { l: "Tandem", a: 22.25, c: 4 }, { l: "Billing Finance", a: 35.4, c: 1.3 }];
            const f = (v) => parseFloat(v) || 0;
            const i = (v) => parseInt(v, 10) || 0;
            const toFixed2 = (n) => n.toFixed(2);
            const roundUpToTenth = (n) => Math.ceil(n * 10) / 10;
            const formatApr = (n) => {
                const num = parseFloat(n);
                if (!Number.isFinite(num)) return '';
                return roundUpToTenth(num).toFixed(1);
            };
            const placeholder = (containerId, text) => setHtml(containerId, `<div class="placeholder-text"><p>${text}</p></div>`);
            const getLoanAmount = () => f(getVal('original-purchase-price')) - f(getVal('deposit-paid'));
            const calcMonthly = (p, t, apr, b = 0) => {
                if (t <= 0) return 0;
                const r = apr / 100 / 12;
                if (r === 0) return (p - b) / t;
                const n = p - (b / Math.pow(1 + r, t));
                const d = (1 - Math.pow(1 + r, -t)) / r;
                return n / d;
            };
            const updateResultsTable = () => {
                const { products, selectedProductIndex, financeDetails } = window.appState;
                if (!products.length) return placeholder('results-container', 'No products found. Please check your input.');
                const rows = products.map((p, idx) => `<tr data-product-index="${idx}" class="${idx === selectedProductIndex ? 'selected-row' : ''}"><td>${p.lender}</td><td class="ps-edit-cell ps-edit-cell--rate"><input type="number" step="0.01" class="ps-edit-input" data-field="apr" value="${toFixed2(p.apr)}" data-product-index="${idx}"><span class="ps-edit-suffix">%</span></td><td class="balloon-input-cell ps-edit-cell">£<input type="number" step="1" class="balloon-input" value="${p.calculatedBalloonPayment.toFixed(0)}" data-product-index="${idx}"></td><td class="ps-edit-cell ps-edit-cell--term"><input type="number" step="1" class="ps-edit-input" data-field="term" value="${p.term ?? financeDetails.remainingTerm}" data-product-index="${idx}"></td><td class="ps-edit-cell ps-edit-cell--money">£<input type="number" step="0.01" class="ps-edit-input" data-field="monthly" value="${toFixed2(p.calculatedMonthlyPayment)}" data-product-index="${idx}"></td><td class="ps-edit-cell ps-edit-cell--money">£<input type="number" step="0.01" class="ps-edit-input" data-field="total" value="${toFixed2(p.totalPayable)}" data-product-index="${idx}"></td><td class="ps-edit-cell ps-edit-cell--money">£<input type="number" step="0.01" class="ps-edit-input" data-field="commission" value="${toFixed2(p.calculatedCommission)}" data-product-index="${idx}"></td></tr>`).join('');
                setHtml('results-container', `<table id="products-table"><thead><tr><th>Lender</th><th>Rate</th><th>Balloon (GFV)</th><th>Term</th><th>Monthly</th><th>Total</th><th>Commission</th></tr></thead><tbody>${rows}</tbody></table>`);
            };
            const updateComparisonView = () => {
                const { selectedProductIndex, financeDetails, products } = window.appState;
                if (selectedProductIndex === null) return placeholder('comparison-container', 'Select a product from the results table above to see a detailed comparison.');
                const p = products[selectedProductIndex];
                const productTerm = p.term ?? financeDetails.remainingTerm;
                const { calculatedMonthlyPayment: origMonthly, totalCostIfKept, settlementFigure, remainingTerm, originalRemainingTerm, originalApr } = financeDetails;
                const origBalloon = f(getVal('original-final-balloon'));
                const monthlyDiff = origMonthly - p.calculatedMonthlyPayment;
                const totalSaving = totalCostIfKept - p.totalPayable;
                const balloonDiff = origBalloon - p.calculatedBalloonPayment;
                const summaryBox = (label, value, valueClass, details) => `<div class="summary-box"><p class="label">${label}</p><p class="value ${valueClass}">${value}</p><div class="details">${details}</div></div>`;
                setHtml('comparison-container', `<div class="main-comparison-area grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="comparison-column" id="current-agreement-col"><h3>Current Agreement</h3><div class="comparison-details"><div class="detail-item"><span>Monthly Payment:</span><strong>£${toFixed2(origMonthly)}</strong></div><div class="detail-item"><span>Interest Rate (APR):</span><strong>${toFixed2(originalApr)}%</strong></div><div class="detail-item"><span>Remaining Term:</span><strong>${originalRemainingTerm} months</strong></div><div class="detail-item"><span>Final Balloon Payment:</span><strong>£${toFixed2(origBalloon)}</strong></div><div class="detail-item"><span>Total Payable from Today:</span><strong>£${toFixed2(totalCostIfKept)}</strong></div><div class="detail-item"><span>Settlement Figure:</span><strong>£${toFixed2(settlementFigure)}</strong></div></div></div><div class="comparison-column" id="proposed-agreement-col"><h3>Proposed New Agreement</h3><div class="comparison-details"><div class="detail-item"><span>Monthly Payment:</span><strong>£${toFixed2(p.calculatedMonthlyPayment)}</strong></div><div class="detail-item"><span>Interest Rate (APR):</span><strong>${toFixed2(p.apr)}%</strong></div><div class="detail-item"><span>Term:</span><strong>${remainingTerm} months</strong></div><div class="detail-item"><span>Final Balloon Payment:</span><strong>£${toFixed2(p.calculatedBalloonPayment)}</strong></div><div class="detail-item"><span>Total Payable:</span><strong>£${toFixed2(p.totalPayable)}</strong></div><div class="detail-item"><span>Amount to Finance:</span><strong>£${toFixed2(settlementFigure)}</strong></div></div><div class="term-adjust-container"><button id="term-minus-btn" class="term-adjust-btn" ${remainingTerm <= 1 ? 'disabled' : ''}>-1 Month</button><button id="term-plus-btn" class="term-adjust-btn">+1 Month</button></div></div><div class="comparison-column" id="summary-col"><h3>Summary Savings</h3><div class="savings-summary-area">${summaryBox('Monthly Payment', `£${toFixed2(Math.abs(monthlyDiff))}`, monthlyDiff >= 0 ? 'text-green-600' : 'text-red-600', `<span>Current: <strong>£${toFixed2(origMonthly)}</strong></span><br><span>New: <strong>£${toFixed2(p.calculatedMonthlyPayment)}</strong></span>`)}${summaryBox('Balance to Own', `£${toFixed2(Math.abs(totalSaving))}`, totalSaving >= 0 ? 'text-green-600' : 'text-red-600', `<div>Current: <strong>£${toFixed2(totalCostIfKept)}</strong></div><div>New: <strong>£${toFixed2(p.totalPayable)}</strong></div>`)}${summaryBox('Term Length', remainingTerm - originalRemainingTerm === 0 ? 'No Change' : `${remainingTerm - originalRemainingTerm > 0 ? '+' : ''}${remainingTerm - originalRemainingTerm} mo`, 'text-gray-800', `<span>Current: <strong>${originalRemainingTerm} mo</strong></span><br><span>New: <strong>${remainingTerm} mo</strong></span>`)}${summaryBox('Balloon Change', `£${toFixed2(Math.abs(balloonDiff))}`, balloonDiff >= 0 ? 'text-green-600' : 'text-orange-600', `<div>Current: <strong>£${toFixed2(origBalloon)}</strong></div><div>New: <strong>£${toFixed2(p.calculatedBalloonPayment)}</strong></div>`)}</div></div></div>`);
            };
            const calcOutstanding = (p, t, apr, b, pm) => {
                const r = apr / 100 / 12;
                if (pm >= t) return b;
                if (r === 0) return p - (p - b) / t * pm;
                const fvP = p * Math.pow(1 + r, pm);
                const mP = calcMonthly(p, t, apr, b);
                const fvPay = mP * ((Math.pow(1 + r, pm) - 1) / r);
                return fvP - fvPay;
            };
            const getBalloonPerc = (term, price) => {
                term = Math.max(0, term);
                if (term <= 0 || price <= 0) return 0;
                const dp = [{ m: 24, p: 0.5865 }, { m: 37, p: 0.5352 }, { m: 49, p: 0.4542 }, { m: 60, p: 0.3597 }];
                if (term <= dp[0].m) return dp[0].p;
                if (term >= dp[dp.length - 1].m) return dp[dp.length - 1].p;
                let lb = dp[0], ub = dp[dp.length - 1];
                for (let i = 0; i < dp.length - 1; i++) if (term >= dp[i].m && term <= dp[i + 1].m) { [lb, ub] = [dp[i], dp[i + 1]]; break; }
                return lb.p + (term - lb.m) * (ub.p - lb.p) / (ub.m - lb.m);
            };
            const updateCurrentFinanceDetails = () => {
                const oLoan = getLoanAmount();
                const oApr = f(getVal('original-apr')), oTerm = i(getVal('original-term')), sDateVal = getVal('agreement-start-date');
                const balloonInput = getEl('original-final-balloon');
                if (getVal('finance-type') === 'PCP' && !balloonInput.dataset.manuallySet) {
                    const balloonPerc = getBalloonPerc(oTerm, oLoan);
                    const calcBalloon = Math.round(oLoan * balloonPerc);
                    setVal('original-final-balloon', calcBalloon > 0 ? calcBalloon : '');
                }
                const oBalloon = f(getVal('original-final-balloon'));
                if ([oLoan, oApr, oTerm].some(isNaN) || !sDateVal) return;
                const monthlyDisplay = getEl('monthly-payment-display');
                if (monthlyDisplay.dataset.manuallySet !== 'true') setVal('monthly-payment-display', toFixed2(calcMonthly(oLoan, oTerm, oApr, oBalloon)));
                const monthsPassed = (new Date().getFullYear() - new Date(sDateVal).getFullYear()) * 12 + (new Date().getMonth() - new Date(sDateVal).getMonth());
                if (getEl('remaining-term-display').dataset.manuallySet !== 'true') setVal('remaining-term-display', Math.max(0, Math.round(oTerm - monthsPassed)));
                if (getEl('outstanding-balance-display').dataset.manuallySet !== 'true') setVal('outstanding-balance-display', toFixed2(calcOutstanding(oLoan, oTerm, oApr, oBalloon, monthsPassed)));
            };
            const processAndSortProducts = async () => {
                const { settlementFigure, remainingTerm } = window.appState.financeDetails;
                const origLoan = getLoanAmount();

                // Pattern B-lite: prefer server-side placeholder quotes (same lender list/defaults as UI),
                // while keeping UI formulae available as a fallback.
                try {
                    if (window.App && typeof App.apiCall === 'function') {
                        let token = '';
                        try { token = (window.localStorage && localStorage.getItem('CMF_AUTH_TOKEN')) || ''; } catch(e) {}
                        const res = await App.apiCall('POST', {
                            action: 'getLenderQuotesBatch',
                            payload: { settlementFigure, remainingTerm, origLoan, token }
                        });

                        if (res && res.success && Array.isArray(res.products) && res.products.length) {
                            window.appState.products = res.products.slice().sort((a, b) => (a.apr || 0) - (b.apr || 0));
                            return;
                        }

                        // If server explicitly says auth required, abort fallback to avoid silently showing stale pricing
                        if (window.__cmfHandleAuthRequired && window.__cmfHandleAuthRequired(res)) return;
                    }
                } catch (e) {
                    // swallow and fall back to local calc
                    console.warn('Server placeholder lender quotes failed; falling back to UI calc.', e);
                }

                // Fallback: local UI calculation (preserves current behaviour)
                const productsWithBalloons = await Promise.all(lenderData.map(async (p) => {
                    let balloon;
                    if (p.h) {
                        await new Promise(r => setTimeout(r, 200));
                        const base = settlementFigure * getBalloonPerc(remainingTerm, origLoan);
                        let v = 1.0;
                        if (p.l === 'Alphera') v = 1.05; else if (p.l === 'Motonovo') v = 0.98; else if (p.l === 'Northridge Finance') v = 1.10;
                        balloon = base * v;
                    } else balloon = settlementFigure * getBalloonPerc(remainingTerm, origLoan);
                    const commission = settlementFigure * (p.c / 100);
                    const monthly = calcMonthly(settlementFigure, remainingTerm, p.a, balloon);
                    const total = (monthly * remainingTerm) + balloon;
                    return { lender: p.l, apr: p.a, term: remainingTerm, calculatedMonthlyPayment: monthly, calculatedBalloonPayment: balloon, calculatedCommission: commission, totalPayable: total };
                }));
                window.appState.products = productsWithBalloons.sort((a, b) => a.apr - b.apr);
            };
            const handleFormSubmit = async (e) => {
                e.preventDefault();
                // Show global loading spinner (reuse Save Deal overlay)
                const __ov = getEl('saveDealOverlay');
                if (__ov) __ov.classList.remove('hidden');
                try {
                const monthly = f(getVal('monthly-payment-display')), remTerm = i(getVal('remaining-term-display')), outBalance = f(getVal('outstanding-balance-display')), oApr = f(getVal('original-apr'));
                if ([monthly, remTerm, outBalance, oApr].some(isNaN)) return showToast("Please ensure all original agreement details are filled correctly.", "error");
                const erc = outBalance > 0 && oApr > 0 ? ((outBalance * (oApr / 100)) / 365) * (remTerm > 12 ? 58 : 28) : 0;
                const settlement = outBalance + erc;
                window.appState.financeDetails = { settlementFigure: settlement, totalCostIfKept: (monthly * remTerm) + f(getVal('original-final-balloon')), calculatedMonthlyPayment: monthly, remainingTerm: remTerm, originalRemainingTerm: remTerm, outstandingBalance: outBalance, erc: erc, originalApr: oApr };
                await processAndSortProducts();
                window.appState.selectedProductIndex = null;
                updateResultsTable();
                updateComparisonView();
                getEl('demands-and-needs-section').style.display = 'block';
                getEl('results-card').scrollIntoView({ behavior: 'smooth' });
                } finally {
                  if (__ov) __ov.classList.add('hidden');
                }
            };
            const handleFinanceTypeChange = () => {
                const balloonInput = getEl('original-final-balloon');
                const isHP = getVal('finance-type') === 'HP';
                balloonInput.value = isHP ? 0 : balloonInput.value;
                balloonInput.disabled = isHP;
                delete balloonInput.dataset.manuallySet;
                updateCurrentFinanceDetails();
            };

            const normalizeKey = (s) => (s || '').toString().toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
            const rawGet = (raw, candidates) => {
                if (!raw || typeof raw !== 'object') return '';
                const keys = Object.keys(raw);
                const normMap = {};
                keys.forEach(k => { normMap[normalizeKey(k)] = k; });
                for (const c of candidates) {
                    const nk = normalizeKey(c);
                    if (normMap[nk] !== undefined) return raw[normMap[nk]];
                }
                // fuzzy contains
                for (const c of candidates) {
                    const nk = normalizeKey(c);
                    const hit = Object.keys(normMap).find(k => k.includes(nk) || nk.includes(k));
                    if (hit) return raw[normMap[hit]];
                }
                return '';
            };

            /* -----------------------------------------------------------------------
   VRN LOOKUP CORE LOGIC (EXPOSED FOR DELEGATION)
   - Must remain accessible from the delegated click handler.
   - If you move/rename this, update: window.fetchVrnPayloadFromSheet
   ----------------------------------------------------------------------- */

const fetchVrnPayloadFromSheet = async (vrn) => {
                const url = `${PAYLOAD_SUPPLIER_URL}?vrn=${encodeURIComponent(vrn)}`;
                const res = await fetch(url, { method: 'GET' });
                if (!res.ok) throw new Error(`Payload service HTTP ${res.status}`);
                return await res.json();
            };
            // Expose for delegated wiring + other modules (exposed for delegated wiring across modules).
            window.fetchVrnPayloadFromSheet = fetchVrnPayloadFromSheet;

            const applyDnsPayloadToUI = (payloadJson) => {
                if (!payloadJson || !payloadJson.dnsPayload) return;

                const dp = payloadJson.dnsPayload;
                const raw = payloadJson.raw || {};

                // Parse numbers that may arrive as strings (e.g. "£123.45", "1,234.56")
                const toNum = (v) => {
                    if (v === null || v === undefined || v === '') return null;
                    if (typeof v === 'number') return v;
                    const s = String(v).trim();
                    const cleaned = s.replace(/[^0-9.\-]/g, '');
                    if (!cleaned) return null;
                    const n = Number(cleaned);
                    return Number.isFinite(n) ? n : null;
                };

                // Mark auto-calc inputs as manually set so later calculations don't overwrite them
                const setManualCalc = (id, val) => {
                    const el = getEl(id);
                    if (!el) return;
                    el.value = val;
                    el.dataset.manuallySet = 'true';
                };

                // Client fields (VRN section)
                if (dp.client) {
                    if (dp.client.firstName !== undefined) setVal('ps_client_firstName', dp.client.firstName || '');
                    if (dp.client.lastName !== undefined) setVal('ps_client_lastName', dp.client.lastName || '');
                    const pc = (dp.client.postcode || (dp.client.address && dp.client.address.postcode) || '');
                    if (pc !== undefined) setVal('ps_client_currentPostcode', pc || '');

                    // Letter creator client fields
                    const street = [dp.client.address && dp.client.address.address1, dp.client.address && dp.client.address.address2].filter(Boolean).join(', ');
                    if (getEl('ltr_client-name')) setVal('ltr_client-name', [dp.client.firstName, dp.client.lastName].filter(Boolean).join(' ').trim());
                    if (getEl('ltr_client-email')) setVal('ltr_client-email', dp.client.email || '');
                    if (getEl('ltr_client-phone')) setVal('ltr_client-phone', dp.client.phone || '');
                    if (getEl('ltr_client-address')) setVal('ltr_client-address', [street, dp.client.address && dp.client.address.town, dp.client.address && dp.client.address.postcode].filter(Boolean).join(', '));
                }

                // Reference number
                // Reference number forced from Source Sheet 'id' in openCustomerModal(); do not override from deals payload.

                // Employment / income (new inputs)
                if (dp.affordability) {
                    if (getEl('ltr_employment-summary')) setVal('ltr_employment-summary', dp.affordability.employmentStatus || '');
                    // Time in employment (total months) - forced from Source Sheet raw
                    try {
                        const _empYearsRaw = rawGet(raw, ['employmentYears', 'employment years', 'years employed', 'years in employment', 'time in employment years']);
                        const _empMonthsRaw = rawGet(raw, ['employmentMonths', 'employment months', 'months employed', 'months in employment', 'time in employment months']);
                        const _empY = parseInt((_empYearsRaw || dp.employmentYears || 0), 10) || 0;
                        const _empM = parseInt((_empMonthsRaw || dp.employmentMonths || 0), 10) || 0;
                        const _totalEmpMonths = (_empY * 12) + _empM;
                        if (getEl('ltr_time-in-employment')) {
                            const _txt = _totalEmpMonths > 0 ? `${_totalEmpMonths} month${_totalEmpMonths === 1 ? '' : 's'}` : '';
                            setVal('ltr_time-in-employment', _txt);
                        }
                    } catch (e) {
                        // no-op
                    }

                // Persist Source Sheet received date for letter template (Illustrative figures date)
                try {
                    const _ssReceived =
                        (dp.receivedDate ?? dp.received_date ?? dp.received ?? dp.received_on)
                        ?? rawGet(raw, ['receivedDate', 'received date', 'Received Date', 'Date Received', 'date received', 'received']);
                    window.sourceSheetReceivedDate = _ssReceived ? String(_ssReceived) : '';
                } catch (e) {
                    // no-op
                }

                // Refresh letter preview if available (so illustrative date updates immediately)
                try {
                    if (typeof updateLetterPreview === 'function') updateLetterPreview();
                } catch (e) {
                    // no-op
                }
if (getEl('ltr_net-income-monthly')) setVal('ltr_net-income-monthly', dp.affordability.netIncomeMonthly ?? '');
                }

                // Settlement total -> Finance Amount (Settlement inc.ERC)(£)
                if (dp.settlementTotal != null && getEl('ltr_new-finance-amount')) {
                    setVal('ltr_new-finance-amount', dp.settlementTotal);
                }

                // =========================
                // Finance mapping (Deals + Source Sheet data only)
                // =========================
                // 1) Monthly Payment (£)  <= oldPayment
                const oldPayment =
                    (dp.oldPayment ?? dp.old_payment ?? dp.monthlyPayment ?? dp.monthly_payment)
                    ?? rawGet(raw, ['oldpayment', 'old payment', 'monthly payment', 'current monthly payment', 'payment', 'instalment', 'installment']);
                const oldPayN = toNum(oldPayment);
                if (oldPayN != null && getEl('monthly-payment-display')) {
                    setManualCalc('monthly-payment-display', toFixed2(oldPayN));
                }

                // 2) Outstanding Balance (£) <= settlement
                const settlement =
                    (dp.settlement ?? dp.outstandingBalance ?? dp.outstanding_balance ?? dp.balanceOutstanding ?? dp.balance_outstanding)
                    ?? rawGet(raw, ['settlement', 'settlement figure', 'outstanding balance', 'balance', 'current balance', 'amount outstanding']);
                const settlementN = toNum(settlement);
                if (settlementN != null && getEl('outstanding-balance-display')) {
                    setManualCalc('outstanding-balance-display', toFixed2(settlementN));
                }

                // 3) Remaining Term (months) <= term (+1)
                const remainingTerm =
                    (dp.term ?? dp.remainingTerm ?? dp.remaining_term ?? dp.termMonths ?? dp.term_months)
                    ?? rawGet(raw, ['term', 'remaining term', 'months remaining', 'months left', 'remaining months']);
                const remTermN = toNum(remainingTerm);
                // Persist Source Sheet term for letter template (prefer raw 'term' header when available)
                try {
                    const _ssTermRaw = toNum(rawGet(raw, ['term', 'Term']));
                    const _ssTerm = (_ssTermRaw != null) ? Math.round(_ssTermRaw) : (remTermN != null ? Math.round(remTermN) : null);
                    if (_ssTerm != null && Number.isFinite(_ssTerm)) {
                        window.sourceSheetTerm = _ssTerm;
                        if (getEl('ltr_current-term')) setVal('ltr_current-term', String(_ssTerm));
                    } else {
                        window.sourceSheetTerm = '';
                        if (getEl('ltr_current-term')) setVal('ltr_current-term', '');
                    }
                } catch (e) {
                    // no-op
                }
                if (remTermN != null && getEl('remaining-term-display')) {
                    const t = Math.round(remTermN);
                    if (Number.isFinite(t)) setManualCalc('remaining-term-display', String(t + 1));
                }

                // 4) Finance Company <= financeCompany  (FORCED from Source Sheet)
                const financeCompany = rawGet(raw, ['Finance Company', 'financeCompany', 'FinanceCompany', 'Lender', 'Finance Provider']);
                setVal('finance-company', financeCompany || '');

                // 5) Agreement Number <= agreementNumber  (FORCED from Source Sheet)
                const agreementNumber = rawGet(raw, ['Agreement Number', 'agreementNumber', 'AgreementNumber', 'Finance Agreement Number', 'Contract Number', 'Account Number']);
                setVal('agreement-number', agreementNumber || '');

                // 6) Purchase Price (£) <= price
                const purchasePrice =
                    (dp.price ?? dp.purchasePrice ?? dp.purchase_price ?? dp.cashPrice ?? dp.cash_price)
                    ?? rawGet(raw, ['purchase price', 'vehicle price', 'cash price', 'price']);
                const priceN = toNum(purchasePrice);
                if (priceN != null && getEl('original-purchase-price')) {
                    setVal('original-purchase-price', toFixed2(priceN));
                }

                // 7) Deposit Paid (£) <= deposit
                const depositPaid =
                    (dp.deposit ?? dp.depositPaid ?? dp.deposit_paid ?? dp.customerDeposit ?? dp.customer_deposit ?? dp.downPayment ?? dp.down_payment)
                    ?? rawGet(raw, ['deposit', 'deposit paid', 'customer deposit', 'down payment', 'downpayment']);
                const depN = toNum(depositPaid);
                if (depN != null && getEl('deposit-paid')) {
                    setVal('deposit-paid', toFixed2(depN));
                }

                // 8) Original APR (%) <= currentApr  (FORCED from Source Sheet)
                const originalApr = rawGet(raw, ['Original APR (%)', 'Original APR', 'APR (%)', 'APR', 'currentApr', 'current apr']);
                const aprN = toNum(originalApr);
                if (getEl('original-apr')) {
                    if (aprN != null) setVal('original-apr', formatApr(aprN));
                    else {
                        const parsedApr = parseFloat(originalApr);
                        if (Number.isFinite(parsedApr)) setVal('original-apr', formatApr(parsedApr));
                        else setVal('original-apr', (originalApr || ''));
                    }
                }

                // 9) Original Term (months) <= originalTerm  (FORCED from Source Sheet)
                const originalTerm = rawGet(raw, ['Original Term (months)', 'Original Term', 'Term (months)', 'Term Months', 'originalTerm', 'original term']);
                const oTermN = toNum(originalTerm);
                if (getEl('original-term')) {
                    if (oTermN != null) {
                        const t = Math.round(oTermN);
                        if (Number.isFinite(t)) setVal('original-term', String(t));
                        else setVal('original-term', (originalTerm || ''));
                    } else if (originalTerm !== null && originalTerm !== undefined && String(originalTerm).trim() !== '') {
                        const m = String(originalTerm).match(/\d+/);
                        if (m && m[0]) setVal('original-term', m[0]);
                        else setVal('original-term', String(originalTerm));
                    } else {
                        setVal('original-term', '');
                    }
                }

                // 10) Finance Type <= financeType  (FORCED from Source Sheet)
                const financeType = rawGet(raw, ['Finance Type', 'financeType', 'Finance Product', 'Product Type', 'productType', 'Product']);
                if (getEl('finance-type')) {
                    const ftRaw = (financeType || '').toString();
                    if (ftRaw.trim() === '') {
                        setVal('finance-type', '');
                    } else {
                        const t = ftRaw.toUpperCase();
                        if (t.includes('PCP')) setVal('finance-type', 'PCP');
                        else if (t.includes('HP') || t.includes('HIRE PURCHASE')) setVal('finance-type', 'HP');
                        else setVal('finance-type', ftRaw);
                    }
                    if (typeof handleFinanceTypeChange === 'function') handleFinanceTypeChange();
                }

                // Store latest source sheet raw row globally for Letter Template and other sections
                window.sourceSheetRaw = raw;
                window.sourceSheetSettlementTotal = rawGet(raw, ['settlementTotal', 'settlement total', 'settlementTotal (£)', 'settlement total (£)']) || '';

                // Letter Template forced mappings (camelCase source sheet fields)
                // [client-address-street] = currentAddressLine1
                setVal('ltr_client-address-street', rawGet(raw, ['currentAddressLine1']) || '');
                // [client-address-town] = currentCity
                setVal('ltr_client-address-town', rawGet(raw, ['currentCity']) || '');
                // [client-address-postcode] = currentPostcode
                setVal('ltr_client-address-postcode', rawGet(raw, ['currentPostcode']) || '');
                // [net monthly income] = monthlyTakeHomePay
                const nmi = rawGet(raw, ['monthlyTakeHomePay']);
                const nmiN = toNum(nmi);
                setVal('ltr_net-income-monthly', nmiN != null ? toFixed2(nmiN) : (nmi || ''));
// Best-effort vehicle/current finance fill from raw row (if your sheet has these columns)
                const make = rawGet(raw, ['make', 'vehicle make']);
                const model = rawGet(raw, ['model', 'vehicle model']);
                const year = rawGet(raw, ['year', 'vehicle year', 'registration year']);
                if (make) setVal('vehicle-make', make);
                if (model) setVal('vehicle-model', model);
                if (year) setVal('vehicle-year', year);

                // Backward compatibility (older sheet column names)
                const lender = rawGet(raw, ['current lender', 'existing lender', 'finance company', 'lender']);
                const agrNo = rawGet(raw, ['agreement number', 'finance agreement number', 'contract number', 'account number']);
                const finType = rawGet(raw, ['finance type', 'product', 'product type', 'finance product', 'pcp/hp', 'hp/pcp', 'hp', 'pcp', 'finance']);

                if (lender && (!getVal('finance-company') || getVal('finance-company').trim() === '')) setVal('finance-company', lender);
                if (agrNo && (!getVal('agreement-number') || getVal('agreement-number').trim() === '')) setVal('agreement-number', agrNo);
                if (finType && (!getVal('finance-type') || getVal('finance-type').trim() === '')) {
                    const t = finType.toString().toUpperCase();
                    if (t.includes('PCP')) setVal('finance-type', 'PCP');
                    else if (t.includes('HP') || t.includes('HIRE PURCHASE')) setVal('finance-type', 'HP');
                    else setVal('finance-type', finType);
                    if (typeof handleFinanceTypeChange === 'function') handleFinanceTypeChange();
                }
            };

            /* -----------------------------------------------------------------------
   VRN LOOKUP UI HANDLER
   - Reads VRN from #vrn
   - Shows loading state on #vrn-lookup-btn
   - Calls fetchVrnPayloadFromSheet(vrn) and updates DOM fields
   ----------------------------------------------------------------------- */

const handleVrnLookup = async () => {
                // Show global Colin overlay while VRN lookup runs
                const __ov = getEl('saveDealOverlay');
                if (__ov) __ov.classList.remove('hidden');
                try {
                const vrn = getVal('vrn').toUpperCase().replace(/\s/g, '');
                if (!vrn) return;
                const spinner = getEl('vrn-spinner'), text = getEl('vrn-lookup-text'), btn = getEl('vrn-lookup-btn');
                spinner.style.display = 'block'; text.style.display = 'none'; btn.disabled = true;
                // 1) Payload service (Deals/Backup) MUST run before DB/API lookups
                setTxt('vrn-status', 'Checking Deals Database...'); getEl('vrn-status').style.color = '#333';
                try {
                    const payloadJson = await fetchVrnPayloadFromSheet(vrn);
                    if (payloadJson && payloadJson.ok && payloadJson.found) {
                        applyDnsPayloadToUI(payloadJson);
                        if (payloadJson.foundInDeals) {
                            setTxt('vrn-status', 'Found in Deal Database.'); getEl('vrn-status').style.color = 'green';
                            spinner.style.display = 'none'; text.style.display = 'block'; btn.disabled = false;
                            return;
                        }
                        setTxt('vrn-status', 'Found in backup. Proceeding to database/API for vehicle lookup...');
                    } else {
                        setTxt('vrn-status', 'Not found in Database. Checking VRN data...');
                    }
                } catch (e) {
                    console.error('Payload service error:', e);
                    setTxt('vrn-status', 'Could not query Deals Database. Checking VRN data...');
                }

                try {
                    const sheetResponse = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getVrnData', payload: { vrn } }) });
                    const sheetResult = await sheetResponse.json();
                    if (sheetResult.success && sheetResult.data) {
                        populateFormWithData(sheetResult.data, 'Vehicle found in our database!');
                        setTxt('vrn-status', getEl('vrn-status').textContent + ' Finance details pre-filled.');
                        spinner.style.display = 'none'; text.style.display = 'block'; btn.disabled = false;
                        return;
                    }
                } catch (error) {
                    console.error("Error checking Google Sheet:", error);
                    setTxt('vrn-status', 'Could not check database. Proceeding to API.');
                }
                setTxt('vrn-status', 'Not in database. Checking external API...');
                const apiKey = 'ICV6nKX6SM8Z8TUnDrRWW11TQfL4BVps9wzErC36';
                try {
                    const apiResponse = await fetch(`https://api.oneautoapi.com/experian/financerecords/v3?vehicle_registration_mark=${vrn}`, { headers: { 'x-api-key': apiKey } });
                    if (!apiResponse.ok) throw new Error(`API Error: ${apiResponse.statusText}`);
                    const apiData = await apiResponse.json();
                    if (apiData.success && apiData.result) {
                        const financeItem = (apiData.result.finance_data_qty > 0 && apiData.result.finance_data_items) ? apiData.result.finance_data_items[0] : null;
                        const vehicleData = {
                            vrn: vrn,
                            make: apiData.result.dvla_manufacturer_desc || '',
                            model: apiData.result.dvla_model_desc || '',
                            year: apiData.result.manufactured_year || '',
                            finance_type: financeItem?.finance_type || '',
                            finance_company: financeItem?.finance_company || '',
                            finance_agreement_number: financeItem?.finance_agreement_number || '',
                            finance_start_date: financeItem?.finance_start_date || '',
                            finance_term_months: financeItem?.finance_term_months || '',
                            finance: financeItem
                        };
                        try {
                             await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveVrnData', payload: vehicleData }) });
                        } catch(e) { console.error("Failed to save new VRN data to sheet:", e); }
                        populateFormWithData(vehicleData, 'Vehicle found via API!');
                        setTxt('vrn-status', getEl('vrn-status').textContent + (vehicleData.finance ? ' Finance details pre-filled & saved.' : ' No finance record found. Saved vehicle details.'));
                    } else { throw new Error(apiData.error || 'Vehicle not found via API.'); }
                } catch (error) {
                    setTxt('vrn-status', `Error: ${error.message}`);
                    getEl('vrn-status').style.color = 'red';
                } finally {
                    spinner.style.display = 'none'; text.style.display = 'block'; btn.disabled = false;
                }
            
                } finally {
                    if (__ov) __ov.classList.add('hidden');
                }
};
            // Expose for delegated wiring (exposed for delegated wiring across modules).
            window.handleVrnLookup = handleVrnLookup;
            const populateFormWithData = (data, statusMsg) => {
                setVal('vehicle-make', data.make || ''); setVal('vehicle-model', data.model || ''); setVal('vehicle-year', data.year || '');
                setTxt('vrn-status', statusMsg); getEl('vrn-status').style.color = 'green';
                if (data.finance) {
                    const fin = data.finance;
                    if (fin.finance_start_date) setVal('agreement-start-date', fin.finance_start_date);
                    if (fin.finance_term_months) setVal('original-term', fin.finance_term_months);
                    if (fin.finance_company) setVal('finance-company', fin.finance_company);
                    if (fin.finance_agreement_number) setVal('agreement-number', fin.finance_agreement_number);
                    if (fin.finance_type) {
                        const type = fin.finance_type.toUpperCase();
                        if (type.includes('PCP')) setVal('finance-type', 'PCP'); else if (type.includes('HIRE PURCHASE')) setVal('finance-type', 'HP');
                    }
                    if (typeof handleFinanceTypeChange === 'function') handleFinanceTypeChange();
                } else { setVal('finance-company', ''); setVal('agreement-number', ''); }
            };
            const populateManufacturers = () => {
                const list = getEl('manufacturer-list');
                const makes = ["Abarth", "Acura", "Alfa Romeo", "Alpine", "Aston Martin", "Audi", "Austin", "Bentley", "BMW", "Bugatti", "Buick", "Cadillac", "Caterham", "Chevrolet", "Chrysler", "Citroen", "Cupra", "Dacia", "Daewoo", "Daihatsu", "Dodge", "DS Automobiles", "Ferrari", "Fiat", "Fisker", "Ford", "Genesis", "GMC", "Honda", "Hummer", "Hyundai", "Ineos", "Infiniti", "Isuzu", "Jaguar", "Jeep", "Kia", "Koenigsegg", "Lamborghini", "Lancia", "Land Rover", "Lexus", "Lincoln", "Lotus", "Maserati", "Maybach", "Mazda", "McLaren", "Mercedes-Benz", "MG", "Mini", "Mitsubishi", "Morgan", "Morris", "Nissan", "Noble", "Opel", "Pagani", "Peugeot", "Polestar", "Pontiac", "Porsche", "Proton", "Ram", "Renault", "Rivian", "Rolls-Royce", "Rover", "Saab", "Seat", "Skoda", "Smart", "SsangYong", "Subaru", "Suzuki", "Tata", "Tesla", "Toyota", "Triumph", "TVR", "Vauxhall", "Volkswagen", "Volvo", "Westfield", "Zenos"];
                list.innerHTML = makes.sort().map(make => `<option value="${make}"></option>`).join('');
            };
            const adjustTerm = (change) => {
                if (!window.appState.financeDetails || window.appState.selectedProductIndex === null) return;
                const newTerm = window.appState.financeDetails.remainingTerm + change;
                if (newTerm < 1) return;
                window.appState.financeDetails.remainingTerm = newTerm;
                const { settlementFigure } = window.appState.financeDetails;
                window.appState.products.forEach(p => {
                    p.calculatedMonthlyPayment = calcMonthly(settlementFigure, newTerm, p.apr, p.calculatedBalloonPayment);
                    p.totalPayable = (p.calculatedMonthlyPayment * newTerm) + p.calculatedBalloonPayment;
                });
                updateResultsTable();
                updateComparisonView();
            };
            const bridgeDataToLetterCreator = () => {
                if (window.appState.selectedProductIndex === null) return;
                const { financeDetails, products, selectedProductIndex } = window.appState;
                const p = products[selectedProductIndex];
                const sDate = new Date(getVal('agreement-start-date'));
                const monthsPassed = (new Date().getFullYear() - sDate.getFullYear()) * 12 + (new Date().getMonth() - sDate.getMonth());
                window.illustratorResultsData = { currentLender: getVal('finance-company'), currentFinanceType: getVal('finance-type').toLowerCase(), currentVehiclePrice: f(getVal('original-purchase-price')), currentDeposit: f(getVal('deposit-paid')), currentApr: f(getVal('original-apr')), currentTerm: i(getVal('original-term')), currentMonthlyPayment: financeDetails.calculatedMonthlyPayment, currentBalloon: f(getVal('original-final-balloon')), currentAgreementStartDate: getVal('agreement-start-date'), currentPaymentsMade: monthsPassed, currentSettlementFigure: financeDetails.settlementFigure, currentAgreementNumber: getVal('agreement-number'), newLenderName: p.lender, newFinanceAmount: financeDetails.settlementFigure, newAdditionalCash: 0, newApr: p.apr, newTerm: financeDetails.remainingTerm, newMonthlyPayment: p.calculatedMonthlyPayment, newBalloon: p.calculatedBalloonPayment, earlyRepaymentChargesPaid: financeDetails.erc, estimatedCommission: p.calculatedCommission };
                if (typeof window.prefillLetterCreator === 'function') window.prefillLetterCreator();
            };
            const solveForAPR = (p, t, pmt, b) => {
                if (t <= 0) return 0;
                let low = 0.0, high = 100.0, mid;
                for (let i = 0; i < 50; i++) {
                    mid = (low + high) / 2;
                    const guessPmt = calcMonthly(p, t, mid, b);
                    if (Math.abs(guessPmt - pmt) < 0.01) return mid;
                    if (guessPmt > pmt) high = mid; else low = mid;
                }
                return mid;
            };
            const calcBalloon = (p, t, pmt, apr) => {
                if (t <= 0) return p;
                const r = apr / 100 / 12;
                if (r === 0) return p - (pmt * t);
                const futureValuePrincipal = p * Math.pow(1 + r, t);
                const futureValuePayments = pmt * ((Math.pow(1 + r, t) - 1) / r);
                return futureValuePrincipal - futureValuePayments;
            };
            const handleManualPaymentEntry = () => {
                if (getVal('finance-type') !== 'PCP') return;
                getEl('monthly-payment-display').dataset.manuallySet = 'true';
                const loanAmount = getLoanAmount();
                const term = i(getVal('original-term'));
                const targetPayment = f(getVal('monthly-payment-display'));
                const initialAPR = f(getVal('original-apr'));
                const initialBalloon = f(getVal('original-final-balloon'));
                const initialPayment = calcMonthly(loanAmount, term, initialAPR, initialBalloon);
                if (Math.abs(initialPayment - targetPayment) < 0.01) return;
                const paymentDiffTotal = (targetPayment - initialPayment) * term;
                const balloonAdjustment = paymentDiffTotal / 2;
                const newBalloon = initialBalloon - balloonAdjustment;
                const newAPR = solveForAPR(loanAmount, term, targetPayment, newBalloon);
                getEl('original-apr').value = formatApr(newAPR);
                getEl('original-final-balloon').value = newBalloon.toFixed(0);
                getEl('original-apr').dataset.manuallySet = 'true';
                getEl('original-final-balloon').dataset.manuallySet = 'true';
            };
            const handleManualAPREntry = () => {
                getEl('original-apr').dataset.manuallySet = 'true';
                let newAPR = f(getVal('original-apr'));
                if (Number.isFinite(newAPR)) {
                    newAPR = roundUpToTenth(newAPR);
                    getEl('original-apr').value = newAPR.toFixed(1);
                }
                if (getVal('finance-type') !== 'PCP') return updateCurrentFinanceDetails();
                const loanAmount = getLoanAmount();
                const term = i(getVal('original-term'));
                const payment = f(getVal('monthly-payment-display'));
                if (!loanAmount || !term || !payment || isNaN(newAPR)) return;
                const newBalloon = calcBalloon(loanAmount, term, payment, newAPR);
                getEl('original-final-balloon').value = newBalloon.toFixed(0);
                getEl('original-final-balloon').dataset.manuallySet = 'true';
            };
            const handleBalloonEdit = (inputElement) => {
                const productIndex = parseInt(inputElement.dataset.productIndex, 10);
                if (isNaN(productIndex)) return;
                const newBalloon = parseFloat(inputElement.value) || 0;
                const product = window.appState.products[productIndex];
                const { settlementFigure, remainingTerm } = window.appState.financeDetails;
                const term = product.term ?? remainingTerm;

                product.calculatedBalloonPayment = newBalloon;
                product.calculatedMonthlyPayment = calcMonthly(settlementFigure, term, product.apr, newBalloon);
                product.totalPayable = (product.calculatedMonthlyPayment * term) + newBalloon;

                const row = inputElement.closest('tr');
                if (!row) return;

                const monthlyInput = row.querySelector('input.ps-edit-input[data-field="monthly"]');
                const totalInput = row.querySelector('input.ps-edit-input[data-field="total"]');
                if (monthlyInput) monthlyInput.value = toFixed2(product.calculatedMonthlyPayment);
                if (totalInput) totalInput.value = toFixed2(product.totalPayable);

                if (window.appState.selectedProductIndex === productIndex) updateComparisonView();
            }

            const handleResultCellEdit = (inputElement) => {
                const productIndex = parseInt(inputElement.dataset.productIndex, 10);
                const field = inputElement.dataset.field;
                if (isNaN(productIndex) || !field) return;

                const product = window.appState.products[productIndex];
                const raw = (inputElement.value || '').toString().trim();

                const asNumber = (v) => {
                    const n = parseFloat(v);
                    return Number.isFinite(n) ? n : 0;
                };

                switch (field) {
                    case 'apr':
                        product.apr = asNumber(raw);
                        break;
                    case 'term':
                        product.term = Math.max(1, parseInt(raw, 10) || 0);
                        break;
                    case 'monthly':
                        product.calculatedMonthlyPayment = asNumber(raw);
                        break;
                    case 'total':
                        product.totalPayable = asNumber(raw);
                        break;
                    case 'commission':
                        product.calculatedCommission = asNumber(raw);
                        break;
                    default:
                        return;
                }

                if (window.appState.selectedProductIndex === productIndex) updateComparisonView();
            };
;
            on(getEl('results-container'), 'change', e => {
                if (e.target.classList.contains('balloon-input')) handleBalloonEdit(e.target);
                if (e.target.classList.contains('ps-edit-input')) handleResultCellEdit(e.target);
            });
            on(getEl('finance-form'), 'submit', handleFormSubmit);
            on(getEl('results-container'), 'click', e => {
                const row = e.target.closest('tr');
                if (row && !e.target.classList.contains('balloon-input') && !e.target.classList.contains('ps-edit-input')) {
                    window.appState.selectedProductIndex = i(row.dataset.productIndex);
                    updateResultsTable();
                    updateComparisonView();
                    bridgeDataToLetterCreator();
                }
            });
            on(getEl('comparison-container'), 'click', e => { if (e.target.id === 'term-plus-btn') adjustTerm(1); else if (e.target.id === 'term-minus-btn') adjustTerm(-1); });
            $$('#pse .original-input').forEach(input => {
                on(input, 'input', (e) => {
                    if (e.target.id === 'original-apr' || e.target.id === 'original-final-balloon') return;
                    $$('#pse .editable-calc').forEach(calcInput => delete calcInput.dataset.manuallySet);
                    delete getEl('original-apr').dataset.manuallySet;
                    delete getEl('original-final-balloon').dataset.manuallySet;
                    updateCurrentFinanceDetails();
                });
            });
            $$('#pse .editable-calc').forEach(input => on(input, 'input', e => e.target.dataset.manuallySet = 'true'));
            on(getEl('monthly-payment-display'), 'change', handleManualPaymentEntry);
            on(getEl('original-apr'), 'change', handleManualAPREntry);
            on(getEl('original-final-balloon'), 'input', () => getEl('original-final-balloon').dataset.manuallySet = 'true');
            on(getEl('finance-type'), 'change', handleFinanceTypeChange);
            on(getEl('vrn-lookup-btn'), 'click', handleVrnLookup);
            on(getEl('vrn'), 'keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    getEl('vrn-lookup-btn').click();
                }
            });
            populateManufacturers(); updateCurrentFinanceDetails(); handleFinanceTypeChange(); initializeLetterCreator();
        };
        const initializeLetterCreator = () => {
            const letterPreview = getEl('ltr_letter-preview-content');
            const printBtn = getEl('ltr_print-letter-btn');
            const checklistToggle = getEl('checklist-toggle');
            const checklistItems = getEl('checklist-items-container');
            const checklistCheckboxes = $$('#checklist-items-container input[type="checkbox"]');
            const printReminder = getEl('print-reminder');
            const formatDate = (dateStr) => {
                if (!dateStr) return '[Date]';
                const d = new Date(dateStr);
                return new Date(d.getTime() + d.getTimezoneOffset() * 60000).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
            };
            const formatCurrency = val => `£${(parseFloat(val) || 0).toFixed(2)}`;
            const getSelectedText = el => (el && el.selectedIndex !== -1 && el.options[el.selectedIndex]) ? el.options[el.selectedIndex].text : '';
            const updateLetterPreview = () => {
                const get = (id) => getVal(id) || `[${id.split('_').slice(1).join(' ')}]`;
                const d = {
                    staffName: get('ltr_staff-name'),
                    letterDate: formatDate(getVal('ltr_letter-date')),
                    illustrativeDate: formatDate(window.sourceSheetReceivedDate || ''),
                    refNum: get('ltr_reference-number'),
                    currentRemainingTerm: window.sourceSheetTerm ? `${window.sourceSheetTerm} months` : '',
                    clientName: get('ltr_client-name'),
                    clientAddr: `${get('ltr_client-address-street')}<br>${get('ltr_client-address-town')}<br>${get('ltr_client-address-postcode')}`,
                    vrn: getVal('vrn')?.toUpperCase() || '[VRN]', vehicle: `${getVal('vehicle-year')} ${getVal('vehicle-make')} ${getVal('vehicle-model')}`,
                    currentLender: get('ltr_current-lender'), currentFinanceType: getSelectedText(getEl('ltr_current-finance-type')), currentVehiclePrice: formatCurrency(getVal('ltr_current-vehicle-price')),
                    currentDeposit: formatCurrency(getVal('ltr_current-deposit')), currentApr: `${getVal('ltr_current-apr')}%`, currentTerm: `${getVal('ltr_current-term')} months`,
                    currentMonthlyPayment: formatCurrency(getVal('ltr_current-monthly-payment')), currentBalloon: formatCurrency(getVal('ltr_current-balloon')),
                    currentAgreementStartDate: formatDate(getVal('ltr_current-agreement-start-date')), currentPaymentsMade: getVal('ltr_current-payments-made'),
                    currentSettlementFigure: formatCurrency(window.illustratorResultsData.currentSettlementFigure), currentAgreementNumber: window.illustratorResultsData.currentAgreementNumber || '[Agreement Number]',
                    newLenderName: get('ltr_new-lender-name'), newTermType: getSelectedText(getEl('ltr_new-term-type')), newFinanceAmount: formatCurrency(getVal('ltr_new-finance-amount')), newAdditionalCash: formatCurrency(getVal('ltr_new-additional-cash')), newAmountToFinance: formatCurrency(window.sourceSheetSettlementTotal || ''), newDeposit: formatCurrency(getVal('deposit-paid') || getVal('ltr_current-deposit') || ''),
                    newApr: `${getVal('ltr_new-apr')}%`, newTerm: `${getVal('ltr_new-term')} months`, newMonthlyPayment: formatCurrency(getVal('ltr_new-monthly-payment')), newBalloon: formatCurrency(getVal('ltr_new-balloon')),
                    earlyRepaymentChargesPaid: formatCurrency(getVal('ltr_early-repayment-charges-paid')),
                    primaryNeed: getEl('ltr_primary-demand-need')?.value ? `You stated your primary need was: ${getSelectedText(getEl('ltr_primary-demand-need'))}.<br>` : '',
                    secondaryNeed: getEl('ltr_secondary-demand-need')?.value ? `Additionally, you mentioned a secondary need: ${getSelectedText(getEl('ltr_secondary-demand-need'))}.<br>` : '',
                    freeTextNeeds: getVal('ltr_client-demands-needs')?.replace(/\n/g, '<br>') || '', howMet: getVal('ltr_how-option-meets-needs')?.replace(/\n/g, '<br>') || '[Client to specify...]',
                    termChoice: getVal('ltr_term-change-choice'), termExtReason: getVal('ltr_term-extension-reason') === 'Other' ? getVal('ltr_term-extension-reason-other') : getSelectedText(getEl('ltr_term-extension-reason')),
                    termRedReason: getVal('ltr_term-reduction-reason') === 'Other' ? getVal('ltr_term-reduction-reason-other') : getSelectedText(getEl('ltr_term-reduction-reason')),
                    otherChoices: getVal('ltr_client-specific-choices-rationale')?.replace(/\n/g, '<br>') || 'No other specific choices noted.',
                    commission: formatCurrency(window.illustratorResultsData.estimatedCommission),
                    coTrading: get('ltr_company-trading-name'), coLegal: get('ltr_company-legal-name'), coAddr1: get('ltr_company-address1'), coAddr2: get('ltr_company-address2'),
                    coPostcode: get('ltr_company-postcode'), coEmail: get('ltr_company-email'), coFca: get('ltr_company-fca-number'), coReg: get('ltr_company-number'),
                };
                let termChangeHTML = '';
                if (d.termChoice === 'extend' && d.termExtReason) termChangeHTML = `<p>You informed us that you wished to extend the term of your finance to ${d.newTerm}. You stated your reason for this decision was: ${d.termExtReason}.</p>`;
                else if (d.termChoice === 'reduce' && d.termRedReason) termChangeHTML = `<p>You informed us that you wished to reduce the term of your finance to ${d.newTerm}. You stated your reason for this decision was: ${d.termRedReason}.</p>`;
                else if (d.termChoice === 'no_change') termChangeHTML = `<p>You indicated no significant change to your loan term was desired or applicable with the new finance option.</p>`;
                let demandsCombined = [d.primaryNeed, d.secondaryNeed, d.freeTextNeeds ? `Other stated needs/demands: <em>${d.freeTextNeeds}</em>` : ''].filter(Boolean).join('<br>');
                if (!demandsCombined.trim()) demandsCombined = '<em>[Client\'s Stated Demands and Needs not specified]</em>';

const illData = window.illustratorResultsData;
                let summaryHTML = '', extendedTermInfo = '';
                let monthlyChange = '', monthlyChangeDirection = '', totalCurrent = '', totalNew = '', totalDiff = '', termEffect = '';
                if (illData && Object.keys(illData).length > 0) {
                    const cMonthly = parseFloat(illData.currentMonthlyPayment) || 0, nMonthly = parseFloat(illData.newMonthlyPayment) || 0;
                    const cRemTerm = (parseInt(illData.currentTerm) || 0) - (parseInt(illData.currentPaymentsMade) || 0);
                    const nTerm = parseInt(illData.newTerm) || 0;
                    const cTotal = (cMonthly * cRemTerm) + (illData.currentFinanceType === 'pcp' ? (parseFloat(illData.currentBalloon) || 0) : 0);
                    const nTotal = (nMonthly * nTerm) + (parseFloat(illData.newBalloon) || 0);
                    // Derived comparison figures for detailed DNS letter
                    const diffMonthly = nMonthly - cMonthly;
                    if (Math.abs(diffMonthly) > 0.005) {
                        monthlyChangeDirection = diffMonthly > 0 ? 'Increase' : 'Decrease';
                        monthlyChange = formatCurrency(Math.abs(diffMonthly));
                    } else {
                        monthlyChangeDirection = '';
                        monthlyChange = '';
                    }
                    totalCurrent = formatCurrency(cTotal);
                    totalNew = formatCurrency(nTotal);
                    const diffTotalVal = nTotal - cTotal;
                    if (Math.abs(diffTotalVal) > 0.005) {
                        totalDiff = formatCurrency(Math.abs(diffTotalVal));
                    } else {
                        totalDiff = '';
                    }
                    if (cRemTerm && nTerm) {
                        const termDiff = nTerm - cRemTerm;
                        if (Math.abs(termDiff) <= 1) termEffect = 'Similar';
                        else if (termDiff < 0) termEffect = 'Shorter';
                        else termEffect = 'Longer';
                    }
                    const points = [];
                    if (cMonthly - nMonthly > 0.005) points.push(`a monthly saving of ${formatCurrency(cMonthly - nMonthly)}`);
                    if (cTotal - nTotal > 0.005) points.push(`a total to pay saving of ${formatCurrency(cTotal - nTotal)} over the term`);
                    if (cRemTerm - nTerm > 0) points.push(`a reduction in your loan term by ${cRemTerm - nTerm} month(s)`);
                    if (nTerm > cRemTerm) extendedTermInfo = `<li>If you have opted to extend the term of the agreement, this will impact the total cost to repay or own the vehicle outright should you wish to exercise your option to purchase.</li>`;
                    summaryHTML = `<p>Based on the illustration, the new finance option indicates ${points.length ? points.join(', and ') : 'no significant changes'}.</p>`;
                    if(illData.earlyRepaymentChargesPaid > 0) summaryHTML += `<p>The early repayment charges of <strong>${formatCurrency(illData.earlyRepaymentChargesPaid)}</strong> have been included in your new finance agreement.</p>`;
                }

                // Reference number placeholder (will be replaced/overridden when payload data is available)
                // Format: lastName_currentPostcode (sanitised)
                try {
                  const ln = (document.getElementById('ps_client_lastName')?.value || '').trim() || (d.clientName || '').trim().split(' ').slice(-1)[0] || 'lastName';
                  const pc = (document.getElementById('ps_client_currentPostcode')?.value || '').trim() || 'currentPostcode';
                  d.referenceNumber = `${ln}_${pc}`.replace(/\s+/g, '_').replace(/[^A-Za-z0-9_\-]/g, '');
                } catch (e) {
                  d.referenceNumber = 'lastName_currentPostcode';
                }

setHtml('ltr_letter-preview-content', `

<div class="letter-header-logo">
  <img class="letter-logo" src="https://lh3.googleusercontent.com/d/1KFrDqP6Er-Zaikrnh3vS7cNRZfihUn8I" alt="${d.coTrading} header" />
</div>
<p>${d.letterDate}</p>

<div class="client-details mb-5">
  <p><strong>${d.clientName}</strong></p>
  <p>${d.clientAddr.replace(/<br>/g, '</p><p>')}</p>
</div>

<p><strong>Re: Demands and Needs / Suitability Statement &ndash; Car Refinance Agreement</strong></p>

<p>
We do not provide independent financial advice for consumer credit or credit broking. We have provided you with information about available options so that you can make an informed decision.
</p>

<p>
This letter records your stated demands and needs and explains why the car refinance option you have chosen appears suitable, based on the information you have given us.
</p>

<h3 class="section-title">1. Your Stated Demands and Needs</h3>

<p>You confirmed that you require finance in relation to the following vehicle:</p>
<p><strong>Vehicle:</strong> ${d.vehicle}</p>
<p><strong>Registration:</strong> ${d.vrn}</p>

<p>During our discussions, you told us that your main objectives, preferences and constraints are:</p>

<p class="dns-mini"><strong>Primary objectives:</strong></p>
<ul class="letter-bullets dns-mini">
  <li>Reduce your monthly payments</li>
  <li>Reduce the overall cost of borrowing where possible</li>
  <li>Avoid significantly extending the term of your borrowing where this is a priority</li>
  <li>Retain the option to own the vehicle at the end of the agreement (where applicable)</li>
</ul>
<p><strong>Your demands and needs (summary):</strong></p>
<p>${demandsCombined}</p>

<h3 class="section-title">2. Information Provided by You</h3>

<p>The suitability of this agreement is based on the information you supplied to us about your personal and financial circumstances, your vehicle and your current finance agreement.</p>

<p><strong>Personal and financial information (summary):</strong></p>
<ul class="letter-bullets bullets-2col">
  <li>Employment: ${getVal('ltr_employment-summary') || '[Summary, e.g. employed / self-employed / other]'}</li>
<li>Time in Employment: ${getVal('ltr_time-in-employment') || '[time in employment current]'}</li>
<li>Regular Net income monthly: ${getVal('ltr_net-income-monthly') || '[net monthly income]'}</li>
<li>Any known changes to your circumstances: None Declared</li>
</ul>

<p><strong>Details of your current finance agreement:</strong></p>
<ul class="letter-bullets bullets-2col">
  <li>Current lender: ${d.currentLender}</li>
  <li>Agreement number: ${d.currentAgreementNumber}</li>
  <li>Type of agreement: ${d.currentFinanceType}</li>
  <li>Original vehicle cash price: ${d.currentVehiclePrice}</li>
  <li>Deposit paid: ${d.currentDeposit}</li>
  <li>Original term: ${d.currentTerm}</li>
  <li>APR (fixed): ${d.currentApr}</li>
  <li>Current monthly payment: ${d.currentMonthlyPayment}</li>
  <li>Final balloon / optional final payment (if applicable): ${d.currentBalloon}</li>
  <li>Agreement start date: ${d.currentAgreementStartDate}</li>
  <li>Payments made to date: ${d.currentPaymentsMade}</li>
  <li>Current settlement figure (including any early repayment charges, if applicable): ${d.currentSettlementFigure}</li>
  <li>Early repayment charges (if stated separately): ${d.earlyRepaymentChargesPaid}</li>
</ul>


<h3 class="section-title">3. Details of the New Agreement You Have Chosen</h3>

<p>You have chosen to proceed with a new refinance agreement on the following basis:</p>

<ul class="letter-bullets bullets-2col">
  ${d.newLenderName && d.newLenderName !== '[New Lender Name]' ? `<li>New lender: ${d.newLenderName}</li>` : ''}
  <li>Type of agreement: ${d.newTermType || '[HP / PCP / Other]'}</li>
  <li>Amount of credit / amount to finance (settlement inc. any fees): ${d.newAmountToFinance}</li>
  <li>Deposit: ${d.newDeposit}</li>
  <li>Term: ${d.newTerm}</li>
  <li>APR (fixed): ${d.newApr}</li>
  <li>Monthly payment: ${d.newMonthlyPayment}</li>
  <li>Final balloon / optional final payment (if applicable): ${d.newBalloon}</li>
  <li>Additional cash released to you (if applicable): ${d.newAdditionalCash}</li>
</ul>

<p>
Any early repayment charges or fees incurred to settle your existing agreement have ${parseFloat((illData && illData.earlyRepaymentChargesPaid) || 0) > 0 ? 'been included in the amount financed under the new agreement where stated.' : 'been explained to you where applicable.'}
</p>

<h3 class="section-title">4. Comparison and How This Option Meets Your Demands and Needs</h3>

<p>
Based on the illustrative figures we discussed on ${d.illustrativeDate}, the new refinance agreement compares to your current agreement as follows (all figures are approximate and for illustration only):
</p>

<p><strong>Monthly payment</strong></p>
<ul class="letter-bullets">
  <li>Current agreement: ${d.currentMonthlyPayment}</li>
  <li>New agreement: ${d.newMonthlyPayment}</li>
  <li>Estimated change in monthly payment: ${monthlyChangeDirection && monthlyChange ? `${monthlyChangeDirection} of ${monthlyChange} per month` : '[Increase / Decrease per month]'}</li>
</ul>

<p><strong>Total amount payable over the full term</strong></p>
<ul class="letter-bullets">
  <li>Under your current agreement: ${totalCurrent}</li>
  <li>Under the new agreement: ${totalNew}</li>
  <li>Estimated difference in total amount payable: ${totalDiff ? totalDiff : '[Increase / Decrease]'}</li>
</ul>

<p><strong>Term and indebtedness</strong></p>
<ul class="letter-bullets">
  <li>Remaining term on current agreement: ${d.currentRemainingTerm || '[Number] months'}</li>
  <li>Term of new agreement: ${d.newTerm}</li>
  <li>Overall effect on the length of time you are in debt: ${termEffect || '[Shorter / Similar / Longer]'}</li>
</ul>

<p><strong>Early repayment charges on current agreement</strong></p>
<ul class="letter-bullets">
  <li>Early repayment charges to settle your current agreement: ${d.earlyRepaymentChargesPaid}</li>
  <li>Treatment in new agreement: ${parseFloat((illData && illData.earlyRepaymentChargesPaid) || 0) > 0 ? 'Included within the new finance amount.' : '[Included within the new finance amount / Paid separately by you]'}</li>
</ul>

<p>
You confirmed that you are comfortable with the balance between monthly payment, total cost and term described above, and that this reflects your priorities.
</p>

<h3 class="section-title">5. Key Risks, Features and Alternatives Considered</h3>

<p>It is important that you understand the key risks and features of this type of product and the alternatives that were discussed.</p>

<p><strong>Key risks and features</strong></p>
<ul class="letter-bullets">
  <li>The agreement is secured on the vehicle. If you do not keep up with repayments, the lender may take legal action and the vehicle may be repossessed.</li>
  <li>Missing or late payments may negatively affect your credit rating and make it harder or more expensive to obtain credit in the future.</li>
  <li>Refinancing may increase the total amount payable and/or extend the period over which you are in debt, unless the comparison above shows a reduction.</li>
  <li>If your agreement includes a final balloon / optional final payment, you must pay this amount (or refinance it, or part-exchange the vehicle) at the end of the term if you wish to keep the vehicle.</li>
  <li>If your agreement has mileage limits or condition requirements, you may incur additional charges at the end of the term if you exceed the agreed mileage or if the vehicle is not in an acceptable condition.</li>
  <li>Early settlement of the new agreement may result in charges or rebates in accordance with the lender&rsquo;s terms and conditions.</li>
</ul>

<p><strong>Alternatives discussed</strong></p>
<p>We made you aware that you did not have to refinance and that you could:</p>
<ul class="letter-bullets">
  <li>remain in your existing agreement and continue making your current payments;</li>
  <li>settle your existing agreement using your own funds (if available);</li>
  <li>change the vehicle (for example, by part-exchange), where appropriate; or</li>
  <li>consider other forms of credit that may be available to you elsewhere.</li>
</ul>
<p>
You confirmed that, having considered these alternatives, you wish to proceed with the new refinance agreement described in this letter.
</p>

<h3 class="section-title">6. Our Status and Commission Disclosure</h3>

<p><strong>Our status</strong></p>
<p>We do not provide independent financial advice and we will not tell you whether you should enter into this agreement. We provide information to help you make your own choice. If you are unsure whether this type of finance is suitable for you, you may wish to seek independent financial advice.</p>
<p>We work with a broad panel of lenders.  ${d.coTrading} acts as a credit broker, not a lender.</p>

<p><strong>Commission disclosure</strong></p>
<p>If you enter into the new agreement, we will receive a commission from the lender for arranging it.
Our estimated commission on this agreement is ${d.commission}. The actual commission amount we receive is available on request before you sign the finance agreement.
Any commission we receive is included within the figures quoted and does not increase the amount you pay under the agreement.
The commission is set by the lender and is not part of a Discretionary Commission Arrangement (DCA). It has not influenced the lender or product presented to you.</p>

<div class="dns-mini">
<h3 class="section-title">7. Vehicle Condition Declaration</h3>

<p>By proceeding, you confirm that:</p>
<ul class="letter-bullets">
  <li>the vehicle is free from any known faults (other than those declared to us and, where applicable, to the lender);</li>
  <li>it has been properly maintained in line with the manufacturer&rsquo;s recommendations (where applicable); and</li>
  <li>to the best of your knowledge, it is in good and safe working order at the point of entering into this refinance agreement.</li>
</ul>
<p>You also confirm that you have received, read and understood our Refinance Customer Terms of Business, and you agree to be bound by those terms.</p>


</div>

<div class="dns-mini">
<h3 class="section-title">8A. Important Information About Refinancing</h3>

<p>
This new agreement is a refinance used to settle your existing car finance. It is a separate agreement (not a change to your current one).
We will follow your instructions to arrange settlement with your current lender once you have agreed the new agreement.
</p>

<ul class="letter-bullets">
  <li><strong>Settlement figure:</strong> the settlement amount can change between an estimate and the confirmed figure provided by your current lender. If the settlement figure changes, the figures shown may change.</li>
  <li><strong>Fees and charges:</strong> your existing agreement may include early settlement fees and/or other charges. These may be payable and can affect the overall cost.</li>
  <li><strong>Negative equity:</strong> if you owe more than the vehicle’s value, the shortfall may be carried into the new agreement, increasing the amount you borrow and the total you repay.</li>
  <li><strong>Term and total cost:</strong> reducing the monthly payment can involve extending the term. A longer term may mean you pay more overall.</li>
  <li><strong>Missed payments:</strong> missed or late payments can lead to arrears, additional charges, a negative impact on your credit file and (where relevant) the risk of the vehicle being repossessed.</li>
</ul>

<p>
Your legal rights about the quality of the vehicle are usually against the selling dealer/trader and depend on when the vehicle was supplied.
Refinancing does not restart or extend those time limits.
If you have a complaint about the original sale, any “connected lender” rights that may apply to the original purchase are generally linked to the original purchase finance, not this refinance agreement.
</p>

<p>
We act as a credit broker and will help coordinate settlement as instructed by you. The lender you choose provides the finance, and we are not the seller of the vehicle. This refinance is not a re-sale of the vehicle.
</p>



<div class="dns-mini">
<div class="dns-mini">
<h3 class="section-title">8B. Settlement Authority &amp; Limited Role</h3>

<p>
To complete the refinance, the existing agreement normally needs to be settled. By signing/confirming this letter, you authorise us to act on your behalf solely for the settlement step described below.
</p>

<ul class="letter-bullets">
  <li>We may request a settlement figure (and updated figures if needed) from your current lender using your details and the vehicle registration.</li>
  <li>You instruct us to use the refinance proceeds (or the new lender’s payment instructions) to pass the settlement amount to your current lender to clear the existing agreement.</li>
  <li>Our role is limited to coordinating this pass-through settlement. We do not own the vehicle, we do not re-sell it to you, and we are not a party to the new credit agreement between you and the new lender.</li>
  <li>If the settlement amount changes or there is any shortfall, this remains your responsibility unless the new lender confirms otherwise.</li>
</ul>

<p>

<h4 class="section-subtitle">Settlement authority</h4>
<p class="small-print">
This section explains how settlement may be handled.
</p>

<p class="small-print">
I confirm I am refinancing my existing vehicle finance and that this process is not a sale or re-sale of the vehicle. I authorise the Dealer to liaise with my current finance provider to obtain settlement figures and to clear the existing finance/charge on the vehicle using funds made available for this purpose.
</p>
<p class="small-print">
I understand the new lender will register a new finance/charge on the vehicle and may release refinance funds to the credit broker (Compare My Finance). The credit broker may then release those funds to the Dealer solely so the Dealer can settle my existing finance/charge (and any related settlement amount) with my current finance provider. Compare My Finance is not the lender and does not provide the finance.
</p>
<p class="small-print">
I understand the Dealer is not providing finance and does not decide whether I am offered finance or the terms of any finance. The Dealer’s role is limited to settlement administration as authorised by me. The Dealer will not charge me a fee for this settlement administration and will not retain any surplus of the refinance funds.
</p>
<p class="small-print">
If there is any difference between the settlement figure paid and the amount received, the credit broker and/or I will be responsible for resolving any shortfall or arranging any refund as appropriate. I understand that settling my existing finance may be subject to early settlement charges and that settlement figures can change. If the settlement figure increases between quote and payment, I authorise the Dealer to notify the credit broker promptly and I understand completion may be delayed until the shortfall is covered.
</p>

<strong>Settlement authority:</strong> I/We authorise Compare My Finance to obtain settlement figures and to arrange payment of the settlement to my/our existing lender as part of the refinance, and I/We understand their role is limited to settlement coordination.
</p>


</div>

</div>

</div>

<h3 class="section-title">9. Your Confirmation</h3>

<p>By signing below, you confirm that:</p>
<ul class="letter-bullets">
  <li>The information you have provided about your circumstances is true, accurate and complete to the best of your knowledge.</li>
  <li>The demands and needs described in section 1 accurately reflect what you are looking to achieve from this finance agreement.</li>
  <li>You have received and understood the lender&rsquo;s Pre-Contract Information and Adequate Explanation documents.</li>
  <li>You understand the key features, risks and alternatives of this product as explained above.</li>
  <li>You are satisfied that the agreement you have chosen meets your demands and needs at this time.</li>
  <li>You understand that failing to keep up with repayments can have serious consequences, including damage to your credit file and potential repossession of the vehicle.</li>
</ul>

<p>Please read this letter carefully and contact us immediately if anything is unclear, incorrect or does not reflect your understanding, or if your circumstances change.</p>

<h3 class="section-title">Customer Declaration and Signature</h3>

<p>I have read and understood this Demands and Needs / Suitability Statement and confirm that it accurately reflects our discussions and my understanding of the agreement.</p>

<p>Customer name: _______________________________</p>
<p>Signature: ____________________________________</p>
<p>Date: ________________________________________</p>
<br>
<div class="letter-footer small-print">
  <p><strong>${d.coTrading}</strong> &middot; ${d.coAddr1}, ${d.coAddr2}, ${d.coPostcode} &middot; Email: ${d.coEmail} &middot; Authorised and regulated by the Financial Conduct Authority (FRN: ${d.coFca}).</p>
</div>

`);
            };
            const checkPrintState = () => {
                if (!checklistToggle || !printBtn || !printReminder) return;
                const isEnabled = checklistToggle.checked && Array.from(checklistCheckboxes).every(cb => cb.checked);
                printBtn.disabled = !isEnabled;
                toggleClass(printReminder, 'hidden', isEnabled);
            };
            const setupConditionalDisplay = (triggerId, targetId, showCondition, otherTargetId = null) => {
                const trigger = getEl(triggerId);
                if (trigger) on(trigger, 'change', function() {
                    toggleClass(getEl(targetId), 'hidden', !showCondition(this.value));
                    if(otherTargetId) toggleClass(getEl(otherTargetId), 'hidden', true);
                    updateLetterPreview();
                });
            };
            $$('#demands-and-needs-section input, #demands-and-needs-section select, #demands-and-needs-section textarea').forEach(input => { if(input) on(input, 'input', updateLetterPreview); });
            if (checklistToggle) on(checklistToggle, 'change', function() { toggleClass(checklistItems, 'hidden', !this.checked); checkPrintState(); });
            on(getEl('ltr_primary-demand-need'), 'change', function() {
                const secondarySelect = getEl('ltr_secondary-demand-need');
                for (const opt of secondarySelect.options) opt.disabled = (opt.value === this.value && this.value !== "");
                if (secondarySelect.value === this.value) secondarySelect.value = "";
                toggleClass(getEl('ltr_secondary-demand-need-container'), 'hidden', !this.value);
                if (!this.value) secondarySelect.value = "";
                updateLetterPreview();
            });
            setupConditionalDisplay('ltr_term-change-choice', 'ltr_term-extension-reason-section', v => v === 'extend', 'ltr_term-reduction-reason-section');
            setupConditionalDisplay('ltr_term-change-choice', 'ltr_term-reduction-reason-section', v => v === 'reduce', 'ltr_term-extension-reason-section');
            setupConditionalDisplay('ltr_term-extension-reason', 'ltr_term-extension-reason-other', v => v === 'Other');
            setupConditionalDisplay('ltr_term-reduction-reason', 'ltr_term-reduction-reason-other', v => v === 'Other');
            if(printBtn) on(printBtn, 'click', () => {
                if (printBtn.disabled) return showToast("Please enable and complete the 'FINAL QUOTE CHECKLIST' before printing.", "error");
                const primaryNeedEl = getEl('ltr_primary-demand-need');
                if (primaryNeedEl && !primaryNeedEl.value) {
                    showToast("Please select a Primary Need.", "error");
                    primaryNeedEl.focus();
                    return;
                }
                const newTypeEl = getEl('ltr_new-term-type');
                if (newTypeEl && !newTypeEl.value) {
                    showToast("Please select a New Finance Option (Type of agreement).", "error");
                    newTypeEl.focus();
                    return;
                }
                const printWindow = window.open('', '_blank');
                const safeLetterHTML = (letterPreview && letterPreview.innerHTML ? letterPreview.innerHTML : '')
                  .replace(/<script[\s\S]*?<\/script>/gi, '')
                  .replace(/on\w+\s*=\s*(['"]).*?\1/gi, ''); // strip inline handlers too

                // Build the print document without injecting user HTML into // (removed unsafe document.write)
                const doc = printWindow.document;
                const printCss = `body{font-family:"Poppins",sans-serif;line-height:1.3;color:#333;margin:12px}h1,h2,h3{font-family:"Poppins",sans-serif;color:#004225}.section-title{font-size:1.1em;font-weight:700;margin-top:0.8em;margin-bottom:.25em;border-bottom:1px solid #eee;padding-bottom:.25em}p{margin-bottom:0.45em}strong{font-weight:700}.company-details p, ...client-details p{margin-bottom:.2em}.footer{margin-top:3em;padding-top:1em;border-top:1px solid #004225;font-size:.9em;color:#555}.esign-section{margin-top:3em;padding-top:1.5em;border-top:1px solid #cce1d7}.esign-declaration{font-style:italic;margin-bottom:1.5em}.esign-signature-line{border-bottom:1px solid #333;height:2em;margin-bottom:.25em;width:70%}.esign-date-line{border-bottom:1px solid #333;height:1.5em;margin-bottom:.25em;width:40%;display:inline-block}
/* --- VRN as mini car reg plate --- */
.vrn-plate{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background: #FDE047;              /* yellow */
  border: 1px solid #000;           /* black border */
  border-radius: 6px;
  padding: 2px 6px;
  display: inline-block;
  letter-spacing: .06em;
  color: #000;
  font-weight: 800;
  line-height: 1;
}

/* Bold currency (no decimals) for NEW payment & savings */
.currency-bold { font-weight:700; }

/* Settlement input a touch larger */
.settlement-input { font-size:1.05rem; }

/* Green “ready to deal+” border */
.kanban-card.deal-ready { border-left-color:#22c55e !important; }

`;
                doc.open();
                doc.write('<!doctype html><html><head><meta charset="utf-8"><title>Demands & Needs Statement</title></head><body></body></html>');
                doc.close();

                const styleEl = doc.createElement('style');
                styleEl.textContent = printCss;
                doc.head.appendChild(styleEl);

                doc.body.innerHTML = safeLetterHTML;

                printWindow.focus();
                printWindow.print()
            });
            checklistCheckboxes.forEach(cb => on(cb, 'change', checkPrintState));
            window.prefillLetterCreator = () => {
                const d = window.illustratorResultsData;
                if (!d || Object.keys(d).length === 0) return;
                const setField = (id, val, isSelect = false) => {
                    const el = getEl(id);
                    if (el) {
                        el.value = val !== undefined && val !== null ? val : '';
                        el.dispatchEvent(new Event('input', { bubbles: true }));
                        if (isSelect) el.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                };
                const fTypeMap = { 'pcp': 'PCP', 'hp': 'HP' };
                setField('ltr_current-lender', d.currentLender); setField('ltr_current-finance-type', fTypeMap[d.currentFinanceType] || 'Other', true);
                setField('ltr_current-vehicle-price', d.currentVehiclePrice); setField('ltr_current-deposit', d.currentDeposit); setField('ltr_current-apr', d.currentApr);
                setField('ltr_current-term', d.currentTerm); setField('ltr_current-monthly-payment', d.currentMonthlyPayment?.toFixed(2)); setField('ltr_current-balloon', d.currentBalloon);
                setField('ltr_current-agreement-start-date', d.currentAgreementStartDate); setField('ltr_current-payments-made', d.currentPaymentsMade);
                setField('ltr_new-lender-name', d.newLenderName); setField('ltr_new-finance-amount', d.newFinanceAmount?.toFixed(2)); setField('ltr_new-additional-cash', d.newAdditionalCash);
                setField('ltr_new-apr', d.newApr); setField('ltr_new-term', d.newTerm); setField('ltr_new-monthly-payment', d.newMonthlyPayment?.toFixed(2));
                setField('ltr_new-balloon', d.newBalloon?.toFixed(2)); setField('ltr_early-repayment-charges-paid', d.earlyRepaymentChargesPaid?.toFixed(2));
                setField('ltr_potential-commission', `£${d.estimatedCommission?.toFixed(2)}`);
            };
            setVal('ltr_letter-date', new Date().toISOString().split('T')[0]);
            checkPrintState(); updateLetterPreview();
        };

            // (deduped duplicate prefillLetterCreator block)

            /* =======================================================================
   TAB: SALES PIPELINE (KANBAN)
   -----------------------------------------------------------------------
   Expected UI:
     - Kanban columns for each deal stage
     - Deal cards within columns
   Common failure mode:
     - If stage mapping keys change or render pipeline isn't called when
       switching tabs, kanban looks empty.
   Protection:
     - Delegated tab wiring triggers App.render.all() when Sales Pipeline
       tab becomes active.
   ======================================================================= */

const initializeSalesPipelineCRM = () => {
            const GOOGLE_SCRIPT_URL = CONFIG.ENDPOINTS.CRM;
            let navMessageTimer;
            const showNavMessage = (message, type = 'info', duration = 3000) => {
                const messageArea = getEl('nav-message-area'), messageText = getEl('nav-message-text');
                if (!messageArea || !messageText) return;
                clearTimeout(navMessageTimer);
                messageText.textContent = message;
                messageText.className = type === 'error' ? 'text-red-300' : (type === 'info' ? 'text-yellow-300' : 'text-white');
                messageArea.classList.remove('opacity-0');
                navMessageTimer = setTimeout(() => messageArea.classList.add('opacity-0'), duration);
            };
            const enableContactsColumnResize = () => {
                const table = getEl('contacts-table');
                if (!table || table.dataset.resizersSetup === 'true') return;
                const theadRow = table.tHead?.rows?.[0];
                if (!theadRow) return;
                table.style.tableLayout = 'fixed';
                let colgroup = table.querySelector('colgroup');
                if (!colgroup) {
                    colgroup = document.createElement('colgroup');
                    theadRow.cells.forEach(() => colgroup.appendChild(document.createElement('col')));
                    table.insertBefore(colgroup, table.firstChild);
                }
                const ths = Array.from(theadRow.cells);
                ths.forEach((th, idx) => {
                    const w = th.getBoundingClientRect().width || 100;
                    colgroup.children[idx].style.width = `${Math.max(w, idx === 0 ? 40 : 80)}px`;
                    if (th.querySelector('.col-resizer')) return;
                    const resizer = document.createElement('span');
                    resizer.className = 'col-resizer';
                    th.appendChild(resizer);
                    let startX = 0, startWidth = 0;
                    const doMouseMove = e => {
                        const newWidth = Math.max((idx === 0 ? 40 : 80), startWidth + (e.clientX - startX));
                        colgroup.children[idx].style.width = `${newWidth}px`;
                    };
                    const doMouseUp = () => {
                        document.removeEventListener('mousemove', doMouseMove);
                        document.removeEventListener('mouseup', doMouseUp);
                        document.body.classList.remove('is-resizing');
                    };
                    resizer.addEventListener('mousedown', e => {
                        e.preventDefault(); e.stopPropagation();
                        startX = e.clientX;
                        startWidth = th.getBoundingClientRect().width;
                        document.body.classList.add('is-resizing');
                        document.addEventListener('mousemove', doMouseMove);
                        document.addEventListener('mouseup', doMouseUp);
                    });
                });
                table.dataset.resizersSetup = 'true';
            };

const SaveManager = {
    _queue: [],
    _isProcessing: false,

    // Entry point: user wants to save a deal
    async saveDeal(deal, opts = {}) {
        return new Promise((resolve, reject) => {
            // De-dupe queued saves per deal so rapid UI updates don't create stale-version conflicts
            const dealId = (window.App && App.utils && typeof App.utils.getDealId === 'function')
                ? App.utils.getDealId(deal)
                : (deal && (deal.id ?? deal.ID ?? deal.Id ?? deal.dealId ?? deal.dealID ?? deal.DealId ?? deal.DealID)) || '';
            const vrn = (window.App && App.utils && typeof App.utils.getVrn === 'function')
                ? App.utils.getVrn(deal)
                : (deal && (deal.vrn ?? deal.VRN ?? deal.Vrn ?? deal.vehicleReg ?? deal.registration)) || '';
            const key = dealId ? `id:${String(dealId)}` : (vrn ? `vrn:${String(vrn)}` : '');

            if (!key) {
                reject(new Error('Missing deal identifier (id/vrn).'));
                return;
            }
const existing = this._queue.find(item => item && item.key === key);
            if (existing) {
                existing.deal = deal; // keep latest snapshot
                // Merge opts: if any caller wants non-silent, treat it as non-silent
                existing.opts = existing.opts || {};
                const nextSilent = !!(opts && opts.silent);
                existing.opts.silent = !!existing.opts.silent && nextSilent;
                existing.opts.reason = (opts && opts.reason) ? opts.reason : existing.opts.reason;
                existing.resolvers.push(resolve);
                existing.rejecters.push(reject);
            } else {
                this._queue.push({ key, deal, opts: (opts || {}), resolvers: [resolve], rejecters: [reject] });
            }
            this._processQueue();
        });
    },

    async _processQueue() {
        // If already saving something, do nothing. The loop will pick it up next.
        if (this._isProcessing) return;

        this._isProcessing = true;

        const saveErrors = [];
        let hadNonSilentSaves = false;

        while (this._queue.length > 0) {
            // Get the next deal to save (FIFO)
            const { key, deal, opts, resolvers, rejecters } = this._queue.shift();
            const _resolvers = Array.isArray(resolvers) ? resolvers : [];
            const _rejecters = Array.isArray(rejecters) ? rejecters : [];
            const silent = !!(opts && opts.silent);
            if (!silent) hadNonSilentSaves = true;
            const notify = (...args) => { try { if (!silent && typeof showNavMessage === 'function') showNavMessage(...args); } catch(e){} };
            let currentDeal = deal;
            // Resolve identifiers safely (supports legacy schemas)
            const dealId = (window.App && App.utils && typeof App.utils.getDealId === 'function')
                ? App.utils.getDealId(deal)
                : (deal && (deal.id ?? deal.ID ?? deal.Id ?? deal.dealId ?? deal.dealID ?? deal.DealId ?? deal.DealID)) || '';
            const vrn = (window.App && App.utils && typeof App.utils.getVrn === 'function')
                ? App.utils.getVrn(deal)
                : (deal && (deal.vrn ?? deal.VRN ?? deal.Vrn ?? deal.vehicleReg ?? deal.registration)) || '';
            const sourceSheet = (currentDeal && currentDeal.sourceSheet != null) ? String(currentDeal.sourceSheet).trim() : '';
            const id = String((dealId && String(dealId).trim()) || (vrn && String(vrn).trim()) || '(missing id)');
            // Prefer latest in-memory deal (it may carry a fresher lastUpdated from a prior save)
            try {
                const live = App.state.deals.find(d => {
                    const fid = (App.utils && typeof App.utils.getDealId === 'function')
                        ? String(App.utils.getDealId(d) || '')
                        : String(d && d.id ? d.id : '');
                    return fid === id;
                });
                if (live && live !== currentDeal) {
                    const desired = currentDeal;
                    currentDeal = { ...live, ...desired };
                    if (live.updatedAt) currentDeal.updatedAt = live.updatedAt;
                    if (live.lastUpdated) currentDeal.lastUpdated = live.lastUpdated;
                }
            } catch (e) {}

            // Hard guard: do not attempt save without a usable identifier
            if (!dealId && !vrn) {
                const errObj = { error: 'Missing identifiers (id/vrn)', deal };
                console.warn('Skipping save: missing identifiers', deal);
                if (Array.isArray(saveErrors)) {
                    saveErrors.push({ key: id, error: 'Missing identifiers (id/vrn)', deal: currentDeal });
                }
                if (typeof showNavMessage === 'function') {
                    showNavMessage('Cannot save: missing ID/VRN.', 'error', 5000);
                }
                _rejecters.forEach(fn => { try { fn(errObj); } catch(e){} });
                continue;
            }
// Visual Feedback (Optional): Show "Saving..." (skip for silent saves)
            const statusText = document.getElementById('nav-message-text');
            if (!silent && statusText) {
                statusText.textContent = `Saving deal ${id}...`;
                statusText.parentElement.classList.remove('opacity-0');
            }

            let lastResult = null;
            let success = false;
            let attempts = 0;
            let sentSnapshot = null;
            const _clone = (obj) => {
                try { return structuredClone(obj); } catch (e) {
                    try { return JSON.parse(JSON.stringify(obj)); } catch (e2) { return { ...(obj || {}) }; }
                }
            };
            const _equal = (a, b) => {
                if (a === b) return true;
                if ((a === null || a === undefined) && (b === null || b === undefined)) return true;
                const ta = typeof a, tb = typeof b;
                if (ta !== 'object' && tb !== 'object') return String(a) === String(b);
                try { return JSON.stringify(a) === JSON.stringify(b); } catch (e) { return false; }
            };
            // Delta-save helpers: keep a snapshot of what we believe the server currently has,
            // so we can send only changed fields (reduces Apps Script load and spreadsheet contention).
            const _stripInternal = (obj) => {
                const out = {};
                try {
                    Object.keys(obj || {}).forEach(k => { if (!String(k).startsWith('_')) out[k] = obj[k]; });
                } catch (e) {}
                return out;
            };
            const _safeSnapshot = (obj) => _clone(_stripInternal(obj || {}));
            const _getServerSnapshot = () => {
                // Prefer the attached snapshot on the queued deal
                if (deal && typeof deal === 'object' && deal._serverSnapshot) return deal._serverSnapshot;
                // Fall back to the in-memory deal (if present) to keep comparisons stable
                try {
                    if (window.App && App.state && Array.isArray(App.state.deals)) {
                        if (dealId) {
                            const hit = App.state.deals.find(d => String(App.utils.getDealId(d)) === String(dealId).trim());
                            if (hit && hit._serverSnapshot) return hit._serverSnapshot;
                            if (hit) return _safeSnapshot(hit);
                        }
                        if (vrn && App.utils && typeof App.utils.getVrn === 'function') {
                            const hit = App.state.deals.find(d => String(App.utils.getVrn(d)) === String(vrn).trim());
                            if (hit && hit._serverSnapshot) return hit._serverSnapshot;
                            if (hit) return _safeSnapshot(hit);
                        }
                    }
                } catch (e) {}
                return deal && typeof deal === 'object' ? _safeSnapshot(deal) : null;
            };


            
            // TEMP LOCK FOR SAVE (no heartbeat): backend save is wrapped in withLock_.
            // Even in desktop/non-collab mode (locking UI disabled), we acquire+release a short lock
            // just around the save to prevent CONFLICT errors from missing lock state.
            let __tempSaveLockId = null;
            try {
                const _id = String(dealId || (App.utils && typeof App.utils.getDealId === 'function' ? App.utils.getDealId(currentDeal) : (currentDeal && currentDeal.id)) || '').trim();
                if (_id && App && App.lock && App.lock.enabled === false) {
                    __tempSaveLockId = _id;
                    await App.apiCall('POST', { action: 'acquireLock', payload: { dealId: _id, clientId: (window.CMF_CLIENT_ID || 'webapp'), mode: 'saveOnce' } });
                }
            } catch (e) { /* best effort */ }

// Retry Loop (Handles "Server Busy")
            while (attempts < 3 && !success) {
                try {
                    attempts++;
                    if (attempts > 1) await new Promise(r => setTimeout(r, 2000 * attempts)); // Backoff

                    // Perform the Save
                    sentSnapshot = _clone(currentDeal);

                    // Build a delta payload instead of sending the full deal every time.
                    const serverSnap = _getServerSnapshot();
                    const payload = {
                        // Identifiers
                        ...(dealId ? { id: String(dealId).trim() } : {}),
                        ...(vrn ? { vrn: String(vrn).trim() } : {}),
                        ...(sourceSheet ? { sourceSheet } : {}),
                        // Optional: allow Apps Script to match by VRN when no id is present
                        ...((!dealId && vrn) ? { matchKey: `vrn:${String(vrn).trim()}` } : {}),
                        // Always include version token for conflict detection
                        lastUpdated: (currentDeal.updatedAt || currentDeal.lastUpdated || null)
                    };

                    let hasChanges = false;
                    try {
                        Object.keys(currentDeal || {}).forEach(k => {
                            // Skip internal fields and metadata that either shouldn't be written or are handled separately
                            if (String(k).startsWith('_')) return;
                            if (k === 'stageHistory' || k === 'lastUpdated' || k === 'updatedAt') return;

                            const originalVal = serverSnap ? serverSnap[k] : undefined;
                            const newVal = currentDeal[k];

                            if (!_equal(originalVal, newVal)) {
                                payload[k] = newVal;
                                hasChanges = true;
                            }
                        });
                    } catch (e) { /* non-fatal */ }

                    // If stage changed, send history log too (keeps audit trail correct)
                    if (payload.dealStage && currentDeal && currentDeal.stageHistory) {
                        payload.stageHistory = currentDeal.stageHistory;
                        hasChanges = true;
                    }

                    const forceSave = !!(opts && (opts.force || opts.forceSave));
                    if (hasChanges || forceSave) {
                        lastResult = await App.apiCall('POST', { action: 'save', payload: payload });
                    } else {
                        // Nothing changed: treat as success and avoid hammering Apps Script / Sheets.
                        lastResult = { success: true, skipped: true };
                    }

                    if (lastResult && lastResult.success) {
                        success = true;
                        // Update local state with server response to ensure sync
                        let idx = -1;
                        try {
                            if (dealId) {
                                idx = App.state.deals.findIndex(d => String(App.utils.getDealId(d)) === String(dealId).trim());
                            } else if (vrn && App.utils && typeof App.utils.getVrn === 'function') {
                                idx = App.state.deals.findIndex(d => String(App.utils.getVrn(d)) === String(vrn).trim());
                            }
                        } catch (e) {
                            // Fallback to previous behaviour
                            idx = App.state.deals.findIndex(d => String(App.utils.getDealId(d)) === id);
                        }
                        if (idx > -1 && lastResult.deal) {
                            const serverDeal = lastResult.deal || {};
                            const target = App.state.deals[idx];
                            if (target && typeof target === 'object') {
                                // Only apply server fields that the user hasn't changed since we sent this save.
                                try {
                                    Object.keys(serverDeal).forEach(k => {
                                        if (k === 'updatedAt' || k === 'lastUpdated') return;
                                        const snapVal = sentSnapshot ? sentSnapshot[k] : undefined;
                                        if (!sentSnapshot || _equal(target[k], snapVal)) {
                                            target[k] = serverDeal[k];
                                        }
                                    });
                                } catch (e) { /* non-fatal */ }
                                // Always trust server's version tokens
                                if (serverDeal.updatedAt) target.updatedAt = serverDeal.updatedAt;
                                if (serverDeal.lastUpdated) target.lastUpdated = serverDeal.lastUpdated;
                                // Refresh server snapshot after applying the server response (for future delta saves).
                                try { target._serverSnapshot = _safeSnapshot(target); } catch (e) { /* non-fatal */ }

                            } else {
                                App.state.deals[idx] = { ...(sentSnapshot || {}), ...serverDeal };
                            }
                        }
                    } else {
                        // Handle optimistic locking conflicts explicitly
                        if (lastResult && lastResult.error && String(lastResult.error).includes("CONFLICT")) {
                            // In single-user usage this is usually a stale version token from rapid successive saves.
                            // Auto-refresh once, re-apply the pending local changes, then retry.
                            if (!currentDeal.__conflictResynced) {
                                currentDeal.__conflictResynced = true;
                                notify('Conflict detected. Refreshing data and retrying save...', 'warning', 4000);
                                try { await App.loadData(); } catch (e) {}
                                try {
                                    const fresh = App.state.deals.find(d => {
                                        const fid = (App.utils && typeof App.utils.getDealId === 'function')
                                            ? String(App.utils.getDealId(d) || '')
                                            : String(d && d.id ? d.id : '');
                                        return fid === id;
                                    });
                                    if (fresh) {
                                        const desired = currentDeal;
                                        currentDeal = { ...fresh, ...desired };
                                        if (fresh.updatedAt) currentDeal.updatedAt = fresh.updatedAt;
                                        if (fresh.lastUpdated) currentDeal.lastUpdated = fresh.lastUpdated;
                                    }
                                } catch (e) {}
                                continue;
                            }
                        }
console.warn(`Save attempt ${attempts} failed for ${id}:`, lastResult?.error);
                    }
                } catch (err) {
                    console.error(`Network error saving ${id}:`, err);
                }
            }

            // Release the temporary save lock (best effort)
            try {
                if (__tempSaveLockId && App && App.lock && App.lock.enabled === false) {
                    await App.apiCall('POST', { action: 'releaseLock', payload: { dealId: __tempSaveLockId, clientId: (window.CMF_CLIENT_ID || 'webapp'), mode: 'saveOnce' } });
                }
            } catch (e) { /* ignore */ }


            // Report back to caller
            if (success) _resolvers.forEach(fn => { try { fn(lastResult); } catch(e){} });
            else {
                saveErrors.push({
                    key: id,
                    error: (lastResult && lastResult.error) ? String(lastResult.error) : 'Unknown error',
                    result: lastResult,
                    deal: deal
                });
                console.warn('Save failed:', id, lastResult);
                showNavMessage(`Failed to save deal ${id}. Please retry.`, 'error', 5000);
                _rejecters.forEach(fn => { try { fn(lastResult || { error: 'Unknown error' }); } catch(e){} });
            }
        }

        // Queue empty - Done.
        this._isProcessing = false;

        // Guard against a "lost wakeup" race:
        // if a save is queued after the while-loop exits but before _isProcessing flips false,
        // saveDeal() will have called _processQueue() while we were still processing (and it returned early),
        // leaving items stuck in the queue. If anything is queued now, schedule another drain.
        if (this._queue.length > 0) {
            setTimeout(() => this._processQueue(), 0);
        }

        if (saveErrors.length > 0) {
            console.warn("SAVE ERRORS DETECTED:", saveErrors);
            try {
                const summary = saveErrors.slice(0, 10)
                    .map(e => `• ${e.key}: ${e.error}`)
                    .join('\n');
                alert(`SAVE ERRORS DETECTED

${summary}

Open the console for full details.`);
            } catch (e) { /* non-fatal */ }
            showNavMessage(`${saveErrors.length} save(s) failed. See details.`, "error", 6000);
        } else {
            if (hadNonSilentSaves) showNavMessage("All changes saved.", "success", 2000);
        }
}
};

// ---------------------------------------------------------------------
// Jigsaw Bank Account payload helper (Option A)
// Ensures the front-end sends a canonical BankAccount object alongside the
// existing flat fields, without breaking backward compatibility.
// ---------------------------------------------------------------------
function normalizeSortCodeForJigsaw(v) {
    const raw = (v === null || v === undefined) ? '' : String(v);
    const digits = raw.replace(/\D/g, '');
    if (digits.length >= 6) {
        const d = digits.slice(0, 6);
        return `${d.slice(0, 2)}-${d.slice(2, 4)}-${d.slice(4, 6)}`;
    }
    return raw.trim();
}

function normalizeAccountNumberForJigsaw(v) {
    const raw = (v === null || v === undefined) ? '' : String(v);
    const digits = raw.replace(/\D/g, '');
    if (!digits) return raw.trim();
    if (digits.length === 8) return digits;
    if (digits.length < 8) return digits;         // backend validation will catch if incomplete
    return digits.slice(-8);                      // if pasted with spaces/extra digits, keep last 8
}

function intOrNull(v) {
    const s = (v === null || v === undefined) ? '' : String(v).trim();
    if (s === '') return null;
    const n = parseInt(s, 10);
    return Number.isFinite(n) ? n : null;
}

function applyBankAccountToJigsawPayloadDeal(payloadDeal, formData) {
    try {
        if (!payloadDeal || typeof payloadDeal !== 'object') return;
        const fd = formData || {};

        const accountName = String(
            (fd.accountName ?? fd.accountHolder ?? payloadDeal.accountName ?? payloadDeal.accountHolder ?? '')
        ).trim();

        const accountNumber = normalizeAccountNumberForJigsaw(fd.accountNumber ?? payloadDeal.accountNumber);
        const sortCode = normalizeSortCodeForJigsaw(fd.sortCode ?? payloadDeal.sortCode);

        const years = (intOrNull(fd.bankYears ?? payloadDeal.bankYears ?? fd.yearsWithBank ?? payloadDeal.yearsWithBank) ?? 0);
        const months = (intOrNull(fd.bankMonths ?? payloadDeal.bankMonths ?? fd.monthsWithBank ?? payloadDeal.monthsWithBank) ?? 0);

        const bankName = String((fd.bankName ?? payloadDeal.bankName ?? '')).trim();

        // Preserve existing flat fields, but ensure canonical aliases exist for mapping.
        if (accountName && payloadDeal.accountName === undefined) payloadDeal.accountName = accountName;
        if (accountName && payloadDeal.accountHolder === undefined) payloadDeal.accountHolder = accountName;

        if (bankName) payloadDeal.bankName = bankName;
        if (sortCode) payloadDeal.sortCode = sortCode;
        if (accountNumber) payloadDeal.accountNumber = accountNumber;

        // Canonical names (camelCase)
        payloadDeal.yearsWithBank = years;
        payloadDeal.monthsWithBank = months;

        // Option A: nested BankAccount object (camelCase + PascalCase) for backend -> Jigsaw mapping
        if (!payloadDeal.bankAccount || typeof payloadDeal.bankAccount !== 'object') payloadDeal.bankAccount = {};
        Object.assign(payloadDeal.bankAccount, {
            // camelCase
            accountName,
            accountNumber,
            sortCode,
            yearsWithBank: years,
            monthsWithBank: months,
            bankName,
            // PascalCase (matches Jigsaw model naming)
            AccountName: accountName,
            AccountNumber: accountNumber,
            SortCode: sortCode,
            YearsWithBank: years,
            MonthsWithBank: months,
            BankName: bankName
        });

        // Keep the original bankYears/bankMonths fields too (don’t break anything expecting them)
        if (fd.bankYears !== undefined && payloadDeal.bankYears === undefined) payloadDeal.bankYears = fd.bankYears;
        if (fd.bankMonths !== undefined && payloadDeal.bankMonths === undefined) payloadDeal.bankMonths = fd.bankMonths;
    } catch (e) {
        // Non-fatal; never block Send/Validate
        console.warn('applyBankAccountToJigsawPayloadDeal failed:', e);
    }
}

/* =======================================================================
   APP ARCHITECTURE OVERVIEW
   -----------------------------------------------------------------------
   App is a single global controller object that holds:
     - state: in-memory working data for current session
     - utils: helpers (formatting, DOM helpers, sanitization, etc.)
     - api: backend interaction helpers (Apps Script endpoints)
     - render: functions that paint UI sections (deals, kanban, modals)
     - init: boot sequence (auth, initial loads, event bindings)
   NOTE:
     - Sales Pipeline uses kanban stages + deal cards; keep render + stage
       mapping intact or the kanban will appear empty.
   ======================================================================= */

const App = {
                state: { deals: [], stages: [{ id: 'Enquiry', title: 'Enquiry'}, { id: 'Packaging', title: 'Underwriting' }, { id: 'Work In Progress', title: 'Work In Progress' }, { id: 'Ready To Deal', title: 'Ready To Deal' }, { id: 'Awaiting Payout', title: 'Awaiting Payout' }, { id: 'Completed', title: 'Completed' }, { id: 'Not Taken Up', title: 'Not Taken Up' }], parsedDeals: { unique: [], duplicates: [] }, surnameFilter: '', expertFilter: '', selectedContactIds: new Set(), currentView: 'pipeline', sortState: { key: 'receivedDate', direction: 'desc' }, resizersSetup: false },
                lock: {
                    enabled: false, // LOCKING DISABLED (desktop/non-collab mode)
                    currentDealId: null,
                    intervalId: null,
                    _boundBeforeUnload: false,
                    async acquire(dealId) {
                        const id = String(dealId || '').trim();
                        if (!this.enabled) return { success: true, status: 'DISABLED' };
                        if (!id) return { success: false, error: 'NO_ID' };
                        return await App.apiCall('POST', { action: 'acquireLock', payload: { dealId: id, clientId: (window.CMF_CLIENT_ID || 'webapp') } });
                    },
                    startHeartbeat(dealId) {
                        const id = String(dealId || '').trim();
                        if (!id) return;
                        if (!this.enabled) return;
                        this.stopHeartbeat();
                        // Renew every 45s (server TTL expected ~60s)
                        this.intervalId = setInterval(() => {
                            // Fire-and-forget; do not spam UI on failures
                            App.apiCall('POST', { action: 'acquireLock', payload: { dealId: id, clientId: (window.CMF_CLIENT_ID || 'webapp') } }).catch(() => {});
                        }, 45000);

                        // Best-effort release when tab closes/navigation happens
                        if (!this._boundBeforeUnload) {
                            this._boundBeforeUnload = true;
                            window.addEventListener('beforeunload', () => {
                                try {
                                    const cur = String(App.lock.currentDealId || '').trim();
                                    if (cur) {
                                        // Best effort; may be canceled by browser
                                        App.apiCall('POST', { action: 'releaseLock', payload: { dealId: cur, clientId: (window.CMF_CLIENT_ID || 'webapp') } });
                                    }
                                } catch (e) {}
                            });
                        }
                    },
                    stopHeartbeat() {
                        if (this.intervalId) {
                            clearInterval(this.intervalId);
                            this.intervalId = null;
                        }
                    },
                    async release(dealId) {
                        const id = String(dealId || this.currentDealId || '').trim();
                        if (!id) return { success: true };
                        this.stopHeartbeat();
                        try {
                            const res = await App.apiCall('POST', { action: 'releaseLock', payload: { dealId: id, clientId: (window.CMF_CLIENT_ID || 'webapp') } });
                            return res || { success: true };
                        } finally {
                            if (this.currentDealId === id) this.currentDealId = null;
                        }
                    }
                },

                config: {
                    CONTACT_STAGE_ID: 'Enquiry',
                    PAID_OUT_STAGE_ID: 'Completed',
                    JIGSAW: { ENABLED: true, ENV: 'UAT', TOKEN_URL: 'https://gateway-uat.jigsawfinance.com/Token', VALIDATE_URL: 'https://gateway-uat.jigsawfinance.com/api/validateJigsawReferral', SUBMIT_URL: 'https://gateway-uat.jigsawfinance.com/api/submitJigsawReferral' },
                    ALL_CSV_HEADERS: ['id', 'vrn', 'vin', 'make', 'model', 'year', 'colour', 'vehicleCurrentMileage', 'financeCompany', 'agreementNumber', 'price', 'deposit', 'currentApr', 'agreementStartDate', 'originalTerm', 'financeType', 'isRefinance', 'term', 'settlementTotal', 'annualMileage', 'receivedDate', 'employmentStatus', 'occupation', 'employerName', 'employerPhone', 'employmentYears', 'employmentMonths', 'monthlyTakeHomePay', 'previousEmployerName', 'previousOccupation', 'previousEmployerAddress1', 'previousEmploymentYears', 'previousEmploymentMonths', 'currentAddressLine1', 'currentAddressLine2', 'currentCity', 'currentPostcode', 'currentAddressYears', 'currentAddressMonths', 'residentialStatus', 'previousAddressLine1', 'previousAddressLine2', 'previousCity', 'previousPostcode', 'previousAddressYears', 'previousAddressMonths', 'previousResidentialStatus', 'title', 'firstName', 'lastName', 'email', 'phone', 'dob', 'maritalStatus', 'bankName', 'accountHolder', 'sortCode', 'accountNumber', 'bankYears', 'bankMonths', 'consentMarketing', 'consentTerms', 'consentAccurate', 'referer', 'reasonCode', 'dealStage', 'expert', 'newPayment', 'newApr', 'savings', 'docID', 'docV5C', 'docBankD', 'docPayslip', 'docSettlement', 'jigsawId', 'oldPayment', 'stageHistory', 'gender', 'drivingLicenceType', 'drivingLicense', 'dependants', 'vehicleCondition', 'vehicleType', 'employmentAddressCity', 'employerAddressLine1', 'employerAddressLine2', 'employerCity', 'employerPostcode', 'previousEmployerAddress2', 'previousEmployerCity', 'previousEmployerPostcode', 'notes1', 'notes1Date', 'notes2', 'notes2Date', 'notes3', 'notes3Date'],

                    READONLY_FIELDS: ['gender', 'drivingLicenceType', 'drivingLicense', 'dependants', 'vehicleCondition', 'vehicleType', 'employmentAddressCity', 'jigsawId'],
                    FIELD_LABEL_MAP: {
                        gender: 'GENDER (auto from Title: Male=1, Female=2)',                        drivingLicenceType: 'DRIVING LICENSE (Full UK = 1)',
                        drivingLicense: 'DRIVING LICENSE (Full UK = 1)',
                        dependants: 'DEPENDANTS (None = 0)',
                        vehicleCondition: 'VEHICLE CONDITION (Used = 0)',
                        vehicleType: 'VEHICLE TYPE (Car = 1)',
                        employmentAddressCity: 'EMPLOYMENT ADDRESS',
                        isRefinance: 'REFINANCE DEAL?'

                        ,previousAddressLine1: 'PREVIOUS ADDRESS LINE 1'
                        ,previousAddressLine2: 'PREVIOUS ADDRESS LINE 2'
                        ,previousCity: 'PREVIOUS ADDRESS CITY'
                        ,previousPostcode: 'PREVIOUS ADDRESS POSTCODE'
                        ,previousResidentialStatus: 'PREVIOUS RESIDENTIAL STATUS'
                        ,previousAddressYears: 'PREVIOUS ADDRESS YEARS'
                        ,previousAddressMonths: 'PREVIOUS ADDRESS MONTHS'
                        ,employerAddressLine1: 'EMPLOYER ADDRESS LINE 1'
                        ,employerAddressLine2: 'EMPLOYER ADDRESS LINE 2'
                        ,employerCity: 'EMPLOYER ADDRESS CITY'
                        ,employerPostcode: 'EMPLOYER ADDRESS POSTCODE'
                        ,previousEmployerName: 'PREVIOUS EMPLOYER NAME'
                        ,previousOccupation: 'PREVIOUS OCCUPATION'
                        ,previousEmploymentYears: 'PREVIOUS EMPLOYMENT YEARS'
                        ,previousEmploymentMonths: 'PREVIOUS EMPLOYMENT MONTHS'
                        ,previousEmployerAddress1: 'PREVIOUS EMPLOYER ADDRESS LINE 1'
                        ,previousEmployerAddress2: 'PREVIOUS EMPLOYER ADDRESS LINE 2'
                        ,previousEmployerCity: 'PREVIOUS EMPLOYER CITY'
                        ,previousEmployerPostcode: 'PREVIOUS EMPLOYER POSTCODE'
                        ,docBankD: 'Doc DirectDebit', jigsawId: 'JIGSAW ID'},
                    FORM_SECTIONS: {
    'Notes': ['notes1','notes1Date','notes2','notes2Date','notes3','notes3Date'],
    'Status': ['dealStage', 'expert', 'referer'],
    'Documents': ['docID', 'docV5C', 'docBankD', 'docSettlement', 'jigsawId'],

    // Deal section directly under Documents
    'Deal': [
        'settlementTotal',   // settlement
        'newPayment',        // new payment
        'oldPayment',        // old payment
        'newApr',            // new APR
        'savings'            // savings
    ,
        'isRefinance'        // refinance (toggle)
    ],

    // Current Finance section directly under Deal
    'Current Finance': [
        'price',             // Car Price Paid (label overridden above)
        'deposit',
        'financeCompany',
        'agreementNumber',
        'currentApr',
        'agreementStartDate',
        'originalTerm',
        'financeType',
        'term',
        'annualMileage',
        'receivedDate'
    ],

    'Personal & Contact': [
        'title', 'firstName', 'lastName', 'email', 'phone', 'dob', 'maritalStatus'
    ],

    'Address': [
        'currentAddressLine1', 'currentAddressLine2', 'currentCity',
        'currentPostcode', 'residentialStatus',
        'currentAddressYears', 'currentAddressMonths'
    ],

    'Employment': [
        'employmentStatus', 'occupation', 'employerName', 'employerPhone',
        'employmentYears', 'employmentMonths', 'monthlyTakeHomePay'
    ],

    // Vehicle Details just above Bank Details
    'Vehicle Details': [
        'vrn', 'vin', 'make', 'model', 'year', 'colour', 'vehicleCurrentMileage'
    ],

    'Bank Details': [
        'bankName', 'accountHolder', 'sortCode',
        'accountNumber', 'bankYears', 'bankMonths'
    ],

    'Consent': [
        'consentMarketing', 'consentTerms', 'consentAccurate'
    ]
,
    'API APPLICATION DATA': [
        'gender',
        'drivingLicense',
        'dependants',
        'vehicleCondition',
        'vehicleType',
        'employmentAddressCity',

        // Previous Address (captured already)
        'previousAddressLine1','previousAddressLine2','previousCity','previousPostcode',
        'previousResidentialStatus','previousAddressYears','previousAddressMonths',

        // Employer Address (capture for API)
        'employerAddressLine1','employerAddressLine2','employerCity','employerPostcode',

        // Previous Employment (captured already)
        'previousEmployerName','previousOccupation','previousEmploymentYears','previousEmploymentMonths',

        // Previous Employer Address (expand for API)
        'previousEmployerAddress1','previousEmployerAddress2','previousEmployerCity','previousEmployerPostcode'
    ]
}
                },
                utils: {

    // Canonicalize deal stage labels so UI/backend can treat Packaging and Underwriting as the same stage.
    // Canonical ID used everywhere: "Packaging" (to match existing backend + kanban stage id).
    // Display title in UI: "Underwriting" (stage.title).
    normalizeDealStage(v) {
        if (v === null || v === undefined) return '';
        const raw = String(v).trim();
        const norm = raw.toLowerCase().replace(/\s+/g,' ').replace(/\//g,' ').trim();
        // common variants/typos
        if (norm === 'underwriting' || norm === 'underwritting' || norm === 'packaging underwriting' || norm === 'packaging underwritting' || norm === 'packaging/underwriting' || norm === 'packaging/underwritting') {
            return 'Packaging';
        }
        if (norm === 'packaging') return 'Packaging';
        return raw;
    },
                    // --- API Application Data helpers (Jigsaw) ---
                    deriveGenderFromTitle(titleRaw) {
                        // Jigsaw Gender enum: Male=1, Female=2
                        if (titleRaw === null || titleRaw === undefined) return '';
                        const t = String(titleRaw).trim().toLowerCase();
                        if (!t) return '';
                        // Handle Title text
                        if (t === 'mr' || t === 'sir') return 1;
                        if (t === 'mrs' || t === 'ms' || t === 'miss' || t === 'madam' || t === 'lady') return 2;
                        // Handle numeric Title enum if used (Mr=1, Mrs=2, Ms=3, Miss=4)
                        if (t === '1') return 1;
                        if (t === '2' || t === '3' || t === '4') return 2;
                        return '';
                    },

                    // Escape potentially unsafe text for HTML (prevents layout breaks & XSS)
                    escapeHtml(str) {
                        if (str === null || str === undefined) return '';
                        return String(str)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    },

                    applyApiAutofillFields(formData, opts = {}) {
                        const fd = formData || {};
                        const updateDom = !!opts.updateDom;

                        // Consent Terms represents FairProcessingNoticeConfirmed - always true
                        fd.consentTerms = true;

                        // Auto fields (refinance-only default behaviour)
                        fd.drivingLicense = 1;           // Full UK Driving Licence (new header)
                        fd.drivingLicenceType = 1;       // Full UK Driving Licence (legacy header)
                        fd.vehicleCondition = 0;         // Used
                        fd.vehicleType = 1;              // Car
                        fd.dependants = 0;               // None
                        if (fd.isRefinance === undefined || fd.isRefinance === null || fd.isRefinance === '') {
                            fd.isRefinance = false;          // User-controlled: default false
                        }

                        // Back-compat aliases: keep both drivingLicense and drivingLicenceType in sync
                        if (!fd.drivingLicense && fd.drivingLicenceType) fd.drivingLicense = fd.drivingLicenceType;
                        if (!fd.drivingLicenceType && fd.drivingLicense) fd.drivingLicenceType = fd.drivingLicense;

                        // Derived fields
                        if (!fd.gender || String(fd.gender).trim() === '') {
                            const g = this.deriveGenderFromTitle(fd.title);
                            if (g) fd.gender = g;
                        }
                        fd.employmentAddressCity = fd.currentCity || fd.employmentAddressCity || '';

                        // Reflect into DOM if requested (for read-only display fields)
                        if (updateDom && typeof getEl === 'function') {
                            const setIfExists = (id, val, type) => {
                                const el = getEl(id);
                                if (!el) return;
                                if (type === 'checkbox') el.checked = !!val;
                                else el.value = (val === undefined || val === null) ? '' : String(val);
                            };
                            setIfExists('gender', fd.gender);
                            setIfExists('drivingLicense', fd.drivingLicenceType);
                            setIfExists('vehicleCondition', fd.vehicleCondition);
                            setIfExists('vehicleType', fd.vehicleType);
                            setIfExists('dependants', fd.dependants);
                            setIfExists('employmentAddressCity', fd.employmentAddressCity);
                            setIfExists('isRefinance', fd.isRefinance, 'checkbox');

                            // Consent terms checkbox should always be checked
                            setIfExists('consentTerms', true, 'checkbox');
                            const cEl = getEl('consentTerms');
                            if (cEl) { cEl.checked = true; cEl.disabled = true; }
                        }
                        return fd;
                    },

                    validateApiApplicationData(formData) {
                        const fd = formData || {};
                        // Gender must be derivable from Title
                        const g = fd.gender || this.deriveGenderFromTitle(fd.title);
                        if (!g) {
                            return { ok: false, message: 'API APPLICATION DATA: Please select a Title (Mr/Mrs/Ms/Miss) so Gender can be derived.' };
                        }
                        return { ok: true };
                    },
                    // Canonical deal identifier resolver (handles legacy column names like "ID")
                    getDealId(d) {
                        if (!d) return '';
                        const candidates = [
                            d.id, d.ID, d.Id,
                            d.dealId, d.dealID, d.DealId, d.DealID,
                            d['deal id'], d['Deal ID'], d['DEAL ID'],
                            d['id'], d['ID']
                        ];
                        for (const c of candidates) {
                            if (c !== null && c !== undefined && String(c).trim() !== '') return String(c).trim();
                        }
                        return '';
                    },
                    getVrn(d) {
                        if (!d) return '';
                        const candidates = [d.vrn, d.VRN, d.Vrn, d.vehicleReg, d.registration];
                        for (const c of candidates) {
                            if (c !== null && c !== undefined && String(c).trim() !== '') {
                                return String(c).toUpperCase().replace(/\s/g,'').trim();
                            }
                        }
                        return '';
                    }
                ,
normalizeDobInput(raw) {
    if (raw === null || raw === undefined) return { ok: true, normalized: '', cleaned: '' };
    let s = String(raw).trim();
    if (!s) return { ok: true, normalized: '', cleaned: '' };

    // Strip ISO time component: 1982-10-14T23:00:00.000Z -> 1982-10-14
    if (/^\d{4}-\d{2}-\d{2}T/.test(s)) s = s.split('T')[0];

    const pad2 = (n) => String(n).padStart(2, '0');
    const isValidYMD = (y, m, d) => {
        const dt = new Date(y, m - 1, d);
        return dt.getFullYear() === y && (dt.getMonth() + 1) === m && dt.getDate() === d;
    };

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [yS, mS, dS] = s.split('-');
        const y = parseInt(yS, 10), m = parseInt(mS, 10), d = parseInt(dS, 10);
        if (!isValidYMD(y, m, d)) return { ok: false, message: 'Please enter a valid Date of Birth.' };
        return { ok: true, normalized: `${pad2(d)}/${pad2(m)}/${y}`, cleaned: s, source: 'ymd' };
    }

    // DD/MM/YYYY or MM/DD/YYYY (1-2 digits allowed)
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
        const a = parseInt(m[1], 10);
        const b = parseInt(m[2], 10);
        const y = parseInt(m[3], 10);

        const ddmmValid = isValidYMD(y, b, a); // day=a, month=b
        const mmddValid = isValidYMD(y, a, b); // month=a, day=b

        // Unambiguous cases: normalise to DD/MM/YYYY
        if (a > 12 && ddmmValid) {
            const out = `${pad2(a)}/${pad2(b)}/${y}`;
            return { ok: true, normalized: out, cleaned: out, source: 'ddmm' };
        }
        if (b > 12 && mmddValid) {
            const out = `${pad2(b)}/${pad2(a)}/${y}`;
            return { ok: true, normalized: out, cleaned: out, source: 'mmdd' };
        }
        if (ddmmValid && !mmddValid) {
            const out = `${pad2(a)}/${pad2(b)}/${y}`;
            return { ok: true, normalized: out, cleaned: out, source: 'ddmm' };
        }
        if (!ddmmValid && mmddValid) {
            const out = `${pad2(b)}/${pad2(a)}/${y}`;
            return { ok: true, normalized: out, cleaned: out, source: 'mmdd' };
        }
        if (ddmmValid && mmddValid) {
            // Ambiguous (e.g. 05/06/1988). Accept as entered without swapping.
            const out = `${pad2(a)}/${pad2(b)}/${y}`;
            return { ok: true, normalized: out, cleaned: out, source: 'ambiguous' };
        }
        return { ok: false, message: 'Please enter a valid Date of Birth.' };
    }

    return { ok: false, message: 'Please enter Date of Birth as DD/MM/YYYY or MM/DD/YYYY.' };
}
                },
                jigsaw: {

                    simpleHash(str) {
                        // FNV-1a 32-bit (fast, deterministic)
                        let h = 0x811c9dc5;
                        for (let i = 0; i < str.length; i++) {
                            h ^= str.charCodeAt(i);
                            h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
                        }
                        return ('00000000' + h.toString(16)).slice(-8);
                    },
                    makeReferrerRef({ dealId, vrn }) {
                        let base = String(dealId || vrn || '').trim();
                        if (!base) {
                            base = (Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 10)).toUpperCase();
                        }
                        // Jigsaw requires ReferrerRef max length 40 and unique in your system.
                        // If too long, keep a stable prefix + hash to preserve uniqueness.
                        if (base.length > 40) {
                            const h = this.simpleHash(base);
                            base = (base.slice(0, 32) + '-' + h.slice(0, 7));
                        }
                        return base.slice(0, 40);
                    },
buildDraft({ dealId, deal, formData }) {
                        const vrn = (formData && formData.vrn) ? String(formData.vrn).trim() : (deal && deal.vrn ? String(deal.vrn).trim() : '');
                        const ref = this.makeReferrerRef({ dealId, vrn });
                        return {
                            ReferrerRef: ref,
                            _meta: {
                                source: 'CMF CRM',
                                env: (App.config && App.config.JIGSAW && App.config.JIGSAW.ENV) ? App.config.JIGSAW.ENV : 'UAT',
                                createdAt: new Date().toISOString()
                            },
                            CMF: {
                                dealId: String(dealId || '').trim(),
                                vrn: vrn,
                                formData: formData || {},
                                dealSnapshot: deal || null
                            }
                        };
                    },
                    cacheDraft(draft) {
                        try {
                            const key = 'cmf_jigsaw_drafts';
                            const existing = JSON.parse(localStorage.getItem(key) || '[]');
                            existing.unshift(draft);
                            localStorage.setItem(key, JSON.stringify(existing.slice(0, 50)));
                        } catch (e) { /* ignore */ }
                        try { window.__lastJigsawDraft = draft; } catch (e) { /* ignore */ }
                    },
                    formatWhen(iso) {
                        if (!iso) return '—';
                        try {
                            const d = new Date(iso);
                            if (isNaN(d.getTime())) return '—';
                            return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        } catch (e) { return '—'; }
                    },
                    setHeaderPanel({ badgeText, state, ref, lastAt, detail } = {}) {
                        const badge = getEl('jigsawHeaderBadge');
                        if (!badge) return; // header panel removed from pipeline view
                        const refEl = getEl('jigsawHeaderRef');
                        const lastEl = getEl('jigsawHeaderLastAt');
                        const detailRow = getEl('jigsawHeaderDetailRow');
                        const detailEl = getEl('jigsawHeaderDetail');
                        if (badge && badgeText !== undefined) badge.textContent = badgeText || 'Not sent';

                        if (badge) {
                            // reset badge classes
                            badge.classList.remove('bg-gray-200','text-gray-700','bg-yellow-100','text-yellow-800','bg-green-100','text-green-800','bg-red-100','text-red-800','bg-blue-100','text-blue-800');
                            if (state === 'sent') badge.classList.add('bg-green-100','text-green-800');
                            else if (state === 'draft' || state === 'pending') badge.classList.add('bg-yellow-100','text-yellow-800');
                            else if (state === 'error') badge.classList.add('bg-red-100','text-red-800');
                            else if (state === 'validated') badge.classList.add('bg-blue-100','text-blue-800');
                            else badge.classList.add('bg-gray-200','text-gray-700');
                        }

                        if (refEl && ref !== undefined) refEl.textContent = (ref && String(ref).trim() !== '') ? String(ref).trim() : '—';
                        if (lastEl && lastAt !== undefined) lastEl.textContent = (lastAt && String(lastAt).trim() !== '') ? String(lastAt).trim() : '—';

                        if (detailEl && detailRow) {
                            if (detail && String(detail).trim() !== '') {
                                detailEl.textContent = String(detail).trim();
                                detailRow.classList.remove('hidden');
                            } else {
                                detailEl.textContent = '';
                                detailRow.classList.add('hidden');
                            }
                        }
                    },
                    setStatus(text, state) {
                        const el = getEl('jigsawStatusText');
                        if (!el) return;
                        el.textContent = text || 'Not sent';
                        el.classList.remove('text-gray-700', 'text-yellow-700', 'text-green-700', 'text-red-700', 'text-blue-700');
                        if (state === 'sent') el.classList.add('text-green-700');
                        else if (state === 'draft' || state === 'pending') el.classList.add('text-yellow-700');
                        else if (state === 'error') el.classList.add('text-red-700');
                        else if (state === 'validated') el.classList.add('text-blue-700');
                        else el.classList.add('text-gray-700');
                    },
                    updateStatusFromDeal(deal) {
                        if (!deal) {
                            this.setStatus('Not sent', '');
                            if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Not sent', state: '', ref: '—', lastAt: '—', detail: '' });
                            return;
                        }

                        const ref = deal.jigsawReference || deal.JigsawReference || deal.jigsawId || deal.JigsawId;
                        const status = deal.jigsawStatus || deal.JigsawStatus || '';
                        const vStatus = deal.jigsawValidationStatus || deal.JigsawValidationStatus || '';
                        const sentAt = deal.jigsawLastSentAt || deal.JigsawLastSentAt || '';
                        const validatedAt = deal.jigsawLastValidatedAt || deal.JigsawLastValidatedAt || '';
                        const detail = deal.jigsawLastResponseMessage || deal.JigsawLastResponseMessage || '';

                        if (ref) {
                            this.setStatus(`Sent (Ref: ${ref})`, 'sent');
                            if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Sent', state: 'sent', ref: String(ref), lastAt: this.formatWhen(sentAt), detail });
                            return;
                        }

                        // Prefer validation status when present
                        if (vStatus) {
                            const vs = String(vStatus).toLowerCase();
                            if (vs.includes('ok') || vs.includes('valid')) {
                                this.setStatus('Validated (OK)', 'validated');
                                if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Validated', state: 'validated', ref: '—', lastAt: this.formatWhen(validatedAt), detail: detail || 'Validated OK' });
                            } else if (vs.includes('draft')) {
                                this.setStatus('Draft prepared', 'draft');
                                if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Draft prepared', state: 'draft', ref: '—', lastAt: this.formatWhen(validatedAt || sentAt), detail });
                            } else {
                                this.setStatus('Validation failed', 'error');
                                if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Validation failed', state: 'error', ref: '—', lastAt: this.formatWhen(validatedAt), detail });
                            }
                            return;
                        }

                        // Fallback to general status
                        const st = String(status).toLowerCase();
                        if (st.includes('draft')) {
                            this.setStatus('Draft prepared', 'draft');
                            if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Draft prepared', state: 'draft', ref: '—', lastAt: this.formatWhen(sentAt || validatedAt), detail });
                            return;
                        }
                        if (st.includes('fail') || st.includes('error')) {
                            this.setStatus('Failed', 'error');
                            if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Failed', state: 'error', ref: '—', lastAt: this.formatWhen(sentAt || validatedAt), detail });
                            return;
                        }

                        this.setStatus('Not sent', '');
                        if (typeof this.setHeaderPanel === 'function') this.setHeaderPanel({ badgeText: 'Not sent', state: '', ref: '—', lastAt: '—', detail });
                    }
                },
                carMoney: {
                    setStatus(text, state) {
                        const el = getEl('carMoneyStatusText');
                        if (!el) return;
                        el.textContent = text || 'Not sent';
                        el.classList.remove('text-gray-700', 'text-yellow-700', 'text-green-700', 'text-red-700');
                        if (state === 'sent') el.classList.add('text-green-700');
                        else if (state === 'draft' || state === 'pending') el.classList.add('text-yellow-700');
                        else if (state === 'error') el.classList.add('text-red-700');
                        else el.classList.add('text-gray-700');
                    },
                    updateStatusFromDeal(deal) {
                        if (!deal) return this.setStatus('Not sent', '');
                        const ref = deal.carMoneyReference || deal.CarMoneyReference || deal.carMoneyId || deal.CarMoneyId;
                        const status = deal.carMoneyStatus || deal.CarMoneyStatus;
                        if (ref) return this.setStatus(`Sent (Ref: ${ref})`, 'sent');
                        if (status && String(status).toLowerCase().includes('draft')) return this.setStatus('Draft prepared', 'draft');
                        return this.setStatus('Not sent', '');
                    }
                },
                cf247: {
                    setStatus(text, state) {
                        const el = getEl('cf247StatusText');
                        if (!el) return;
                        el.textContent = text || 'Not sent';
                        el.classList.remove('text-gray-700', 'text-yellow-700', 'text-green-700', 'text-red-700');
                        if (state === 'sent') el.classList.add('text-green-700');
                        else if (state === 'draft' || state === 'pending') el.classList.add('text-yellow-700');
                        else if (state === 'error') el.classList.add('text-red-700');
                        else el.classList.add('text-gray-700');
                    },
                    updateStatusFromDeal(deal) {
                        if (!deal) return this.setStatus('Not sent', '');
                        const ref = deal.cf247Reference || deal.CF247Reference || deal.cf247Id || deal.CF247Id;
                        const status = deal.cf247Status || deal.CF247Status;
                        if (ref) return this.setStatus(`Sent (Ref: ${ref})`, 'sent');
                        if (status && String(status).toLowerCase().includes('draft')) return this.setStatus('Draft prepared', 'draft');
                        return this.setStatus('Not sent', '');
                    }
                },
                elements: {},
                init() {
                    const elementIds = { pageTitle: 'pageTitle', kanbanBoard: 'kanban-board', contactsList: 'contacts-list', contactSearch: 'contactSearch', manageStagesModal: 'manageStagesModal', customerModal: 'customerModal', confirmModal: 'confirmModal', duplicateModal: 'duplicateModal', importFile: 'importFile', fileName: 'fileName', statusMessage: 'status-message', importButton: 'importButton', exportButton: 'exportButton', customerForm: 'customerForm', dealId: 'dealId', modalTitle: 'modalTitle', deleteDealBtn: 'deleteDealBtn', connectionStatusIcon: 'connection-status-icon', connectionStatusText: 'connection-status-text',  surnameSearch: 'surnameSearch', expertSearch: 'expertSearch', sendJigsawBtn: 'sendJigsawBtn', sendCarMoneyBtn: 'sendCarMoneyBtn', sendCF247Btn: 'sendCF247Btn', jigsawStatusText: 'jigsawStatusText', carMoneyStatusText: 'carMoneyStatusText', cf247StatusText: 'cf247StatusText',};
                    for (const key in elementIds) this.elements[key] = getEl(elementIds[key]);
                    this.elements.navTabs = $$('.nav-tab');
                    this.elements.views = $$('.view');
                    this.elements.titleAndButtonsWrapper = getEl('title-and-buttons-wrapper');
                    this.ui.buildCustomerForm();
                    this.elements.dealStage = getEl('dealStage');
                    this.bindEvents(); this.loadData(); this.ui.switchView('pipeline');
                    this.ui.injectSortControls(); this.ui.syncSortControls(); this.ui.updateConnectionStatus('checking');
                },
                bindEvents() {
                    const debounce = (func, delay) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => func.apply(this, args), delay); }; };
                    this.elements.navTabs.forEach(tab => on(tab, 'click', () => { this.ui.switchView(tab.dataset.view); this.loadData(); }));
                    on(getEl('addStageBtn'), 'click', () => this.ui.addStageInput());
                    on(getEl('saveStages'), 'click', () => this.handlers.saveStages());
                    on(getEl('cancelStages'), 'click', () => this.ui.closeModal('manageStages'));
                    on(getEl('closeCustomerModal'), 'click', () => this.ui.closeModal('customer'));
                    on(getEl('saveDealBtn'), 'click', () => this.elements.customerForm.dispatchEvent(new Event('submit', { bubbles: true })));
                    on(getEl('sendJigsawBtn'), 'click', () => this.handlers.sendJigsaw());
                    on(getEl('validateJigsawBtn'), 'click', () => this.handlers.validateJigsaw());
                    on(getEl('sendCarMoneyBtn'), 'click', () => this.handlers.sendCarMoney());
                    on(getEl('sendCF247Btn'), 'click', () => this.handlers.sendCF247());
                    // DOB helper: normalise on blur (accepts DD/MM/YYYY, MM/DD/YYYY, and ISO timestamps)
                    const dobEl = getEl('dob');
                    if (dobEl) {
                        on(dobEl, 'blur', () => {
                            const r = (App.utils && typeof App.utils.normalizeDobInput === 'function')
                                ? App.utils.normalizeDobInput(dobEl.value || '')
                                : { ok: true, normalized: (dobEl.value || '').trim() };
                            if (r && r.ok && r.normalized) dobEl.value = r.normalized;
                        });
                    }
                    on(this.elements.customerForm, 'submit', (e) => this.handlers.saveDeal(e));
                    on(this.elements.deleteDealBtn, 'click', () => this.handlers.deleteDeal());
                    on(this.elements.importFile, 'change', (e) => this.handlers.handleFileSelect(e));
                    on(this.elements.importButton, 'click', () => this.handlers.processImport());
                    on(this.elements.exportButton, 'click', () => this.handlers.exportData());
                    on(getEl('confirmCancel'), 'click', () => this.ui.closeModal('confirm'));
                    on(getEl('cancelDuplicate'), 'click', () => this.ui.closeModal('duplicate'));
                    on(getEl('confirmDuplicate'), 'click', () => this.handlers.importDeals(false));
                    on(getEl('importAllBtn'), 'click', () => this.handlers.importDeals(true));
                    on(getEl('select-all-contacts'), 'change', (e) => this.handlers.toggleSelectAllContacts(e.target.checked));
                    on(getEl('delete-selected-btn'), 'click', () => this.handlers.deleteSelectedContacts());
                    on(this.elements.contactSearch, 'input', debounce((e) => this.handlers.searchContacts(e.target.value), 300));
                    on(this.elements.surnameSearch, 'input', debounce((e) => this.handlers.searchSurname(e.target.value), 300));
                    if (this.elements.expertSearch) {
                        on(this.elements.expertSearch, 'input', debounce((e) => this.handlers.searchExpert(e.target.value), 300));
                    }
                    on(document, 'keydown', (e) => { if (e.key === 'Escape') this.ui.closeAllModals(); });
                },
                async apiCall(method, data = {}) {

                  // Unified API call that supports Apps Script hosting (google.script.run) and local/desktop (fetch)

                  const action = (String(method||'').toUpperCase().startsWith('GET')) ? 'getDelta' : (data && data.action ? data.action : 'unknown');

                  const payload = (String(method||'').toUpperCase().startsWith('GET'))
                    ? {}
                    : (
                        (data && typeof data === 'object' && data.payload != null) ? data.payload
                        : (
                            (data && typeof data === 'object') ? (() => {
                              const copy = { ...(data || {}) };
                              try { delete copy.action; } catch(e) {}
                              return copy;
                            })()
                            : {}
                          )
                      );

                  console.log('API Call:', action, payload);


                  // If running inside Apps Script HTML Service, prefer google.script.run (no fetch, no CORS)

                  if (typeof google !== 'undefined' && google.script && google.script.run) {

                    return new Promise((resolve, reject) => {

                      let _payload = payload || {};
                      
                      // --- Attach CMF auth token automatically (single token system) ---
                      try {
                        const t = (window.localStorage && localStorage.getItem('CMF_AUTH_TOKEN')) || '';
                        if (t && _payload && typeof _payload === 'object' && !_payload.token) _payload.token = t;
                      } catch(e) {}
// Normalize payload shapes for certain actions
                      if (action === 'getFolderFiles') {

                        if (typeof _payload === 'string') _payload = { folderId: _payload };                        if (_payload && !_payload.folderId) {
                          _payload = { ..._payload, folderId: (_payload.folderId || _payload.id || _payload.folder_id || _payload.driveFolderId ||
                            (typeof _payload.folder === 'string' ? _payload.folder : (_payload.folder && (_payload.folder.id || _payload.folder.folderId || _payload.folder.driveFolderId))) ||
                            (_payload.selectedFolder && (_payload.selectedFolder.id || _payload.selectedFolder.folderId || _payload.selectedFolder.driveFolderId)) ||
                            (_payload.node && (_payload.node.id || _payload.node.folderId || _payload.node.driveFolderId))
                          ) };
                        }
                      }

                      // Attach auth token to every request except authLogin/authStatus
                        try {
                          const token = (action !== 'authLogin') ? (localStorage.getItem('CMF_AUTH_TOKEN') || '') : '';
                          if (token && _payload && typeof _payload === 'object') _payload.token = token;
                        } catch(e) {}
                        const request = { action: action, payload: _payload || {} };

                      google.script.run

                        .withSuccessHandler((response) => {

                          try {

                            const dataObj = (typeof response === 'string') ? JSON.parse(response) : response;

                            
                            if (dataObj === null || typeof dataObj === 'undefined') { reject(new Error('Null/undefined response from server')); return; }
if (dataObj && dataObj.success === false) {

                              // If auth required, show login screen and reject
                              try {
                                if (window.__cmfHandleAuthRequired && window.__cmfHandleAuthRequired(dataObj)) {
                                  reject(new Error('AUTH_REQUIRED'));
                                  return;
                                }
                              } catch(e) {}

                              console.error('API Error:', dataObj.error, dataObj);

                              reject(new Error(dataObj.error || 'Server error'));

                            } else {

                              resolve(dataObj);

                            }

                          } catch (e) {

                            reject(e);

                          }

                        })

                        .withFailureHandler((err) => {

                          console.error('Google Script Run Error:', err);

                          // err can be string or object

                          const msg = (err && err.message) ? err.message : String(err);

                          reject(new Error(msg));

                        })

                        .handleWebClientRequest(request);

                    });

                  }


                  // Fallback: fetch (desktop/local testing)

                  const endpoint = (CONFIG && CONFIG.ENDPOINTS && CONFIG.ENDPOINTS.CRM) ? CONFIG.ENDPOINTS.CRM : (window.CMF_SELF_URL || '');

                  if (!endpoint) throw new Error('Missing CONFIG.ENDPOINTS.CRM');


                  if (method === 'GET') {

                    const r = await fetch(endpoint + '?api=1', { method: 'GET' });

                    return await r.json();

                  }


                  const r = await fetch(endpoint, {

                    method: 'POST',

                    body: JSON.stringify({ action, payload }),

                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }

                  });

                  const out = await r.json();

                  if (out && out.success === false) throw new Error(out.error || 'Server error');

                  return out;

                },

                async loadData() {
                    showNavMessage("Loading data from server...", "info", 2000);
                    const _loadStartedAt = (window.performance && performance.now ? performance.now() : Date.now());
                    const _raw = await this.apiCall('GET');
                    // Backend may return an array directly, or wrap it in an object.
                    const data = Array.isArray(_raw) ? _raw
                        : (_raw && Array.isArray(_raw.data)) ? _raw.data
                        : (_raw && _raw.data && Array.isArray(_raw.data.data)) ? _raw.data.data
                        : (_raw && Array.isArray(_raw.deals)) ? _raw.deals
                        : (_raw && Array.isArray(_raw.values)) ? _raw.values
                        : (_raw && Array.isArray(_raw.result)) ? _raw.result
                        : (_raw && _raw.data && Array.isArray(_raw.data.values)) ? _raw.data.values
                        : null;
                                        if (data && Array.isArray(data)) {
                        const toCamel = s => s.toString().replace(/([-_\s][a-z])/ig, ($1) => $1.toUpperCase().replace(/[-_\s]/g, ''));

                        // 1) Map all rows into clean objects FIRST (no dedupe inside the loop)
                        let mappedDeals = data.map(deal => {
                            const mapped = Object.keys(deal).reduce((acc, key) => ({ ...acc,
                                [(String(key||'').toLowerCase().replace(/[\s_\-]/g,'')==='jigsawid') ? 'jigsawId' : toCamel(key)]: deal[key]
                            }), {});

                            // Canonical ID
                            const canonicalId = (mapped.id ?? mapped.ID ?? mapped.Id ?? mapped.dealId ?? mapped.dealID ?? mapped.DealId ?? mapped.DealID);
                            if (canonicalId !== null && canonicalId !== undefined && String(canonicalId).trim() !== '') mapped.id = String(canonicalId).trim();

                            // Canonical VRN
                            const canonicalVrn = (mapped.vrn ?? mapped.VRN ?? mapped.Vrn ?? mapped.vehicleReg ?? mapped.registration);
                            if (canonicalVrn !== null && canonicalVrn !== undefined && String(canonicalVrn).trim() !== '') {
                                mapped.vrn = String(canonicalVrn).toUpperCase().replace(/\s/g,'').trim();
                            }

                            // Aliasing
                            if (mapped.docBankD === undefined) {
                                const _pv = (mapped.docBankD ?? mapped['docBankD'] ?? mapped.docbankd ?? mapped.cbPackagers ?? mapped['CB-Packagers']);
                                if (_pv !== undefined) mapped.docBankD = _pv;
                            }

                            // Stage normalization
                            if (mapped.dealStage !== undefined && mapped.dealStage !== null) {
                                const _ds = String(mapped.dealStage).trim();
                                mapped.dealStage = App.utils.normalizeDealStage(_ds) || mapped.dealStage;
                            }

                            return mapped;
                        });

                        // 2) Deduplicate ONCE across the full mapped list (prevents Kanban duplicates on refresh)
                        try {
                            const seen = new Map(); // key -> deal
                            const dupes = [];

                            const keyFor = (d) => {
                                const k = (App.utils && typeof App.utils.getDealId === 'function') ? App.utils.getDealId(d) : (d && d.id);
                                const v = (App.utils && typeof App.utils.getVrn === 'function') ? App.utils.getVrn(d) : (d && d.vrn);
                                const s = (d && (d.sourceSheet ?? d.SourceSheet ?? d.sourcesheet)) || '';
                                return String(k || v || d.id || s || '').trim();
                            };

                            const score = (d) => {
                                const t = Date.parse(d.updatedAt || d.lastUpdated || d.modifiedAt || d.ModifiedAt || '') || 0;
                                const h = Array.isArray(d.stageHistory) ? d.stageHistory.length : 0;
                                return (t * 10) + h;
                            };

                            for (const d of mappedDeals) {
                                const k = keyFor(d);
                                if (!k) { dupes.push(d); continue; }
                                if (!seen.has(k)) {
                                    seen.set(k, d);
                                } else {
                                    const existing = seen.get(k);
                                    if (score(d) >= score(existing)) {
                                        dupes.push(existing);
                                        seen.set(k, d);
                                    } else {
                                        dupes.push(d);
                                    }
                                }
                            }

                            this.state.parsedDeals = {
                                unique: Array.from(seen.values()),
                                duplicates: dupes
                            };
                            this.state.deals = this.state.parsedDeals.unique;
                        } catch (e) {
                            console.warn('De-dupe failed; using raw mapped list', e);
                            this.state.deals = mappedDeals;
                        }
                        // Keep a snapshot of server state on each deal so we can delta-save later.
                        try {
                            (this.state.deals || []).forEach(d => {
                                if (!d || typeof d !== 'object') return;
                                const snap = (() => {
                                    try { return structuredClone(d); } catch (e) {
                                        try { return JSON.parse(JSON.stringify(d)); } catch (e2) { return { ...(d || {}) }; }
                                    }
                                })();
                                try { Object.keys(snap || {}).forEach(k => { if (String(k).startsWith('_')) delete snap[k]; }); } catch (e) {}
                                d._serverSnapshot = snap;
                            });
                        } catch (e) { /* non-fatal */ }


                        showNavMessage(`Data OK (${this.state.deals.length} deals, ${Math.round((window.performance && performance.now ? performance.now() : Date.now()) - _loadStartedAt)}ms)`, "success", 5000);
                    } else {
                        console.error('Load failed (no valid array). Raw response was:', _raw);
                        showNavMessage("Failed to load or parse data from server (no valid array).", "error", 7000);
                        this.state.deals = [];
                    }

                    this.render.all();
                },
                handlers: {

                        openDrivePreview(url) {
                            try {
                                const u = String(url || '').trim();
                                // Only iframe embeddable preview URLs should go into the preview frame.
                                // For anything else (folders, drive home, docs edit links), open in a new tab.
                                const isPreview = /\/file\/d\//.test(u) && /\/preview(\?|$)/.test(u);
                                if (!isPreview) {
                                    window.open(u || 'about:blank', '_blank');
                                    return;
                                }
                                const frame = document.getElementById('drive-preview-frame');
                                const placeholder = document.getElementById('drive-placeholder');
                                if (frame) frame.src = u;
                                if (placeholder) placeholder.style.display = 'none';
                            } catch (e) {
                                console.error('openDrivePreview failed', e);
                            }
                        },


                        // Ensure API autofill fields are set on the deal object and written back to the source sheet.
                        ensureApiFieldsOnOpen(deal) {
                            try {
                                if (!deal) return;
                                const before = {};
                                const keys = ['dependants','vehicleType','vehicleCondition','drivingLicense','drivingLicenceType','gender','employmentAddressCity','consentTerms'];
                                const norm = (v) => {
                                    if (v === null || v === undefined) return '';
                                    if (typeof v === 'boolean') return v ? 'true' : 'false';
                                    return String(v).trim();
                                };
                                keys.forEach(k => before[k] = norm(deal[k]));

                                // Apply defaults/derivations (mutates deal)
                                if (App.utils && typeof App.utils.applyApiAutofillFields === 'function') {
                                    App.utils.applyApiAutofillFields(deal, { updateDom: false });
                                }

                                // Ensure drivingLicense/drivingLicenceType are aligned on the object
                                if (!deal.drivingLicense && deal.drivingLicenceType) deal.drivingLicense = deal.drivingLicenceType;
                                if (!deal.drivingLicenceType && deal.drivingLicense) deal.drivingLicenceType = deal.drivingLicense;

                                const after = {};
                                keys.forEach(k => after[k] = norm(deal[k]));
                                const changed = keys.some(k => before[k] !== after[k]);

                                if (changed) {
                                    // Persist silently (so opening a modal doesn't spam UI)
                                    SaveManager.saveDeal(deal, { silent: true, reason: 'apiAutofillOnOpen' })
                                        .catch(() => { /* non-fatal */ });
                                }
                            } catch (e) {
                                console.warn('ensureApiFieldsOnOpen failed:', e);
                            }
                        },

inlineEdit(input) {
    // This is a helper hook for the onblur event
    // Currently acts as a placeholder to prevent errors,
    // but ensures the 'change' event fires correctly.
    input.dispatchEvent(new Event('change', { bubbles: true }));
},

setupNotesAutoDate() {
    const pad = (n) => String(n).padStart(2, '0');

    // For <input type="date"> the value MUST be YYYY-MM-DD.
    const stampISO = () => {
        const d = new Date();
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    };

    // For plain text date fields (fallback), use DD/MM/YYYY.
    const stampUK = () => {
        const d = new Date();
        return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
    };

    for (let i = 1; i <= 3; i++) {
        const noteEl = getEl(`notes${i}`);
        const dateEl = getEl(`notes${i}Date`);
        if (!noteEl || !dateEl) continue;

        // Prevent duplicate listeners on repeated modal opens / re-renders.
        if (noteEl.dataset.notesAutoDateWired === '1') continue;
        noteEl.dataset.notesAutoDateWired = '1';

        const mark = () => {
            if (App.state._isPopulatingForm) return;

            // If note is emptied, clear the date; otherwise set today's date.
            const hasText = String(noteEl.value || '').trim().length > 0;
            if (!hasText) {
                dateEl.value = '';
                return;
            }

            dateEl.value = (dateEl.type === 'date') ? stampISO() : stampUK();
        };

        noteEl.addEventListener('input', mark);
        noteEl.addEventListener('change', mark);
    }
},

searchSurname(term) {
    App.state.surnameFilter = (term || '').toLowerCase().trim();
    App.render.board();
},
searchExpert(term) {
    App.state.expertFilter = (term || '').toLowerCase().trim();
    App.render.board();
},

saveStages() {
                        const newStages = Array.from($$('#stage-list .stage-item')).map(item => {
                            const rawId = item.dataset.id;
                            const rawTitle = item.querySelector('input').value;
                            const canonicalId = App.utils.normalizeDealStage(rawId) || rawId;
                            // Force the shared stage to display as "Underwriting" in the UI
                            const title = (canonicalId === 'Packaging') ? 'Underwriting' : rawTitle;
                            return { id: canonicalId, title };
                        });
                        App.state.stages = [...App.state.stages.filter(s => s.isProtected), ...newStages]
                            // De-dupe stages by id (prevents both Packaging and Underwriting appearing)
                            .reduce((acc, s) => {
                                const existing = acc.find(x => x.id === s.id);
                                if (existing) {
                                    existing.title = existing.title || s.title;
                                } else {
                                    acc.push(s);
                                }
                                return acc;
                            }, []);
                        App.render.board(); showNavMessage("Stages updated for this session.", "success"); App.ui.closeModal('manageStages');
            },
                    async saveDeal(e) {
                        e.preventDefault();
                        const dealId = App.elements.dealId.value;
                        const deal = dealId ? (App.state.deals.find(d => String(App.utils.getDealId(d)) === String(dealId)) || null) : null;
                        const formData = App.ui.getFormData();

                        // === SAFETY (A): block saves if modal was not hydrated ===
                        if (dealId && App.state && App.state.customerModalHydrated === false) {
                            showNavMessage('Cannot save: application data did not load. Close the modal and re-open the client card.', 'error', 8000);
                            return;
                        }

                        // === SAFETY (C): block destructive blank-overwrite on existing deals ===
                        if (dealId) {
                            const meaningfulKeys = Object.keys(formData || {}).filter((k) => {
                                if (!k) return false;
                                const ignore = new Set(['id','createdAt','updatedAt','lastUpdated','timestamp','_row','row','sheetRow','dealId']);
                                if (ignore.has(k)) return false;
                                const v = formData[k];
                                if (v === null || v === undefined) return false;
                                if (typeof v === 'string') return v.trim() !== '';
                                if (typeof v === 'number') return !Number.isNaN(v);
                                if (typeof v === 'boolean') return true;
                                if (Array.isArray(v)) return v.length > 0;
                                return true;
                            });
                            if (meaningfulKeys.length < 5) {
                                showNavMessage('Save blocked: the application form is mostly empty. This would overwrite existing client data with blanks. Close the modal and re-open the deal.', 'error', 10000);
                                return;
                            }
                        }

                        App.utils.applyApiAutofillFields(formData, { updateDom: true });
                        const apiCheck = App.utils.validateApiApplicationData(formData);
                        if (!apiCheck.ok) {
                            showNavMessage(`${apiCheck.message} (You can still save; Jigsaw Validate/Send will require this.)`, 'warning', 6000);
                        }

// Build the deal object the backend expects (mapping to JigsawReferral happens server-side)
                        const payloadDeal = Object.assign({}, (deal || {}), (formData || {}));
                        payloadDeal.id = String(dealId || payloadDeal.id || '').trim();
                        if (payloadDeal.vrn) payloadDeal.vrn = String(payloadDeal.vrn).toUpperCase().replace(/\s/g, '').trim();
                        // Backward compatibility for stage rename
                        if (payloadDeal.dealStage) { payloadDeal.dealStage = App.utils.normalizeDealStage(payloadDeal.dealStage) || payloadDeal.dealStage; }

// DOB: accept DD/MM/YYYY (UK), MM/DD/YYYY (US), and ISO (YYYY-MM-DD or YYYY-MM-DDTHH:mm:ssZ). Normalise to DD/MM/YYYY.
const dobCheck = (App.utils && typeof App.utils.normalizeDobInput === 'function')
    ? App.utils.normalizeDobInput(formData.dob || '')
    : { ok: true, normalized: (formData.dob || '').trim() };

if (!dobCheck.ok) {
    showNavMessage(dobCheck.message || "Please enter a valid Date of Birth.", "error");
    return;
}
if (dobCheck.normalized) {
    formData.dob = dobCheck.normalized;
    const dobEl = getEl('dob');
    if (dobEl) dobEl.value = dobCheck.normalized;
}

let dealToSave;
                        if (dealId) {
                            const existing = App.state.deals.find(d => String(App.utils.getDealId(d)) === String(dealId));
                            if (existing) {
                                dealToSave = { ...existing, ...formData, id: String(dealId), dealStage: formData.dealStage, value: parseInt(formData.settlementTotal) || 0 };
                                if (existing.dealStage !== formData.dealStage) dealToSave.stageHistory = [...(existing.stageHistory || []), { dealStage: formData.dealStage, date: new Date().toISOString() }];
                            }
                        } else {
                            if (!formData.vrn) return showNavMessage("VRN is required for a new deal.", "error");
                            const stage = formData.dealStage || App.config.CONTACT_STAGE_ID;
                            dealToSave = { ...formData, id: formData.vrn, dealStage: stage, value: parseInt(formData.settlementTotal) || 0, receivedDate: new Date().toISOString().split('T')[0], stageHistory: [{ dealStage: stage, date: new Date().toISOString() }] };
                        }
                        if (dealToSave) {
                            const _saveBtn = getEl('saveDealBtn');
                            const _origBtnHtml = _saveBtn ? _saveBtn.innerHTML : '';
                            const _setSaving = (isSaving) => {
                                if (_saveBtn) {
                                    _saveBtn.disabled = !!isSaving;
                                    if (isSaving) {
                                        _saveBtn.classList.add('opacity-60', 'pointer-events-none');
                                        _saveBtn.innerHTML = `<span class="inline-flex items-center gap-2">Saving...</span>`;
                                    } else {
                                        _saveBtn.classList.remove('opacity-60', 'pointer-events-none');
                                        _saveBtn.innerHTML = _origBtnHtml;
                                    }
                                }
                                if (App.elements.customerForm) {
                                    if (isSaving) {
                                        App.elements.customerForm.classList.add('opacity-70', 'pointer-events-none');
                                    } else {
                                        App.elements.customerForm.classList.remove('opacity-70', 'pointer-events-none');
                                    }
                                }

                                // Global overlay spinner while saving (blocks UI + dims background)
                                const _overlay = getEl('saveDealOverlay');
                                if (_overlay) _overlay.classList.toggle('hidden', !isSaving);
                            };

                            _setSaving(true);
                            try {
                                showNavMessage(dealId ? "Updating deal..." : "Adding deal...", "info");
                                const result = await SaveManager.saveDeal(dealToSave);
                                if (result && result.success) {
                                    showNavMessage(dealId ? "Deal updated!" : "Deal added!", "success");
                                    await App.loadData();
                                    App.ui.closeModal('customer');
                                }
                            } catch (err) {
                                console.error(err);
                                showNavMessage(`Save failed: ${err && err.message ? err.message : err}`, 'error', 6000);
                            } finally {
                                _setSaving(false);
                            }
                        }
                    },
                    async sendJigsaw() {
                        const dealId = App.elements.dealId.value;
                        if (!dealId) return showNavMessage("Please save the deal before sending to Jigsaw.", "error");
                        const deal = App.state.deals.find(d => String(App.utils.getDealId(d)) === String(dealId)) || null;
                        const formData = App.ui.getFormData();
                        const draft = App.jigsaw.buildDraft({ dealId, deal, formData });
                        App.utils.applyApiAutofillFields(formData, { updateDom: true });
                        const apiCheck = App.utils.validateApiApplicationData(formData);
                        if (!apiCheck.ok) return showNavMessage(apiCheck.message, 'error');

                        // Build the deal object the backend expects (mapping to JigsawReferral happens server-side)
                        const payloadDeal = Object.assign({}, (deal || {}), (formData || {}));
                        payloadDeal.id = String(dealId || payloadDeal.id || '').trim();
                        if (payloadDeal.vrn) payloadDeal.vrn = String(payloadDeal.vrn).toUpperCase().replace(/\s/g, '').trim();
                        // Backward compatibility for stage rename
                        if (payloadDeal.dealStage) { payloadDeal.dealStage = App.utils.normalizeDealStage(payloadDeal.dealStage) || payloadDeal.dealStage; }

// Option A: ensure the backend receives the full applicant bank details in a canonical structure
if (typeof applyBankAccountToJigsawPayloadDeal === 'function') {
    applyBankAccountToJigsawPayloadDeal(payloadDeal, formData);
}
                        App.ui.showConfirmModal('SEND TO JIGSAW?', 'This will submit the full application to Jigsaw (once backend is enabled).', async () => {
                            const btn = getEl('sendJigsawBtn');
                            const origHtml = btn ? btn.innerHTML : '';
                            const setBusy = (busy) => {
                                if (!btn) return;
                                btn.disabled = !!busy;
                                if (busy) {
                                    btn.classList.add('opacity-60', 'pointer-events-none');
                                    btn.innerHTML = 'Sending...';
                                } else {
                                    btn.classList.remove('opacity-60', 'pointer-events-none');
                                    btn.innerHTML = origHtml;
                                }
                            };

                            setBusy(true);
                            App.jigsaw.setStatus('Sending…', 'pending');

                            if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                App.jigsaw.setHeaderPanel({ badgeText: 'Sending…', state: 'pending', detail: 'Submitting via backend…' });
                            }

                            try {
                                if (!App.config || !App.config.JIGSAW || !App.config.JIGSAW.ENABLED) {
                                    App.jigsaw.cacheDraft(draft);
                                    App.jigsaw.setStatus('Draft prepared', 'draft');
                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Draft prepared', state: 'draft', detail: 'Backend not enabled yet (draft saved).' });
                                    }
                                    if (deal) {
                                        deal.jigsawStatus = 'Draft';
                                        deal.jigsawLastResponseMessage = 'Backend not enabled (draft saved).';
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    showNavMessage('Jigsaw draft prepared (backend not enabled yet). Open DevTools console for the payload.', 'success', 3500);
                                    console.log('[CMF] Jigsaw draft payload:', draft);
                                    return;
                                }

                                let result = await App.apiCall('POST', { action: 'submitJigsaw', payload: { deal: payloadDeal, draft: draft } });
                                // Backward compatibility: older backends used 'submitJigsawReferral'
                                if (result && result.success === false && result.error && String(result.error).toLowerCase().includes('unknown action')) {
                                    const retry = await App.apiCall('POST', { action: 'submitJigsawReferral', payload: { deal: payloadDeal, draft: draft } });
                                    if (retry && ((retry === true) || (retry.success === true) || (String(retry.success).toLowerCase() === 'true'))) {
                                        result = retry;
                                    } else if (retry) {
                                        result = retry;
                                    }
                                }
                                // If the backend isn't wired yet, it may reply with success:false + an unknown action error.
                                if (result && result.success === false && result.error && String(result.error).toLowerCase().includes('unknown action')) {
                                    App.jigsaw.cacheDraft(draft);
                                    App.jigsaw.setStatus('Draft prepared', 'draft');
                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Draft prepared', state: 'draft', detail: 'Backend action submitJigsaw not found (draft saved).' });
                                    }
                                    if (deal) {
                                        deal.jigsawStatus = 'Draft';
                                        deal.jigsawLastResponseMessage = 'Backend action submitJigsaw not found (draft saved).';
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    showNavMessage('Backend action submitJigsaw not found (draft saved). Open DevTools console for the payload.', 'info', 5000);
                                    console.log('[CMF] Jigsaw draft payload:', draft);
                                    return;
                                }
                                // If backend validates first, surface validation errors clearly.
                                if (result && result.success === false && result.stage === 'validate') {
                                    App.jigsaw.setStatus('Validation failed', 'error');
                                    const msg = (result.error ? (typeof result.error === 'string' ? result.error : JSON.stringify(result.error)) : 'Validation failed.');
                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Validation failed', state: 'error', detail: msg });
                                    }
                                    if (deal) {
                                        deal.jigsawStatus = 'Validation failed';
                                        deal.jigsawLastResponseMessage = msg;
                                        deal.jigsawLastValidatedAt = new Date().toISOString();
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    // Populate the permanent VALIDATION ERRORS panel in APPLICATION
                                    try {
                                        const fieldErrors = extractJigsawFieldErrors(result);
                                        if (fieldErrors && fieldErrors.length) {
                                            showJigsawUiErrors(fieldErrors, result, payloadDeal, { status: (_resp1 && _resp1.status) || _httpStatus || 0, statusText: (_resp1 && _resp1.statusText) || '', url: (_resp1 && _resp1.url) || '' });
                                        } else {
                                            showJigsawUiErrors([msg], result, payloadDeal, { status: (_resp1 && _resp1.status) || _httpStatus || 0, statusText: (_resp1 && _resp1.statusText) || '', url: (_resp1 && _resp1.url) || '' });
                                        }
                                    } catch (e) { /* no-op */ }
showNavMessage('Jigsaw validation failed: ' + msg, 'error', 7000);
                                    console.error('[CMF] Jigsaw validation failed:', result);
                                    return;
                                }

                                const ok = (result === true) || (result && (result.success === true || String(result.success).toLowerCase() === 'true'));
                                if (ok) {
                                    App.jigsaw.setStatus('Sent', 'sent');
                                    try {
                                        const submitResp = (result && result.result) ? result.result : (result && result.data ? result.data : null);
                                        const jigsawId = submitResp && (submitResp.JigsawId ?? submitResp.jigsawId ?? submitResp.JigsawReference);
                                        const introducerRef = submitResp && (submitResp.IntroducerReference ?? submitResp.IntroducerRef ?? submitResp.IntroducerReferenceNumber);
                                        // Store on the in-memory deal so it can be saved/persisted by your backend if desired.
                                        if (deal) {
                                            if (jigsawId !== undefined && jigsawId !== null && String(jigsawId).trim() !== '') deal.jigsawId = String(jigsawId).trim();
                                            // Also write back into the visible API APPLICATION DATA field (if present)
                                            const jEl = getEl('jigsawId');
                                            if (jEl && jigsawId !== undefined && jigsawId !== null) {
                                                jEl.value = String(jigsawId).trim();
                                                jEl.dispatchEvent(new Event('input', { bubbles: true }));
                                                jEl.dispatchEvent(new Event('change', { bubbles: true }));
                                            }

                                            if (introducerRef !== undefined && introducerRef !== null && String(introducerRef).trim() !== '') deal.jigsawIntroducerReference = String(introducerRef).trim();
                                            deal.jigsawLastSentAt = new Date().toISOString();
                                            // Persist jigsawId back to the source sheet immediately
                                            try {
                                                if (jigsawId !== undefined && jigsawId !== null && String(jigsawId).trim() !== '' && typeof SaveManager !== 'undefined' && deal) {
                                                    await SaveManager.saveDeal(deal, { silent: true, reason: 'jigsawIdWriteback' });
                                                }
                                            } catch (e) { /* non-fatal */ }
                                            deal.jigsawStatus = 'Sent';
                                            deal.jigsawLastResponseMessage = 'Sent';
                                            if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                        }
                                    } catch (e) {}

                                    showNavMessage('Sent to Jigsaw.', 'success', 2500);
                                } else {
                                    App.jigsaw.setStatus('Failed', 'error');
                                    const _msg = (result && result.error) ? String(result.error) : 'Jigsaw submission failed.';
                                    if (deal) {
                                        deal.jigsawStatus = 'Failed';
                                        deal.jigsawLastSentAt = deal.jigsawLastSentAt || new Date().toISOString();
                                        deal.jigsawLastResponseMessage = _msg;
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    } else if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Failed', state: 'error', detail: _msg });
                                    }
                                    showNavMessage(_msg, 'error', 4500);
                                    console.error('[CMF] Jigsaw submission failed:', result);
                                }
                            } catch (err) {
                                App.jigsaw.setStatus('Failed', 'error');
                                if (deal) {
                                    deal.jigsawStatus = 'Failed';
                                    deal.jigsawLastSentAt = deal.jigsawLastSentAt || new Date().toISOString();
                                    deal.jigsawLastResponseMessage = 'Jigsaw submission error (see console).';
                                    if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                } else if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                    App.jigsaw.setHeaderPanel({ badgeText: 'Failed', state: 'error', detail: 'Jigsaw submission error (see console).' });
                                }
                                showNavMessage('Jigsaw submission error. See console for details.', 'error', 4500);
                                console.error(err);
                            } finally {
                                setBusy(false);
                            }
                        });
                    },

                    async validateJigsaw() {
                        const dealId = App.elements.dealId.value;
                        if (!dealId) return showNavMessage("Please save the deal before validating with Jigsaw.", "error");
                        const deal = App.state.deals.find(d => String(App.utils.getDealId(d)) === String(dealId)) || null;
                        const formData = App.ui.getFormData();
                        const draft = App.jigsaw.buildDraft({ dealId, deal, formData });

                        // Build the deal object the backend expects (mapping to JigsawReferral happens server-side)
                        const payloadDeal = Object.assign({}, (deal || {}), (formData || {}));
                        payloadDeal.id = String(dealId || payloadDeal.id || '').trim();
                        if (payloadDeal.vrn) payloadDeal.vrn = String(payloadDeal.vrn).toUpperCase().replace(/\s/g, '').trim();
                        // Backward compatibility for stage rename
                        if (payloadDeal.dealStage) { payloadDeal.dealStage = App.utils.normalizeDealStage(payloadDeal.dealStage) || payloadDeal.dealStage; }

// Option A: ensure the backend receives the full applicant bank details in a canonical structure
if (typeof applyBankAccountToJigsawPayloadDeal === 'function') {
    applyBankAccountToJigsawPayloadDeal(payloadDeal, formData);
}
                        App.ui.showConfirmModal('VALIDATE WITH JIGSAW?', 'This will validate the application with Jigsaw (no submission).', async () => {
                            // === UI: show all Jigsaw validation errors in-window (not just first/console) ===
                            const clearJigsawUiErrors = () => {
                                const box = getEl('jigsawValidationErrors');
                                const list = getEl('jigsawValidationErrorsList');
                                if (list) list.innerHTML = '';
                                if (box) box.classList.add('hidden');
                            };
                            const _escape = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
                            function listEmptyFieldsFromPayload(payload) {
  const misses = [];
  const isEmpty = (v) =>
    v === null || v === undefined || (typeof v === 'string' && v.trim() === '');

  const walk = (obj, path) => {
    if (!obj || typeof obj !== 'object') return;
    if (Array.isArray(obj)) {
      obj.forEach((v, i) => walk(v, `${path}[${i}]`));
      return;
    }
    for (const [k, v] of Object.entries(obj)) {
      const p = path ? `${path}.${k}` : k;
      if (isEmpty(v)) misses.push({ path: p, value: v });
      else if (typeof v === 'object') walk(v, p);
    }
  };

  walk(payload, '');
  return misses;
}
                            const showJigsawUiErrors = (items, rawObj, payloadDeal, meta) => {
  const box = document.getElementById('jigsawValidationErrors');
  const list = document.getElementById('jigsawValidationErrorsList');
  const emptyMsg = document.getElementById('jigsawValidationErrorsEmpty');
  const raw = document.getElementById('jigsawValidationErrorsRaw');
  const payloadPre = document.getElementById('jigsawValidationPayload');
  if (!box || !list || !emptyMsg || !raw) return;

  // normalise items -> objects
  const norm = (e) => {
    if (!e) return null;
    if (typeof e === 'string') return { field: '', label: '', message: e, code: '', path: '' };
    return {
      field: e.field || e.key || e.name || '',
      label: e.label || '',
      message: e.message || e.msg || e.error || e.description || JSON.stringify(e),
      code: e.code || e.errorCode || e.statusCode || '',
      path: e.path || e.pointer || e.location || ''
    };
  };

  const errs = Array.isArray(items) ? items.map(norm).filter(Boolean) : [];

  // Add "missing/empty" data from the payload we sent
  const missing = payloadDeal ? listEmptyFieldsFromPayload(payloadDeal) : [];
  const missingAsErrors = missing.map(m => ({
    field: m.path,
    label: '',
    message: 'Missing/empty value in payload',
    code: 'EMPTY',
    path: m.path
  }));

  const combined = [...errs, ...missingAsErrors];

  list.innerHTML = '';

  if (!combined.length) {
    emptyMsg.textContent = 'Validation failed (no error details returned).';
    emptyMsg.classList.remove('hidden');
    list.classList.add('hidden');
  } else {
    emptyMsg.classList.add('hidden');
    list.classList.remove('hidden');

    combined.forEach((e) => {
      const li = document.createElement('li');

      const headBits = [];
      if (e.code) headBits.push(`[${e.code}]`);
      if (e.field) headBits.push(e.field);
      if (e.label) headBits.push(`(${e.label})`);
      const head = headBits.join(' ').trim() || 'Error';

      li.innerHTML = `
        <div class="font-semibold">${head}</div>
        <div class="text-slate-700">${(e.message || '').toString()}</div>
      `;
      list.appendChild(li);
    });
  }

  // Build raw section with status + response
  const rawOut = {
    meta: meta || {},
    response: rawObj,
    payloadSent: payloadDeal || null
  };
  raw.textContent = JSON.stringify(rawOut, null, 2);

  // Fill the dedicated payload panel (kept separate from Raw response for quick copying)
  if (payloadPre) {
    const actionName = (meta && meta.action) ? meta.action : 'validateJigsaw';
    payloadPre.textContent = JSON.stringify({ action: actionName, payload: payloadDeal || null }, null, 2);
  }

  // Persist so the modal can show the same details if needed
  App.jigsawUi = App.jigsawUi || {};
  App.jigsawUi.lastValidationErrors = combined;
  App.jigsawUi.lastValidationRaw = rawOut;

  box.classList.remove('hidden');
};
                            function extractJigsawFieldErrors(root) {
  // Normalised output: [{ field, label, message, code, path }]
  const out = [];
  const push = (e) => {
    if (!e) return;

    // string error
    if (typeof e === 'string') {
      out.push({ field: '', label: '', message: e, code: '', path: '' });
      return;
    }

    // object error
    if (typeof e === 'object') {
      out.push({
        field: e.field || e.key || e.name || '',
        label: e.label || '',
        message: e.message || e.msg || e.error || e.description || JSON.stringify(e),
        code: e.code || e.errorCode || e.statusCode || '',
        path: e.path || e.pointer || e.location || ''
      });
    }
  };

  if (!root) return out;

  // check a few likely nesting points
  const candidates = [
    root,
    root.errorResponse,
    root.response,
    root.result,
    root.details,
    root.data
  ].filter(Boolean);

  const harvest = (body) => {
    if (!body) return;

    if (Array.isArray(body.errors)) body.errors.forEach(push);
    if (Array.isArray(body.validationErrors)) body.validationErrors.forEach(push);

    // missingFields as array
    if (Array.isArray(body.missingFields)) {
      body.missingFields.forEach((f) => push({ field: f, message: 'Missing/required', code: 'MISSING' }));
    }

    // missing as object map: { field: "reason" }
    if (body.missing && typeof body.missing === 'object' && !Array.isArray(body.missing)) {
      Object.entries(body.missing).forEach(([k, v]) =>
        push({ field: k, message: String(v || 'Missing/required'), code: 'MISSING' })
      );
    }

    // validationErrors as object map: { field: "reason" }
    if (body.validationErrors && typeof body.validationErrors === 'object' && !Array.isArray(body.validationErrors)) {
      Object.entries(body.validationErrors).forEach(([k, v]) =>
        push({ field: k, message: String(v || 'Invalid'), code: 'INVALID' })
      );
    }

    // single message/code pattern
    if ((body.message || body.error || body.title) && !out.length) {
      push({
        message: body.message || body.error || body.title,
        code: body.code || body.errorCode || body.statusCode || ''
      });
    }
  };

  candidates.forEach(harvest);
    // Map key identifiers reliably (SourceSheet headers vs UI form fields)
    // Ref (id): prefer explicit 'id' field; fall back to hidden dealId or VRN if needed.
    if (!out.id) {
      const dealIdEl = document.getElementById('dealId');
      const dealIdVal = dealIdEl && dealIdEl.value ? String(dealIdEl.value).trim() : '';
      out.id = dealIdVal || out.vrn || '';
    }

    // Received Date: accept alternate casing (receiveddate) and global parsed value if present.
    if (!out.receivedDate) {
      const alt = (out.receiveddate || out['received date'] || '').toString().trim();
      out.receivedDate = alt || (window.sourceSheetReceivedDate ? String(window.sourceSheetReceivedDate).trim() : '') || '';
    }

    return out;
  }

                            // Backend wrapper for VALIDATE: call the SAME CRM backend (single CMF token system)
// and return a { ok, status, statusText, url, text, json } envelope WITHOUT throwing,
// so we can display all Jigsaw field errors in the UI.
async function jigsawFetchAction(action, payload) {
  const _payload = (payload && typeof payload === 'object') ? { ...payload } : {};
  try {
    const t = (window.localStorage && localStorage.getItem('CMF_AUTH_TOKEN')) || '';
    if (t && !_payload.token) _payload.token = t;
  } catch(e) {}

  // Prefer google.script.run when inside Apps Script HTML Service
  if (typeof google !== 'undefined' && google.script && google.script.run && typeof google.script.run.handleWebClientRequest === 'function') {
    return await new Promise((resolve) => {
      google.script.run
        .withSuccessHandler((response) => {
          let obj = response;
          try { obj = (typeof response === 'string') ? JSON.parse(response) : response; } catch(e) {}
          resolve({
            ok: true,
            status: 200,
            statusText: 'OK',
            url: 'google.script.run',
            text: (typeof obj === 'string') ? obj : JSON.stringify(obj),
            json: obj,
            parseError: null
          });
        })
        .withFailureHandler((err) => {
          const msg = (err && err.message) ? err.message : String(err);
          resolve({
            ok: false,
            status: 500,
            statusText: 'FAILURE_HANDLER',
            url: 'google.script.run',
            text: msg,
            json: { success: false, error: msg },
            parseError: null
          });
        })
        .handleWebClientRequest({ action, payload: _payload });
    });
  }

  // Fallback (local testing): fetch to CONFIG.ENDPOINTS.CRM and include token in payload
  const endpoint = (CONFIG && CONFIG.ENDPOINTS && CONFIG.ENDPOINTS.CRM) ? CONFIG.ENDPOINTS.CRM : (window.CMF_SELF_URL || '');
  const res = await fetch(endpoint, {
    method: 'POST',
    body: JSON.stringify({ action, payload: _payload }),
    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
  });

  const txt = await res.text();
  let json = null;
  let parseError = null;

  try { json = txt ? JSON.parse(txt) : null; }
  catch (e) { json = null; parseError = e && e.message ? e.message : String(e); }

  return { ok: res.ok, status: res.status, statusText: res.statusText, url: res.url, text: txt, json, parseError };
}


                                                   clearJigsawUiErrors();
                            // === end UI errors ===

                            const btn = getEl('validateJigsawBtn');
                            const origHtml = btn ? btn.innerHTML : '';
                            const setBusy = (busy) => {
                                if (!btn) return;
                                btn.disabled = !!busy;
                                if (busy) {
                                    btn.classList.add('opacity-60', 'pointer-events-none');
                                    btn.innerHTML = 'Validating...';
                                } else {
                                    btn.classList.remove('opacity-60', 'pointer-events-none');
                                    btn.innerHTML = origHtml;
                                }
                            };

                            setBusy(true);
                            App.jigsaw.setStatus('Validating…', 'pending');
                            if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                App.jigsaw.setHeaderPanel({ badgeText: 'Validating…', state: 'pending', detail: 'Validating (no submission)…' });
                            }

                            try {
                                if (!App.config || !App.config.JIGSAW || !App.config.JIGSAW.ENABLED) {
                                    App.jigsaw.cacheDraft(draft);
                                    App.jigsaw.setStatus('Draft prepared', 'draft');
                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Draft prepared', state: 'draft', detail: 'Backend not enabled yet (draft saved).' });
                                    }
                                    showNavMessage('Jigsaw draft prepared (backend not enabled yet). Open DevTools console for the payload.', 'success', 3500);
                                    console.log('[CMF] Jigsaw draft payload:', draft);
                                    if (deal) {
                                        deal.jigsawValidationStatus = 'Draft';
                                        deal.jigsawLastValidatedAt = new Date().toISOString();
                                        deal.jigsawLastResponseMessage = 'Backend not enabled (draft saved).';
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    return;
                                }

                                const _resp1 = await jigsawFetchAction('validateJigsaw', { deal: payloadDeal, draft: draft });
                                let result = _resp1 ? _resp1.json : null;
                                let _httpOk = _resp1 ? _resp1.ok : true;
                                let _httpStatus = _resp1 ? _resp1.status : 0;

                                // Backward compatibility: older backends used 'validateJigsawReferral'
                                if (result && result.success === false && result.error && String(result.error).toLowerCase().includes('unknown action')) {
                                    const _resp2 = await jigsawFetchAction('validateJigsawReferral', { deal: payloadDeal, draft: draft });
                                    const retry = _resp2 ? _resp2.json : null;
                                    _httpOk = _resp2 ? _resp2.ok : _httpOk;
                                    _httpStatus = _resp2 ? _resp2.status : _httpStatus;
                                    result = retry || result;
                                }

                                // If the backend isn't wired yet, it may reply with success:false + an unknown action error.
                                if (result && result.success === false && result.error && String(result.error).toLowerCase().includes('unknown action')) {
                                    App.jigsaw.cacheDraft(draft);
                                    App.jigsaw.setStatus('Draft prepared', 'draft');
                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Draft prepared', state: 'draft', detail: 'Validate action not found (draft saved).' });
                                    }
                                    showNavMessage('Backend action validateJigsaw not found (draft saved). Open DevTools console for the payload.', 'info', 6000);
                                    console.log('[CMF] Jigsaw draft payload:', draft);
                                    if (deal) {
                                        deal.jigsawValidationStatus = 'Draft';
                                        deal.jigsawLastValidatedAt = new Date().toISOString();
                                        deal.jigsawLastResponseMessage = 'Validate action not found (draft saved).';
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    return;
                                }

                                // Surface validation errors clearly.
                                if (result && result.success === false && result.stage === 'validate') {
                                    App.jigsaw.setStatus('Validation failed', 'error');
                                    const msg = (result.error ? (typeof result.error === 'string' ? result.error : JSON.stringify(result.error)) : 'Validation failed.');

                                    const meta = {
                                        status: (_resp1 && _resp1.status) || 0,
                                        statusText: (_resp1 && _resp1.statusText) || '',
                                        url: (_resp1 && _resp1.url) || '',
                                        action: 'validateJigsaw'
                                    };

                                    // Ensure RAW response always includes body/status, even if we couldn't parse field errors
                                    let uiRaw = result;
                                    if (uiRaw === null || uiRaw === undefined) uiRaw = {};
                                    if (typeof uiRaw !== 'object') uiRaw = { value: uiRaw };
                                    if (_resp1 && _resp1.text) uiRaw.rawText = _resp1.text;
                                    if (_resp1 && _resp1.parseError) uiRaw.parseError = _resp1.parseError;

                                    const fieldErrors = extractJigsawFieldErrors(uiRaw);
                                    showJigsawUiErrors((fieldErrors && fieldErrors.length) ? fieldErrors : [msg], uiRaw, payloadDeal, meta);

                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Validation failed', state: 'error', detail: msg });
                                    }
                                    showNavMessage('Jigsaw validation failed: ' + msg, 'error', 7000);
                                    console.error('[CMF] Jigsaw validation failed:', result);
                                    if (deal) {
                                        deal.jigsawValidationStatus = 'Failed';
                                        deal.jigsawLastValidatedAt = new Date().toISOString();
                                        deal.jigsawLastResponseMessage = msg;
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    return;
                                }

                                const ok = (result === true) || (result && (result.success === true || String(result.success).toLowerCase() === 'true'));
                                if (ok) {
                                    App.jigsaw.setStatus('Validated (OK)', 'validated');
                                    if (deal) {
                                        deal.jigsawValidationStatus = 'OK';
                                        deal.jigsawLastValidatedAt = new Date().toISOString();
                                        deal.jigsawStatus = 'Validated';
                                        deal.jigsawLastResponseMessage = 'Validated OK';
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    } else if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Validated', state: 'validated', detail: 'Validated OK' });
                                    }
                                    showNavMessage('Validated with Jigsaw (OK).', 'success', 2500);
                                } else {
                                    App.jigsaw.setStatus('Validation failed', 'error');
                                    const msg = (result && result.error) ? String(result.error) : 'Jigsaw validation failed.';
                                    const meta = {
                                        status: (_resp1 && _resp1.status) || _httpStatus || 0,
                                        statusText: (_resp1 && _resp1.statusText) || '',
                                        url: (_resp1 && _resp1.url) || '',
                                        action: 'validateJigsaw'
                                    };

                                    // Ensure RAW response always includes body/status, even if JSON parsing failed
                                    let uiRaw = result;
                                    if (uiRaw === null || uiRaw === undefined) uiRaw = {};
                                    if (typeof uiRaw !== 'object') uiRaw = { value: uiRaw };
                                    if (_resp1 && _resp1.text) uiRaw.rawText = _resp1.text;
                                    if (_resp1 && _resp1.parseError) uiRaw.parseError = _resp1.parseError;

                                    const fieldErrors = extractJigsawFieldErrors(uiRaw);
                                    showJigsawUiErrors((fieldErrors && fieldErrors.length) ? fieldErrors : [msg], uiRaw, payloadDeal, meta);
                                    // If HTTP layer failed but backend still provided JSON, include status
                                    if (typeof _httpOk !== 'undefined' && !_httpOk && _httpStatus) {
                                        // Keep existing msg, but ensure UI shows something useful
                                    }
                                    if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                        App.jigsaw.setHeaderPanel({ badgeText: 'Validation failed', state: 'error', detail: msg });
                                    }
                                    if (deal) {
                                        deal.jigsawValidationStatus = 'Failed';
                                        deal.jigsawLastValidatedAt = new Date().toISOString();
                                        deal.jigsawLastResponseMessage = msg;
                                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(deal);
                                    }
                                    showNavMessage(msg, 'error', 4500);
                                    console.error('[CMF] Jigsaw validation failed:', result);
                                }
                            } catch (err) {
                                App.jigsaw.setStatus('Validation failed', 'error');
                                if (App.jigsaw && typeof App.jigsaw.setHeaderPanel === 'function') {
                                    App.jigsaw.setHeaderPanel({ badgeText: 'Validation failed', state: 'error', detail: 'See validation errors for details.' });
                                }
                                showNavMessage('Jigsaw validation error. See validation errors for details.', 'error', 6000);
                                console.error(err);

                                try {
                                    const url = (typeof GOOGLE_SCRIPT_URL !== 'undefined') ? GOOGLE_SCRIPT_URL : '';
                                    showJigsawUiErrors(
                                        [err && err.message ? err.message : String(err)],
                                        { ok: false, error: true },
                                        payloadDeal,
                                        { status: 0, statusText: 'FETCH_ERROR', url, action: 'validateJigsaw' }
                                    );
                                } catch (e) { /* no-op */ }
                            } finally {
                                setBusy(false);
                            }
                        });
                    },
                    sendCarMoney() {
                        App.carMoney && App.carMoney.setStatus && App.carMoney.setStatus('Draft prepared', 'draft');
                        showNavMessage("SEND CARMONEY is a placeholder button (not yet connected).", "info");
                    },
                    sendCF247() {
                        App.cf247 && App.cf247.setStatus && App.cf247.setStatus('Draft prepared', 'draft');
                        showNavMessage("SEND CF247 is a placeholder button (not yet connected).", "info");
                    },
                    deleteDeal() {
                        const dealId = App.elements.dealId.value;
                        if (!dealId) return;
                        App.ui.showConfirmModal('Delete Deal?', 'This will permanently delete this deal.', async () => {
                            showNavMessage("Deleting deal...", "info");
                            const result = await App.apiCall('POST', { action: 'delete', payload: { id: dealId } });
                            if(result && result.success) {
                                showNavMessage("Deal deleted.", "success");
                                App.state.selectedContactIds.delete(dealId);
                                await App.loadData(); App.ui.closeModal('customer');
                            }
                        });
                    },
                    async handleDrop(dealId, newDealStage) {
                        newDealStage = App.utils.normalizeDealStage(newDealStage) || newDealStage;
                        const idStr = String(dealId || '').trim();
                        const deal = App.state.deals.find(d => String(App.utils.getDealId(d) || '').trim() === idStr)
                                  || App.state.deals.find(d => String(App.utils.getVrn(d) || '').trim() === idStr)
                                  || App.state.deals.find(d => String(d.id || '').trim() === idStr);
                        if (!deal || String(deal.dealStage || '') === String(newDealStage || '')) return;
                        const cardElement = $(`#kanban-board .kanban-card[data-deal-id="${idStr}"]`);
                        const targetColumnList = $(`#kanban-board .kanban-column[data-deal-stage="${newDealStage}"] .deal-list`);
                        const originalStage = deal.dealStage;
                        const originalParent = cardElement ? cardElement.parentElement : null;

                        // Update state first so summary calculations reflect the move immediately.
                        deal.dealStage = newDealStage;

                        if (cardElement && targetColumnList) {
                            // Move existing DOM node (no duplication) and then recalc header stats.
                            targetColumnList.appendChild(cardElement);
                            App.handlers.recalculateColumnSummaries(originalStage, newDealStage);
                        } else {
                            // Fallback: if DOM not found (filters/search), re-render board from state.
                            App.render.board();
                        }
                        deal.stageHistory = [...(deal.stageHistory || []), { dealStage: newDealStage, date: new Date().toISOString() }];
                        const result = await SaveManager.saveDeal(deal );
                        if (!result || !result.success) {
                            showNavMessage("Failed to save stage change. Reverting.", "error");
                            deal.dealStage = originalStage;
                            deal.stageHistory.pop();
                            if (cardElement && originalParent) {
                                originalParent.appendChild(cardElement);
                                App.handlers.recalculateColumnSummaries(newDealStage, originalStage);
                            } else App.render.board();
                        }
                    },
                    async handleExpertChange(dealId, newExpert) {
                        const idStr = String(dealId || '').trim();
                        const deal = App.state.deals.find(d => String(App.utils.getDealId(d) || '').trim() === idStr)
                                  || App.state.deals.find(d => String(App.utils.getVrn(d) || '').trim() === idStr)
                                  || App.state.deals.find(d => String(d.id || '').trim() === idStr);
                        if (!deal || String(deal.expert || '') === String(newExpert || '')) return;
                        const cardElement = $(`#kanban-board .kanban-card[data-deal-id="${idStr}"]`);
                        const oldExpert = deal.expert;
                        const oldColorClass = App.ui.getExpertColorClass(oldExpert);
                        const newColorClass = App.ui.getExpertColorClass(newExpert);
                        if (cardElement) {
                            cardElement.classList.remove(...oldColorClass.split(' '));
                            cardElement.classList.add(...newColorClass.split(' '));
                        }
                        deal.expert = newExpert;
                        const result = await SaveManager.saveDeal(deal );
                        if (!result || !result.success) {
                            showNavMessage("Failed to save expert change. Reverting.", "error");
                            deal.expert = oldExpert;
                            if (cardElement) {
                                cardElement.classList.remove(...newColorClass.split(' '));
                                cardElement.classList.add(...oldColorClass.split(' '));
                            }
                        }
                    },
                    recalculateColumnSummaries(oldStageId, newStageId) {
                        [oldStageId, newStageId].filter(Boolean).forEach(stageId => {
                            const column = $(`#kanban-board .kanban-column[data-deal-stage="${stageId}"]`);
                            if (!column) return;
                            const stageDeals = App.state.deals.filter(d => d.dealStage === stageId);
                            const totalValue = stageDeals.reduce((sum, d) => sum + (parseInt(d.settlementTotal) || 0), 0);
                            const countSpan = column.querySelector('h3 + span');
                            const valueDiv = column.querySelector('.font-bold');
                            if (countSpan) countSpan.textContent = `${stageDeals.length} deals`;
                            if (valueDiv) valueDiv.textContent = `£${totalValue.toLocaleString()}`;
                        });
                    },
                    handleFileSelect(event) {
                        const file = event.target.files[0];
                        if (!file) return;
                        setTxt('fileName', file.name);
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                                const { unique, duplicates } = App.handlers.parseAndCheckDuplicates(jsonData);
                                App.state.parsedDeals = { unique, duplicates };
                                App.elements.importButton.disabled = false;
                                setHtml('status-message', `<span class="text-blue-600">Found ${unique.length} unique contacts and ${duplicates.length} duplicates.</span>`);
                            } catch (err) {
                                setHtml('status-message', `<span class="text-red-600">Error: ${err.message}</span>`);
                                App.elements.importButton.disabled = true;
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    },
                    parseAndCheckDuplicates(jsonData) {
                        const existingKeys = new Set(App.state.deals.map(d => d.vrn ? d.vrn.toLowerCase().replace(/\s/g, '') : '').filter(Boolean));
                        const unique = [], duplicates = [];
                        const toCamel = s => s.replace(/([-_ \s][a-z])/ig, ($1) => $1.toUpperCase().replace(/[-_ \s]/g, ''));
                        jsonData.forEach(row => {
                            const obj = {};
                            for (const key in row) {
                                const _nk = String(key || '').toLowerCase().replace(/[\s_\-]/g,'');
                                const camelKey = (_nk === 'jigsawid') ? 'jigsawId' : toCamel(key);
                                if (App.config.ALL_CSV_HEADERS.includes(camelKey)) obj[camelKey] = row[key];
                            }
                            const vrnKey = obj.vrn ? obj.vrn.toLowerCase().replace(/\s/g, '') : '';
                            if (vrnKey && existingKeys.has(vrnKey)) duplicates.push(obj);
                            else { unique.push(obj); if (vrnKey) existingKeys.add(vrnKey); }
                        });
                        return { unique, duplicates };
                    },
                    processImport() {
                        if (App.state.parsedDeals.duplicates.length > 0) App.ui.showDuplicateModal(App.state.parsedDeals.duplicates);
                        else App.handlers.importDeals(false);
                    },
                    async importDeals(includeDuplicates) {
                        App.ui.closeModal('duplicate');
                        const dealsToImport = includeDuplicates ? [...App.state.parsedDeals.unique, ...App.state.parsedDeals.duplicates] : App.state.parsedDeals.unique;
                        if (dealsToImport.length === 0) return showNavMessage("No new contacts to import.", "info");
                        const newDeals = dealsToImport.map(d => ({ ...d, id: d.vrn, dealStage: d.dealStage || App.config.CONTACT_STAGE_ID, receivedDate: d.receivedDate || new Date().toISOString().split('T')[0], stageHistory: [{ dealStage: d.dealStage || App.config.CONTACT_STAGE_ID, date: new Date().toISOString() }], value: parseInt(d.settlementTotal) || 0 }));
                        showNavMessage(`Uploading ${newDeals.length} contacts...`, "info");
                        const result = await App.apiCall('POST', { action: 'batchUpdate', payload: newDeals });
                        if(result && result.success) { showNavMessage(`Successfully uploaded ${newDeals.length} contacts!`, "success"); await App.loadData(); }
                        setHtml('status-message', ''); setVal('importFile', ''); setTxt('fileName', '');
                        App.state.parsedDeals = { unique: [], duplicates: [] }; App.elements.importButton.disabled = true;
                    },
                    exportData() {
                        const ws = XLSX.utils.json_to_sheet(App.state.deals);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Deals");
                        XLSX.writeFile(wb, "crm_data_export.xlsx");
                        showNavMessage("Data exported successfully!", "success");
                    },
                    deleteSelectedContacts() {
                        const ids = Array.from(App.state.selectedContactIds);
                        if (ids.length === 0) return;
                        App.ui.showConfirmModal(`Delete ${ids.length} contacts?`, 'This action is irreversible.', async () => {
                            showNavMessage(`Deleting ${ids.length} contacts...`, "info");
                            for (const id of ids) await App.apiCall('POST', { action: 'delete', payload: { id } });
                            showNavMessage(`${ids.length} contacts deleted.`, "success");
                            App.state.selectedContactIds.clear(); await App.loadData();
                        });
                    },
                    searchContacts(term) {
                        const lowerTerm = term.toLowerCase().trim();
                        if (!lowerTerm) return App.render.contacts();
                        const filtered = App.state.deals.filter(deal =>
                            deal.dealStage === App.config.CONTACT_STAGE_ID &&
                            Object.values(deal).some(value =>
                                String(value).toLowerCase().includes(lowerTerm)
                            )
                        );
                        App.render.contacts(filtered);
                    },
                    handleSort(key, direction) {
                        const { sortState } = App.state;
                        if (direction) {
                            sortState.direction = direction;
                        } else {
                            sortState.direction = (sortState.key === key && sortState.direction === 'asc') ? 'desc' : 'asc';
                        }
                        sortState.key = key;
                        App.render.contacts();
                        App.ui.syncSortControls();
                    },
                                            toggleSelectAllContacts(checked) {
                            const contactDeals = App.state.deals.filter(d => d.dealStage === App.config.CONTACT_STAGE_ID);
                            const visibleContactIds = contactDeals.map(d => d.id);
                            if (checked) {
                                visibleContactIds.forEach(id => App.state.selectedContactIds.add(id));
                            } else {
                                visibleContactIds.forEach(id => App.state.selectedContactIds.delete(id));
                            }
                            App.ui.updateContactSelection();
                        }, // <--- Note the comma here!

                        // ============================================================
                        //  DRIVE FILES "BRAIN" (RESTORED)
                        // ============================================================

                        // 1. LIVE SEARCH TRIGGER
                        handleLiveSearch(value) {
                            if (this.searchTimer) clearTimeout(this.searchTimer);
                            const self = this;
                            this.searchTimer = setTimeout(() => {
                                const query = value ? value.trim() : '';
                                self.runFolderSearch(query);
                            }, 400);
                        },

                        // 2. RUN SEARCH (Find Folders)
                        async runFolderSearch(query) {
                            const listEl = document.getElementById('drive-file-list');
                            const countEl = document.getElementById('drive-result-count');

                            if (!listEl) {
                                console.error("Critical: 'drive-file-list' element missing!");
                                if(App.diagnostics) App.diagnostics.log("Critical: 'drive-file-list' element missing!", "error");
                                return;
                            }

                            // Show Loading State
                            listEl.innerHTML = `
                                <div class="flex flex-col items-center justify-center h-full pt-10">
                                    <div class="spinner border-t-green-600 w-8 h-8 mb-3"></div>
                                    <p class="text-sm text-gray-500">${query ? 'Searching...' : 'Loading all folders...'}</p>
                                </div>`;

                            try {
                                if(App.diagnostics) App.diagnostics.log(`Requesting folders (Query: "${query}")...`, "info");

                                // Call Backend
                                const res = await App.apiCall('POST', { action: 'searchFolders', query: query });

                                if (!res || !res.success) {
                                    const msg = res ? res.error : "Network Error";
                                    listEl.innerHTML = `<div class="p-4 text-center text-red-500">Error: ${msg}</div>`;
                                    if(App.diagnostics) App.diagnostics.log("Backend Error: " + msg, "error");
                                    return;
                                }

                                if (!res.folders || res.folders.length === 0) {
                                    listEl.innerHTML = `
                                        <div class="flex flex-col items-center justify-center h-64 text-gray-500">
                                            <p class="font-medium">No matches found</p>
                                            <p class="text-xs opacity-75">${res.message || 'Try a different name'}</p>
                                        </div>`;
                                    if(countEl) countEl.classList.add('hidden');
                                    return;
                                }

                                if(countEl) {
                                    countEl.textContent = res.folders.length;
                                    countEl.classList.remove('hidden');
                                }

                                if(App.diagnostics) App.diagnostics.log(`Rendering ${res.folders.length} folders...`, "success");

                                // Safe Escape Helper
                                const esc = (str) => (App.utils && App.utils.escapeHtml) ? App.utils.escapeHtml(str) : String(str);

                                let html = `<div class="p-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Client Folders</div>`;

                                res.folders.forEach(folder => {
                                    html += `
                                    <div onclick="App.handlers.openClientFolder('${esc(folder.id)}')" 
                                         class="cursor-pointer p-3 bg-white border-b border-gray-100 hover:bg-green-50 hover:pl-4 transition-all flex items-center gap-3 group">
                                        <div class="bg-green-50 p-2 rounded-lg group-hover:bg-green-100 client-files-icon">
                                            <svg class="w-5 h-5 text-[#004225]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                                                <!-- CLIENT FILES TAB: Left results list (“wallet/document sleeve”). Selecting an item loads preview into #drive-preview-frame. -->
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5A2.5 2.5 0 0 1 5.5 5H20a1 1 0 0 1 1 1v2.5"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5V19a2 2 0 0 0 2 2h15a2 2 0 0 0 2-2V9H5.5A2.5 2.5 0 0 1 3 7.5z"/>
                                                <!-- BRANDING/ILLUSTRATION: Decorative car outline element. Safe to replace with SVG; avoid changing layout container class names. -->
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16l1-3h6l1 3"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16h10"/>
                                                <circle cx="9" cy="17" r="1" />
                                                <circle cx="15" cy="17" r="1" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-gray-700 group-hover:text-green-800">${esc(folder.name)}</div>
                                            <div class="text-[10px] text-gray-400">Updated: ${new Date(folder.updated).toLocaleDateString()}</div>
                                        </div>
                                    </div>`;
                                });
                                listEl.innerHTML = html;

                            } catch (e) {
                                console.error(e);
                                listEl.innerHTML = `<div class="p-4 text-center text-red-500 text-xs">Render Error: ${e.message}</div>`;
                                if(App.diagnostics) App.diagnostics.log("Render Crash: " + e.message, "error");
                            }
                        },

                        // 3. OPEN FOLDER (Get Files)
                        async openClientFolder(folderId) {
                            const listEl = document.getElementById('drive-file-list');
                            listEl.innerHTML = `
                                <div class="flex flex-col items-center justify-center h-full pt-10">
                                    <div class="spinner border-t-blue-600 w-8 h-8 mb-3"></div>
                                    <p class="text-sm text-gray-500">Opening folder...</p>
                                </div>`;

                            try {
                                if(App.diagnostics) App.diagnostics.log(`Opening Folder ID: ${folderId}...`, "info");

                                const res = await App.apiCall('POST', { action: 'getFolderFiles', folderId: folderId });

                                if (!res || !res.success || !res.files || res.files.length === 0) {
                                    listEl.innerHTML = '<div class="p-4 text-center text-gray-400">This folder is empty.</div>';
                                    return;
                                }

                                const esc = (str) => (App.utils && App.utils.escapeHtml) ? App.utils.escapeHtml(str) : String(str);

                                let html = `
                                    <div class="flex items-center gap-2 p-3 bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                                        <button onclick="App.handlers.runFolderSearch(document.getElementById('drive-search-input').value)" 
                                                class="text-xs bg-white border border-gray-300 px-2 py-1.5 rounded hover:bg-gray-100 flex items-center gap-1 font-medium text-gray-600">
                                            <span>← Back</span>
                                        </button>
                                        <span class="text-xs font-bold text-gray-800 truncate flex-1">${esc(res.folderName)}</span>
                                    </div>
                                    <div class="p-2 space-y-1">`;

                                res.files.forEach(file => {
                                    html += `
                                        <div onclick="App.handlers.openDrivePreview('${file.url}'); document.querySelectorAll('.drive-item').forEach(e=>e.classList.remove('bg-blue-50','ring-1','ring-blue-300')); this.classList.add('bg-blue-50','ring-1','ring-blue-300');" 
                                             class="drive-item cursor-pointer p-3 bg-white border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-all flex items-start gap-3 group">
                                            <img src="${file.icon}" class="w-5 h-5 mt-0.5 opacity-80 group-hover:opacity-100">
                                            <div class="overflow-hidden">
                                                <div class="text-sm font-medium text-gray-700 truncate group-hover:text-blue-700">${esc(file.name)}</div>
                                                <div class="text-[10px] text-gray-400 mt-1 flex gap-2">
                                                    <span>${new Date(file.lastUpdated).toLocaleDateString()}</span>
                                                    <span>${(file.size/1024).toFixed(0)} KB</span>
                                                </div>
                                            </div>
                                        </div>`;
                                });
                                html += '</div>';
                                listEl.innerHTML = html;
                                if(App.diagnostics) App.diagnostics.log(`Opened folder. Showing ${res.files.length} files.`, "success");

                            } catch (e) {
                                console.error(e);
                                listEl.innerHTML = `<div class="p-4 text-center text-red-500">Error: ${e.message}</div>`;
                                if(App.diagnostics) App.diagnostics.log("Folder Open Error: " + e.message, "error");
                            }
                        }

                },

                diagnostics: {
                    log(msg, type = 'info') {
                        // Logging disabled (console UI hidden). Keep as no-op for safety.
                        return;
                    },

                    updateStatus(status) {
                        const dot = document.getElementById('sys-status-dot');
                        const text = document.getElementById('sys-status-text');
                        if (!dot || !text) return;

                        if (status === 'online') {
                            dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                            text.className = "font-bold uppercase tracking-wider text-green-400";
                            text.innerText = "SYSTEM ONLINE";
                        } else if (status === 'checking') {
                            dot.className = "w-2.5 h-2.5 rounded-full bg-yellow-400 animate-bounce";
                            text.className = "font-bold uppercase tracking-wider text-yellow-400";
                            text.innerText = "CONNECTING...";
                        } else {
                            dot.className = "w-2.5 h-2.5 rounded-full bg-red-500";
                            text.className = "font-bold uppercase tracking-wider text-red-400";
                            text.innerText = "OFFLINE / ERROR";
                        }
                    },

                    async runFullTest() {
                        this.updateStatus('checking');

                        const logWrap = document.getElementById('sys-log-container');
                        if (logWrap) {
                            logWrap.classList.remove('hidden');
                            logWrap.innerHTML = ''; // Clear
                        }

                        this.log("Starting Diagnostic Sequence...", "info");

                        // TEST 1: Basic Connectivity (Ping)
                        const t0 = performance.now();
                        try {
                            this.log(`1. Pinging Backend: ${String(CONFIG?.ENDPOINTS?.CRM || '').substring(0, 40)}...`, "info");
                            const res = await App.apiCall('POST', { action: 'healthCheck' });
                            const t1 = performance.now();
                            const latency = Math.round(t1 - t0);

                            const latEl = document.getElementById('sys-latency');
                            if (latEl) latEl.innerText = `Latency: ${latency}ms`;

                            if (res && res.success) {
                                this.log(`Connection Established (${latency}ms)`, "success");
                                this.log(`Script User: ${App.utils.escapeHtml(res.user || 'Unknown')}`, "info");
                                this.log(`Version Ident: ${App.utils.escapeHtml(res.version || 'Unknown')}`, "info");
                            } else {
                                throw new Error("Backend reachable but returned error: " + (res?.error || "Unknown"));
                            }
                        } catch (e) {
                            this.log("CONNECTION FAILED: " + (e?.message || e), "error");
                            if ((e?.message || '').includes("SyntaxError")) {
                                this.log("HINT: Server likely returned HTML instead of JSON. Check the Deployment URL.", "error");
                            }
                            this.updateStatus('offline');
                            return;
                        }

                        // TEST 2: Drive Permissions / Browse mode
                        this.log("2. Checking Drive Root Folder Access...", "info");
                        try {
                            const driveRes = await App.apiCall('POST', { action: 'searchFolders', query: '' });

                            if (driveRes && driveRes.success) {
                                const count = Array.isArray(driveRes.folders) ? driveRes.folders.length : 0;
                                this.log(`Root Access Confirmed. Found ${count} folders.`, "success");
                                this.updateStatus('online');
                            } else {
                                this.log("DRIVE ERROR: " + (driveRes?.error || "Unknown Error"), "error");
                                if (driveRes?.debug) this.log("Debug Info: " + App.utils.escapeHtml(driveRes.debug), "info");
                                this.updateStatus('offline');
                            }
                        } catch (e) {
                            this.log("Drive Test Failed: " + (e?.message || e), "error");
                            this.updateStatus('offline');
                        }
                    }
                },

                render: {
                    all() { this.board(); this.contacts(); if (App.state.currentView === 'forecasting') this.forecasting(); },
                    board() {
                        const { kanbanBoard } = App.elements;

                        // Sticky-scroll: capture scroll positions before any DOM changes.
                        const scrollPositions = new Map();
                        try {
                            const cols = kanbanBoard.querySelectorAll('.kanban-column');
                            cols.forEach(col => {
                                const key = col.dataset.dealStage || col.id;
                                const scroller = col.querySelector('.deal-list') || col;
                                if (key) scrollPositions.set(String(key), scroller.scrollTop || 0);
                            });
                        } catch (e) { /* non-fatal */ }

                        const surnameTerm = (App.state.surnameFilter || '').toLowerCase().trim();
                        const expertTerm  = (App.state.expertFilter  || '').toLowerCase().trim();

                        // Lazy render: build a lightweight signature; if unchanged, do nothing (preserves scroll naturally).
                        const signatureParts = [];
                        const frag = document.createDocumentFragment();
                        App.state.stages.filter(s => s.id !== 'Contact').forEach(stage => {
                            let stageDeals = App.state.deals.filter(d => {
                                // 1. Filter by Stage
                                if (d.dealStage !== stage.id) return false;

                                // 2. Safe Surname Filter
                                if (surnameTerm) {
                                    const name = (d.lastName || '').toString().toLowerCase();
                                    if (!name.includes(surnameTerm)) return false;
                                }

                                // 3. Safe Expert Filter
                                if (expertTerm) {
                                    const expert = (d.expert || '').toString().toLowerCase();
                                    if (!expert.includes(expertTerm)) return false;
                                }

                                return true;
                            });
                            // Signature: stage + ordered deal ids (post-filters). Used to skip no-op re-renders.
                            try {
                                const ids = stageDeals.map(d => {
                                    try {
                                        const id = (App.utils && typeof App.utils.getDealId === 'function') ? App.utils.getDealId(d) : (d.id ?? d.ID ?? d.vrn ?? d.VRN ?? '');
                                        return String(id || '').trim();
                                    } catch (e) { return ''; }
                                }).filter(Boolean).join(',');
                                signatureParts.push(`${stage.id}:${ids}`);
                            } catch (e) {
                                signatureParts.push(`${stage.id}:${stageDeals.length}`);
                            }

                            const totalValue = stageDeals.reduce((sum, d) => sum + (parseInt(d.settlementTotal) || 0), 0);
                            const col = document.createElement('div');
                            col.className = 'kanban-column rounded-lg p-3 w-72 sm:w-80 flex-shrink-0';
                            col.dataset.dealStage = stage.id;
                            col.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="font-semibold text-lg">${stage.title}</h3><span class="text-sm font-medium">${stageDeals.length} deals</span></div><div class="text-sm font-bold mb-3">£${totalValue.toLocaleString()}</div><div class="space-y-3 deal-list"></div>`;
                            frag.appendChild(col);
                            (stage.id === 'Enquiry'
    ? [...stageDeals].sort((a, b) => new Date(b.receivedDate) - new Date(a.receivedDate))
    : stageDeals
).forEach(deal => {
                                const card = document.createElement('div');
                                card.innerHTML = App.templates.dealCard(deal);
                                const cardEl = card.firstElementChild;
                                on(cardEl, 'click', (e) => {
                                // Avoid opening the modal when interacting with controls inside the card
                                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('select') || e.target.closest('textarea') || e.target.closest('a')) return;

                                const dealId = App.utils.getDealId(deal);
                                if (dealId) {
                                    App.ui.openCustomerModalLocked(dealId);
                                } else {
                                    console.error("Deal missing canonical ID:", deal, { resolvedId: dealId, resolvedVrn: App.utils.getVrn(deal) });
                                    showNavMessage("Cannot edit: Deal has no ID/VRN", "error");
                                }
                            });
                                const stageSelect = cardEl.querySelector('.deal-stage-select');
                                const dealKey = String(App.utils.getDealId(deal) || App.utils.getVrn(deal) || deal.id || '').trim();
                                on(stageSelect, 'click', e => e.stopPropagation());
                                on(stageSelect, 'change', async (e) => {
                                    e.stopPropagation();
                                    const sel = e.target;
                                    // Guard against double-fires while saving
                                    if (sel && sel.dataset && sel.dataset.busy === '1') return;
                                    if (sel && sel.dataset) sel.dataset.busy = '1';
                                    if (sel) sel.disabled = true;
                                    try {
                                        await App.handlers.handleDrop(dealKey, sel.value);
                                    } finally {
                                        if (sel) sel.disabled = false;
                                        if (sel && sel.dataset) sel.dataset.busy = '0';
                                    }
                                });
                                const expertSelect = cardEl.querySelector('.expert-select');
                                on(expertSelect, 'click', e => e.stopPropagation());
                                on(expertSelect, 'change', e => App.handlers.handleExpertChange(dealKey, e.target.value));

                                cardEl.querySelectorAll('.doc-toggle').forEach(btn => {
                                    on(btn, 'click', async (ev) => {
                                        ev.stopPropagation();
                                        const field = btn.dataset.field;
                                        const isTrue = (v) => (v === true || v === 1 || v === '1' || (typeof v === 'string' && v.toLowerCase() === 'true'));
                                        const newVal = !isTrue(deal[field]);
                                        deal[field] = newVal;
                                        // Mirror Direct Debit toggle into docBankD for backend
                                        if (field === 'docBankD') {
                                            deal.docBankD = newVal;
                                            deal['docBankD'] = newVal;
                                        }
                                        btn.dataset.state = newVal ? 'true' : 'false';
                                        btn.classList.toggle('toggle-green', newVal);
                                        btn.classList.toggle('toggle-red', !newVal);
                                        btn.textContent = newVal ? '✓' : '✗';
                                        try { await SaveManager.saveDeal(deal ); } catch (e) { console.error(e); }
                                    });
                                });
                                cardEl.querySelectorAll('.inline-edit').forEach(inp => {
                                    on(inp, 'click', e => e.stopPropagation());
                                    on(inp, 'change', async (e) => {
                                        const f = inp.dataset.field;
                                        deal[f] = inp.value;

                                        // Auto-calc Savings in Kanban when New Payment + Old Payment exist:
                                        // (New Payment - Old Payment) * New Term
                                        // Uses deal.term as the "New Term" (falls back to deal.newTerm if present).
                                        if (f === 'newPayment' || f === 'oldPayment' || f === 'term' || f === 'newTerm') {
                                            const np = toNumber(deal.newPayment, 2);
                                            const op = toNumber(deal.oldPayment, 2);
                                            const nt = toNumber((deal.term ?? deal.newTerm), 0);
                                            if (np && op && nt) {
                                                const savingsCalc = (op - np) * nt;
                                                deal.savings = savingsCalc;

                                                // Reflect immediately in the card UI (without triggering a loop)
                                                const savingsEl = cardEl.querySelector('.inline-edit[data-field="savings"]');
                                                if (savingsEl) {
                                                    savingsEl.value = fmtGBP0.format(savingsCalc);
                                                }
                                            }
                                        }

                                        try { await SaveManager.saveDeal(deal ); } catch (e) { console.error(e); }
                                    });
                                });
col.querySelector('.deal-list').appendChild(cardEl);
                            });
                        });
                        // Commit render only if signature changed
                        const newSig = `${surnameTerm}||${expertTerm}||${signatureParts.join('##')}`;
                        if (App.state.__boardRenderSig === newSig && kanbanBoard.children.length) {
                            return;
                        }
                        App.state.__boardRenderSig = newSig;

                        kanbanBoard.innerHTML = '';
                        kanbanBoard.appendChild(frag);

                        // Sticky-scroll: restore scroll positions after the DOM is painted.
                        setTimeout(() => {
                            try {
                                const cols = kanbanBoard.querySelectorAll('.kanban-column');
                                cols.forEach(col => {
                                    const key = col.dataset.dealStage || col.id;
                                    if (!key) return;
                                    const scroller = col.querySelector('.deal-list') || col;
                                    if (scrollPositions.has(String(key))) scroller.scrollTop = scrollPositions.get(String(key));
                                });
                            } catch (e) { /* non-fatal */ }
                        }, 0);

                        App.ui.addDragAndDropListeners();
                    },
                    contacts(deals) {
                        const { contactsList } = App.elements;
                        const { key: sortKey, direction } = App.state.sortState;
                        contactsList.innerHTML = '';
                        let dealsToRender = deals || App.state.deals;
                        if (!dealsToRender.length) return contactsList.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-8">No contacts found.</td></tr>`;
                        dealsToRender.sort((a, b) => {
                            const valA = a[sortKey], valB = b[sortKey];
                            let comp = 0;
                            if (sortKey === 'receivedDate') comp = new Date(valB) - new Date(valA);
                            else if (sortKey === 'settlementTotal') comp = (parseInt(valB) || 0) - (parseInt(valA) || 0);
                            else comp = (valA || '').toString().localeCompare((valB || '').toString());
                            return direction === 'asc' ? -comp : comp;
                        });
                        const frag = document.createDocumentFragment();
                        dealsToRender.forEach(deal => {
                            const row = frag.appendChild(document.createElement('tr'));
                            row.className = 'hover:bg-gray-50 cursor-pointer'; row.dataset.dealId = deal.id;
                            const createCell = (content, classes = '') => { const c = document.createElement('td'); c.className = `px-6 py-4 text-sm ${classes}`; c.textContent = content; return c; };
                            const chkCell = document.createElement('td'); chkCell.className = 'px-6 py-4';
                            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'contact-checkbox'; chk.dataset.id = deal.id;
                            chk.checked = App.state.selectedContactIds.has(deal.id);
                            chk.onclick = (e) => { e.stopPropagation(); App.state.selectedContactIds.has(deal.id) ? App.state.selectedContactIds.delete(deal.id) : App.state.selectedContactIds.add(deal.id); App.ui.updateContactSelection(); };
                            chkCell.appendChild(chk);
                            row.append(chkCell, createCell(deal.receivedDate || '', 'text-gray-500'), createCell(deal.referer || '', 'text-gray-500'), (() => { const c = document.createElement('td'); c.className = 'px-6 py-4 text-sm'; c.innerHTML = deal.vrn ? `<span class=\"vrn-plate\">${deal.vrn}</span>` : ''; return c; })(), createCell(deal.firstName || '', 'font-medium text-gray-900'), createCell(deal.lastName || '', 'text-gray-500'), createCell(deal.phone || '', 'text-gray-500'), createCell(`£${(parseInt(deal.settlementTotal) || 0).toLocaleString()}`, 'text-gray-500'));
                            on(row, 'click', () => App.ui.openCustomerModalLocked(App.utils.getDealId(deal)));
                        });
                        contactsList.appendChild(frag);
                        App.ui.syncSortControls();
                    },
                    forecasting() {
                        const projCont = getEl('projected-revenue-chart'), prevCont = getEl('previous-performance-chart');
                        projCont.innerHTML = ''; prevCont.innerHTML = '';
                        const PROB_MAP = {
    'Enquiry': 0.0,
    'Packaging': 0.25,
    'Work In Progress': 0.50,
    'Ready To Deal': 1.00,
    'Awaiting Payout': 1.00
};
                        const LEAD_TIME = {
    'Enquiry': 9999,
    'Packaging': 60,
    'Work In Progress': 30,
    'Ready To Deal': 14,
    'Awaiting Payout': 7
};
                        const projData = {}, histData = {};
                        App.state.deals.forEach(d => {
                            if (PROB_MAP[d.dealStage]) {
                                const weightedVal = (parseInt(d.settlementTotal) || 0) * PROB_MAP[d.dealStage];
                                const projDate = new Date(); projDate.setDate(projDate.getDate() + (LEAD_TIME[d.dealStage] || 30));
                                const key = `${projDate.getFullYear()}-${String(projDate.getMonth() + 1).padStart(2, '0')}`;
                                projData[key] = (projData[key] || 0) + weightedVal;
                            }
                            if (d.dealStage === App.config.PAID_OUT_STAGE_ID) {
                                const paidHist = d.stageHistory?.find(h => h.dealStage === App.config.PAID_OUT_STAGE_ID);
                                if (paidHist) {
                                    const paidDate = new Date(paidHist.date);
                                    const key = `${paidDate.getFullYear()}-${String(paidDate.getMonth() + 1).padStart(2, '0')}`;
                                    histData[key] = (histData[key] || 0) + (parseInt(d.settlementTotal) || 0);
                                }
                            }
                        });
                        for (let i = 0; i < 3; i++) {
                            const d = new Date(); d.setMonth(d.getMonth() + i);
                            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            projCont.innerHTML += App.templates.forecastBar(d.toLocaleString('default', { month: 'long' }), projData[key] || 0, 50000);
                        }
                        for (let i = 1; i <= 3; i++) {
                            const d = new Date(); d.setMonth(d.getMonth() - i);
                            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            prevCont.innerHTML += App.templates.forecastBar(d.toLocaleString('default', { month: 'long' }), histData[key] || 0, 50000);
                        }
                    },
                        // =====================================================
                        // GOOGLE DRIVE: Client Files Search
                        // =====================================================
                        // =====================================================
// GOOGLE DRIVE: Client Files (Live Folder Search -> Select -> Files)
// -----------------------------------------------------
// UX model:
//   Step 1 (live): searchFolders    -> returns folder shortlist (top 10)
//   Step 2 (click): getFolderFiles  -> returns files for selected folder
// Notes:
//   - Uses debounce (pause detection) to reduce Apps Script calls.
//   - All folder/file names are escaped via App.utils.escapeHtml().
// =====================================================

    // ===========================================
    // CLIENT FILES: Folder browse/search + file preview
    // ===========================================

    // 1. LIVE SEARCH TRIGGER
    handleLiveSearch(value) {
        if (this.searchTimer) clearTimeout(this.searchTimer);
        const self = this;
        this.searchTimer = setTimeout(() => {
            const query = value ? value.trim() : '';
            self.runFolderSearch(query);
        }, 400);
    },

    // 2. RUN SEARCH (Find Folders)
    async runFolderSearch(query) {
        const listEl = document.getElementById('drive-file-list');
        const countEl = document.getElementById('drive-result-count');

        // Safety check (prevents silent failure)
        if (!listEl) {
            console.error("Missing list element");
            return;
        }

        // Show Loading State
        listEl.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full pt-10">
                <div class="spinner border-t-green-600 w-8 h-8 mb-3"></div>
                <p class="text-sm text-gray-500">${query ? 'Searching...' : 'Loading all folders...'}</p>
            </div>`;

        try {
            // Call Backend
            const res = await App.apiCall('POST', { action: 'searchFolders', query: query });

            if (!res || !res.success) {
                listEl.innerHTML = `<div class="p-4 text-center text-red-500">Error: ${res ? res.error : "Network Error"}</div>`;
                return;
            }

            if (!res.folders || res.folders.length === 0) {
                listEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-500">
                        <p class="font-medium">No matches found</p>
                        <p class="text-xs opacity-75">Try a different name</p>
                    </div>`;
                if (countEl) countEl.classList.add('hidden');
                return;
            }

            if (countEl) {
                countEl.textContent = res.folders.length;
                countEl.classList.remove('hidden');
            }

            // Safe Escape Helper
            const esc = (str) => (App.utils && App.utils.escapeHtml) ? App.utils.escapeHtml(str) : String(str);

            let html = `<div class="p-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Client Folders</div>`;

            res.folders.forEach(folder => {
                html += `
                <div onclick="App.handlers.openClientFolder('${esc(folder.id)}')"
                     class="cursor-pointer p-3 bg-white border-b border-gray-100 hover:bg-green-50 hover:pl-4 transition-all flex items-center gap-3 group">
                    <div class="bg-yellow-100 p-2 rounded-lg group-hover:bg-yellow-200">
                        <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 0 012-2h5l2 2h5a2 0 012 2v6a2 0 01-2 2H4a2 0 01-2-2V6z"/></svg>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-gray-700 group-hover:text-green-800">${esc(folder.name)}</div>
                        <div class="text-[10px] text-gray-400">Updated: ${new Date(folder.updated).toLocaleDateString()}</div>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html;

        } catch (e) {
            console.error(e);
            listEl.innerHTML = `<div class="p-4 text-center text-red-500 text-xs">Render Error: ${e.message}</div>`;
        }
    },

    // 3. OPEN FOLDER (Get Files)
    async openClientFolder(folderId) {
        const listEl = document.getElementById('drive-file-list');
        listEl.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full pt-10">
                <div class="spinner border-t-blue-600 w-8 h-8 mb-3"></div>
                <p class="text-sm text-gray-500">Opening folder...</p>
            </div>`;

        try {
            const res = await App.apiCall('POST', { action: 'getFolderFiles', folderId: folderId });

            if (!res || !res.success || !res.files || res.files.length === 0) {
                listEl.innerHTML = '<div class="p-4 text-center text-gray-400">This folder is empty.</div>';
                return;
            }

            const esc = (str) => (App.utils && App.utils.escapeHtml) ? App.utils.escapeHtml(str) : String(str);

            let html = `
                <div class="flex items-center gap-2 p-3 bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                    <button onclick="App.handlers.runFolderSearch(document.getElementById('drive-search-input').value)"
                            class="text-xs bg-white border border-gray-300 px-2 py-1.5 rounded hover:bg-gray-100 flex items-center gap-1 font-medium text-gray-600">
                        <span>← Back</span>
                    </button>
                    <span class="text-xs font-bold text-gray-800 truncate flex-1">${esc(res.folderName)}</span>
                </div>
                <div class="p-2 space-y-1">`;

            res.files.forEach(file => {
                html += `
                    <div onclick="App.handlers.openDrivePreview('${file.url}'); document.querySelectorAll('.drive-item').forEach(e=>e.classList.remove('bg-blue-50','ring-1','ring-blue-300')); this.classList.add('bg-blue-50','ring-1','ring-blue-300');"
                         class="drive-item cursor-pointer p-3 bg-white border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-all flex items-start gap-3 group">
                        <img src="${file.icon}" class="w-5 h-5 mt-0.5 opacity-80 group-hover:opacity-100">
                        <div class="overflow-hidden">
                            <div class="text-sm font-medium text-gray-700 truncate group-hover:text-blue-700">${esc(file.name)}</div>
                            <div class="text-[10px] text-gray-400 mt-1 flex gap-2">
                                <span>${new Date(file.lastUpdated).toLocaleDateString()}</span>
                                <span>${(file.size/1024).toFixed(0)} KB</span>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            listEl.innerHTML = html;

        } catch (e) {
            console.error(e);
            listEl.innerHTML = `<div class="p-4 text-center text-red-500">Error: ${e.message}</div>`;
        }
    },

                },
                templates: {

    dealCard: (d) => {
        const colorClass = App.ui.getExpertColorClass(d.expert);
        const esc = App.utils.escapeHtml;
const isDealReady = ['docID','docV5C','docSettlement'].every(f => d[f] === true || d[f] === 'true');

        const experts = ['', 'Kyle', 'Jordan (IOU)', 'Mills', 'Kurt', 'Umar', 'Austin'];

        const curPay = (parseFloat(d.currentMonthlyPayment) || 0);
        const curPayDisplay = curPay ? `£${curPay.toLocaleString()}` : (d.settlementTotal ? `£${(parseInt(d.settlementTotal)||0).toLocaleString()}` : '—');
        const postcode = d.currentPostcode || d.postcode || d.postCode || '';
        const currentApr = (d.currentApr ?? d.current_apr ?? '').toString();
        const vrn = d.vrn || '';
        const agreement = ((d.id ?? '') !== '' ? String(d.id) : '') || d.agreementNumber || '';
        const rawDob = d.dob || d.dateOfBirth || '';

        const toYMD = (val) => {
            if (!val) return '';
            if (typeof val === 'number') {
                const ms = Math.round((val - 25569) * 86400 * 1000);
                const d = new Date(ms);
                if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }
            const s = String(val).trim();
            let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
            if (m) {
                const d = new Date(+m[1], +m[2]-1, +m[3]);
                if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }
            m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})$/);
            if (m) {
                let d1 = +m[1], d2 = +m[2], y = +m[3]; if (y < 100) y += 1900;
                const d = new Date(y, d2-1, d1);
                if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }
            const d = new Date(s);
            if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            return s;
        };
        const dob = toYMD(rawDob);

        const reason = d.reasonCode || '';

        const tgl = (lbl, field, val) => {
            const on = (val === true || val === 1 || val === '1' || (typeof val === 'string' && val.toLowerCase() === 'true'));
            return `<div class="flex items-center justify-end gap-2"><span class="toggle-label">${lbl}</span><button type="button" class="doc-toggle toggle ${on ? 'toggle-green' : 'toggle-red'}" data-field="${field}" data-state="${on ? 'true' : 'false'}">${on ? '✓' : '✗'}</button></div>`;
        };

        return `
        <div class="kanban-card text-gray-800 rounded-lg px-1 py-[0.2375rem] shadow ${colorClass} ${isDealReady ? 'deal-ready' : ''}" draggable="true" data-deal-id="${esc(App.utils.getDealId(d) || App.utils.getVrn(d) || d.id || d.ID || d.Id || d.dealId || d.dealID || d.DealId || d.DealID || '')}">
          <div class="grid grid-cols-3 gap-0 card-gap-tight text-[11px] leading-tight items-start">
            <div class="flex flex-col">
              <p class="font-semibold text-[13px] truncate">${esc(d.lastName || 'Unnamed')}</p>
              <div class="text-[10px] text-gray-500 font-medium truncate">${esc(postcode || '')}</div>
            </div>
            <div class="flex items-center justify-center">
              ${vrn ? ('<span class="vrn-plate">' + esc(vrn) + '</span>') : ''}
            </div>
            <div class="text-right">
              <select
                class="inline-edit w-full border rounded px-1 py-0.5 text-[11px]"
                data-field="reasonCode"
              >
                <option value="" ${!reason ? 'selected' : ''}>NTU Reason</option>
<option value="Declined - Credit/Afford." ${reason === 'Declined - Credit/Afford.' ? 'selected' : ''}>Declined - Credit/Afford.</option>
<option value="Declined - Vehicle/Age-Mileage" ${reason === 'Declined - Vehicle/Age-Mileage' ? 'selected' : ''}>Declined - Vehicle/Age-Mileage</option>
<option value="Will Not Proceed" ${reason === 'Will Not Proceed' ? 'selected' : ''}>Will Not Proceed</option>
<option value="Car Write-Off/Mech. Issues" ${reason === 'Car Write-Off/Mech. Issues' ? 'selected' : ''}>Car Write-Off/Mech. Issues</option>
<option value="No Contact for 10+ attempts" ${reason === 'No Contact for 10+ attempts' ? 'selected' : ''}>No Contact for 10+ attempts</option>
<option value="Savings Too Low" ${reason === 'Savings Too Low' ? 'selected' : ''}>Savings Too Low</option>
<option value="Refused Documents" ${reason === 'Refused Documents' ? 'selected' : ''}>Refused Documents</option>
<option value="Max Advanced" ${reason === 'Max Advanced' ? 'selected' : ''}>Max Advanced</option>
<option value="New Rate Too High" ${reason === 'New Rate Too High' ? 'selected' : ''}>New Rate Too High</option>
<option value="Min Advance Too Low" ${reason === 'Min Advance Too Low' ? 'selected' : ''}>Min Advance Too Low</option>
<option value="Min Term Too Low" ${reason === 'Min Term Too Low' ? 'selected' : ''}>Min Term Too Low</option>
</select>

            </div>

            <div class="uppercase tracking-wide text-[10px] text-gray-500 font-semibold mt-[0.2375rem]">OLD</div>
            <div class="uppercase tracking-wide text-[10px] text-gray-500 font-semibold mt-[0.2375rem]">NEW</div>
            <div class=""></div>

            <div><input type="number" step="1" class="inline-edit w-full border rounded px-1 py-0.5 text-[11px]" placeholder="Payment" data-field="oldPayment" data-key="oldPayment"data-field="oldPayment" value="${esc(d.oldPayment || '')}" / onblur="(function(el){App.handlers.inlineEdit(el); var n=toNumber(el.value,0); el.value = n ? fmtGBP0.format(n) : ''; })(this)"></div>
            <div><input type="number" step="0.01" class="inline-edit w-full border rounded px-1 py-0.5 text-[11px] currency-bold" placeholder="Payment" data-field="newPayment" data-key="newPayment"data-field="newPayment" value="${esc(d.newPayment || '')}" / onblur="(function(el){App.handlers.inlineEdit(el); var n=toNumber(el.value,0); el.value = n ? fmtGBP0.format(n) : ''; })(this)"></div>
            <div>${tgl('ID','docID', d.docID)}</div>

            <div class="h-[24.7px] flex items-center"><div class="w-full border rounded px-1 py-0.5 text-[11px] bg-gray-50 text-gray-700 text-right">${currentApr ? `${currentApr}%` : ``}</div></div>
            <div><input type="text" inputmode="decimal" class="inline-edit w-full border rounded px-1 py-0.5 text-[11px]" placeholder="APR" data-apr text-right w-full border rounded px-1 py-0.5 text-[11px]" placeholder="APR" data-field="newApr" data-key="newApr"data-field="newApr" value="${ensurePercent(d.newApr)}" onfocus="this.value = String(this.value).replace('%', '')" onblur="(function(el){ const n = toNumber(el.value, 2); el.value = String(n); el.dispatchEvent(new Event('change', {bubbles:true})); el.value = ensurePercent(n); })(this)" / onfocus="this.value=String(this.value).replace('%','')" onblur="(function(el){App.handlers.inlineEdit(el);var n=toNumber(el.value,2); el.value=ensurePercent(n);})(this)"></div>
            <div>${tgl('V5','docV5C', d.docV5C)}</div>

            <div><input type="number" step="0.01" class="inline-edit w-full border rounded px-1 py-0.5 text-[11px]" placeholder="Settlement" data-field="settlementTotal" data-key="settlementTotal"data-field="settlementTotal" value="${esc(d.settlementTotal || '')}" / onblur="(function(el){App.handlers.inlineEdit(el); var n=toNumber(el.value,2); el.value = n ? fmtGBP2.format(n) : ''; })(this)">
  <div class="label-xs text-right mt-0.5">Settlement</div>
</div>
            <div><input type="number" step="0.01" class="inline-edit w-full border rounded px-1 py-0.5 text-[11px] currency-bold" placeholder="Savings" data-field="savings" data-key="savings"data-field="savings" value="${esc(d.savings || '')}" / onblur="(function(el){App.handlers.inlineEdit(el); var n=toNumber(el.value,0); el.value = n ? fmtGBP0.format(n) : ''; })(this)">
  <div class="label-xs text-right mt-0.5">Savings</div>
</div>
            <div>${tgl('Settle','docSettlement', d.docSettlement)}</div>

            <div></div>
            <div></div>
            <div>${tgl('Direct Debit','docBankD', (d.docBankD ?? d['docBankD'] ?? d.cbPackagers ?? d.packagers ?? d.Packagers ?? d['CB-Packagers'] ?? d['CB -Packagers'] ?? d['CB - Packagers']))}</div>

            <div>
              <select class="expert-select text-[11px] bg-white border border-gray-300 rounded px-1 py-0.5 w-full" style="margin-top:-2px">
                ${['', 'Kyle', 'Jordan (IOU)', 'Mills', 'Kurt', 'Umar', 'Austin'].map(name => `<option value="${esc(name || '')}" ${d.expert === name ? 'selected' : ''}>${esc(name || 'Expert...')}</option>`).join('')}
              </select>
            </div>
            <div>
              <select class="deal-stage-select text-[11px] bg-white border border-gray-300 rounded px-1 py-0.5 w-full" style="margin-top:-2px">
                ${App.state.stages.map(s => `<option value="${esc(s.id)}" ${d.dealStage === s.id ? 'selected' : ''}>${esc(s.title)}</option>`).join('')}
              </select>
            </div>
            <div class="text-right text-[12px] font-mono text-gray-600">${esc(agreement)}</div>
          </div>
        </div>`;
    },
    formField:

 (id, label, type = 'text') => {
                        const isReadOnly = (App.config.READONLY_FIELDS && App.config.READONLY_FIELDS.includes(id));
                        const roAttr = isReadOnly ? 'readonly' : '';
                        const roClass = isReadOnly ? ' bg-gray-100 text-gray-700 cursor-not-allowed' : '';
                        const fieldMap = { 'textarea': `<textarea id="${id}" name="${id}" class="input-field${roClass}" ${roAttr}></textarea>`, 'select': `<select id="${id}" name="${id}" class="input-field${roClass}" ${roAttr}></select>`, 'checkbox': `<input type="checkbox" id="${id}" name="${id}" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">`, 'default': `<input type="${type}" id="${id}" name="${id}" class="input-field${roClass}" ${roAttr}>` };
                        if (type === 'checkbox') {
  if (id === 'isRefinance') {
    return `<label for="${id}" class="flex items-center gap-2">${fieldMap[type]} <span id="isRefinanceLabel" class="refinance-label-box">${label}</span></label>`;
  }
  return `<label for="${id}" class="flex items-center gap-2">${fieldMap[type]} ${label}</label>`;
}
return `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label>${fieldMap[type] || fieldMap['default']}</div>`;
},
                    forecastBar: (label, val, max) => `<div><div class="flex justify-between mb-1"><span class="text-base font-medium text-gray-700">${label}</span><span class="text-sm font-medium text-gray-700">£${Math.round(val||0).toLocaleString('en-GB')}</span></div><div class="w-full bg-gray-200 rounded-full h-4"><div class="h-4 rounded-full bg-[var(--gold-orange)]" style="width: ${max > 0 ? Math.min((val / max) * 100, 100) : 0}%;"></div></div></div>`,
                },
                ui: {
                    switchView(view) {
                        App.state.currentView = view;
                        App.elements.navTabs.forEach(t => toggleClass(t, 'active', t.dataset.view === view));
                        App.elements.views.forEach(v => toggleClass(v, 'hidden', v.id !== `${view}-view`));
                        this.updateHeader(view);
                        if (view === 'forecasting') App.render.forecasting();
                        if (view === 'contacts' && !App.state.resizersSetup) {
                            requestAnimationFrame(() => {
                                enableContactsColumnResize();
                                App.state.resizersSetup = true;
                            });
                        }
                    },
                    updateHeader(view) {
                        const titles = { pipeline: 'Sales Pipeline', contacts: 'Contacts', forecasting: 'Forecasting', data: 'Data Management' };
                        setTxt('pageTitle', titles[view]);
                        while (App.elements.titleAndButtonsWrapper.children.length > 1) App.elements.titleAndButtonsWrapper.removeChild(App.elements.titleAndButtonsWrapper.lastChild);
                        if (view === 'pipeline') {
                            const addBtn = Object.assign(document.createElement('button'), { id: 'addDealBtn', className: 'text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:opacity-90 transition-opacity bg-[var(--gold-orange)]', innerHTML: `<i class="fas fa-plus mr-2"></i>Add Deal` });
                            const manageBtn = Object.assign(document.createElement('button'), { id: 'manageStagesBtn', className: 'text-green-900 font-semibold py-2 px-4 rounded-lg shadow-md hover:opacity-90 transition-opacity bg-yellow-400', innerHTML: `<i class="fas fa-edit mr-2"></i>Manage Stages` });
                            on(addBtn, 'click', () => this.openCustomerModal());
                            on(manageBtn, 'click', () => this.openModal('manageStages'));
                            App.elements.titleAndButtonsWrapper.append(addBtn, manageBtn);
                        }
                    },
                    updateConnectionStatus(status) {
                        const icon = App.elements.connectionStatusIcon, text = App.elements.connectionStatusText;
                        if (!icon || !text) return;
                        icon.className = `fas fa-circle`; text.classList.remove('text-red-600', 'text-green-600', 'text-yellow-600');
                        if (status === 'connected') { icon.classList.add('text-green-600'); text.textContent = `Connection: Connected (Ping: ${App.state.pingLatency}ms)`; }
                        else if (status === 'failed') { icon.classList.add('text-red-600'); text.textContent = 'Connection: Failed'; }
                        else { icon.classList.add('text-yellow-600'); text.textContent = 'Connection: Checking...'; }
                    },
                    openModal(name) {
                        if (name === 'manageStages') this.populateStageManagement();
                        toggleClass(getEl(`${name}Modal`), 'hidden', false);
                        toggleClass(getEl(`${name}Modal`), 'flex', true);
                        if (name === 'customer') {
                            // Ensure Close control is always present/visible after showing
                            this.ensureCustomerCloseButton();
                            setTimeout(() => this.ensureCustomerCloseButton(), 0);
                        }
                    },
                    closeModal(name) {
                        toggleClass(getEl(`${name}Modal`), 'hidden', true);
                        toggleClass(getEl(`${name}Modal`), 'flex', false);
                        if (name === 'customer') {
                            const id = String(App.lock.currentDealId || (App.elements.dealId && App.elements.dealId.value) || '').trim();
                            if (id) App.lock.release(id);
                        }
                    },
                    closeAllModals() { $$('[id$="Modal"]').forEach(el => { toggleClass(el, 'hidden', true); toggleClass(el, 'flex', false); }); },
                    ensureCustomerCloseButton() {
                        const titleEl = getEl('modalTitle');
                        const headerEl = titleEl ? (titleEl.parentElement || null) : null;
                        if (!headerEl) return;

                        // Ensure the top-right action container exists in the header
                        let actions = getEl('customerModalTopActions');
                        if (!actions) {
                            actions = document.createElement('div');
                            actions.id = 'customerModalTopActions';
                            actions.className = 'absolute right-4 top-4 flex items-center gap-2 z-50';
                            headerEl.appendChild(actions);
                        } else if (actions.parentElement !== headerEl) {
                            headerEl.appendChild(actions);
                        }

                        // Ensure PSE and PRINT PDF buttons live in the top-right actions
                        let pseBtnTop = getEl('pseShortcutBtn');
                        if (!pseBtnTop) {
                            pseBtnTop = document.createElement('button');
                            pseBtnTop.type = 'button';
                            pseBtnTop.id = 'pseShortcutBtn';
                            pseBtnTop.title = "Open Product Source & DNS with this application's VRN";
                            pseBtnTop.className = 'bg-green-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2 shadow-sm';
                            pseBtnTop.innerHTML = '<span class="font-bold">PSE</span>';
                        }

                        let printBtn = getEl('printApplicationPdfBtn');
                        if (!printBtn) {
                            printBtn = document.createElement('button');
                            printBtn.type = 'button';
                            printBtn.id = 'printApplicationPdfBtn';
                            printBtn.title = 'Generate a PDF of the full application';
                            printBtn.className = 'bg-gray-700 text-white font-semibold px-3 py-1.5 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2 shadow-sm';
                            printBtn.innerHTML = '<i class="fas fa-print"></i><span>Print PDF</span>';
                        }

                        // Ensure they're mounted in the top actions (some re-render paths can detach them)
                        if (pseBtnTop.parentElement !== actions) actions.appendChild(pseBtnTop);
                        if (printBtn.parentElement !== actions) actions.appendChild(printBtn);

                        // Ensure CLOSE button exists and is positioned to the right
                        let btn = getEl('closeCustomerModal');

                        // Re-create if missing (some flows may re-render the header)
                        if (!btn) {
                            btn = document.createElement('button');
                            btn.type = 'button';
                            btn.id = 'closeCustomerModal';
                            btn.className = 'flex items-center gap-2 text-sm font-semibold px-3 py-1.5 rounded-lg border border-gray-200 bg-white shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500';
                            btn.innerHTML = '<span>Close</span><span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-50"><i class="fas fa-times text-red-600"></i></span>';
                        }

                        // Ensure it's mounted in the top actions (some re-render paths can detach it)
                        if (btn.parentElement !== actions) actions.appendChild(btn);

                        // Enforce button order: [PSE] [PRINT PDF] [CLOSE]
                        // (Flex row, so DOM order matters.)
                        if (actions.firstElementChild !== pseBtnTop) {
                            actions.insertBefore(pseBtnTop, actions.firstElementChild);
                        }
                        if (pseBtnTop.nextElementSibling !== printBtn) {
                            actions.insertBefore(printBtn, pseBtnTop.nextElementSibling);
                        }
                        if (printBtn.nextElementSibling !== btn) {
                            actions.insertBefore(btn, printBtn.nextElementSibling);
                        }

// Force visibility and clickability
                        btn.classList.remove('hidden');
                        btn.style.display = 'flex';
                        btn.style.visibility = 'visible';
                        btn.style.pointerEvents = 'auto';

                        // Bind click each time (simple + robust)
                        btn.onclick = (e) => { e.preventDefault(); this.closeModal('customer'); };
                    },

                    
                    async openCustomerModalLocked(dealId) {
                        const id = String(dealId || '').trim();

                        if (!App.lock.enabled) {
                            // Locking disabled: open immediately
                            return this.openCustomerModal(id || null);
                        }
                        // Creating a new record (no lock needed)
                        if (!id) return this.openCustomerModal();

                        // If switching records, release previous lock first
                        if (App.lock.currentDealId && App.lock.currentDealId !== id) {
                            await App.lock.release(App.lock.currentDealId);
                        }

                        showNavMessage('Checking lock…', 'info');

                        let lockResult = null;
                        try {
                            lockResult = await App.lock.acquire(id);
                        } catch (e) {
                            lockResult = null;
                        }

                        // Normalize backend shapes: {success}, {ok}, {status:"ACQUIRED"/"RENEWED"}
                        const status = lockResult ? String(lockResult.status || '').toUpperCase() : '';
                        const acquired = !!(
                            (lockResult && lockResult.success) ||
                            (lockResult && lockResult.ok) ||
                            status === 'ACQUIRED' ||
                            status === 'RENEWED'
                        );

                        const isLocked = !!(lockResult && String(lockResult.error || lockResult.status || '').toUpperCase() === 'LOCKED');

                        if (acquired) {
                            App.lock.currentDealId = id;
                            App.lock.startHeartbeat(id);
                            showNavMessage('Lock acquired', 'success');
                            return this.openCustomerModal(id);
                        }

                        // Locked: generic message (no identities)
                        if (isLocked) {
                            showNavMessage('Locked', 'error');
                            alert('This card is currently locked. Please try again shortly.');
                            return null;
                        }

                        // Fail-open: if lock service is unavailable or returned an unexpected response,
                        // allow the modal to open rather than blocking edits for a single-operator workflow.
                        console.warn('Lock check unavailable/unexpected; opening without lock:', lockResult);
                        showNavMessage('Lock unavailable (opened anyway)', 'info');
                        return this.openCustomerModal(id);
                    },

                    openCustomerModal(id = null) {
                        // 1. Resolve the record robustly (supports legacy keys and accidental VRN-as-id wiring)
                        const requested = (id !== null && id !== undefined && String(id).trim() !== '') ? String(id).trim() : '';
                        let resolvedId = requested;
                        let dealData = requested
                            ? App.state.deals.find(d => String(App.utils.getDealId(d)) === requested)
                            : null;

                        // If not found by canonical ID, try matching by VRN (e.g., if a DOM data attribute was populated with VRN)
                        if (!dealData && requested) {
                            const normReqVrn = requested.toUpperCase().replace(/\s/g,'').trim();
                            dealData = App.state.deals.find(d => App.utils.getVrn(d) === normReqVrn) || null;
                            if (dealData) {
                                const canonical = App.utils.getDealId(dealData);
                                if (canonical) resolvedId = canonical;
                            }
                        }

                        
                        // === SAFETY (A): prevent blank-save while modal is hydrating ===
                        const _editingExisting = !!requested;
                        App.state = App.state || {};
                        App.state.customerModalHydrated = !_editingExisting; // add-mode is considered hydrated
                        const _saveBtn = getEl('saveDealBtn');
                        const _setSaveEnabled = (enabled) => {
                            if (!_saveBtn) return;
                            _saveBtn.disabled = !enabled;
                            _saveBtn.classList.toggle('opacity-50', !enabled);
                            _saveBtn.classList.toggle('cursor-not-allowed', !enabled);
                            _saveBtn.title = enabled ? '' : 'Loading application data…';
                        };
                        _setSaveEnabled(!_editingExisting);
// 3. If an ID was provided but we couldn't find a record, don't fall back to Add mode
                        if (requested && !dealData) {
                            console.error('Deal not found for id:', id);
                            showNavMessage('Cannot edit: contact not found. Try reloading data.', 'error');
                            return;
                        }

                        
// 2. Reset form and populate dropdowns
                        App.elements.customerForm.reset();
                        this.ensureCustomerCloseButton();
                        if (App.jigsaw && typeof App.jigsaw.updateStatusFromDeal === 'function') App.jigsaw.updateStatusFromDeal(dealData);
                        if (App.carMoney && typeof App.carMoney.updateStatusFromDeal === 'function') App.carMoney.updateStatusFromDeal(dealData);
                        if (App.cf247 && typeof App.cf247.updateStatusFromDeal === 'function') App.cf247.updateStatusFromDeal(dealData);
                        this.populateStageDropdown();
                        this.populateExpertDropdown(dealData ? dealData.expert : null);

                        
// 4. Set the Modal Title & Style
                        const modalTitleEl = getEl('modalTitle');
                        const headerEl = modalTitleEl ? (modalTitleEl.parentElement || null) : null;
                        if (dealData) {
                            setTxt('modalTitle', `APPLICATION: ${(dealData.firstName || '').trim()} ${(dealData.lastName || '').trim()} (${dealData.vrn || 'No VRN'})`);
                            if (headerEl && headerEl.classList) {
                                headerEl.classList.remove('bg-gray-50');
                                headerEl.classList.add('bg-blue-50');
                            }
                        } else {
                            setTxt('modalTitle', 'ADD NEW DEAL');
                            if (headerEl && headerEl.classList) {
                                headerEl.classList.remove('bg-blue-50');
                                headerEl.classList.add('bg-gray-50');
                            }
                        }

                        // 5. Handle Delete Button Visibility
                        toggleClass(App.elements.deleteDealBtn, 'hidden', !id);

                        // 6. Set the hidden ID field (Crucial for write-back)
                        setVal('dealId', resolvedId || '');

                        // 7. Populate the form or set defaults
                        if (dealData) {
                            // Auto-fill API application data (and write-back to sheet) on modal open
                            if (App.handlers && typeof App.handlers.ensureApiFieldsOnOpen === 'function') App.handlers.ensureApiFieldsOnOpen(dealData);
                            // Ensure canonical jigsawId is populated even if backend uses JigsawReference
                            try {
                                if (dealData && (!dealData.jigsawId || String(dealData.jigsawId).trim()==='')) {
                                    const jr = (dealData.JigsawReference ?? dealData.jigsawReference ?? dealData.JigsawRef ?? dealData.jigsawRef);
                                    if (jr !== undefined && jr !== null && String(jr).trim() !== '') dealData.jigsawId = String(jr).trim();
                                }
                            } catch(e) { /* no-op */ }
                            this.setFormData(dealData);
                            // === SAFETY (A): mark hydrated and enable Save ===
                            try {
                                App.state.customerModalHydrated = true;
                                const _saveBtn2 = getEl('saveDealBtn');
                                if (_saveBtn2) {
                                    _saveBtn2.disabled = false;
                                    _saveBtn2.classList.remove('opacity-50','cursor-not-allowed');
                                    _saveBtn2.title = '';
                                }
                            } catch(e) { /* no-op */ }

                            // ===== Forced Source Sheet -> Letter Template mappings (non-conditional) =====
                            try {
                                // Persist Source Sheet fields for letter preview
                                if (!window.sourceSheetReceivedDate) window.sourceSheetReceivedDate = dealData.receivedDate || '';
                                // Prefer term captured from Source Sheet payload mapping; fallback to dealData.term
                                if (window.sourceSheetTerm === undefined || window.sourceSheetTerm === null || window.sourceSheetTerm === '') {
                                    window.sourceSheetTerm = (dealData.term !== undefined && dealData.term !== null) ? dealData.term : '';
                                }
                                if (getEl('ltr_current-term')) setVal('ltr_current-term', window.sourceSheetTerm ? String(window.sourceSheetTerm) : '');

                                // Reference Number should come from Source Sheet 'id' header (NOT referer)
                                if (getEl('ltr_reference-number')) setVal('ltr_reference-number', dealData.id || '');

                                // Time in Employment (total months) forced from Source Sheet values
                                const empY = parseInt((getVal('employmentYears') || dealData.employmentYears || (dealData.affordability && dealData.affordability.employmentYears) || 0), 10) || 0;
                                const empM = parseInt((getVal('employmentMonths') || dealData.employmentMonths || (dealData.affordability && dealData.affordability.employmentMonths) || 0), 10) || 0;
                                const totalEmpMonths = (empY * 12) + empM;
                                const empText = totalEmpMonths > 0 ? `${totalEmpMonths} month${totalEmpMonths === 1 ? '' : 's'}` : '';
                                if (getEl('ltr_time-in-employment')) setVal('ltr_time-in-employment', empText);
                                // Trigger a letter preview refresh (so date + remaining term update immediately)
                                if (typeof updateLetterPreview === 'function') updateLetterPreview();
                            } catch (e) {
                                console.warn('Forced Source Sheet letter mappings failed:', e);
                            }
                            // ===== End forced mappings =====

                            try {
                                if (App.handlers && typeof App.handlers.setupNotesAutoDate === 'function') App.handlers.setupNotesAutoDate();
                                if (typeof relayoutNotesSection === 'function') relayoutNotesSection();
                            } catch (e) { /* no-op */ }

                            if (App.utils && typeof App.utils.applyApiAutofillFields === 'function') App.utils.applyApiAutofillFields(dealData, { updateDom: true });
                        } else {
                            // Default stage if adding new
                            if (App.elements.dealStage) {
                                setVal('dealStage', App.state.stages.find(s => s.id === App.config.CONTACT_STAGE_ID)?.id || '');
                            }
                        }

                        // 8. Show the modal
                        this.openModal('customer');
                        // Auto-fill Savings if empty: (Old Payment - New Payment) * Term
                        try {
                            const savingsEl = getEl('savings');
                            const savingsVal = savingsEl ? String(savingsEl.value || '').trim() : String(getVal('savings') || '').trim();
                            if (!savingsVal) {
                                const np = toNumber(getVal('newPayment'), 2);
                                const op = toNumber(getVal('oldPayment'), 2);
                                const t  = toNumber(getVal('term'), 0);
                                if (Number.isFinite(np) && Number.isFinite(op) && np > 0 && op > 0 && Number.isFinite(t) && t > 0) {
                                    const calc = (op - np) * t;
                                    if (Number.isFinite(calc)) {
                                        // Savings is displayed as GBP (0dp) in UI
                                        setVal('savings', fmtGBP0.format(calc));
                                    }
                                }
                            }
                        } catch (e) { /* no-op */ }

                        // Reset scroll so header/Close is always visible on reopen
                        const _formScroll = getEl('customerForm');
                        if (_formScroll) _formScroll.scrollTop = 0;

                        // Safety: some browsers/layout passes can drop the Close control after re-open
                        this.ensureCustomerCloseButton();
                        setTimeout(() => this.ensureCustomerCloseButton(), 50);
                    },
                    setFormData(data) {
    // Back-compat: tolerate differing header/field naming (spaces, Title Case, etc.)
    // and ensure date inputs render when values exist.
    if (!data) data = {};

    const normKey = (k) => String(k).toLowerCase().replace(/[\s_\-]/g, '');

    // Map normalized keys -> actual keys present on the record
    const keyMap = {};
    try {
        Object.keys(data).forEach(k => { keyMap[normKey(k)] = k; });
    } catch (e) { /* no-op */ }

    const variantsFor = (fieldId) => {
        const capFirst = fieldId ? (fieldId.charAt(0).toUpperCase() + fieldId.slice(1)) : fieldId;
        const spaced = String(fieldId).replace(/([A-Z])/g, ' $1').replace(/\s+/g, ' ').trim();           // notes1 Date
        const spacedTitle = spaced ? (spaced.charAt(0).toUpperCase() + spaced.slice(1)) : spaced;        // Notes1 Date
        const noSpaceTitle = spacedTitle ? spacedTitle.replace(/\s+/g, '') : spacedTitle;                // Notes1Date
        return [fieldId, capFirst, spaced, spacedTitle, noSpaceTitle];
    };

    const getAny = (fieldId) => {
        // Special-case: Jigsaw ID is sometimes stored as JigsawReference in the backend/sheet
        if (fieldId === 'jigsawId') {
            const candidates = ['jigsawId','JigsawId','jigsawID','JIGSAW ID','JIGSAWID','JigsawReference','jigsawReference','JigsawRef','jigsawRef'];
            for (const c of candidates) {
                if (Object.prototype.hasOwnProperty.call(data, c)) {
                    const v = data[c];
                    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
                }
                const nk = normKey(c);
                const actual = keyMap[nk];
                if (actual && Object.prototype.hasOwnProperty.call(data, actual)) {
                    const v2 = data[actual];
                    if (v2 !== undefined && v2 !== null && String(v2).trim() !== '') return v2;
                }
            }
        }

        // 1) Exact + common variants
        for (const v of variantsFor(fieldId)) {
            if (v && Object.prototype.hasOwnProperty.call(data, v)) {
                const val = data[v];
                if (val !== undefined && val !== null && String(val).trim() !== '') return val;
            }
        }
        // 2) Normalized lookup (case/space/underscore/hyphen insensitive)
        for (const v of variantsFor(fieldId)) {
            const nk = normKey(v);
            const actual = keyMap[nk];
            if (actual && Object.prototype.hasOwnProperty.call(data, actual)) {
                const val = data[actual];
                if (val !== undefined && val !== null && String(val).trim() !== '') return val;
            }
        }
        return '';
    };

    // Back-compat: sync drivingLicense <-> drivingLicenceType
    const dl = getAny('drivingLicense');
    const dlt = getAny('drivingLicenceType');

    // Fill known headers (keeps existing tab wiring/ids intact)
    App.config.ALL_CSV_HEADERS.forEach((fieldId) => {
        const input = App.elements.customerForm.elements[fieldId];
        if (!input) return;

        let value = getAny(fieldId);

        // Apply driving license aliasing at display time (without forcing a write-back)
        if (fieldId === 'drivingLicenceType' && (!value || String(value).trim() === '') && dl) value = dl;
        if (fieldId === 'drivingLicense' && (!value || String(value).trim() === '') && dlt) value = dlt;

        // Normalise date-only fields to YYYY-MM-DD (strip any time component)
        if ((fieldId === 'agreementStartDate' || fieldId === 'receivedDate') && value) {
            let s = String(value).trim();
            if (/^\d{4}-\d{2}-\d{2}T/.test(s)) s = s.split('T')[0];
            if (/^\d{4}-\d{2}-\d{2}\s/.test(s)) s = s.slice(0, 10);
            if (/^\d{2}\/\d{2}\/\d{4}/.test(s)) {
                const parts = s.split(/[\s\/]/);
                const d = parts[0], m = parts[1], y = parts[2];
                s = `${y}-${m}-${d}`;
            }
            value = s;
        }

        // Normalise DOB (supports YYYY-MM-DD and ISO timestamps) to DD/MM/YYYY for display
        if (fieldId === 'dob' && value) {
            let s = String(value).trim();
            if (/^\d{4}-\d{2}-\d{2}T/.test(s)) s = s.split('T')[0];
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                const [y, m, d] = s.split('-');
                value = `${d}/${m}/${y}`;
            }
        }

        // Normalise any <input type="date"> values so the browser actually renders them.
// Accepts ISO (YYYY-MM-DD), ISO timestamps, UK/European DD/MM/YYYY (with or without leading zeros),
// and Excel/Sheets serial day numbers.
        if (input.type === 'date') {
            if (!input.dataset.dateFromUK) input.dataset.dateFromUK = '0';

            const pad2 = (n) => String(n).padStart(2, '0');

            const excelSerialToISO = (serial) => {
                const n = Number(serial);
                if (!Number.isFinite(n)) return '';
                // Heuristic: treat large day counts as serial dates (e.g. Google Sheets / Excel)
                if (n < 20000) return '';
                const base = Date.UTC(1899, 11, 30); // Excel/Sheets day 0 (compatible with Google Sheets)
                const dt = new Date(base + (n * 86400000));
                if (isNaN(dt.getTime())) return '';
                return `${dt.getUTCFullYear()}-${pad2(dt.getUTCMonth() + 1)}-${pad2(dt.getUTCDate())}`;
            };

            const ukToISO = (d, m, y) => {
                let yy = String(y);
                if (yy.length === 2) yy = String(2000 + Number(yy));
                return `${yy}-${pad2(m)}-${pad2(d)}`;
            };

            if (value !== undefined && value !== null && String(value).trim() !== '') {
                const sRaw = String(value).trim();

                // Numeric serial dates -> ISO
                const serialISO = excelSerialToISO(sRaw);
                if (serialISO) {
                    value = serialISO;
                    input.dataset.dateFromUK = '0';
                } else {
                    let s = sRaw;

                    // ISO timestamp -> date only
                    if (/^\d{4}-\d{1,2}-\d{1,2}T/.test(s)) s = s.split('T')[0];
                    if (/^\d{4}-\d{1,2}-\d{1,2}\s/.test(s)) s = s.slice(0, 10);

                    // Normalise ISO YYYY-M-D -> YYYY-MM-DD
                    const isoParts = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                    if (isoParts) {
                        const y = isoParts[1], mo = isoParts[2], d = isoParts[3];
                        s = `${y}-${pad2(mo)}-${pad2(d)}`;
                        input.dataset.dateFromUK = '0';
                        value = s;
                    } else {
                        // UK/European D/M/YYYY or D-M-YYYY or D.M.YYYY (leading zeros optional)
                        const ukParts = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2}|\d{4})(?:\b.*)?$/);
                        if (ukParts) {
                            const d = ukParts[1], mo = ukParts[2], y = ukParts[3];
                            s = ukToISO(d, mo, y);
                            input.dataset.dateFromUK = '1';
                            value = s;
                        } else {
                            // Pass through anything else; invalid values will simply render as empty.
                            input.dataset.dateFromUK = '0';
                            value = s;
                        }
                    }
                }
            }
        }

        if (input.type === 'checkbox') {
            const s = (value === null || value === undefined) ? '' : String(value).trim().toLowerCase();
            input.checked = (value === true) || (s === 'true') || (s === 'yes') || (s === '1') || (s === 'y') || (s === 'on') || (s === 't');
        } else {
            input.value = value || '';
        }
    });

    // Deal stage selector (accept variant keys too)
    const stageVal = getAny('dealStage');
    if (stageVal && App.elements.dealStage) setVal('dealStage', stageVal);
},
getFormData(
) {
                        const data = {};
                        App.config.ALL_CSV_HEADERS.forEach(f => {
                            const i = App.elements.customerForm.elements[f];
                            if (!i) return;

                            if (i.type === 'checkbox') {
                                data[f] = i.checked;
                                return;
                            }

                            let v = i.value;

                            // Notes date fields: allow <input type="date"> to display correctly (ISO),
                            // but if this record originally came from a UK DD/MM/YYYY string, save it back in UK format.
                            if (/^notes[1-3]Date$/.test(f) && i.type === 'date' && v) {
                                const fromUK = (i.dataset && i.dataset.dateFromUK === '1');
                                if (fromUK && /^\d{4}-\d{2}-\d{2}$/.test(v)) {
                                    const [y, m, d] = v.split('-');
                                    v = `${d}/${m}/${y}`;
                                }
                            }

                            data[f] = v;
                        });
                        data.dealId = getVal('dealId');
                        // Back-compat aliasing
                        if (data.drivingLicense !== undefined && (data.drivingLicenceType === undefined || data.drivingLicenceType === '')) data.drivingLicenceType = data.drivingLicense;
                        if (data.drivingLicenceType !== undefined && (data.drivingLicense === undefined || data.drivingLicense === '')) data.drivingLicense = data.drivingLicenceType;
                        return data;
                    },
                    buildCustomerForm() {
                        let html = '';
                        for (const legend in App.config.FORM_SECTIONS) {
                            if (legend === 'API APPLICATION DATA') {
                                if (legend === 'API APPLICATION DATA') {
                                html += `<fieldset class="border p-4 rounded-md"><legend class="px-2 font-semibold text-lg flex items-center justify-between"><span>${legend}</span><button type="button" id="toggleApiAppData" class="px-3 py-1 rounded-md border text-sm">SHOW</button></legend><div id="apiAppDataBody" style="display:none" class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
                            } else {
                                html += `<fieldset class="border p-4 rounded-md"><legend class="px-2 font-semibold text-lg">${legend}</legend><div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
                            }
                            } else {
                                html += `<fieldset class="border p-4 rounded-md"><legend class="px-2 font-semibold text-lg">${legend}</legend><div class="grid grid-cols-1 md:grid-cols-3 gap-4">`;
                            }
                            App.config.FORM_SECTIONS[legend].forEach(fieldId => {
                                const label = (App.config.FIELD_LABEL_MAP && App.config.FIELD_LABEL_MAP[fieldId]) ? App.config.FIELD_LABEL_MAP[fieldId] : fieldId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                let type = (fieldId.includes('Date') ? 'date' : (fieldId.includes('email') ? 'email' : (fieldId.includes('phone') ? 'tel' : ((fieldId.startsWith('consent') || fieldId === 'isRefinance') ? 'checkbox' : 'text'))));
                                if (fieldId === 'dealStage' || fieldId === 'expert') type = 'select';
                                html += App.templates.formField(fieldId, label, type);
                            });

            html += `</div></fieldset>`;
            if (legend === 'API APPLICATION DATA') {
                html += `
<fieldset class="border p-4 rounded-md" id="validation-errors-fieldset">
  <legend class="px-2 font-semibold text-lg">VALIDATION ERRORS</legend>
  <div id="jigsawValidationErrors" class="p-3 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm">

    <details class="mt-0">
      <summary class="cursor-pointer text-sm font-semibold">Raw response</summary>
      <pre id="jigsawValidationErrorsRaw" class="mt-2 text-xs bg-gray-50 border rounded-lg p-3 overflow-auto whitespace-pre-wrap"></pre>
    </details>

    <details class="mt-4">
      <summary class="cursor-pointer text-sm font-semibold">Payload sent on VALIDATE JIGSAW</summary>
      <pre id="jigsawValidationPayload" class="mt-2 text-xs bg-white border rounded-lg p-3 overflow-auto whitespace-pre-wrap"></pre>
      <div class="text-[11px] text-gray-600 mt-1">Shown as JSON: { action, payload }. This is exactly what the UI posts to the backend.</div>
    </details>

    <!-- LAYOUT NOTE: This block was moved under “Payload” per prior request. If relocating again, confirm it doesn’t break CSS grid/flex expectations. -->
    <div class="flex items-start justify-between gap-3 mt-4">
      <div class="font-semibold">Jigsaw: Missing / invalid fields</div>
      <button type="button" class="text-xs font-semibold underline" id="jigsawValidationErrorsClearBtn">Clear</button>
    </div>
    <div id="jigsawValidationErrorsEmpty" class="text-gray-600 text-xs mt-2">No validation errors.</div>
    <ul id="jigsawValidationErrorsList" class="list-disc pl-5 mt-2 space-y-1 hidden"></ul>

  </div>
</fieldset>`;
            }

}
                        App.elements.customerForm.insertAdjacentHTML('beforeend', html);
        // --- Collapsible API APPLICATION DATA (hidden by default) ---
        try {
            const toggleBtn = document.getElementById('toggleApiAppData');
            const body = document.getElementById('apiAppDataBody');
            if (toggleBtn && body) {
                const sync = () => {
                    const hidden = (body.style.display === 'none' || getComputedStyle(body).display === 'none');
                    toggleBtn.textContent = hidden ? 'SHOW' : 'HIDE';
                };
                toggleBtn.addEventListener('click', () => {
                    const hidden = (body.style.display === 'none' || getComputedStyle(body).display === 'none');
                    body.style.display = hidden ? '' : 'none';
                    sync();
                });
                sync();
            }
        } catch (e) { /* no-op */ }

        // --- Refinance indicator styling (outline + green/red background) ---
        try {
            const refEl = document.getElementById('isRefinance');
            if (refEl) {
                const labelTag = document.getElementById('isRefinanceLabel')
                    || (document.querySelector('label[for="isRefinance"] span'));
                if (labelTag) {
                    if (!labelTag.classList.contains('refinance-label-box')) {
                        labelTag.classList.add('refinance-label-box');
                    }
                    const updateRef = () => {
                        labelTag.classList.toggle('refinance-true', !!refEl.checked);
                        labelTag.classList.toggle('refinance-false', !refEl.checked);
                    };
                    refEl.addEventListener('change', updateRef);
                    updateRef();
                }
            }
        } catch (e) { /* no-op */ }

        try {
            if (App.handlers && typeof App.handlers.setupNotesAutoDate === 'function') App.handlers.setupNotesAutoDate();
            if (typeof relayoutNotesSection === 'function') relayoutNotesSection();
        } catch (e) { /* no-op */ }

        if (App.ui && typeof App.ui.wireValidationErrorsPanel === 'function') App.ui.wireValidationErrorsPanel();
},
                    getExpertColorClass(expert) {
                        const colors = { Kyle: 'bg-blue-50 hover:bg-blue-100', Mills: 'bg-purple-50 hover:bg-purple-100', Kurt: 'bg-teal-50 hover:bg-teal-100', Umar: 'bg-amber-50 hover:bg-amber-100', Austin: 'bg-rose-50 hover:bg-rose-100' };
                        return colors[expert] || 'bg-white hover:bg-gray-50';
                    },
                    populateStageManagement() { const list = getEl('stage-list'); list.innerHTML = App.state.stages.filter(s => s.id !== App.config.CONTACT_STAGE_ID && s.id !== App.config.PAID_OUT_STAGE_ID).map(s => `<div class="stage-item flex items-center space-x-2" data-id="${s.id}"><input type="text" value="${s.title}" class="input-field flex-grow"><button class="text-red-500 hover:text-red-700">&times;</button></div>`).join(''); list.querySelectorAll('button').forEach(btn => on(btn, 'click', (e) => e.target.closest('.stage-item').remove())); },
                    addStageInput() { const list = getEl('stage-list'); const item = Object.assign(document.createElement('div'), { className: 'stage-item flex items-center space-x-2', dataset: { id: `new-${Date.now()}` }, innerHTML: `<input type="text" placeholder="New Stage" class="input-field flex-grow"><button class="text-red-500 hover:text-red-700">&times;</button>` }); on(item.querySelector('button'), 'click', () => item.remove()); list.appendChild(item); },
                    populateStageDropdown() { if (App.elements.dealStage) App.elements.dealStage.innerHTML = App.state.stages.map(s => `<option value="${s.id}">${s.title}</option>`).join(''); },
                    populateExpertDropdown(currentExpert) {
                        const expertSelect = getEl('expert');
                        if (!expertSelect) return;
                        const experts = ['', 'Kyle', 'Jordan (IOU)', 'Mills', 'Kurt', 'Umar', 'Austin'];
                        expertSelect.innerHTML = experts.map(name => `<option value="${name || ''}" ${currentExpert === name ? 'selected' : ''}>${name || 'Select Expert...'}</option>`).join('');
                    },
                    addDragAndDropListeners() { $$('.kanban-card').forEach(c => { on(c, 'dragstart', e => { e.target.classList.add('dragging'); e.dataTransfer.setData('text/plain', e.target.dataset.dealId); }); on(c, 'dragend', e => e.target.classList.remove('dragging')); }); $$('.kanban-column').forEach(col => { on(col, 'dragover', e => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }); on(col, 'dragleave', e => e.currentTarget.classList.remove('drag-over')); on(col, 'drop', e => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); App.handlers.handleDrop(e.dataTransfer.getData('text/plain'), e.currentTarget.dataset.dealStage); }); }); },
                    injectSortControls() {
                        $$('#contacts-table th[data-sort-key]').forEach(th => {
                            if (th.querySelector('.sort-controls')) return;
                            const key = th.dataset.sortKey;
                            const controls = document.createElement('span');
                            controls.className = 'sort-controls';
                            controls.innerHTML = `<button type="button" class="sort-arrow sort-asc" title="Sort ascending">▲</button><button type="button" class="sort-arrow sort-desc" title="Sort descending">▼</button>`;
                            controls.querySelector('.sort-asc').addEventListener('click', e => { e.stopPropagation(); App.handlers.handleSort(key, 'asc'); });
                            controls.querySelector('.sort-desc').addEventListener('click', e => { e.stopPropagation(); App.handlers.handleSort(key, 'desc'); });
                            th.appendChild(controls);
                        });
                    },
                    syncSortControls() {
                        const { key, direction } = App.state.sortState;
                        $$('#contacts-table th[data-sort-key]').forEach(th => {
                            const k = th.dataset.sortKey;
                            th.querySelector('.sort-controls .sort-asc').classList.toggle('active', k === key && direction === 'asc');
                            th.querySelector('.sort-controls .sort-desc').classList.toggle('active', k === key && direction === 'desc');
                        });
                    },
                    showConfirmModal(title, msg, onConfirm) { setTxt('confirmTitle', title); setTxt('confirmMessage', msg); const btn = getEl('confirmAction'); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); on(newBtn, 'click', () => { onConfirm(); this.closeModal('confirm'); }); this.openModal('confirm'); },
                    showDuplicateModal(dupes) { setTxt('duplicateCount', dupes.length); setHtml('duplicateList', dupes.map(d => `<tr><td class="px-2 py-1">${d.vrn}</td><td class="px-2 py-1">${d.firstName} ${d.lastName}</td></tr>`).join('')); this.openModal('duplicate'); },
                    updateContactSelection() { $$('.contact-checkbox').forEach(cb => { cb.checked = App.state.selectedContactIds.has(cb.dataset.id); }); toggleClass(getEl('contacts-actions'), 'hidden', App.state.selectedContactIds.size === 0); const contactDeals = App.state.deals.filter(d => d.dealStage === App.config.CONTACT_STAGE_ID); getEl('select-all-contacts').checked = contactDeals.length > 0 && contactDeals.every(d => App.state.selectedContactIds.has(d.id)); }
                }
            };

                        // === EXPOSE APP TO HTML BUTTONS (CRITICAL FIX) ===
            window.App = App;
            // =================================================

            // --- AUTH BOOTSTRAP (token-based) ---
            (function(){
              const overlay = document.getElementById('loginOverlay');
              const appRoot = document.getElementById('appRoot') || document.body; // fallback
              const form = document.getElementById('loginForm');
              const uEl  = document.getElementById('loginUsername');
              const pEl  = document.getElementById('loginPassword');
              const errEl= document.getElementById('loginError');
              const btn  = document.getElementById('loginBtn');

              function showLogin(msg){
                try { if (errEl){ errEl.textContent = msg || ''; errEl.classList.toggle('hidden', !msg); } } catch(e){}
                // Show login, hide app
                if (overlay){ overlay.style.display = 'flex'; overlay.classList.remove('hidden'); }
                if (appRoot){ appRoot.classList.add('hidden'); }
              }
              function hideLogin(){
                try { if (errEl){ errEl.textContent=''; errEl.classList.add('hidden'); } } catch(e){}
                // Hide login, show app
                if (overlay){ overlay.style.display = 'none'; overlay.classList.add('hidden'); }
                if (appRoot){ appRoot.classList.remove('hidden'); }
                try { activateSalesPipeline(); } catch(e){}

              }

              function activateSalesPipeline(){
                try {
                  // Default view after login/logout: Sales Pipeline
                  var salesTab = document.querySelector('.tab-link[data-tab="sales-pipeline-crm"]');
                  if (salesTab) {
                    // Ensure it's marked active and panel shown
                    if (typeof showTab === 'function') {
                      showTab(salesTab);
                    } else {
                      salesTab.click();
                    }
                  }
                } catch(e){}
              }


              // Global hook used by apiCall() when server returns AUTH_REQUIRED
              window.__cmfHandleAuthRequired = function(resp){
                if (!resp) return false;
                if (resp.authRequired || resp.error === 'AUTH_REQUIRED') {
                  try { localStorage.removeItem('CMF_AUTH_TOKEN'); } catch(e){}
                  showLogin('Session expired. Please sign in again.');
                  return true;
                }
                return false;
              };

              async function callAction(action, payload){
                // Prefer App.apiCall if present
                if (window.App && typeof App.apiCall === 'function') {
                  return await App.apiCall('POST', { action: action, payload: payload || {} });
                }
                // Fallback direct call
                return await new Promise((resolve, reject) => {
                  if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    reject(new Error('Not running inside Apps Script Web App.'));
                    return;
                  }
                  google.script.run
                    .withSuccessHandler(r => { try { resolve((typeof r === 'string') ? JSON.parse(r) : r); } catch(e){ resolve(r); } })
                    .withFailureHandler(e => reject(e))
                    .handleWebClientRequest({ action: action, payload: payload || {} });
                });
              }

              async function checkSession(){
                // If not in Apps Script frame, show login with message
                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                  showLogin('This page must be opened via the deployed Apps Script Web App URL.');
                  return false;
                }
                const token = (() => { try { return localStorage.getItem('CMF_AUTH_TOKEN') || ''; } catch(e){ return ''; } })();
                if (!token) { showLogin(); return false; }
                try {
                  const res = await callAction('authStatus', { token });
                  if (res && res.success && res.loggedIn) { hideLogin(); return true; }
                } catch(e) {}
                try { localStorage.removeItem('CMF_AUTH_TOKEN'); } catch(e){}
                showLogin();
                return false;
              }

              async function doLogin(username, password){
                const res = await callAction('authLogin', { username, password });
                if (!res || !res.success || !res.token) throw new Error(res?.error || 'Login failed');
                try { localStorage.setItem('CMF_AUTH_TOKEN', res.token); } catch(e){}
                hideLogin();
                return true;
              }

              // Wire login form
              if (form) {
                form.addEventListener('submit', async (ev) => {
                  ev.preventDefault();
                  const u = (uEl?.value || '').trim();
                  const p = (pEl?.value || '').trim();
                  if (!u || !p) { showLogin('Enter username and password.'); return; }
                  try { if (btn) btn.disabled = true; } catch(e){}
                  try {
                    await doLogin(u,p);
                    try { activateSalesPipeline(); } catch(e){}
                    // Now boot the app
                    if (typeof App.init === 'function') App.init();
                  } catch(e) {
                    showLogin(e.message || String(e));
                  } finally {
                    try { if (btn) btn.disabled = false; } catch(e){}
                  }
                });
              }



              // Wire logout button
              const logoutBtn = document.getElementById('logoutBtn');
              if (logoutBtn) {
                logoutBtn.addEventListener('click', async (ev) => {
                  ev.preventDefault();
                  try { if (btn) btn.disabled = false; } catch(e) {}
                  try {
                    const token = (() => { try { return localStorage.getItem('CMF_AUTH_TOKEN') || ''; } catch(e){ return ''; } })();
                    // Tell server to invalidate token (best-effort)
                    try { await callAction('authLogout', { token }); } catch(e) {}
                  } finally {
                    try { localStorage.removeItem('CMF_AUTH_TOKEN'); } catch(e){}
                    showLogin('Signed out.');
                    try { activateSalesPipeline(); } catch(e){}
                  }
                });
              }
              // Boot gate: only init when authenticated
              (async function(){
                const ok = await checkSession();
                if (ok) { try { activateSalesPipeline(); } catch(e){} }
                if (ok && typeof App.init === 'function') App.init();
              })();
            })();
        };

        /* =====================================================================
           CMF WIRING GUARD (AI-PROOF)
           ---------------------------------------------------------------------
           Problem: AI edits / DOM re-renders can remove or recreate buttons/tabs,
           breaking direct addEventListener wiring.
           Fix: One capture-phase delegated click handler on document.body that:
             - switches tabs reliably
             - triggers VRN "FIND" reliably
           This runs BEFORE any per-element click handlers (capture phase) and
           stops propagation to prevent duplicate execution.
        ====================================================================== */
        (function initCmfDelegatedWiring(){
            if (window.__cmfDelegationInitDone) return;
            window.__cmfDelegationInitDone = true;

            const switchTab = (targetId) => {
                const tabs = document.querySelectorAll('.tab-link');
                const contents = document.querySelectorAll('.tab-content');

                tabs.forEach(t => t.classList.remove('active-tab'));
                contents.forEach(c => c.style.display = 'none');

                const targetPanel = document.getElementById(targetId);
                const targetTab = Array.from(tabs).find(t => t.dataset && t.dataset.tab === targetId);

                if (targetTab) targetTab.classList.add('active-tab');

                if (!targetPanel) return;

                const isFlex = ['sales-pipeline-crm','client-files-view'].includes(targetId);
                targetPanel.style.display = isFlex ? 'flex' : 'block';
                if (isFlex) targetPanel.style.flexDirection = 'column';

                // Auto-focus Drive search when opening Client Files
                // + NEW: Trigger Browse Mode immediately (loads first 50 folders)
                if (targetId === 'client-files-view') {
                    setTimeout(() => {
                        const inp = document.getElementById('drive-search-input');
                        if (inp) inp.focus();

                        // Browse-first: empty query => backend returns the first N folders
                        try {
                            if (window.App && App.handlers && typeof App.handlers.handleLiveSearch === 'function') {
                                App.handlers.handleLiveSearch('');
                            }
                        } catch (e) { /* no-op */ }
                    }, 100);
                }

                // Tab-specific refresh hooks
                if (targetId === 'sales-pipeline-crm') {
                    try {
                        if (window.App && App.render && typeof App.render.all === 'function') {
                            setTimeout(() => { try { App.render.all(); } catch(e){} }, 50);
                        }
                        if (window.App && App.state) {
                            App.state.resizersSetup = false;
                        }
                    } catch(e){}
                }

                if (targetId === 'document-upload') {
                    try { if (typeof loadCustomerUploadIframe === 'function') loadCustomerUploadIframe(); } catch(e){}
                }

                if (targetId === 'whatsapp-messenger') {
                    try {
                        const ifr = document.getElementById('whatsapp-messenger-iframe');
                        const tpl = document.getElementById('whatsapp-messenger-srcdoc');
                        if (ifr && tpl && !ifr.dataset.loaded) {
                            ifr.srcdoc = tpl.innerHTML;
                            ifr.dataset.loaded = '1';
                        }
                    } catch(e){}
                }
            };

            /* =======================================================================
   WIRING GUARD (CAPTURE-PHASE EVENT DELEGATION)
   -----------------------------------------------------------------------
   Why this exists:
     - Direct addEventListener() calls often break when DOM nodes are
       re-rendered, replaced, or AI edits restructure markup.
   What it guarantees:
     1) Tabs always switch (via .tab-link[data-tab]) and run per-tab hooks.
     2) VRN FIND always works (via #vrn-lookup-btn) even after re-render.
   If anything "stops working", check here FIRST.
   ======================================================================= */

document.body.addEventListener('click', async (e) => {
                // 1) Tabs (delegated)
                const tabLink = e.target.closest('.tab-link');
                if (tabLink && tabLink.dataset && tabLink.dataset.tab) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    switchTab(tabLink.dataset.tab);
                    return;
                }


                // 1.5) PSE shortcut from Application Modal (delegated)
                const pseBtn = e.target.closest('#pseShortcutBtn');
                if (pseBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    let vrn = '';
                    try {
                        if (window.App && App.elements && App.elements.customerForm && App.elements.customerForm.elements) {
                            const vrnEl = App.elements.customerForm.elements['vrn'];
                            if (vrnEl) vrn = vrnEl.value || '';
                        }
                        if (!vrn && window.App && App.ui && typeof App.ui.getFormData === 'function') {
                            const fd = App.ui.getFormData();
                            vrn = (fd && fd.vrn) ? fd.vrn : '';
                        }
                    } catch (err) {}

                    vrn = String(vrn || '').toUpperCase().replace(/\s/g, '').trim();
                    if (!vrn) {
                        alert('No VRN found in this application.');
                        return;
                    }

                    // Close the modal so the PSE tab is visible
                    try { if (window.App && App.ui && typeof App.ui.closeModal === 'function') App.ui.closeModal('customer'); } catch (err) {}

                    // Switch tab then auto-run the VRN lookup
                    try { switchTab('pse'); } catch (err) {}

                    setTimeout(() => {
                        const vrnInput = document.querySelector('#pse #vrn');
                        if (vrnInput) {
                            vrnInput.value = vrn;
                            vrnInput.dispatchEvent(new Event('input', { bubbles: true }));
                            vrnInput.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        const findBtn = document.querySelector('#pse #vrn-lookup-btn');
                        if (findBtn) findBtn.click();
                    }, 150);

                    return;
                }

                // 2) VRN FIND button (delegated)
                const vrnBtn = e.target.closest('#vrn-lookup-btn');
                if (vrnBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    // Prefer the existing handler (now exposed by initializePSE)
                    if (typeof window.handleVrnLookup === 'function') {
                        await window.handleVrnLookup();
                        return;
                    }

                    // Fallback: minimal compatibility path
                    const vrnInput = document.getElementById('vrn');
                    const vrnValue = vrnInput ? (vrnInput.value || '').trim() : '';
                    if (!vrnValue) { alert('Please enter a VRN first.'); return; }
                    if (typeof window.fetchVrnPayloadFromSheet === 'function') {
                        try { await window.fetchVrnPayloadFromSheet(vrnValue); } catch(err){ console.error(err); }
                    } else {
                        console.error('VRN handler not available (scope issue).');
                        alert('VRN lookup not available (scope issue).');
                    }
                }
            }, true); // IMPORTANT: capture phase
        })();

        document.addEventListener('DOMContentLoaded', () => {
            initializeTabs();
            initializePSE();
            initializeSalesPipelineCRM();
        });
    </script>
<style id="cmf-custom-pipeline-banner-css">
/* Full-width scrolling banner under the "Add Deal" button */
#cmf-pipeline-banner-wrap { width: 100%; margin-top: 0; }
#cmf-pipeline-banner {
  position: relative; overflow: hidden; width: 100%;
  background: linear-gradient(90deg, #004225 0%, #0a5b36 100%);
  color: #fff; border-radius: .5rem; padding: .5rem 0;
  box-shadow: 0 4px 12px rgba(0,0,0,.12);
  border: 1px solid rgba(255,255,255,.12);
}
#cmf-pipeline-banner .marquee {
  white-space: nowrap; display: inline-block; padding-left: 100%;
  animation: cmf-marquee 56s linear infinite;
  font-weight: 700; letter-spacing: .02em;
}
#cmf-pipeline-banner .marquee span{ padding: 0 8rem; }
#cmf-pipeline-banner .marquee .item{ margin-right: 8rem; display:inline-block; }
@keyframes cmf-marquee {
  0% { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

/* Hide any Manage Stages buttons safely without touching the modal */
button#manageStagesBtn,
button[data-action="manage-stages"],
button[aria-controls="manageStagesModal"],
button[onclick*="manageStages"],
#title-and-buttons-wrapper button:where(:is([id*="manageStage" i],[data-target="#manageStagesModal"])),
#kanban-toolbar button:where(:is([id*="manageStage" i],[data-target="#manageStagesModal"])) {
  display: none !important;
}
</style>
<style>
  /* Product Source & DNS - Vehicle Finance Finder layout */
  #pse .page-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  #pse #form-card {
    padding: 24px 24px 28px;
    background: #f7faf4;
    border-radius: 18px;
    border: 1px solid #d8e4c6;
  }

  #pse #form-card .ps-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  #pse #form-card .ps-header-main {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  #pse #form-card .ps-header-avatar {
    width: 72px;
    height: 72px;
    border-radius: 999px;
    overflow: hidden;
    background: #e3f1dd;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #004225;
    flex-shrink: 0;
  }

  #pse #form-card .ps-header-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #pse #form-card .ps-header-text {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #pse #form-card .ps-header-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #004225;
  }

  #pse #form-card .ps-header-subtitle {
    font-size: 0.9rem;
    color: #4a6a4a;
  }

  #pse #form-card .ps-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  #pse #form-card .ps-vrn-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px 24px;
    align-items: center;
    padding: 16px 20px;
    border-radius: 14px;
    background: #d3e6cd;

  /* VRN block: 2-column inner layout */
  #pse #form-card .ps-vrn-search {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
  }

  #pse #form-card .ps-vrn-search .ps-vrn-helper {
    margin-bottom: 2px;
  }

  #pse #form-card .ps-client-col {
    min-width: 0;
  }
}

  /* VRN block: 3-column layout (desktop) */
  @media (min-width: 900px) {
    #pse #form-card .ps-vrn-row {
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      align-items: start;
    }
  }

  #pse #form-card .ps-client-placeholder {
    padding: 12px 14px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.55);
    border: 1px solid rgba(0, 66, 37, 0.15);
  }

  #pse #form-card .ps-client-title {
    font-size: 0.8rem;
    font-weight: 700;
    color: #004225;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  #pse #form-card .ps-client-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  #pse #form-card .ps-client-field label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #004225;
  }

  #pse #form-card .ps-client-field input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(0, 66, 37, 0.25);
    background: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
  }

  #pse #form-card .ps-client-field--full {
    grid-column: 1 / -1;
  }

  #pse #form-card .ps-client-note {
    display: block;
    margin-top: 10px;
    font-size: 0.75rem;
    color: rgba(0, 66, 37, 0.85);
  }

  /* Finance type: avoid text clipping */
  #pse #finance-type {
    font-size: 0.9rem;
    line-height: 1.2;
  }

  #pse #form-card .ps-vrn-helper {
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #004225;
  }

  #pse #form-card .ps-vrn-input label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    color: #004225;
  }

  #pse #form-card .vrn-lookup-group {
    display: flex;
    gap: 8px;
  }

  #pse #form-card .vrn-lookup-group input {
    flex: 1;
  }

  #pse #form-card .vrn-lookup-group button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 18px;
    border-radius: 999px;
    border: none;
    background: #004225;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    min-height: 40px;
  }

  #pse #form-card .vrn-lookup-group button:disabled {
    opacity: 0.7;
    cursor: default;
  }

  #pse #form-card .ps-vrn-status {
    display: block;
    font-size: 0.75rem;
    margin-top: 4px;
  }

  #pse #form-card .ps-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px 20px;
  }

  #pse #form-card .ps-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px 20px;
  }

  #pse #form-card .form-group {
    margin-bottom: 0;
  }

  #pse #form-card .form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    color: #004225;
  }

  #pse #form-card .form-group input,
  #pse #form-card .form-group select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #c8d7b7;
    background: #ffffff;
    box-sizing: border-box;
  }

  #pse #form-card .form-group input:disabled {
    background: #f1f4ec;
    font-weight: 600;
  }

  #pse #form-card .form-group input.editable-calc {
    background: #f1f4ec;
  }

  #pse #form-card .ps-primary-btn {
    align-self: center;
    max-width: 260px;
    margin-top: 4px;
    border-radius: 999px;
    font-weight: 700;
  }

  @media (max-width: 900px) {
    #pse #form-card {
      padding: 20px 16px 24px;
    }

    #pse #form-card .ps-header-title {
      font-size: 1.2rem;
    }

    #pse #form-card .ps-vrn-row {
      grid-template-columns: 1fr;
      align-items: flex-start;
    }
  }
</style>
<script id="cmf-custom-pipeline-banner-js">
(function(){
  const GBP = new Intl.NumberFormat('en-GB', { style:'currency', currency:'GBP', maximumFractionDigits: 2 });
  const parseMoney = (s) => {
    if (s == null) return 0;
    if (typeof s === 'number') return s;
    const n = parseFloat(String(s).replace(/[^0-9.\-]/g,''));
    return isNaN(n) ? 0 : n;
  };
  const isVisible = (el) => !!(el && el.offsetParent !== null);
  const norm = (s) => String(s||'').toLowerCase().trim();

  // Prefer inserting ABOVE the search bar row (#kanban-toolbar)
  function ensureBanner(){
    const toolbar = document.getElementById('kanban-toolbar');
    const container = toolbar?.parentElement || document.getElementById('pipeline-view') || document.getElementById('sales-pipeline-crm') || document.body;
    if (!container) return null;
    if (container.querySelector('#cmf-pipeline-banner-wrap')) return container.querySelector('#cmf-pipeline-banner-wrap');

    const wrap = document.createElement('div');
    wrap.id = 'cmf-pipeline-banner-wrap';
    wrap.style.margin = '0 0 .5rem 0';
    const banner = document.createElement('div');
    banner.id = 'cmf-pipeline-banner';
    banner.innerHTML = '<div class="marquee"><span>Calculating…</span></div>';
    wrap.appendChild(banner);

    if (toolbar && toolbar.parentElement === container) {
      container.insertBefore(wrap, toolbar);
    } else {
      container.prepend(wrap);
    }
    return wrap;
  }

  // Read totals directly from the rendered column headers (the same numbers the user sees)
  function headerTotal(stageLabel){
    const col = document.querySelector(`#kanban-board .kanban-column[data-deal-stage="${stageLabel}"]`)
             || Array.from(document.querySelectorAll('#kanban-board .kanban-column')).find(c => norm(c.dataset.dealStage) === norm(stageLabel));
    if (!col) return 0;
    // The app updates this using: column.querySelector('.font-bold').textContent = '£...'
    const valueDiv = col.querySelector('.font-bold');
    if (!valueDiv) return 0;
    return parseMoney(valueDiv.textContent);
  }

  // Primary: DOM header numbers. Secondary: derive from App.state.deals
  function computePipelineValue(){
    let ap  = headerTotal('Awaiting Payout');
    let rtd = headerTotal('Ready To Deal') || headerTotal('Ready to Deal');
    let wip = headerTotal('Work In Progress') || headerTotal('Work in Progress');
    let uw  = headerTotal('Packaging');

    // Fallback to App.state if headers not yet rendered
    if (!(ap || rtd || wip || uw)) {
      if (window.App && App.state && Array.isArray(App.state.deals)) {
        const deals = App.state.deals;
        const sum = (labels) => deals
          .filter(d => labels.some(lbl => norm(d.dealStage) === norm(lbl)))
          .reduce((acc, d) => acc + (parseMoney(d.settlementTotal) || 0), 0);
        ap  = sum(['Awaiting Payout']);
        rtd = sum(['Ready To Deal','Ready to Deal']);
        wip = sum(['Work In Progress','Work in Progress']);
        uw  = sum(['Packaging']);
      }
    }

    const total = (ap + rtd + 0.5 * wip + 0.25 * uw);
    const value = total * 0.04;
    return {uw,wip,rtd,ap,total,value};
  }

function renderBanner(){
  const wrap = ensureBanner(); if (!wrap) return;
  const b = wrap.querySelector('#cmf-pipeline-banner .marquee'); if (!b) return;

  const {uw,wip,rtd,ap,total} = computePipelineValue();

  // Total pipeline = ap + rtd + wip + uw
  const gross = ap + rtd + wip + uw;

  const GBP0 = (n) => new Intl.NumberFormat('en-GB', { style:'currency', currency:'GBP', maximumFractionDigits: 0 }).format(Math.round(n));

  const items = [
    `<span class="item">ACTIVE PIPELINE: ${GBP0(gross)}</span>`,
    `<span class="item">Extraction Estimate: ${GBP0(total)}</span>`,
    `<span class="item">Commission: ${GBP0(total * 0.05)}</span>`
  ].join('');

  b.innerHTML = '<span>' + items + '</span>';
}

  // Silent refresh every minute on Sales Pipeline view
  function tryRefreshPipeline() {
  if (window.DISABLE_DELTA_POLLING) return; // delta polling disabled
  // Prevent overlapping refreshes
  if (window.__cmfDeltaRefreshBusy) return;
  window.__cmfDeltaRefreshBusy = true;

  try {
    // Safety: App may not be ready yet
    if (!window.App || !App.apiCall) {
      console.log("Skipping auto-refresh: App not ready.");
      return;
    }

    // Skip refresh if we are currently writing data
    if (window.SaveManager && window.SaveManager._isProcessing) {
      console.log("Skipping auto-refresh: Save in progress.");
      return;
    }

    // Only refresh when the pipeline view is visible (if helper exists)
    try {
      const pv = document.getElementById('pipeline-view') || document.getElementById('sales-pipeline-crm');
      if (typeof isVisible === 'function' && pv && !isVisible(pv)) return;
    } catch (e) { /* non-fatal */ }

    if (!window.lastFetchTime) window.lastFetchTime = new Date().toISOString();

    (async () => {
      try {
        const result = await App.apiCall('POST', {
          action: 'getDelta',
          payload: { since: window.lastFetchTime }
        });

        if (result && result.success && Array.isArray(result.data) && result.data.length > 0) {
          console.log(`Received ${result.data.length} updates.`);

          // Helper: build a stable key (id -> vrn -> sourceSheet)
          const keyFor = (d) => {
            if (!d) return '';
            const id = (App.utils && typeof App.utils.getDealId === 'function') ? App.utils.getDealId(d) : (d.id ?? d.ID ?? d.Id);
            const vrn = (App.utils && typeof App.utils.getVrn === 'function') ? App.utils.getVrn(d) : (d.vrn ?? d.VRN ?? d.Vrn);
            const sheet = d.sourceSheet ?? d.SourceSheet ?? d.sourcesheet ?? '';
            return String(id || vrn || sheet || '').trim();
          };

          // 1) Upsert into state.deals without ever duplicating keys
          const indexByKey = new Map();
          for (let i = 0; i < (App.state.deals || []).length; i++) {
            const k = keyFor(App.state.deals[i]);
            if (k) indexByKey.set(k, i);
          }

          for (const updatedDeal of result.data) {
            if (!updatedDeal) continue;
            const k = keyFor(updatedDeal);
            if (!k) continue;

            const idx = indexByKey.get(k);
            if (idx !== undefined) {
              // Merge (keep existing object reference where possible)
              const existing = App.state.deals[idx];
              if (existing && typeof existing === 'object') {
                Object.assign(existing, updatedDeal);
              } else {
                App.state.deals[idx] = updatedDeal;
              }
            } else {
              App.state.deals.push(updatedDeal);
              indexByKey.set(k, App.state.deals.length - 1);
            }
          }

          // 2) Final safety de-dupe (in case backend returns repeats)
          try {
            const seen = new Map();
            const unique = [];
            for (const d of App.state.deals) {
              const k = keyFor(d);
              if (!k) continue;
              if (!seen.has(k)) {
                seen.set(k, true);
                unique.push(d);
              }
            }
            App.state.deals = unique;

          // Maintain per-deal server snapshot for delta saves
          try {
            (App.state.deals || []).forEach(d => {
              if (!d || typeof d !== 'object') return;
              if (!d._serverSnapshot) {
                const snap = (() => { try { return structuredClone(d); } catch(e){ try { return JSON.parse(JSON.stringify(d)); } catch(e2){ return { ...(d||{}) }; } } })();
                try { Object.keys(snap || {}).forEach(k => { if (String(k).startsWith('_')) delete snap[k]; }); } catch (e) {}
                d._serverSnapshot = snap;
              }
            });
          } catch (e) {}
          } catch (e) {
            console.warn('Delta de-dupe failed', e);
          }

          if (App.render && typeof App.render.board === 'function') {
            App.render.board();
          }
          // Let any listeners update badges/banners without re-rendering
          try { window.dispatchEvent(new CustomEvent('cmf:dealsUpdated')); } catch (e) {}
        }
      } catch (err) {
        console.error('Error during delta refresh', err);
      } finally {
        window.lastFetchTime = new Date().toISOString();
        window.__cmfDeltaRefreshBusy = false;
      }
    })();
  } catch (e) {
    window.__cmfDeltaRefreshBusy = false;
  }
}

function hideManageStages(){
    // Remove any button with exact label "Manage Stages"
    Array.from(document.querySelectorAll('button')).forEach(btn=>{
      const t=(btn.textContent||'').trim().toLowerCase();
      if (t === 'manage stages' || /\bmanage\s+stages\b/i.test(btn.textContent||'')){ btn.style.display='none'; btn.setAttribute('aria-hidden','true'); }
    });
  }

  function tick(){ renderBanner(); hideManageStages(); }

  // Respond to board mutations and App state changes
  const board = document.getElementById('kanban-board');
  if (board){
    const mo = new MutationObserver(() => { tick(); });
    mo.observe(board, { childList:true, subtree:true, characterData:true });
  }
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.closest('#kanban-board')) tick();
  }, true);
  window.addEventListener('cmf:dealsUpdated', tick);

  // Start intervals once DOM is ready
  function init(){
    tick();
    if (window.__cmfRefreshIntervalsStarted) return;
    window.__cmfRefreshIntervalsStarted = true;
    // Track last successful fetch time for delta-sync
    window.lastFetchTime = new Date().toISOString();
    // setInterval(()=>{ tryRefreshPipeline(); }, 10000); // DISABLED: delta polling off
    setInterval(()=>{ renderBanner(); }, 3 * 1000);
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
<script>
// CMF CRM overrides added for DOB format, labels, and section layout
if (window.App && App.templates && App.ui && App.config && App.elements && App.elements.customerForm) {
    // Override formField to enforce DD/MM/YYYY for DOB
    App.templates.formField = (fieldId, label, type = 'text') => {
        const isReadOnly = (App.config && App.config.READONLY_FIELDS && App.config.READONLY_FIELDS.includes(fieldId));
        const roAttr = isReadOnly ? 'readonly' : '';
        const roDisabled = isReadOnly ? 'disabled' : '';
        const roClass = isReadOnly ? ' bg-gray-100 text-gray-700 cursor-not-allowed' : '';

        const commonClasses = 'input-field w-full p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--gold-orange)] focus:border-[var(--gold-orange)]' + roClass;

        // Special case: DOB must be DD/MM/YYYY (e.g. 21/07/1988)
        if (fieldId === 'dob') {
            return `
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input
                        type="text"
                        id="dob"
                        name="dob"
                        class="${commonClasses}"
                        placeholder="DD/MM/YYYY or MM/DD/YYYY"
                        inputmode="numeric"
                        autocomplete="bday"
                        pattern="^\d{1,2}/\d{1,2}/\d{4}$"
                        title="Use format DD/MM/YYYY or MM/DD/YYYY (US), e.g. 21/07/1988 or 07/21/1988"
                        ${roAttr}
                    >
                </div>
            `;
        }

        const fieldMap = {
            textarea: `<textarea id="${fieldId}" name="${fieldId}" class="${commonClasses}" ${roAttr}></textarea>`,
            select: `<select id="${fieldId}" name="${fieldId}" class="${commonClasses}" ${roAttr}></select>`,
            checkbox: `<input type="checkbox" id="${fieldId}" name="${fieldId}" class="mr-2" ${roDisabled}>`,
            default: `<input type="${type}" id="${fieldId}" name="${fieldId}" class="${commonClasses}" ${roAttr}>`
        };

        return type === 'checkbox'
            ? `<label class="flex items-center text-sm">${fieldMap.checkbox}${label}</label>`
            : `<div><label for="${fieldId}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>${fieldMap[type] || fieldMap.default}</div>`;
    };

    // Override buildCustomerForm to support custom labels (Car Price Paid, DOB) while using FORM_SECTIONS
    App.ui.buildCustomerForm = function() {
        let html = '';
        for (const legend in App.config.FORM_SECTIONS) {
            const colsClass = 'grid grid-cols-1 md:grid-cols-4 gap-4';

            html += `<fieldset class="border p-4 rounded-md"><legend class="px-2 font-semibold text-lg">${legend}</legend><div class="${colsClass}">`;
            App.config.FORM_SECTIONS[legend].forEach(fieldId => {
                const customLabels = {
                    price: 'Car Price Paid',
                    dob: 'Date of Birth'
                };
                const label = (App.config.FIELD_LABEL_MAP && App.config.FIELD_LABEL_MAP[fieldId]) || customLabels[fieldId] ||
                    fieldId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());

                let type = ((fieldId.startsWith('notes') && !fieldId.endsWith('Date')) ? 'textarea'
                    : ((fieldId.includes('Date') || fieldId === 'dob') ? 'date'
                    : (fieldId.includes('email')
                        ? 'email'
                        : (fieldId.includes('phone')
                            ? 'tel'
                            : ((fieldId.startsWith('consent') || fieldId === 'isRefinance') ? 'checkbox' : 'text')))));

                if (fieldId === 'dealStage' || fieldId === 'expert') type = 'select';
                html += App.templates.formField(fieldId, label, type);
            });
            html += `</div></fieldset>`;
        }
        App.elements.customerForm.insertAdjacentHTML('beforeend', html);
        // --- Collapsible API APPLICATION DATA (hidden by default) ---
        try {
            const toggleBtn = document.getElementById('toggleApiAppData');
            const body = document.getElementById('apiAppDataBody');
            if (toggleBtn && body) {
                const sync = () => {
                    const hidden = (body.style.display === 'none' || getComputedStyle(body).display === 'none');
                    toggleBtn.textContent = hidden ? 'SHOW' : 'HIDE';
                };
                toggleBtn.addEventListener('click', () => {
                    const hidden = (body.style.display === 'none' || getComputedStyle(body).display === 'none');
                    body.style.display = hidden ? '' : 'none';
                    sync();
                });
                sync();
            }
        } catch (e) { /* no-op */ }

        // --- Refinance indicator styling (outline + green/red background) ---
        try {
            const refEl = document.getElementById('isRefinance');
            if (refEl) {
                const fieldWrap = refEl.closest('div') || refEl.parentElement;
                if (fieldWrap && !fieldWrap.classList.contains('refinance-indicator-box')) {
                    fieldWrap.classList.add('refinance-indicator-box');
                    const updateRef = () => {
                        fieldWrap.classList.toggle('refinance-true', !!refEl.checked);
                        fieldWrap.classList.toggle('refinance-false', !refEl.checked);
                    };
                    refEl.addEventListener('change', updateRef);
                    updateRef();
                }
            }
        } catch (e) { /* no-op */ }

    };

    // Wire up the permanent Validation Errors panel (in APPLICATION form)
    App.ui.wireValidationErrorsPanel = function() {
        const btn = document.getElementById('jigsawValidationErrorsClearBtn');
        if (!btn || btn.dataset.wired === '1') return;
        btn.dataset.wired = '1';
        btn.addEventListener('click', function() {
            const list = document.getElementById('jigsawValidationErrorsList');
            const empty = document.getElementById('jigsawValidationErrorsEmpty');
            const raw = document.getElementById('jigsawValidationErrorsRaw');
            const payloadPre = document.getElementById('jigsawValidationPayload');
            if (list) {
                list.innerHTML = '';
                list.classList.add('hidden');
            }
            if (raw) raw.textContent = '';
            if (payloadPre) payloadPre.textContent = '';
if (empty) empty.classList.remove('hidden');
        });
    };

}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  var mascotUrls = [
    "https://lh3.googleusercontent.com/d/1pN87QOTcrMHpJM6o16psBV5ZuwetFFYH",
    "https://lh3.googleusercontent.com/d/1Kf2kzoUmPDkHOrj_TkezYe0937VUAqzj",
    "https://lh3.googleusercontent.com/d/1z1OLTlJGykDP98DAwljiEJN02u6bDLZT",
    "https://lh3.googleusercontent.com/d/1CKF3DD9sPJtLzxT28t0sgFN_W3NigU-g",
    "https://lh3.googleusercontent.com/d/1NHtgaOBuB2qS9yGyl9jVoX7VOTnlPT0S",
    "https://lh3.googleusercontent.com/d/19AmXdwRyfPvogLEF-BGxxJeF6zgpAFK7"
  ];

  function shuffle(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = array[i];
      array[i] = array[j];
      array[j] = tmp;
    }
    return array;
  }

  var pse = document.getElementById("pse");
  if (!pse) return;

  // Select all circular/mascot images within Product Source section
  var imgEls = pse.querySelectorAll(".ps-header-avatar img, img[alt^='colincompare']");
  if (!imgEls.length) return;

  var rotated = shuffle(mascotUrls.slice());

  imgEls.forEach(function (img, index) {
    var src = rotated[index % rotated.length];
    img.setAttribute("src", src);
  });
});
</script>
<script>
/* Fallback tab initialiser (runs even if module script fails). */
(function() {
  // If the main tab initialiser ran, do nothing.
  if (window.__cmfTabsInitDone) return;

  function $all(sel, root) { return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

  /* =======================================================================
   TAB: DOCUMENT UPLOADS
   -----------------------------------------------------------------------
   - Loads an iframe / upload experience for customer documents.
   Common failure mode:
     - Tab switch wiring missing => panel never shown => appears blank.
   Protection:
     - Delegated tab wiring explicitly calls loadCustomerUploadIframe()
       when Document Uploads tab activates.
   ======================================================================= */

function loadCustomerUploadIframe(){
    try{
      var ifr = document.getElementById('customer-upload-iframe');
      if(!ifr) return;
      var base = (ifr.getAttribute('data-base-src') || '').trim();
      if(!base) return;
      // Avoid double ? issues
      var sep = base.indexOf('?') === -1 ? '?' : '&';
      var next = base + sep + 'mode=crm&embed=1&cb=' + Date.now();
      // Only set when first load OR when currently blank/about:blank
      if(!ifr.dataset.loaded || !ifr.src || ifr.src === 'about:blank'){
        ifr.src = next;
        ifr.dataset.loaded = '1';
      }
    }catch(e){}
  }

  function ensureLazyIframes(panel) {
    if (!panel || !panel.id) return;

    // Customer upload iframe (optional lazy loader)
    if (panel.id === 'document-upload') {
      loadCustomerUploadIframe();
    }

    // WhatsApp messenger iframe (lazy loads srcdoc)
    if (panel.id === 'whatsapp-messenger') {
      var wIfr = document.getElementById('whatsapp-messenger-iframe');
      var wTpl = document.getElementById('whatsapp-messenger-srcdoc');
      if (wIfr && wTpl && !wIfr.dataset.loaded) {
        wIfr.srcdoc = wTpl.innerHTML;
        wIfr.dataset.loaded = '1';
      }
    }
  }

  function reloadWhatsAppMessenger(resetState) {
    try {
      if (resetState) {
        localStorage.removeItem('whatsappPinned');
        localStorage.removeItem('whatsappSettings');
      }
    } catch (e) {}

    var wIfr = document.getElementById('whatsapp-messenger-iframe');
    var wTpl = document.getElementById('whatsapp-messenger-srcdoc');
    if (wIfr && wTpl) {
      try { delete wIfr.dataset.loaded; } catch(e) { wIfr.dataset.loaded = ''; }
      wIfr.srcdoc = wTpl.innerHTML;
      wIfr.dataset.loaded = '1';
    }
  }

  // WhatsApp toolbar buttons
  (function initWhatsAppToolbar(){
    var reloadBtn = document.getElementById('whatsapp-reload-btn');
    if (reloadBtn && !reloadBtn.dataset.bound) {
      reloadBtn.addEventListener('click', function(){ reloadWhatsAppMessenger(false); });
      reloadBtn.dataset.bound = '1';
    }
    var resetBtn = document.getElementById('whatsapp-reset-btn');
    if (resetBtn && !resetBtn.dataset.bound) {
      resetBtn.addEventListener('click', function(){ reloadWhatsAppMessenger(true); });
      resetBtn.dataset.bound = '1';
    }

    function cmfCopy(text){
      try{
        if (navigator.clipboard && window.isSecureContext){
          return navigator.clipboard.writeText(text);
        }
      }catch(e){}
      return new Promise(function(resolve,reject){
        try{
          var ta=document.createElement('textarea');
          ta.value=text;
          ta.style.position='fixed';
          ta.style.left='-9999px';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          var ok=document.execCommand('copy');
          document.body.removeChild(ta);
          ok?resolve():reject(new Error('copy failed'));
        }catch(err){reject(err);}
      });
    }
  function showTab(tabEl) {
    var tabs = $all('.tab-link');
    var panels = $all('.tab-content');

    tabs.forEach(function(t) { t.classList.remove('active-tab'); });
    panels.forEach(function(p) { p.style.display = 'none'; });

    tabEl.classList.add('active-tab');
    var id = tabEl.getAttribute('data-tab');
    if (!id) return;

    var panel = document.getElementById(id);
    if (!panel) return;

    // Match the main tab logic: sales pipeline needs flex.
    if (panel.id === 'sales-pipeline-crm') {
      panel.style.display = 'flex';
      panel.style.flexDirection = 'column';
    } else {
      panel.style.display = 'block';
    }

    ensureLazyIframes(panel);

    // Refresh Sales Pipeline layout when the panel becomes visible (fixes init-while-hidden issues).
    if (panel.id === 'sales-pipeline-crm') {
      try {
        if (window.App && App.render && typeof App.render.all === 'function') {
          requestAnimationFrame(function(){ try { App.render.all(); } catch(e){} });
        }
        if (window.App && App.state) { window.App.state.resizersSetup = false; }
      } catch(e){}
    }
  }

  function init() {
    // If the main init completed between load + now, bail.
    if (window.__cmfTabsInitDone) return;

    var tabs = $all('.tab-link');
    if (!tabs.length) return;

    tabs.forEach(function(t) {
      // Prevent double-binding if this fallback runs more than once.
      if (t.dataset && t.dataset.fallbackBound === '1') return;
      if (t.dataset) t.dataset.fallbackBound = '1';

      t.addEventListener('click', function(e) {
        e.preventDefault();
        showTab(t);
      });
    });

    // Prefer the one already marked active, otherwise first
    var active = document.querySelector('.tab-link.active-tab') || tabs[0];
    showTab(active);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<!-- APPLICATION MODAL: Notes section uses a strict 3-row layout for predictable height + scroll behavior. If adding rows, also adjust modal scroll constraints. -->
<script id="cmf-notes-strict-rows">
(function () {
  'use strict';
  var MAX_ROWS = 3;

  function getForm() { return document.getElementById('customerForm'); }
  function getModal() { return document.getElementById('customerModal'); }

  function findNotesFieldset(form) {
    if (!form) return null;
    var fieldsets = Array.prototype.slice.call(form.querySelectorAll('fieldset'));
    return fieldsets.find(function (fs) {
      var lg = fs.querySelector('legend');
      var t = lg && lg.textContent ? lg.textContent.trim().toLowerCase() : '';
      return t === 'notes' || t === 'note' || t.indexOf('notes') === 0;
    }) || null;
  }

  function closestWrap(el) {
    if (!el) return null;
    return el.closest('.form-group, .field-group, .mb-4, .mt-4, div') || el.parentElement;
  }

  function collectPair(fs, i) {
    var noteEl = fs.querySelector('#notes' + i);
    var dateEl = fs.querySelector('#notes' + i + 'Date');
    if (!noteEl || !dateEl) return null;
    return {
      i: i,
      noteEl: noteEl,
      dateEl: dateEl,
      noteWrap: closestWrap(noteEl),
      dateWrap: closestWrap(dateEl)
    };
  }

  function hideExtraFields(fs) {
    for (var i = MAX_ROWS + 1; i <= 10; i++) {
      var n = fs.querySelector('#notes' + i);
      var d = fs.querySelector('#notes' + i + 'Date');
      if (n) {
        var nw = closestWrap(n);
        if (nw) nw.classList.add('hidden');
        n.classList.add('hidden');
      }
      if (d) {
        var dw = closestWrap(d);
        if (dw) dw.classList.add('hidden');
        d.classList.add('hidden');
      }
    }
  }

  function relayoutNotesSection() {
    var form = getForm();
    if (!form) return false;

    var notesFs = findNotesFieldset(form);
    if (!notesFs) return false;

    var legend = notesFs.querySelector('legend');
    if (!legend) return false;

    var existingRows = notesFs.querySelectorAll('.cmf-notes-row');
    if (notesFs.dataset.cmfNotesStrict === '1' && existingRows && existingRows.length === MAX_ROWS) {
      hideExtraFields(notesFs);
      return true;
    }

    var pairs = [];
    for (var i = 1; i <= MAX_ROWS; i++) {
      var pair = collectPair(notesFs, i);
      if (pair) pairs.push(pair);
    }
    if (!pairs.length) return false;

    hideExtraFields(notesFs);

    // Clear everything except the legend.
    Array.prototype.slice.call(notesFs.children).forEach(function (child) {
      if (child !== legend) notesFs.removeChild(child);
    });

    var container = document.createElement('div');
    container.className = 'space-y-4';

    for (var j = 1; j <= MAX_ROWS; j++) {
      var p = pairs.find(function (x) { return x.i === j; });
      if (!p || !p.noteWrap || !p.dateWrap) continue;

      var noteW = p.noteWrap;
      var dateW = p.dateWrap;

      // 66/33 split on sm+.
      noteW.classList.add('sm:col-span-2');
      dateW.classList.add('sm:col-span-1');

      // Ensure note textarea is comfortably sized.
      var ta = noteW.querySelector('textarea');
      if (ta && !ta.getAttribute('rows')) ta.setAttribute('rows', '2');

      var row = document.createElement('div');
      row.className = 'cmf-notes-row grid grid-cols-1 sm:grid-cols-3 gap-4 items-start';
      row.appendChild(noteW);
      row.appendChild(dateW);
      container.appendChild(row);
    }

    notesFs.appendChild(container);
    notesFs.dataset.cmfNotesStrict = '1';
    return true;
  }

  function scheduleRelayout() {
    if (scheduleRelayout._raf) cancelAnimationFrame(scheduleRelayout._raf);
    scheduleRelayout._raf = requestAnimationFrame(function () { relayoutNotesSection(); });
  }

  // Initial retries (form builds async).
  var attempts = 0;
  var maxAttempts = 80;
  var timer = setInterval(function () {
    attempts++;
    var done = relayoutNotesSection();
    if (done || attempts >= maxAttempts) clearInterval(timer);
  }, 100);

  // Observe changes to the modal/form so the layout stays strict whenever Application is opened/rebuilt.
  var modal = getModal();
  if (modal && typeof MutationObserver !== 'undefined') {
    var obs = new MutationObserver(function () { scheduleRelayout(); });
    obs.observe(modal, { childList: true, subtree: true, attributes: true, attributeFilter: ['class', 'style'] });
  }

})();
</script>
<script>
/* ===== Document Upload helpers (non-invasive) ===== */
(function(){
  function qs(sel, root){ return (root||document).querySelector(sel); }

  function getUploadIframe(){ return qs('#customer-upload-iframe'); }

  function getBaseSrc(ifr){
    if (!ifr) return '';
    return ifr.getAttribute('data-base-src') || ifr.getAttribute('src') || '';
  }

  function reloadUploadIframe(){
    var ifr = getUploadIframe();
    if (!ifr) return;
    var base = getBaseSrc(ifr);
    if (!base) { try { ifr.src = ifr.src; } catch(e){} return; }
    var sep = base.indexOf('?') > -1 ? '&' : '?';
    ifr.src = base + sep + 'cb=' + Date.now();
  }

  // When switching to the Document Upload tab, refresh the iframe to avoid stale/cached loads.
  // This does not alter the existing tab wiring; it runs after the tab click.
  document.addEventListener('click', function(ev){
    var a = ev.target && ev.target.closest ? ev.target.closest('.tab-link[data-tab="document-upload"]') : null;
    if (!a) return;
    setTimeout(reloadUploadIframe, 0);
  }, true);
})();

// CMF_DOCUPLOAD_REFRESH_V1: refresh Document Upload iframe on tab click (prevents stale webapp assets)
(function(){
  const frame = document.getElementById('customer-upload-iframe');
  if(!frame) return;

  const base = frame.getAttribute('data-base-src') || frame.getAttribute('src') || '';
  if(base && !frame.getAttribute('data-base-src')) frame.setAttribute('data-base-src', base);

  function bust(){
    const b = frame.getAttribute('data-base-src') || base;
    if(!b) return;
    const sep = b.includes('?') ? '&' : '?';
    frame.src = b + sep + 'cb=' + Date.now();
  }

  const triggers = Array.from(document.querySelectorAll('button, a, [role="tab"], .tab, .tab-btn'))
    .filter(el => (el.textContent || '').trim().toLowerCase() === 'document upload');

  triggers.forEach(t => t.addEventListener('click', ()=>{ setTimeout(bust, 0); }));
})();

</script>
<script id="cmf-application-pdf-v1">
(function(){
  const BANNER_URL = "https://lh3.googleusercontent.com/d/1ZmfrGW614Vo6A6jbPMRhSeVdSzPp8o0k";

  function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s=document.createElement('script');
      s.src=src; s.async=true;
      s.onload=()=>resolve();
      s.onerror=()=>reject(new Error('Failed to load '+src));
      document.head.appendChild(s);
    });
  }

  async function ensurePdfLibs(){
    // Prefer already-loaded libs if present
    if (window.html2canvas && window.jspdf && window.jspdf.jsPDF) return;
    // Load on demand (keeps rest of app unaffected)
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
  }

  function collectApplicationData(){
    const form = (window.App && App.elements && App.elements.customerForm) ? App.elements.customerForm : document.getElementById('customerForm');

    // Prefer the configured headers, but ALWAYS include the required source-sheet fields for the application PDF.
    const configured = (window.App && App.config && Array.isArray(App.config.ALL_CSV_HEADERS)) ? App.config.ALL_CSV_HEADERS : [];
    const required = ["phone", "receivedDate", "id", "vin", "make", "model", "year", "colour", "vehicleCurrentMileage", "financeCompany", "agreementNumber", "price", "deposit", "currentApr", "agreementStartDate", "originalTerm", "financeType", "term", "settlementTotal", "annualMileage", "employmentStatus", "occupation", "employerName", "employerPhone", "employmentYears", "employmentMonths", "monthlyTakeHomePay", "previousEmployerName", "previousOccupation", "previousEmployerAddress1", "previousEmploymentYears", "previousEmploymentMonths", "currentAddressLine1", "currentAddressLine2", "currentCity", "currentPostcode", "currentAddressYears", "currentAddressMonths", "residentialStatus", "previousAddressLine1", "previousAddressLine2", "previousCity", "previousPostcode", "previousAddressYears", "previousAddressMonths", "previousResidentialStatus", "title", "firstName", "lastName", "email", "dob", "maritalStatus", "bankName", "accountHolder", "sortCode", "accountNumber", "bankYears", "bankMonths", "branchName", "consentMarketing", "consentTerms", "consentAccurate", "oldPayment", "newPayment"];
    const headers = Array.from(new Set([...(configured || []), ...required]));

    const out = {};
    headers.forEach(id=>{
      const el = form && form.elements ? form.elements[id] : null;
      out[id] = el ? ((el.value != null ? String(el.value) : '').trim()) : '';
    });

    // extra safety for jigsawId from raw keys / legacy casing
    if (!out.jigsawId) {
      const candidates = ['jigsawId','JIGSAW ID','JIGSAWID','JigsawId','jigsawID'];
      for (const c of candidates){
        const el = form && form.elements ? form.elements[c] : null;
        if (el && el.value && String(el.value).trim()) { out.jigsawId = String(el.value).trim(); break; }
      }
    }

    // Backfill "id" (Ref) and "receivedDate" from legacy keys / App state if not present
    if (!out.id) {
      const candidates = ['id','ID','Id','dealId','dealID','DealId','reference','ref','Ref'];
      for (const c of candidates){
        const el = form && form.elements ? form.elements[c] : null;
        if (el && el.value && String(el.value).trim()) { out.id = String(el.value).trim(); break; }
      }
      try {
        const cd = (window.App && App.state && (App.state.currentDeal || App.state.selectedDeal)) ? (App.state.currentDeal || App.state.selectedDeal) : null;
        if (!out.id && cd) {
          if (cd.id != null) out.id = String(cd.id).trim();
          else if (cd.dealId != null) out.id = String(cd.dealId).trim();
          else if (cd.reference != null) out.id = String(cd.reference).trim();
        }
      } catch(e){}
    }

    if (!out.receivedDate) {
      const candidates = ['receivedDate','receiveddate','ReceivedDate','dateReceived','received'];
      for (const c of candidates){
        const el = form && form.elements ? form.elements[c] : null;
        if (el && el.value && String(el.value).trim()) { out.receivedDate = String(el.value).trim(); break; }
      }
      try {
        const cd = (window.App && App.state && (App.state.currentDeal || App.state.selectedDeal)) ? (App.state.currentDeal || App.state.selectedDeal) : null;
        if (!out.receivedDate && cd && cd.receivedDate != null) out.receivedDate = String(cd.receivedDate).trim();
      } catch(e){}
    }

    return out;
  }

  function buildPrintableNode(app){
    const wrap = document.createElement('div');
    wrap.style.width = '794px'; // ~A4 at 96dpi
    // Keep banner positioning intact, but tighten layout for PDF readability
    wrap.style.padding = '26px 26px 78px';
    wrap.style.boxSizing = 'border-box';
    wrap.style.background = '#ffffff';
    wrap.style.color = '#111827';
    wrap.style.fontFamily = 'Arial, sans-serif';
    wrap.style.fontSize = '10.5px';
    wrap.style.lineHeight = '1.25';

    const banner = document.createElement('img');
    banner.src = BANNER_URL;
    banner.crossOrigin = 'anonymous';
    banner.style.width = '100%';
    banner.style.height = 'auto';
    banner.style.display = 'block';
    banner.style.marginBottom = '20px';
    wrap.appendChild(banner);

    const h = document.createElement('div');
    h.style.display='flex';
    h.style.justifyContent='space-between';
    h.style.alignItems='flex-end';
    h.style.marginBottom='10px';

    const ref = (app.id || app.dealId || app.vrn || '').toString().trim();
    const received = (app.receivedDate || app.receiveddate || window.sourceSheetReceivedDate || '').toString().trim();
    h.innerHTML = `
      <div style="font-size:16px;font-weight:800;color:#0b3d2e;letter-spacing:0.2px;">Client Application</div>
      <div style="text-align:right;font-size:10px;color:#374151;">
        <div><strong>Received:</strong> ${received ? received.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''}</div>
        <div><strong>Ref:</strong> ${ref ? ref.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''}</div>
      </div>
    `;
    wrap.appendChild(h);

    const name = [app.title, app.firstName, app.lastName].filter(Boolean).join(' ').trim();
    if (name) {
      const sub = document.createElement('div');
      sub.style.fontSize = '10.5px';
      sub.style.color = '#374151';
      sub.style.marginBottom = '14px';
      const safe = name.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      sub.innerHTML = `<strong>Applicant:</strong> ${safe}`;
      wrap.appendChild(sub);
    }

    const labels = {
      phone: 'Phone',
      receivedDate: 'Received Date',
      id: 'Application ID',

      title: 'Title',
      firstName: 'First Name',
      lastName: 'Last Name',
      dob: 'Date of Birth',
      maritalStatus: 'Marital Status',
      email: 'Email',

      vin: 'VIN',
      make: 'Make',
      model: 'Model',
      year: 'Year',
      colour: 'Colour',
      vehicleCurrentMileage: 'Current Mileage',
      annualMileage: 'Annual Mileage',

      financeCompany: 'Finance Company',
      agreementNumber: 'Agreement Number',
      financeType: 'Finance Type',
      agreementStartDate: 'Agreement Start Date',
      originalTerm: 'Original Term',
      term: 'Term',
      price: 'Vehicle Price',
      deposit: 'Deposit',
      currentApr: 'Current APR',
      settlementTotal: 'Settlement Total',

      employmentStatus: 'Employment Status',
      occupation: 'Occupation',
      employerName: 'Employer Name',
      employerPhone: 'Employer Phone',
      employmentYears: 'Employment Years',
      employmentMonths: 'Employment Months',
      monthlyTakeHomePay: 'Monthly Take Home Pay',

      previousEmployerName: 'Previous Employer Name',
      previousOccupation: 'Previous Occupation',
      previousEmployerAddress1: 'Previous Employer Address',
      previousEmploymentYears: 'Previous Employment Years',
      previousEmploymentMonths: 'Previous Employment Months',

      currentAddressLine1: 'Current Address Line 1',
      currentAddressLine2: 'Current Address Line 2',
      currentCity: 'Current Town/City',
      currentPostcode: 'Current Postcode',
      currentAddressYears: 'Time at Current Address (Years)',
      currentAddressMonths: 'Time at Current Address (Months)',
      residentialStatus: 'Residential Status',

      previousAddressLine1: 'Previous Address Line 1',
      previousAddressLine2: 'Previous Address Line 2',
      previousCity: 'Previous Town/City',
      previousPostcode: 'Previous Postcode',
      previousAddressYears: 'Time at Previous Address (Years)',
      previousAddressMonths: 'Time at Previous Address (Months)',
      previousResidentialStatus: 'Previous Residential Status',

      bankName: 'Bank Name',
      branchName: 'Branch Name',
      accountHolder: 'Account Holder',
      sortCode: 'Sort Code',
      accountNumber: 'Account Number',
      bankYears: 'Time with Bank (Years)',
      bankMonths: 'Time with Bank (Months)',

      consentMarketing: 'Marketing Consent',
      consentTerms: 'Terms Consent',
      consentAccurate: 'Accuracy Consent',

      oldPayment: 'Old Payment',
      newPayment: 'New Payment'
    };

    function esc(v){
      const s = (v == null ? '' : String(v));
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function section(title, fields){
      const sec = document.createElement('div');
      sec.style.marginTop = '14px';

      const t = document.createElement('div');
      t.style.fontSize = '11.5px';
      t.style.fontWeight = '800';
      t.style.color = '#ffffff';
      t.style.padding = '6px 10px';
      t.style.background = 'linear-gradient(90deg, #0b3d2e 0%, #14532d 60%, #1f7a48 100%)';
      t.style.border = '1px solid #0b3d2e';
      t.textContent = title;
      sec.appendChild(t);

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      const tbody = document.createElement('tbody');

      fields.forEach(key=>{
        const tr = document.createElement('tr');
        const label = labels[key] || key;
        const val = esc(app[key] || '');
        tr.innerHTML = `
          <td style="width:32%;border:1px solid #e5e7eb;padding:5px 8px;vertical-align:top;font-weight:700;background:#ecfdf5;color:#064e3b;">${esc(label)}</td>
          <td style="border:1px solid #e5e7eb;padding:5px 8px;vertical-align:top;white-space:pre-wrap;">${val}</td>
        `;
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      sec.appendChild(table);
      wrap.appendChild(sec);
    }

    // Sensible application-form order, including all required source-sheet fields.
    section('Applicant Details', ['title','firstName','lastName','dob','maritalStatus','email','phone']);
    section('Vehicle Details', ['vin','make','model','year','colour','vehicleCurrentMileage','annualMileage']);
    section('Finance Agreement', ['financeCompany','agreementNumber','financeType','agreementStartDate','originalTerm','term','currentApr','settlementTotal']);
    section('Payment Comparison', ['oldPayment','newPayment']);
    section('Employment', ['employmentStatus','occupation','employerName','employerPhone','employmentYears','employmentMonths','monthlyTakeHomePay']);
    section('Previous Employment', ['previousEmployerName','previousOccupation','previousEmployerAddress1','previousEmploymentYears','previousEmploymentMonths']);
    section('Current Address', ['currentAddressLine1','currentAddressLine2','currentCity','currentPostcode','currentAddressYears','currentAddressMonths','residentialStatus']);
    section('Previous Address', ['previousAddressLine1','previousAddressLine2','previousCity','previousPostcode','previousAddressYears','previousAddressMonths','previousResidentialStatus']);
    section('Bank Details', ['bankName','branchName','accountHolder','sortCode','accountNumber','bankYears','bankMonths']);
    section('Consents', ['consentMarketing','consentTerms','consentAccurate']);

// Summary (advisor shorthand)
function fmtMoney(v){
  if (v === null || v === undefined) return '';
  const s = String(v).trim();
  if (!s) return '';
  const n = Number(s.replace(/[^0-9.-]/g,''));
  if (!isFinite(n)) return s;
  return '£' + n.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtApr(v){
  if (v === null || v === undefined) return '';
  const s = String(v).trim();
  if (!s) return '';
  const n = Number(s.replace(/[^0-9.-]/g,''));
  if (!isFinite(n)) return s;
  return n.toLocaleString('en-GB', { maximumFractionDigits: 2 }) + '%';
}
function toInt(v){
  const n = parseInt(String(v||'').replace(/[^0-9-]/g,''), 10);
  return isFinite(n) ? n : null;
}
function summaryLine(app){
  const oldPay = fmtMoney(app.oldPayment);
  const apr = fmtApr(app.currentApr);
  const settlement = fmtMoney(app.settlementTotal);
  const lender = (app.financeCompany || '').toString().trim();
  const term = toInt(app.term);
  const newTerm = (term !== null) ? (term + 1) : null;
  const parts = [];
  parts.push(`Current payment ${oldPay || '—'}`);
  parts.push(`APR ${apr || '—'}`);
  parts.push(`Lender ${lender || '—'}`);
  parts.push(`Settlement ${settlement || '—'}`);
  parts.push(`New term needed ${(newTerm !== null) ? newTerm : '—'} months`);
  return parts.join(' • ');
}

// Insert SUMMARY under CONSENT
(function addSummary(){
  const summary = summaryLine(app);
  const el = document.createElement('div');
  el.style.marginTop = '8px';
  el.innerHTML = `<div style="font-weight:700;font-size:14px;margin:10px 0 6px">Summary</div>
                  <div style="border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fafafa;font-size:12px;line-height:1.4">
                    ${summary}
                  </div>`;
  wrap.appendChild(el);
})();
    return wrap;
  }

  async function generateApplicationPdf(){
    const btn = document.getElementById('printApplicationPdfBtn');
    if (btn) btn.disabled = true;

    try{
      await ensurePdfLibs();
      const app = collectApplicationData();
      const node = buildPrintableNode(app);

      // Attach off-screen for accurate rendering
      const host = document.createElement('div');
      host.style.position='fixed';
      host.style.left='-10000px';
      host.style.top='0';
      host.style.width='794px'; // ~A4 at 96dpi
      host.style.zIndex='-1';
      host.appendChild(node);
      document.body.appendChild(host);

      // Wait a tick for images/fonts
      await new Promise(r=>setTimeout(r, 250));

      const canvas = await window.html2canvas(node, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
      });

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Margins / gutters:
      // - Page 1: NO gutter above banner (top = 0)
      // - Page 2+: add head gutter
      // - All pages: add footer gutter
      const marginX = 12;           // left/right
      const marginTopFirst = 0;     // page 1
      const marginTopOther = 14;    // page 2+
      const marginBottom = 28;      // footer breathing room (prevents "cut-off" look)

      const usableW = pageWidth - (marginX * 2);

      // Fit width within margins; calculate px per mm
      const pxPerMm = canvas.width / usableW;

      function mmToPx(mm){ return Math.round(mm * pxPerMm); }

      // Footer meta (drawn by jsPDF, not in HTML capture)
      const printedAt = new Date();
      const printedStr = printedAt.toLocaleString('en-GB', {
        year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
      });
      const receivedStr = (app.receivedDate || app.receiveddate || '').toString().trim();
      // Ref MUST map to sourcesheet header "id"
      const refStr = (app.id || app.ID || app.Id || app.dealId || app.dealID || app.reference || app.ref || '').toString().trim();

      // Slice the captured canvas into pages so header/footer gutters remain blank
      let offsetPx = 0;
      let pageIndex = 0;

      while (offsetPx < canvas.height - 2) {
        const isFirst = pageIndex === 0;
        const marginTop = isFirst ? marginTopFirst : marginTopOther;
        const usableH = pageHeight - marginTop - marginBottom;

        const sliceHpx = Math.min(mmToPx(usableH), canvas.height - offsetPx);
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width;
        pageCanvas.height = sliceHpx;

        const ctx = pageCanvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,pageCanvas.width,pageCanvas.height);

        // draw portion of original canvas into this page
        ctx.drawImage(canvas, 0, offsetPx, canvas.width, sliceHpx, 0, 0, canvas.width, sliceHpx);

        const pageImg = pageCanvas.toDataURL('image/jpeg', 0.95);
        const sliceHmm = sliceHpx / pxPerMm;

        if (pageIndex > 0) pdf.addPage();
        pdf.addImage(pageImg, 'JPEG', marginX, marginTop, usableW, sliceHmm);

        offsetPx += mmToPx(usableH);
        pageIndex += 1;
      }

      // Footer text + page numbers (inside reserved footer gutter)
      const totalPages = pdf.getNumberOfPages();
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(9);

      for (let p = 1; p <= totalPages; p++) {
        pdf.setPage(p);

        const lineY = pageHeight - marginBottom + 4;
        pdf.setDrawColor(210);
        pdf.setLineWidth(0.2);
        pdf.line(marginX, lineY, pageWidth - marginX, lineY);

        const footerY = pageHeight - 9;
        const leftText = `Printed: ${printedStr}   Received: ${receivedStr}   Ref: ${refStr}`;
        const rightText = `Page ${p} of ${totalPages}`;

        pdf.setTextColor(70);
        pdf.text(leftText, marginX, footerY);

        const rightW = pdf.getTextWidth(rightText);
        pdf.text(rightText, pageWidth - marginX - rightW, footerY);
      }

      const fileId = (refStr || app.vin || app.lastName || 'application').replace(/[^a-z0-9\-_.]/ig,'_');
      pdf.save(`APPLICATION_${fileId}.pdf`);

      host.remove();
    } catch(err){
      console.error('PDF generation failed:', err);
      alert('PDF generation failed. Check console for details.');
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  function wire(){
    const btn = document.getElementById('printApplicationPdfBtn');
    if (!btn || btn.dataset.wired === 'true') return;
    btn.dataset.wired = 'true';
    btn.addEventListener('click', generateApplicationPdf);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wire);
  else wire();
})();
</script>
<!-- APPLICATION MODAL: Sections (fieldsets) are ordered intentionally (operator flow). If reordering, also check validation + save mapping for each field group. -->
<script id="cmf-application-section-order">
(function(){
  'use strict';

  function norm(s){ return (s||'').toString().trim().toLowerCase(); }

  function findFieldsetByLegend(form, name){
    if (!form) return null;
    const want = norm(name);
    const fss = Array.from(form.querySelectorAll('fieldset'));
    for (const fs of fss){
      const lg = fs.querySelector('legend');
      const t = norm(lg && lg.textContent);
      if (!t) continue;
      if (t === want || t.startsWith(want)) return fs;
    }
    return null;
  }

  function insertAfter(el, ref){
    if (!el || !ref || !ref.parentNode) return;
    const p = ref.parentNode;
    if (ref.nextSibling) p.insertBefore(el, ref.nextSibling);
    else p.appendChild(el);
  }

  function applyOrder(){
    const modal = document.getElementById('customerModal');
    const form  = document.getElementById('customerForm');
    if (!modal || !form) return;

    const consent = findFieldsetByLegend(form, 'consent');
    const doc     = findFieldsetByLegend(form, 'document');
    const status  = findFieldsetByLegend(form, 'status');
    const notes   = findFieldsetByLegend(form, 'notes');
    const personal= findFieldsetByLegend(form, 'personal');

    // Move STATUS to sit UNDER CONSENT
    // Move DOCUMENT to sit ABOVE STATUS (after CONSENT)
    if (consent){
      if (doc)   insertAfter(doc, consent);
      if (status) insertAfter(status, doc || consent);
    } else if (doc && status){
      insertAfter(status, doc);
    }

    // PERSONAL to sit BELOW the NOTES section
    if (notes && personal){
      insertAfter(personal, notes);
    }
  }

  // Run on load and when the modal opens (some builds re-render DOM on open)
  function hook(){
    applyOrder();

    const modal = document.getElementById('customerModal');
    if (!modal) return;

    const obs = new MutationObserver(function(muts){
      for (const m of muts){
        if (m.type === 'attributes' && m.attributeName === 'class'){
          const isHidden = modal.classList.contains('hidden');
          if (!isHidden) {
            // allow any internal render to finish
            setTimeout(applyOrder, 0);
          }
        }
      }
    });
    obs.observe(modal, { attributes: true, attributeFilter: ['class'] });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', hook);
  else hook();
})();
</script>
<!-- GLOBAL: Loading overlay (Colin) used during async operations across all tabs. Triggered by App.ui.showLoading/hideLoading (search in JS). Keep overlay ID stable. -->
<div aria-hidden="true" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center hidden z-[9999] cursor-wait" id="saveDealOverlay">
<img alt="Loading..." class="colin-spinner w-24 h-24" src="https://lh3.googleusercontent.com/d/126qJMUWUzhzmUItRi9Zt1JFQDZ5TVgxx"/>
</div>
</body>
    <!-- E2E TEST: <today’s date/time> -->
</html>
